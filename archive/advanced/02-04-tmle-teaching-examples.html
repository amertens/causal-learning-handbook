<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Chapter 2.4: From Question to Estimate — TMLE in Practice</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="02-04-tmle-teaching-examples_files/libs/clipboard/clipboard.min.js"></script>
<script src="02-04-tmle-teaching-examples_files/libs/quarto-html/quarto.js"></script>
<script src="02-04-tmle-teaching-examples_files/libs/quarto-html/popper.min.js"></script>
<script src="02-04-tmle-teaching-examples_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="02-04-tmle-teaching-examples_files/libs/quarto-html/anchor.min.js"></script>
<link href="02-04-tmle-teaching-examples_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02-04-tmle-teaching-examples_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="02-04-tmle-teaching-examples_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="02-04-tmle-teaching-examples_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="02-04-tmle-teaching-examples_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Chapter 2.4: From Question to Estimate — TMLE in Practice</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="chapter-2.4-from-question-to-estimate-tmle-in-practice" class="level1">
<h1>Chapter 2.4: From Question to Estimate — TMLE in Practice</h1>
<p><em>A progressive tutorial for pharmacoepidemiologists</em></p>
<p>This chapter walks through a complete causal analysis from start to finish, building each estimator step-by-step so you can see exactly where bias enters, how each method addresses it, and why TMLE provides a principled solution.</p>
<p>We use a realistic post-marketing safety scenario: <strong>evaluating the cardiovascular safety of a new diabetes drug</strong>.</p>
<p>By the end of this chapter, you will have implemented:</p>
<ol type="1">
<li>A naive (unadjusted) model</li>
<li>G-computation (outcome modeling)</li>
<li>IPTW (treatment modeling)</li>
<li>AIPW (combining both)</li>
<li>TMLE (targeting the estimate)</li>
</ol>
<p>Each method builds on what came before. Every step includes code, diagnostics, and interpretation.</p>
<hr>
</section>
<section id="clinical-motivation" class="level1">
<h1>1. Clinical Motivation</h1>
<section id="the-regulatory-question" class="level2">
<h2 class="anchored" data-anchor-id="the-regulatory-question">The Regulatory Question</h2>
<p>A new sodium-glucose co-transporter 2 (SGLT2) inhibitor, <strong>dapagliflozin</strong>, has been approved for type 2 diabetes. Post-marketing surveillance data from insurance claims suggest a potential cardiovascular safety signal. The FDA’s Office of Surveillance and Epidemiology asks:</p>
<blockquote class="blockquote">
<p><strong>Does initiation of dapagliflozin (vs.&nbsp;a sulfonylurea comparator) increase the 1-year risk of major adverse cardiovascular events (MACE) in adults with type 2 diabetes?</strong></p>
</blockquote>
<p>This is a classic <strong>active comparator, new user</strong> design question.</p>
<section id="key-elements" class="level3">
<h3 class="anchored" data-anchor-id="key-elements">Key elements</h3>
<ul>
<li><strong>Target population:</strong> Adults aged 40-85 with type 2 diabetes initiating a new oral glucose-lowering agent</li>
<li><strong>Treatment strategies:</strong> Initiate dapagliflozin (A = 1) vs.&nbsp;initiate sulfonylurea (A = 0)</li>
<li><strong>Outcome:</strong> 1-year MACE (composite of MI, stroke, CV death), binary</li>
<li><strong>Intercurrent events:</strong> Treatment discontinuation, switching, death from non-CV causes</li>
<li><strong>Decision:</strong> Should the label carry a cardiovascular warning? Is a formal safety trial needed?</li>
</ul>
</section>
<section id="why-standard-regression-falls-short" class="level3">
<h3 class="anchored" data-anchor-id="why-standard-regression-falls-short">Why standard regression falls short</h3>
<p>A logistic regression of MACE on treatment will confound the effect with differences in baseline health. Patients prescribed newer, more expensive agents may differ systematically from those prescribed sulfonylureas — in age, comorbidity burden, prior cardiovascular history, renal function, and concomitant medications.</p>
<p>We need methods that explicitly separate confounding from causal effects.</p>
<hr>
</section>
</section>
</section>
<section id="the-causal-roadmap" class="level1">
<h1>2. The Causal Roadmap</h1>
<p>We follow a five-step workflow that structures every causal analysis.</p>
<section id="step-1-define-the-causal-question" class="level2">
<h2 class="anchored" data-anchor-id="step-1-define-the-causal-question">Step 1: Define the Causal Question</h2>
<p><strong>In plain language:</strong> What would happen to 1-year MACE risk if every eligible patient started dapagliflozin, compared to if every eligible patient started a sulfonylurea?</p>
<p><strong>As a counterfactual estimand:</strong></p>
<p>The Average Treatment Effect (ATE) on the risk difference scale:</p>
<p><span class="math display">\[
\psi = E[Y(1)] - E[Y(0)]
\]</span></p>
<p>where <span class="math inline">\(Y(a)\)</span> is the potential outcome under treatment strategy <span class="math inline">\(a\)</span>.</p>
<ul>
<li><span class="math inline">\(E[Y(1)]\)</span> = population risk of MACE if everyone took dapagliflozin</li>
<li><span class="math inline">\(E[Y(0)]\)</span> = population risk of MACE if everyone took sulfonylurea</li>
<li>A negative <span class="math inline">\(\psi\)</span> means dapagliflozin is protective; a positive <span class="math inline">\(\psi\)</span> means increased risk</li>
</ul>
</section>
<section id="step-2-define-the-causal-model" class="level2">
<h2 class="anchored" data-anchor-id="step-2-define-the-causal-model">Step 2: Define the Causal Model</h2>
<p>We posit the following causal structure. Confounders <span class="math inline">\(W\)</span> affect both treatment choice <span class="math inline">\(A\)</span> and the outcome <span class="math inline">\(Y\)</span>. Treatment <span class="math inline">\(A\)</span> also affects <span class="math inline">\(Y\)</span> directly.</p>
<p>The confounders include:</p>
<ul>
<li><strong>Age</strong> — older patients have higher CV risk and may receive different prescriptions</li>
<li><strong>BMI</strong> — obesity correlates with both drug choice and CV risk</li>
<li><strong>HbA1c</strong> — glycemic control at baseline affects prescribing and outcomes</li>
<li><strong>Prior CVD</strong> — history of cardiovascular disease is a strong confounder</li>
<li><strong>eGFR</strong> — renal function influences both drug eligibility and CV risk</li>
<li><strong>Statin use</strong> — a marker of CV risk management</li>
</ul>
<p>The DAG (directed acyclic graph):</p>
<pre><code>       W (age, BMI, HbA1c, prior CVD, eGFR, statin)
      / \
     v   v
     A --&gt; Y</code></pre>
<p>All arrows from <span class="math inline">\(W\)</span> point to both <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span>. There is a direct arrow from <span class="math inline">\(A\)</span> to <span class="math inline">\(Y\)</span>. There are no arrows from <span class="math inline">\(A\)</span> back to <span class="math inline">\(W\)</span> (this is a point-treatment analysis at baseline).</p>
<p>Structural equations:</p>
<ul>
<li><span class="math inline">\(W\)</span> is drawn from the population distribution</li>
<li><span class="math inline">\(A = f_A(W, U_A)\)</span> — treatment depends on confounders and unmeasured factors</li>
<li><span class="math inline">\(Y = f_Y(A, W, U_Y)\)</span> — outcome depends on treatment, confounders, and unmeasured factors</li>
</ul>
</section>
<section id="step-3-identify-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="step-3-identify-assumptions">Step 3: Identify Assumptions</h2>
<p>For the causal estimand <span class="math inline">\(\psi = E[Y(1)] - E[Y(0)]\)</span> to be identified from observational data, we need:</p>
<p><strong>Consistency:</strong> The observed outcome for a patient who received treatment <span class="math inline">\(a\)</span> equals their potential outcome <span class="math inline">\(Y(a)\)</span>. This requires a well-defined intervention — “initiate dapagliflozin” must mean the same thing across patients. In practice, we define treatment as filling a new prescription.</p>
<p><strong>Exchangeability (no unmeasured confounding):</strong> <span class="math inline">\(Y(a) \perp\!\!\!\perp A \mid W\)</span> for all <span class="math inline">\(a\)</span>. Conditional on measured baseline covariates, treatment assignment is as-good-as-random. This is the most vulnerable assumption. We cannot test it, but we can make it more plausible by adjusting for a rich set of confounders.</p>
<p><strong>Positivity:</strong> <span class="math inline">\(0 &lt; P(A = 1 \mid W = w) &lt; 1\)</span> for all <span class="math inline">\(w\)</span> with <span class="math inline">\(P(W = w) &gt; 0\)</span>. Every patient type has some chance of receiving either drug. Violations occur when, for example, patients with severe renal impairment are never prescribed dapagliflozin.</p>
<p>Each assumption is untestable but can be made more or less plausible by study design.</p>
</section>
<section id="step-4-map-to-a-statistical-estimand" class="level2">
<h2 class="anchored" data-anchor-id="step-4-map-to-a-statistical-estimand">Step 4: Map to a Statistical Estimand</h2>
<p>Under the three assumptions above, the causal estimand equals a statistical quantity we can estimate from data:</p>
<p><span class="math display">\[
\psi = E_W\big[E[Y \mid A=1, W]\big] - E_W\big[E[Y \mid A=0, W]\big]
\]</span></p>
<p>This is the <strong>G-computation identification formula</strong>. It says: fit a model for <span class="math inline">\(E[Y \mid A, W]\)</span>, predict under <span class="math inline">\(A = 1\)</span> and <span class="math inline">\(A = 0\)</span> for every patient, and average over the population distribution of <span class="math inline">\(W\)</span>.</p>
<p>Equivalently, using the propensity score <span class="math inline">\(g(W) = P(A=1 \mid W)\)</span>:</p>
<p><span class="math display">\[
E[Y(a)] = E\left[\frac{I(A=a) Y}{P(A=a \mid W)}\right]
\]</span></p>
<p>This is the <strong>IPTW identification formula</strong>.</p>
<p>Both representations target the same quantity. They differ in which nuisance function they rely on.</p>
</section>
<section id="step-5-choose-an-estimation-strategy" class="level2">
<h2 class="anchored" data-anchor-id="step-5-choose-an-estimation-strategy">Step 5: Choose an Estimation Strategy</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 27%">
<col style="width: 27%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Relies on</th>
<th>Robust to</th>
<th>Weakness</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>G-computation</td>
<td>Outcome model <span class="math inline">\(E[Y \mid A, W]\)</span></td>
<td>Treatment model misspecification</td>
<td>Sensitive to outcome model misspecification</td>
</tr>
<tr class="even">
<td>IPTW</td>
<td>Treatment model <span class="math inline">\(P(A \mid W)\)</span></td>
<td>Outcome model misspecification</td>
<td>Sensitive to positivity violations and weight instability</td>
</tr>
<tr class="odd">
<td>AIPW</td>
<td>Both models</td>
<td>Misspecification of either one model</td>
<td>Not targeted; can produce out-of-bounds estimates</td>
</tr>
<tr class="even">
<td>TMLE</td>
<td>Both models</td>
<td>Misspecification of either one model</td>
<td>More complex to implement; requires understanding the targeting step</td>
</tr>
</tbody>
</table>
<p>TMLE additionally:</p>
<ul>
<li>Respects the natural bounds of the parameter space (probabilities stay between 0 and 1)</li>
<li>Achieves the semiparametric efficiency bound when both models are well-specified</li>
<li>Provides valid inference through the efficient influence curve</li>
<li>Integrates naturally with machine learning via Super Learner</li>
</ul>
<p>We now implement each estimator progressively.</p>
<hr>
</section>
</section>
<section id="data-simulation" class="level1">
<h1>3. Data Simulation</h1>
<p>We simulate a realistic claims-like dataset with multiple confounders, nonlinear effects, and treatment-confounder interactions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.6.0
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline confounders ---</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>age    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">62</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>bmi    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">31</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>hba1c  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">8.2</span>, <span class="at">sd =</span> <span class="fl">1.3</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior CVD: more likely with age and high BMI</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>cvd    <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> bmi))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># eGFR: lower with age, higher with lower BMI</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>egfr   <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">15</span>, <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">95</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">-</span> <span class="fl">0.3</span> <span class="sc">*</span> bmi, <span class="at">sd =</span> <span class="dv">15</span>))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Statin use: more likely with CVD and age</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>statin <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">1.8</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> age))</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment model (propensity score) ---</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Dapagliflozin is preferentially prescribed to:</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># - younger patients, higher eGFR (renal eligibility), higher BMI, lower HbA1c</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes nonlinear terms and interactions</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">+</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.15</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span>         <span class="co"># interaction</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.002</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span>             <span class="co"># nonlinear age effect</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_trt))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome model ---</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># MACE risk depends on treatment, confounders, with nonlinearities</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># True treatment effect: dapagliflozin REDUCES MACE risk (protective)</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>lp_out <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> A <span class="sc">+</span>                       <span class="co"># true causal effect (protective)</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span>        <span class="co"># interaction</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span>           <span class="co"># nonlinear age effect</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> A <span class="sc">*</span> cvd                   <span class="co"># treatment-confounder interaction</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_out))</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(age, bmi, hba1c, cvd, egfr, statin, A, Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="true-causal-effect" class="level3">
<h3 class="anchored" data-anchor-id="true-causal-effect">True causal effect</h3>
<p>We compute the true ATE from the data-generating process:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># True potential outcomes from the structural model</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>p1_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span> <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span> <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> cvd)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>p0_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span> <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span> <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> cvd)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>true_ate <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_true <span class="sc">-</span> p0_true)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE (risk difference):"</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE (risk difference): -0.0338 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under dapagliflozin:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p1_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True risk under dapagliflozin: 0.0691 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under sulfonylurea: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p0_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True risk under sulfonylurea:  0.1029 </code></pre>
</div>
</div>
</section>
<section id="inspect-the-data" class="level3">
<h3 class="anchored" data-anchor-id="inspect-the-data">Inspect the data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n          =</span> <span class="fu">n</span>(),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_age   =</span> <span class="fu">mean</span>(age),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_bmi   =</span> <span class="fu">mean</span>(bmi),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_hba1c =</span> <span class="fu">mean</span>(hba1c),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_cvd    =</span> <span class="fu">mean</span>(cvd),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_egfr  =</span> <span class="fu">mean</span>(egfr),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_statin =</span> <span class="fu">mean</span>(statin),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mace_rate  =</span> <span class="fu">mean</span>(Y),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 9
      A     n mean_age mean_bmi mean_hba1c pct_cvd mean_egfr pct_statin
  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
1     0  3828     62.6     30.9       8.27   0.532      83.7      0.653
2     1  1172     59.7     31.7       8.01   0.334      89.1      0.515
# ℹ 1 more variable: mace_rate &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Notice the imbalances: dapagliflozin patients are younger, have higher eGFR, and less prior CVD. These differences will bias a naive comparison.</p>
<hr>
</section>
</section>
<section id="progressive-estimation" class="level1">
<h1>4. Progressive Estimation</h1>
<section id="a.-naive-unadjusted-model" class="level2">
<h2 class="anchored" data-anchor-id="a.-naive-unadjusted-model">4A. Naive (Unadjusted) Model</h2>
<p>We start with what many analysts would try first: a simple comparison of MACE rates by treatment group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unadjusted risk difference</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>risk_A1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>risk_A0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>naive_rd <span class="ot">&lt;-</span> risk_A1 <span class="sc">-</span> risk_A0</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk (dapagliflozin):"</span>, <span class="fu">round</span>(risk_A1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Naive risk (dapagliflozin): 0.0444 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk (sulfonylurea): "</span>, <span class="fu">round</span>(risk_A0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Naive risk (sulfonylurea):  0.11 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk difference:     "</span>, <span class="fu">round</span>(naive_rd, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Naive risk difference:      -0.0656 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                  "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                   -0.0338 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unadjusted logistic regression</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>naive_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(naive_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Y ~ A, family = binomial, data = dat)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -2.09095    0.05166 -40.475  &lt; 2e-16 ***
A           -0.97889    0.15095  -6.485 8.89e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 3130.5  on 4999  degrees of freedom
Residual deviance: 3078.2  on 4998  degrees of freedom
AIC: 3082.2

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p><strong>What went wrong?</strong> The naive estimate is biased because dapagliflozin patients differ systematically from sulfonylurea patients. The treatment groups are not exchangeable. The naive estimate conflates the drug effect with the confounding by indication.</p>
<hr>
</section>
<section id="b.-g-computation-outcome-modeling" class="level2">
<h2 class="anchored" data-anchor-id="b.-g-computation-outcome-modeling">4B. G-Computation (Outcome Modeling)</h2>
<p>G-computation directly implements the identification formula by modeling <span class="math inline">\(E[Y \mid A, W]\)</span>, then standardizing.</p>
<section id="step-1-fit-the-outcome-model" class="level3">
<h3 class="anchored" data-anchor-id="step-1-fit-the-outcome-model">Step 1: Fit the outcome model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parametric outcome model (logistic regression)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We include main effects and key interactions</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>               A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-predict-counterfactual-outcomes" class="level3">
<h3 class="anchored" data-anchor-id="step-2-predict-counterfactual-outcomes">Step 2: Predict counterfactual outcomes</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create counterfactual datasets</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>dat1 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict potential outcomes for each individual</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>Q1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>Q0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat0, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3-standardize-average-over-the-population" class="level3">
<h3 class="anchored" data-anchor-id="step-3-standardize-average-over-the-population">Step 3: Standardize (average over the population)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>gcomp_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>gcomp_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>gcomp_ate   <span class="ot">&lt;-</span> gcomp_risk1 <span class="sc">-</span> gcomp_risk0</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp risk (dapagliflozin):"</span>, <span class="fu">round</span>(gcomp_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp risk (dapagliflozin): 0.0629 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp risk (sulfonylurea): "</span>, <span class="fu">round</span>(gcomp_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp risk (sulfonylurea):  0.0996 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp ATE:                 "</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp ATE:                  -0.0367 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                   "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                    -0.0338 </code></pre>
</div>
</div>
</section>
<section id="bootstrap-confidence-interval-for-g-computation" class="level3">
<h3 class="anchored" data-anchor-id="bootstrap-confidence-interval-for-g-computation">Bootstrap confidence interval for G-computation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>n_boot <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>boot_ate <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_boot)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_boot) {</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  dat_b <span class="ot">&lt;-</span> dat[idx, ]</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  mod_b <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>                  A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial, <span class="at">data =</span> dat_b)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  Q1_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_b, <span class="at">newdata =</span> dat_b <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  Q0_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_b, <span class="at">newdata =</span> dat_b <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  boot_ate[b] <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_b <span class="sc">-</span> Q0_b)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>gcomp_se <span class="ot">&lt;-</span> <span class="fu">sd</span>(boot_ate)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>gcomp_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_ate, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp ATE:"</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>),</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(gcomp_se, <span class="dv">4</span>),</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(gcomp_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(gcomp_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp ATE: -0.0367  SE: 0.0098  95% CI: [ -0.0569 , -0.0191 ]</code></pre>
</div>
</div>
<p><strong>Key insight:</strong> G-computation gave a much better estimate than the naive approach by adjusting for confounders. But it depends entirely on the outcome model being correct. If we misspecified the functional form (missed interactions, nonlinearities), the estimate would be biased.</p>
<hr>
</section>
</section>
<section id="c.-iptw-treatment-modeling" class="level2">
<h2 class="anchored" data-anchor-id="c.-iptw-treatment-modeling">4C. IPTW (Treatment Modeling)</h2>
<p>IPTW takes a different approach: instead of modeling the outcome, it models treatment assignment and reweights the data to create a pseudo-population where confounders are balanced.</p>
<section id="step-1-estimate-the-propensity-score" class="level3">
<h3 class="anchored" data-anchor-id="step-1-estimate-the-propensity-score">Step 1: Estimate the propensity score</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Propensity score model</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> age<span class="sc">:</span>cvd,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ps =</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of propensity scores</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.002505 0.146338 0.220684 0.234400 0.314028 0.632319 </code></pre>
</div>
</div>
</section>
<section id="step-2-assess-propensity-score-overlap" class="level3">
<h3 class="anchored" data-anchor-id="step-2-assess-propensity-score-overlap">Step 2: Assess propensity score overlap</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated propensity score P(A=1 | W)"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Overlap"</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Good overlap means every type of patient has some chance of getting either drug. If the distributions barely overlap, IPTW will produce extreme weights and unstable estimates.</p>
</section>
<section id="step-3-construct-stabilized-weights" class="level3">
<h3 class="anchored" data-anchor-id="step-3-construct-stabilized-weights">Step 3: Construct stabilized weights</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal treatment probability</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>p_A <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>A)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unstabilized weights</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_unstab =</span> <span class="fu">ifelse</span>(A <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> ps, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stabilized weights</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sw =</span> <span class="fu">ifelse</span>(A <span class="sc">==</span> <span class="dv">1</span>, p_A <span class="sc">/</span> ps, (<span class="dv">1</span> <span class="sc">-</span> p_A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4-diagnose-weights" class="level3">
<h3 class="anchored" data-anchor-id="step-4-diagnose-weights">Step 4: Diagnose weights</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Weight diagnostics</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_w  =</span> <span class="fu">min</span>(sw),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">p01_w  =</span> <span class="fu">quantile</span>(sw, <span class="fl">0.01</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(sw),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">p99_w  =</span> <span class="fu">quantile</span>(sw, <span class="fl">0.99</span>),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_w  =</span> <span class="fu">max</span>(sw),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_w =</span> <span class="fu">mean</span>(sw),</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_w   =</span> <span class="fu">sd</span>(sw),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 8
      A min_w p01_w median p99_w max_w mean_w  sd_w
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1     0 0.768 0.784  0.960  1.50  2.08  1.00  0.161
2     1 0.373 0.406  0.817  3.22  7.06  0.991 0.594</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Weight distribution plot</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> sw, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stabilized IPTW weight"</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of Stabilized IPTW Weights"</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>)) <span class="sc">+</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>What to look for:</strong></p>
<ul>
<li>Weights should be centered around 1 (for stabilized weights)</li>
<li>Very large weights (&gt; 10) indicate positivity problems</li>
<li>The mean of stabilized weights should be approximately 1</li>
</ul>
</section>
<section id="step-5-check-covariate-balance-after-weighting" class="level3">
<h3 class="anchored" data-anchor-id="step-5-check-covariate-balance-after-weighting">Step 5: Check covariate balance after weighting</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardized mean differences: unweighted vs weighted</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>compute_smd <span class="ot">&lt;-</span> <span class="cf">function</span>(data, var, trt, <span class="at">weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(weights)) weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  w1 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  w0 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d1, w1)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d0, w0)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w1 <span class="sc">*</span> (d1 <span class="sc">-</span> m1)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w1))</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  s0 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w0 <span class="sc">*</span> (d0 <span class="sc">-</span> m0)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w0))</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  pooled_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((s1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> s0<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  (m1 <span class="sc">-</span> m0) <span class="sc">/</span> pooled_sd</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"bmi"</span>, <span class="st">"hba1c"</span>, <span class="st">"cvd"</span>, <span class="st">"egfr"</span>, <span class="st">"statin"</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>smd_raw <span class="ot">&lt;-</span> <span class="fu">sapply</span>(covariates, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>))</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>smd_wt  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(covariates, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>, dat<span class="sc">$</span>sw))</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>smd_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> covariates,</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">Unadjusted =</span> <span class="fu">abs</span>(smd_raw),</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">Weighted   =</span> <span class="fu">abs</span>(smd_wt)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>variable, <span class="at">names_to =</span> <span class="st">"Method"</span>, <span class="at">values_to =</span> <span class="st">"SMD"</span>)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(smd_df, <span class="fu">aes</span>(<span class="at">x =</span> SMD, <span class="at">y =</span> <span class="fu">reorder</span>(variable, SMD), <span class="at">color =</span> Method, <span class="at">shape =</span> Method)) <span class="sc">+</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Absolute Standardized Mean Difference"</span>,</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Covariate Balance: Before and After IPTW"</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#EE6677"</span>, <span class="st">"#228833"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The dashed line at 0.1 is a common threshold. After weighting, all covariates should be below this line.</p>
</section>
<section id="step-6-estimate-the-ate" class="level3">
<h3 class="anchored" data-anchor-id="step-6-estimate-the-ate">Step 6: Estimate the ATE</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hajek (ratio) estimator with stabilized weights</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>risk1_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>risk0_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>iptw_ate   <span class="ot">&lt;-</span> risk1_iptw <span class="sc">-</span> risk0_iptw</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW risk (dapagliflozin):"</span>, <span class="fu">round</span>(risk1_iptw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW risk (dapagliflozin): 0.0559 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW risk (sulfonylurea): "</span>, <span class="fu">round</span>(risk0_iptw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW risk (sulfonylurea):  0.0996 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE:                 "</span>, <span class="fu">round</span>(iptw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW ATE:                  -0.0438 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                  -0.0338 </code></pre>
</div>
</div>
</section>
<section id="weight-truncation" class="level3">
<h3 class="anchored" data-anchor-id="weight-truncation">Weight truncation</h3>
<p>If weights are extreme, truncation can improve stability at the cost of a small amount of bias:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Truncate at 1st and 99th percentiles</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>trunc_lower <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw, <span class="fl">0.01</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>trunc_upper <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw, <span class="fl">0.99</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sw_trunc =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(sw, trunc_lower), trunc_upper))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>risk1_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>risk0_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>iptw_ate_trunc <span class="ot">&lt;-</span> risk1_trunc <span class="sc">-</span> risk0_trunc</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE (truncated weights):"</span>, <span class="fu">round</span>(iptw_ate_trunc, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW ATE (truncated weights): -0.0472 </code></pre>
</div>
</div>
<p><strong>Key insight:</strong> IPTW adjusts for confounding through the treatment model alone. It does not use information about the outcome-confounder relationship. If the propensity score model is wrong, IPTW is biased. If positivity is limited, weights become extreme and the estimate becomes unstable.</p>
<hr>
</section>
</section>
<section id="d.-aipw-augmented-inverse-probability-weighting" class="level2">
<h2 class="anchored" data-anchor-id="d.-aipw-augmented-inverse-probability-weighting">4D. AIPW (Augmented Inverse Probability Weighting)</h2>
<p>AIPW combines the outcome model and the treatment model. It is <strong>doubly robust</strong>: consistent if either model is correct.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using models from previous steps:</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1, Q0 = predicted outcomes from g-computation</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ps     = propensity scores from IPTW</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># AIPW components</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>mu1_aipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">mean</span>(</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  Q1 <span class="sc">+</span> A <span class="sc">*</span> (Y <span class="sc">-</span> Q1) <span class="sc">/</span> ps</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>mu0_aipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">mean</span>(</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  Q0 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">*</span> (Y <span class="sc">-</span> Q0) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>aipw_ate <span class="ot">&lt;-</span> mu1_aipw <span class="sc">-</span> mu0_aipw</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW risk (dapagliflozin):"</span>, <span class="fu">round</span>(mu1_aipw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW risk (dapagliflozin): 0.0596 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW risk (sulfonylurea): "</span>, <span class="fu">round</span>(mu0_aipw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW risk (sulfonylurea):  0.0995 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW ATE:                 "</span>, <span class="fu">round</span>(aipw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW ATE:                  -0.04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                  -0.0338 </code></pre>
</div>
</div>
<section id="influence-curve-and-inference" class="level3">
<h3 class="anchored" data-anchor-id="influence-curve-and-inference">Influence curve and inference</h3>
<p>The efficient influence curve (EIC) for the ATE gives us individual-level “scores” that measure each observation’s contribution to the estimate. The variance of these scores provides valid standard errors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Efficient influence curve for ATE</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>eic <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  (A <span class="sc">/</span> ps) <span class="sc">*</span> (Y <span class="sc">-</span> Q1) <span class="sc">+</span> Q1 <span class="sc">-</span> mu1_aipw <span class="sc">-</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  ((<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)) <span class="sc">*</span> (Y <span class="sc">-</span> Q0) <span class="sc">-</span> Q0 <span class="sc">+</span> mu0_aipw</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>aipw_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic) <span class="sc">/</span> n)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>aipw_ci <span class="ot">&lt;-</span> aipw_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> aipw_se</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW ATE:"</span>, <span class="fu">round</span>(aipw_ate, <span class="dv">4</span>),</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(aipw_se, <span class="dv">4</span>),</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(aipw_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(aipw_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW ATE: -0.04  SE: 0.0101  95% CI: [ -0.0598 , -0.0201 ]</code></pre>
</div>
</div>
<p><strong>Key insight:</strong> AIPW improves on both g-computation and IPTW by using both models. However, AIPW does not “target” its initial estimates — it can produce predicted probabilities outside [0, 1], and it does not solve the efficient influence curve equation exactly when machine learning is used. TMLE addresses both issues.</p>
<hr>
</section>
</section>
<section id="e.-tmle-targeted-maximum-likelihood-estimation" class="level2">
<h2 class="anchored" data-anchor-id="e.-tmle-targeted-maximum-likelihood-estimation">4E. TMLE (Targeted Maximum Likelihood Estimation)</h2>
<p>TMLE is the centerpiece of this chapter. It combines the best properties of all previous methods:</p>
<ul>
<li>Uses both outcome and treatment models (doubly robust)</li>
<li>Targets the specific estimand of interest (not just fitting a good outcome model)</li>
<li>Respects natural parameter bounds</li>
<li>Solves the efficient influence curve equation, ensuring valid inference</li>
<li>Integrates naturally with machine learning (Super Learner)</li>
</ul>
<section id="conceptual-overview" class="level3">
<h3 class="anchored" data-anchor-id="conceptual-overview">Conceptual overview</h3>
<p>TMLE works in three stages:</p>
<ol type="1">
<li><strong>Initial estimate:</strong> Fit an outcome model <span class="math inline">\(\hat{Q}^0(A, W) = \hat{E}[Y \mid A, W]\)</span> (like g-computation)</li>
<li><strong>Targeting step:</strong> Update <span class="math inline">\(\hat{Q}^0\)</span> using information from the propensity score to reduce bias for the specific estimand</li>
<li><strong>Substitution estimate:</strong> Plug the updated <span class="math inline">\(\hat{Q}^*\)</span> into the G-computation formula</li>
</ol>
<p>The targeting step is what makes TMLE special. It uses the <strong>clever covariate</strong> — a function of the propensity score — to fluctuate the initial outcome model in the direction that solves the efficient influence curve equation.</p>
</section>
<section id="step-by-step-implementation" class="level3">
<h3 class="anchored" data-anchor-id="step-by-step-implementation">Step-by-step implementation</h3>
<section id="step-1-initial-outcome-model" class="level4">
<h4 class="anchored" data-anchor-id="step-1-initial-outcome-model">Step 1: Initial outcome model</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same as g-computation — fit E[Y | A, W]</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>q_init <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial predictions</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>Q1_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>Q0_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>QA_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">type =</span> <span class="st">"response"</span>)  <span class="co"># predictions at observed A</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-estimate-the-propensity-score" class="level4">
<h4 class="anchored" data-anchor-id="step-2-estimate-the-propensity-score">Step 2: Estimate the propensity score</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same model as IPTW</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>g_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> age<span class="sc">:</span>cvd,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>ps_tmle <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_fit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Bound propensity scores away from 0 and 1 for stability</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>ps_tmle <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.01</span>, <span class="fu">pmin</span>(<span class="fl">0.99</span>, ps_tmle))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3-compute-the-clever-covariate" class="level4">
<h4 class="anchored" data-anchor-id="step-3-compute-the-clever-covariate">Step 3: Compute the clever covariate</h4>
<p>The clever covariate <span class="math inline">\(H(A, W)\)</span> is the bridge between the treatment model and the outcome model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for each observation at their OBSERVED treatment</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>H_A <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">/</span> ps_tmle <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate under A=1 and A=0 (for prediction)</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>H_1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ps_tmle</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>H_0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The clever covariate is large when a patient’s treatment was unlikely given their covariates — exactly the patients who are most informative about the causal effect.</p>
</section>
<section id="step-4-fluctuation-targeting-model" class="level4">
<h4 class="anchored" data-anchor-id="step-4-fluctuation-targeting-model">Step 4: Fluctuation (targeting) model</h4>
<p>This is the key step. We fit a logistic regression of <span class="math inline">\(Y\)</span> on <span class="math inline">\(H(A, W)\)</span> with the initial <span class="math inline">\(\hat{Q}^0\)</span> as an offset. The coefficient <span class="math inline">\(\epsilon\)</span> tells us how much to update the initial estimate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fluctuation model: logit(Y) ~ offset(logit(Q_init)) + H</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>fluc <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QA_init)) <span class="sc">+</span> H_A,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon (fluctuation parameter):"</span>, <span class="fu">round</span>(epsilon, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epsilon (fluctuation parameter): -0.00633 </code></pre>
</div>
</div>
<p>A small <span class="math inline">\(\epsilon\)</span> means the initial model was already close to solving the EIC equation. A large <span class="math inline">\(\epsilon\)</span> means the targeting step made a substantial correction.</p>
</section>
<section id="step-5-update-predictions" class="level4">
<h4 class="anchored" data-anchor-id="step-5-update-predictions">Step 5: Update predictions</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the fluctuation to counterfactual predictions</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>Q1_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q1_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_1)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>Q0_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q0_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we apply <code>plogis()</code> (the inverse-logit function), which guarantees predictions stay in [0, 1]. This is the “substitution estimator” property of TMLE.</p>
</section>
<section id="step-6-compute-the-tmle-estimate" class="level4">
<h4 class="anchored" data-anchor-id="step-6-compute-the-tmle-estimate">Step 6: Compute the TMLE estimate</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>tmle_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_star)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>tmle_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_star)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>tmle_ate   <span class="ot">&lt;-</span> tmle_risk1 <span class="sc">-</span> tmle_risk0</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (dapagliflozin):"</span>, <span class="fu">round</span>(tmle_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE risk (dapagliflozin): 0.0594 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (sulfonylurea): "</span>, <span class="fu">round</span>(tmle_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE risk (sulfonylurea):  0.1002 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:                 "</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE ATE:                  -0.0409 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                  -0.0338 </code></pre>
</div>
</div>
</section>
<section id="step-7-inference-via-the-efficient-influence-curve" class="level4">
<h4 class="anchored" data-anchor-id="step-7-inference-via-the-efficient-influence-curve">Step 7: Inference via the efficient influence curve</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># EIC evaluated at the TMLE estimates</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>eic_tmle <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  (A <span class="sc">/</span> ps_tmle) <span class="sc">*</span> (Y <span class="sc">-</span> Q1_star) <span class="sc">+</span> Q1_star <span class="sc">-</span> tmle_risk1 <span class="sc">-</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  ((<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)) <span class="sc">*</span> (Y <span class="sc">-</span> Q0_star) <span class="sc">-</span> Q0_star <span class="sc">+</span> tmle_risk0</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>tmle_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic_tmle) <span class="sc">/</span> n)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>tmle_ci <span class="ot">&lt;-</span> tmle_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> tmle_se</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:"</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>),</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(tmle_se, <span class="dv">4</span>),</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE ATE: -0.0409  SE: 0.0102  95% CI: [ -0.0608 , -0.021 ]</code></pre>
</div>
</div>
</section>
</section>
<section id="verify-the-eic-mean-is-approximately-zero" class="level3">
<h3 class="anchored" data-anchor-id="verify-the-eic-mean-is-approximately-zero">Verify: the EIC mean is approximately zero</h3>
<p>A correctly implemented TMLE solves the efficient influence curve equation, meaning the sample mean of the EIC should be approximately zero:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of EIC:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic_tmle), <span class="dv">8</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean of EIC: 0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(Should be very close to zero)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Should be very close to zero)</code></pre>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="comparing-all-estimators" class="level1">
<h1>5. Comparing All Estimators</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method  =</span> <span class="fu">c</span>(<span class="st">"Naive"</span>, <span class="st">"G-computation"</span>, <span class="st">"IPTW"</span>, <span class="st">"IPTW (truncated)"</span>, <span class="st">"AIPW"</span>, <span class="st">"TMLE"</span>),</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATE     =</span> <span class="fu">c</span>(naive_rd, gcomp_ate, iptw_ate, iptw_ate_trunc, aipw_ate, tmle_ate),</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE      =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_se, <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_se, tmle_se),</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_low  =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_ci[<span class="dv">1</span>], <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_ci[<span class="dv">1</span>], tmle_ci[<span class="dv">1</span>]),</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_high =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_ci[<span class="dv">2</span>], <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_ci[<span class="dv">2</span>], tmle_ci[<span class="dv">2</span>])</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  Method               ATE      SE  CI_low CI_high
  &lt;chr&gt;              &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 Naive            -0.0656 NA      NA      NA     
2 G-computation    -0.0367  0.0098 -0.0569 -0.0191
3 IPTW             -0.0438 NA      NA      NA     
4 IPTW (truncated) -0.0472 NA      NA      NA     
5 AIPW             -0.04    0.0101 -0.0598 -0.0201
6 TMLE             -0.0409  0.0102 -0.0608 -0.021 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the comparison</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(SE)) <span class="sc">%&gt;%</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="fu">factor</span>(Method, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"G-computation"</span>, <span class="st">"AIPW"</span>, <span class="st">"TMLE"</span>)))</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> ATE, <span class="at">y =</span> Method)) <span class="sc">+</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> CI_low, <span class="at">xmax =</span> CI_high), <span class="at">height =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_ate, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> true_ate, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">label =</span> <span class="st">"True ATE"</span>,</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated ATE (Risk Difference)"</span>,</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Causal Estimators"</span>,</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red dashed line = true causal effect"</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="diagnostics" class="level1">
<h1>6. Diagnostics</h1>
<p>Good estimation is nothing without good diagnostics. This section covers the checks every analyst should perform.</p>
<section id="propensity-score-overlap" class="level2">
<h2 class="anchored" data-anchor-id="propensity-score-overlap">6.1 Propensity Score Overlap</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps_tmle, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">40</span>, <span class="at">alpha =</span> <span class="fl">0.55</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Propensity score"</span>,</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Distribution by Treatment Group"</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Interpretation:</strong> If the histograms have substantial overlap, the positivity assumption is plausible. Gaps indicate regions where one treatment is rarely or never prescribed — IPTW will struggle there.</p>
</section>
<section id="weight-distribution" class="level2">
<h2 class="anchored" data-anchor-id="weight-distribution">6.2 Weight Distribution</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Unstabilized weight summary ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Unstabilized weight summary ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>w_unstab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.003   1.182   1.337   1.991   1.828  30.108 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Stabilized weight summary ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Stabilized weight summary ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>sw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3727  0.8562  0.9480  0.9977  1.0891  7.0573 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Proportion of stabilized weights &gt; 5:"</span>, <span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Proportion of stabilized weights &gt; 5: 6e-04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion of stabilized weights &gt; 10:"</span>, <span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Proportion of stabilized weights &gt; 10: 0 </code></pre>
</div>
</div>
</section>
<section id="clever-covariate-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="clever-covariate-diagnostics">6.3 Clever Covariate Diagnostics</h2>
<p>The clever covariate drives the TMLE targeting step. Extreme values indicate potential instability:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>clever_cov_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">H =</span> H_A,</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="fu">factor</span>(dat<span class="sc">$</span>A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>))</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(clever_cov_df, <span class="fu">aes</span>(<span class="at">x =</span> H, <span class="at">fill =</span> treatment)) <span class="sc">+</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Clever covariate H(A, W)"</span>,</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of the Clever Covariate"</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="influence-curve-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="influence-curve-diagnostics">6.4 Influence Curve Diagnostics</h2>
<p>The EIC values reveal influential observations. A well-behaved estimator has EIC values centered near zero with no extreme outliers:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>eic_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">eic =</span> eic_tmle)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(eic_df, <span class="fu">aes</span>(<span class="at">x =</span> eic)) <span class="sc">+</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#228833"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Efficient influence curve value"</span>,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of TMLE Influence Curve Values"</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EIC summary:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(eic_tmle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-4.80971 -0.02585  0.08820  0.00000  0.12378 24.86376 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic_tmle), <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EIC mean: 0 </code></pre>
</div>
</div>
</section>
<section id="extreme-prediction-check" class="level2">
<h2 class="anchored" data-anchor-id="extreme-prediction-check">6.5 Extreme Prediction Check</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Predicted outcome range (initial model) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Predicted outcome range (initial model) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q1 range: 0.0088 0.7715 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q0 range: 0.0091 0.877 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Predicted outcome range (after targeting) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Predicted outcome range (after targeting) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1* range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_star), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q1* range: 0.0087 0.6419 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0* range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_star), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q0* range: 0.0092 0.8777 </code></pre>
</div>
</div>
<p>Notice that TMLE keeps all predictions between 0 and 1 by construction — the logistic fluctuation guarantees this.</p>
<hr>
</section>
</section>
<section id="interpretation" class="level1">
<h1>7. Interpretation</h1>
<section id="translating-to-regulatory-language" class="level2">
<h2 class="anchored" data-anchor-id="translating-to-regulatory-language">Translating to regulatory language</h2>
<p>Based on the TMLE analysis:</p>
<ul>
<li><strong>Point estimate:</strong> Dapagliflozin is estimated to reduce 1-year MACE risk by approximately 4.1 percentage points compared to sulfonylurea</li>
<li><strong>Confidence interval:</strong> The 95% CI is [-6.1, -2.1] percentage points</li>
<li><strong>Risk difference vs.&nbsp;odds ratio:</strong> We report on the risk difference scale because it is directly interpretable. An odds ratio would obscure the magnitude of absolute risk change, which is what matters for labeling and clinical decisions.</li>
</ul>
</section>
<section id="regulatory-decision" class="level2">
<h2 class="anchored" data-anchor-id="regulatory-decision">Regulatory decision</h2>
<p>If the confidence interval excludes zero and the point estimate is negative (protective), the data do not support adding a cardiovascular warning. If the CI includes zero, the evidence is inconclusive and further monitoring or a dedicated outcomes trial may be warranted.</p>
</section>
<section id="sensitivity-to-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="sensitivity-to-assumptions">Sensitivity to assumptions</h2>
<p><strong>Which assumptions are most fragile?</strong></p>
<ol type="1">
<li><p><strong>No unmeasured confounding (exchangeability):</strong> This is always the weakest link in observational data. Lifestyle factors (diet, exercise, smoking) may confound and are poorly captured in claims data.</p></li>
<li><p><strong>Positivity:</strong> If some patient types never receive one drug (e.g., patients with very low eGFR are ineligible for SGLT2 inhibitors), the ATE is not identifiable for the full population. Consider restricting to a subpopulation where positivity holds.</p></li>
<li><p><strong>Consistency:</strong> If treatment initiation is not well-defined (e.g., varying doses), the potential outcomes are ambiguous.</p></li>
</ol>
<p><strong>What if unmeasured confounding exists?</strong> A sensitivity analysis (E-value or bias analysis) can quantify how strong unmeasured confounding would need to be to explain away the observed effect.</p>
<hr>
</section>
</section>
<section id="why-super-learner-improves-nuisance-estimation" class="level1">
<h1>8. Why Super Learner Improves Nuisance Estimation</h1>
<p>In the examples above, we used parametric logistic regression for both the outcome and treatment models. In practice, these models may be misspecified — missing interactions, wrong functional forms, or overly rigid assumptions.</p>
<p><strong>Super Learner</strong> is an ensemble machine learning method that:</p>
<ol type="1">
<li>Takes a library of candidate learners (logistic regression, LASSO, random forest, etc.)</li>
<li>Uses cross-validation to evaluate each learner’s performance</li>
<li>Combines them using optimally weighted stacking</li>
<li>Guarantees performance at least as good as the best individual learner (asymptotically)</li>
</ol>
<section id="why-this-matters-for-tmle" class="level3">
<h3 class="anchored" data-anchor-id="why-this-matters-for-tmle">Why this matters for TMLE</h3>
<ul>
<li>TMLE is doubly robust: consistent if either the outcome or treatment model is correct</li>
<li>But TMLE is <strong>efficient</strong> when both models are consistent at reasonable rates</li>
<li>Super Learner reduces the risk of misspecifying either model</li>
<li>Cross-validation within Super Learner protects against overfitting</li>
</ul>
</section>
<section id="conceptual-demonstration" class="level3">
<h3 class="anchored" data-anchor-id="conceptual-demonstration">Conceptual demonstration</h3>
<p>The following shows how Super Learner would be integrated (this requires the SuperLearner package, which may not run in all webR environments):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define learner library</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>SL_lib <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.gam"</span>, <span class="st">"SL.mean"</span>)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model via Super Learner</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>Q_SL <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> dat<span class="sc">$</span>Y,</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> dat <span class="sc">%&gt;%</span> <span class="fu">select</span>(A, age, bmi, hba1c, cvd, egfr, statin),</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> SL_lib</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment model via Super Learner</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>g_SL <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> dat<span class="sc">$</span>A,</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> dat <span class="sc">%&gt;%</span> <span class="fu">select</span>(age, bmi, hba1c, cvd, egfr, statin),</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> SL_lib</span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a><span class="co"># View the cross-validated weights</span></span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>Q_SL<span class="sc">$</span>coef  <span class="co"># how much each learner contributes to the outcome model</span></span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>g_SL<span class="sc">$</span>coef  <span class="co"># how much each learner contributes to the treatment model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Super Learner automatically determines which learners are most useful and how to combine them — no manual model selection required.</p>
<hr>
</section>
</section>
<section id="summary-of-estimator-trade-offs" class="level1">
<h1>9. Summary of Estimator Trade-offs</h1>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 22%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Property</th>
<th>G-comp</th>
<th>IPTW</th>
<th>AIPW</th>
<th>TMLE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Uses outcome model</td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Uses treatment model</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Doubly robust</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Respects bounds</td>
<td>Depends</td>
<td>N/A</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Efficient (solves EIC)</td>
<td>No</td>
<td>No</td>
<td>Asymptotically</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Works with ML</td>
<td>Partially</td>
<td>Partially</td>
<td>Needs cross-fitting</td>
<td>Naturally</td>
</tr>
<tr class="odd">
<td>Inference method</td>
<td>Bootstrap</td>
<td>Sandwich</td>
<td>Influence curve</td>
<td>Influence curve</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="key-takeaways" class="level1">
<h1>Key Takeaways</h1>
<ol type="1">
<li><p><strong>The naive estimate is biased</strong> because treatment groups differ in baseline characteristics. Never interpret unadjusted comparisons as causal effects.</p></li>
<li><p><strong>G-computation is intuitive</strong> but depends on correctly modeling the outcome. It implements the identification formula directly.</p></li>
<li><p><strong>IPTW tackles confounding through reweighting</strong> but is sensitive to positivity violations and propensity score misspecification. Always check weight distributions.</p></li>
<li><p><strong>AIPW is doubly robust</strong> — consistent if either the outcome or treatment model is correct. But it does not target the parameter of interest and can produce out-of-bounds predictions.</p></li>
<li><p><strong>TMLE combines the strengths of all methods.</strong> It starts with an outcome model, targets it using the propensity score, respects parameter bounds, and provides efficient inference through the influence curve.</p></li>
<li><p><strong>Super Learner</strong> reduces the risk of model misspecification by ensembling multiple learners with cross-validated weights. It pairs naturally with TMLE.</p></li>
<li><p><strong>Diagnostics are non-negotiable.</strong> Always inspect propensity score overlap, weight distributions, covariate balance, and influence curve behavior before trusting any estimate.</p></li>
<li><p><strong>Every step of the causal roadmap matters.</strong> The estimate is only as valid as the assumptions that identify the causal effect from observational data.</p></li>
</ol>
<hr>
</section>
<section id="advanced-extensions" class="level1">
<h1>10. Advanced Extensions</h1>
<p>The framework in this chapter extends to several important settings:</p>
<ul>
<li><strong>Dynamic treatment regimes:</strong> Treatment rules that depend on patient characteristics (e.g., “prescribe dapagliflozin if eGFR &gt; 45, else sulfonylurea”)</li>
<li><strong>Stochastic interventions:</strong> Shift the probability of treatment rather than forcing a deterministic assignment — useful when positivity is limited</li>
<li><strong>Mediation analysis:</strong> Decompose the total effect into direct and indirect pathways (e.g., does dapagliflozin reduce MACE partly through weight loss?)</li>
<li><strong>Conditional average treatment effects (CATE):</strong> Estimate how the treatment effect varies across subgroups</li>
<li><strong>Variable importance:</strong> Identify which confounders matter most for the treatment effect</li>
<li><strong>Longitudinal TMLE (LTMLE) and LMTP:</strong> Handle time-varying treatments, confounders, and censoring — covered in subsequent chapters</li>
</ul>
<p>Each extension follows the same causal roadmap: define the question, specify the causal model, verify assumptions, identify the statistical estimand, and choose an appropriate estimator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    
 [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   
 [9] ggplot2_3.5.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 
 [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         
 [9] labeling_0.4.3    generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4
[13] munsell_0.5.1     pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6      
[17] utf8_1.2.4        stringi_1.8.7     xfun_0.49         timechange_0.3.0 
[21] cli_3.6.5         withr_3.0.2       magrittr_2.0.3    digest_0.6.37    
[25] grid_4.4.2        rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4  
[29] vctrs_0.6.5       evaluate_1.0.5    glue_1.8.0        farver_2.1.2     
[33] fansi_1.0.6       colorspace_2.1-1  rmarkdown_2.29    tools_4.4.2      
[37] pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>