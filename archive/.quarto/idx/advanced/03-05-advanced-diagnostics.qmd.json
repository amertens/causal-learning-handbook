{"title":"Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses","markdown":{"yaml":{"title":"Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses","format":"html"},"headingText":"Chapter 3.5","containsRefs":false,"markdown":"\n\n## Advanced Diagnostics and Sensitivity Analyses  \n*Ensuring credible causal conclusions in real-world longitudinal data*\n\nCausal inference is never just about estimating an effect — it is about **credibly defending** that effect.  \nDiagnostics and sensitivity analyses are essential components of the causal roadmap because:\n\n- Identifying assumptions are never fully testable  \n- Real-world data contain missingness, selection, unmeasured confounding, and misclassification  \n- Positivity and model misspecification can quietly undermine estimation  \n- Regulatory-grade RWE requires transparency and robustness checks  \n\nThis chapter walks through:\n\n1. Diagnostics for identification assumptions  \n2. Positivity and overlap assessment  \n3. Diagnostics for nuisance models (Q and g)  \n4. Weight diagnostics  \n5. Sensitivity analyses for unmeasured confounding  \n6. Negative controls  \n7. TMLE-specific diagnostics  \n8. Longitudinal diagnostics (LMTP / longitudinal TMLE)  \n\n--- \n\n## 1. Diagnostics for Identification Assumptions\n\nThe core identification assumptions are:\n\n- **Consistency**  \n- **Exchangeability (No unmeasured confounding)**  \n- **Positivity**  \n- **Correct nuisance model specification**\n\nWhile not directly testable, their **empirical implications** can be evaluated.\n\n### 1.1 Data structure and quality checks\n\nBefore causal modeling:\n\n- Verify time ordering  \n- Confirm treatment and outcome timestamps  \n- Inspect missingness patterns  \n- Look for coding shifts (ICD-9 to ICD-10)  \n- Examine distributions and implausible values  \n\n### 1.2 DAG review\n\nA DAG clarifies:\n\n- Adjustment sets  \n- Potential unmeasured confounding  \n- Variables that should **not** be adjusted for (mediators, colliders)\n\nUse DAGs as a communication tool with clinical partners.\n\n---\n\n## 2. Positivity Diagnostics\n\nPositivity requires:\n\n> Every combination of covariates has a non-zero probability of receiving each treatment.\n\nViolations cause unstable weights and unreliable estimates.\n\n### 2.1 Propensity score overlap\n\n```r\nps <- predict(glm(A ~ W1 + W2, family = binomial), type = \"response\")\n\nlibrary(ggplot2)\nggplot(tibble(ps = ps, A = A), aes(x = ps, fill = factor(A))) +\n  geom_density(alpha = 0.4)\n```\n\nIndicators of concern:\n\n- Mass near 0 or 1  \n- Disjoint distributions  \n\n### 2.2 Clever covariate range (TMLE)\n\n```r\nH <- A/ps - (1-A)/(1-ps)\nsummary(H)\n```\n\nExtreme values imply near-positivity violations.\n\n### 2.3 Remedies\n\n- Restrict to regions with support (“overlap population”)\n- Truncate weights  \n- Use **stochastic interventions** instead of static ones  \n- Simplify interventions  \n\n---\n\n## 3. Diagnostics for Nuisance Functions (Q and g)\n\nAccurate nuisance models are crucial for TMLE, AIPW, and LMTP.\n\n### 3.1 Predictive accuracy\n\n- AUC for binary outcomes  \n- MSE/R² for continuous  \n- Cross-validated risk from SuperLearner  \n\n### 3.2 Calibration plots\n\n```r\ndat %>% \n  mutate(pred = Qhat) %>% \n  ggplot(aes(x = pred, y = Y)) +\n    geom_point(alpha = 0.3) +\n    geom_smooth()\n```\n\n### 3.3 Overfitting assessment\n\nCompare:\n\n- Training loss  \n- Cross-validated loss  \n\nLarge discrepancy → overfitting.\n\n### 3.4 Variable-importance sanity check\n\nEnsure top predictors are *clinically plausible*.\n\n---\n\n## 4. Weight Diagnostics\n\nFor IPTW, MSMs, and censoring weights.\n\n### 4.1 Weight summaries\n\n```r\nsummary(weights)\nquantile(weights, probs = c(0.01, 0.99))\n```\n\nRed flags:\n\n- Mean far from 1  \n- Very heavy tail  \n- Huge max weights  \n\n### 4.2 Visual check\n\n```r\nggplot(tibble(w = weights), aes(x = w)) +\n  geom_histogram()\n```\n\n### 4.3 Truncation\n\n```r\nlower <- quantile(weights, 0.01)\nupper <- quantile(weights, 0.99)\nw_trunc <- pmin(pmax(weights, lower), upper)\n```\n\n---\n\n## 5. Sensitivity Analyses for Unmeasured Confounding\n\n### 5.1 E-values\n\nMeasures minimum strength of confounding needed to explain away an effect.\n\n### 5.2 Quantitative Bias Analysis (QBA)\n\nSimulates impact of:\n\n- Unmeasured confounder prevalence  \n- Unmeasured confounder associations  \n\nR packages: **episensr**, **causalsens**\n\n### 5.3 Rosenbaum sensitivity\n\nFor matched studies.\n\n### 5.4 Sensitivity using stochastic interventions\n\nLMTP can quantify robustness of static intervention effects.\n\n---\n\n## 6. Negative Controls\n\nNegative control outcomes (NCOs):\n\n- Causally unrelated to treatment  \n- Share confounding structures  \n\nIf TMLE of treatment → NCO ≠ 0 → likely confounding remains.\n\nExample:\n\n```r\ntmle_nco <- tmle(\n  Y = dat$negative_event,\n  A = dat$treatment,\n  W = dat[, confounders]\n)\n```\n\nNegative control exposures are also useful.\n\n---\n\n## 7. TMLE-Specific Diagnostics\n\n### 7.1 Clever covariate behavior\n\nExtreme clever covariate values lead to unstable targeting.\n\n### 7.2 Targeting step convergence\n\nCheck for warnings in logistic fluctuation:\n\n```\nglm.fit: algorithm did not converge\n```\n\n### 7.3 Influence-curve distribution\n\n```r\nIC <- tmle_fit$ic\nmean(IC); var(IC)\n```\n\nHeavy tails → avoid Wald intervals, use bootstrap.\n\n---\n\n## 8. Longitudinal Diagnostics (LMTP & Longitudinal TMLE)\n\n### 8.1 Sequential positivity\n\nCheck treatment probabilities at each timepoint.\n\n### 8.2 Cumulative weights\n\n```r\ncumw <- apply(weight_matrix, 1, prod)\nhist(cumw)\n```\n\nExtreme cumulative weights → instability.\n\n### 8.3 Truncation across time\n\nTruncate weights at each time step or truncate cumulative weights.\n\n### 8.4 Time-varying confounding sanity checks\n\nEnsure intermediate variables are not inappropriate colliders.\n\n---\n\n## 9. Recommended Diagnostics Workflow\n\n### Before estimation\n\n- Confirm time-ordering  \n- Draw a DAG  \n- Check missingness  \n- Summarize covariate distributions by treatment  \n\n### During estimation\n\n- Check PS overlap  \n- Evaluate weight distributions  \n- Inspect Q and g predictions  \n- Check TMLE targeting step  \n\n### After estimation\n\n- Sensitivity analyses  \n- Negative controls  \n- Compare across estimators (IPTW, TMLE, AIPW)  \n- Robustness checks (population restriction, alternative confounder sets)\n\n---\n\n## 10. Summary\n\nTo produce defensible causal evidence, diagnostics must be:\n\n- Systematic  \n- Transparent  \n- Documented in the analysis plan  \n- Interpreted with domain expertise  \n\nWith these tools, analysts can judge the **credibility**, **robustness**, and **transportability** of causal findings — essential for regulatory, clinical, and scientific decision‑making.\n\n```{r}\nsessionInfo()\n```\n","srcMarkdownNoYaml":"\n\n# Chapter 3.5  \n## Advanced Diagnostics and Sensitivity Analyses  \n*Ensuring credible causal conclusions in real-world longitudinal data*\n\nCausal inference is never just about estimating an effect — it is about **credibly defending** that effect.  \nDiagnostics and sensitivity analyses are essential components of the causal roadmap because:\n\n- Identifying assumptions are never fully testable  \n- Real-world data contain missingness, selection, unmeasured confounding, and misclassification  \n- Positivity and model misspecification can quietly undermine estimation  \n- Regulatory-grade RWE requires transparency and robustness checks  \n\nThis chapter walks through:\n\n1. Diagnostics for identification assumptions  \n2. Positivity and overlap assessment  \n3. Diagnostics for nuisance models (Q and g)  \n4. Weight diagnostics  \n5. Sensitivity analyses for unmeasured confounding  \n6. Negative controls  \n7. TMLE-specific diagnostics  \n8. Longitudinal diagnostics (LMTP / longitudinal TMLE)  \n\n--- \n\n## 1. Diagnostics for Identification Assumptions\n\nThe core identification assumptions are:\n\n- **Consistency**  \n- **Exchangeability (No unmeasured confounding)**  \n- **Positivity**  \n- **Correct nuisance model specification**\n\nWhile not directly testable, their **empirical implications** can be evaluated.\n\n### 1.1 Data structure and quality checks\n\nBefore causal modeling:\n\n- Verify time ordering  \n- Confirm treatment and outcome timestamps  \n- Inspect missingness patterns  \n- Look for coding shifts (ICD-9 to ICD-10)  \n- Examine distributions and implausible values  \n\n### 1.2 DAG review\n\nA DAG clarifies:\n\n- Adjustment sets  \n- Potential unmeasured confounding  \n- Variables that should **not** be adjusted for (mediators, colliders)\n\nUse DAGs as a communication tool with clinical partners.\n\n---\n\n## 2. Positivity Diagnostics\n\nPositivity requires:\n\n> Every combination of covariates has a non-zero probability of receiving each treatment.\n\nViolations cause unstable weights and unreliable estimates.\n\n### 2.1 Propensity score overlap\n\n```r\nps <- predict(glm(A ~ W1 + W2, family = binomial), type = \"response\")\n\nlibrary(ggplot2)\nggplot(tibble(ps = ps, A = A), aes(x = ps, fill = factor(A))) +\n  geom_density(alpha = 0.4)\n```\n\nIndicators of concern:\n\n- Mass near 0 or 1  \n- Disjoint distributions  \n\n### 2.2 Clever covariate range (TMLE)\n\n```r\nH <- A/ps - (1-A)/(1-ps)\nsummary(H)\n```\n\nExtreme values imply near-positivity violations.\n\n### 2.3 Remedies\n\n- Restrict to regions with support (“overlap population”)\n- Truncate weights  \n- Use **stochastic interventions** instead of static ones  \n- Simplify interventions  \n\n---\n\n## 3. Diagnostics for Nuisance Functions (Q and g)\n\nAccurate nuisance models are crucial for TMLE, AIPW, and LMTP.\n\n### 3.1 Predictive accuracy\n\n- AUC for binary outcomes  \n- MSE/R² for continuous  \n- Cross-validated risk from SuperLearner  \n\n### 3.2 Calibration plots\n\n```r\ndat %>% \n  mutate(pred = Qhat) %>% \n  ggplot(aes(x = pred, y = Y)) +\n    geom_point(alpha = 0.3) +\n    geom_smooth()\n```\n\n### 3.3 Overfitting assessment\n\nCompare:\n\n- Training loss  \n- Cross-validated loss  \n\nLarge discrepancy → overfitting.\n\n### 3.4 Variable-importance sanity check\n\nEnsure top predictors are *clinically plausible*.\n\n---\n\n## 4. Weight Diagnostics\n\nFor IPTW, MSMs, and censoring weights.\n\n### 4.1 Weight summaries\n\n```r\nsummary(weights)\nquantile(weights, probs = c(0.01, 0.99))\n```\n\nRed flags:\n\n- Mean far from 1  \n- Very heavy tail  \n- Huge max weights  \n\n### 4.2 Visual check\n\n```r\nggplot(tibble(w = weights), aes(x = w)) +\n  geom_histogram()\n```\n\n### 4.3 Truncation\n\n```r\nlower <- quantile(weights, 0.01)\nupper <- quantile(weights, 0.99)\nw_trunc <- pmin(pmax(weights, lower), upper)\n```\n\n---\n\n## 5. Sensitivity Analyses for Unmeasured Confounding\n\n### 5.1 E-values\n\nMeasures minimum strength of confounding needed to explain away an effect.\n\n### 5.2 Quantitative Bias Analysis (QBA)\n\nSimulates impact of:\n\n- Unmeasured confounder prevalence  \n- Unmeasured confounder associations  \n\nR packages: **episensr**, **causalsens**\n\n### 5.3 Rosenbaum sensitivity\n\nFor matched studies.\n\n### 5.4 Sensitivity using stochastic interventions\n\nLMTP can quantify robustness of static intervention effects.\n\n---\n\n## 6. Negative Controls\n\nNegative control outcomes (NCOs):\n\n- Causally unrelated to treatment  \n- Share confounding structures  \n\nIf TMLE of treatment → NCO ≠ 0 → likely confounding remains.\n\nExample:\n\n```r\ntmle_nco <- tmle(\n  Y = dat$negative_event,\n  A = dat$treatment,\n  W = dat[, confounders]\n)\n```\n\nNegative control exposures are also useful.\n\n---\n\n## 7. TMLE-Specific Diagnostics\n\n### 7.1 Clever covariate behavior\n\nExtreme clever covariate values lead to unstable targeting.\n\n### 7.2 Targeting step convergence\n\nCheck for warnings in logistic fluctuation:\n\n```\nglm.fit: algorithm did not converge\n```\n\n### 7.3 Influence-curve distribution\n\n```r\nIC <- tmle_fit$ic\nmean(IC); var(IC)\n```\n\nHeavy tails → avoid Wald intervals, use bootstrap.\n\n---\n\n## 8. Longitudinal Diagnostics (LMTP & Longitudinal TMLE)\n\n### 8.1 Sequential positivity\n\nCheck treatment probabilities at each timepoint.\n\n### 8.2 Cumulative weights\n\n```r\ncumw <- apply(weight_matrix, 1, prod)\nhist(cumw)\n```\n\nExtreme cumulative weights → instability.\n\n### 8.3 Truncation across time\n\nTruncate weights at each time step or truncate cumulative weights.\n\n### 8.4 Time-varying confounding sanity checks\n\nEnsure intermediate variables are not inappropriate colliders.\n\n---\n\n## 9. Recommended Diagnostics Workflow\n\n### Before estimation\n\n- Confirm time-ordering  \n- Draw a DAG  \n- Check missingness  \n- Summarize covariate distributions by treatment  \n\n### During estimation\n\n- Check PS overlap  \n- Evaluate weight distributions  \n- Inspect Q and g predictions  \n- Check TMLE targeting step  \n\n### After estimation\n\n- Sensitivity analyses  \n- Negative controls  \n- Compare across estimators (IPTW, TMLE, AIPW)  \n- Robustness checks (population restriction, alternative confounder sets)\n\n---\n\n## 10. Summary\n\nTo produce defensible causal evidence, diagnostics must be:\n\n- Systematic  \n- Transparent  \n- Documented in the analysis plan  \n- Interpreted with domain expertise  \n\nWith these tools, analysts can judge the **credibility**, **robustness**, and **transportability** of causal findings — essential for regulatory, clinical, and scientific decision‑making.\n\n```{r}\nsessionInfo()\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"03-05-advanced-diagnostics.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","theme":"cosmo","smooth-scroll":true,"title":"Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses","sidebar":{"style":"docked","search":true,"contents":[{"text":"Overview","href":"index.qmd"},{"section":"Advanced topics","contents":[{"text":"1.1 Regression vs Causal Inference","href":"01-01-regression-vs-causal.qmd"},{"text":"1.2 The Causal Roadmap in detail","href":"01-02-causal-roadmap.qmd"},{"text":"1.3 Identification and Estimands","href":"01-03-identification-estimands.qmd"},{"text":"2.1 G-computation","href":"02-01-gcomputation.qmd"},{"text":"2.2 Inverse Probability of Treatment Weighting (IPTW)","href":"02-02-iptw.qmd"},{"text":"2.3 Doubly Robust Estimation and Targeted Maximum Likelihood Estimation (TMLE)","href":"02-03-doubly-robust-tmle.qmd"},{"text":"2.4 Super Learner","href":"02-04-superlearner.qmd"},{"text":"3.3 Longitudinal Case Study","href":"03-03-longitudinal-case-study.qmd"},{"text":"3.4 Effect Modification","href":"03-04-effect-modification.qmd"},{"text":"3.5 Advanced Diagnostics","href":"03-05-advanced-diagnostics.qmd"},{"text":"3.6 RWD meets RCT: Hybrid Designs","href":"03-06-rwd-meets-rct-hybrid-designs.qmd"},{"text":"3.7 Longitudinal Time-Dependent Confounding","href":"03-07-longitudinal-td-confounding.qmd"},{"text":"3.8 TMLE in the Clean Room Design","href":"03-08-tmle-clean-room.qmd"},{"text":"Covariate Adjustment IN RCTs using TMLE","href":"chapter_covariate_adjustment_tmle.qmd"},{"text":"Common Pitfalls in Causal Inference","href":"common-pitfalls.qmd"}]}]}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}