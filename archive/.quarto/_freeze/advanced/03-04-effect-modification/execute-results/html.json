{
  "hash": "9fecb520b1d49acc55ddea73a53e815d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects\"\nformat: html\n---\n\n\n\n\n\n# Chapter 3.4  \n\n## TO DO:\n\n- incorporate Haodongs methods and causal forest\n\n## Effect Modification and Heterogeneous Treatment Effects  \n*Identifying who benefits most (or least) from treatment*\n\nCausal inference is not only about estimating *average* treatment effects.  \nIn many scientific and regulatory settings, we want to know:\n\n> **Does the treatment work differently for different types of patients?**\n\nThis phenomenon is known as **effect modification** or **treatment-effect heterogeneity (HTE)**.\n\nIn this chapter, you’ll learn:\n\n1. Conceptual foundations of effect modification  \n2. How to define subgroup-specific causal estimands  \n3. TMLE-based approaches to effect heterogeneity  \n4. Machine-learning approaches, focusing on the **causal forest**  \n5. How to interpret heterogeneous effects responsibly  \n6. Diagnostics, uncertainty, and false discovery concerns  \n\nThis chapter builds on the causal roadmap and estimation methods from earlier modules.\n\n---\n\n## 1. Why Study Effect Modification?\n\nThe **average treatment effect (ATE)** answers:  \n> “What is the mean effect of treatment in the population?”\n\nBut patients differ:\n\n- age, sex  \n- comorbidities  \n- biomarkers  \n- baseline risk  \n- genetic variation  \n\nClinically and scientifically relevant questions include:\n\n- *Does our osteoporosis drug reduce fracture risk more in high-risk patients?*  \n- *Are cardiovascular risks higher in patients with chronic kidney disease?*  \n- *Does benefit differ by baseline frailty or prior CVD?*\n\nEffect modification helps answer these individualized or stratified questions.\n\n---\n\n## 2. Causal Estimands for Effect Modification\n\nTo study heterogeneity, we define **conditional average treatment effects (CATE)**.\n\nLet \\(X\\) be a baseline covariate or set of covariates.\n\nThe **CATE** is:\n\n\\[\nCATE(x) = E[Y(1) - Y(0) \\mid X = x].\n\\]\n\nFor categorical variables (e.g., age group):\n\n\\[\nATE_{\text{age<75}} = E[Y(1) - Y(0) \\mid \text{age} < 75],\n\\]\n\nand similarly for other strata.\n\nYour choice of estimand must match the scientific question:\n\n- **Prespecified subgroups** (sex, race, CKD stage)  \n- **Post hoc continuous moderators** (eGFR, age)  \n- **Machine-learned subgroups** (via trees / forests)\n\n---\n\n## 3. Identification Assumptions\n\nEffect modification estimands inherit the same assumptions as the main causal effect:\n\n- **Exchangeability:**  \n  \\(\n  Y(a) \\perp A \\mid W\n  \\)\n- **Positivity:**  \n  Each subgroup must contain both treated and untreated  \n- **Consistency**\n\nAdditionally:\n\n- Moderator variables must be **measured before treatment**  \n- You should avoid conditioning on **post-treatment variables** when defining subgroups\n\n---\n\n## 4. A Workflow for Effect Modification\n\n1. **Define causal estimands** (subgroup-specific ATE, CATE(x))  \n2. **Choose moderators**  \n   - Prespecified vs exploratory  \n3. **Estimate nuisance functions** with SuperLearner  \n4. **Estimate heterogeneous effects** using:\n   - TMLE (subgroup-specific or CATE-targeted)  \n   - Causal forests  \n5. **Quantify uncertainty**  \n6. **Document all steps and prespecifications**\n\nWe now walk through TMLE and causal forest approaches.\n\n---\n\n## 5. TMLE for Subgroup-Specific Effects\n\nFor **prespecified subgroups**, TMLE can estimate:\n\n\\[\nATE_g = E[Y(1) - Y(0) \\mid X_g = 1],\n\\]\n\nwhere \\(X_g\\) indicates membership in subgroup \\(g\\).\n\nExample: ATE among patients younger than 75.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tmle)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: glmnet\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: Matrix\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoaded glmnet 4.1-8\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: SuperLearner\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: nnls\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: gam\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: splines\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: foreach\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoaded gam 1.22-5\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSuper Learner\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nVersion: 2.0-29\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPackage created on 2024-02-06\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWelcome to the tmle package, version 2.0.1.1\n\nUse tmleNews() to see details on changes and bug fixes\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(SuperLearner)\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'ggplot2' was built under R version 4.4.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'stringr' was built under R version 4.4.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.6.0\n✔ ggplot2   3.5.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ purrr::accumulate() masks foreach::accumulate()\n✖ tidyr::expand()     masks Matrix::expand()\n✖ dplyr::filter()     masks stats::filter()\n✖ dplyr::lag()        masks stats::lag()\n✖ tidyr::pack()       masks Matrix::pack()\n✖ tidyr::unpack()     masks Matrix::unpack()\n✖ purrr::when()       masks foreach::when()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\n# Assume dat has columns: Y (outcome), A (treatment), age, cvd, eGFR, etc.\nset.seed(123)\n\ndat <- tibble(\n  Y = rbinom(2000, 1, 0.2),\n  A = rbinom(2000, 1, 0.5),\n  age = rnorm(2000, 75, 6),\n  cvd = rbinom(2000, 1, 0.4),\n  eGFR = rnorm(2000, 60, 15)\n)\n\ndat <- dat %>%\n  mutate(age_under75 = if_else(age < 75, 1, 0))\n\nsl_lib <- c(\"SL.glm\", \"SL.ranger\", \"SL.mean\")\n\ntmle_sub <- tmle(\n  Y = dat$Y[dat$age_under75 == 1],\n  A = dat$A[dat$age_under75 == 1],\n  W = dat %>%\n    filter(age_under75 == 1) %>%\n    select(cvd, eGFR),\n  family = \"binomial\",\n  Q.SL.library = sl_lib,\n  g.SL.library = sl_lib\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required namespace: ranger\n```\n\n\n:::\n\n```{.r .cell-code}\ntmle_sub$estimates$ATE\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$psi\n[1] 0.01827827\n\n$var.psi\n[1] 0.0006070161\n\n$CI\n[1] -0.03001073  0.06656727\n\n$pvalue\n[1] 0.4581586\n\n$bs.var\n[1] NA\n\n$bs.CI.twosided\n[1] NA NA\n\n$bs.CI.onesided.lower\n[1] -Inf   NA\n\n$bs.CI.onesided.upper\n[1]  NA Inf\n```\n\n\n:::\n:::\n\n\n\n\nInterpretation:\n\n> Among patients younger than 75, the TMLE-estimated risk difference is …\n\nThis approach:\n\n- Gives valid subgroup-specific estimates  \n- Leverages SuperLearner for nuisance models  \n\nLimitations:\n\n- Does not provide a *continuous* CATE curve  \n- Requires prespecified groups and adequate sample size in each  \n\n---\n\n## 6. TMLE Extensions for Continuous Effect Modification\n\nFor continuous effect modifiers, you may want:\n\n\\[\nCATE(x) = E[Y(1) - Y(0) \\mid X = x]\n\\]\n\nfor all x (e.g., all ages). TMLE-based approaches often use:\n\n- Projection of the CATE onto basis functions of X (splines, polynomials)\n- Estimation of projection coefficients via TMLE\n- Reconstruction of \\( CATE(x) \\) from the projected function\n\nA typical CATE-TMLE algorithm:\n\n1. Expand \\(X\\) into basis functions \\(h_1(X),\\dots,h_K(X)\\)  \n2. Define target parameters of the form  \n   \\(\\Psi_k = E[(Y(1) - Y(0)) h_k(X)]\\)  \n3. Use TMLE to estimate each \\(\\Psi_k\\)  \n4. Construct \\( \\hat{CATE}(x) = \\sum_k \\hat\\Psi_k h_k(x)\\)\n\nWe won’t fully implement this here (it is mathematically intensive), but you should be aware that:\n\n- TMLE can provide **smooth, doubly robust CATE estimators**  \n- TMLE-based variable importance methods can also quantify **how much** a covariate modifies the treatment effect  \n\n---\n\n## 7. Modern ML Approach: Causal Forests\n\n**Causal forests** are tree-based methods specifically designed to estimate CATEs.\n\nThey extend random forests by:\n\n- Splitting trees to maximize *treatment-effect heterogeneity*  \n- Using “honest” sample splitting (training vs estimation sets)  \n- Averaging across many trees to obtain smooth CATE estimates\n\n### 7.1 Why Causal Forests?\n\n- Automatically detect complex, nonlinear interactions  \n- Provide **individual-level CATE estimates** \\( \\hat\tau(x) \\)  \n- Offer approximate pointwise confidence intervals  \n- Useful for exploratory HTE analysis\n\nCaveats:\n\n- Not doubly robust  \n- Interpretation is essentially **associational**, unless we embed it in a rigorous causal framework  \n- Needs the same identification assumptions as other causal estimators\n\n---\n\n## 8. Implementing Causal Forests in R\n\nWe use the `grf` package.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages(\"grf\")\nlibrary(grf)\n\nset.seed(2028)\n\n# Simulate data with treatment effect heterogeneity\nn <- 3000\nX <- tibble(\n  age = rnorm(n, 75, 6),\n  cvd = rbinom(n, 1, 0.4),\n  risk_score = rnorm(n, 0, 1)\n)\n\nA <- rbinom(n, 1, plogis(-0.5 + 0.2 * X$age - 0.8 * X$risk_score))\n# Treatment effect depends on risk_score\ntau_true <- -0.05 + 0.1 * (X$risk_score > 0)\nY <- rbinom(n, 1, plogis(-2 + tau_true * A + 0.05 * (X$age - 75) + 0.5 * X$cvd))\n\nX_mat <- as.matrix(X)\n\ncf <- causal_forest(\n  X = X_mat,\n  Y = Y,\n  W = A\n)\n\n# Individualized CATE estimates\ntau_hat <- predict(cf)$predictions\n\nsummary(tau_hat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's \n     NA      NA      NA     NaN      NA      NA    3000 \n```\n\n\n:::\n:::\n\n\n\n\n### Visualizing CATE vs. risk score\n\n**To do** debug\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(X$risk_score, tau_hat,\n     xlab = \"Baseline risk score\",\n     ylab = \"Estimated CATE\",\n     pch = 16, cex = 0.3)\nabline(h = 0, col = \"red\")\n```\n:::\n\n\n\n\nYou should see different CATE patterns for low vs high risk scores.\n\n---\n\n## 9. Subgrouping Using CATE Estimates\n\nWe can create subgroups such as:\n\n- “High predicted benefit” vs “low predicted benefit”\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nthreshold <- median(tau_hat)\n\nres <- X %>%\n  mutate(\n    CATE_hat = tau_hat,\n    group = if_else(CATE_hat > threshold, \"high benefit\", \"low benefit\")\n  )\n\ntable(res$group)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n< table of extent 0 >\n```\n\n\n:::\n\n```{.r .cell-code}\nres %>%\n  group_by(group) %>%\n  summarize(\n    mean_CATE = mean(CATE_hat),\n    .groups = \"drop\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 2\n  group mean_CATE\n  <chr>     <dbl>\n1 <NA>        NaN\n```\n\n\n:::\n:::\n\n\n\n\nThis is **exploratory**, not confirmatory.  \nIt can inform:\n\n- Hypothesis generation  \n- Prespecified subgroup definitions in future trials  \n\n---\n\n## 10. Causal Forest vs. TMLE: Which Should You Use?\n\n**TMLE (with SuperLearner):**\n\n- Best for **prespecified** subgroups  \n- CATE-TMLE gives **doubly robust**, efficient CATE estimates  \n- Integrates neatly into a causal estimand framework  \n- More transparent and parameter-focused  \n\n**Causal Forest:**\n\n- Best for **exploratory** heterogeneity  \n- Automatically discovers complex interactions  \n- Provides smooth CATE functions without specifying bases  \n- Good for risk-stratified or personalized-medicine questions  \n\n### Practical pattern:\n\n1. Use **TMLE** to estimate ATE and pre-planned subgroup effects  \n2. Use **causal forests** to explore residual heterogeneity and generate new hypotheses  \n3. Where consistent patterns are observed, design new confirmatory analyses or studies\n\n---\n\n## 11. Interpretation and Reporting: Avoiding Pitfalls\n\nEffect modification is tempting but dangerous:\n\n- Multiple subgroup comparisons inflate type I error  \n- “Fishing expeditions” can produce spurious heterogeneity  \n- Small subgroup sizes → unstable estimates  \n\nBest practices:\n\n1. **Prespecify main effect modifiers** when possible  \n2. **Correct for multiplicity** (e.g., family-wise error or FDR) if reporting many subgroups  \n3. Emphasize **uncertainty** (wide CIs are expected)  \n4. Treat causal forest findings as **exploratory** unless prespecified or replicated  \n5. Always present the **overall ATE** alongside any heterogeneity results  \n\n---\n\n## 12. Example: Combining TMLE and Causal Forests\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 1: ATE with TMLE\nsl_lib <- c(\"SL.glm\", \"SL.ranger\", \"SL.mean\")\n\ntmle_ate <- tmle(\n  Y = Y,\n  A = A,\n  W = X,\n  family = \"binomial\",\n  Q.SL.library = sl_lib,\n  g.SL.library = sl_lib\n)\n\ntmle_ate$estimates$ATE\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNULL\n```\n\n\n:::\n\n```{.r .cell-code}\n# Step 2: CATEs with causal forest (already computed as tau_hat)\nsummary(tau_hat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's \n     NA      NA      NA     NaN      NA      NA    3000 \n```\n\n\n:::\n:::\n\n\n\n\n- TMLE gives a **population-level effect** (with solid identifiability and efficiency).\n- Causal forest gives **individual-level estimated CATEs** to explore how effects vary.\n\n---\n\n## 13. Summary\n\nIn this chapter, you learned:\n\n- How to define causal estimands for effect modification and CATEs  \n- How to estimate subgroup-specific effects via TMLE  \n- How TMLE can be extended to continuous moderators using projection / variable importance frameworks  \n- How causal forests provide flexible, ML-driven CATE estimates  \n- How to interpret heterogeneous effects carefully in real-world and regulatory contexts  \n\nEffect modification analysis is powerful but fragile. Combining **TMLE** for confirmatory, parameter-focused inference and **causal forests** for exploratory, data-adaptive heterogeneity learning often yields the most insightful and responsible use of HTE methods.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.4.2 (2024-10-31 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 26200)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: America/Los_Angeles\ntzcode source: internal\n\nattached base packages:\n[1] splines   stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] grf_2.4.0           lubridate_1.9.3     forcats_1.0.0      \n [4] stringr_1.6.0       dplyr_1.1.4         purrr_1.0.2        \n [7] readr_2.1.5         tidyr_1.3.1         tibble_3.2.1       \n[10] ggplot2_3.5.2       tidyverse_2.0.0     tmle_2.0.1.1       \n[13] SuperLearner_2.0-29 gam_1.22-5          foreach_1.5.2      \n[16] nnls_1.6            glmnet_4.1-8        Matrix_1.7-1       \n\nloaded via a namespace (and not attached):\n [1] utf8_1.2.4            generics_0.1.3        shape_1.4.6.1        \n [4] stringi_1.8.7         lattice_0.22-6        hms_1.1.3            \n [7] digest_0.6.37         magrittr_2.0.3        timechange_0.3.0     \n[10] evaluate_1.0.5        grid_4.4.2            iterators_1.0.14     \n[13] fastmap_1.2.0         jsonlite_2.0.0        survival_3.7-0       \n[16] fansi_1.0.6           scales_1.3.0          codetools_0.2-20     \n[19] cli_3.6.5             rlang_1.1.6           munsell_0.5.1        \n[22] withr_3.0.2           yaml_2.3.10           tools_4.4.2          \n[25] tzdb_0.4.0            colorspace_2.1-1      ranger_0.17.0        \n[28] vctrs_0.6.5           R6_2.6.1              lifecycle_1.0.4      \n[31] htmlwidgets_1.6.4     pkgconfig_2.0.3       pillar_1.9.0         \n[34] gtable_0.3.6          glue_1.8.0            Rcpp_1.0.13-1        \n[37] xfun_0.49             tidyselect_1.2.1      rstudioapi_0.17.1    \n[40] knitr_1.49            htmltools_0.5.8.1     rmarkdown_2.29       \n[43] compiler_4.4.2        WeightedROC_2020.1.31\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}