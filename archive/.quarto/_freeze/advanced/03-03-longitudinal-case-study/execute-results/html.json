{
  "hash": "6cdede3864fa8e90caa72c301dfffba8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis\"\nformat: html\n---\n\n\n\n\n# Chapter 3.3  \n## Case Study: Real-World Longitudinal Causal Inference Using Targeted Learning\n\nThis chapter walks through a **complete applied example** of longitudinal causal inference using real-world data concepts.  \nThe goal is to help you translate the earlier theoretical chapters into a practical analysis workflow.\n\nWe use the motivating real-world question:\n\n> **What is the 3-year cardiovascular risk difference if all eligible patients initiating osteoporosis therapy remained on denosumab vs. zoledronic acid under full adherence?**\n\nAlthough we cannot use the proprietary data from the actual studies, this chapter recreates a *plausible longitudinal structure* and walks you through the entire pipeline:\n\n- Constructing the longitudinal dataset  \n- Defining the causal question, intervention, and estimand  \n- Identifying longitudinal confounders and censoring  \n- Using SuperLearner for nuisance function estimation  \n- Applying TMLE or LMTP for longitudinal causal effects  \n- Interpreting the results in a regulatory and clinical context  \n\nThis chapter integrates lessons from Chapter 1 (causal roadmap) and Chapter 2 (estimation).\n\n---\n\n# 1. The Clinical and Real-World Context\n\nOsteoporosis treatments such as **denosumab** and **zoledronic acid** are widely used in postmenopausal women.  \nObservational data registries show:\n\n- Frequent **treatment interruptions**  \n- **Switching** between agents  \n- **Loss to follow-up**  \n- Time-varying covariates (e.g., frailty, kidney function, fall risk)\n\nThese complexities make longitudinal causal inference necessary.\n\nA naive Cox model adjusting for baseline covariates would **fail** to address:\n\n- Time-varying confounding affected by prior treatment  \n- Informative censoring (patients at higher risk may discontinue)  \n- Treatment switching  \n- Differing follow-up time  \n- Positivity issues  \n\nWe instead use **Longitudinal TMLE** or **LMTP** to estimate causal effects under hypothetical longitudinal interventions.\n\n---\n\n# 2. The Longitudinal Data Structure\n\nAssume patient \\(i\\) is followed monthly for 36 months.\n\nThe canonical structure:\n\n\\[\nO_i = (W_i, A_{i0}, L_{i1}, A_{i1}, C_{i1}, L_{i2}, A_{i2}, C_{i2}, \\dots, Y_i)\n\\]\n\nWhere:\n\n- **W**: baseline covariates (age, CVD history, frailty)\n- **A_t**: treatment status at time \\(t\\) (1 = denosumab, 0 = zoledronic acid)\n- **L_t**: time-varying covariates (kidney function, fracture risk, comorbidities)\n- **C_t**: censoring/loss to follow-up (1 = censored)\n- **Y**: cardiovascular event by 36 months\n\nWe simulate a small example below.\n\n---\n\n# 3. Simulation of a Plausible Longitudinal Dataset\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'ggplot2' was built under R version 4.4.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'stringr' was built under R version 4.4.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.6.0\n✔ ggplot2   3.5.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nset.seed(2027)\nn <- 2000\nTmax <- 6   # six timepoints for illustration\n\n# Baseline\nW_age  <- rnorm(n, 75, 6)\nW_cvd  <- rbinom(n, 1, plogis(0.12 * (W_age - 70)))\n\n# Initial treatment\nA0 <- rbinom(n, 1, plogis(-1 + 0.1*(W_age - 70) + 1.4*W_cvd))\n\n# Containers\nL <- matrix(NA, n, Tmax)\nA <- matrix(NA, n, Tmax)\nC <- matrix(0, n, Tmax)\n\nA[,1] <- A0\n\n# Generate longitudinal covariates & treatment\nfor (t in 1:Tmax) {\n  # time-varying comorbidity\n  L[,t] <- rnorm(n, mean = 0.3*W_age + 1.2*W_cvd + 0.5*A[,max(1,t-1)], sd = 1)\n\n  # treatment switching\n  A[,t] <- rbinom(n, 1, plogis(-2 + 0.3*L[,t] + 0.8*A[,max(1,t-1)]))\n\n  # censoring\n  C[,t] <- rbinom(n, 1, plogis(-4 + 0.2*L[,t] + 0.4*A[,t]))\n}\n\n# Outcome depends on full history\nY <- rbinom(n, 1, plogis(-3 + 0.5*rowMeans(A) + 0.1*rowMeans(L)))\n\ndat_long <- tibble(\n  id = 1:n,\n  age = W_age,\n  cvd = W_cvd,\n  Y = Y\n)\n\n# Expand wide data into long format (illustrative)\nfor (t in 1:Tmax) {\n  dat_long[[paste0(\"L\",t)]] <- L[,t]\n  dat_long[[paste0(\"A\",t)]] <- A[,t]\n  dat_long[[paste0(\"C\",t)]] <- C[,t]\n}\n\nglimpse(dat_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 2,000\nColumns: 22\n$ id  <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19,…\n$ age <dbl> 69.39073, 70.83682, 71.71233, 79.59763, 86.11260, 79.52474, 68.490…\n$ cvd <int> 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, …\n$ Y   <int> 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, …\n$ L1  <dbl> 20.34615, 22.75564, 23.10096, 26.65886, 27.36779, 26.43067, 22.025…\n$ A1  <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ C1  <dbl> 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, …\n$ L2  <dbl> 22.59807, 24.27239, 21.82958, 27.86522, 26.43808, 25.98865, 22.263…\n$ A2  <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ C2  <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, …\n$ L3  <dbl> 20.83098, 21.74027, 22.62104, 24.16512, 26.39433, 25.80440, 20.817…\n$ A3  <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ C3  <dbl> 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, …\n$ L4  <dbl> 20.78728, 24.72590, 22.69284, 26.37661, 28.55076, 23.07908, 23.526…\n$ A4  <int> 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ C4  <dbl> 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ L5  <dbl> 20.82393, 20.23492, 21.55791, 26.03560, 29.75833, 24.53722, 23.048…\n$ A5  <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ C5  <dbl> 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, …\n$ L6  <dbl> 21.01436, 23.69870, 21.78397, 25.38586, 26.92236, 25.95101, 22.523…\n$ A6  <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ C6  <dbl> 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, …\n```\n\n\n:::\n:::\n\n\n\n\n---\n\n# 4. Defining the Longitudinal Causal Question\n\nOur target estimand:\n\n> **What is the 36-month cardiovascular event risk if everyone remained continuously on denosumab vs continuously on zoledronic acid?**\n\nThis is a **static treatment regime**:\n\n\\[\nd_1: A_t = 1 \\ \forall t  \n\\]\n\\[\nd_0: A_t = 0 \\ \forall t\n\\]\n\nEquivalent to a “perfect adherence” scenario.\n\nWe can also define:\n\n- **Dynamic regimes** (treatment depends on predicted fracture risk)\n- **Stochastic regimes** (shift interventions on treatment probabilities)\n\nBut for now we use static interventions.\n\n---\n\n# 5. Identification: Assumptions for Longitudinal Effects\n\nTo identify the causal effect using observed data, we require:\n\n- **Sequential exchangeability:**  \n  \\( Y^{\\bar a} \\perp A_t \\mid \\bar L_t, \\bar A_{t-1}, W \\)\n- **Sequential positivity:**  \n  Each treatment is possible at each time for every covariate history\n- **Consistency:**  \n  Observed outcomes correspond to the regime actually followed\n\nThese are the longitudinal analogues of the point-treatment assumptions.\n\n---\n\n# 6. Using LMTP for Longitudinal Interventions\n\nThe **lmtp** package is a modern tool for estimating longitudinal modified treatment policies (MTPs).  \nIt supports:\n\n- Static interventions  \n- Dynamic rules  \n- Stochastic shifts  \n- Censoring adjustments  \n\nHere we implement:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Example skeleton \n library(lmtp)\n\nresult <- lmtp_tmle(\n  data = dat_long,\n  trt = paste0(\"A\", 1:Tmax),\n  outcome = \"Y\",\n  time = 1:Tmax,\n  shift = function(data, trt) { rep(1, length(trt)) },  # always-denosumab\n  learners_outcome = list(SL.glm, SL.ranger),\n  learners_trt = list(SL.glm, SL.ranger),\n  folds = 5\n)\n\nresult\n```\n:::\n\n\n\n\nThis gives a TMLE estimate of:\n\n- Risk under always-denosumab  \n- Risk under always-ZA  \n- Risk difference  \n- Confidence intervals  \n\n---\n\n# 7. Using Longitudinal TMLE (Manual Concept)\n\nLongitudinal TMLE proceeds:\n\n1. Start at final timepoint  \n2. Estimate Q-models backward in time  \n3. Estimate g-models for each treatment and censoring event  \n4. Apply sequential targeting  \n5. Compute counterfactual outcomes  \n\nThis is mathematically complex but **automated by LMTP** in most real applications.\n\n---\n\n# 8. Interpretation of Results\n\nAssume hypothetical results:\n\n| Regime | Estimated 36-mo risk |\n|--------|----------------------|\n| Always denosumab | 0.051 |\n| Always ZA        | 0.055 |\n\nATE (risk difference):\n\n```\n-0.004 (0.4 percentage points lower cardiovascular risk)\n```\n\nInterpretation:\n\n- The estimated cardiovascular risk difference between continuous denosumab vs continuous ZA is small.  \n- Both therapies appear similar in risk, consistent with findings in published RWE studies.  \n- Subgroup and sensitivity analyses may explore heterogeneity and robustness.\n\n---\n\n# 9. Sensitivity & Diagnostic Considerations\n\n### 9.1 Positivity\nCheck treatment probabilities at each timepoint.\n\n### 9.2 Extreme weights\nLMTP handles this better than IPTW, but diagnostics still matter.\n\n### 9.3 Truncation\nMay be needed for sparse treatment histories.\n\n### 9.4 Negative control outcomes\nUseful to diagnose unmeasured confounding.\n\n---\n\n# 10. Summary\n\nIn this chapter, you learned how to:\n\n- Build and structure longitudinal data  \n- Define static longitudinal interventions  \n- Apply LMTP/TMLE for longitudinal causal effects  \n- Interpret results in a real-world regulatory context  \n\nThis case study demonstrates how to use targeted learning methods to generate high-quality causal evidence from complex real-world data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.4.2 (2024-10-31 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 26200)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: America/Los_Angeles\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    \n [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   \n [9] ggplot2_3.5.2   tidyverse_2.0.0\n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 \n [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         \n [9] generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4 munsell_0.5.1    \n[13] pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6       utf8_1.2.4       \n[17] stringi_1.8.7     xfun_0.49         timechange_0.3.0  cli_3.6.5        \n[21] withr_3.0.2       magrittr_2.0.3    digest_0.6.37     grid_4.4.2       \n[25] rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4   vctrs_0.6.5      \n[29] evaluate_1.0.5    glue_1.8.0        fansi_1.0.6       colorspace_2.1-1 \n[33] rmarkdown_2.29    tools_4.4.2       pkgconfig_2.0.3   htmltools_0.5.8.1\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}