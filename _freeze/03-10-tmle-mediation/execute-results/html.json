{
  "hash": "4dc7df74d429fc44e6fa63fba1aa8695",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"An Illustrated Guide to TMLE for Mediation Analysis\"\nsubtitle: \"Decomposing total effects into direct and indirect pathways\"\nformat: html\n---\n\n\n\n\n# An Illustrated Guide to TMLE for Mediation Analysis\n*How to decompose a drug's total effect into what works directly and what works through an intermediate mechanism*\n\nIn pharmacoepidemiology, we often want to know not just **whether** a drug works, but **how** it works. Does dapagliflozin reduce cardiovascular events because it lowers blood pressure, because it improves glucose control, or through some other mechanism entirely?\n\n**Mediation analysis** decomposes a total causal effect into:\n\n- A **direct effect** — the part of the treatment effect NOT operating through the mediator\n- An **indirect effect** — the part operating THROUGH the mediator\n\nTMLE provides a principled framework for this decomposition that is doubly robust and compatible with machine learning.\n\n::: {.callout-note}\n## Learning objectives\n- Define natural direct effects (NDE) and natural indirect effects (NIE) using potential outcomes\n- Explain the cross-world independence assumption and why it is required for mediation\n- Construct the density ratio clever covariates used in TMLE for mediation\n- Implement NDE and NIE estimation via Monte Carlo integration within TMLE\n- Use the `crumble` package for automated TMLE-based mediation analysis\n- Interpret decomposed effects in a pharmacoepidemiology context (e.g., drug mechanism elucidation)\n:::\n\n::: {.callout-important}\n## Sources and scope\nThis chapter is educational. Causal conclusions depend on identification assumptions (e.g., consistency, exchangeability, positivity) and on diagnostic evidence that the data support the target estimand. When flexible machine learning is used for nuisance estimation, valid inference typically requires cross-fitting or a cross-validated TMLE variant, plus appropriate rate conditions.\n:::\n\n\n\n\n\n\n\n\n\n---\n\n# 1. Clinical Motivation\n\n## The Pharmacoepidemiologic Question\n\nSGLT2 inhibitors (like dapagliflozin) have shown surprising cardiovascular benefits in type 2 diabetes trials. The FDA and sponsor want to understand **the mechanism**:\n\n> **How much of dapagliflozin's effect on reducing MACE operates through HbA1c reduction (glycemic pathway), and how much operates through other mechanisms (e.g., blood pressure, weight loss, direct cardiac effects)?**\n\nThis matters because:\n\n- If the effect is entirely through glycemic control, other glucose-lowering drugs should work too\n- If the effect is mostly direct, SGLT2 inhibitors have a unique cardiovascular benefit worth highlighting in labeling\n- Understanding mechanisms guides future drug development\n\n:::{.callout-note}\n## The Setup\n\n- **Treatment (A):** Dapagliflozin vs. sulfonylurea\n- **Mediator (M):** 6-month HbA1c change (glycemic improvement)\n- **Outcome (Y):** 1-year MACE\n- **Confounders (W):** Age, BMI, baseline HbA1c, prior CVD, eGFR, statin use\n- **Question:** How much of the $A \\to Y$ effect goes through $A \\to M \\to Y$?\n:::\n\n---\n\n# 2. Mediation Analysis: The Causal Roadmap\n\n## Step 1: Define the Causal Question\n\nIn mediation, we decompose the **total effect** into two pieces:\n\n:::{.callout-tip}\n## Total Effect = Natural Direct Effect + Natural Indirect Effect\n\n**Total Effect (TE):**\n$$TE = E[Y(1, M(1))] - E[Y(0, M(0))]$$\nThe overall effect of treatment on outcome (what we estimated in Chapter 2.4).\n\n**Natural Direct Effect (NDE):**\n$$NDE = E[Y(1, M(0))] - E[Y(0, M(0))]$$\nThe effect of treatment on outcome if we could **hold the mediator at its control value**.\n\"What if we gave the drug but magically blocked it from changing HbA1c?\"\n\n**Natural Indirect Effect (NIE):**\n$$NIE = E[Y(1, M(1))] - E[Y(1, M(0))]$$\nThe effect of the mediator change induced by treatment, **while keeping treatment on**.\n\"What if we didn't change the drug assignment but shifted HbA1c as dapagliflozin would?\"\n:::\n\nThe decomposition is: $TE = NDE + NIE$\n\n:::{.callout-caution}\n## Plain Language\n\n- **NDE:** \"How much does the drug help even if it didn't change HbA1c at all?\" (the direct pathway — blood pressure, weight, cardiac remodeling, etc.)\n- **NIE:** \"How much does the drug help specifically because it lowers HbA1c?\" (the glycemic pathway)\n\nIf the NIE is large, glycemic control is the main mechanism. If the NDE is large, the drug works through non-glycemic pathways.\n:::\n\n## Step 2: The Causal Model (DAG)\n\nThe mediation DAG adds one node compared to the standard confounding DAG:\n\n```\n              W (confounders)\n            / | \\\n           /  |  \\\n          v   v   v\n          A → M → Y\n          |       ↑\n          └───────┘\n            (direct)\n```\n\n- $W \\to A$: confounders affect treatment\n- $W \\to M$: confounders affect the mediator\n- $W \\to Y$: confounders affect the outcome\n- $A \\to M$: treatment affects the mediator (dapagliflozin lowers HbA1c)\n- $M \\to Y$: the mediator affects the outcome (HbA1c affects MACE risk)\n- $A \\to Y$: treatment directly affects the outcome (non-glycemic pathways)\n\n:::{.callout-important}\n## Critical Assumption: No Mediator-Outcome Confounding Affected by Treatment\n\nFor mediation to work, there must be **no confounder of the M → Y relationship that is itself affected by treatment**. If treatment changes a variable $Z$ that confounds $M \\to Y$, the natural direct and indirect effects are not identifiable from observed data.\n\n```\n     A → Z → M → Y       ← Z confounds M→Y AND is affected by A\n              ↑\n              Z ──────→ Y  ← This breaks identification!\n```\n\nThis is the hardest assumption in mediation analysis. In our example: does dapagliflozin change something (like blood pressure or weight) that both affects HbA1c trajectory AND independently affects MACE? If so, we need more advanced methods (interventional effects).\n:::\n\n## Step 3: Assumptions for Mediation\n\nTo identify the NDE and NIE, we need the standard confounding assumptions PLUS additional ones:\n\n1. **No unmeasured treatment-outcome confounding:** $Y(a, m) \\perp\\!\\!\\!\\perp A \\mid W$\n2. **No unmeasured mediator-outcome confounding:** $Y(a, m) \\perp\\!\\!\\!\\perp M \\mid A, W$\n3. **No unmeasured treatment-mediator confounding:** $M(a) \\perp\\!\\!\\!\\perp A \\mid W$\n4. **Cross-world independence:** No $W$-adjusted confounder of $M \\to Y$ is affected by $A$\n\n:::{.callout-warning}\n## The Cross-World Problem\n\nAssumption 4 is called the \"cross-world\" assumption because the NDE involves a quantity $Y(1, M(0))$ — the outcome under treatment $A = 1$ with the mediator value that **would have occurred** under $A = 0$. This never happens in reality; it combines potential outcomes from two different \"worlds.\"\n\nThis assumption is untestable and often debated. If you are uncomfortable with it, consider **interventional (in)direct effects**, which replace the cross-world assumption with a weaker one. We briefly discuss this in Section 9.\n:::\n\n## Step 4: Statistical Estimands\n\nUnder the assumptions above, the NDE and NIE are identified by statistical quantities:\n\n:::{.callout-note}\n## The Mediation G-Computation Formulas\n\n**NDE:**\n$$NDE = \\sum_m \\sum_w \\big[E[Y \\mid A=1, M=m, W=w] - E[Y \\mid A=0, M=m, W=w]\\big] \\cdot P(M=m \\mid A=0, W=w) \\cdot P(W=w)$$\n\n**NIE:**\n$$NIE = \\sum_m \\sum_w E[Y \\mid A=1, M=m, W=w] \\cdot \\big[P(M=m \\mid A=1, W=w) - P(M=m \\mid A=0, W=w)\\big] \\cdot P(W=w)$$\n\nThese formulas require:\n\n- An **outcome model:** $E[Y \\mid A, M, W]$\n- A **mediator model:** $P(M \\mid A, W)$\n- A **treatment model:** $P(A \\mid W)$ (for the TMLE targeting step)\n:::\n\n## Step 5: Why TMLE for Mediation?\n\n| Method | Limitation |\n|--------|-----------|\n| Baron-Kenny regression | Assumes linear models, no interactions, continuous mediator |\n| Parametric G-computation | Works but depends on correct outcome AND mediator models |\n| Weighting-based | Can be unstable with continuous mediators |\n| **TMLE for mediation** | Doubly robust, handles nonlinear effects, works with Super Learner |\n\n---\n\n# 3. Data Simulation\n\nWe simulate a dataset where dapagliflozin reduces MACE both directly and through HbA1c improvement.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nset.seed(2026)\nn <- 4000\n\n# --- Baseline confounders ---\nage    <- rnorm(n, mean = 62, sd = 10)\nbmi    <- rnorm(n, mean = 31, sd = 5)\nhba1c_bl <- rnorm(n, mean = 8.2, sd = 1.3)   # baseline HbA1c\ncvd    <- rbinom(n, 1, plogis(-3.5 + 0.04 * age + 0.03 * bmi))\negfr   <- pmax(15, rnorm(n, mean = 95 - 0.5 * (age - 60), sd = 15))\nstatin <- rbinom(n, 1, plogis(-1.5 + 1.8 * cvd + 0.02 * age))\n\n# --- Treatment model ---\nlp_trt <- -0.5 +\n  -0.02 * (age - 62) +\n  0.03 * (bmi - 31) +\n  -0.1 * (hba1c_bl - 8.2) +\n  -0.5 * cvd +\n  0.015 * (egfr - 80)\n\nA <- rbinom(n, 1, plogis(lp_trt))\n\n# --- Mediator: 6-month HbA1c change ---\n# Dapagliflozin lowers HbA1c more than sulfonylurea\n# Negative values = improvement (reduction in HbA1c)\nM <- rnorm(n,\n  mean = -0.3 - 0.5 * A + 0.1 * (hba1c_bl - 8.2) - 0.005 * egfr +\n         0.01 * (age - 62),\n  sd = 0.6\n)\n\n# --- Outcome: 1-year MACE ---\n# Direct effect of A (non-glycemic) + indirect effect through M\nlp_out <- -3.5 +\n  -0.25 * A +           # DIRECT effect (non-glycemic pathways)\n  0.40 * M +            # mediator effect (higher HbA1c change → more MACE)\n  0.04 * (age - 62) +\n  0.02 * (bmi - 31) +\n  0.90 * cvd +\n  -0.01 * (egfr - 80) +\n  0.25 * statin +\n  0.15 * A * cvd        # treatment-confounder interaction on direct path\n\nY <- rbinom(n, 1, plogis(lp_out))\n\ndat <- tibble(age, bmi, hba1c_bl, cvd, egfr, statin, A, M, Y)\n```\n:::\n\n\n\n\n### True causal effects\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Compute true NDE and NIE from the structural model ---\n\n# We need: E[M | A=0, W] and E[M | A=1, W]\nM_mean_A0 <- -0.3 - 0.5 * 0 + 0.1 * (hba1c_bl - 8.2) - 0.005 * egfr +\n              0.01 * (age - 62)\nM_mean_A1 <- -0.3 - 0.5 * 1 + 0.1 * (hba1c_bl - 8.2) - 0.005 * egfr +\n              0.01 * (age - 62)\n\n# Monte Carlo integration over M distribution\nset.seed(999)\nn_mc <- 50  # MC samples per observation\n\ntrue_nde_vals <- numeric(n)\ntrue_nie_vals <- numeric(n)\ntrue_te_vals  <- numeric(n)\n\nfor (i in 1:n) {\n  # Sample M values from P(M | A=0, W)\n  m_samples_A0 <- rnorm(n_mc, mean = M_mean_A0[i], sd = 0.6)\n  # Sample M values from P(M | A=1, W)\n  m_samples_A1 <- rnorm(n_mc, mean = M_mean_A1[i], sd = 0.6)\n\n  w_vec <- c(age[i], bmi[i], cvd[i], egfr[i], statin[i])\n\n  # E[Y(1, M(0))] - average over M drawn from P(M|A=0,W)\n  lp_1_m0 <- -3.5 + -0.25 * 1 + 0.40 * m_samples_A0 +\n              0.04 * (w_vec[1] - 62) + 0.02 * (w_vec[2] - 31) +\n              0.90 * w_vec[3] + -0.01 * (w_vec[4] - 80) +\n              0.25 * w_vec[5] + 0.15 * 1 * w_vec[3]\n  EY_1_M0 <- mean(plogis(lp_1_m0))\n\n  # E[Y(0, M(0))]\n  lp_0_m0 <- -3.5 + -0.25 * 0 + 0.40 * m_samples_A0 +\n              0.04 * (w_vec[1] - 62) + 0.02 * (w_vec[2] - 31) +\n              0.90 * w_vec[3] + -0.01 * (w_vec[4] - 80) +\n              0.25 * w_vec[5] + 0.15 * 0 * w_vec[3]\n  EY_0_M0 <- mean(plogis(lp_0_m0))\n\n  # E[Y(1, M(1))]\n  lp_1_m1 <- -3.5 + -0.25 * 1 + 0.40 * m_samples_A1 +\n              0.04 * (w_vec[1] - 62) + 0.02 * (w_vec[2] - 31) +\n              0.90 * w_vec[3] + -0.01 * (w_vec[4] - 80) +\n              0.25 * w_vec[5] + 0.15 * 1 * w_vec[3]\n  EY_1_M1 <- mean(plogis(lp_1_m1))\n\n  true_nde_vals[i] <- EY_1_M0 - EY_0_M0\n  true_nie_vals[i] <- EY_1_M1 - EY_1_M0\n  true_te_vals[i]  <- EY_1_M1 - EY_0_M0\n}\n\ntrue_NDE <- mean(true_nde_vals)\ntrue_NIE <- mean(true_nie_vals)\ntrue_TE  <- mean(true_te_vals)\n\ncat(\"True Total Effect: \", round(true_TE, 4), \"\\n\")\n#> True Total Effect:  -0.0122\ncat(\"True NDE (direct): \", round(true_NDE, 4), \"\\n\")\n#> True NDE (direct):  -0.0054\ncat(\"True NIE (via M):  \", round(true_NIE, 4), \"\\n\")\n#> True NIE (via M):   -0.0068\ncat(\"NDE + NIE:         \", round(true_NDE + true_NIE, 4), \"\\n\")\n#> NDE + NIE:          -0.0122\ncat(\"Proportion mediated:\", round(true_NIE / true_TE * 100, 1), \"%\\n\")\n#> Proportion mediated: 55.5 %\n```\n:::\n\n\n\n\n---\n\n# 4. Why Naive Approaches Fail\n\n## 4A. The Baron-Kenny Trap\n\nThe classic approach fits two regressions and reads off coefficients. Let's see what it gives us:\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Step 1: Total effect\ntotal_mod <- glm(Y ~ A + age + bmi + hba1c_bl + cvd + egfr + statin,\n                 family = binomial, data = dat)\n\n# Step 2: Mediator model\nmed_mod <- lm(M ~ A + age + bmi + hba1c_bl + cvd + egfr + statin,\n              data = dat)\n\n# Step 3: Outcome model with mediator\nfull_mod <- glm(Y ~ A + M + age + bmi + hba1c_bl + cvd + egfr + statin,\n                family = binomial, data = dat)\n\ncat(\"--- Baron-Kenny style coefficients ---\\n\")\n#> --- Baron-Kenny style coefficients ---\ncat(\"Total effect (A in model without M):\", round(coef(total_mod)[\"A\"], 3), \"(log-OR)\\n\")\n#> Total effect (A in model without M): -0.548 (log-OR)\ncat(\"Direct effect (A in model with M):  \", round(coef(full_mod)[\"A\"], 3), \"(log-OR)\\n\")\n#> Direct effect (A in model with M):   -0.205 (log-OR)\ncat(\"Mediator effect (M on Y):           \", round(coef(full_mod)[\"M\"], 3), \"(log-OR)\\n\")\n#> Mediator effect (M on Y):            0.689 (log-OR)\ncat(\"Treatment on mediator:              \", round(coef(med_mod)[\"A\"], 3), \"(mean change)\\n\")\n#> Treatment on mediator:               -0.514 (mean change)\n```\n:::\n\n\n\n\n:::{.callout-caution}\n## What's Wrong with Baron-Kenny Here?\n\n1. **Scale:** The coefficients are on the log-odds scale. The \"difference in coefficients\" method ($TE - DE$) does not equal the indirect effect on the risk difference scale for non-linear models.\n\n2. **Non-collapsibility:** The log-odds ratio is non-collapsible — the coefficient of $A$ changes when you add $M$ to the model, even if there is NO mediation, simply because of the non-linear link function.\n\n3. **No valid standard errors** for the indirect effect without additional assumptions.\n\n4. **No double robustness** — if either model is misspecified, everything is biased.\n\nWe need a proper decomposition on the risk difference scale.\n:::\n\n---\n\n## 4B. Naive Regression-Based Decomposition on the Risk Difference Scale\n\nA better approach: use G-computation-style prediction, but decompose manually.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Outcome model including the mediator\nq_med_mod <- glm(Y ~ A + M + age + bmi + hba1c_bl + cvd + egfr + statin +\n                   A:cvd,\n                 family = binomial, data = dat)\n\n# Mediator model\nm_mod <- lm(M ~ A + age + bmi + hba1c_bl + egfr, data = dat)\n\n# Predicted mediator values under A=0 and A=1\nM_hat_A0 <- predict(m_mod, newdata = dat %>% mutate(A = 0))\nM_hat_A1 <- predict(m_mod, newdata = dat %>% mutate(A = 1))\n\n# E[Y(1, M(0))]: set A=1, M=M_hat_A0\nEY_1_M0 <- mean(predict(q_med_mod,\n  newdata = dat %>% mutate(A = 1, M = M_hat_A0),\n  type = \"response\"))\n\n# E[Y(0, M(0))]: set A=0, M=M_hat_A0\nEY_0_M0 <- mean(predict(q_med_mod,\n  newdata = dat %>% mutate(A = 0, M = M_hat_A0),\n  type = \"response\"))\n\n# E[Y(1, M(1))]: set A=1, M=M_hat_A1\nEY_1_M1 <- mean(predict(q_med_mod,\n  newdata = dat %>% mutate(A = 1, M = M_hat_A1),\n  type = \"response\"))\n\nnaive_NDE <- EY_1_M0 - EY_0_M0\nnaive_NIE <- EY_1_M1 - EY_1_M0\nnaive_TE  <- EY_1_M1 - EY_0_M0\n\ncat(\"Naive G-comp NDE:\", round(naive_NDE, 4), \" (true:\", round(true_NDE, 4), \")\\n\")\n#> Naive G-comp NDE: -0.0081  (true: -0.0054 )\ncat(\"Naive G-comp NIE:\", round(naive_NIE, 4), \" (true:\", round(true_NIE, 4), \")\\n\")\n#> Naive G-comp NIE: -0.0103  (true: -0.0068 )\ncat(\"Naive G-comp TE: \", round(naive_TE, 4),  \" (true:\", round(true_TE, 4), \")\\n\")\n#> Naive G-comp TE:  -0.0184  (true: -0.0122 )\n```\n:::\n\n\n\n\n:::{.callout-note}\n## This Is G-Computation for Mediation\n\nThis approach correctly decomposes the effect on the risk difference scale. But it has the same weakness as point-treatment G-computation: it depends entirely on both the outcome model AND the mediator model being correctly specified. There is no robustness to misspecification.\n\nTMLE adds targeting to make this doubly robust.\n:::\n\n---\n\n# 5. TMLE for Mediation: Step by Step\n\nWe now implement a TMLE-based mediation analysis. The algorithm extends the point-treatment TMLE in a specific way: we need to \"target\" the outcome model not just for the treatment mechanism, but also for the mediator mechanism.\n\n## The Algorithm Overview\n\n```\n┌───────────────────────────────────────┐\n│ Step 1: Fit the outcome model         │\n│ Q(A, M, W) = E[Y | A, M, W]          │\n│ Predict under (A=1,M) and (A=0,M)    │\n└───────────────┬───────────────────────┘\n                │\n┌───────────────▼───────────────────────┐\n│ Step 2: Fit the mediator model        │\n│ P(M | A, W)                           │\n│ Needed for NDE/NIE decomposition      │\n└───────────────┬───────────────────────┘\n                │\n┌───────────────▼───────────────────────┐\n│ Step 3: Fit the treatment model       │\n│ g(W) = P(A=1 | W)                     │\n│ Needed for the clever covariate       │\n└───────────────┬───────────────────────┘\n                │\n┌───────────────▼───────────────────────┐\n│ Step 4: Compute mediation-specific    │\n│ clever covariates for NDE and NIE     │\n└───────────────┬───────────────────────┘\n                │\n┌───────────────▼───────────────────────┐\n│ Step 5: Fluctuate Q to get Q*         │\n│ (targeting step for each effect)      │\n└───────────────┬───────────────────────┘\n                │\n┌───────────────▼───────────────────────┐\n│ Step 6: Plug Q* into mediation        │\n│ formulas to estimate NDE and NIE      │\n└───────────────────────────────────────┘\n```\n\n---\n\n## Step 1: Fit the Outcome Model\n\n:::{.callout-note}\n## Step 1: Model E[Y | A, M, W]\n\nJust like standard TMLE, start by fitting a model for the expected outcome. But now the model includes the **mediator** $M$ as a predictor alongside treatment $A$ and confounders $W$.\n\n$$\\hat{Q}(A, M, W) = \\hat{E}[Y \\mid A, M, W]$$\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlogit <- function(p) log(p / (1 - p))\n\n# Outcome model: includes treatment, mediator, and confounders\nq_mod <- glm(Y ~ A + M + age + bmi + hba1c_bl + cvd + egfr + statin +\n               A:cvd + A:M,\n             family = binomial, data = dat)\n\n# Predict at observed values\nQAM_init <- predict(q_mod, type = \"response\")\n\n# Predict under counterfactual treatment values (keeping M observed)\nQ1M_init <- predict(q_mod, newdata = dat %>% mutate(A = 1), type = \"response\")\nQ0M_init <- predict(q_mod, newdata = dat %>% mutate(A = 0), type = \"response\")\n\ncat(\"Q(A,M,W) range:\", round(range(QAM_init), 4), \"\\n\")\n#> Q(A,M,W) range: 0.0011 0.3803\n```\n:::\n\n\n\n\n---\n\n## Step 2: Fit the Mediator Model\n\n:::{.callout-tip}\n## Step 2: Model P(M | A, W) — The Mediator Distribution\n\nTo decompose the total effect, we need to know how the mediator distribution shifts under treatment vs. control. For a continuous mediator, we model $M \\mid A, W$ as normally distributed.\n\nThis model serves two purposes:\n\n1. It tells us what $M$ values to expect under $A = 0$ vs. $A = 1$\n2. It provides density ratios needed for the clever covariate\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Mediator model: how does M depend on A and W?\nm_mod <- lm(M ~ A + age + bmi + hba1c_bl + egfr, data = dat)\nsigma_m <- sigma(m_mod)\n\n# Predicted mediator mean under A=0 and A=1\nM_mean_a0 <- predict(m_mod, newdata = dat %>% mutate(A = 0))\nM_mean_a1 <- predict(m_mod, newdata = dat %>% mutate(A = 1))\n\n# Density of observed M under each treatment condition\n# P(M_obs | A=0, W) and P(M_obs | A=1, W)\ndens_M_A0 <- dnorm(dat$M, mean = M_mean_a0, sd = sigma_m)\ndens_M_A1 <- dnorm(dat$M, mean = M_mean_a1, sd = sigma_m)\n\ncat(\"Mean mediator shift (A=1 vs A=0):\", round(mean(M_mean_a1 - M_mean_a0), 3), \"\\n\")\n#> Mean mediator shift (A=1 vs A=0): -0.512\n```\n:::\n\n\n\n\n---\n\n## Step 3: Fit the Treatment Model\n\n:::{.callout-tip}\n## Step 3: Model P(A = 1 | W) — The Propensity Score\n\nSame as standard TMLE. The propensity score is needed for the clever covariates.\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ng_mod <- glm(A ~ age + bmi + hba1c_bl + cvd + egfr + statin,\n             family = binomial, data = dat)\n\nps <- predict(g_mod, type = \"response\")\nps <- pmax(0.01, pmin(0.99, ps))\n\ncat(\"Propensity score range:\", round(range(ps), 3), \"\\n\")\n#> Propensity score range: 0.112 0.707\n```\n:::\n\n\n\n\n---\n\n## Step 4: The Mediation Clever Covariates\n\n:::{.callout-important}\n## Step 4: Clever Covariates for NDE and NIE\n\nThis is where mediation TMLE differs from standard TMLE. The clever covariate for the NDE is different from the one for the NIE, because they target different estimands.\n\n**For the NDE**, we need the expected outcome under $A = 1$ vs. $A = 0$ while holding $M$ at its distribution under $A = 0$. The clever covariate involves a **density ratio** that reweights the mediator distribution:\n\n$$H^{NDE}(A, M, W) = \\frac{I(A=1) \\cdot f(M \\mid A=0, W)}{g(W) \\cdot f(M \\mid A=1, W)} - \\frac{I(A=0)}{1 - g(W)}$$\n\n**For the NIE**, we need the expected outcome under $A = 1$ comparing the mediator distribution under $A = 1$ vs. $A = 0$:\n\n$$H^{NIE}(A, M, W) = \\frac{I(A=1)}{g(W)} - \\frac{I(A=1) \\cdot f(M \\mid A=0, W)}{g(W) \\cdot f(M \\mid A=1, W)}$$\n\nThe density ratio $f(M \\mid A=0, W) / f(M \\mid A=1, W)$ is what connects the mediator model to the targeting step. It reweights the treated group's mediator values to look like the control group's mediator distribution.\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Density ratio: P(M | A=0, W) / P(M | A=1, W)\n# This ratio \"transports\" the mediator distribution from control to treatment\ndensity_ratio <- dens_M_A0 / pmax(dens_M_A1, 1e-10)\n\n# Clever covariate for NDE\nH_NDE <- dat$A * density_ratio / ps - (1 - dat$A) / (1 - ps)\n\n# Clever covariate for NIE\nH_NIE <- dat$A / ps - dat$A * density_ratio / ps\n\ncat(\"Density ratio range:\", round(range(density_ratio), 3), \"\\n\")\n#> Density ratio range: 0.057 21.999\ncat(\"H_NDE range:\", round(range(H_NDE), 2), \"\\n\")\n#> H_NDE range: -3.37 31.78\ncat(\"H_NIE range:\", round(range(H_NIE), 2), \"\\n\")\n#> H_NIE range: -29 4.32\n```\n:::\n\n\n\n\n:::{.callout-caution}\n## What Does the Density Ratio Do?\n\nThe density ratio $f(M \\mid A=0, W) / f(M \\mid A=1, W)$ answers: \"How much more (or less) likely is this particular mediator value under control than under treatment?\"\n\n- **Ratio > 1:** This mediator value is more typical of the control group → gets upweighted\n- **Ratio < 1:** This mediator value is more typical of the treatment group → gets downweighted\n- **Ratio ≈ 1:** This mediator value is equally likely under both treatments\n\nWhen we multiply a treated patient's outcome by this ratio, we effectively \"transport\" their mediator to what it would have looked like without treatment — which is exactly what the NDE requires.\n:::\n\n---\n\n## Step 5: Targeting (Fluctuation) for NDE\n\n:::{.callout-warning}\n## Step 5: Fluctuate Q to Target the NDE\n\nJust like standard TMLE, we fit a logistic regression with the initial $\\hat{Q}$ as an offset and the NDE clever covariate as the predictor. The coefficient $\\epsilon$ tells us how much to update.\n\n$$\\text{logit}(Y) = \\text{logit}(\\hat{Q}(A, M, W)) + \\epsilon_{NDE} \\cdot H_{NDE}$$\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Fluctuation for NDE\nfluc_nde <- glm(dat$Y ~ -1 + offset(logit(QAM_init)) + H_NDE,\n                family = binomial)\neps_nde <- coef(fluc_nde)\n\ncat(\"Epsilon NDE:\", round(eps_nde, 5), \"\\n\")\n#> Epsilon NDE: -0.0087\n\n# Update Q predictions\nQ1M_star_nde <- plogis(logit(Q1M_init) + eps_nde * density_ratio / ps)\nQ0M_star_nde <- plogis(logit(Q0M_init) + eps_nde * (-1 / (1 - ps)))\n```\n:::\n\n\n\n\n---\n\n## Step 6: Compute the NDE\n\n:::{.callout-note}\n## Step 6: Plug-in NDE Estimate\n\nThe NDE is the difference in the targeted outcome predictions, averaged over the population, where the mediator is held at its **control** distribution.\n\nFor the treated group (with density-reweighted mediator), we average:\n$$\\widehat{NDE} = \\frac{1}{n}\\sum_i \\hat{Q}^*_1(M_i, W_i) \\cdot r(M_i, W_i) - \\frac{1}{n}\\sum_i \\hat{Q}^*_0(M_i, W_i)$$\n\nwhere $r(M_i, W_i)$ is a normalized version of the density ratio that integrates properly.\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# For the NDE, we need E[Q*(1,M,W)] where M ~ P(M|A=0,W)\n# We use the density-ratio weighted average among treated\n# and the direct average among controls\n\n# Approach: Monte Carlo integration over P(M | A=0, W)\nset.seed(42)\nn_mc <- 30\n\nnde_mc <- numeric(n)\nfor (i in 1:n) {\n  m_draws <- rnorm(n_mc, mean = M_mean_a0[i], sd = sigma_m)\n\n  # Density ratio for each MC draw: f(m|A=0,W) / f(m|A=1,W)\n  dr_draws <- dnorm(m_draws, mean = M_mean_a0[i], sd = sigma_m) /\n              pmax(dnorm(m_draws, mean = M_mean_a1[i], sd = sigma_m), 1e-10)\n\n  # Q*(1, m, W) for each m draw\n  # H_NDE at (A=1, m) = density_ratio(m) / ps\n  newdat_1 <- dat[rep(i, n_mc), ] %>% mutate(A = 1, M = m_draws)\n  q1m <- predict(q_mod, newdata = newdat_1, type = \"response\")\n  q1m_star <- plogis(logit(q1m) + eps_nde * dr_draws / ps[i])\n\n  # Q*(0, m, W) for each m draw\n  # H_NDE at (A=0, m) = -1 / (1 - ps)\n  newdat_0 <- dat[rep(i, n_mc), ] %>% mutate(A = 0, M = m_draws)\n  q0m <- predict(q_mod, newdata = newdat_0, type = \"response\")\n  q0m_star <- plogis(logit(q0m) + eps_nde * (-1 / (1 - ps[i])))\n\n  nde_mc[i] <- mean(q1m_star) - mean(q0m_star)\n}\n\ntmle_NDE <- mean(nde_mc)\ncat(\"TMLE NDE:\", round(tmle_NDE, 4), \" (true:\", round(true_NDE, 4), \")\\n\")\n#> TMLE NDE: -0.0106  (true: -0.0054 )\n```\n:::\n\n\n\n\n---\n\n## Step 7: Targeting and Computing the NIE\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Fluctuation for NIE\nfluc_nie <- glm(dat$Y ~ -1 + offset(logit(QAM_init)) + H_NIE,\n                family = binomial)\neps_nie <- coef(fluc_nie)\ncat(\"Epsilon NIE:\", round(eps_nie, 5), \"\\n\")\n#> Epsilon NIE: 0.0217\n\n# Monte Carlo integration for NIE\nnie_mc <- numeric(n)\nfor (i in 1:n) {\n  # M draws from P(M|A=1,W)\n  m_draws_a1 <- rnorm(n_mc, mean = M_mean_a1[i], sd = sigma_m)\n  # M draws from P(M|A=0,W)\n  m_draws_a0 <- rnorm(n_mc, mean = M_mean_a0[i], sd = sigma_m)\n\n  # Density ratios for each draw: f(m|A=0,W) / f(m|A=1,W)\n  dr_a1 <- dnorm(m_draws_a1, mean = M_mean_a0[i], sd = sigma_m) /\n           pmax(dnorm(m_draws_a1, mean = M_mean_a1[i], sd = sigma_m), 1e-10)\n  dr_a0 <- dnorm(m_draws_a0, mean = M_mean_a0[i], sd = sigma_m) /\n           pmax(dnorm(m_draws_a0, mean = M_mean_a1[i], sd = sigma_m), 1e-10)\n\n  # Q*(1, M(1), W) - Q*(1, M(0), W)\n  # H_NIE at (A=1, m) = (1 - density_ratio(m)) / ps\n  newdat_1_m1 <- dat[rep(i, n_mc), ] %>% mutate(A = 1, M = m_draws_a1)\n  newdat_1_m0 <- dat[rep(i, n_mc), ] %>% mutate(A = 1, M = m_draws_a0)\n\n  q_m1 <- predict(q_mod, newdata = newdat_1_m1, type = \"response\")\n  q_m0 <- predict(q_mod, newdata = newdat_1_m0, type = \"response\")\n\n  q_m1_star <- plogis(logit(q_m1) + eps_nie * (1 - dr_a1) / ps[i])\n  q_m0_star <- plogis(logit(q_m0) + eps_nie * (1 - dr_a0) / ps[i])\n\n  nie_mc[i] <- mean(q_m1_star) - mean(q_m0_star)\n}\n\ntmle_NIE <- mean(nie_mc)\ntmle_TE  <- tmle_NDE + tmle_NIE\n\ncat(\"TMLE NIE:\", round(tmle_NIE, 4), \" (true:\", round(true_NIE, 4), \")\\n\")\n#> TMLE NIE: -0.0087  (true: -0.0068 )\ncat(\"TMLE TE: \", round(tmle_TE, 4),  \" (true:\", round(true_TE, 4), \")\\n\")\n#> TMLE TE:  -0.0193  (true: -0.0122 )\n```\n:::\n\n\n\n\n---\n\n# 6. Results Comparison\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nresults <- tibble(\n  Effect = rep(c(\"Total Effect\", \"Natural Direct Effect\", \"Natural Indirect Effect\"), 3),\n  Method = rep(c(\"True\", \"Naive G-comp\", \"TMLE\"), each = 3),\n  Estimate = c(\n    true_TE, true_NDE, true_NIE,\n    naive_TE, naive_NDE, naive_NIE,\n    tmle_TE, tmle_NDE, tmle_NIE\n  )\n)\n\nresults %>%\n  pivot_wider(names_from = Method, values_from = Estimate) %>%\n  mutate(across(where(is.numeric), ~round(., 4)))\n#> # A tibble: 3 × 4\n#>   Effect                     True `Naive G-comp`    TMLE\n#>   <chr>                     <dbl>          <dbl>   <dbl>\n#> 1 Total Effect            -0.0122        -0.0184 -0.0193\n#> 2 Natural Direct Effect   -0.0054        -0.0081 -0.0106\n#> 3 Natural Indirect Effect -0.0068        -0.0103 -0.0087\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Visualization\nggplot(results, aes(x = Estimate, y = Effect, color = Method, shape = Method)) +\n  geom_point(size = 3, position = position_dodge(width = 0.3)) +\n  labs(\n    x = \"Effect Estimate (Risk Difference)\",\n    y = \"\",\n    title = \"Mediation Decomposition: Comparing Methods\"\n  ) +\n  theme_minimal() +\n  scale_color_manual(values = c(\"#228833\", \"#4477AA\", \"#EE6677\"))\n```\n\n::: {.cell-output-display}\n![](03-10-tmle-mediation_files/figure-html/unnamed-chunk-14-1.png){fig-align='center' width=672}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Proportion mediated\ncat(\"\\n=== Proportion Mediated ===\\n\")\n#> \n#> === Proportion Mediated ===\ncat(\"True:       \", round(true_NIE / true_TE * 100, 1), \"%\\n\")\n#> True:        55.5 %\ncat(\"Naive G-comp:\", round(naive_NIE / naive_TE * 100, 1), \"%\\n\")\n#> Naive G-comp: 55.9 %\ncat(\"TMLE:       \", round(tmle_NIE / tmle_TE * 100, 1), \"%\\n\")\n#> TMLE:        45 %\n```\n:::\n\n\n\n\n---\n\n# 7. Diagnostics for Mediation TMLE\n\n## 7.1 Propensity Score Overlap\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(dat, aes(x = ps, fill = factor(A, labels = c(\"Sulfonylurea\", \"Dapagliflozin\")))) +\n  geom_density(alpha = 0.45) +\n  labs(\n    x = \"P(A=1 | W)\", fill = \"Treatment\",\n    title = \"Diagnostic: Propensity Score Overlap\"\n  ) +\n  theme_minimal() +\n  scale_fill_manual(values = c(\"#4477AA\", \"#EE6677\"))\n```\n\n::: {.cell-output-display}\n![](03-10-tmle-mediation_files/figure-html/unnamed-chunk-16-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\n## 7.2 Mediator Distribution by Treatment\n\n:::{.callout-tip}\n## Why This Matters\n\nThe NIE depends on the treatment actually **shifting** the mediator distribution. If the mediator distributions under $A = 0$ and $A = 1$ are identical, there is no indirect effect to detect.\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(dat, aes(x = M, fill = factor(A, labels = c(\"Sulfonylurea\", \"Dapagliflozin\")))) +\n  geom_density(alpha = 0.45) +\n  labs(\n    x = \"6-month HbA1c change (M)\",\n    fill = \"Treatment\",\n    title = \"Diagnostic: Mediator Distribution by Treatment Group\"\n  ) +\n  theme_minimal() +\n  scale_fill_manual(values = c(\"#4477AA\", \"#EE6677\"))\n```\n\n::: {.cell-output-display}\n![](03-10-tmle-mediation_files/figure-html/unnamed-chunk-17-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\n## 7.3 Density Ratio Distribution\n\n:::{.callout-caution}\n## Density Ratio Instability\n\nExtreme density ratios indicate that some observed mediator values are very unlikely under one treatment but common under the other. This creates instability analogous to extreme IPTW weights.\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(tibble(r = density_ratio), aes(x = r)) +\n  geom_histogram(bins = 50, fill = \"#CC6677\", alpha = 0.7) +\n  geom_vline(xintercept = 1, linetype = \"dashed\") +\n  labs(\n    x = \"Density ratio f(M|A=0,W) / f(M|A=1,W)\",\n    y = \"Count\",\n    title = \"Diagnostic: Mediator Density Ratio\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](03-10-tmle-mediation_files/figure-html/unnamed-chunk-18-1.png){fig-align='center' width=672}\n:::\n\n```{.r .cell-code}\n\ncat(\"Density ratio summary:\\n\")\n#> Density ratio summary:\nsummary(density_ratio)\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#>  0.05709  0.59038  1.10575  1.63305  2.02503 21.99932\ncat(\"Proportion > 3:\", round(mean(density_ratio > 3), 3), \"\\n\")\n#> Proportion > 3: 0.135\n```\n:::\n\n\n\n\n## 7.4 Mediator-Outcome Relationship\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Check that M actually predicts Y (otherwise no mediation to find)\nggplot(dat, aes(x = M, y = Y)) +\n  geom_smooth(method = \"loess\", se = TRUE, color = \"#228833\") +\n  facet_wrap(~factor(A, labels = c(\"Sulfonylurea\", \"Dapagliflozin\"))) +\n  labs(\n    x = \"6-month HbA1c change (M)\",\n    y = \"P(MACE)\",\n    title = \"Diagnostic: Mediator-Outcome Relationship by Treatment\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](03-10-tmle-mediation_files/figure-html/unnamed-chunk-19-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\n---\n\n# 8. Interpretation\n\n:::{.callout-note}\n## What Would We Tell the FDA?\n\nBased on the TMLE mediation analysis:\n\n- **Total effect:** Dapagliflozin reduces 1-year MACE risk by approximately 1.9 percentage points compared to sulfonylurea\n- **Direct effect (NDE):** Approximately 1.1 percentage points of this reduction operates through **non-glycemic pathways** (blood pressure reduction, weight loss, direct cardiac effects)\n- **Indirect effect via HbA1c (NIE):** Approximately 0.9 percentage points operates through **glycemic improvement**\n- **Proportion mediated:** About 45% of the cardiovascular benefit is attributable to HbA1c reduction\n\n**Implication:** The majority of the CV benefit appears to be through non-glycemic mechanisms, suggesting SGLT2 inhibitors have a unique cardioprotective effect beyond glucose lowering. This supports differentiated labeling.\n:::\n\n### Fragile Assumptions\n\n:::{.callout-warning}\n## What Could Go Wrong?\n\n1. **Unmeasured mediator-outcome confounders affected by treatment:** If dapagliflozin changes blood pressure (call it $Z$), and blood pressure both affects HbA1c trajectory AND directly affects MACE, the NDE/NIE decomposition is biased. This is the cross-world assumption.\n\n2. **Mediator measurement error:** If 6-month HbA1c is a noisy proxy for the true glycemic pathway, the NIE will be attenuated (biased toward zero) and the NDE will absorb the missing indirect effect.\n\n3. **Mediator model misspecification:** If the true mediator distribution is non-normal or has treatment-dependent variance, the density ratio may be miscalibrated.\n:::\n\n---\n\n# 9. Advanced: Interventional (In)Direct Effects\n\nIf the cross-world assumption (no treatment-affected mediator-outcome confounders) is violated, natural direct and indirect effects are not identified. An alternative is the **interventional (in)direct effect**.\n\n:::{.callout-tip}\n## Interventional Effects: A Weaker Assumption\n\nInstead of asking \"what if we set $M$ to $M(0)$?\" (cross-world), interventional effects ask \"what if we drew $M$ randomly from $P(M \\mid A = 0, W)$?\" (a stochastic intervention on the mediator).\n\n**Interventional Direct Effect (IDE):**\n$$IDE = E\\big[Y(1, G_0)\\big] - E\\big[Y(0, G_0)\\big]$$\n\n**Interventional Indirect Effect (IIE):**\n$$IIE = E\\big[Y(1, G_1)\\big] - E\\big[Y(1, G_0)\\big]$$\n\nwhere $G_a$ denotes a random draw from $P(M \\mid A = a, W)$.\n\nThe IDE and IIE do NOT require the cross-world assumption. They only need the standard no-unmeasured-confounding assumptions for $A \\to Y$, $A \\to M$, and $M \\to Y$ (conditional on $A$ and $W$).\n\nThe `lmtp` package can estimate interventional effects for longitudinal mediation settings.\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Conceptual: LMTP for interventional effects\nlibrary(lmtp)\n\n# Shift the mediator distribution as if treatment were control\nshift_mediator <- function(data, trt) {\n  # Draw M from P(M | A=0, W) instead of P(M | A=observed, W)\n  data[[trt]]  # placeholder — real implementation uses mediator density\n}\n\n# See lmtp documentation for full mediation analysis interface\n```\n:::\n\n\n\n\n---\n\n# 10. Comparison: Mediation Methods\n\n| Method | Handles nonlinearity | Doubly robust | Works with ML | Cross-world needed | Package |\n|--------|---------------------|--------------|--------------|-------------------|---------|\n| Baron-Kenny | No | No | No | Implicitly yes | Base R |\n| Parametric G-comp | Partially | No | No | Yes | `mediation` |\n| Weighting-based | Yes | No | Partially | Yes | `CMAverse` |\n| **TMLE for NDE/NIE** | **Yes** | **Yes** | **Yes** | **Yes** | `tmle` |\n| Interventional effects | Yes | Yes | Yes | **No** | `lmtp` |\n\n---\n\n# Key Takeaways\n\n:::{.callout-note}\n## Summary\n\n1. **Mediation analysis decomposes a total effect** into direct (not through the mediator) and indirect (through the mediator) components. This tells us *how* a drug works.\n\n2. **Baron-Kenny regression fails** for binary outcomes because of non-collapsibility. Even for continuous outcomes, it assumes linearity and no interactions.\n\n3. **TMLE for mediation** extends the standard TMLE algorithm with a mediator-specific **density ratio** in the clever covariate. This density ratio \"transports\" the mediator distribution from one treatment arm to the other.\n\n4. **The cross-world assumption** (no treatment-affected mediator-outcome confounders) is required for natural direct/indirect effects. If violated, consider **interventional effects** which require only standard confounding assumptions.\n\n5. **Diagnostics matter:** check propensity score overlap, mediator distribution shift, density ratio stability, and the mediator-outcome relationship.\n\n6. **The proportion mediated** tells decision-makers whether a drug works primarily through a specific mechanism or through other pathways — critical for labeling, mechanistic understanding, and competitor drug development.\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsessionInfo()\n#> R version 4.4.2 (2024-10-31 ucrt)\n#> Platform: x86_64-w64-mingw32/x64\n#> Running under: Windows 11 x64 (build 26200)\n#> \n#> Matrix products: default\n#> \n#> \n#> locale:\n#> [1] LC_COLLATE=English_United States.utf8 \n#> [2] LC_CTYPE=English_United States.utf8   \n#> [3] LC_MONETARY=English_United States.utf8\n#> [4] LC_NUMERIC=C                          \n#> [5] LC_TIME=English_United States.utf8    \n#> \n#> time zone: America/Los_Angeles\n#> tzcode source: internal\n#> \n#> attached base packages:\n#> [1] stats     graphics  grDevices utils     datasets  methods   base     \n#> \n#> other attached packages:\n#>  [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    \n#>  [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   \n#>  [9] ggplot2_3.5.2   tidyverse_2.0.0\n#> \n#> loaded via a namespace (and not attached):\n#>  [1] Matrix_1.7-1      gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2   \n#>  [5] tidyselect_1.2.1  splines_4.4.2     scales_1.3.0      yaml_2.3.10      \n#>  [9] fastmap_1.2.0     lattice_0.22-6    R6_2.6.1          labeling_0.4.3   \n#> [13] generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4 munsell_0.5.1    \n#> [17] pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6       utf8_1.2.4       \n#> [21] stringi_1.8.7     xfun_0.49         timechange_0.3.0  cli_3.6.5        \n#> [25] mgcv_1.9-1        withr_3.0.2       magrittr_2.0.3    digest_0.6.37    \n#> [29] grid_4.4.2        rstudioapi_0.17.1 hms_1.1.3         nlme_3.1-166     \n#> [33] lifecycle_1.0.4   vctrs_0.6.5       evaluate_1.0.5    glue_1.8.0       \n#> [37] farver_2.1.2      fansi_1.0.6       colorspace_2.1-1  rmarkdown_2.29   \n#> [41] tools_4.4.2       pkgconfig_2.0.3   htmltools_0.5.8.1\n```\n:::\n\n\n\n\n---\n\n## Sources and further reading\n\n- Zheng Z, van der Laan MJ (2012). Targeted maximum likelihood estimation of natural direct effects. *Int J Biostat* 8(1):Article 3.\n- VanderWeele TJ (2015). *Explanation in Causal Inference: Methods for Mediation and Interaction*. Oxford University Press.\n- Diaz I, Hejazi NS (2020). Causal mediation analysis for stochastic interventions. *JRSS-B* 82(3):661-683.\n- Pearl J (2001). Direct and indirect effects. *Proceedings of the 17th Conference on Uncertainty in Artificial Intelligence*, 411-420.\n- Robins JM, Richardson TS (2010). Alternative graphical causal models and the identification of direct effects. In *Causality and Psychopathology*, Oxford University Press.\n- Williams NT, Diaz I (2024). crumble: An R package for TMLE-based mediation analysis. [GitHub](https://github.com/nt-williams/crumble)\n- `medltmle` (if available): [GitHub search](https://github.com/topics/mediation-analysis)\n- van der Laan MJ, Rose S (2011). *Targeted Learning*. Springer.\n\n---\n\n## Software Implementation (R)\n\nThis example uses the `crumble` package (if available) to estimate the **natural direct effect (NDE)** and **natural indirect effect (NIE)** via TMLE-based mediation analysis. The `crumble` package implements targeted learning for mediation with flexible nuisance estimation.\n\n- Simulate data with a binary treatment $A$, continuous mediator $M$, and binary outcome $Y$\n- Estimate NDE and NIE using `crumble::crumble()` with cross-fitting\n- Falls back to a manual decomposition using `tmle` if `crumble` is unavailable\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(1)\nn <- 600\nW <- rnorm(n)\nA <- rbinom(n, 1, plogis(0.3 * W))\nM <- 0.5 * A + 0.4 * W + rnorm(n, sd = 0.8)\nY <- rbinom(n, 1, plogis(-1 + 0.4 * A + 0.6 * M + 0.3 * W))\n\ndat <- data.frame(W = W, A = A, M = M, Y = Y)\n\nif (requireNamespace(\"crumble\", quietly = TRUE)) {\n  library(crumble)\n\n  ## crumble estimates interventional (in)direct effects\n  ## using TMLE with cross-fitting\n  result <- crumble(\n    data = dat,\n    trt = \"A\",\n    outcome = \"Y\",\n    mediators = \"M\",\n    baseline = \"W\",\n    outcome_type = \"binomial\",\n    learners = c(\"SL.glm\", \"SL.mean\"),\n    nn_module = NULL  # use standard SL, not neural net\n  )\n\n  cat(\"── Mediation TMLE via crumble ──\\n\")\n  print(result)\n} else {\n  message(\"'crumble' package not found.\")\n  message(\"Install from GitHub:  remotes::install_github('nt-williams/crumble')\")\n  message(\"\\nFalling back to a manual total-effect decomposition...\\n\")\n\n  if (requireNamespace(\"tmle\", quietly = TRUE)) {\n    library(tmle)\n    ## Total effect only (not a true mediation decomposition)\n    fit <- tmle(Y = Y, A = A, W = data.frame(W = W),\n                Q.SL.library = \"SL.glm\", g.SL.library = \"SL.glm\")\n    cat(\"Total effect (ATE):\", round(fit$estimates$ATE$psi, 4), \"\\n\")\n    cat(\"95% CI:\", round(fit$estimates$ATE$CI, 4), \"\\n\")\n    cat(\"\\nNote: This is the total effect only.\\n\")\n    cat(\"For NDE/NIE decomposition, install the crumble package.\\n\")\n  } else {\n    message(\"Install 'tmle':  install.packages('tmle')\")\n  }\n}\n```\n:::\n",
    "supporting": [
      "03-10-tmle-mediation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}