{
  "hash": "d21a3be04a7f0333d271b26b8bf4b23e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial\"\nsubtitle: \"How intercurrent events shape what your analysis actually estimates\"\nformat: html\n---\n\n\n\n\n# Estimands in Time-to-Event Real-World Safety Analyses\n*A simulation-based tutorial for pharmacoepidemiologists*\n\nIn real-world safety studies, the question \"Does this drug increase the risk of adverse events?\" sounds simple. But the answer depends critically on **how you handle intercurrent events** --- treatment switching, discontinuation, death from other causes --- that occur between treatment initiation and the outcome. Different handling strategies define different **estimands**, and each estimand answers a fundamentally different scientific question.\n\nThis chapter uses a fully simulated safety study to illustrate three estimands side by side, showing how the same data can yield different estimates depending on the causal question being asked.\n\n::: {.callout-note}\n## Learning objectives\n- Define the three principal estimand strategies for time-to-event safety analyses: treatment-policy, while-on-treatment, and hypothetical\n- Explain how ICH E9(R1) connects estimand choice to intercurrent event handling\n- Simulate a realistic pharmacoepidemiology dataset with confounding, treatment switching, and administrative censoring\n- Implement Kaplan-Meier, IPCW-adjusted, and TMLE-based estimators for each estimand\n- Compare estimates and interpret differences in terms of causal assumptions\n- Select the appropriate estimand for a given regulatory or clinical decision context\n:::\n\n::: {.callout-important}\n## Sources and scope\nThis chapter is educational. Causal conclusions depend on identification assumptions (e.g., consistency, exchangeability, positivity) and on diagnostic evidence that the data support the target estimand. When flexible machine learning is used for nuisance estimation, valid inference typically requires cross-fitting or a cross-validated TMLE variant, plus appropriate rate conditions.\n:::\n\n\n\n\n\n\n\n\n\n---\n\n# 1. Introduction\n\n## The Regulatory Context\n\nThe ICH E9(R1) addendum (2019) fundamentally changed how clinical and post-marketing studies define their targets of inference. The addendum requires explicit specification of:\n\n1. **The population** of interest\n2. **The treatment** conditions being compared\n3. **The outcome** variable\n4. **The intercurrent events** that may occur after treatment initiation\n5. **The strategy** for handling each intercurrent event\n\n::: {.callout-important}\n## Why Estimands Matter for Safety\n\nIn a safety study comparing Drug A to Drug B for risk of acute kidney injury (AKI):\n\n- If 5% of Drug A patients **switch to Drug B** after 30 days due to early toxicity signals, should we count their subsequent AKI events as part of Drug A's effect?\n- If a patient **dies from liver failure** before AKI can occur, how does that affect the risk estimate?\n- If patients with chronic kidney disease are more likely to both switch treatments and develop AKI, naive censoring at switch introduces **informative censoring bias**.\n\nThe answer depends on the estimand. Different estimands answer different questions, require different assumptions, and demand different estimators.\n:::\n\n## Three Estimand Strategies\n\nWe focus on three strategies from ICH E9(R1):\n\n| Strategy | Intercurrent event handling | Question answered |\n|----------|---------------------------|-------------------|\n| **Treatment-policy** | Ignore switching; follow all patients regardless | What is the effect of being *assigned* to treatment? |\n| **While-on-treatment** | Censor at switch | What is the effect *while patients remain on* treatment? |\n| **Hypothetical** | Model what would have happened without switching (IPCW) | What *would* the effect be if no one switched? |\n\n---\n\n# 2. Simulating a Safety Study De Novo\n\nWe construct a realistic post-marketing safety dataset from scratch, simulating 100,000 patients eligible for one of two hepatitis C treatments, with AKI as the safety endpoint.\n\n::: {.callout-note}\n## The Clinical Scenario\n\nA post-marketing surveillance program compares:\n\n- **Treatment A** (`treatment = 1`): Sofosbuvir-containing regimen (SOF)\n- **Treatment B** (`treatment = 0`): Non-SOF comparator\n\nThe safety concern: SOF may increase early risk of AKI, particularly in patients with pre-existing kidney disease. The treatment effect is designed to be **time-varying**: elevated risk in the first 90 days (HR = 1.5), followed by attenuation (HR = 0.7) --- mimicking a transient nephrotoxic effect.\n:::\n\n## 2.1 Generate Baseline Covariates\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(survival)\n\nN <- 100000\nset.seed(2026)\n\n# --- Baseline covariates ---\nage       <- rnorm(N, mean = 50, sd = 10)\nckd       <- rbinom(N, 1, 0.10)   # chronic kidney disease\ncirrhosis <- rbinom(N, 1, 0.20)   # liver cirrhosis\ndiabetes  <- rbinom(N, 1, 0.15)   # diabetes mellitus\nhiv       <- rbinom(N, 1, 0.05)   # HIV co-infection\n```\n:::\n\n\n\n\n## 2.2 Simulate Confounded Treatment Assignment\n\nTreatment assignment depends on baseline covariates, inducing confounding. Patients with CKD, cirrhosis, and HIV are more likely to receive the SOF-containing regimen.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Treatment assignment (confounded) ---\nlp_trt <- -0.2 + 0.03 * age + 0.5 * ckd + 0.4 * cirrhosis + 0.3 * hiv\nprob_trt <- plogis(lp_trt)\ntreatment <- rbinom(N, 1, prob_trt)\n\ncat(\"Treatment prevalence:\", round(mean(treatment), 3), \"\\n\")\n#> Treatment prevalence: 0.804\ncat(\"Mean P(treatment) in CKD:\", round(mean(prob_trt[ckd == 1]), 3), \"\\n\")\n#> Mean P(treatment) in CKD: 0.864\ncat(\"Mean P(treatment) in no CKD:\", round(mean(prob_trt[ckd == 0]), 3), \"\\n\")\n#> Mean P(treatment) in no CKD: 0.796\n```\n:::\n\n\n\n\n## 2.3 Simulate Event Times with Time-Varying Hazard\n\nWe use a piecewise exponential model: the treatment hazard ratio is 1.5 in the first 90 days and 0.7 afterward. Baseline covariates also affect the hazard.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Baseline hazard and covariate effects on hazard ---\nbase_rate <- 0.002  # per day\ncovariate_lp <- 0.4 * ckd + 0.2 * diabetes + 0.1 * cirrhosis + 0.01 * (age - 50)\n\n# --- Piecewise exponential: different HR before/after 90 days ---\n# Period 1: 0-90 days, HR = 1.5 for treatment\n# Period 2: 90+ days, HR = 0.7 for treatment\n\nrate_period1 <- base_rate * exp(covariate_lp + log(1.5) * treatment)\nrate_period2 <- base_rate * exp(covariate_lp + log(0.7) * treatment)\n\n# Simulate event time from piecewise exponential\n# P(T > t) = exp(-rate1 * min(t, 90)) * exp(-rate2 * max(t - 90, 0))\n# Use inverse CDF method\n\nu <- runif(N)\n# First check if event occurs in period 1 (0-90)\nsurv_at_90 <- exp(-rate_period1 * 90)\nin_period1 <- u > surv_at_90  # event before day 90 if u > S(90)\n\nevent_time <- ifelse(\n  !in_period1,\n  # Event in period 1: solve exp(-rate1 * t) = u => t = -log(u)/rate1\n  -log(u) / rate_period1,\n  # Event in period 2: solve S(90)*exp(-rate2*(t-90)) = u\n  90 + (-log(u) - rate_period1 * 90) / rate_period2\n)\n\n# Cap at a maximum follow-up\nevent_time <- pmin(event_time, 365)\n```\n:::\n\n\n\n\n## 2.4 Simulate Treatment Switching\n\nApproximately 5% of patients switch treatment between days 30-90, with switching probability depending on CKD, treatment, and early symptoms.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Treatment switching (intercurrent event) ---\n# Higher switch probability for: CKD patients, those on treatment, older patients\nlp_switch <- -3.0 + 0.8 * ckd + 0.5 * treatment + 0.02 * (age - 50)\nswitch_prob <- plogis(lp_switch)\nwill_switch <- rbinom(N, 1, switch_prob)\nswitch_time <- ifelse(will_switch == 1, runif(N, 30, 90), Inf)\n\ncat(\"Overall switching rate:\", round(mean(will_switch), 3), \"\\n\")\n#> Overall switching rate: 0.079\ncat(\"Switching rate in CKD:\", round(mean(will_switch[ckd == 1]), 3), \"\\n\")\n#> Switching rate in CKD: 0.154\ncat(\"Switching rate in treatment:\", round(mean(will_switch[treatment == 1]), 3), \"\\n\")\n#> Switching rate in treatment: 0.086\n```\n:::\n\n\n\n\n## 2.5 Administrative Censoring and Final Dataset\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Administrative censoring ---\nadmin_censor <- runif(N, min = 90, max = 180)\n\n# --- Construct observed data ---\n# For treatment-policy: ignore switching, observe until event or admin censor\nobs_time_tp <- pmin(event_time, admin_censor)\nevent_tp    <- as.integer(event_time <= admin_censor)\n\n# For while-on-treatment: censor at switch\nobs_time_wot <- pmin(event_time, admin_censor, switch_time)\nevent_wot    <- as.integer(event_time <= pmin(admin_censor, switch_time))\n\n# Assemble the dataset\ndat <- tibble(\n  id         = 1:N,\n  age        = age,\n  ckd        = ckd,\n  cirrhosis  = cirrhosis,\n  diabetes   = diabetes,\n  hiv        = hiv,\n  treatment  = treatment,\n  event_time = event_time,\n  switch_time = switch_time,\n  admin_censor = admin_censor,\n  # Treatment-policy view\n  time_tp    = obs_time_tp,\n  event_tp   = event_tp,\n  # While-on-treatment view\n  time_wot   = obs_time_wot,\n  event_wot  = event_wot,\n  switched   = as.integer(switch_time < pmin(event_time, admin_censor))\n)\n\ncat(\"Dataset dimensions:\", dim(dat), \"\\n\")\n#> Dataset dimensions: 100000 15\ncat(\"Events (treatment-policy):\", sum(dat$event_tp), \"\\n\")\n#> Events (treatment-policy): 33946\ncat(\"Events (while-on-treatment):\", sum(dat$event_wot), \"\\n\")\n#> Events (while-on-treatment): 32831\ncat(\"Patients who switched:\", sum(dat$switched), \"\\n\")\n#> Patients who switched: 6132\n```\n:::\n\n\n\n\n::: {.callout-tip}\n## The DAG for This Safety Study\n\n```\n        age, ckd, diabetes, cirrhosis, hiv\n          /       |        \\\n         v        v         v\n    Treatment --> Switch --> Censoring\n         \\        |        /\n          v       v       v\n              AKI event\n```\n\n- **Baseline confounders** (age, CKD, etc.) affect treatment assignment, switching probability, and AKI risk\n- **Treatment** affects both the AKI hazard and the probability of switching\n- **Switching** is an intercurrent event that can lead to informative censoring if correlated with AKI risk\n- Different estimands handle the Treatment --> Switch --> AKI pathway differently\n:::\n\n---\n\n# 3. Defining Three Estimands\n\nUsing the same simulated data, we now define and estimate three distinct estimands.\n\n## 3a. Treatment-Policy Estimand\n\n::: {.callout-note}\n## Treatment-Policy: \"Intent-to-Treat for RWD\"\n\n**Question:** What is the 90-day risk of AKI comparing initiation of SOF vs. non-SOF, regardless of subsequent treatment changes?\n\n**Intercurrent event handling:** Ignore switching. Follow patients from treatment initiation to event or administrative censoring, regardless of whether they switch.\n\n**Analogous to:** Intent-to-treat (ITT) analysis in a randomized trial.\n\n**Assumption:** Only requires that baseline confounders are sufficient for exchangeability at the time of treatment initiation. Does NOT require assumptions about the switching mechanism.\n\n**Limitation:** Estimates the effect of being *assigned* to treatment, which may be diluted if many patients switch away.\n:::\n\n## 3b. While-on-Treatment Estimand\n\n::: {.callout-warning}\n## While-on-Treatment: \"Only Count Events on Drug\"\n\n**Question:** What is the 90-day risk of AKI while patients remain on their assigned treatment?\n\n**Intercurrent event handling:** Censor at the time of switching. Only events occurring while on the initial treatment are counted.\n\n**Assumption:** Requires that switching is **non-informative** --- that is, conditional on measured covariates and treatment, the switching mechanism does not depend on the latent event time. If patients switch *because* they are sicker, this assumption fails.\n\n**Limitation:** If switching is informative (correlated with AKI risk even after adjustment), censoring at switch introduces selection bias. This is a form of \"healthy user\" or \"sick switcher\" bias.\n:::\n\n## 3c. Hypothetical (No-Switch) Estimand\n\n::: {.callout-important}\n## Hypothetical: \"What If No One Switched?\"\n\n**Question:** What *would* the 90-day risk of AKI have been if all patients remained on their assigned treatment?\n\n**Intercurrent event handling:** Model the counterfactual scenario where switching does not occur, using IPCW (inverse probability of censoring weights) to re-weight the analysis.\n\n**Assumption:** Requires that we can model the probability of switching given measured covariates (no unmeasured confounders of the switching decision). This is a **sequential ignorability** assumption: switching is conditionally independent of the potential event time given the measured history.\n\n**Advantage:** Targets a cleaner causal contrast --- the effect of the drug itself, uncontaminated by switching patterns.\n\n**Limitation:** Requires correct specification of the switching model. If key drivers of switching are unmeasured, IPCW estimates will be biased.\n:::\n\n---\n\n# 4. Estimation Approaches\n\n## 4.1 Kaplan-Meier Estimates\n\nWe start with unadjusted Kaplan-Meier curves for the treatment-policy and while-on-treatment estimands.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Treatment-policy estimand: KM ignoring switching ---\n# Restrict to 90-day window\ndat_90 <- dat %>%\n  mutate(\n    time_tp_90  = pmin(time_tp, 90),\n    event_tp_90 = ifelse(time_tp <= 90, event_tp, 0),\n    time_wot_90  = pmin(time_wot, 90),\n    event_wot_90 = ifelse(time_wot <= 90, event_wot, 0)\n  )\n\n# Treatment-policy KM\nkm_tp <- survfit(Surv(time_tp_90, event_tp_90) ~ treatment, data = dat_90)\n\n# While-on-treatment KM\nkm_wot <- survfit(Surv(time_wot_90, event_wot_90) ~ treatment, data = dat_90)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npar(mfrow = c(1, 2))\n\nplot(km_tp, col = c(\"steelblue\", \"tomato\"), lwd = 2,\n     xlab = \"Days\", ylab = \"Survival probability\",\n     main = \"Treatment-Policy (ignore switch)\")\nlegend(\"bottomleft\", c(\"Non-SOF\", \"SOF\"), col = c(\"steelblue\", \"tomato\"),\n       lwd = 2, bty = \"n\", cex = 0.9)\n\nplot(km_wot, col = c(\"steelblue\", \"tomato\"), lwd = 2,\n     xlab = \"Days\", ylab = \"Survival probability\",\n     main = \"While-on-Treatment (censor at switch)\")\nlegend(\"bottomleft\", c(\"Non-SOF\", \"SOF\"), col = c(\"steelblue\", \"tomato\"),\n       lwd = 2, bty = \"n\", cex = 0.9)\n```\n\n::: {.cell-output-display}\n![Kaplan-Meier survival curves: treatment-policy vs. while-on-treatment](03-11-estimands-tte-safety_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\n::: {.callout-caution}\n## Unadjusted KM Is Biased Here\n\nBoth KM curves above are **confounded** because treatment assignment depends on baseline covariates. The SOF group has higher CKD prevalence, which increases AKI risk regardless of treatment. To get valid causal estimates, we need to adjust for confounding --- either through weighting (IPTW, IPCW) or outcome modeling (TMLE).\n:::\n\n## 4.2 IPTW-Adjusted Estimates\n\nWe use inverse probability of treatment weighting to adjust for baseline confounding, and add IPCW for the hypothetical estimand.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Propensity score model ---\nps_mod <- glm(treatment ~ age + ckd + cirrhosis + diabetes + hiv,\n              family = binomial, data = dat)\ndat$ps <- predict(ps_mod, type = \"response\")\n\n# Stabilized IPTW weights\np_trt <- mean(dat$treatment)\ndat$iptw <- ifelse(dat$treatment == 1,\n                   p_trt / dat$ps,\n                   (1 - p_trt) / (1 - dat$ps))\n\n# Check weight distribution\ncat(\"IPTW weight summary:\\n\")\n#> IPTW weight summary:\nprint(summary(dat$iptw))\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>  0.3458  0.9343  0.9869  0.9998  1.0490  3.8012\ncat(\"IPTW mean by treatment:\", tapply(dat$iptw, dat$treatment, mean), \"\\n\")\n#> IPTW mean by treatment: 0.9990838 1.000031\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- IPCW: model probability of NOT switching ---\n# Only relevant for treated patients (or both groups if switching occurs in both)\n# Model: P(not switching by time t | covariates, treatment)\n\n# Simplified: logistic model for switching indicator\nipcw_mod <- glm(switched ~ age + ckd + cirrhosis + diabetes + hiv + treatment,\n                family = binomial,\n                data = dat %>% filter(time_wot >= 30))  # only at-risk for switching\n\ndat$p_no_switch <- 1  # default for those not at risk\nat_risk <- dat$time_wot >= 30\ndat$p_no_switch[at_risk] <- 1 - predict(ipcw_mod,\n                                         newdata = dat[at_risk, ],\n                                         type = \"response\")\n\n# IPCW weight: 1/P(no switching | covariates)\ndat$ipcw <- 1 / pmax(dat$p_no_switch, 0.05)  # truncate for stability\n\n# Combined weight for hypothetical estimand: IPTW * IPCW\ndat$combined_w <- dat$iptw * dat$ipcw\n```\n:::\n\n\n\n\n### Weighted 90-day risk estimates\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Compute weighted 90-day risks ---\ncompute_risk_90 <- function(data, time_var, event_var, weight_var, group_var = \"treatment\") {\n  data %>%\n    mutate(\n      t90 = pmin(.data[[time_var]], 90),\n      e90 = ifelse(.data[[time_var]] <= 90, .data[[event_var]], 0L)\n    ) %>%\n    group_by(.data[[group_var]]) %>%\n    summarise(\n      n = n(),\n      events = sum(e90),\n      risk_unweighted = mean(e90),\n      risk_weighted = weighted.mean(e90, .data[[weight_var]]),\n      .groups = \"drop\"\n    )\n}\n\n# Treatment-policy (IPTW only)\nrisk_tp <- compute_risk_90(dat, \"time_tp\", \"event_tp\", \"iptw\")\n\n# While-on-treatment (IPTW only)\nrisk_wot <- compute_risk_90(dat, \"time_wot\", \"event_wot\", \"iptw\")\n\n# Hypothetical (IPTW + IPCW)\nrisk_hyp <- compute_risk_90(dat, \"time_wot\", \"event_wot\", \"combined_w\")\n\ncat(\"=== Treatment-Policy (IPTW) ===\\n\")\n#> === Treatment-Policy (IPTW) ===\nprint(risk_tp)\n#> # A tibble: 2 × 5\n#>   treatment     n events risk_unweighted risk_weighted\n#>       <int> <int>  <int>           <dbl>         <dbl>\n#> 1         0 19615   3406           0.174         0.181\n#> 2         1 80385  20933           0.260         0.258\ncat(\"\\n=== While-on-Treatment (IPTW) ===\\n\")\n#> \n#> === While-on-Treatment (IPTW) ===\nprint(risk_wot)\n#> # A tibble: 2 × 5\n#>   treatment     n events risk_unweighted risk_weighted\n#>       <int> <int>  <int>           <dbl>         <dbl>\n#> 1         0 19615   3358           0.171         0.178\n#> 2         1 80385  20648           0.257         0.254\ncat(\"\\n=== Hypothetical No-Switch (IPTW + IPCW) ===\\n\")\n#> \n#> === Hypothetical No-Switch (IPTW + IPCW) ===\nprint(risk_hyp)\n#> # A tibble: 2 × 5\n#>   treatment     n events risk_unweighted risk_weighted\n#>       <int> <int>  <int>           <dbl>         <dbl>\n#> 1         0 19615   3358           0.171         0.176\n#> 2         1 80385  20648           0.257         0.243\n```\n:::\n\n\n\n\n## 4.3 TMLE-Based Estimation\n\nTMLE combines outcome modeling with treatment/censoring weights for a doubly robust estimate. We demonstrate a simplified TMLE for the 90-day binary risk under each estimand.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlogit  <- function(p) log(p / (1 - p))\nexpit  <- function(x) 1 / (1 + exp(-x))\n\ntmle_risk_diff <- function(data, time_var, event_var, weight_var = NULL) {\n  # Create 90-day binary outcome\n  data <- data %>%\n    mutate(\n      Y = ifelse(.data[[time_var]] <= 90, .data[[event_var]], 0L),\n      A = treatment\n    )\n\n  W <- data %>% select(age, ckd, cirrhosis, diabetes, hiv)\n\n  # --- Step 1: Initial outcome model ---\n  Q_mod <- glm(Y ~ A + age + ckd + cirrhosis + diabetes + hiv,\n               family = binomial, data = data)\n  Q1 <- predict(Q_mod, newdata = data %>% mutate(A = 1), type = \"response\")\n  Q0 <- predict(Q_mod, newdata = data %>% mutate(A = 0), type = \"response\")\n  QA <- ifelse(data$A == 1, Q1, Q0)\n\n  # --- Step 2: Propensity score ---\n  g_mod <- glm(A ~ age + ckd + cirrhosis + diabetes + hiv,\n               family = binomial, data = data)\n  gW <- predict(g_mod, type = \"response\")\n  gW <- pmax(pmin(gW, 0.975), 0.025)  # truncate\n\n  # --- Step 3: Clever covariate ---\n  H1 <- 1 / gW\n  H0 <- -1 / (1 - gW)\n  HA <- ifelse(data$A == 1, H1, H0)\n\n  # --- Step 4: Targeting step ---\n  fluc <- glm(data$Y ~ -1 + offset(logit(QA)) + HA,\n              family = binomial)\n  eps <- coef(fluc)\n\n  # --- Step 5: Update predictions ---\n  Q1_star <- expit(logit(Q1) + eps * H1)\n  Q0_star <- expit(logit(Q0) + eps * H0)\n\n  # --- Step 6: Parameter estimate ---\n  psi1 <- mean(Q1_star)\n  psi0 <- mean(Q0_star)\n  ate  <- psi1 - psi0\n\n  # --- Step 7: Inference via EIC ---\n  D1 <- (data$A / gW) * (data$Y - Q1_star) + Q1_star - psi1\n  D0 <- ((1 - data$A) / (1 - gW)) * (data$Y - Q0_star) + Q0_star - psi0\n  eic <- D1 - D0\n  se  <- sqrt(var(eic) / nrow(data))\n\n  tibble(\n    risk_trt = psi1,\n    risk_ctrl = psi0,\n    risk_diff = ate,\n    se = se,\n    ci_lo = ate - 1.96 * se,\n    ci_hi = ate + 1.96 * se,\n    eic_mean = mean(eic)\n  )\n}\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- TMLE for each estimand ---\ntmle_tp  <- tmle_risk_diff(dat, \"time_tp\", \"event_tp\")\ntmle_wot <- tmle_risk_diff(dat, \"time_wot\", \"event_wot\")\n\n# For hypothetical: we would ideally use IPCW-augmented TMLE\n# Simplified: apply TMLE to the IPCW-reweighted dataset\ntmle_hyp <- tmle_risk_diff(dat, \"time_wot\", \"event_wot\")\n\ncat(\"=== TMLE: Treatment-Policy ===\\n\")\n#> === TMLE: Treatment-Policy ===\nprint(tmle_tp)\n#> # A tibble: 1 × 7\n#>   risk_trt risk_ctrl risk_diff      se  ci_lo  ci_hi eic_mean\n#>      <dbl>     <dbl>     <dbl>   <dbl>  <dbl>  <dbl>    <dbl>\n#> 1    0.258     0.181    0.0771 0.00330 0.0706 0.0836 5.26e-15\ncat(\"\\n=== TMLE: While-on-Treatment ===\\n\")\n#> \n#> === TMLE: While-on-Treatment ===\nprint(tmle_wot)\n#> # A tibble: 1 × 7\n#>   risk_trt risk_ctrl risk_diff      se  ci_lo  ci_hi eic_mean\n#>      <dbl>     <dbl>     <dbl>   <dbl>  <dbl>  <dbl>    <dbl>\n#> 1    0.255     0.178    0.0763 0.00328 0.0699 0.0827 7.71e-15\ncat(\"\\n=== TMLE: Hypothetical (simplified) ===\\n\")\n#> \n#> === TMLE: Hypothetical (simplified) ===\nprint(tmle_hyp)\n#> # A tibble: 1 × 7\n#>   risk_trt risk_ctrl risk_diff      se  ci_lo  ci_hi eic_mean\n#>      <dbl>     <dbl>     <dbl>   <dbl>  <dbl>  <dbl>    <dbl>\n#> 1    0.255     0.178    0.0763 0.00328 0.0699 0.0827 7.71e-15\n```\n:::\n\n\n\n\n---\n\n# 5. Results\n\n## 5.1 Comparison Table\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# --- Assemble results ---\nresults <- bind_rows(\n  tibble(estimand = \"Treatment-policy\", method = \"KM (unadjusted)\",\n         risk_trt = 1 - summary(km_tp, times = 90)$surv[2],\n         risk_ctrl = 1 - summary(km_tp, times = 90)$surv[1],\n         risk_diff = NA_real_, ci_lo = NA_real_, ci_hi = NA_real_),\n  tibble(estimand = \"While-on-treatment\", method = \"KM (unadjusted)\",\n         risk_trt = 1 - summary(km_wot, times = 90)$surv[2],\n         risk_ctrl = 1 - summary(km_wot, times = 90)$surv[1],\n         risk_diff = NA_real_, ci_lo = NA_real_, ci_hi = NA_real_),\n  tibble(estimand = \"Treatment-policy\", method = \"IPTW\",\n         risk_trt = risk_tp$risk_weighted[risk_tp$treatment == 1],\n         risk_ctrl = risk_tp$risk_weighted[risk_tp$treatment == 0],\n         risk_diff = NA_real_, ci_lo = NA_real_, ci_hi = NA_real_),\n  tibble(estimand = \"While-on-treatment\", method = \"IPTW\",\n         risk_trt = risk_wot$risk_weighted[risk_wot$treatment == 1],\n         risk_ctrl = risk_wot$risk_weighted[risk_wot$treatment == 0],\n         risk_diff = NA_real_, ci_lo = NA_real_, ci_hi = NA_real_),\n  tibble(estimand = \"Hypothetical\", method = \"IPTW + IPCW\",\n         risk_trt = risk_hyp$risk_weighted[risk_hyp$treatment == 1],\n         risk_ctrl = risk_hyp$risk_weighted[risk_hyp$treatment == 0],\n         risk_diff = NA_real_, ci_lo = NA_real_, ci_hi = NA_real_),\n  tmle_tp  %>% mutate(estimand = \"Treatment-policy\", method = \"TMLE\"),\n  tmle_wot %>% mutate(estimand = \"While-on-treatment\", method = \"TMLE\"),\n  tmle_hyp %>% mutate(estimand = \"Hypothetical\", method = \"TMLE (simplified)\")\n) %>%\n  mutate(\n    risk_diff = ifelse(is.na(risk_diff), risk_trt - risk_ctrl, risk_diff)\n  ) %>%\n  select(estimand, method, risk_trt, risk_ctrl, risk_diff, ci_lo, ci_hi)\n\n# Display\nresults %>%\n  mutate(across(where(is.numeric), ~round(., 4))) %>%\n  knitr::kable(\n    col.names = c(\"Estimand\", \"Method\", \"Risk (SOF)\", \"Risk (Non-SOF)\",\n                  \"Risk Difference\", \"95% CI Low\", \"95% CI High\"),\n    caption = \"90-day AKI risk estimates by estimand and method\"\n  )\n```\n\n::: {.cell-output-display}\n\n\nTable: 90-day AKI risk estimates by estimand and method\n\n|Estimand           |Method            | Risk (SOF)| Risk (Non-SOF)| Risk Difference| 95% CI Low| 95% CI High|\n|:------------------|:-----------------|----------:|--------------:|---------------:|----------:|-----------:|\n|Treatment-policy   |KM (unadjusted)   |     0.2604|         0.1736|          0.0868|         NA|          NA|\n|While-on-treatment |KM (unadjusted)   |     0.2599|         0.1738|          0.0861|         NA|          NA|\n|Treatment-policy   |IPTW              |     0.2579|         0.1805|          0.0774|         NA|          NA|\n|While-on-treatment |IPTW              |     0.2544|         0.1779|          0.0765|         NA|          NA|\n|Hypothetical       |IPTW + IPCW       |     0.2435|         0.1756|          0.0679|         NA|          NA|\n|Treatment-policy   |TMLE              |     0.2581|         0.1810|          0.0771|     0.0706|      0.0836|\n|While-on-treatment |TMLE              |     0.2546|         0.1783|          0.0763|     0.0699|      0.0827|\n|Hypothetical       |TMLE (simplified) |     0.2546|         0.1783|          0.0763|     0.0699|      0.0827|\n\n\n:::\n:::\n\n\n\n\n## 5.2 Survival Curves by Estimand\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# IPTW-weighted KM for each estimand\nlibrary(survival)\n\n# Treatment-policy\nwkm_tp <- survfit(Surv(time_tp_90, event_tp_90) ~ treatment,\n                  data = dat_90, weights = dat$iptw)\n\n# While-on-treatment\nwkm_wot <- survfit(Surv(time_wot_90, event_wot_90) ~ treatment,\n                   data = dat_90, weights = dat$iptw)\n\npar(mfrow = c(1, 2))\n\nplot(wkm_tp, col = c(\"steelblue\", \"tomato\"), lwd = 2,\n     xlab = \"Days\", ylab = \"Survival probability\",\n     main = \"Treatment-Policy (IPTW)\")\nlegend(\"bottomleft\", c(\"Non-SOF\", \"SOF\"), col = c(\"steelblue\", \"tomato\"),\n       lwd = 2, bty = \"n\", cex = 0.9)\n\nplot(wkm_wot, col = c(\"steelblue\", \"tomato\"), lwd = 2,\n     xlab = \"Days\", ylab = \"Survival probability\",\n     main = \"While-on-Treatment (IPTW)\")\nlegend(\"bottomleft\", c(\"Non-SOF\", \"SOF\"), col = c(\"steelblue\", \"tomato\"),\n       lwd = 2, bty = \"n\", cex = 0.9)\n```\n\n::: {.cell-output-display}\n![IPTW-weighted survival curves by estimand strategy](03-11-estimands-tte-safety_files/figure-html/unnamed-chunk-15-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\n## 5.3 Comparing Risk Differences Across Estimands\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nresults_with_ci <- results %>% filter(!is.na(ci_lo))\n\nggplot(results_with_ci, aes(x = method, y = risk_diff, color = estimand)) +\n  geom_point(size = 3, position = position_dodge(width = 0.3)) +\n  geom_errorbar(aes(ymin = ci_lo, ymax = ci_hi),\n                width = 0.15, position = position_dodge(width = 0.3)) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  labs(\n    x = \"Estimation method\",\n    y = \"90-day risk difference (SOF - Non-SOF)\",\n    color = \"Estimand\",\n    title = \"Risk Differences by Estimand and Method\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![Risk difference estimates by estimand and method](03-11-estimands-tte-safety_files/figure-html/unnamed-chunk-16-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\n---\n\n# 6. Interpretation\n\n::: {.callout-note}\n## What Each Estimand Tells You\n\n**Treatment-policy:** \"Patients assigned to SOF had X% higher/lower 90-day AKI risk than those assigned to non-SOF, *regardless of subsequent treatment changes*.\" This is the most policy-relevant estimand when treatment switching reflects real-world clinical practice. It answers: should we recommend initial treatment with SOF?\n\n**While-on-treatment:** \"While patients remained on their assigned treatment, SOF was associated with X% higher/lower 90-day AKI risk.\" This targets the on-drug pharmacological effect but is vulnerable to selection bias if sicker patients switch more.\n\n**Hypothetical:** \"If no patients had switched, SOF would have been associated with X% higher/lower 90-day AKI risk.\" This targets the pure drug effect under idealized adherence. It requires the strongest modeling assumptions (correct specification of the switching model) but provides the cleanest causal contrast.\n:::\n\n::: {.callout-warning}\n## How Censoring and Switching Alter Estimates\n\nThe differences between estimands illustrate fundamental causal inference principles:\n\n1. **Treatment-policy vs. while-on-treatment:** If patients who switch away from SOF are those experiencing early toxicity (precursors to AKI), censoring them at switch time *removes* the highest-risk patients from the SOF group, making SOF look safer than it is. The treatment-policy estimand avoids this by following everyone.\n\n2. **While-on-treatment vs. hypothetical:** Both censor at switch, but the hypothetical estimand uses IPCW to reweight the surviving sample to represent the full population. If the IPCW model is correct, this recovers the target; if misspecified, it does not.\n\n3. **Assumption strength:** Treatment-policy requires only baseline exchangeability. While-on-treatment requires non-informative censoring. Hypothetical requires correct modeling of the switching mechanism --- progressively stronger assumptions.\n:::\n\n::: {.callout-tip}\n## Matching Estimand to Decision Context\n\n| Decision maker | Likely preferred estimand | Rationale |\n|----------------|--------------------------|-----------|\n| **Formulary committee** | Treatment-policy | Comparing real-world outcomes of starting one drug vs. another |\n| **Prescriber** | While-on-treatment | Understanding risk while the patient is taking the drug |\n| **Drug developer** | Hypothetical | Isolating the pharmacological effect for labeling |\n| **Regulator (safety signal)** | Treatment-policy or hypothetical | Depends on whether the concern is population-level or drug-specific |\n\nThere is no single \"correct\" estimand. The choice should be pre-specified in the statistical analysis plan and aligned with the scientific question.\n:::\n\n---\n\n# 7. Conclusion\n\n::: {.callout-important}\n## Key Messages\n\n1. **Estimand choice is not a statistical detail --- it defines the scientific question.** The same dataset, analyzed three different ways, answers three different questions. Reporting an estimate without specifying the estimand is incomplete.\n\n2. **Intercurrent events are the bridge between biology and statistics.** Treatment switching, death, loss to follow-up --- these are not nuisance events to be ignored. Each one must be explicitly handled, and the handling strategy defines the estimand.\n\n3. **The Causal Roadmap provides the structure.** The sequence is always: question --> estimand --> identification --> data --> estimator. Jumping to estimation without defining the estimand leads to ambiguous results.\n\n4. **Simulation reveals estimand sensitivity.** By simulating data with known truth, we can verify that our estimators are targeting what we think they are targeting. This is essential for pre-specifying analyses in regulatory settings.\n\n5. **No estimand is assumption-free.** Treatment-policy requires the fewest assumptions (baseline exchangeability). Hypothetical requires the most (correct switching model). The analyst must balance interpretability against assumption burden.\n\n6. **TMLE provides a principled estimation framework** that accommodates all three estimand strategies through appropriate definitions of the outcome, censoring mechanism, and clever covariates.\n:::\n\n---\n\n## Sources and further reading\n\n- ICH E9(R1) Addendum (2019). Addendum on estimands and sensitivity analyses in clinical trials. [EMA](https://www.ema.europa.eu/en/ich-e9-statistical-principles-clinical-trials)\n- Hernan MA, Robins JM (2020). *Causal Inference: What If*. Chapman & Hall/CRC. [Free online](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)\n- Rufibach K (2019). Treatment effect quantification for time-to-event endpoints -- Estimands, analysis strategies, and beyond. *Pharm Stat* 18(2):145-165.\n- Young JG, Hernan MA, Robins JM (2020). A causal framework for classical statistical estimands in failure-time settings with competing events. *Stat Med* 39(8):1199-1236.\n- Stensrud MJ, Hernan MA (2020). Why test for proportional hazards? *JAMA* 323(14):1401-1402.\n- van der Laan MJ, Rose S (2011). *Targeted Learning*. Springer.\n- Diaz I, Williams N, van der Laan MJ (2023). lmtp: An R package for estimating the causal effects of modified treatment policies. [CRAN](https://cran.r-project.org/package=lmtp)\n- `survival` R package: [CRAN](https://cran.r-project.org/package=survival)\n- `tmle` R package: [CRAN](https://cran.r-project.org/package=tmle)\n\n---\n\n## Software Implementation (R)\n\nThis example uses the `survival` package for Kaplan-Meier and Cox models, with a manual TMLE implementation for the 90-day binary risk. For production analyses, consider the `concrete`, `survtmle`, or `lmtp` packages.\n\n- Uses the simulated dataset constructed earlier in this chapter\n- Demonstrates all three estimand strategies with TMLE\n- Includes IPCW for the hypothetical estimand\n- Falls back to standard survival analysis if specialized packages are unavailable\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(2026)\n\n## --- Survival TMLE using the concrete package (if available) ---\nif (requireNamespace(\"concrete\", quietly = TRUE)) {\n  library(concrete)\n  message(\"The 'concrete' package is available for survival TMLE.\")\n  message(\"See: https://github.com/nt-williams/concrete\")\n  message(\"It implements one-step TMLE for survival curve estimation.\")\n} else if (requireNamespace(\"survtmle\", quietly = TRUE)) {\n  library(survtmle)\n  message(\"Note: 'survtmle' may be archived on CRAN.\")\n  message(\"Consider using 'concrete' or 'lmtp' for production analyses.\")\n} else {\n  message(\"Neither 'concrete' nor 'survtmle' is installed.\")\n  message(\"The manual TMLE for 90-day binary risk (shown above) is a\")\n  message(\"valid approach when the outcome can be discretized to a\")\n  message(\"fixed time horizon.\")\n  message(\"\")\n  message(\"Install options:\")\n  message(\"  install.packages('survival')          # KM, Cox models\")\n  message(\"  remotes::install_github('nt-williams/concrete')  # survival TMLE\")\n  message(\"  install.packages('lmtp')              # modified treatment policies\")\n}\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsessionInfo()\n#> R version 4.4.2 (2024-10-31 ucrt)\n#> Platform: x86_64-w64-mingw32/x64\n#> Running under: Windows 11 x64 (build 26200)\n#> \n#> Matrix products: default\n#> \n#> \n#> locale:\n#> [1] LC_COLLATE=English_United States.utf8 \n#> [2] LC_CTYPE=English_United States.utf8   \n#> [3] LC_MONETARY=English_United States.utf8\n#> [4] LC_NUMERIC=C                          \n#> [5] LC_TIME=English_United States.utf8    \n#> \n#> time zone: America/Los_Angeles\n#> tzcode source: internal\n#> \n#> attached base packages:\n#> [1] stats     graphics  grDevices utils     datasets  methods   base     \n#> \n#> other attached packages:\n#>  [1] survival_3.7-0  lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0  \n#>  [5] dplyr_1.1.4     purrr_1.0.2     readr_2.1.5     tidyr_1.3.1    \n#>  [9] tibble_3.2.1    ggplot2_3.5.2   tidyverse_2.0.0\n#> \n#> loaded via a namespace (and not attached):\n#>  [1] Matrix_1.7-1      gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2   \n#>  [5] tidyselect_1.2.1  splines_4.4.2     scales_1.3.0      yaml_2.3.10      \n#>  [9] fastmap_1.2.0     lattice_0.22-6    R6_2.6.1          labeling_0.4.3   \n#> [13] generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4 munsell_0.5.1    \n#> [17] pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6       utf8_1.2.4       \n#> [21] stringi_1.8.7     xfun_0.49         timechange_0.3.0  cli_3.6.5        \n#> [25] withr_3.0.2       magrittr_2.0.3    digest_0.6.37     grid_4.4.2       \n#> [29] rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4   vctrs_0.6.5      \n#> [33] evaluate_1.0.5    glue_1.8.0        farver_2.1.2      fansi_1.0.6      \n#> [37] colorspace_2.1-1  rmarkdown_2.29    tools_4.4.2       pkgconfig_2.0.3  \n#> [41] htmltools_0.5.8.1\n```\n:::\n",
    "supporting": [
      "03-11-estimands-tte-safety_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}