{
  "hash": "c9771b79a49ff3564eb0289379d649b7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects\"\nformat: html\n---\n\n\n\n\n\n# Chapter 3.4  \n\n## Effect Modification and Heterogeneous Treatment Effects\n*Identifying who benefits most (or least) from treatment*\n\nCausal inference is not only about estimating *average* treatment effects.  \nIn many scientific and regulatory settings, we want to know:\n\n> **Does the treatment work differently for different types of patients?**\n\nThis phenomenon is known as **effect modification** or **treatment-effect heterogeneity (HTE)**.\n\nIn this chapter, you’ll learn:\n\n1. Conceptual foundations of effect modification  \n2. How to define subgroup-specific causal estimands  \n3. TMLE-based approaches to effect heterogeneity  \n4. Machine-learning approaches, focusing on the **causal forest**  \n5. How to interpret heterogeneous effects responsibly  \n6. Diagnostics, uncertainty, and false discovery concerns  \n\nThis chapter builds on the causal roadmap and estimation methods from earlier modules.\n\n---\n\n## 1. Why Study Effect Modification?\n\n:::{.callout-important}\n## Why This Matters for Public Health Practice\n\nThe **average treatment effect (ATE)** answers:\n> “What is the mean effect of treatment in the population?”\n\nBut patients differ:\n\n- age, sex\n- comorbidities\n- biomarkers\n- baseline risk\n- genetic variation\n\nClinically and scientifically relevant questions include:\n\n- *Does our osteoporosis drug reduce fracture risk more in high-risk patients?*\n- *Are cardiovascular risks higher in patients with chronic kidney disease?*\n- *Does benefit differ by baseline frailty or prior CVD?*\n\nEffect modification helps answer these individualized or stratified questions. As an epidemiologist, understanding **who benefits most** from an intervention -- and who may even be harmed -- is essential for translating population-level evidence into clinical and policy recommendations.\n:::\n\n---\n\n## 2. Causal Estimands for Effect Modification\n\nTo study heterogeneity, we define **conditional average treatment effects (CATE)**.\n\n:::{.callout-note}\n## What Is a CATE? (Plain-Language Version)\n\nThe **Conditional Average Treatment Effect (CATE)** answers a simple question: *\"What is the average treatment effect for people who share a specific characteristic?\"*\n\nFor example, the CATE among women tells you the average effect of the treatment *specifically among women*. The CATE at age 80 tells you the expected effect *for an 80-year-old*.\n\nFormally, let \\(X\\) be a baseline covariate or set of covariates. The CATE is:\n\n\\[\nCATE(x) = E[Y(1) - Y(0) \\mid X = x].\n\\]\n\nFor categorical variables (e.g., age group):\n\n\\[\nATE_{\text{age<75}} = E[Y(1) - Y(0) \\mid \text{age} < 75],\n\\]\n\nand similarly for other strata.\n\nThink of it this way: the ATE gives you one number for *everyone*. The CATE gives you a *different number for each subgroup*, letting you see where the treatment works best (or worst).\n:::\n\nYour choice of estimand must match the scientific question:\n\n- **Prespecified subgroups** (sex, race, CKD stage)\n- **Post hoc continuous moderators** (eGFR, age)\n- **Machine-learned subgroups** (via trees / forests)\n\n---\n\n## 3. Identification Assumptions\n\n:::{.callout-warning}\n## Assumptions Still Apply -- And Get Harder in Subgroups\n\nEffect modification estimands inherit the same assumptions as the main causal effect:\n\n- **Exchangeability:**\n  \\(\n  Y(a) \\perp A \\mid W\n  \\)\n- **Positivity:**\n  Each subgroup must contain both treated and untreated\n- **Consistency**\n\nAdditionally:\n\n- Moderator variables must be **measured before treatment**\n- You should avoid conditioning on **post-treatment variables** when defining subgroups\n\n**Positivity is especially fragile in subgroup analyses.** When you slice the data into smaller groups, some subgroups may have very few treated or untreated individuals. Always check that both treatment arms are adequately represented in every subgroup you analyze.\n:::\n\n---\n\n## 4. A Workflow for Effect Modification\n\n:::{.callout-tip}\n## Step-by-Step Workflow for Investigating Effect Modification\n\n1. **Define causal estimands** (subgroup-specific ATE, CATE(x))\n2. **Choose moderators**\n   - Prespecified vs exploratory\n3. **Estimate nuisance functions** with SuperLearner\n4. **Estimate heterogeneous effects** using:\n   - TMLE (subgroup-specific or CATE-targeted)\n   - Causal forests\n5. **Quantify uncertainty**\n6. **Document all steps and prespecifications**\n\nThe key discipline here is to **decide your subgroups and moderators before looking at results**. Prespecification protects you from the temptation to cherry-pick findings. When you do explore post hoc, label those findings clearly as hypothesis-generating.\n:::\n\nWe now walk through TMLE and causal forest approaches.\n\n---\n\n## 5. TMLE for Subgroup-Specific Effects\n\n:::{.callout-note}\n## TMLE for Subgroup Effects: The Confirmatory Approach\n\nFor **prespecified subgroups**, TMLE can estimate:\n\n\\[\nATE_g = E[Y(1) - Y(0) \\mid X_g = 1],\n\\]\n\nwhere \\(X_g\\) indicates membership in subgroup \\(g\\).\n\nThe idea is straightforward: subset your data to a subgroup and run TMLE within that subset. Because TMLE is doubly robust and uses SuperLearner for flexible nuisance estimation, you get reliable effect estimates even within subgroups -- as long as you have enough data and positivity holds.\n:::\n\nExample: ATE among patients younger than 75.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tmle)\nlibrary(SuperLearner)\nlibrary(tidyverse)\n\n# Assume dat has columns: Y (outcome), A (treatment), age, cvd, eGFR, etc.\nset.seed(123)\n\ndat <- tibble(\n  Y = rbinom(2000, 1, 0.2),\n  A = rbinom(2000, 1, 0.5),\n  age = rnorm(2000, 75, 6),\n  cvd = rbinom(2000, 1, 0.4),\n  eGFR = rnorm(2000, 60, 15)\n)\n\ndat <- dat %>%\n  mutate(age_under75 = if_else(age < 75, 1, 0))\n\nsl_lib <- c(\"SL.glm\", \"SL.ranger\", \"SL.mean\")\n\ntmle_sub <- tmle(\n  Y = dat$Y[dat$age_under75 == 1],\n  A = dat$A[dat$age_under75 == 1],\n  W = dat %>%\n    filter(age_under75 == 1) %>%\n    select(cvd, eGFR),\n  family = \"binomial\",\n  Q.SL.library = sl_lib,\n  g.SL.library = sl_lib\n)\n\ntmle_sub$estimates$ATE\n```\n:::\n\n\n\n\nInterpretation:\n\n> Among patients younger than 75, the TMLE-estimated risk difference is …\n\nThis approach:\n\n- Gives valid subgroup-specific estimates  \n- Leverages SuperLearner for nuisance models  \n\nLimitations:\n\n- Does not provide a *continuous* CATE curve  \n- Requires prespecified groups and adequate sample size in each  \n\n---\n\n## 6. TMLE Extensions for Continuous Effect Modification\n\nFor continuous effect modifiers, you may want:\n\n\\[\nCATE(x) = E[Y(1) - Y(0) \\mid X = x]\n\\]\n\nfor all x (e.g., all ages). TMLE-based approaches often use:\n\n- Projection of the CATE onto basis functions of X (splines, polynomials)\n- Estimation of projection coefficients via TMLE\n- Reconstruction of \\( CATE(x) \\) from the projected function\n\n:::{.callout-tip}\n## CATE-TMLE: A Smooth, Doubly Robust Curve\n\nA typical CATE-TMLE algorithm:\n\n1. Expand \\(X\\) into basis functions \\(h_1(X),\\dots,h_K(X)\\)\n2. Define target parameters of the form\n   \\(\\Psi_k = E[(Y(1) - Y(0)) h_k(X)]\\)\n3. Use TMLE to estimate each \\(\\Psi_k\\)\n4. Construct \\( \\hat{CATE}(x) = \\sum_k \\hat\\Psi_k h_k(x)\\)\n\nWe won’t fully implement this here (it is mathematically intensive), but you should be aware that:\n\n- TMLE can provide **smooth, doubly robust CATE estimators**\n- TMLE-based variable importance methods can also quantify **how much** a covariate modifies the treatment effect\n\nThis gives you the best of both worlds: a continuous picture of how the treatment effect changes across a modifier, with the statistical guarantees that come from TMLE’s doubly robust framework.\n:::  \n\n---\n\n## 7. Modern ML Approach: Causal Forests\n\n:::{.callout-note}\n## Causal Forests in Plain Language\n\n**Causal forests** are tree-based methods specifically designed to estimate CATEs. Think of them as “smart subgroup finders”: instead of you deciding which subgroups to examine, the algorithm searches across all your covariates to find the splits that reveal the biggest differences in treatment effect.\n\nThey extend random forests by:\n\n- Splitting trees to maximize *treatment-effect heterogeneity*\n- Using “honest” sample splitting (training vs estimation sets)\n- Averaging across many trees to obtain smooth CATE estimates\n\n### 7.1 Why Causal Forests?\n\n- Automatically detect complex, nonlinear interactions\n- Provide **individual-level CATE estimates** \\( \\hat\\tau(x) \\)\n- Offer approximate pointwise confidence intervals\n- Useful for exploratory HTE analysis\n:::\n\n:::{.callout-caution}\n## Important Caveats About Causal Forests\n\n- **Not doubly robust.** Unlike TMLE, causal forests do not offer the same protection against model misspecification. If your propensity score model or outcome model is wrong, the CATE estimates may be biased.\n- **Interpretation is essentially associational** unless we embed the forest in a rigorous causal framework with the same identification assumptions (exchangeability, positivity, consistency).\n- **Overfitting to noise.** With many covariates and flexible splits, causal forests can find “heterogeneity” that is really just random variation -- especially in small samples.\n\nTreat causal forest results as **hypothesis-generating**, not confirmatory. If the forest suggests a subgroup with large benefit, that finding should be validated in an independent dataset or prespecified in a future study.\n:::\n\n---\n\n## 8. Implementing Causal Forests in R\n\nWe use the `grf` package.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages(\"grf\")\nlibrary(grf)\n\nset.seed(2028)\n\n# Simulate data with treatment effect heterogeneity\nn <- 3000\nX <- tibble(\n  age = rnorm(n, 75, 6),\n  cvd = rbinom(n, 1, 0.4),\n  risk_score = rnorm(n, 0, 1)\n)\n\nA <- rbinom(n, 1, plogis(-0.5 + 0.2 * X$age - 0.8 * X$risk_score))\n# Treatment effect depends on risk_score\ntau_true <- -0.05 + 0.1 * (X$risk_score > 0)\nY <- rbinom(n, 1, plogis(-2 + tau_true * A + 0.05 * (X$age - 75) + 0.5 * X$cvd))\n\nX_mat <- as.matrix(X)\n\ncf <- causal_forest(\n  X = X_mat,\n  Y = Y,\n  W = A\n)\n\n# Individualized CATE estimates\ntau_hat <- predict(cf)$predictions\n\nsummary(tau_hat)\n```\n:::\n\n\n\n\n### Visualizing CATE vs. risk score\n\n**To do** debug\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(X$risk_score, tau_hat,\n     xlab = \"Baseline risk score\",\n     ylab = \"Estimated CATE\",\n     pch = 16, cex = 0.3)\nabline(h = 0, col = \"red\")\n```\n:::\n\n\n\n\nYou should see different CATE patterns for low vs high risk scores.\n\n---\n\n## 9. Subgrouping Using CATE Estimates\n\nWe can create subgroups such as:\n\n- “High predicted benefit” vs “low predicted benefit”\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nthreshold <- median(tau_hat)\n\nres <- X %>%\n  mutate(\n    CATE_hat = tau_hat,\n    group = if_else(CATE_hat > threshold, \"high benefit\", \"low benefit\")\n  )\n\ntable(res$group)\n\nres %>%\n  group_by(group) %>%\n  summarize(\n    mean_CATE = mean(CATE_hat),\n    .groups = \"drop\"\n  )\n```\n:::\n\n\n\n\nThis is **exploratory**, not confirmatory.  \nIt can inform:\n\n- Hypothesis generation  \n- Prespecified subgroup definitions in future trials  \n\n---\n\n## 10. Causal Forest vs. TMLE: Which Should You Use?\n\n:::{.callout-important}\n## Choosing the Right Tool for the Job\n\n**TMLE (with SuperLearner):**\n\n- Best for **prespecified** subgroups\n- CATE-TMLE gives **doubly robust**, efficient CATE estimates\n- Integrates neatly into a causal estimand framework\n- More transparent and parameter-focused\n\n**Causal Forest:**\n\n- Best for **exploratory** heterogeneity\n- Automatically discovers complex interactions\n- Provides smooth CATE functions without specifying bases\n- Good for risk-stratified or personalized-medicine questions\n\n### Practical pattern:\n\n1. Use **TMLE** to estimate ATE and pre-planned subgroup effects\n2. Use **causal forests** to explore residual heterogeneity and generate new hypotheses\n3. Where consistent patterns are observed, design new confirmatory analyses or studies\n\n**Bottom line:** Use TMLE when you know *which* subgroups to test. Use causal forests when you want the data to *show* you where heterogeneity might exist. In practice, the strongest analyses do both.\n:::\n\n---\n\n## 11. Interpretation and Reporting: Avoiding Pitfalls\n\n:::{.callout-warning}\n## The Multiple Comparisons Trap\n\nEffect modification is tempting but dangerous:\n\n- Multiple subgroup comparisons inflate type I error\n- “Fishing expeditions” can produce spurious heterogeneity\n- Small subgroup sizes lead to unstable estimates\n\n**Consider this:** if you test 20 subgroups at alpha = 0.05, you expect one “significant” finding by chance alone -- even if there is zero true heterogeneity. This is not a theoretical concern; it is one of the most common sources of irreproducible findings in epidemiology.\n\nBest practices:\n\n1. **Prespecify main effect modifiers** when possible\n2. **Correct for multiplicity** (e.g., family-wise error or FDR) if reporting many subgroups\n3. Emphasize **uncertainty** (wide CIs are expected)\n4. Treat causal forest findings as **exploratory** unless prespecified or replicated\n5. Always present the **overall ATE** alongside any heterogeneity results\n:::  \n\n---\n\n## 12. Example: Combining TMLE and Causal Forests\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 1: ATE with TMLE\nsl_lib <- c(\"SL.glm\", \"SL.ranger\", \"SL.mean\")\n\ntmle_ate <- tmle(\n  Y = Y,\n  A = A,\n  W = X,\n  family = \"binomial\",\n  Q.SL.library = sl_lib,\n  g.SL.library = sl_lib\n)\n\ntmle_ate$estimates$ATE\n\n# Step 2: CATEs with causal forest (already computed as tau_hat)\nsummary(tau_hat)\n```\n:::\n\n\n\n\n- TMLE gives a **population-level effect** (with solid identifiability and efficiency).\n- Causal forest gives **individual-level estimated CATEs** to explore how effects vary.\n\n---\n\n## 13. Summary\n\n:::{.callout-tip}\n## Key Takeaways\n\nIn this chapter, you learned:\n\n- How to define causal estimands for effect modification and CATEs\n- How to estimate subgroup-specific effects via TMLE\n- How TMLE can be extended to continuous moderators using projection / variable importance frameworks\n- How causal forests provide flexible, ML-driven CATE estimates\n- How to interpret heterogeneous effects carefully in real-world and regulatory contexts\n\nEffect modification analysis is powerful but fragile. Combining **TMLE** for confirmatory, parameter-focused inference and **causal forests** for exploratory, data-adaptive heterogeneity learning often yields the most insightful and responsible use of HTE methods.\n\n**Remember:** always report the overall ATE first, prespecify your subgroups, correct for multiple comparisons, and label exploratory findings honestly. Your readers -- and your future self -- will thank you.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.4.2 (2024-10-31 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 26200)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: America/Los_Angeles\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nloaded via a namespace (and not attached):\n [1] htmlwidgets_1.6.4 compiler_4.4.2    fastmap_1.2.0     cli_3.6.5        \n [5] tools_4.4.2       htmltools_0.5.8.1 rstudioapi_0.17.1 yaml_2.3.10      \n [9] rmarkdown_2.29    knitr_1.49        jsonlite_2.0.0    xfun_0.49        \n[13] digest_0.6.37     rlang_1.1.6       evaluate_1.0.5   \n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}