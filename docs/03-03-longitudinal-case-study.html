<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A practical guide to the Causal Roadmap, Targeted Maximum Likelihood Estimation (TMLE), and Super Learner for modern causal inference in epidemiology, with emphasis on pharmacoepidemiology and clinical trial analysis.">

<title>11&nbsp; Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis – Causal Learning Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-04-effect-modification.html" rel="next">
<link href="./superlearner.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b343bb23504f009ddf7b24643a6af19a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Causal Learning Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/amertens/causal-learning-handbook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Causal Learning Handbook</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-01-regression-vs-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 1.1: Limitations of Standard Regression Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-02-causal-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 1.2: The Causal Roadmap</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-03-identification-estimands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1.3: From Causal Questions to Analysis — Identification, Estimands, and Statistical Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Roadmap for Real-world Evidence Generation: A Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Estimation Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-01-gcomputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-02-iptw.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-03-doubly-robust-tmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-04-tmle-teaching-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superlearner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-03-longitudinal-case-study.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-04-effect-modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-05-advanced-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-07-longitudinal-td-confounding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-08-tmle-clean-room.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-09-illustrated-ltmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-10-tmle-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anotated_bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Annotated Bibliography: Modern Causal Inference and Targeted Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#chapter-3.3" id="toc-chapter-3.3" class="nav-link active" data-scroll-target="#chapter-3.3"><span class="header-section-number">12</span> Chapter 3.3</a>
  <ul class="collapse">
  <li><a href="#case-study-real-world-longitudinal-causal-inference-using-targeted-learning" id="toc-case-study-real-world-longitudinal-causal-inference-using-targeted-learning" class="nav-link" data-scroll-target="#case-study-real-world-longitudinal-causal-inference-using-targeted-learning"><span class="header-section-number">12.1</span> Case Study: Real-World Longitudinal Causal Inference Using Targeted Learning</a></li>
  </ul></li>
  <li><a href="#the-clinical-and-real-world-context" id="toc-the-clinical-and-real-world-context" class="nav-link" data-scroll-target="#the-clinical-and-real-world-context"><span class="header-section-number">13</span> 1. The Clinical and Real-World Context</a></li>
  <li><a href="#the-longitudinal-data-structure" id="toc-the-longitudinal-data-structure" class="nav-link" data-scroll-target="#the-longitudinal-data-structure"><span class="header-section-number">14</span> 2. The Longitudinal Data Structure</a></li>
  <li><a href="#simulation-of-a-plausible-longitudinal-dataset" id="toc-simulation-of-a-plausible-longitudinal-dataset" class="nav-link" data-scroll-target="#simulation-of-a-plausible-longitudinal-dataset"><span class="header-section-number">15</span> 3. Simulation of a Plausible Longitudinal Dataset</a></li>
  <li><a href="#defining-the-longitudinal-causal-question" id="toc-defining-the-longitudinal-causal-question" class="nav-link" data-scroll-target="#defining-the-longitudinal-causal-question"><span class="header-section-number">16</span> 4. Defining the Longitudinal Causal Question</a></li>
  <li><a href="#identification-assumptions-for-longitudinal-effects" id="toc-identification-assumptions-for-longitudinal-effects" class="nav-link" data-scroll-target="#identification-assumptions-for-longitudinal-effects"><span class="header-section-number">17</span> 5. Identification: Assumptions for Longitudinal Effects</a></li>
  <li><a href="#using-lmtp-for-longitudinal-interventions" id="toc-using-lmtp-for-longitudinal-interventions" class="nav-link" data-scroll-target="#using-lmtp-for-longitudinal-interventions"><span class="header-section-number">18</span> 6. Using LMTP for Longitudinal Interventions</a></li>
  <li><a href="#using-longitudinal-tmle-manual-concept" id="toc-using-longitudinal-tmle-manual-concept" class="nav-link" data-scroll-target="#using-longitudinal-tmle-manual-concept"><span class="header-section-number">19</span> 7. Using Longitudinal TMLE (Manual Concept)</a></li>
  <li><a href="#interpretation-of-results" id="toc-interpretation-of-results" class="nav-link" data-scroll-target="#interpretation-of-results"><span class="header-section-number">20</span> 8. Interpretation of Results</a></li>
  <li><a href="#sensitivity-diagnostic-considerations" id="toc-sensitivity-diagnostic-considerations" class="nav-link" data-scroll-target="#sensitivity-diagnostic-considerations"><span class="header-section-number">21</span> 9. Sensitivity &amp; Diagnostic Considerations</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">22</span> 10. Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="chapter-3.3" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Chapter 3.3</h1>
<section id="case-study-real-world-longitudinal-causal-inference-using-targeted-learning" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="case-study-real-world-longitudinal-causal-inference-using-targeted-learning"><span class="header-section-number">12.1</span> Case Study: Real-World Longitudinal Causal Inference Using Targeted Learning</h2>
<p>This chapter walks through a <strong>complete applied example</strong> of longitudinal causal inference using real-world data concepts.<br>
The goal is to help you translate the earlier theoretical chapters into a practical analysis workflow.</p>
<p>We use the motivating real-world question:</p>
<blockquote class="blockquote">
<p><strong>What is the 3-year cardiovascular risk difference if all eligible patients initiating osteoporosis therapy remained on denosumab vs.&nbsp;zoledronic acid under full adherence?</strong></p>
</blockquote>
<p>Although we cannot use the proprietary data from the actual studies, this chapter recreates a <em>plausible longitudinal structure</em> and walks you through the entire pipeline:</p>
<ul>
<li>Constructing the longitudinal dataset<br>
</li>
<li>Defining the causal question, intervention, and estimand<br>
</li>
<li>Identifying longitudinal confounders and censoring<br>
</li>
<li>Using SuperLearner for nuisance function estimation<br>
</li>
<li>Applying TMLE or LMTP for longitudinal causal effects<br>
</li>
<li>Interpreting the results in a regulatory and clinical context</li>
</ul>
<p>This chapter integrates lessons from Chapter 1 (causal roadmap) and Chapter 2 (estimation).</p>
<hr>
</section>
</section>
<section id="the-clinical-and-real-world-context" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> 1. The Clinical and Real-World Context</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Longitudinal Analysis? The Clinical Reality
</div>
</div>
<div class="callout-body-container callout-body">
<p>Osteoporosis treatments such as <strong>denosumab</strong> and <strong>zoledronic acid</strong> are widely used in postmenopausal women. But real-world treatment trajectories are messy. Observational data registries show:</p>
<ul>
<li>Frequent <strong>treatment interruptions</strong></li>
<li><strong>Switching</strong> between agents</li>
<li><strong>Loss to follow-up</strong></li>
<li>Time-varying covariates (e.g., frailty, kidney function, fall risk)</li>
</ul>
<p>These complexities mean that a single baseline snapshot cannot capture the full causal story. Patients change treatments over time, their risk factors evolve, and those evolving risk factors influence both future treatment decisions and the outcome. <strong>This is why longitudinal causal inference is necessary</strong> — standard regression on baseline data alone will produce biased estimates when treatment and confounders co-evolve over time.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why a Naive Cox Model Fails Here
</div>
</div>
<div class="callout-body-container callout-body">
<p>A naive Cox model adjusting for baseline covariates would <strong>fail</strong> to address:</p>
<ul>
<li><strong>Time-varying confounding affected by prior treatment</strong> — a patient’s kidney function at month 6 is influenced by the treatment they received in months 1–5, and also affects what treatment they receive next</li>
<li><strong>Informative censoring</strong> — patients at higher risk may discontinue therapy, making dropouts systematically different from those who remain</li>
<li><strong>Treatment switching</strong> — patients who switch from one agent to another introduce post-baseline confounding that baseline adjustment cannot handle</li>
<li><strong>Differing follow-up time</strong> — varying observation windows across patients create structural biases when not properly modeled</li>
<li><strong>Positivity violations</strong> — some covariate histories may make one treatment nearly impossible, leading to extreme extrapolation</li>
</ul>
<p>If you adjust for time-varying confounders in a Cox model, you <strong>block causal pathways</strong> (overadjustment bias). If you do not adjust, you have <strong>uncontrolled confounding</strong>. This is the fundamental dilemma that methods like Longitudinal TMLE and LMTP are designed to solve.</p>
</div>
</div>
<p>We instead use <strong>Longitudinal TMLE</strong> or <strong>LMTP</strong> to estimate causal effects under hypothetical longitudinal interventions.</p>
<hr>
</section>
<section id="the-longitudinal-data-structure" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> 2. The Longitudinal Data Structure</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Canonical Longitudinal Data Structure
</div>
</div>
<div class="callout-body-container callout-body">
<p>Assume patient <span class="math inline">\(i\)</span> is followed monthly for 36 months. In longitudinal causal inference, we represent each patient’s observed data as an <strong>ordered sequence</strong> of baseline variables, treatments, time-varying confounders, censoring indicators, and the final outcome:</p>
<p><span class="math display">\[
O_i = (W_i, A_{i0}, L_{i1}, A_{i1}, C_{i1}, L_{i2}, A_{i2}, C_{i2}, \dots, Y_i)
\]</span></p>
<p><strong>Reading this notation:</strong> at each time point, we first observe the patient’s updated covariates (<span class="math inline">\(L_t\)</span>), then their treatment decision (<span class="math inline">\(A_t\)</span>), then whether they dropped out (<span class="math inline">\(C_t\)</span>). This ordering matters because it encodes our assumptions about what causes what.</p>
<p>Where:</p>
<ul>
<li><strong><span class="math inline">\(W\)</span></strong>: baseline covariates (age, CVD history, frailty) — measured once at study entry</li>
<li><strong><span class="math inline">\(A_t\)</span></strong>: treatment status at time <span class="math inline">\(t\)</span> (1 = denosumab, 0 = zoledronic acid) — can change over time</li>
<li><strong><span class="math inline">\(L_t\)</span></strong>: time-varying covariates (kidney function, fracture risk, comorbidities) — updated each visit</li>
<li><strong><span class="math inline">\(C_t\)</span></strong>: censoring/loss to follow-up (1 = censored) — captures informative dropout</li>
<li><strong><span class="math inline">\(Y\)</span></strong>: cardiovascular event by 36 months — the final outcome of interest</li>
</ul>
<p>This structure is the foundation for everything that follows. Every longitudinal causal method — whether IPTW, g-computation, or TMLE — operates on data organized this way.</p>
</div>
</div>
<p>We simulate a small example below.</p>
<hr>
</section>
<section id="simulation-of-a-plausible-longitudinal-dataset" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> 3. Simulation of a Plausible Longitudinal Dataset</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.6.0
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2027</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Tmax <span class="ot">&lt;-</span> <span class="dv">6</span>   <span class="co"># six timepoints for illustration</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>W_age  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">75</span>, <span class="dv">6</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>W_cvd  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="fl">0.12</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">70</span>)))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial treatment</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>A0 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span>(W_age <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fl">1.4</span><span class="sc">*</span>W_cvd))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Containers</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, Tmax)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, Tmax)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, Tmax)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>A[,<span class="dv">1</span>] <span class="ot">&lt;-</span> A0</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate longitudinal covariates &amp; treatment</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tmax) {</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># time-varying comorbidity</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  L[,t] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">0.3</span><span class="sc">*</span>W_age <span class="sc">+</span> <span class="fl">1.2</span><span class="sc">*</span>W_cvd <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>A[,<span class="fu">max</span>(<span class="dv">1</span>,t<span class="dv">-1</span>)], <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># treatment switching</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  A[,t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>L[,t] <span class="sc">+</span> <span class="fl">0.8</span><span class="sc">*</span>A[,<span class="fu">max</span>(<span class="dv">1</span>,t<span class="dv">-1</span>)]))</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># censoring</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  C[,t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">4</span> <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>L[,t] <span class="sc">+</span> <span class="fl">0.4</span><span class="sc">*</span>A[,t]))</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome depends on full history</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">rowMeans</span>(A) <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span><span class="fu">rowMeans</span>(L)))</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> W_age,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvd =</span> W_cvd,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand wide data into long format (illustrative)</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tmax) {</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  dat_long[[<span class="fu">paste0</span>(<span class="st">"L"</span>,t)]] <span class="ot">&lt;-</span> L[,t]</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  dat_long[[<span class="fu">paste0</span>(<span class="st">"A"</span>,t)]] <span class="ot">&lt;-</span> A[,t]</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  dat_long[[<span class="fu">paste0</span>(<span class="st">"C"</span>,t)]] <span class="ot">&lt;-</span> C[,t]</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2,000
Columns: 22
$ id  &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19,…
$ age &lt;dbl&gt; 69.39073, 70.83682, 71.71233, 79.59763, 86.11260, 79.52474, 68.490…
$ cvd &lt;int&gt; 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, …
$ Y   &lt;int&gt; 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, …
$ L1  &lt;dbl&gt; 20.34615, 22.75564, 23.10096, 26.65886, 27.36779, 26.43067, 22.025…
$ A1  &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ C1  &lt;dbl&gt; 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, …
$ L2  &lt;dbl&gt; 22.59807, 24.27239, 21.82958, 27.86522, 26.43808, 25.98865, 22.263…
$ A2  &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ C2  &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, …
$ L3  &lt;dbl&gt; 20.83098, 21.74027, 22.62104, 24.16512, 26.39433, 25.80440, 20.817…
$ A3  &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ C3  &lt;dbl&gt; 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, …
$ L4  &lt;dbl&gt; 20.78728, 24.72590, 22.69284, 26.37661, 28.55076, 23.07908, 23.526…
$ A4  &lt;int&gt; 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ C4  &lt;dbl&gt; 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ L5  &lt;dbl&gt; 20.82393, 20.23492, 21.55791, 26.03560, 29.75833, 24.53722, 23.048…
$ A5  &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ C5  &lt;dbl&gt; 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, …
$ L6  &lt;dbl&gt; 21.01436, 23.69870, 21.78397, 25.38586, 26.92236, 25.95101, 22.523…
$ A6  &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ C6  &lt;dbl&gt; 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, …</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What This Simulated Data Represents
</div>
</div>
<div class="callout-body-container callout-body">
<p>In plain language, the code above creates <strong>2,000 hypothetical patients</strong> each observed over <strong>6 time points</strong>. Here is what is happening at each step:</p>
<ol type="1">
<li><strong>Baseline</strong>: Each patient starts with an age (centered around 75) and a baseline CVD history that depends on age — older patients are more likely to have prior cardiovascular disease.</li>
<li><strong>Initial treatment (<span class="math inline">\(A_0\)</span>)</strong>: Whether a patient starts on denosumab depends on their age and CVD history — sicker, older patients are more likely to receive denosumab (confounding by indication).</li>
<li><strong>At each time point</strong>: A time-varying comorbidity score (<span class="math inline">\(L_t\)</span>) evolves based on age, CVD history, <em>and the prior treatment</em> — this is the hallmark of <strong>time-varying confounding affected by prior treatment</strong>. Treatment can then switch based on the current comorbidity score.</li>
<li><strong>Censoring</strong>: Dropout probability depends on current comorbidity and treatment — making censoring <strong>informative</strong> (sicker patients on certain treatments are more likely to be lost).</li>
<li><strong>Outcome</strong>: The final cardiovascular event depends on the <em>entire treatment history</em> (average treatment across all time points) and the <em>entire covariate history</em>.</li>
</ol>
<p>This is exactly the kind of data structure where naive methods break down: treatment affects future confounders, which affect future treatment, which affects the outcome.</p>
</div>
</div>
<hr>
</section>
<section id="defining-the-longitudinal-causal-question" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> 4. Defining the Longitudinal Causal Question</h1>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Static Treatment Regimes: The Causal Question in Plain Language
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our target estimand:</p>
<blockquote class="blockquote">
<p><strong>What is the 36-month cardiovascular event risk if everyone remained continuously on denosumab vs continuously on zoledronic acid?</strong></p>
</blockquote>
<p>In plain language, a <strong>static treatment regime</strong> is a hypothetical rule that says: “No matter what happens to the patient over time — regardless of side effects, lab values, or clinical events — keep them on this treatment at every visit.” We are comparing two such rules:</p>
<p>[ d_1: A_t = 1 &nbsp;orall t<br>
] [ d_0: A_t = 0 &nbsp;orall t ]</p>
<p>This is equivalent to a <strong>”perfect adherence” scenario</strong> — asking what <em>would</em> happen if every patient stayed on their assigned treatment for the full 36 months, something that rarely occurs in practice.</p>
<p><strong>Why this matters for MPH epidemiologists:</strong> This is the longitudinal analogue of the intention-to-treat vs.&nbsp;per-protocol distinction from RCTs. We are estimating a per-protocol-like effect, but from observational data, using methods that properly handle the time-varying confounding that makes naive per-protocol analyses biased.</p>
<p>We can also define:</p>
<ul>
<li><strong>Dynamic regimes</strong> (treatment depends on predicted fracture risk — e.g., “treat with denosumab only if eGFR drops below 45”)</li>
<li><strong>Stochastic regimes</strong> (shift interventions on treatment probabilities — e.g., “increase the probability of receiving denosumab by 10%”)</li>
</ul>
<p>But for now we use static interventions to keep the exposition clear.</p>
</div>
</div>
<hr>
</section>
<section id="identification-assumptions-for-longitudinal-effects" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> 5. Identification: Assumptions for Longitudinal Effects</h1>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Identification Assumptions — Sequential Exchangeability Is the Hardest to Defend
</div>
</div>
<div class="callout-body-container callout-body">
<p>To identify the causal effect using observed data, we require three assumptions. These are the longitudinal analogues of the point-treatment assumptions, but they must hold <strong>at every time point</strong>:</p>
<ul>
<li><p><strong>Sequential exchangeability (no unmeasured time-varying confounding):</strong> <span class="math inline">\(Y^{\bar{a}} \perp A_t \mid \bar{L}_t, \bar{A}_{t-1}, W\)</span> At each time <span class="math inline">\(t\)</span>, conditional on the full covariate and treatment history up to that point, the treatment assignment is “as good as random.” <strong>This is the hardest assumption to defend in practice.</strong> It requires that you have measured <em>every</em> variable that simultaneously affects treatment decisions and the outcome at <em>every</em> time point. In osteoporosis research, this means capturing not only lab values and diagnoses but also physician judgment, patient preferences, and symptom severity — variables that may not appear in claims data.</p></li>
<li><p><strong>Sequential positivity:</strong> Each treatment must be possible at each time for every covariate history. If certain patients <em>never</em> receive one of the treatments at some point in follow-up (e.g., patients with severe renal impairment never receive zoledronic acid), the causal effect is not identifiable for those subgroups.</p></li>
<li><p><strong>Consistency:</strong> The observed outcome for a patient who happened to follow regime <span class="math inline">\(\bar{a}\)</span> is the same as the potential outcome under intervention <span class="math inline">\(\bar{a}\)</span>. This is usually reasonable but requires that the treatment is well-defined (e.g., “denosumab 60mg SC every 6 months” not just “denosumab”).</p></li>
</ul>
<p><strong>Practical guidance:</strong> In your DAG and protocol, explicitly list which time-varying confounders you are conditioning on and which might be unmeasured. Sensitivity analyses (Section 9) can help assess how robust your conclusions are to violations of sequential exchangeability.</p>
</div>
</div>
<hr>
</section>
<section id="using-lmtp-for-longitudinal-interventions" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> 6. Using LMTP for Longitudinal Interventions</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What LMTP Does in Plain Language
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>lmtp</strong> R package lets you answer “what if” questions about treatment strategies that unfold over time. In plain language, it does the following:</p>
<ol type="1">
<li><strong>You specify a hypothetical treatment rule</strong> (e.g., “always give denosumab” or “increase the probability of treatment by 20%”).</li>
<li><strong>LMTP estimates what the outcome would have been</strong> if every patient in your dataset had followed that rule, adjusting for the fact that treatment, confounders, and censoring all evolve together over time.</li>
<li><strong>Under the hood</strong>, it uses a combination of outcome regression and treatment/censoring models (doubly robust estimation via TMLE), with <strong>SuperLearner</strong> to flexibly estimate these nuisance functions.</li>
</ol>
<p>The package supports:</p>
<ul>
<li><strong>Static interventions</strong> — set treatment to a fixed value at every time point</li>
<li><strong>Dynamic rules</strong> — treatment depends on patient characteristics at each visit</li>
<li><strong>Stochastic shifts</strong> — nudge treatment probabilities rather than forcing a deterministic rule</li>
<li><strong>Censoring adjustments</strong> — properly handle informative dropout</li>
</ul>
<p>This is a major practical advantage: you do not need to hand-code the sequential regression or the clever covariate targeting step. LMTP automates the entire longitudinal TMLE pipeline.</p>
</div>
</div>
<p>Here we implement:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example skeleton </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">library</span>(lmtp)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat_long,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trt =</span> <span class="fu">paste0</span>(<span class="st">"A"</span>, <span class="dv">1</span><span class="sc">:</span>Tmax),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>Tmax,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">shift =</span> <span class="cf">function</span>(data, trt) { <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(trt)) },  <span class="co"># always-denosumab</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_outcome =</span> <span class="fu">list</span>(SL.glm, SL.ranger),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_trt =</span> <span class="fu">list</span>(SL.glm, SL.ranger),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">folds =</span> <span class="dv">5</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives a TMLE estimate of:</p>
<ul>
<li>Risk under always-denosumab<br>
</li>
<li>Risk under always-ZA<br>
</li>
<li>Risk difference<br>
</li>
<li>Confidence intervals</li>
</ul>
<hr>
</section>
<section id="using-longitudinal-tmle-manual-concept" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> 7. Using Longitudinal TMLE (Manual Concept)</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Backward Regression Intuition
</div>
</div>
<div class="callout-body-container callout-body">
<p>Longitudinal TMLE can feel abstract, but the core intuition is straightforward: <strong>work backward from the outcome</strong>.</p>
<p>Think of it like this: imagine you are standing at the end of the study (month 36) and asking, “Given everything that happened up to this point, what is the expected outcome?” Then you step back one month and ask the same question, incorporating the answer from the future. You keep stepping backward, month by month, until you reach baseline.</p>
<p>At each step, the method:</p>
<ol type="1">
<li><strong>Estimates the expected outcome</strong> given the current and future treatment/covariate history (the “Q-model” or outcome regression)</li>
<li><strong>Estimates the probability of the observed treatment and remaining uncensored</strong> at that time point (the “g-model” or propensity/censoring model)</li>
<li><strong>Applies a targeting step</strong> — a small, clever update to the outcome regression that ensures the final estimate is <strong>doubly robust</strong> (consistent if <em>either</em> the Q-model or the g-model is correct) and has valid confidence intervals</li>
</ol>
<p>The procedure in summary:</p>
<ol type="1">
<li>Start at the final timepoint</li>
<li>Estimate Q-models backward in time</li>
<li>Estimate g-models for each treatment and censoring event</li>
<li>Apply sequential targeting</li>
<li>Compute counterfactual outcomes</li>
</ol>
<p>This is mathematically involved but <strong>automated by LMTP</strong> in most real applications. You do not need to implement the backward iteration yourself — but understanding the intuition helps you diagnose problems (e.g., if g-models at certain time points are near 0 or 1, you have a positivity issue at that step).</p>
</div>
</div>
<hr>
</section>
<section id="interpretation-of-results" class="level1" data-number="20">
<h1 data-number="20"><span class="header-section-number">20</span> 8. Interpretation of Results</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpreting Longitudinal Causal Estimates
</div>
</div>
<div class="callout-body-container callout-body">
<p>Assume hypothetical results:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Regime</th>
<th>Estimated 36-mo risk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Always denosumab</td>
<td>0.051</td>
</tr>
<tr class="even">
<td>Always ZA</td>
<td>0.055</td>
</tr>
</tbody>
</table>
<p>ATE (risk difference):</p>
<pre><code>-0.004 (0.4 percentage points lower cardiovascular risk)</code></pre>
<p><strong>How to read this table:</strong> Under the hypothetical scenario where <em>all</em> patients adhered perfectly to denosumab for 36 months, we estimate a 5.1% cardiovascular event rate. Under perfect adherence to zoledronic acid, we estimate 5.5%. The difference — 0.4 percentage points — is the estimated causal effect of the treatment policy.</p>
<p>Key interpretive points:</p>
<ul>
<li>The estimated cardiovascular risk difference between continuous denosumab vs continuous ZA is <strong>clinically small</strong>. Whether this is meaningful depends on the clinical context (absolute risk, NNT, cost).</li>
<li>Both therapies appear similar in cardiovascular risk, consistent with findings in published real-world evidence (RWE) studies.</li>
<li>These estimates reflect a <strong>per-protocol effect</strong> — what would happen under perfect adherence — which is different from what you would observe in practice where patients switch and discontinue.</li>
<li>Subgroup and sensitivity analyses should explore heterogeneity (e.g., does the effect differ by baseline CVD risk?) and robustness to assumption violations.</li>
</ul>
</div>
</div>
<hr>
</section>
<section id="sensitivity-diagnostic-considerations" class="level1" data-number="21">
<h1 data-number="21"><span class="header-section-number">21</span> 9. Sensitivity &amp; Diagnostic Considerations</h1>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Positivity Violations in Longitudinal Settings
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>9.1 Positivity.</strong> In a longitudinal study, positivity must hold <em>at every time point</em> for <em>every observed covariate history</em>. This is a much stronger requirement than in a single-timepoint study. Check treatment probabilities at each timepoint — if at any visit, certain patient profiles have near-zero probability of receiving one treatment, your estimates for that subgroup are extrapolating beyond the data.</p>
<p><strong>Practical check:</strong> Plot the estimated propensity scores (probability of treatment) at each time point, stratified by key covariates. If scores cluster near 0 or 1 at later time points, you may have a structural positivity violation.</p>
<p><strong>9.2 Extreme weights.</strong> LMTP and longitudinal TMLE handle extreme weights better than inverse probability of treatment weighting (IPTW), because they use substitution estimators rather than relying solely on inverse weighting. However, diagnostics still matter — examine the distribution of the estimated clever covariates or influence function values for outliers.</p>
<p><strong>9.3 Truncation.</strong> Weight or density ratio truncation may be needed for sparse treatment histories. If only a handful of patients follow a particular treatment sequence, the variance of your estimate will be large. Consider whether the target estimand is realistic given the data support.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Negative Control Outcomes: A Diagnostic for Unmeasured Confounding
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>9.4 Negative control outcomes</strong> are outcomes that <em>should not</em> be affected by the treatment if your causal model is correct. For example, if denosumab and zoledronic acid should have no differential effect on, say, accidental injury rates, then finding a “treatment effect” on accidental injuries is evidence of residual confounding.</p>
<p><strong>How to use them:</strong> Run your entire LMTP pipeline with the negative control outcome substituted for the real outcome. If the estimated effect is close to the null, that is reassuring (though not definitive). If you see a substantial effect, your primary analysis may be biased by unmeasured confounding.</p>
<p>This is one of the most practical tools available to an epidemiologist for assessing the plausibility of the sequential exchangeability assumption.</p>
</div>
</div>
<hr>
</section>
<section id="summary" class="level1" data-number="22">
<h1 data-number="22"><span class="header-section-number">22</span> 10. Summary</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Chapter Takeaways
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, you learned how to:</p>
<ul>
<li><strong>Build and structure longitudinal data</strong> using the canonical ordering <span class="math inline">\(O = (W, A_0, L_1, A_1, C_1, \dots, Y)\)</span> — the foundation for any longitudinal causal analysis</li>
<li><strong>Define static longitudinal interventions</strong> — hypothetical “always treat” regimes that formalize the causal question as a comparison of treatment policies over time</li>
<li><strong>Apply LMTP/TMLE for longitudinal causal effects</strong> — doubly robust, semiparametric methods that correctly handle time-varying confounding affected by prior treatment, informative censoring, and treatment switching</li>
<li><strong>Interpret results in a real-world regulatory context</strong> — distinguishing per-protocol causal effects from observed associational quantities, and understanding what the estimates do (and do not) tell us</li>
</ul>
<p><strong>The bottom line:</strong> When treatment, confounders, and censoring co-evolve over time, standard regression and Cox models produce biased estimates. Longitudinal TMLE and LMTP provide a principled, flexible framework for causal inference in these settings. The LMTP package makes this accessible in practice, automating the sequential targeting procedure while allowing SuperLearner-based estimation of nuisance functions.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    
 [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   
 [9] ggplot2_3.5.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 
 [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         
 [9] generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4 munsell_0.5.1    
[13] pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6       utf8_1.2.4       
[17] stringi_1.8.7     xfun_0.49         timechange_0.3.0  cli_3.6.5        
[21] withr_3.0.2       magrittr_2.0.3    digest_0.6.37     grid_4.4.2       
[25] rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4   vctrs_0.6.5      
[29] evaluate_1.0.5    glue_1.8.0        fansi_1.0.6       colorspace_2.1-1 
[33] rmarkdown_2.29    tools_4.4.2       pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amertens\.github\.io\/causal-learning-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./superlearner.html" class="pagination-link" aria-label="Chapter 2.4: SuperLearner and Machine Learning for Causal Inference">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-04-effect-modification.html" class="pagination-link" aria-label="Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb11" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 3.3  </span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Case Study: Real-World Longitudinal Causal Inference Using Targeted Learning</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>This chapter walks through a **complete applied example** of longitudinal causal inference using real-world data concepts.  </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>The goal is to help you translate the earlier theoretical chapters into a practical analysis workflow.</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>We use the motivating real-world question:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **What is the 3-year cardiovascular risk difference if all eligible patients initiating osteoporosis therapy remained on denosumab vs. zoledronic acid under full adherence?**</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>Although we cannot use the proprietary data from the actual studies, this chapter recreates a *plausible longitudinal structure* and walks you through the entire pipeline:</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Constructing the longitudinal dataset  </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Defining the causal question, intervention, and estimand  </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Identifying longitudinal confounders and censoring  </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Using SuperLearner for nuisance function estimation  </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Applying TMLE or LMTP for longitudinal causal effects  </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Interpreting the results in a regulatory and clinical context  </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>This chapter integrates lessons from Chapter 1 (causal roadmap) and Chapter 2 (estimation).</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. The Clinical and Real-World Context</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Longitudinal Analysis? The Clinical Reality</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>Osteoporosis treatments such as **denosumab** and **zoledronic acid** are widely used in postmenopausal women. But real-world treatment trajectories are messy. Observational data registries show:</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Frequent **treatment interruptions**</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Switching** between agents</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Loss to follow-up**</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Time-varying covariates (e.g., frailty, kidney function, fall risk)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>These complexities mean that a single baseline snapshot cannot capture the full causal story. Patients change treatments over time, their risk factors evolve, and those evolving risk factors influence both future treatment decisions and the outcome. **This is why longitudinal causal inference is necessary** --- standard regression on baseline data alone will produce biased estimates when treatment and confounders co-evolve over time.</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why a Naive Cox Model Fails Here</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>A naive Cox model adjusting for baseline covariates would **fail** to address:</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Time-varying confounding affected by prior treatment** --- a patient's kidney function at month 6 is influenced by the treatment they received in months 1--5, and also affects what treatment they receive next</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Informative censoring** --- patients at higher risk may discontinue therapy, making dropouts systematically different from those who remain</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treatment switching** --- patients who switch from one agent to another introduce post-baseline confounding that baseline adjustment cannot handle</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Differing follow-up time** --- varying observation windows across patients create structural biases when not properly modeled</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Positivity violations** --- some covariate histories may make one treatment nearly impossible, leading to extreme extrapolation</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>If you adjust for time-varying confounders in a Cox model, you **block causal pathways** (overadjustment bias). If you do not adjust, you have **uncontrolled confounding**. This is the fundamental dilemma that methods like Longitudinal TMLE and LMTP are designed to solve.</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>We instead use **Longitudinal TMLE** or **LMTP** to estimate causal effects under hypothetical longitudinal interventions.</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. The Longitudinal Data Structure</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Canonical Longitudinal Data Structure</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>Assume patient $i$ is followed monthly for 36 months. In longitudinal causal inference, we represent each patient's observed data as an **ordered sequence** of baseline variables, treatments, time-varying confounders, censoring indicators, and the final outcome:</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>O_i = (W_i, A_{i0}, L_{i1}, A_{i1}, C_{i1}, L_{i2}, A_{i2}, C_{i2}, \dots, Y_i)</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>**Reading this notation:** at each time point, we first observe the patient's updated covariates ($L_t$), then their treatment decision ($A_t$), then whether they dropped out ($C_t$). This ordering matters because it encodes our assumptions about what causes what.</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>Where:</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$W$**: baseline covariates (age, CVD history, frailty) --- measured once at study entry</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$A_t$**: treatment status at time $t$ (1 = denosumab, 0 = zoledronic acid) --- can change over time</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$L_t$**: time-varying covariates (kidney function, fracture risk, comorbidities) --- updated each visit</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$C_t$**: censoring/loss to follow-up (1 = censored) --- captures informative dropout</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$Y$**: cardiovascular event by 36 months --- the final outcome of interest</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>This structure is the foundation for everything that follows. Every longitudinal causal method --- whether IPTW, g-computation, or TMLE --- operates on data organized this way.</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>We simulate a small example below.</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Simulation of a Plausible Longitudinal Dataset</span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2027</span>)</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>Tmax <span class="ot">&lt;-</span> <span class="dv">6</span>   <span class="co"># six timepoints for illustration</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>W_age  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">75</span>, <span class="dv">6</span>)</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>W_cvd  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="fl">0.12</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">70</span>)))</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial treatment</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>A0 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span>(W_age <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fl">1.4</span><span class="sc">*</span>W_cvd))</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Containers</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, Tmax)</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, Tmax)</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, Tmax)</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>A[,<span class="dv">1</span>] <span class="ot">&lt;-</span> A0</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate longitudinal covariates &amp; treatment</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tmax) {</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># time-varying comorbidity</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>  L[,t] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">0.3</span><span class="sc">*</span>W_age <span class="sc">+</span> <span class="fl">1.2</span><span class="sc">*</span>W_cvd <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>A[,<span class="fu">max</span>(<span class="dv">1</span>,t<span class="dv">-1</span>)], <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># treatment switching</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>  A[,t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>L[,t] <span class="sc">+</span> <span class="fl">0.8</span><span class="sc">*</span>A[,<span class="fu">max</span>(<span class="dv">1</span>,t<span class="dv">-1</span>)]))</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># censoring</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>  C[,t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">4</span> <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>L[,t] <span class="sc">+</span> <span class="fl">0.4</span><span class="sc">*</span>A[,t]))</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome depends on full history</span></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">rowMeans</span>(A) <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span><span class="fu">rowMeans</span>(L)))</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> W_age,</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvd =</span> W_cvd,</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand wide data into long format (illustrative)</span></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tmax) {</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>  dat_long[[<span class="fu">paste0</span>(<span class="st">"L"</span>,t)]] <span class="ot">&lt;-</span> L[,t]</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>  dat_long[[<span class="fu">paste0</span>(<span class="st">"A"</span>,t)]] <span class="ot">&lt;-</span> A[,t]</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>  dat_long[[<span class="fu">paste0</span>(<span class="st">"C"</span>,t)]] <span class="ot">&lt;-</span> C[,t]</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat_long)</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a><span class="fu">## What This Simulated Data Represents</span></span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>In plain language, the code above creates **2,000 hypothetical patients** each observed over **6 time points**. Here is what is happening at each step:</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Baseline**: Each patient starts with an age (centered around 75) and a baseline CVD history that depends on age --- older patients are more likely to have prior cardiovascular disease.</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Initial treatment ($A_0$)**: Whether a patient starts on denosumab depends on their age and CVD history --- sicker, older patients are more likely to receive denosumab (confounding by indication).</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**At each time point**: A time-varying comorbidity score ($L_t$) evolves based on age, CVD history, *and the prior treatment* --- this is the hallmark of **time-varying confounding affected by prior treatment**. Treatment can then switch based on the current comorbidity score.</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Censoring**: Dropout probability depends on current comorbidity and treatment --- making censoring **informative** (sicker patients on certain treatments are more likely to be lost).</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Outcome**: The final cardiovascular event depends on the *entire treatment history* (average treatment across all time points) and the *entire covariate history*.</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>This is exactly the kind of data structure where naive methods break down: treatment affects future confounders, which affect future treatment, which affects the outcome.</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Defining the Longitudinal Causal Question</span></span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a><span class="fu">## Static Treatment Regimes: The Causal Question in Plain Language</span></span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>Our target estimand:</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **What is the 36-month cardiovascular event risk if everyone remained continuously on denosumab vs continuously on zoledronic acid?**</span></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>In plain language, a **static treatment regime** is a hypothetical rule that says: "No matter what happens to the patient over time --- regardless of side effects, lab values, or clinical events --- keep them on this treatment at every visit." We are comparing two such rules:</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a><span class="sc">\[</span></span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>d_1: A_t = 1 \ orall t  </span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a><span class="sc">\]</span></span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a><span class="sc">\[</span></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>d_0: A_t = 0 \ orall t</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a><span class="sc">\]</span></span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>This is equivalent to a **”perfect adherence” scenario** --- asking what *would* happen if every patient stayed on their assigned treatment for the full 36 months, something that rarely occurs in practice.</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>**Why this matters for MPH epidemiologists:** This is the longitudinal analogue of the intention-to-treat vs. per-protocol distinction from RCTs. We are estimating a per-protocol-like effect, but from observational data, using methods that properly handle the time-varying confounding that makes naive per-protocol analyses biased.</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>We can also define:</span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Dynamic regimes** (treatment depends on predicted fracture risk --- e.g., “treat with denosumab only if eGFR drops below 45”)</span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Stochastic regimes** (shift interventions on treatment probabilities --- e.g., “increase the probability of receiving denosumab by 10%”)</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>But for now we use static interventions to keep the exposition clear.</span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. Identification: Assumptions for Longitudinal Effects</span></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a><span class="fu">## Identification Assumptions --- Sequential Exchangeability Is the Hardest to Defend</span></span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>To identify the causal effect using observed data, we require three assumptions. These are the longitudinal analogues of the point-treatment assumptions, but they must hold **at every time point**:</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Sequential exchangeability (no unmeasured time-varying confounding):**</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>  $Y^{\bar{a}} \perp A_t \mid \bar{L}_t, \bar{A}_{t-1}, W$</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>  At each time $t$, conditional on the full covariate and treatment history up to that point, the treatment assignment is "as good as random." **This is the hardest assumption to defend in practice.** It requires that you have measured *every* variable that simultaneously affects treatment decisions and the outcome at *every* time point. In osteoporosis research, this means capturing not only lab values and diagnoses but also physician judgment, patient preferences, and symptom severity --- variables that may not appear in claims data.</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Sequential positivity:**</span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>  Each treatment must be possible at each time for every covariate history. If certain patients *never* receive one of the treatments at some point in follow-up (e.g., patients with severe renal impairment never receive zoledronic acid), the causal effect is not identifiable for those subgroups.</span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Consistency:**</span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>  The observed outcome for a patient who happened to follow regime $\bar{a}$ is the same as the potential outcome under intervention $\bar{a}$. This is usually reasonable but requires that the treatment is well-defined (e.g., "denosumab 60mg SC every 6 months" not just "denosumab").</span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>**Practical guidance:** In your DAG and protocol, explicitly list which time-varying confounders you are conditioning on and which might be unmeasured. Sensitivity analyses (Section 9) can help assess how robust your conclusions are to violations of sequential exchangeability.</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. Using LMTP for Longitudinal Interventions</span></span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a><span class="fu">## What LMTP Does in Plain Language</span></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>The **lmtp** R package lets you answer "what if" questions about treatment strategies that unfold over time. In plain language, it does the following:</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**You specify a hypothetical treatment rule** (e.g., "always give denosumab" or "increase the probability of treatment by 20%").</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**LMTP estimates what the outcome would have been** if every patient in your dataset had followed that rule, adjusting for the fact that treatment, confounders, and censoring all evolve together over time.</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Under the hood**, it uses a combination of outcome regression and treatment/censoring models (doubly robust estimation via TMLE), with **SuperLearner** to flexibly estimate these nuisance functions.</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>The package supports:</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Static interventions** --- set treatment to a fixed value at every time point</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Dynamic rules** --- treatment depends on patient characteristics at each visit</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Stochastic shifts** --- nudge treatment probabilities rather than forcing a deterministic rule</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Censoring adjustments** --- properly handle informative dropout</span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>This is a major practical advantage: you do not need to hand-code the sequential regression or the clever covariate targeting step. LMTP automates the entire longitudinal TMLE pipeline.</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a>Here we implement:</span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a><span class="in"># Example skeleton </span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a><span class="in"> library(lmtp)</span></span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a><span class="in">result &lt;- lmtp_tmle(</span></span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a><span class="in">  data = dat_long,</span></span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a><span class="in">  trt = paste0("A", 1:Tmax),</span></span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a><span class="in">  outcome = "Y",</span></span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a><span class="in">  time = 1:Tmax,</span></span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a><span class="in">  shift = function(data, trt) { rep(1, length(trt)) },  # always-denosumab</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a><span class="in">  learners_outcome = list(SL.glm, SL.ranger),</span></span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a><span class="in">  learners_trt = list(SL.glm, SL.ranger),</span></span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a><span class="in">  folds = 5</span></span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a><span class="in">result</span></span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>This gives a TMLE estimate of:</span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Risk under always-denosumab  </span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Risk under always-ZA  </span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Risk difference  </span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Confidence intervals  </span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. Using Longitudinal TMLE (Manual Concept)</span></span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Backward Regression Intuition</span></span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>Longitudinal TMLE can feel abstract, but the core intuition is straightforward: **work backward from the outcome**.</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>Think of it like this: imagine you are standing at the end of the study (month 36) and asking, "Given everything that happened up to this point, what is the expected outcome?" Then you step back one month and ask the same question, incorporating the answer from the future. You keep stepping backward, month by month, until you reach baseline.</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>At each step, the method:</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Estimates the expected outcome** given the current and future treatment/covariate history (the "Q-model" or outcome regression)</span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Estimates the probability of the observed treatment and remaining uncensored** at that time point (the "g-model" or propensity/censoring model)</span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Applies a targeting step** --- a small, clever update to the outcome regression that ensures the final estimate is **doubly robust** (consistent if *either* the Q-model or the g-model is correct) and has valid confidence intervals</span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a>The procedure in summary:</span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Start at the final timepoint</span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Estimate Q-models backward in time</span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Estimate g-models for each treatment and censoring event</span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Apply sequential targeting</span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Compute counterfactual outcomes</span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a>This is mathematically involved but **automated by LMTP** in most real applications. You do not need to implement the backward iteration yourself --- but understanding the intuition helps you diagnose problems (e.g., if g-models at certain time points are near 0 or 1, you have a positivity issue at that step).</span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Interpretation of Results</span></span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting Longitudinal Causal Estimates</span></span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>Assume hypothetical results:</span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>| Regime | Estimated 36-mo risk |</span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a>|--------|----------------------|</span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>| Always denosumab | 0.051 |</span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a>| Always ZA        | 0.055 |</span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a>ATE (risk difference):</span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a><span class="in">-0.004 (0.4 percentage points lower cardiovascular risk)</span></span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a>**How to read this table:** Under the hypothetical scenario where *all* patients adhered perfectly to denosumab for 36 months, we estimate a 5.1% cardiovascular event rate. Under perfect adherence to zoledronic acid, we estimate 5.5%. The difference --- 0.4 percentage points --- is the estimated causal effect of the treatment policy.</span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a>Key interpretive points:</span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The estimated cardiovascular risk difference between continuous denosumab vs continuous ZA is **clinically small**. Whether this is meaningful depends on the clinical context (absolute risk, NNT, cost).</span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Both therapies appear similar in cardiovascular risk, consistent with findings in published real-world evidence (RWE) studies.</span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>These estimates reflect a **per-protocol effect** --- what would happen under perfect adherence --- which is different from what you would observe in practice where patients switch and discontinue.</span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Subgroup and sensitivity analyses should explore heterogeneity (e.g., does the effect differ by baseline CVD risk?) and robustness to assumption violations.</span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Sensitivity &amp; Diagnostic Considerations</span></span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a><span class="fu">## Positivity Violations in Longitudinal Settings</span></span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a>**9.1 Positivity.** In a longitudinal study, positivity must hold *at every time point* for *every observed covariate history*. This is a much stronger requirement than in a single-timepoint study. Check treatment probabilities at each timepoint --- if at any visit, certain patient profiles have near-zero probability of receiving one treatment, your estimates for that subgroup are extrapolating beyond the data.</span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a>**Practical check:** Plot the estimated propensity scores (probability of treatment) at each time point, stratified by key covariates. If scores cluster near 0 or 1 at later time points, you may have a structural positivity violation.</span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a>**9.2 Extreme weights.** LMTP and longitudinal TMLE handle extreme weights better than inverse probability of treatment weighting (IPTW), because they use substitution estimators rather than relying solely on inverse weighting. However, diagnostics still matter --- examine the distribution of the estimated clever covariates or influence function values for outliers.</span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a>**9.3 Truncation.** Weight or density ratio truncation may be needed for sparse treatment histories. If only a handful of patients follow a particular treatment sequence, the variance of your estimate will be large. Consider whether the target estimand is realistic given the data support.</span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a><span class="fu">## Negative Control Outcomes: A Diagnostic for Unmeasured Confounding</span></span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a>**9.4 Negative control outcomes** are outcomes that *should not* be affected by the treatment if your causal model is correct. For example, if denosumab and zoledronic acid should have no differential effect on, say, accidental injury rates, then finding a "treatment effect" on accidental injuries is evidence of residual confounding.</span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>**How to use them:** Run your entire LMTP pipeline with the negative control outcome substituted for the real outcome. If the estimated effect is close to the null, that is reassuring (though not definitive). If you see a substantial effect, your primary analysis may be biased by unmeasured confounding.</span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>This is one of the most practical tools available to an epidemiologist for assessing the plausibility of the sequential exchangeability assumption.</span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a><span class="fu"># 10. Summary</span></span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a><span class="fu">## Chapter Takeaways</span></span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a>In this chapter, you learned how to:</span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Build and structure longitudinal data** using the canonical ordering $O = (W, A_0, L_1, A_1, C_1, \dots, Y)$ --- the foundation for any longitudinal causal analysis</span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Define static longitudinal interventions** --- hypothetical "always treat" regimes that formalize the causal question as a comparison of treatment policies over time</span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Apply LMTP/TMLE for longitudinal causal effects** --- doubly robust, semiparametric methods that correctly handle time-varying confounding affected by prior treatment, informative censoring, and treatment switching</span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Interpret results in a real-world regulatory context** --- distinguishing per-protocol causal effects from observed associational quantities, and understanding what the estimates do (and do not) tell us</span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a>**The bottom line:** When treatment, confounders, and censoring co-evolve over time, standard regression and Cox models produce biased estimates. Longitudinal TMLE and LMTP provide a principled, flexible framework for causal inference in these settings. The LMTP package makes this accessible in practice, automating the sequential targeting procedure while allowing SuperLearner-based estimation of nuisance functions.</span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>