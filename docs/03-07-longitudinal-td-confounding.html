<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A practical guide to the Causal Roadmap, Targeted Maximum Likelihood Estimation (TMLE), and Super Learner for modern causal inference in epidemiology, with emphasis on pharmacoepidemiology and clinical trial analysis.">

<title>15&nbsp; Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE – Causal Learning Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-08-tmle-clean-room.html" rel="next">
<link href="./03-06-rwd-meets-rct-hybrid-designs.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b343bb23504f009ddf7b24643a6af19a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-07-longitudinal-td-confounding.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Causal Learning Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/amertens/causal-learning-handbook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Causal Learning Handbook</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-01-regression-vs-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 1.1: Limitations of Standard Regression Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-02-causal-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 1.2: The Causal Roadmap</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-03-identification-estimands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1.3: From Causal Questions to Analysis — Identification, Estimands, and Statistical Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Roadmap for Real-world Evidence Generation: A Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Estimation Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-01-gcomputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-02-iptw.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-03-doubly-robust-tmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-04-tmle-teaching-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superlearner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-03-longitudinal-case-study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-04-effect-modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-05-advanced-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-07-longitudinal-td-confounding.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-08-tmle-clean-room.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-09-illustrated-ltmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-10-tmle-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anotated_bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Annotated Bibliography: Modern Causal Inference and Targeted Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#chapter-3.7-imperfect-adherence-in-longitudinal-data" id="toc-chapter-3.7-imperfect-adherence-in-longitudinal-data" class="nav-link active" data-scroll-target="#chapter-3.7-imperfect-adherence-in-longitudinal-data"><span class="header-section-number">16</span> Chapter 3.7: Imperfect Adherence in Longitudinal Data</a></li>
  <li><a href="#clinical-motivation" id="toc-clinical-motivation" class="nav-link" data-scroll-target="#clinical-motivation"><span class="header-section-number">17</span> 1. Clinical Motivation</a>
  <ul class="collapse">
  <li><a href="#the-setting" id="toc-the-setting" class="nav-link" data-scroll-target="#the-setting"><span class="header-section-number">17.1</span> The Setting</a>
  <ul class="collapse">
  <li><a href="#why-this-question-is-hard" id="toc-why-this-question-is-hard" class="nav-link" data-scroll-target="#why-this-question-is-hard"><span class="header-section-number">17.1.1</span> Why this question is hard</a></li>
  <li><a href="#target-population" id="toc-target-population" class="nav-link" data-scroll-target="#target-population"><span class="header-section-number">17.1.2</span> Target population</a></li>
  <li><a href="#treatment-strategies" id="toc-treatment-strategies" class="nav-link" data-scroll-target="#treatment-strategies"><span class="header-section-number">17.1.3</span> Treatment strategies</a></li>
  <li><a href="#outcome" id="toc-outcome" class="nav-link" data-scroll-target="#outcome"><span class="header-section-number">17.1.4</span> Outcome</a></li>
  <li><a href="#intercurrent-events" id="toc-intercurrent-events" class="nav-link" data-scroll-target="#intercurrent-events"><span class="header-section-number">17.1.5</span> Intercurrent events</a></li>
  <li><a href="#the-decision" id="toc-the-decision" class="nav-link" data-scroll-target="#the-decision"><span class="header-section-number">17.1.6</span> The decision</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#the-problem-with-conditioning-on-adherence" id="toc-the-problem-with-conditioning-on-adherence" class="nav-link" data-scroll-target="#the-problem-with-conditioning-on-adherence"><span class="header-section-number">18</span> 2. The Problem with Conditioning on Adherence</a>
  <ul class="collapse">
  <li><a href="#why-not-just-adjust-for-adherence-in-a-regression" id="toc-why-not-just-adjust-for-adherence-in-a-regression" class="nav-link" data-scroll-target="#why-not-just-adjust-for-adherence-in-a-regression"><span class="header-section-number">18.1</span> Why not just adjust for adherence in a regression?</a></li>
  <li><a href="#visual-intuition" id="toc-visual-intuition" class="nav-link" data-scroll-target="#visual-intuition"><span class="header-section-number">18.2</span> Visual intuition</a></li>
  <li><a href="#a-common-mistake-gee-models" id="toc-a-common-mistake-gee-models" class="nav-link" data-scroll-target="#a-common-mistake-gee-models"><span class="header-section-number">18.3</span> A common mistake: GEE models</a></li>
  </ul></li>
  <li><a href="#causal-roadmap-for-longitudinal-data" id="toc-causal-roadmap-for-longitudinal-data" class="nav-link" data-scroll-target="#causal-roadmap-for-longitudinal-data"><span class="header-section-number">19</span> 3. Causal Roadmap for Longitudinal Data</a></li>
  <li><a href="#data-simulation" id="toc-data-simulation" class="nav-link" data-scroll-target="#data-simulation"><span class="header-section-number">20</span> 4. Data Simulation</a>
  <ul class="collapse">
  <li><a href="#true-effect-of-perfect-adherence" id="toc-true-effect-of-perfect-adherence" class="nav-link" data-scroll-target="#true-effect-of-perfect-adherence"><span class="header-section-number">20.0.1</span> True effect of perfect adherence</a></li>
  <li><a href="#prepare-data-in-long-format" id="toc-prepare-data-in-long-format" class="nav-link" data-scroll-target="#prepare-data-in-long-format"><span class="header-section-number">20.0.2</span> Prepare data in long format</a></li>
  </ul></li>
  <li><a href="#the-naive-biased-approach" id="toc-the-naive-biased-approach" class="nav-link" data-scroll-target="#the-naive-biased-approach"><span class="header-section-number">21</span> 5. The Naive (Biased) Approach</a>
  <ul class="collapse">
  <li><a href="#a.-cross-sectional-regression-on-cumulative-adherence" id="toc-a.-cross-sectional-regression-on-cumulative-adherence" class="nav-link" data-scroll-target="#a.-cross-sectional-regression-on-cumulative-adherence"><span class="header-section-number">21.1</span> 5A. Cross-sectional regression on cumulative adherence</a></li>
  </ul></li>
  <li><a href="#iptw-for-marginal-structural-models" id="toc-iptw-for-marginal-structural-models" class="nav-link" data-scroll-target="#iptw-for-marginal-structural-models"><span class="header-section-number">22</span> 6. IPTW for Marginal Structural Models</a>
  <ul class="collapse">
  <li><a href="#estimate-treatment-weights-at-each-time-point" id="toc-estimate-treatment-weights-at-each-time-point" class="nav-link" data-scroll-target="#estimate-treatment-weights-at-each-time-point"><span class="header-section-number">22.0.1</span> Estimate treatment weights at each time point</a></li>
  <li><a href="#compute-cumulative-weights" id="toc-compute-cumulative-weights" class="nav-link" data-scroll-target="#compute-cumulative-weights"><span class="header-section-number">22.0.2</span> Compute cumulative weights</a></li>
  <li><a href="#weighted-outcome-model" id="toc-weighted-outcome-model" class="nav-link" data-scroll-target="#weighted-outcome-model"><span class="header-section-number">22.0.3</span> Weighted outcome model</a></li>
  </ul></li>
  <li><a href="#longitudinal-tmle-conceptual-overview" id="toc-longitudinal-tmle-conceptual-overview" class="nav-link" data-scroll-target="#longitudinal-tmle-conceptual-overview"><span class="header-section-number">23</span> 7. Longitudinal TMLE: Conceptual Overview</a>
  <ul class="collapse">
  <li><a href="#the-algorithm-simplified" id="toc-the-algorithm-simplified" class="nav-link" data-scroll-target="#the-algorithm-simplified"><span class="header-section-number">23.0.1</span> The algorithm (simplified)</a></li>
  <li><a href="#why-ltmle-is-better-than-longitudinal-iptw" id="toc-why-ltmle-is-better-than-longitudinal-iptw" class="nav-link" data-scroll-target="#why-ltmle-is-better-than-longitudinal-iptw"><span class="header-section-number">23.0.2</span> Why LTMLE is better than longitudinal IPTW</a></li>
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages"><span class="header-section-number">23.0.3</span> Packages</a></li>
  </ul></li>
  <li><a href="#implementing-longitudinal-tmle" id="toc-implementing-longitudinal-tmle" class="nav-link" data-scroll-target="#implementing-longitudinal-tmle"><span class="header-section-number">24</span> 8. Implementing Longitudinal TMLE</a>
  <ul class="collapse">
  <li><a href="#by-hand-sequential-regression-approach" id="toc-by-hand-sequential-regression-approach" class="nav-link" data-scroll-target="#by-hand-sequential-regression-approach"><span class="header-section-number">24.0.1</span> By-hand sequential regression approach</a></li>
  <li><a href="#iterative-targeting-simplified-2-step" id="toc-iterative-targeting-simplified-2-step" class="nav-link" data-scroll-target="#iterative-targeting-simplified-2-step"><span class="header-section-number">24.0.2</span> Iterative targeting (simplified 2-step)</a></li>
  <li><a href="#influence-curve-based-inference" id="toc-influence-curve-based-inference" class="nav-link" data-scroll-target="#influence-curve-based-inference"><span class="header-section-number">24.0.3</span> Influence-curve based inference</a></li>
  </ul></li>
  <li><a href="#using-the-lmtp-package" id="toc-using-the-lmtp-package" class="nav-link" data-scroll-target="#using-the-lmtp-package"><span class="header-section-number">25</span> 9. Using the LMTP Package</a>
  <ul class="collapse">
  <li><a href="#lmtp-interface-conceptual" id="toc-lmtp-interface-conceptual" class="nav-link" data-scroll-target="#lmtp-interface-conceptual"><span class="header-section-number">25.0.1</span> LMTP interface (conceptual)</a></li>
  <li><a href="#stochastic-intervention-shift-adherence-probability" id="toc-stochastic-intervention-shift-adherence-probability" class="nav-link" data-scroll-target="#stochastic-intervention-shift-adherence-probability"><span class="header-section-number">25.0.2</span> Stochastic intervention: shift adherence probability</a></li>
  </ul></li>
  <li><a href="#comparison-gee-vs.-iptw-msm-vs.-ltmle" id="toc-comparison-gee-vs.-iptw-msm-vs.-ltmle" class="nav-link" data-scroll-target="#comparison-gee-vs.-iptw-msm-vs.-ltmle"><span class="header-section-number">26</span> 10. Comparison: GEE vs.&nbsp;IPTW-MSM vs.&nbsp;LTMLE</a></li>
  <li><a href="#diagnostics-for-longitudinal-settings" id="toc-diagnostics-for-longitudinal-settings" class="nav-link" data-scroll-target="#diagnostics-for-longitudinal-settings"><span class="header-section-number">27</span> 11. Diagnostics for Longitudinal Settings</a>
  <ul class="collapse">
  <li><a href="#time-specific-propensity-score-overlap" id="toc-time-specific-propensity-score-overlap" class="nav-link" data-scroll-target="#time-specific-propensity-score-overlap"><span class="header-section-number">27.1</span> 11.1 Time-specific propensity score overlap</a></li>
  <li><a href="#cumulative-weight-distribution" id="toc-cumulative-weight-distribution" class="nav-link" data-scroll-target="#cumulative-weight-distribution"><span class="header-section-number">27.2</span> 11.2 Cumulative weight distribution</a></li>
  <li><a href="#adherence-patterns-over-time" id="toc-adherence-patterns-over-time" class="nav-link" data-scroll-target="#adherence-patterns-over-time"><span class="header-section-number">27.3</span> 11.3 Adherence patterns over time</a></li>
  </ul></li>
  <li><a href="#imperfect-adherence-as-an-intercurrent-event" id="toc-imperfect-adherence-as-an-intercurrent-event" class="nav-link" data-scroll-target="#imperfect-adherence-as-an-intercurrent-event"><span class="header-section-number">28</span> 12. Imperfect Adherence as an Intercurrent Event</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">29</span> 13. Interpretation</a>
  <ul class="collapse">
  <li><a href="#what-would-we-tell-the-public-health-agency" id="toc-what-would-we-tell-the-public-health-agency" class="nav-link" data-scroll-target="#what-would-we-tell-the-public-health-agency"><span class="header-section-number">29.1</span> What would we tell the public health agency?</a></li>
  <li><a href="#implications-for-adherence-support-programs" id="toc-implications-for-adherence-support-programs" class="nav-link" data-scroll-target="#implications-for-adherence-support-programs"><span class="header-section-number">29.2</span> Implications for adherence support programs</a></li>
  <li><a href="#fragile-assumptions" id="toc-fragile-assumptions" class="nav-link" data-scroll-target="#fragile-assumptions"><span class="header-section-number">29.3</span> Fragile assumptions</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">30</span> Key Takeaways</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-07-longitudinal-td-confounding.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">An illustrated guide to why conditioning on adherence biases causal effects, and how longitudinal TMLE and LMTP address this</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="chapter-3.7-imperfect-adherence-in-longitudinal-data" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> Chapter 3.7: Imperfect Adherence in Longitudinal Data</h1>
<p><em>Why conditioning on adherence biases causal effects, and how longitudinal TMLE and LMTP address this</em></p>
<p>In randomized trials, the intent-to-treat (ITT) analysis compares groups as randomized, regardless of whether patients actually took their medication. But in pharmacoepidemiology, we often want to know:</p>
<blockquote class="blockquote">
<p>What would have happened if patients had actually followed a particular treatment strategy?</p>
</blockquote>
<p>This chapter addresses <strong>imperfect adherence</strong> — a central challenge in longitudinal causal inference. We show:</p>
<ul>
<li>Why standard regression conditioning on time-varying adherence introduces bias</li>
<li>How the causal roadmap handles time-varying treatments and confounders</li>
<li>How to define realistic adherence-based estimands</li>
<li>How to implement longitudinal TMLE and LMTP to estimate effects under hypothetical adherence patterns</li>
</ul>
<p>The motivating example: <strong>antiretroviral therapy (ART) adherence and HIV virologic suppression</strong>.</p>
<hr>
</section>
<section id="clinical-motivation" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> 1. Clinical Motivation</h1>
<section id="the-setting" class="level2" data-number="17.1">
<h2 data-number="17.1" class="anchored" data-anchor-id="the-setting"><span class="header-section-number">17.1</span> The Setting</h2>
<p>A public health agency wants to evaluate antiretroviral therapy strategies for people living with HIV. The key question:</p>
<blockquote class="blockquote">
<p><strong>What is the probability of virologic suppression (HIV RNA &lt; 200 copies/mL) at 12 months if all patients maintained high adherence to their ART regimen, compared to the observed adherence pattern?</strong></p>
</blockquote>
<section id="why-this-question-is-hard" class="level3" data-number="17.1.1">
<h3 data-number="17.1.1" class="anchored" data-anchor-id="why-this-question-is-hard"><span class="header-section-number">17.1.1</span> Why this question is hard</h3>
<p>In practice, ART adherence varies over time due to:</p>
<ul>
<li><strong>Side effects</strong> (nausea, fatigue) that reduce adherence</li>
<li><strong>Viral load response</strong> — patients who achieve suppression may become less diligent</li>
<li><strong>CD4 count changes</strong> — worsening health may change both adherence and outcomes</li>
<li><strong>Mental health</strong> and substance use — confounders that affect both adherence and outcomes</li>
</ul>
<p>Critically, adherence at each time point is influenced by time-varying health status, and time-varying health status is itself influenced by past adherence. This creates <strong>time-varying confounding affected by prior treatment</strong> — a situation where standard methods fail.</p>
</section>
<section id="target-population" class="level3" data-number="17.1.2">
<h3 data-number="17.1.2" class="anchored" data-anchor-id="target-population"><span class="header-section-number">17.1.2</span> Target population</h3>
<p>Adults living with HIV initiating a new ART regimen</p>
</section>
<section id="treatment-strategies" class="level3" data-number="17.1.3">
<h3 data-number="17.1.3" class="anchored" data-anchor-id="treatment-strategies"><span class="header-section-number">17.1.3</span> Treatment strategies</h3>
<ul>
<li><strong>Strategy 1:</strong> Maintain high adherence (<span class="math inline">\(\geq\)</span> 95% of doses) at every monthly interval</li>
<li><strong>Strategy 0:</strong> Natural (observed) adherence course</li>
</ul>
</section>
<section id="outcome" class="level3" data-number="17.1.4">
<h3 data-number="17.1.4" class="anchored" data-anchor-id="outcome"><span class="header-section-number">17.1.4</span> Outcome</h3>
<p>Virologic suppression (HIV RNA &lt; 200 copies/mL) at 12 months</p>
</section>
<section id="intercurrent-events" class="level3" data-number="17.1.5">
<h3 data-number="17.1.5" class="anchored" data-anchor-id="intercurrent-events"><span class="header-section-number">17.1.5</span> Intercurrent events</h3>
<ul>
<li>Loss to follow-up (informative censoring)</li>
<li>Treatment switching</li>
<li>Death</li>
</ul>
</section>
<section id="the-decision" class="level3" data-number="17.1.6">
<h3 data-number="17.1.6" class="anchored" data-anchor-id="the-decision"><span class="header-section-number">17.1.6</span> The decision</h3>
<p>Should adherence support programs be intensified? How much improvement in suppression could be expected from perfect adherence?</p>
<hr>
</section>
</section>
</section>
<section id="the-problem-with-conditioning-on-adherence" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> 2. The Problem with Conditioning on Adherence</h1>
<p>Before introducing the correct methods, let us understand <strong>why standard approaches fail</strong>.</p>
<section id="why-not-just-adjust-for-adherence-in-a-regression" class="level2" data-number="18.1">
<h2 data-number="18.1" class="anchored" data-anchor-id="why-not-just-adjust-for-adherence-in-a-regression"><span class="header-section-number">18.1</span> Why not just adjust for adherence in a regression?</h2>
<p>Consider a simple model: <span class="math display">\[
\text{logit}\big(P(Y = 1)\big) = \beta_0 + \beta_1 \cdot \text{Cumulative Adherence} + \beta_2 \cdot \text{Baseline CD4}
\]</span></p>
<p>This conditions on adherence. But why is that a problem?</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Conditioning-on-Adherence Trap
</div>
</div>
<div class="callout-body-container callout-body">
<p>The problem is that adherence is <strong>affected by prior health status</strong>, which also affects the outcome. Adherence is simultaneously:</p>
<ul>
<li>A <strong>mediator</strong> (treatment <span class="math inline">\(\to\)</span> adherence <span class="math inline">\(\to\)</span> outcome)</li>
<li>A <strong>collider</strong> when conditioned on (because both health status and unmeasured factors affect it)</li>
</ul>
<p>Conditioning on adherence opens <strong>backdoor paths</strong> through time-varying confounders, introducing selection bias. This is a fundamental result from causal inference theory.</p>
<p><strong>Think of it this way:</strong> If you compare patients who adhered well vs.&nbsp;poorly, you are not comparing like-with-like. Patients who adhered poorly may have done so <em>because</em> they were sicker — and that sickness, not the low adherence, may explain worse outcomes. Conditioning on adherence mixes up the reason for adherence with the effect of adherence.</p>
</div>
</div>
</section>
<section id="visual-intuition" class="level2" data-number="18.2">
<h2 data-number="18.2" class="anchored" data-anchor-id="visual-intuition"><span class="header-section-number">18.2</span> Visual intuition</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Collider Problem in a Diagram
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>    CD4(t-1) -----&gt; Adherence(t) -----&gt; CD4(t) -----&gt; Outcome
       |                ^                  |
       |                |                  |
       +---------&gt; Adherence(t) &lt;----------+
                     (collider when conditioned on)</code></pre>
<p>When you condition on adherence at time <span class="math inline">\(t\)</span>, you induce an association between CD4 at time <span class="math inline">\(t-1\)</span> and unmeasured factors that affect adherence — biasing the effect estimate.</p>
<p><strong>Why does this matter?</strong> Once you “hold adherence fixed” in a regression, you create a spurious link between everything that caused adherence. This is collider bias, and it distorts the causal effect estimate in unpredictable ways — sometimes making the treatment look more effective, sometimes less.</p>
</div>
</div>
</section>
<section id="a-common-mistake-gee-models" class="level2" data-number="18.3">
<h2 data-number="18.3" class="anchored" data-anchor-id="a-common-mistake-gee-models"><span class="header-section-number">18.3</span> A common mistake: GEE models</h2>
<p>Generalized Estimating Equations (GEE) are popular for longitudinal data, but a GEE model that adjusts for time-varying covariates <strong>and</strong> conditions on time-varying treatment (adherence) will produce biased estimates for causal effects when time-varying confounders are affected by prior treatment.</p>
<p><strong>The solution:</strong> Use g-methods (g-computation, IPTW, or TMLE) that properly handle the time-ordering of treatment, confounders, and outcome.</p>
<hr>
</section>
</section>
<section id="causal-roadmap-for-longitudinal-data" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> 3. Causal Roadmap for Longitudinal Data</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 1: Define the Causal Question
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Plain language:</strong> What would the 12-month virologic suppression rate be if every patient maintained high adherence, compared to the naturally observed adherence pattern?</p>
<p><strong>Counterfactual estimand:</strong></p>
<p>Let <span class="math inline">\(\bar{A} = (A_1, A_2, \ldots, A_T)\)</span> denote the adherence history. Define two regimes:</p>
<ul>
<li><strong>Always high adherence:</strong> <span class="math inline">\(d_1: A_t = 1\)</span> for all <span class="math inline">\(t\)</span> (deterministic static regime)</li>
<li><strong>Natural course:</strong> <span class="math inline">\(d_0:\)</span> treatment follows the observed distribution</li>
</ul>
<p>The estimand is:</p>
<p><span class="math display">\[
\psi = E\big[Y(\bar{a} = \bar{1})\big] - E\big[Y^{\text{obs}}\big]
\]</span></p>
<p>where <span class="math inline">\(Y(\bar{a} = \bar{1})\)</span> is the potential outcome under the always-high-adherence regime.</p>
<p>We can also define <strong>stochastic interventions</strong> that shift the probability of high adherence (e.g., increase it by 20%) rather than forcing it to 100% — more realistic and less prone to positivity violations.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 2: Specify the Causal Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>The longitudinal data structure for patient <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[
O_i = \big(W_i, \; L_{i,1}, A_{i,1}, C_{i,1}, \; L_{i,2}, A_{i,2}, C_{i,2}, \; \ldots, \; L_{i,T}, A_{i,T}, C_{i,T}, \; Y_i\big)
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(W\)</span>: baseline covariates (age, sex, baseline CD4, baseline viral load, comorbidities)</li>
<li><span class="math inline">\(L_t\)</span>: time-varying covariates at time <span class="math inline">\(t\)</span> (CD4 count, viral load, symptoms, mental health score)</li>
<li><span class="math inline">\(A_t\)</span>: adherence indicator at time <span class="math inline">\(t\)</span> (1 = high adherence, 0 = low)</li>
<li><span class="math inline">\(C_t\)</span>: censoring at time <span class="math inline">\(t\)</span> (1 = lost to follow-up, 0 = still observed)</li>
<li><span class="math inline">\(Y\)</span>: virologic suppression at 12 months</li>
</ul>
<p><strong>The key causal feature:</strong> <span class="math inline">\(L_t\)</span> is affected by past treatment <span class="math inline">\(\bar{A}_{t-1}\)</span> and also affects future treatment <span class="math inline">\(A_t\)</span> and the outcome <span class="math inline">\(Y\)</span>. This is time-varying confounding affected by prior treatment.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3: State the Assumptions
</div>
</div>
<div class="callout-body-container callout-body">
<p>These assumptions are critical. If they fail, even the best estimator will give biased answers.</p>
<p><strong>Sequential exchangeability:</strong> <span class="math display">\[
Y(\bar{a}) \perp\!\!\!\perp A_t \mid \bar{L}_t, \bar{A}_{t-1}, W \quad \text{for all } t
\]</span> At each time point, treatment is as-good-as-random given the observed history. This is the longitudinal analogue of “no unmeasured confounding.”</p>
<p><strong>Sequential positivity:</strong> <span class="math display">\[
P(A_t = a \mid \bar{L}_t, \bar{A}_{t-1}, W) &gt; 0 \quad \text{for all } t, a
\]</span> Every adherence level must be possible at every time point for every covariate history. Violations occur when certain health states make adherence nearly deterministic.</p>
<p><strong>Consistency:</strong> The observed outcome matches the potential outcome under the treatment actually received.</p>
<p><strong>Independent censoring (conditional):</strong> <span class="math display">\[
Y(\bar{a}) \perp\!\!\!\perp C_t \mid \bar{L}_t, \bar{A}_{t-1}, W \quad \text{for all } t
\]</span> Censoring is independent of potential outcomes given the measured history.</p>
<p><strong>Why does this matter?</strong> If unmeasured factors (e.g., substance use severity, housing instability) drive both adherence and outcomes, sequential exchangeability fails. If some patient subgroups never achieve high adherence, positivity fails. Both scenarios lead to biased estimates, regardless of the statistical method used.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 4: Map to a Statistical Estimand
</div>
</div>
<div class="callout-body-container callout-body">
<p>Under the above assumptions, the G-computation formula for the longitudinal setting is:</p>
<p><span class="math display">\[
E[Y(\bar{a})] = \sum_{\bar{l}} E[Y \mid \bar{A} = \bar{a}, \bar{L} = \bar{l}, W] \prod_t P(L_t = l_t \mid \bar{A}_{t-1}, \bar{L}_{t-1}, W)
\]</span></p>
<p>This is a high-dimensional integral that iterates over all possible covariate histories — practically estimated via sequential regression or TMLE.</p>
<p><strong>The good news:</strong> This formula tells us exactly what we need to estimate. The assumptions above bridge the gap from the causal question (what <em>would</em> happen) to a statistical quantity we can estimate from observed data (what <em>did</em> happen, reweighted or modeled appropriately).</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 5: Choose an Estimation Strategy
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 33%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Approach</th>
<th>Limitation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GEE with time-varying covariates</td>
<td>Conditions on <span class="math inline">\(L_t\)</span> directly</td>
<td>Biased under time-varying confounding</td>
</tr>
<tr class="even">
<td>Marginal structural model (MSM) via IPTW</td>
<td>Reweights by cumulative propensity</td>
<td>Products of weights become extreme</td>
</tr>
<tr class="odd">
<td>Longitudinal G-computation</td>
<td>Sequential outcome regression</td>
<td>Fully parametric; error compounds</td>
</tr>
<tr class="even">
<td>Longitudinal TMLE (LTMLE)</td>
<td>Sequential targeting</td>
<td>Best properties but complex</td>
</tr>
<tr class="odd">
<td>LMTP</td>
<td>Modified treatment policies with TMLE</td>
<td>Handles stochastic interventions naturally</td>
</tr>
</tbody>
</table>
<p>We implement the last two approaches.</p>
<p><strong>Why LTMLE and LMTP?</strong> These methods combine the strengths of outcome modeling and propensity weighting. They handle the feedback loop between treatment and confounders, avoid extreme weights, provide doubly robust estimation, and support flexible machine learning for nuisance parameter estimation.</p>
</div>
</div>
<hr>
</section>
<section id="data-simulation" class="level1" data-number="20">
<h1 data-number="20"><span class="header-section-number">20</span> 4. Data Simulation</h1>
<p>We simulate a realistic longitudinal HIV cohort with 6 monthly time points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.6.0
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>n  <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>T_max <span class="ot">&lt;-</span> <span class="dv">6</span>  <span class="co"># 6 monthly intervals (representing a 12-month follow-up, bi-monthly)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline covariates ---</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>W_age     <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">38</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>W_male    <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.65</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>W_cd4_bl  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">350</span>, <span class="at">sd =</span> <span class="dv">150</span>)  <span class="co"># baseline CD4</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>W_cd4_bl  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">50</span>, W_cd4_bl)               <span class="co"># floor at 50</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>W_vl_bl   <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">4.5</span>, <span class="at">sd =</span> <span class="fl">0.8</span>)  <span class="co"># baseline log10 viral load</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>W_depress <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.30</span>)               <span class="co"># baseline depression</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Containers for longitudinal data ---</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>L_cd4  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)   <span class="co"># time-varying CD4</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>L_sympt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)  <span class="co"># time-varying symptom burden</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>A_adh  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)   <span class="co"># adherence at each time</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>C_cens <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, T_max)    <span class="co"># censoring indicator</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>alive  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">TRUE</span>, n)           <span class="co"># tracking who is still observed</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Simulate longitudinal process ---</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Previous adherence (for t=1, use a starting value)</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    A_prev <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.7</span>)  <span class="co"># initial adherence tendency</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    A_prev <span class="ot">&lt;-</span> A_adh[, t <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    A_prev[<span class="fu">is.na</span>(A_prev)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Previous CD4 (for t=1, use baseline)</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  cd4_prev <span class="ot">&lt;-</span> <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) W_cd4_bl <span class="cf">else</span> L_cd4[, t <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  cd4_prev[<span class="fu">is.na</span>(cd4_prev)] <span class="ot">&lt;-</span> W_cd4_bl[<span class="fu">is.na</span>(cd4_prev)]</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Time-varying CD4 ---</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CD4 increases with adherence, depends on history</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  L_cd4[, t] <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">50</span>,</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    cd4_prev <span class="sc">+</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">30</span> <span class="sc">*</span> A_prev <span class="sc">-</span> <span class="dv">10</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> A_prev), <span class="at">sd =</span> <span class="dv">40</span>) <span class="sc">+</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>) <span class="sc">+</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="dv">20</span> <span class="sc">*</span> W_male</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Time-varying symptom burden ---</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Higher with low CD4, depression; reduced by adherence</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>  L_sympt[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>,</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.003</span> <span class="sc">*</span> L_cd4[, t] <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> W_depress <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> A_prev <span class="sc">+</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>           <span class="fl">0.01</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>))</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Adherence at time t ---</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Affected by: symptoms (reduce adherence), CD4 response (feedback),</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior adherence (habit), depression, age</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>  lp_adh <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">*</span> L_sympt[, t] <span class="sc">+</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.002</span> <span class="sc">*</span> (L_cd4[, t] <span class="sc">-</span> <span class="dv">350</span>) <span class="sc">+</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.6</span> <span class="sc">*</span> A_prev <span class="sc">+</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.7</span> <span class="sc">*</span> W_depress <span class="sc">+</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.01</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>) <span class="sc">+</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.2</span> <span class="sc">*</span> W_male</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>  A_adh[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_adh))</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Censoring ---</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># More likely with low CD4, symptoms, low adherence</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>  lp_cens <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">4.0</span> <span class="sc">+</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.002</span> <span class="sc">*</span> L_cd4[, t] <span class="sc">+</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.5</span> <span class="sc">*</span> L_sympt[, t] <span class="sc">+</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> A_adh[, t] <span class="sc">+</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.5</span> <span class="sc">*</span> W_depress</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  C_cens[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_cens)) <span class="sc">*</span> alive</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  alive <span class="ot">&lt;-</span> alive <span class="sc">&amp;</span> (C_cens[, t] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set future values to NA for censored individuals</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (t <span class="sc">&lt;</span> T_max) {</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    A_adh[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    L_cd4[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    L_sympt[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    C_cens[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome: virologic suppression at end of follow-up ---</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Depends on cumulative adherence, final CD4, baseline VL</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>cum_adh <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(A_adh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>final_cd4 <span class="ot">&lt;-</span> <span class="fu">apply</span>(L_cd4, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  valid <span class="ot">&lt;-</span> x[<span class="sc">!</span><span class="fu">is.na</span>(x)]</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(valid) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">tail</span>(valid, <span class="dv">1</span>) <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>lp_outcome <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.0</span> <span class="sc">+</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.5</span> <span class="sc">*</span> cum_adh <span class="sc">+</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.003</span> <span class="sc">*</span> (final_cd4 <span class="sc">-</span> <span class="dv">350</span>) <span class="sc">+</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">*</span> W_vl_bl <span class="sc">+</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> W_depress <span class="sc">+</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> W_male <span class="sc">+</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.8</span> <span class="sc">*</span> cum_adh <span class="sc">*</span> (final_cd4 <span class="sc">&gt;</span> <span class="dv">400</span>)  <span class="co"># interaction: adherence more effective with good immune response</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>Y_supp <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_outcome))</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Censored individuals: outcome is missing</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>Y_supp[<span class="sc">!</span>alive] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size:"</span>, n, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size: 3000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Censored by end:"</span>, <span class="fu">sum</span>(<span class="sc">!</span>alive), <span class="st">"("</span>, <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(<span class="sc">!</span>alive), <span class="dv">1</span>), <span class="st">"%)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Censored by end: 152 ( 5.1 %)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Among uncensored, suppression rate:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Y_supp[alive]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Among uncensored, suppression rate: 0.344 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean cumulative adherence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(cum_adh, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean cumulative adherence: 0.709 </code></pre>
</div>
</div>
<section id="true-effect-of-perfect-adherence" class="level3" data-number="20.0.1">
<h3 data-number="20.0.1" class="anchored" data-anchor-id="true-effect-of-perfect-adherence"><span class="header-section-number">20.0.1</span> True effect of perfect adherence</h3>
<p>We can compute the counterfactual suppression rate under always-high adherence from the structural model. Since the true DGP is complex (with feedback), we approximate using simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate counterfactual under always-high adherence (A_t = 1 for all t)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>cf_cd4 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>cf_sympt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  cd4_prev_cf <span class="ot">&lt;-</span> <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) W_cd4_bl <span class="cf">else</span> cf_cd4[, t <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  A_prev_cf <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># always high adherence</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  cf_cd4[, t] <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">50</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    cd4_prev_cf <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">30</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">-</span> <span class="dv">10</span> <span class="sc">*</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">40</span>) <span class="sc">+</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>) <span class="sc">+</span> <span class="dv">20</span> <span class="sc">*</span> W_male</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  cf_sympt[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.003</span> <span class="sc">*</span> cf_cd4[, t] <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> W_depress <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>           <span class="fl">0.01</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>))</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>cf_cum_adh <span class="ot">&lt;-</span> <span class="fl">1.0</span>  <span class="co"># perfect adherence</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>cf_final_cd4 <span class="ot">&lt;-</span> cf_cd4[, T_max]</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>lp_cf <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.0</span> <span class="sc">+</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.5</span> <span class="sc">*</span> cf_cum_adh <span class="sc">+</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.003</span> <span class="sc">*</span> (cf_final_cd4 <span class="sc">-</span> <span class="dv">350</span>) <span class="sc">+</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">*</span> W_vl_bl <span class="sc">+</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> W_depress <span class="sc">+</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> W_male <span class="sc">+</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.8</span> <span class="sc">*</span> cf_cum_adh <span class="sc">*</span> (cf_final_cd4 <span class="sc">&gt;</span> <span class="dv">400</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>true_suppression_perfect <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_cf))</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>true_suppression_observed <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_outcome), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True suppression under always-high adherence:"</span>, <span class="fu">round</span>(true_suppression_perfect, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True suppression under always-high adherence: 0.542 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True suppression under observed adherence:   "</span>, <span class="fu">round</span>(true_suppression_observed, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True suppression under observed adherence:    0.336 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True effect of perfect adherence:             "</span>, <span class="fu">round</span>(true_suppression_perfect <span class="sc">-</span> true_suppression_observed, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True effect of perfect adherence:              0.206 </code></pre>
</div>
</div>
</section>
<section id="prepare-data-in-long-format" class="level3" data-number="20.0.2">
<h3 data-number="20.0.2" class="anchored" data-anchor-id="prepare-data-in-long-format"><span class="header-section-number">20.0.2</span> Prepare data in long format</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a wide-format dataframe for analysis</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>dat_wide <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> W_age,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">male =</span> W_male,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd4_bl =</span> W_cd4_bl,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vl_bl =</span> W_vl_bl,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">depress =</span> W_depress</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"cd4_"</span>, t)]]   <span class="ot">&lt;-</span> L_cd4[, t]</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"sympt_"</span>, t)]] <span class="ot">&lt;-</span> L_sympt[, t]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"A_"</span>, t)]]     <span class="ot">&lt;-</span> A_adh[, t]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"C_"</span>, t)]]     <span class="ot">&lt;-</span> C_cens[, t]</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>dat_wide<span class="sc">$</span>Y <span class="ot">&lt;-</span> Y_supp</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co"># For long format (useful for some analyses)</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> dat_wide <span class="sc">%&gt;%</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">matches</span>(<span class="st">"^(cd4|sympt|A|C)_</span><span class="sc">\\</span><span class="st">d+$"</span>),</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"time"</span>),</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"(</span><span class="sc">\\</span><span class="st">w+)_(</span><span class="sc">\\</span><span class="st">d+)"</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.integer</span>(time)) <span class="sc">%&gt;%</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, time)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 18,000
Columns: 12
$ id      &lt;int&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4,…
$ age     &lt;dbl&gt; 43.20589, 43.20589, 43.20589, 43.20589, 43.20589, 43.20589, 27…
$ male    &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ cd4_bl  &lt;dbl&gt; 105.6647, 105.6647, 105.6647, 105.6647, 105.6647, 105.6647, 17…
$ vl_bl   &lt;dbl&gt; 3.480404, 3.480404, 3.480404, 3.480404, 3.480404, 3.480404, 4.…
$ depress &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ Y       &lt;int&gt; 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ time    &lt;int&gt; 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 1, 2, 3,…
$ cd4     &lt;dbl&gt; 129.7946, 142.5491, 252.5217, 315.5199, 421.1039, 450.3287, 23…
$ sympt   &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ A       &lt;int&gt; 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0,…
$ C       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="the-naive-biased-approach" class="level1" data-number="21">
<h1 data-number="21"><span class="header-section-number">21</span> 5. The Naive (Biased) Approach</h1>
<p>First, let us see what happens if we ignore the time-varying confounding structure.</p>
<section id="a.-cross-sectional-regression-on-cumulative-adherence" class="level2" data-number="21.1">
<h2 data-number="21.1" class="anchored" data-anchor-id="a.-cross-sectional-regression-on-cumulative-adherence"><span class="header-section-number">21.1</span> 5A. Cross-sectional regression on cumulative adherence</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only among uncensored</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>dat_complete <span class="ot">&lt;-</span> dat_wide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Y))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>dat_complete<span class="sc">$</span>cum_adh <span class="ot">&lt;-</span> cum_adh[alive]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>naive_gee <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> cum_adh <span class="sc">+</span> cd4_bl <span class="sc">+</span> vl_bl <span class="sc">+</span> depress <span class="sc">+</span> age <span class="sc">+</span> male,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat_complete)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted suppression at 100% vs 50% adherence</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>nd_perfect <span class="ot">&lt;-</span> dat_complete <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">cum_adh =</span> <span class="fl">1.0</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>nd_half    <span class="ot">&lt;-</span> dat_complete <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">cum_adh =</span> <span class="fl">0.5</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>naive_perfect <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(naive_gee, <span class="at">newdata =</span> nd_perfect, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>naive_half    <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(naive_gee, <span class="at">newdata =</span> nd_half, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive model:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Naive model:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Predicted suppression at 100% adherence:"</span>, <span class="fu">round</span>(naive_perfect, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Predicted suppression at 100% adherence: 0.568 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Predicted suppression at 50% adherence: "</span>, <span class="fu">round</span>(naive_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Predicted suppression at 50% adherence:  0.159 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Difference:"</span>, <span class="fu">round</span>(naive_perfect <span class="sc">-</span> naive_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Difference: 0.409 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">This estimate is biased because it conditions on post-treatment variables.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
This estimate is biased because it conditions on post-treatment variables.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Is This Wrong?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The model treats cumulative adherence as a fixed baseline variable, but adherence is:</p>
<ol type="1">
<li><strong>Affected by time-varying CD4 and symptoms</strong> (confounders) — patients who feel worse adhere less, and feeling worse also worsens the outcome directly</li>
<li><strong>Itself affects future CD4 and symptoms</strong> (it is a treatment) — taking medication changes the very health indicators that influence future adherence</li>
<li><strong>A collider</strong> when conditioned on — because both health status and unmeasured factors drive adherence decisions</li>
</ol>
<p>The estimate conflates the causal effect of adherence with the reverse causal effect of health on adherence. You cannot untangle “does adherence improve outcomes?” from “do better outcomes sustain adherence?” using standard regression.</p>
<p><strong>The fundamental issue:</strong> Standard regression assumes covariates are fixed. But in a longitudinal feedback loop, today’s treatment changes tomorrow’s confounders, which change the day after’s treatment. No single regression equation can properly account for this temporal cascade.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="iptw-for-marginal-structural-models" class="level1" data-number="22">
<h1 data-number="22"><span class="header-section-number">22</span> 6. IPTW for Marginal Structural Models</h1>
<p>The first correct approach is IPTW, which avoids conditioning on time-varying confounders by reweighting.</p>
<section id="estimate-treatment-weights-at-each-time-point" class="level3" data-number="22.0.1">
<h3 data-number="22.0.1" class="anchored" data-anchor-id="estimate-treatment-weights-at-each-time-point"><span class="header-section-number">22.0.1</span> Estimate treatment weights at each time point</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Work in long format; only uncensored observations</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>dat_long_uc <span class="ot">&lt;-</span> dat_long <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">cumall</span>(<span class="sc">!</span><span class="fu">is.na</span>(A))) <span class="sc">%&gt;%</span>  <span class="co"># keep complete treatment histories</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Propensity model at each time point</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># P(A_t = 1 | history)</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>dat_long_uc <span class="ot">&lt;-</span> dat_long_uc <span class="sc">%&gt;%</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_lag =</span> <span class="fu">lag</span>(<span class="fu">as.double</span>(A), <span class="at">default =</span> <span class="fl">0.7</span>),  <span class="co"># lagged adherence</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">cd4_lag =</span> <span class="fu">lag</span>(cd4, <span class="at">default =</span> <span class="fu">first</span>(cd4))</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Time-specific propensity models</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>g_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>dat_long_uc<span class="sc">$</span>ps_t <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>dat_long_uc<span class="sc">$</span>ps_num_t <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t_val <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> dat_long_uc<span class="sc">$</span>time <span class="sc">==</span> t_val</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  dat_t <span class="ot">&lt;-</span> dat_long_uc[idx, ]</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  g_t <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> cd4 <span class="sc">+</span> sympt <span class="sc">+</span> A_lag <span class="sc">+</span> depress <span class="sc">+</span> age <span class="sc">+</span> male <span class="sc">+</span> vl_bl,</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat_t)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  g_models[[t_val]] <span class="ot">&lt;-</span> g_t</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>  ps_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_t, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stabilized numerator: P(A_t | baseline, past A)</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>  g_num_t <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> A_lag <span class="sc">+</span> age <span class="sc">+</span> male,</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat_t)</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>  ps_num <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_num_t, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>  dat_long_uc<span class="sc">$</span>ps_t[idx] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    dat_t<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, ps_pred, <span class="dv">1</span> <span class="sc">-</span> ps_pred</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>  dat_long_uc<span class="sc">$</span>ps_num_t[idx] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    dat_t<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, ps_num, <span class="dv">1</span> <span class="sc">-</span> ps_num</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Any remaining NA (shouldn't happen, but safety net)</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>dat_long_uc<span class="sc">$</span>ps_num_t[<span class="fu">is.na</span>(dat_long_uc<span class="sc">$</span>ps_num_t)] <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compute-cumulative-weights" class="level3" data-number="22.0.2">
<h3 data-number="22.0.2" class="anchored" data-anchor-id="compute-cumulative-weights"><span class="header-section-number">22.0.2</span> Compute cumulative weights</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative product of time-specific propensity scores</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>weight_df <span class="ot">&lt;-</span> dat_long_uc <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cum_ps_denom =</span> <span class="fu">prod</span>(ps_t, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cum_adh =</span> <span class="fu">mean</span>(A, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Stabilized weights (using marginal model in numerator)</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>weight_df<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> weight_df<span class="sc">$</span>cum_ps_denom</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge outcome</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>weight_df <span class="ot">&lt;-</span> weight_df <span class="sc">%&gt;%</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dat_wide <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, Y), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Y))</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Truncate extreme weights</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>w99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(weight_df<span class="sc">$</span>sw, <span class="fl">0.99</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>weight_df<span class="sc">$</span>sw_trunc <span class="ot">&lt;-</span> <span class="fu">pmin</span>(weight_df<span class="sc">$</span>sw, w99)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Weight summary (truncated):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Weight summary (truncated):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weight_df<span class="sc">$</span>sw_trunc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.473  13.231  28.079  60.936  73.400 565.277 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot weight distribution</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weight_df, <span class="fu">aes</span>(<span class="at">x =</span> sw_trunc)) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#228833"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stabilized cumulative IPTW weight (truncated at 99th pctile)"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of Longitudinal IPTW Weights"</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-07-longitudinal-td-confounding_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Beware: Extreme Cumulative Weights
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cumulative weights from longitudinal IPTW are <strong>products</strong> of time-specific weights. Even with modest individual weights (e.g., each between 0.5 and 2.0), the product over 6 or 12 time points can become extreme.</p>
<p><strong>Why this happens:</strong> If a patient’s observed treatment history is unlikely under the model (e.g., they adhered despite many risk factors for non-adherence), their cumulative weight <span class="math inline">\(w = \prod_{t=1}^{T} 1/g_t\)</span> can explode. A few such patients can dominate the entire weighted analysis.</p>
<p><strong>Practical consequences:</strong></p>
<ul>
<li>A single patient with weight 500 can outweigh hundreds of others combined</li>
<li>Truncating weights introduces bias but reduces variance — a delicate trade-off</li>
<li>Confidence intervals become unreliable when weights are extreme</li>
<li>Weight instability gets worse with more time points</li>
</ul>
<p>This is a well-known limitation of longitudinal IPTW and a key reason to prefer TMLE-based methods, which incorporate treatment information through numerically stable logistic fluctuation models rather than multiplicative weights.</p>
</div>
</div>
</section>
<section id="weighted-outcome-model" class="level3" data-number="22.0.3">
<h3 data-number="22.0.3" class="anchored" data-anchor-id="weighted-outcome-model"><span class="header-section-number">22.0.3</span> Weighted outcome model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MSM: weighted regression of outcome on cumulative adherence</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>msm_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> cum_adh, <span class="at">family =</span> binomial,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights =</span> sw_trunc, <span class="at">data =</span> weight_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in eval(family$initialize): non-integer #successes in a binomial glm!</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted suppression under perfect vs half adherence</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>msm_perfect <span class="ot">&lt;-</span> <span class="fu">predict</span>(msm_fit,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">cum_adh =</span> <span class="fl">1.0</span>),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>msm_half <span class="ot">&lt;-</span> <span class="fu">predict</span>(msm_fit,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">cum_adh =</span> <span class="fl">0.5</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW-MSM estimate:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW-MSM estimate:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression at 100% adherence:"</span>, <span class="fu">round</span>(msm_perfect, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Suppression at 100% adherence: 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression at 50% adherence: "</span>, <span class="fu">round</span>(msm_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Suppression at 50% adherence:  0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Difference:"</span>, <span class="fu">round</span>(msm_perfect <span class="sc">-</span> msm_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Difference: 1 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="longitudinal-tmle-conceptual-overview" class="level1" data-number="23">
<h1 data-number="23"><span class="header-section-number">23</span> 7. Longitudinal TMLE: Conceptual Overview</h1>
<p>Longitudinal TMLE extends the point-treatment TMLE from Chapter 2.4 to the time-varying setting. The core idea is the same — fit initial models, then target them — but now we work backwards through time.</p>
<section id="the-algorithm-simplified" class="level3" data-number="23.0.1">
<h3 data-number="23.0.1" class="anchored" data-anchor-id="the-algorithm-simplified"><span class="header-section-number">23.0.1</span> The algorithm (simplified)</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 1: Outcome Model — Start at the End
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Start at the final time point</strong> <span class="math inline">\(T\)</span> and fit the outcome model:</p>
<p><span class="math display">\[\hat{Q}_T(\bar{A}_T, \bar{L}_T, W) = E[Y \mid \bar{A}_T, \bar{L}_T, W]\]</span></p>
<p>This is the same initial outcome regression as in point-treatment TMLE — estimate the expected outcome given the full observed history. The difference is that “history” now includes treatment and covariates at every time point.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 2: Propensity Scores — One at Every Time Point
</div>
</div>
<div class="callout-body-container callout-body">
<p>Estimate the treatment mechanism at each time <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[g_t = P(A_t \mid \bar{A}_{t-1}, \bar{L}_t, W)\]</span></p>
<p>Unlike point-treatment TMLE which has a single propensity score, here you need <span class="math inline">\(T\)</span> separate propensity models — one for each treatment decision. Each conditions on the full history available at that time point.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3: Clever Covariates — Cumulative Inverse Probabilities
</div>
</div>
<div class="callout-body-container callout-body">
<p>For each time <span class="math inline">\(t\)</span> from <span class="math inline">\(T\)</span> down to 1, compute the clever covariate using the cumulative treatment probability:</p>
<p><span class="math display">\[H_t = \frac{I(\bar{A}_t = \bar{a}_t)}{\prod_{s=1}^{t} \hat{g}_s}\]</span></p>
<p>The clever covariate at time <span class="math inline">\(t\)</span> involves the product of all propensity scores up to that time. This is what links the treatment model to the outcome model at each step of the backwards iteration.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 4: Targeting — Update Backwards Through Time
</div>
</div>
<div class="callout-body-container callout-body">
<p>For each time <span class="math inline">\(t\)</span> from <span class="math inline">\(T\)</span> down to 1, run a targeting (fluctuation) step to update <span class="math inline">\(\hat{Q}_t\)</span>:</p>
<ol type="1">
<li>Regress the outcome (or pseudo-outcome from the next step) on the clever covariate <span class="math inline">\(H_t\)</span> with the logit of <span class="math inline">\(\hat{Q}_t\)</span> as offset</li>
<li>Use the estimated fluctuation parameter <span class="math inline">\(\hat{\epsilon}_t\)</span> to update predictions</li>
</ol>
<p><strong>Then average</strong> the targeted predictions under the intervention of interest.</p>
<p>Each targeting step corrects the outcome model at that time point using information from the treatment model, achieving sequential double robustness.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How Does This Handle Time-Dependent Confounding?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The backwards iteration is the key. At each step:</p>
<ul>
<li><strong>Conditioning on <span class="math inline">\(L_t\)</span></strong> in the outcome model at time <span class="math inline">\(t\)</span> correctly adjusts for confounding of <span class="math inline">\(A_t\)</span></li>
<li><strong>Integrating out <span class="math inline">\(L_t\)</span></strong> in the backwards regression from time <span class="math inline">\(t\)</span> to <span class="math inline">\(t-1\)</span> preserves the mediated effect of <span class="math inline">\(A_{t-1}\)</span> through <span class="math inline">\(L_t\)</span></li>
</ul>
<p>This is exactly the dilemma that standard regression cannot solve: you need to adjust for <span class="math inline">\(L_t\)</span> as a confounder of <span class="math inline">\(A_t\)</span> but not block it as a mediator of <span class="math inline">\(A_{t-1}\)</span>. The sequential backwards structure does both, by conditioning on <span class="math inline">\(L_t\)</span> only at the time step where it is a confounder and then marginalizing over it at the step where it is a mediator.</p>
<p><strong>In plain language:</strong> L-TMLE “peels off” one layer of time-varying confounding at each step, working from the outcome back to baseline. By the time it reaches the first treatment decision, all the intermediate confounders have been properly handled.</p>
</div>
</div>
</section>
<section id="why-ltmle-is-better-than-longitudinal-iptw" class="level3" data-number="23.0.2">
<h3 data-number="23.0.2" class="anchored" data-anchor-id="why-ltmle-is-better-than-longitudinal-iptw"><span class="header-section-number">23.0.2</span> Why LTMLE is better than longitudinal IPTW</h3>
<ul>
<li>Does not require computing cumulative weight products (avoids extreme weights)</li>
<li>Doubly robust at each time step</li>
<li>Can incorporate Super Learner for each nuisance model</li>
<li>Provides efficient influence curve-based inference</li>
</ul>
</section>
<section id="packages" class="level3" data-number="23.0.3">
<h3 data-number="23.0.3" class="anchored" data-anchor-id="packages"><span class="header-section-number">23.0.3</span> Packages</h3>
<ul>
<li><strong>ltmle:</strong> The <code>ltmle</code> R package implements longitudinal TMLE for binary and continuous treatments with censoring</li>
<li><strong>lmtp:</strong> The <code>lmtp</code> package implements a more general framework for modified treatment policies (static, dynamic, and stochastic interventions) using TMLE</li>
</ul>
<hr>
</section>
</section>
<section id="implementing-longitudinal-tmle" class="level1" data-number="24">
<h1 data-number="24"><span class="header-section-number">24</span> 8. Implementing Longitudinal TMLE</h1>
<p>We demonstrate a simplified by-hand longitudinal TMLE for the static “always treat” regime, then show the package interface.</p>
<section id="by-hand-sequential-regression-approach" class="level3" data-number="24.0.1">
<h3 data-number="24.0.1" class="anchored" data-anchor-id="by-hand-sequential-regression-approach"><span class="header-section-number">24.0.1</span> By-hand sequential regression approach</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Outcome Model: Initial Sequential Regression
</div>
</div>
<div class="callout-body-container callout-body">
<p>First, fit the outcome model at the final time step — <span class="math inline">\(Q_T = E[Y \mid A_T, L_T, \ldots, W]\)</span> — using all available information. Then predict under the counterfactual where all treatment decisions are set to “high adherence.”</p>
<p>This is the starting point: a G-computation estimate that would be correct if the outcome model is perfectly specified, but may be biased otherwise. The targeting steps below will correct this.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Work with complete cases for the by-hand demonstration</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>dat_analysis <span class="ot">&lt;-</span> dat_wide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Y))</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 1: Fit outcome model at the final time step ---</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Q_T = E[Y | A_T, L_T, ..., W]</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We use all available information</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct features for the final outcome model</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>dat_analysis <span class="ot">&lt;-</span> dat_analysis <span class="sc">%&gt;%</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">cum_adh =</span> <span class="fu">rowMeans</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"A_"</span>)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">last_cd4 =</span> cd4_6,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">last_sympt =</span> sympt_6</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial outcome regression</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>Q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A_1 <span class="sc">+</span> A_2 <span class="sc">+</span> A_3 <span class="sc">+</span> A_4 <span class="sc">+</span> A_5 <span class="sc">+</span> A_6 <span class="sc">+</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>               cd4_bl <span class="sc">+</span> vl_bl <span class="sc">+</span> depress <span class="sc">+</span> age <span class="sc">+</span> male <span class="sc">+</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>               cd4_6 <span class="sc">+</span> sympt_6,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat_analysis)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict under always-high adherence (all A_t = 1)</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>dat_cf <span class="ot">&lt;-</span> dat_analysis <span class="sc">%&gt;%</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"A_"</span>), <span class="sc">~</span><span class="dv">1</span>))</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>Q_star <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">newdata =</span> dat_cf, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sequential G-computation estimate (no targeting):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sequential G-computation estimate (no targeting):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression under always-high adherence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Q_star), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Suppression under always-high adherence: 0.511 </code></pre>
</div>
</div>
</section>
<section id="iterative-targeting-simplified-2-step" class="level3" data-number="24.0.2">
<h3 data-number="24.0.2" class="anchored" data-anchor-id="iterative-targeting-simplified-2-step"><span class="header-section-number">24.0.2</span> Iterative targeting (simplified 2-step)</h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Propensity Scores: Modeling Treatment at Each Time Point
</div>
</div>
<div class="callout-body-container callout-body">
<p>We estimate <span class="math inline">\(P(A_t = 1 \mid \text{history}_t)\)</span> at each time point. In this simplified demonstration, we model the cumulative probability of the full “always treat” regime as the product of time-specific propensities.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Propensity scores for cumulative treatment ---</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified: model P(all A_t = 1 | W) as product of marginals</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This is an approximation for demonstration</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>g_cum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(dat_analysis))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t_val <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  A_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  A_lag_col <span class="ot">&lt;-</span> <span class="cf">if</span>(t_val <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val <span class="sc">-</span> <span class="dv">1</span>) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  cd4_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"cd4_"</span>, t_val)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  sympt_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"sympt_"</span>, t_val)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(cd4_col, sympt_col, <span class="st">"depress"</span>, <span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"vl_bl"</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(A_lag_col)) formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(formula_vars, A_lag_col)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  g_t_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.formula</span>(<span class="fu">paste</span>(A_col, <span class="st">"~"</span>, <span class="fu">paste</span>(formula_vars, <span class="at">collapse =</span> <span class="st">" + "</span>))),</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial, <span class="at">data =</span> dat_analysis</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>  g_t_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_t_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  g_cum <span class="ot">&lt;-</span> g_cum <span class="sc">*</span> g_t_pred  <span class="co"># cumulative probability of always-treated</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Bound away from zero</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>g_cum <span class="ot">&lt;-</span> <span class="fu">pmax</span>(g_cum, <span class="fl">0.001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Clever Covariate: Bridging Outcome and Treatment Models
</div>
</div>
<div class="callout-body-container callout-body">
<p>The clever covariate for the “always treat” intervention is:</p>
<p><span class="math display">\[H = \frac{I(\text{all } A_t = 1)}{g_{\text{cum}}}\]</span></p>
<p>For patients who followed the regime at every time point, <span class="math inline">\(H\)</span> equals the inverse of their cumulative probability of doing so. For patients who deviated at any point, <span class="math inline">\(H = 0\)</span>. This is the same logic as point-treatment TMLE’s <span class="math inline">\(H = I(A=1)/g(W)\)</span>, extended to the full treatment history.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for the "always treat" intervention</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># H = I(all A_t = 1) / g_cum</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>all_treated <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(dat_analysis <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"A_"</span>))) <span class="sc">==</span> T_max</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>H_clever <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(all_treated) <span class="sc">/</span> g_cum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Targeting Step: Updating the Initial Estimates
</div>
</div>
<div class="callout-body-container callout-body">
<p>Run a logistic regression of <span class="math inline">\(Y\)</span> on <span class="math inline">\(H\)</span> with the logit of <span class="math inline">\(\hat{Q}\)</span> as an offset. The coefficient <span class="math inline">\(\hat{\epsilon}\)</span> is the fluctuation parameter that corrects the initial outcome model to be unbiased for our specific estimand.</p>
<p><span class="math display">\[\text{logit}(Y) = \text{logit}(\hat{Q}) + \epsilon \cdot H\]</span></p>
<p>Then update the counterfactual predictions:</p>
<p><span class="math display">\[\hat{Q}^* = \text{expit}(\text{logit}(\hat{Q}_{\text{cf}}) + \hat{\epsilon} \cdot H_{\text{cf}})\]</span></p>
<p>where <span class="math inline">\(H_{\text{cf}} = 1/g_{\text{cum}}\)</span> because under the intervention, everyone is treated.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Targeting step</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>Q_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>fluc_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat_analysis<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(Q_init)) <span class="sc">+</span> H_clever,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc_mod)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Update counterfactual predictions</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>H_cf <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> g_cum  <span class="co"># under the intervention, everyone is treated</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>Q_targeted <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q_star) <span class="sc">+</span> epsilon <span class="sc">*</span> H_cf)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Targeted estimate (simplified LTMLE):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Targeted estimate (simplified LTMLE):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression under always-high adherence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Q_targeted), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Suppression under always-high adherence: 0.491 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Epsilon:"</span>, <span class="fu">round</span>(epsilon, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Epsilon: -0.00528 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Just Happened?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The targeting step nudged the initial G-computation predictions toward the truth by incorporating information from the treatment model. Here is the intuition:</p>
<ul>
<li>If the outcome model was <strong>already correct</strong>, the fluctuation parameter <span class="math inline">\(\epsilon\)</span> will be close to zero — no correction needed</li>
<li>If the outcome model was <strong>biased</strong>, the clever covariate <span class="math inline">\(H\)</span> steers the correction in the right direction, using the treatment mechanism as a guide</li>
</ul>
<p>The result is <strong>double robustness</strong>: the final estimate is consistent if either the outcome model <span class="math inline">\(\hat{Q}\)</span> or the treatment model <span class="math inline">\(\hat{g}\)</span> is correctly specified. Neither needs to be perfect on its own — they compensate for each other’s errors.</p>
</div>
</div>
</section>
<section id="influence-curve-based-inference" class="level3" data-number="24.0.3">
<h3 data-number="24.0.3" class="anchored" data-anchor-id="influence-curve-based-inference"><span class="header-section-number">24.0.3</span> Influence-curve based inference</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># EIC for the always-treat estimand</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>psi_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q_targeted)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>eic_long <span class="ot">&lt;-</span> H_cf <span class="sc">*</span> (dat_analysis<span class="sc">$</span>Y <span class="sc">-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_clever)) <span class="sc">+</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>            Q_targeted <span class="sc">-</span> psi_hat</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>se_long <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic_long) <span class="sc">/</span> <span class="fu">nrow</span>(dat_analysis))</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>ci_long <span class="ot">&lt;-</span> psi_hat <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> se_long</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Simplified LTMLE for always-high adherence:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simplified LTMLE for always-high adherence:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Estimate:"</span>, <span class="fu">round</span>(psi_hat, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Estimate: 0.491 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SE:"</span>, <span class="fu">round</span>(se_long, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SE: 0.523 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  95% CI: ["</span>, <span class="fu">round</span>(ci_long[<span class="dv">1</span>], <span class="dv">3</span>), <span class="st">","</span>, <span class="fu">round</span>(ci_long[<span class="dv">2</span>], <span class="dv">3</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  95% CI: [ -0.535 , 1.517 ]</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="using-the-lmtp-package" class="level1" data-number="25">
<h1 data-number="25"><span class="header-section-number">25</span> 9. Using the LMTP Package</h1>
<p>The <code>lmtp</code> package provides a clean interface for estimating effects of longitudinal modified treatment policies. It handles:</p>
<ul>
<li>Static interventions (always treat)</li>
<li>Dynamic interventions (treat based on covariate values)</li>
<li>Stochastic interventions (shift treatment probabilities)</li>
<li>Censoring adjustment</li>
<li>Super Learner integration</li>
</ul>
<section id="lmtp-interface-conceptual" class="level3" data-number="25.0.1">
<h3 data-number="25.0.1" class="anchored" data-anchor-id="lmtp-interface-conceptual"><span class="header-section-number">25.0.1</span> LMTP interface (conceptual)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtp)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the shift function for "always high adherence"</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>always_adhere <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) {</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define variable names</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>trt_vars <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>cens_vars <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"C_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"cd4_bl"</span>, <span class="st">"vl_bl"</span>, <span class="st">"depress"</span>)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>tv_vars <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"cd4_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>),</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"sympt_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Run LMTP-TMLE</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>result_lmtp <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat_wide,</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">trt =</span> trt_vars,</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline =</span> baseline_vars,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_vary =</span> tv_vars,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">cens =</span> cens_vars,</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">shift =</span> always_adhere,</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_type =</span> <span class="st">"binomial"</span>,</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_outcome =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.glmnet"</span>),</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_trt =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.glmnet"</span>),</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">folds =</span> <span class="dv">5</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="co"># View results</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>result_lmtp</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Confidence interval</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(result_lmtp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="stochastic-intervention-shift-adherence-probability" class="level3" data-number="25.0.2">
<h3 data-number="25.0.2" class="anchored" data-anchor-id="stochastic-intervention-shift-adherence-probability"><span class="header-section-number">25.0.2</span> Stochastic intervention: shift adherence probability</h3>
<p>A more realistic intervention does not force 100% adherence but increases the probability of high adherence:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift function: increase P(A=1) by 20 percentage points</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># but cap at 1</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>shift_adherence <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) {</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmin</span>(data[[trt]] <span class="sc">+</span> <span class="fl">0.2</span>, <span class="dv">1</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>result_shift <span class="ot">&lt;-</span> <span class="fu">lmtp_tmle</span>(</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat_wide,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">trt =</span> trt_vars,</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline =</span> baseline_vars,</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_vary =</span> tv_vars,</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">cens =</span> cens_vars,</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">shift =</span> shift_adherence,</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_type =</span> <span class="st">"binomial"</span>,</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_outcome =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.glmnet"</span>),</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners_trt =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.glmnet"</span>),</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">folds =</span> <span class="dv">5</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>result_shift</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Stochastic Interventions?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stochastic interventions mitigate positivity violations by only shifting treatment probabilities rather than forcing them to 0 or 1. This makes the estimand more realistic — no intervention can achieve 100% adherence.</p>
<p><strong>Three reasons to prefer stochastic interventions:</strong></p>
<ol type="1">
<li><p><strong>Realistic estimands:</strong> Asking “what if we increased the probability of adherence by 20%?” is more actionable than “what if everyone adhered perfectly?” No real-world program achieves perfect adherence.</p></li>
<li><p><strong>Positivity preservation:</strong> If some patients have near-zero probability of adhering (e.g., due to severe side effects), a static “always adhere” intervention violates positivity for those patients. A shift intervention only moves probabilities incrementally, staying within the support of the observed data.</p></li>
<li><p><strong>Policy relevance:</strong> Decision-makers want to know the expected benefit of feasible interventions (SMS reminders, pill organizers, peer support) that shift adherence by realistic amounts — not the theoretical maximum under impossible conditions.</p></li>
</ol>
<p>The <code>lmtp</code> package makes stochastic interventions as easy to implement as static ones — you just change the shift function.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="comparison-gee-vs.-iptw-msm-vs.-ltmle" class="level1" data-number="26">
<h1 data-number="26"><span class="header-section-number">26</span> 10. Comparison: GEE vs.&nbsp;IPTW-MSM vs.&nbsp;LTMLE</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Naive regression (biased)"</span>,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">"IPTW-MSM (truncated weights)"</span>,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Simplified LTMLE"</span>),</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Approach =</span> <span class="fu">c</span>(<span class="st">"Conditions on cumulative adherence"</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Reweights by cumulative propensity"</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Sequential targeting with EIC inference"</span>),</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Issue =</span> <span class="fu">c</span>(<span class="st">"Confounded by time-varying health"</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Extreme cumulative weights"</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"More complex but doubly robust"</span>)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>comparison</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  Method                       Approach                                Issue    
  &lt;chr&gt;                        &lt;chr&gt;                                   &lt;chr&gt;    
1 Naive regression (biased)    Conditions on cumulative adherence      Confound…
2 IPTW-MSM (truncated weights) Reweights by cumulative propensity      Extreme …
3 Simplified LTMLE             Sequential targeting with EIC inference More com…</code></pre>
</div>
</div>
<hr>
</section>
<section id="diagnostics-for-longitudinal-settings" class="level1" data-number="27">
<h1 data-number="27"><span class="header-section-number">27</span> 11. Diagnostics for Longitudinal Settings</h1>
<section id="time-specific-propensity-score-overlap" class="level2" data-number="27.1">
<h2 data-number="27.1" class="anchored" data-anchor-id="time-specific-propensity-score-overlap"><span class="header-section-number">27.1</span> 11.1 Time-specific propensity score overlap</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check overlap at each time point</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>overlap_checks <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t_val <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  A_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  cd4_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"cd4_"</span>, t_val)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  sympt_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"sympt_"</span>, t_val)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(cd4_col, sympt_col, <span class="st">"depress"</span>, <span class="st">"age"</span>, <span class="st">"male"</span>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (t_val <span class="sc">&gt;</span> <span class="dv">1</span>) formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(formula_vars, <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>  g_check <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.formula</span>(<span class="fu">paste</span>(A_col, <span class="st">"~"</span>, <span class="fu">paste</span>(formula_vars, <span class="at">collapse =</span> <span class="st">" + "</span>))),</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial, <span class="at">data =</span> dat_analysis</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  ps_check <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_check, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>  overlap_checks[[t_val]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> t_val,</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps =</span> ps_check,</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> dat_analysis[[A_col]]</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>overlap_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(overlap_checks)</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(overlap_df, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low adherence"</span>, <span class="st">"High adherence"</span>)))) <span class="sc">+</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">paste</span>(<span class="st">"Time"</span>, time), <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"P(A_t = 1 | history)"</span>,</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Adherence"</span>,</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Overlap by Time Point"</span></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#EE6677"</span>, <span class="st">"#228833"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-07-longitudinal-td-confounding_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cumulative-weight-distribution" class="level2" data-number="27.2">
<h2 data-number="27.2" class="anchored" data-anchor-id="cumulative-weight-distribution"><span class="header-section-number">27.2</span> 11.2 Cumulative weight distribution</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cumulative IPTW weight summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cumulative IPTW weight summary:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Before truncation:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Before truncation:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weight_df<span class="sc">$</span>sw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
   1.473   13.231   28.079   64.916   73.400 2508.131 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">After truncation:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
After truncation:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weight_df<span class="sc">$</span>sw_trunc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.473  13.231  28.079  60.936  73.400 565.277 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Fraction &gt; 10:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(weight_df<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Fraction &gt; 10: 0.778 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction &gt; 50:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(weight_df<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">50</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fraction &gt; 50: 0.357 </code></pre>
</div>
</div>
<p>Large fractions of extreme weights indicate that the longitudinal treatment mechanism is poorly estimated or that positivity is violated. This motivates using LTMLE over IPTW.</p>
</section>
<section id="adherence-patterns-over-time" class="level2" data-number="27.3">
<h2 data-number="27.3" class="anchored" data-anchor-id="adherence-patterns-over-time"><span class="header-section-number">27.3</span> 11.3 Adherence patterns over time</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize adherence trajectories</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>adh_summary <span class="ot">&lt;-</span> dat_long <span class="sc">%&gt;%</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(A)) <span class="sc">%&gt;%</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_adherent =</span> <span class="fu">mean</span>(A),</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(adh_summary, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pct_adherent)) <span class="sc">+</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#4477AA"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"#4477AA"</span>) <span class="sc">+</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time point"</span>,</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Proportion with high adherence"</span>,</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Adherence Over Time"</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-07-longitudinal-td-confounding_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="imperfect-adherence-as-an-intercurrent-event" class="level1" data-number="28">
<h1 data-number="28"><span class="header-section-number">28</span> 12. Imperfect Adherence as an Intercurrent Event</h1>
<p>In the ICH E9(R1) framework for clinical trials, adherence departures are <strong>intercurrent events</strong> that affect the interpretation of treatment effects.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Estimand Strategies for Adherence
</div>
</div>
<div class="callout-body-container callout-body">
<p>The ICH E9(R1) framework provides four strategies for handling intercurrent events like imperfect adherence. Each answers a different scientific question:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 45%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Strategy</th>
<th>Interpretation</th>
<th>Method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Treatment policy</td>
<td>Effect of being assigned treatment, regardless of adherence</td>
<td>ITT / standard comparison</td>
</tr>
<tr class="even">
<td>Hypothetical</td>
<td>Effect if adherence had been maintained</td>
<td>Longitudinal TMLE / LMTP</td>
</tr>
<tr class="odd">
<td>While on treatment</td>
<td>Effect among the period of actual adherence</td>
<td>Censoring-based methods</td>
</tr>
<tr class="even">
<td>Composite</td>
<td>Adherence departure is part of the outcome</td>
<td>Modified outcome</td>
</tr>
</tbody>
</table>
<p><strong>Longitudinal TMLE and LMTP directly estimate the hypothetical strategy</strong> — they estimate what would have happened under a counterfactual adherence pattern. This is the most relevant estimand for evaluating whether a treatment works when taken properly.</p>
<p><strong>Why does this matter?</strong> Choosing the wrong estimand strategy leads to answering the wrong question. If a drug works when taken but patients stop taking it due to side effects, the treatment policy estimand (ITT) will understate efficacy. The hypothetical estimand answers “does the drug work?” while the treatment policy estimand answers “does prescribing the drug work?” — both are valid but serve different decisions.</p>
</div>
</div>
<hr>
</section>
<section id="interpretation" class="level1" data-number="29">
<h1 data-number="29"><span class="header-section-number">29</span> 13. Interpretation</h1>
<section id="what-would-we-tell-the-public-health-agency" class="level2" data-number="29.1">
<h2 data-number="29.1" class="anchored" data-anchor-id="what-would-we-tell-the-public-health-agency"><span class="header-section-number">29.1</span> What would we tell the public health agency?</h2>
<p>Based on our analysis:</p>
<ul>
<li>Under the naturally observed adherence pattern, approximately 34% of patients achieve virologic suppression at 12 months</li>
<li>Under a hypothetical always-high-adherence intervention, the estimated suppression rate is approximately 49%</li>
<li>The estimated benefit of ensuring high adherence is approximately 14.7 percentage points of additional suppression</li>
</ul>
</section>
<section id="implications-for-adherence-support-programs" class="level2" data-number="29.2">
<h2 data-number="29.2" class="anchored" data-anchor-id="implications-for-adherence-support-programs"><span class="header-section-number">29.2</span> Implications for adherence support programs</h2>
<p>If increasing adherence from observed levels to near-perfect could improve suppression by this magnitude, investments in adherence support (pill organizers, SMS reminders, peer support, reduced pill burden) may be cost-effective.</p>
</section>
<section id="fragile-assumptions" class="level2" data-number="29.3">
<h2 data-number="29.3" class="anchored" data-anchor-id="fragile-assumptions"><span class="header-section-number">29.3</span> Fragile assumptions</h2>
<ol type="1">
<li><strong>Sequential exchangeability:</strong> If unmeasured factors (e.g., substance use severity, housing instability) affect both adherence and outcomes, our estimates are biased</li>
<li><strong>Positivity:</strong> If some patient types never achieve high adherence, we cannot estimate the effect of forcing them to adhere — stochastic interventions are more appropriate</li>
<li><strong>Independent censoring:</strong> If loss to follow-up is driven by unmeasured factors related to both adherence and outcome, even after conditioning on observed covariates, our censoring adjustment is biased</li>
</ol>
<hr>
</section>
</section>
<section id="key-takeaways" class="level1" data-number="30">
<h1 data-number="30"><span class="header-section-number">30</span> Key Takeaways</h1>
<ol type="1">
<li><p><strong>Never condition on time-varying adherence in a regression model</strong> when adherence is affected by time-varying confounders. This introduces collider bias through a feedback loop.</p></li>
<li><p><strong>GEE models that adjust for time-varying covariates are biased</strong> for causal questions about treatment effects under different adherence patterns.</p></li>
<li><p><strong>Longitudinal IPTW (marginal structural models)</strong> correctly handles time-varying confounding but produces unstable estimates when cumulative weights are extreme.</p></li>
<li><p><strong>Longitudinal TMLE (LTMLE)</strong> avoids the extreme weight problem by targeting the sequential outcome regressions directly. It is doubly robust at each time step and provides influence-curve inference.</p></li>
<li><p><strong>LMTP extends this framework</strong> to stochastic and modified treatment policies, which are more realistic than static “always treat” interventions and mitigate positivity violations.</p></li>
<li><p><strong>Imperfect adherence is an intercurrent event.</strong> The ICH E9(R1) framework helps clarify which estimand (treatment policy, hypothetical, etc.) matches the decision at hand. Longitudinal TMLE directly estimates the hypothetical strategy.</p></li>
<li><p><strong>Diagnostics in longitudinal settings</strong> require checking propensity score overlap at each time point and inspecting cumulative weight distributions. Extreme cumulative weights are a clear signal to prefer TMLE over IPTW.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    
 [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   
 [9] ggplot2_3.5.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 
 [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         
 [9] labeling_0.4.3    generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4
[13] munsell_0.5.1     pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6      
[17] utf8_1.2.4        stringi_1.8.7     xfun_0.49         timechange_0.3.0 
[21] cli_3.6.5         withr_3.0.2       magrittr_2.0.3    digest_0.6.37    
[25] grid_4.4.2        rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4  
[29] vctrs_0.6.5       evaluate_1.0.5    glue_1.8.0        farver_2.1.2     
[33] fansi_1.0.6       colorspace_2.1-1  rmarkdown_2.29    tools_4.4.2      
[37] pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amertens\.github\.io\/causal-learning-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="pagination-link" aria-label="Chapter 3.6: When RWD Meets RCT – Hybrid Designs">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-08-tmle-clean-room.html" class="pagination-link" aria-label="Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb91" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE"</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "An illustrated guide to why conditioning on adherence biases causal effects, and how longitudinal TMLE and LMTP address this"</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 3.7: Imperfect Adherence in Longitudinal Data</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>*Why conditioning on adherence biases causal effects, and how longitudinal TMLE and LMTP address this*</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>In randomized trials, the intent-to-treat (ITT) analysis compares groups as randomized, regardless of whether patients actually took their medication. But in pharmacoepidemiology, we often want to know:</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; What would have happened if patients had actually followed a particular treatment strategy?</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>This chapter addresses **imperfect adherence** --- a central challenge in longitudinal causal inference. We show:</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Why standard regression conditioning on time-varying adherence introduces bias</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How the causal roadmap handles time-varying treatments and confounders</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to define realistic adherence-based estimands</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to implement longitudinal TMLE and LMTP to estimate effects under hypothetical adherence patterns</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>The motivating example: **antiretroviral therapy (ART) adherence and HIV virologic suppression**.</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. Clinical Motivation</span></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Setting</span></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>A public health agency wants to evaluate antiretroviral therapy strategies for people living with HIV. The key question:</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **What is the probability of virologic suppression (HIV RNA &lt; 200 copies/mL) at 12 months if all patients maintained high adherence to their ART regimen, compared to the observed adherence pattern?**</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why this question is hard</span></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>In practice, ART adherence varies over time due to:</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Side effects** (nausea, fatigue) that reduce adherence</span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Viral load response** --- patients who achieve suppression may become less diligent</span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**CD4 count changes** --- worsening health may change both adherence and outcomes</span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Mental health** and substance use --- confounders that affect both adherence and outcomes</span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a>Critically, adherence at each time point is influenced by time-varying health status, and time-varying health status is itself influenced by past adherence. This creates **time-varying confounding affected by prior treatment** --- a situation where standard methods fail.</span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a><span class="fu">### Target population</span></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a>Adults living with HIV initiating a new ART regimen</span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a><span class="fu">### Treatment strategies</span></span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Strategy 1:** Maintain high adherence ($\geq$ 95% of doses) at every monthly interval</span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Strategy 0:** Natural (observed) adherence course</span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a><span class="fu">### Outcome</span></span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>Virologic suppression (HIV RNA &lt; 200 copies/mL) at 12 months</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intercurrent events</span></span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Loss to follow-up (informative censoring)</span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Treatment switching</span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Death</span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a><span class="fu">### The decision</span></span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a>Should adherence support programs be intensified? How much improvement in suppression could be expected from perfect adherence?</span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. The Problem with Conditioning on Adherence</span></span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-66"><a href="#cb91-66" aria-hidden="true" tabindex="-1"></a>Before introducing the correct methods, let us understand **why standard approaches fail**.</span>
<span id="cb91-67"><a href="#cb91-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-68"><a href="#cb91-68" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why not just adjust for adherence in a regression?</span></span>
<span id="cb91-69"><a href="#cb91-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-70"><a href="#cb91-70" aria-hidden="true" tabindex="-1"></a>Consider a simple model:</span>
<span id="cb91-71"><a href="#cb91-71" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-72"><a href="#cb91-72" aria-hidden="true" tabindex="-1"></a>\text{logit}\big(P(Y = 1)\big) = \beta_0 + \beta_1 \cdot \text{Cumulative Adherence} + \beta_2 \cdot \text{Baseline CD4}</span>
<span id="cb91-73"><a href="#cb91-73" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-74"><a href="#cb91-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-75"><a href="#cb91-75" aria-hidden="true" tabindex="-1"></a>This conditions on adherence. But why is that a problem?</span>
<span id="cb91-76"><a href="#cb91-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-77"><a href="#cb91-77" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb91-78"><a href="#cb91-78" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Conditioning-on-Adherence Trap</span></span>
<span id="cb91-79"><a href="#cb91-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-80"><a href="#cb91-80" aria-hidden="true" tabindex="-1"></a>The problem is that adherence is **affected by prior health status**, which also affects the outcome. Adherence is simultaneously:</span>
<span id="cb91-81"><a href="#cb91-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-82"><a href="#cb91-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A **mediator** (treatment $\to$ adherence $\to$ outcome)</span>
<span id="cb91-83"><a href="#cb91-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A **collider** when conditioned on (because both health status and unmeasured factors affect it)</span>
<span id="cb91-84"><a href="#cb91-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-85"><a href="#cb91-85" aria-hidden="true" tabindex="-1"></a>Conditioning on adherence opens **backdoor paths** through time-varying confounders, introducing selection bias. This is a fundamental result from causal inference theory.</span>
<span id="cb91-86"><a href="#cb91-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-87"><a href="#cb91-87" aria-hidden="true" tabindex="-1"></a>**Think of it this way:** If you compare patients who adhered well vs. poorly, you are not comparing like-with-like. Patients who adhered poorly may have done so *because* they were sicker --- and that sickness, not the low adherence, may explain worse outcomes. Conditioning on adherence mixes up the reason for adherence with the effect of adherence.</span>
<span id="cb91-88"><a href="#cb91-88" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-89"><a href="#cb91-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-90"><a href="#cb91-90" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visual intuition</span></span>
<span id="cb91-91"><a href="#cb91-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-92"><a href="#cb91-92" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb91-93"><a href="#cb91-93" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Collider Problem in a Diagram</span></span>
<span id="cb91-94"><a href="#cb91-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-95"><a href="#cb91-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-96"><a href="#cb91-96" aria-hidden="true" tabindex="-1"></a><span class="in">    CD4(t-1) -----&gt; Adherence(t) -----&gt; CD4(t) -----&gt; Outcome</span></span>
<span id="cb91-97"><a href="#cb91-97" aria-hidden="true" tabindex="-1"></a><span class="in">       |                ^                  |</span></span>
<span id="cb91-98"><a href="#cb91-98" aria-hidden="true" tabindex="-1"></a><span class="in">       |                |                  |</span></span>
<span id="cb91-99"><a href="#cb91-99" aria-hidden="true" tabindex="-1"></a><span class="in">       +---------&gt; Adherence(t) &lt;----------+</span></span>
<span id="cb91-100"><a href="#cb91-100" aria-hidden="true" tabindex="-1"></a><span class="in">                     (collider when conditioned on)</span></span>
<span id="cb91-101"><a href="#cb91-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-102"><a href="#cb91-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-103"><a href="#cb91-103" aria-hidden="true" tabindex="-1"></a>When you condition on adherence at time $t$, you induce an association between CD4 at time $t-1$ and unmeasured factors that affect adherence --- biasing the effect estimate.</span>
<span id="cb91-104"><a href="#cb91-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-105"><a href="#cb91-105" aria-hidden="true" tabindex="-1"></a>**Why does this matter?** Once you "hold adherence fixed" in a regression, you create a spurious link between everything that caused adherence. This is collider bias, and it distorts the causal effect estimate in unpredictable ways --- sometimes making the treatment look more effective, sometimes less.</span>
<span id="cb91-106"><a href="#cb91-106" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-107"><a href="#cb91-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-108"><a href="#cb91-108" aria-hidden="true" tabindex="-1"></a><span class="fu">## A common mistake: GEE models</span></span>
<span id="cb91-109"><a href="#cb91-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-110"><a href="#cb91-110" aria-hidden="true" tabindex="-1"></a>Generalized Estimating Equations (GEE) are popular for longitudinal data, but a GEE model that adjusts for time-varying covariates **and** conditions on time-varying treatment (adherence) will produce biased estimates for causal effects when time-varying confounders are affected by prior treatment.</span>
<span id="cb91-111"><a href="#cb91-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-112"><a href="#cb91-112" aria-hidden="true" tabindex="-1"></a>**The solution:** Use g-methods (g-computation, IPTW, or TMLE) that properly handle the time-ordering of treatment, confounders, and outcome.</span>
<span id="cb91-113"><a href="#cb91-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-114"><a href="#cb91-114" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-115"><a href="#cb91-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-116"><a href="#cb91-116" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Causal Roadmap for Longitudinal Data</span></span>
<span id="cb91-117"><a href="#cb91-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-118"><a href="#cb91-118" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb91-119"><a href="#cb91-119" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Define the Causal Question</span></span>
<span id="cb91-120"><a href="#cb91-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-121"><a href="#cb91-121" aria-hidden="true" tabindex="-1"></a>**Plain language:** What would the 12-month virologic suppression rate be if every patient maintained high adherence, compared to the naturally observed adherence pattern?</span>
<span id="cb91-122"><a href="#cb91-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-123"><a href="#cb91-123" aria-hidden="true" tabindex="-1"></a>**Counterfactual estimand:**</span>
<span id="cb91-124"><a href="#cb91-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-125"><a href="#cb91-125" aria-hidden="true" tabindex="-1"></a>Let $\bar{A} = (A_1, A_2, \ldots, A_T)$ denote the adherence history. Define two regimes:</span>
<span id="cb91-126"><a href="#cb91-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-127"><a href="#cb91-127" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Always high adherence:** $d_1: A_t = 1$ for all $t$ (deterministic static regime)</span>
<span id="cb91-128"><a href="#cb91-128" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Natural course:** $d_0:$ treatment follows the observed distribution</span>
<span id="cb91-129"><a href="#cb91-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-130"><a href="#cb91-130" aria-hidden="true" tabindex="-1"></a>The estimand is:</span>
<span id="cb91-131"><a href="#cb91-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-132"><a href="#cb91-132" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-133"><a href="#cb91-133" aria-hidden="true" tabindex="-1"></a>\psi = E\big<span class="co">[</span><span class="ot">Y(\bar{a} = \bar{1})\big</span><span class="co">]</span> - E\big<span class="co">[</span><span class="ot">Y^{\text{obs}}\big</span><span class="co">]</span></span>
<span id="cb91-134"><a href="#cb91-134" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-135"><a href="#cb91-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-136"><a href="#cb91-136" aria-hidden="true" tabindex="-1"></a>where $Y(\bar{a} = \bar{1})$ is the potential outcome under the always-high-adherence regime.</span>
<span id="cb91-137"><a href="#cb91-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-138"><a href="#cb91-138" aria-hidden="true" tabindex="-1"></a>We can also define **stochastic interventions** that shift the probability of high adherence (e.g., increase it by 20%) rather than forcing it to 100% --- more realistic and less prone to positivity violations.</span>
<span id="cb91-139"><a href="#cb91-139" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-140"><a href="#cb91-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-141"><a href="#cb91-141" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb91-142"><a href="#cb91-142" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Specify the Causal Model</span></span>
<span id="cb91-143"><a href="#cb91-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-144"><a href="#cb91-144" aria-hidden="true" tabindex="-1"></a>The longitudinal data structure for patient $i$ at time $t$:</span>
<span id="cb91-145"><a href="#cb91-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-146"><a href="#cb91-146" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-147"><a href="#cb91-147" aria-hidden="true" tabindex="-1"></a>O_i = \big(W_i, \; L_{i,1}, A_{i,1}, C_{i,1}, \; L_{i,2}, A_{i,2}, C_{i,2}, \; \ldots, \; L_{i,T}, A_{i,T}, C_{i,T}, \; Y_i\big)</span>
<span id="cb91-148"><a href="#cb91-148" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-149"><a href="#cb91-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-150"><a href="#cb91-150" aria-hidden="true" tabindex="-1"></a>Where:</span>
<span id="cb91-151"><a href="#cb91-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-152"><a href="#cb91-152" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$W$: baseline covariates (age, sex, baseline CD4, baseline viral load, comorbidities)</span>
<span id="cb91-153"><a href="#cb91-153" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$L_t$: time-varying covariates at time $t$ (CD4 count, viral load, symptoms, mental health score)</span>
<span id="cb91-154"><a href="#cb91-154" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$A_t$: adherence indicator at time $t$ (1 = high adherence, 0 = low)</span>
<span id="cb91-155"><a href="#cb91-155" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$C_t$: censoring at time $t$ (1 = lost to follow-up, 0 = still observed)</span>
<span id="cb91-156"><a href="#cb91-156" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y$: virologic suppression at 12 months</span>
<span id="cb91-157"><a href="#cb91-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-158"><a href="#cb91-158" aria-hidden="true" tabindex="-1"></a>**The key causal feature:** $L_t$ is affected by past treatment $\bar{A}_{t-1}$ and also affects future treatment $A_t$ and the outcome $Y$. This is time-varying confounding affected by prior treatment.</span>
<span id="cb91-159"><a href="#cb91-159" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-160"><a href="#cb91-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-161"><a href="#cb91-161" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb91-162"><a href="#cb91-162" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: State the Assumptions</span></span>
<span id="cb91-163"><a href="#cb91-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-164"><a href="#cb91-164" aria-hidden="true" tabindex="-1"></a>These assumptions are critical. If they fail, even the best estimator will give biased answers.</span>
<span id="cb91-165"><a href="#cb91-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-166"><a href="#cb91-166" aria-hidden="true" tabindex="-1"></a>**Sequential exchangeability:**</span>
<span id="cb91-167"><a href="#cb91-167" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-168"><a href="#cb91-168" aria-hidden="true" tabindex="-1"></a>Y(\bar{a}) \perp<span class="sc">\!\!\!</span>\perp A_t \mid \bar{L}_t, \bar{A}_{t-1}, W \quad \text{for all } t</span>
<span id="cb91-169"><a href="#cb91-169" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-170"><a href="#cb91-170" aria-hidden="true" tabindex="-1"></a>At each time point, treatment is as-good-as-random given the observed history. This is the longitudinal analogue of "no unmeasured confounding."</span>
<span id="cb91-171"><a href="#cb91-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-172"><a href="#cb91-172" aria-hidden="true" tabindex="-1"></a>**Sequential positivity:**</span>
<span id="cb91-173"><a href="#cb91-173" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-174"><a href="#cb91-174" aria-hidden="true" tabindex="-1"></a>P(A_t = a \mid \bar{L}_t, \bar{A}_{t-1}, W) &gt; 0 \quad \text{for all } t, a</span>
<span id="cb91-175"><a href="#cb91-175" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-176"><a href="#cb91-176" aria-hidden="true" tabindex="-1"></a>Every adherence level must be possible at every time point for every covariate history. Violations occur when certain health states make adherence nearly deterministic.</span>
<span id="cb91-177"><a href="#cb91-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-178"><a href="#cb91-178" aria-hidden="true" tabindex="-1"></a>**Consistency:**</span>
<span id="cb91-179"><a href="#cb91-179" aria-hidden="true" tabindex="-1"></a>The observed outcome matches the potential outcome under the treatment actually received.</span>
<span id="cb91-180"><a href="#cb91-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-181"><a href="#cb91-181" aria-hidden="true" tabindex="-1"></a>**Independent censoring (conditional):**</span>
<span id="cb91-182"><a href="#cb91-182" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-183"><a href="#cb91-183" aria-hidden="true" tabindex="-1"></a>Y(\bar{a}) \perp<span class="sc">\!\!\!</span>\perp C_t \mid \bar{L}_t, \bar{A}_{t-1}, W \quad \text{for all } t</span>
<span id="cb91-184"><a href="#cb91-184" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-185"><a href="#cb91-185" aria-hidden="true" tabindex="-1"></a>Censoring is independent of potential outcomes given the measured history.</span>
<span id="cb91-186"><a href="#cb91-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-187"><a href="#cb91-187" aria-hidden="true" tabindex="-1"></a>**Why does this matter?** If unmeasured factors (e.g., substance use severity, housing instability) drive both adherence and outcomes, sequential exchangeability fails. If some patient subgroups never achieve high adherence, positivity fails. Both scenarios lead to biased estimates, regardless of the statistical method used.</span>
<span id="cb91-188"><a href="#cb91-188" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-189"><a href="#cb91-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-190"><a href="#cb91-190" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb91-191"><a href="#cb91-191" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Map to a Statistical Estimand</span></span>
<span id="cb91-192"><a href="#cb91-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-193"><a href="#cb91-193" aria-hidden="true" tabindex="-1"></a>Under the above assumptions, the G-computation formula for the longitudinal setting is:</span>
<span id="cb91-194"><a href="#cb91-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-195"><a href="#cb91-195" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-196"><a href="#cb91-196" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">Y(\bar{a})</span><span class="co">]</span> = \sum_{\bar{l}} E<span class="co">[</span><span class="ot">Y \mid \bar{A} = \bar{a}, \bar{L} = \bar{l}, W</span><span class="co">]</span> \prod_t P(L_t = l_t \mid \bar{A}_{t-1}, \bar{L}_{t-1}, W)</span>
<span id="cb91-197"><a href="#cb91-197" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb91-198"><a href="#cb91-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-199"><a href="#cb91-199" aria-hidden="true" tabindex="-1"></a>This is a high-dimensional integral that iterates over all possible covariate histories --- practically estimated via sequential regression or TMLE.</span>
<span id="cb91-200"><a href="#cb91-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-201"><a href="#cb91-201" aria-hidden="true" tabindex="-1"></a>**The good news:** This formula tells us exactly what we need to estimate. The assumptions above bridge the gap from the causal question (what *would* happen) to a statistical quantity we can estimate from observed data (what *did* happen, reweighted or modeled appropriately).</span>
<span id="cb91-202"><a href="#cb91-202" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-203"><a href="#cb91-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-204"><a href="#cb91-204" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb91-205"><a href="#cb91-205" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Choose an Estimation Strategy</span></span>
<span id="cb91-206"><a href="#cb91-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-207"><a href="#cb91-207" aria-hidden="true" tabindex="-1"></a>| Method | Approach | Limitation |</span>
<span id="cb91-208"><a href="#cb91-208" aria-hidden="true" tabindex="-1"></a>|--------|----------|------------|</span>
<span id="cb91-209"><a href="#cb91-209" aria-hidden="true" tabindex="-1"></a>| GEE with time-varying covariates | Conditions on $L_t$ directly | Biased under time-varying confounding |</span>
<span id="cb91-210"><a href="#cb91-210" aria-hidden="true" tabindex="-1"></a>| Marginal structural model (MSM) via IPTW | Reweights by cumulative propensity | Products of weights become extreme |</span>
<span id="cb91-211"><a href="#cb91-211" aria-hidden="true" tabindex="-1"></a>| Longitudinal G-computation | Sequential outcome regression | Fully parametric; error compounds |</span>
<span id="cb91-212"><a href="#cb91-212" aria-hidden="true" tabindex="-1"></a>| Longitudinal TMLE (LTMLE) | Sequential targeting | Best properties but complex |</span>
<span id="cb91-213"><a href="#cb91-213" aria-hidden="true" tabindex="-1"></a>| LMTP | Modified treatment policies with TMLE | Handles stochastic interventions naturally |</span>
<span id="cb91-214"><a href="#cb91-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-215"><a href="#cb91-215" aria-hidden="true" tabindex="-1"></a>We implement the last two approaches.</span>
<span id="cb91-216"><a href="#cb91-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-217"><a href="#cb91-217" aria-hidden="true" tabindex="-1"></a>**Why LTMLE and LMTP?** These methods combine the strengths of outcome modeling and propensity weighting. They handle the feedback loop between treatment and confounders, avoid extreme weights, provide doubly robust estimation, and support flexible machine learning for nuisance parameter estimation.</span>
<span id="cb91-218"><a href="#cb91-218" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-219"><a href="#cb91-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-220"><a href="#cb91-220" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-221"><a href="#cb91-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-222"><a href="#cb91-222" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Data Simulation</span></span>
<span id="cb91-223"><a href="#cb91-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-224"><a href="#cb91-224" aria-hidden="true" tabindex="-1"></a>We simulate a realistic longitudinal HIV cohort with 6 monthly time points.</span>
<span id="cb91-225"><a href="#cb91-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-228"><a href="#cb91-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-229"><a href="#cb91-229" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb91-230"><a href="#cb91-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-231"><a href="#cb91-231" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb91-232"><a href="#cb91-232" aria-hidden="true" tabindex="-1"></a>n  <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb91-233"><a href="#cb91-233" aria-hidden="true" tabindex="-1"></a>T_max <span class="ot">&lt;-</span> <span class="dv">6</span>  <span class="co"># 6 monthly intervals (representing a 12-month follow-up, bi-monthly)</span></span>
<span id="cb91-234"><a href="#cb91-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-235"><a href="#cb91-235" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline covariates ---</span></span>
<span id="cb91-236"><a href="#cb91-236" aria-hidden="true" tabindex="-1"></a>W_age     <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">38</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb91-237"><a href="#cb91-237" aria-hidden="true" tabindex="-1"></a>W_male    <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.65</span>)</span>
<span id="cb91-238"><a href="#cb91-238" aria-hidden="true" tabindex="-1"></a>W_cd4_bl  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">350</span>, <span class="at">sd =</span> <span class="dv">150</span>)  <span class="co"># baseline CD4</span></span>
<span id="cb91-239"><a href="#cb91-239" aria-hidden="true" tabindex="-1"></a>W_cd4_bl  <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">50</span>, W_cd4_bl)               <span class="co"># floor at 50</span></span>
<span id="cb91-240"><a href="#cb91-240" aria-hidden="true" tabindex="-1"></a>W_vl_bl   <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">4.5</span>, <span class="at">sd =</span> <span class="fl">0.8</span>)  <span class="co"># baseline log10 viral load</span></span>
<span id="cb91-241"><a href="#cb91-241" aria-hidden="true" tabindex="-1"></a>W_depress <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.30</span>)               <span class="co"># baseline depression</span></span>
<span id="cb91-242"><a href="#cb91-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-243"><a href="#cb91-243" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Containers for longitudinal data ---</span></span>
<span id="cb91-244"><a href="#cb91-244" aria-hidden="true" tabindex="-1"></a>L_cd4  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)   <span class="co"># time-varying CD4</span></span>
<span id="cb91-245"><a href="#cb91-245" aria-hidden="true" tabindex="-1"></a>L_sympt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)  <span class="co"># time-varying symptom burden</span></span>
<span id="cb91-246"><a href="#cb91-246" aria-hidden="true" tabindex="-1"></a>A_adh  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)   <span class="co"># adherence at each time</span></span>
<span id="cb91-247"><a href="#cb91-247" aria-hidden="true" tabindex="-1"></a>C_cens <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, T_max)    <span class="co"># censoring indicator</span></span>
<span id="cb91-248"><a href="#cb91-248" aria-hidden="true" tabindex="-1"></a>alive  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">TRUE</span>, n)           <span class="co"># tracking who is still observed</span></span>
<span id="cb91-249"><a href="#cb91-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-250"><a href="#cb91-250" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Simulate longitudinal process ---</span></span>
<span id="cb91-251"><a href="#cb91-251" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb91-252"><a href="#cb91-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-253"><a href="#cb91-253" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Previous adherence (for t=1, use a starting value)</span></span>
<span id="cb91-254"><a href="#cb91-254" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb91-255"><a href="#cb91-255" aria-hidden="true" tabindex="-1"></a>    A_prev <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.7</span>)  <span class="co"># initial adherence tendency</span></span>
<span id="cb91-256"><a href="#cb91-256" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb91-257"><a href="#cb91-257" aria-hidden="true" tabindex="-1"></a>    A_prev <span class="ot">&lt;-</span> A_adh[, t <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb91-258"><a href="#cb91-258" aria-hidden="true" tabindex="-1"></a>    A_prev[<span class="fu">is.na</span>(A_prev)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb91-259"><a href="#cb91-259" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-260"><a href="#cb91-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-261"><a href="#cb91-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Previous CD4 (for t=1, use baseline)</span></span>
<span id="cb91-262"><a href="#cb91-262" aria-hidden="true" tabindex="-1"></a>  cd4_prev <span class="ot">&lt;-</span> <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) W_cd4_bl <span class="cf">else</span> L_cd4[, t <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb91-263"><a href="#cb91-263" aria-hidden="true" tabindex="-1"></a>  cd4_prev[<span class="fu">is.na</span>(cd4_prev)] <span class="ot">&lt;-</span> W_cd4_bl[<span class="fu">is.na</span>(cd4_prev)]</span>
<span id="cb91-264"><a href="#cb91-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-265"><a href="#cb91-265" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Time-varying CD4 ---</span></span>
<span id="cb91-266"><a href="#cb91-266" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CD4 increases with adherence, depends on history</span></span>
<span id="cb91-267"><a href="#cb91-267" aria-hidden="true" tabindex="-1"></a>  L_cd4[, t] <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">50</span>,</span>
<span id="cb91-268"><a href="#cb91-268" aria-hidden="true" tabindex="-1"></a>    cd4_prev <span class="sc">+</span></span>
<span id="cb91-269"><a href="#cb91-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">30</span> <span class="sc">*</span> A_prev <span class="sc">-</span> <span class="dv">10</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> A_prev), <span class="at">sd =</span> <span class="dv">40</span>) <span class="sc">+</span></span>
<span id="cb91-270"><a href="#cb91-270" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>) <span class="sc">+</span></span>
<span id="cb91-271"><a href="#cb91-271" aria-hidden="true" tabindex="-1"></a>    <span class="dv">20</span> <span class="sc">*</span> W_male</span>
<span id="cb91-272"><a href="#cb91-272" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-273"><a href="#cb91-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-274"><a href="#cb91-274" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Time-varying symptom burden ---</span></span>
<span id="cb91-275"><a href="#cb91-275" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Higher with low CD4, depression; reduced by adherence</span></span>
<span id="cb91-276"><a href="#cb91-276" aria-hidden="true" tabindex="-1"></a>  L_sympt[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>,</span>
<span id="cb91-277"><a href="#cb91-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.003</span> <span class="sc">*</span> L_cd4[, t] <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> W_depress <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> A_prev <span class="sc">+</span></span>
<span id="cb91-278"><a href="#cb91-278" aria-hidden="true" tabindex="-1"></a>           <span class="fl">0.01</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>))</span>
<span id="cb91-279"><a href="#cb91-279" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-280"><a href="#cb91-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-281"><a href="#cb91-281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Adherence at time t ---</span></span>
<span id="cb91-282"><a href="#cb91-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Affected by: symptoms (reduce adherence), CD4 response (feedback),</span></span>
<span id="cb91-283"><a href="#cb91-283" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior adherence (habit), depression, age</span></span>
<span id="cb91-284"><a href="#cb91-284" aria-hidden="true" tabindex="-1"></a>  lp_adh <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span></span>
<span id="cb91-285"><a href="#cb91-285" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">*</span> L_sympt[, t] <span class="sc">+</span></span>
<span id="cb91-286"><a href="#cb91-286" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.002</span> <span class="sc">*</span> (L_cd4[, t] <span class="sc">-</span> <span class="dv">350</span>) <span class="sc">+</span></span>
<span id="cb91-287"><a href="#cb91-287" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.6</span> <span class="sc">*</span> A_prev <span class="sc">+</span></span>
<span id="cb91-288"><a href="#cb91-288" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.7</span> <span class="sc">*</span> W_depress <span class="sc">+</span></span>
<span id="cb91-289"><a href="#cb91-289" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.01</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>) <span class="sc">+</span></span>
<span id="cb91-290"><a href="#cb91-290" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.2</span> <span class="sc">*</span> W_male</span>
<span id="cb91-291"><a href="#cb91-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-292"><a href="#cb91-292" aria-hidden="true" tabindex="-1"></a>  A_adh[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_adh))</span>
<span id="cb91-293"><a href="#cb91-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-294"><a href="#cb91-294" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Censoring ---</span></span>
<span id="cb91-295"><a href="#cb91-295" aria-hidden="true" tabindex="-1"></a>  <span class="co"># More likely with low CD4, symptoms, low adherence</span></span>
<span id="cb91-296"><a href="#cb91-296" aria-hidden="true" tabindex="-1"></a>  lp_cens <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">4.0</span> <span class="sc">+</span></span>
<span id="cb91-297"><a href="#cb91-297" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.002</span> <span class="sc">*</span> L_cd4[, t] <span class="sc">+</span></span>
<span id="cb91-298"><a href="#cb91-298" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.5</span> <span class="sc">*</span> L_sympt[, t] <span class="sc">+</span></span>
<span id="cb91-299"><a href="#cb91-299" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> A_adh[, t] <span class="sc">+</span></span>
<span id="cb91-300"><a href="#cb91-300" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.5</span> <span class="sc">*</span> W_depress</span>
<span id="cb91-301"><a href="#cb91-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-302"><a href="#cb91-302" aria-hidden="true" tabindex="-1"></a>  C_cens[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_cens)) <span class="sc">*</span> alive</span>
<span id="cb91-303"><a href="#cb91-303" aria-hidden="true" tabindex="-1"></a>  alive <span class="ot">&lt;-</span> alive <span class="sc">&amp;</span> (C_cens[, t] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb91-304"><a href="#cb91-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-305"><a href="#cb91-305" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set future values to NA for censored individuals</span></span>
<span id="cb91-306"><a href="#cb91-306" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (t <span class="sc">&lt;</span> T_max) {</span>
<span id="cb91-307"><a href="#cb91-307" aria-hidden="true" tabindex="-1"></a>    A_adh[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb91-308"><a href="#cb91-308" aria-hidden="true" tabindex="-1"></a>    L_cd4[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb91-309"><a href="#cb91-309" aria-hidden="true" tabindex="-1"></a>    L_sympt[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb91-310"><a href="#cb91-310" aria-hidden="true" tabindex="-1"></a>    C_cens[<span class="sc">!</span>alive, (t<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T_max] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb91-311"><a href="#cb91-311" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-312"><a href="#cb91-312" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-313"><a href="#cb91-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-314"><a href="#cb91-314" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome: virologic suppression at end of follow-up ---</span></span>
<span id="cb91-315"><a href="#cb91-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Depends on cumulative adherence, final CD4, baseline VL</span></span>
<span id="cb91-316"><a href="#cb91-316" aria-hidden="true" tabindex="-1"></a>cum_adh <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(A_adh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-317"><a href="#cb91-317" aria-hidden="true" tabindex="-1"></a>final_cd4 <span class="ot">&lt;-</span> <span class="fu">apply</span>(L_cd4, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb91-318"><a href="#cb91-318" aria-hidden="true" tabindex="-1"></a>  valid <span class="ot">&lt;-</span> x[<span class="sc">!</span><span class="fu">is.na</span>(x)]</span>
<span id="cb91-319"><a href="#cb91-319" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(valid) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">tail</span>(valid, <span class="dv">1</span>) <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb91-320"><a href="#cb91-320" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-321"><a href="#cb91-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-322"><a href="#cb91-322" aria-hidden="true" tabindex="-1"></a>lp_outcome <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.0</span> <span class="sc">+</span></span>
<span id="cb91-323"><a href="#cb91-323" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.5</span> <span class="sc">*</span> cum_adh <span class="sc">+</span></span>
<span id="cb91-324"><a href="#cb91-324" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.003</span> <span class="sc">*</span> (final_cd4 <span class="sc">-</span> <span class="dv">350</span>) <span class="sc">+</span></span>
<span id="cb91-325"><a href="#cb91-325" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">*</span> W_vl_bl <span class="sc">+</span></span>
<span id="cb91-326"><a href="#cb91-326" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> W_depress <span class="sc">+</span></span>
<span id="cb91-327"><a href="#cb91-327" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> W_male <span class="sc">+</span></span>
<span id="cb91-328"><a href="#cb91-328" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.8</span> <span class="sc">*</span> cum_adh <span class="sc">*</span> (final_cd4 <span class="sc">&gt;</span> <span class="dv">400</span>)  <span class="co"># interaction: adherence more effective with good immune response</span></span>
<span id="cb91-329"><a href="#cb91-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-330"><a href="#cb91-330" aria-hidden="true" tabindex="-1"></a>Y_supp <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_outcome))</span>
<span id="cb91-331"><a href="#cb91-331" aria-hidden="true" tabindex="-1"></a><span class="co"># Censored individuals: outcome is missing</span></span>
<span id="cb91-332"><a href="#cb91-332" aria-hidden="true" tabindex="-1"></a>Y_supp[<span class="sc">!</span>alive] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb91-333"><a href="#cb91-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-334"><a href="#cb91-334" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size:"</span>, n, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-335"><a href="#cb91-335" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Censored by end:"</span>, <span class="fu">sum</span>(<span class="sc">!</span>alive), <span class="st">"("</span>, <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(<span class="sc">!</span>alive), <span class="dv">1</span>), <span class="st">"%)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-336"><a href="#cb91-336" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Among uncensored, suppression rate:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Y_supp[alive]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-337"><a href="#cb91-337" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean cumulative adherence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(cum_adh, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-338"><a href="#cb91-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-339"><a href="#cb91-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-340"><a href="#cb91-340" aria-hidden="true" tabindex="-1"></a><span class="fu">### True effect of perfect adherence</span></span>
<span id="cb91-341"><a href="#cb91-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-342"><a href="#cb91-342" aria-hidden="true" tabindex="-1"></a>We can compute the counterfactual suppression rate under always-high adherence from the structural model. Since the true DGP is complex (with feedback), we approximate using simulation:</span>
<span id="cb91-343"><a href="#cb91-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-346"><a href="#cb91-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-347"><a href="#cb91-347" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate counterfactual under always-high adherence (A_t = 1 for all t)</span></span>
<span id="cb91-348"><a href="#cb91-348" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb91-349"><a href="#cb91-349" aria-hidden="true" tabindex="-1"></a>cf_cd4 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)</span>
<span id="cb91-350"><a href="#cb91-350" aria-hidden="true" tabindex="-1"></a>cf_sympt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n, T_max)</span>
<span id="cb91-351"><a href="#cb91-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-352"><a href="#cb91-352" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb91-353"><a href="#cb91-353" aria-hidden="true" tabindex="-1"></a>  cd4_prev_cf <span class="ot">&lt;-</span> <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) W_cd4_bl <span class="cf">else</span> cf_cd4[, t <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb91-354"><a href="#cb91-354" aria-hidden="true" tabindex="-1"></a>  A_prev_cf <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># always high adherence</span></span>
<span id="cb91-355"><a href="#cb91-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-356"><a href="#cb91-356" aria-hidden="true" tabindex="-1"></a>  cf_cd4[, t] <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">50</span>,</span>
<span id="cb91-357"><a href="#cb91-357" aria-hidden="true" tabindex="-1"></a>    cd4_prev_cf <span class="sc">+</span></span>
<span id="cb91-358"><a href="#cb91-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">30</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">-</span> <span class="dv">10</span> <span class="sc">*</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">40</span>) <span class="sc">+</span></span>
<span id="cb91-359"><a href="#cb91-359" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>) <span class="sc">+</span> <span class="dv">20</span> <span class="sc">*</span> W_male</span>
<span id="cb91-360"><a href="#cb91-360" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-361"><a href="#cb91-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-362"><a href="#cb91-362" aria-hidden="true" tabindex="-1"></a>  cf_sympt[, t] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>,</span>
<span id="cb91-363"><a href="#cb91-363" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.003</span> <span class="sc">*</span> cf_cd4[, t] <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> W_depress <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb91-364"><a href="#cb91-364" aria-hidden="true" tabindex="-1"></a>           <span class="fl">0.01</span> <span class="sc">*</span> (W_age <span class="sc">-</span> <span class="dv">38</span>))</span>
<span id="cb91-365"><a href="#cb91-365" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-366"><a href="#cb91-366" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-367"><a href="#cb91-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-368"><a href="#cb91-368" aria-hidden="true" tabindex="-1"></a>cf_cum_adh <span class="ot">&lt;-</span> <span class="fl">1.0</span>  <span class="co"># perfect adherence</span></span>
<span id="cb91-369"><a href="#cb91-369" aria-hidden="true" tabindex="-1"></a>cf_final_cd4 <span class="ot">&lt;-</span> cf_cd4[, T_max]</span>
<span id="cb91-370"><a href="#cb91-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-371"><a href="#cb91-371" aria-hidden="true" tabindex="-1"></a>lp_cf <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.0</span> <span class="sc">+</span></span>
<span id="cb91-372"><a href="#cb91-372" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.5</span> <span class="sc">*</span> cf_cum_adh <span class="sc">+</span></span>
<span id="cb91-373"><a href="#cb91-373" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.003</span> <span class="sc">*</span> (cf_final_cd4 <span class="sc">-</span> <span class="dv">350</span>) <span class="sc">+</span></span>
<span id="cb91-374"><a href="#cb91-374" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">*</span> W_vl_bl <span class="sc">+</span></span>
<span id="cb91-375"><a href="#cb91-375" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> W_depress <span class="sc">+</span></span>
<span id="cb91-376"><a href="#cb91-376" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> W_male <span class="sc">+</span></span>
<span id="cb91-377"><a href="#cb91-377" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.8</span> <span class="sc">*</span> cf_cum_adh <span class="sc">*</span> (cf_final_cd4 <span class="sc">&gt;</span> <span class="dv">400</span>)</span>
<span id="cb91-378"><a href="#cb91-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-379"><a href="#cb91-379" aria-hidden="true" tabindex="-1"></a>true_suppression_perfect <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_cf))</span>
<span id="cb91-380"><a href="#cb91-380" aria-hidden="true" tabindex="-1"></a>true_suppression_observed <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_outcome), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-381"><a href="#cb91-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-382"><a href="#cb91-382" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True suppression under always-high adherence:"</span>, <span class="fu">round</span>(true_suppression_perfect, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-383"><a href="#cb91-383" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True suppression under observed adherence:   "</span>, <span class="fu">round</span>(true_suppression_observed, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-384"><a href="#cb91-384" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True effect of perfect adherence:             "</span>, <span class="fu">round</span>(true_suppression_perfect <span class="sc">-</span> true_suppression_observed, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-385"><a href="#cb91-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-386"><a href="#cb91-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-387"><a href="#cb91-387" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prepare data in long format</span></span>
<span id="cb91-388"><a href="#cb91-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-391"><a href="#cb91-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-392"><a href="#cb91-392" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a wide-format dataframe for analysis</span></span>
<span id="cb91-393"><a href="#cb91-393" aria-hidden="true" tabindex="-1"></a>dat_wide <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb91-394"><a href="#cb91-394" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb91-395"><a href="#cb91-395" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> W_age,</span>
<span id="cb91-396"><a href="#cb91-396" aria-hidden="true" tabindex="-1"></a>  <span class="at">male =</span> W_male,</span>
<span id="cb91-397"><a href="#cb91-397" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd4_bl =</span> W_cd4_bl,</span>
<span id="cb91-398"><a href="#cb91-398" aria-hidden="true" tabindex="-1"></a>  <span class="at">vl_bl =</span> W_vl_bl,</span>
<span id="cb91-399"><a href="#cb91-399" aria-hidden="true" tabindex="-1"></a>  <span class="at">depress =</span> W_depress</span>
<span id="cb91-400"><a href="#cb91-400" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-401"><a href="#cb91-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-402"><a href="#cb91-402" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb91-403"><a href="#cb91-403" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"cd4_"</span>, t)]]   <span class="ot">&lt;-</span> L_cd4[, t]</span>
<span id="cb91-404"><a href="#cb91-404" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"sympt_"</span>, t)]] <span class="ot">&lt;-</span> L_sympt[, t]</span>
<span id="cb91-405"><a href="#cb91-405" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"A_"</span>, t)]]     <span class="ot">&lt;-</span> A_adh[, t]</span>
<span id="cb91-406"><a href="#cb91-406" aria-hidden="true" tabindex="-1"></a>  dat_wide[[<span class="fu">paste0</span>(<span class="st">"C_"</span>, t)]]     <span class="ot">&lt;-</span> C_cens[, t]</span>
<span id="cb91-407"><a href="#cb91-407" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-408"><a href="#cb91-408" aria-hidden="true" tabindex="-1"></a>dat_wide<span class="sc">$</span>Y <span class="ot">&lt;-</span> Y_supp</span>
<span id="cb91-409"><a href="#cb91-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-410"><a href="#cb91-410" aria-hidden="true" tabindex="-1"></a><span class="co"># For long format (useful for some analyses)</span></span>
<span id="cb91-411"><a href="#cb91-411" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> dat_wide <span class="sc">%&gt;%</span></span>
<span id="cb91-412"><a href="#cb91-412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb91-413"><a href="#cb91-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">matches</span>(<span class="st">"^(cd4|sympt|A|C)_</span><span class="sc">\\</span><span class="st">d+$"</span>),</span>
<span id="cb91-414"><a href="#cb91-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"time"</span>),</span>
<span id="cb91-415"><a href="#cb91-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"(</span><span class="sc">\\</span><span class="st">w+)_(</span><span class="sc">\\</span><span class="st">d+)"</span></span>
<span id="cb91-416"><a href="#cb91-416" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-417"><a href="#cb91-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.integer</span>(time)) <span class="sc">%&gt;%</span></span>
<span id="cb91-418"><a href="#cb91-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, time)</span>
<span id="cb91-419"><a href="#cb91-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-420"><a href="#cb91-420" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat_long)</span>
<span id="cb91-421"><a href="#cb91-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-422"><a href="#cb91-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-423"><a href="#cb91-423" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-424"><a href="#cb91-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-425"><a href="#cb91-425" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. The Naive (Biased) Approach</span></span>
<span id="cb91-426"><a href="#cb91-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-427"><a href="#cb91-427" aria-hidden="true" tabindex="-1"></a>First, let us see what happens if we ignore the time-varying confounding structure.</span>
<span id="cb91-428"><a href="#cb91-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-429"><a href="#cb91-429" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5A. Cross-sectional regression on cumulative adherence</span></span>
<span id="cb91-430"><a href="#cb91-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-433"><a href="#cb91-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-434"><a href="#cb91-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Only among uncensored</span></span>
<span id="cb91-435"><a href="#cb91-435" aria-hidden="true" tabindex="-1"></a>dat_complete <span class="ot">&lt;-</span> dat_wide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Y))</span>
<span id="cb91-436"><a href="#cb91-436" aria-hidden="true" tabindex="-1"></a>dat_complete<span class="sc">$</span>cum_adh <span class="ot">&lt;-</span> cum_adh[alive]</span>
<span id="cb91-437"><a href="#cb91-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-438"><a href="#cb91-438" aria-hidden="true" tabindex="-1"></a>naive_gee <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> cum_adh <span class="sc">+</span> cd4_bl <span class="sc">+</span> vl_bl <span class="sc">+</span> depress <span class="sc">+</span> age <span class="sc">+</span> male,</span>
<span id="cb91-439"><a href="#cb91-439" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat_complete)</span>
<span id="cb91-440"><a href="#cb91-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-441"><a href="#cb91-441" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted suppression at 100% vs 50% adherence</span></span>
<span id="cb91-442"><a href="#cb91-442" aria-hidden="true" tabindex="-1"></a>nd_perfect <span class="ot">&lt;-</span> dat_complete <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">cum_adh =</span> <span class="fl">1.0</span>)</span>
<span id="cb91-443"><a href="#cb91-443" aria-hidden="true" tabindex="-1"></a>nd_half    <span class="ot">&lt;-</span> dat_complete <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">cum_adh =</span> <span class="fl">0.5</span>)</span>
<span id="cb91-444"><a href="#cb91-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-445"><a href="#cb91-445" aria-hidden="true" tabindex="-1"></a>naive_perfect <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(naive_gee, <span class="at">newdata =</span> nd_perfect, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb91-446"><a href="#cb91-446" aria-hidden="true" tabindex="-1"></a>naive_half    <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(naive_gee, <span class="at">newdata =</span> nd_half, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb91-447"><a href="#cb91-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-448"><a href="#cb91-448" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive model:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-449"><a href="#cb91-449" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Predicted suppression at 100% adherence:"</span>, <span class="fu">round</span>(naive_perfect, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-450"><a href="#cb91-450" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Predicted suppression at 50% adherence: "</span>, <span class="fu">round</span>(naive_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-451"><a href="#cb91-451" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Difference:"</span>, <span class="fu">round</span>(naive_perfect <span class="sc">-</span> naive_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-452"><a href="#cb91-452" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">This estimate is biased because it conditions on post-treatment variables.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-453"><a href="#cb91-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-454"><a href="#cb91-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-455"><a href="#cb91-455" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb91-456"><a href="#cb91-456" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Is This Wrong?</span></span>
<span id="cb91-457"><a href="#cb91-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-458"><a href="#cb91-458" aria-hidden="true" tabindex="-1"></a>The model treats cumulative adherence as a fixed baseline variable, but adherence is:</span>
<span id="cb91-459"><a href="#cb91-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-460"><a href="#cb91-460" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Affected by time-varying CD4 and symptoms** (confounders) --- patients who feel worse adhere less, and feeling worse also worsens the outcome directly</span>
<span id="cb91-461"><a href="#cb91-461" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Itself affects future CD4 and symptoms** (it is a treatment) --- taking medication changes the very health indicators that influence future adherence</span>
<span id="cb91-462"><a href="#cb91-462" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**A collider** when conditioned on --- because both health status and unmeasured factors drive adherence decisions</span>
<span id="cb91-463"><a href="#cb91-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-464"><a href="#cb91-464" aria-hidden="true" tabindex="-1"></a>The estimate conflates the causal effect of adherence with the reverse causal effect of health on adherence. You cannot untangle "does adherence improve outcomes?" from "do better outcomes sustain adherence?" using standard regression.</span>
<span id="cb91-465"><a href="#cb91-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-466"><a href="#cb91-466" aria-hidden="true" tabindex="-1"></a>**The fundamental issue:** Standard regression assumes covariates are fixed. But in a longitudinal feedback loop, today's treatment changes tomorrow's confounders, which change the day after's treatment. No single regression equation can properly account for this temporal cascade.</span>
<span id="cb91-467"><a href="#cb91-467" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-468"><a href="#cb91-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-469"><a href="#cb91-469" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-470"><a href="#cb91-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-471"><a href="#cb91-471" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. IPTW for Marginal Structural Models</span></span>
<span id="cb91-472"><a href="#cb91-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-473"><a href="#cb91-473" aria-hidden="true" tabindex="-1"></a>The first correct approach is IPTW, which avoids conditioning on time-varying confounders by reweighting.</span>
<span id="cb91-474"><a href="#cb91-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-475"><a href="#cb91-475" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimate treatment weights at each time point</span></span>
<span id="cb91-476"><a href="#cb91-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-479"><a href="#cb91-479" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-480"><a href="#cb91-480" aria-hidden="true" tabindex="-1"></a><span class="co"># Work in long format; only uncensored observations</span></span>
<span id="cb91-481"><a href="#cb91-481" aria-hidden="true" tabindex="-1"></a>dat_long_uc <span class="ot">&lt;-</span> dat_long <span class="sc">%&gt;%</span></span>
<span id="cb91-482"><a href="#cb91-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb91-483"><a href="#cb91-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">cumall</span>(<span class="sc">!</span><span class="fu">is.na</span>(A))) <span class="sc">%&gt;%</span>  <span class="co"># keep complete treatment histories</span></span>
<span id="cb91-484"><a href="#cb91-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb91-485"><a href="#cb91-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-486"><a href="#cb91-486" aria-hidden="true" tabindex="-1"></a><span class="co"># Propensity model at each time point</span></span>
<span id="cb91-487"><a href="#cb91-487" aria-hidden="true" tabindex="-1"></a><span class="co"># P(A_t = 1 | history)</span></span>
<span id="cb91-488"><a href="#cb91-488" aria-hidden="true" tabindex="-1"></a>dat_long_uc <span class="ot">&lt;-</span> dat_long_uc <span class="sc">%&gt;%</span></span>
<span id="cb91-489"><a href="#cb91-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb91-490"><a href="#cb91-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-491"><a href="#cb91-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_lag =</span> <span class="fu">lag</span>(<span class="fu">as.double</span>(A), <span class="at">default =</span> <span class="fl">0.7</span>),  <span class="co"># lagged adherence</span></span>
<span id="cb91-492"><a href="#cb91-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">cd4_lag =</span> <span class="fu">lag</span>(cd4, <span class="at">default =</span> <span class="fu">first</span>(cd4))</span>
<span id="cb91-493"><a href="#cb91-493" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-494"><a href="#cb91-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb91-495"><a href="#cb91-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-496"><a href="#cb91-496" aria-hidden="true" tabindex="-1"></a><span class="co"># Time-specific propensity models</span></span>
<span id="cb91-497"><a href="#cb91-497" aria-hidden="true" tabindex="-1"></a>g_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb91-498"><a href="#cb91-498" aria-hidden="true" tabindex="-1"></a>dat_long_uc<span class="sc">$</span>ps_t <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb91-499"><a href="#cb91-499" aria-hidden="true" tabindex="-1"></a>dat_long_uc<span class="sc">$</span>ps_num_t <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb91-500"><a href="#cb91-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-501"><a href="#cb91-501" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t_val <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb91-502"><a href="#cb91-502" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> dat_long_uc<span class="sc">$</span>time <span class="sc">==</span> t_val</span>
<span id="cb91-503"><a href="#cb91-503" aria-hidden="true" tabindex="-1"></a>  dat_t <span class="ot">&lt;-</span> dat_long_uc[idx, ]</span>
<span id="cb91-504"><a href="#cb91-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-505"><a href="#cb91-505" aria-hidden="true" tabindex="-1"></a>  g_t <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> cd4 <span class="sc">+</span> sympt <span class="sc">+</span> A_lag <span class="sc">+</span> depress <span class="sc">+</span> age <span class="sc">+</span> male <span class="sc">+</span> vl_bl,</span>
<span id="cb91-506"><a href="#cb91-506" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat_t)</span>
<span id="cb91-507"><a href="#cb91-507" aria-hidden="true" tabindex="-1"></a>  g_models[[t_val]] <span class="ot">&lt;-</span> g_t</span>
<span id="cb91-508"><a href="#cb91-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-509"><a href="#cb91-509" aria-hidden="true" tabindex="-1"></a>  ps_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_t, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-510"><a href="#cb91-510" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stabilized numerator: P(A_t | baseline, past A)</span></span>
<span id="cb91-511"><a href="#cb91-511" aria-hidden="true" tabindex="-1"></a>  g_num_t <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> A_lag <span class="sc">+</span> age <span class="sc">+</span> male,</span>
<span id="cb91-512"><a href="#cb91-512" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat_t)</span>
<span id="cb91-513"><a href="#cb91-513" aria-hidden="true" tabindex="-1"></a>  ps_num <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_num_t, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-514"><a href="#cb91-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-515"><a href="#cb91-515" aria-hidden="true" tabindex="-1"></a>  dat_long_uc<span class="sc">$</span>ps_t[idx] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb91-516"><a href="#cb91-516" aria-hidden="true" tabindex="-1"></a>    dat_t<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, ps_pred, <span class="dv">1</span> <span class="sc">-</span> ps_pred</span>
<span id="cb91-517"><a href="#cb91-517" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-518"><a href="#cb91-518" aria-hidden="true" tabindex="-1"></a>  dat_long_uc<span class="sc">$</span>ps_num_t[idx] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb91-519"><a href="#cb91-519" aria-hidden="true" tabindex="-1"></a>    dat_t<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, ps_num, <span class="dv">1</span> <span class="sc">-</span> ps_num</span>
<span id="cb91-520"><a href="#cb91-520" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-521"><a href="#cb91-521" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-522"><a href="#cb91-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-523"><a href="#cb91-523" aria-hidden="true" tabindex="-1"></a><span class="co"># Any remaining NA (shouldn't happen, but safety net)</span></span>
<span id="cb91-524"><a href="#cb91-524" aria-hidden="true" tabindex="-1"></a>dat_long_uc<span class="sc">$</span>ps_num_t[<span class="fu">is.na</span>(dat_long_uc<span class="sc">$</span>ps_num_t)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb91-525"><a href="#cb91-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-526"><a href="#cb91-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-527"><a href="#cb91-527" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compute cumulative weights</span></span>
<span id="cb91-528"><a href="#cb91-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-531"><a href="#cb91-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-532"><a href="#cb91-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative product of time-specific propensity scores</span></span>
<span id="cb91-533"><a href="#cb91-533" aria-hidden="true" tabindex="-1"></a>weight_df <span class="ot">&lt;-</span> dat_long_uc <span class="sc">%&gt;%</span></span>
<span id="cb91-534"><a href="#cb91-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb91-535"><a href="#cb91-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb91-536"><a href="#cb91-536" aria-hidden="true" tabindex="-1"></a>    <span class="at">cum_ps_denom =</span> <span class="fu">prod</span>(ps_t, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb91-537"><a href="#cb91-537" aria-hidden="true" tabindex="-1"></a>    <span class="at">cum_adh =</span> <span class="fu">mean</span>(A, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb91-538"><a href="#cb91-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb91-539"><a href="#cb91-539" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-540"><a href="#cb91-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-541"><a href="#cb91-541" aria-hidden="true" tabindex="-1"></a><span class="co"># Stabilized weights (using marginal model in numerator)</span></span>
<span id="cb91-542"><a href="#cb91-542" aria-hidden="true" tabindex="-1"></a>weight_df<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> weight_df<span class="sc">$</span>cum_ps_denom</span>
<span id="cb91-543"><a href="#cb91-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-544"><a href="#cb91-544" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge outcome</span></span>
<span id="cb91-545"><a href="#cb91-545" aria-hidden="true" tabindex="-1"></a>weight_df <span class="ot">&lt;-</span> weight_df <span class="sc">%&gt;%</span></span>
<span id="cb91-546"><a href="#cb91-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dat_wide <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, Y), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-547"><a href="#cb91-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Y))</span>
<span id="cb91-548"><a href="#cb91-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-549"><a href="#cb91-549" aria-hidden="true" tabindex="-1"></a><span class="co"># Truncate extreme weights</span></span>
<span id="cb91-550"><a href="#cb91-550" aria-hidden="true" tabindex="-1"></a>w99 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(weight_df<span class="sc">$</span>sw, <span class="fl">0.99</span>)</span>
<span id="cb91-551"><a href="#cb91-551" aria-hidden="true" tabindex="-1"></a>weight_df<span class="sc">$</span>sw_trunc <span class="ot">&lt;-</span> <span class="fu">pmin</span>(weight_df<span class="sc">$</span>sw, w99)</span>
<span id="cb91-552"><a href="#cb91-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-553"><a href="#cb91-553" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Weight summary (truncated):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-554"><a href="#cb91-554" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weight_df<span class="sc">$</span>sw_trunc)</span>
<span id="cb91-555"><a href="#cb91-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-556"><a href="#cb91-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-559"><a href="#cb91-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-560"><a href="#cb91-560" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot weight distribution</span></span>
<span id="cb91-561"><a href="#cb91-561" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weight_df, <span class="fu">aes</span>(<span class="at">x =</span> sw_trunc)) <span class="sc">+</span></span>
<span id="cb91-562"><a href="#cb91-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#228833"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb91-563"><a href="#cb91-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-564"><a href="#cb91-564" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stabilized cumulative IPTW weight (truncated at 99th pctile)"</span>,</span>
<span id="cb91-565"><a href="#cb91-565" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb91-566"><a href="#cb91-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of Longitudinal IPTW Weights"</span></span>
<span id="cb91-567"><a href="#cb91-567" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-568"><a href="#cb91-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb91-569"><a href="#cb91-569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-570"><a href="#cb91-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-571"><a href="#cb91-571" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb91-572"><a href="#cb91-572" aria-hidden="true" tabindex="-1"></a><span class="fu">## Beware: Extreme Cumulative Weights</span></span>
<span id="cb91-573"><a href="#cb91-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-574"><a href="#cb91-574" aria-hidden="true" tabindex="-1"></a>Cumulative weights from longitudinal IPTW are **products** of time-specific weights. Even with modest individual weights (e.g., each between 0.5 and 2.0), the product over 6 or 12 time points can become extreme.</span>
<span id="cb91-575"><a href="#cb91-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-576"><a href="#cb91-576" aria-hidden="true" tabindex="-1"></a>**Why this happens:** If a patient's observed treatment history is unlikely under the model (e.g., they adhered despite many risk factors for non-adherence), their cumulative weight $w = \prod_{t=1}^{T} 1/g_t$ can explode. A few such patients can dominate the entire weighted analysis.</span>
<span id="cb91-577"><a href="#cb91-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-578"><a href="#cb91-578" aria-hidden="true" tabindex="-1"></a>**Practical consequences:**</span>
<span id="cb91-579"><a href="#cb91-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-580"><a href="#cb91-580" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A single patient with weight 500 can outweigh hundreds of others combined</span>
<span id="cb91-581"><a href="#cb91-581" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Truncating weights introduces bias but reduces variance --- a delicate trade-off</span>
<span id="cb91-582"><a href="#cb91-582" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Confidence intervals become unreliable when weights are extreme</span>
<span id="cb91-583"><a href="#cb91-583" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Weight instability gets worse with more time points</span>
<span id="cb91-584"><a href="#cb91-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-585"><a href="#cb91-585" aria-hidden="true" tabindex="-1"></a>This is a well-known limitation of longitudinal IPTW and a key reason to prefer TMLE-based methods, which incorporate treatment information through numerically stable logistic fluctuation models rather than multiplicative weights.</span>
<span id="cb91-586"><a href="#cb91-586" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-587"><a href="#cb91-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-588"><a href="#cb91-588" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weighted outcome model</span></span>
<span id="cb91-589"><a href="#cb91-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-592"><a href="#cb91-592" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-593"><a href="#cb91-593" aria-hidden="true" tabindex="-1"></a><span class="co"># MSM: weighted regression of outcome on cumulative adherence</span></span>
<span id="cb91-594"><a href="#cb91-594" aria-hidden="true" tabindex="-1"></a>msm_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> cum_adh, <span class="at">family =</span> binomial,</span>
<span id="cb91-595"><a href="#cb91-595" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights =</span> sw_trunc, <span class="at">data =</span> weight_df)</span>
<span id="cb91-596"><a href="#cb91-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-597"><a href="#cb91-597" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted suppression under perfect vs half adherence</span></span>
<span id="cb91-598"><a href="#cb91-598" aria-hidden="true" tabindex="-1"></a>msm_perfect <span class="ot">&lt;-</span> <span class="fu">predict</span>(msm_fit,</span>
<span id="cb91-599"><a href="#cb91-599" aria-hidden="true" tabindex="-1"></a>                       <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">cum_adh =</span> <span class="fl">1.0</span>),</span>
<span id="cb91-600"><a href="#cb91-600" aria-hidden="true" tabindex="-1"></a>                       <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-601"><a href="#cb91-601" aria-hidden="true" tabindex="-1"></a>msm_half <span class="ot">&lt;-</span> <span class="fu">predict</span>(msm_fit,</span>
<span id="cb91-602"><a href="#cb91-602" aria-hidden="true" tabindex="-1"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">cum_adh =</span> <span class="fl">0.5</span>),</span>
<span id="cb91-603"><a href="#cb91-603" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-604"><a href="#cb91-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-605"><a href="#cb91-605" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW-MSM estimate:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-606"><a href="#cb91-606" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression at 100% adherence:"</span>, <span class="fu">round</span>(msm_perfect, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-607"><a href="#cb91-607" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression at 50% adherence: "</span>, <span class="fu">round</span>(msm_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-608"><a href="#cb91-608" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Difference:"</span>, <span class="fu">round</span>(msm_perfect <span class="sc">-</span> msm_half, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-609"><a href="#cb91-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-610"><a href="#cb91-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-611"><a href="#cb91-611" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-612"><a href="#cb91-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-613"><a href="#cb91-613" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. Longitudinal TMLE: Conceptual Overview</span></span>
<span id="cb91-614"><a href="#cb91-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-615"><a href="#cb91-615" aria-hidden="true" tabindex="-1"></a>Longitudinal TMLE extends the point-treatment TMLE from Chapter 2.4 to the time-varying setting. The core idea is the same --- fit initial models, then target them --- but now we work backwards through time.</span>
<span id="cb91-616"><a href="#cb91-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-617"><a href="#cb91-617" aria-hidden="true" tabindex="-1"></a><span class="fu">### The algorithm (simplified)</span></span>
<span id="cb91-618"><a href="#cb91-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-619"><a href="#cb91-619" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb91-620"><a href="#cb91-620" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Outcome Model --- Start at the End</span></span>
<span id="cb91-621"><a href="#cb91-621" aria-hidden="true" tabindex="-1"></a>**Start at the final time point** $T$ and fit the outcome model:</span>
<span id="cb91-622"><a href="#cb91-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-623"><a href="#cb91-623" aria-hidden="true" tabindex="-1"></a>$$\hat{Q}_T(\bar{A}_T, \bar{L}_T, W) = E<span class="co">[</span><span class="ot">Y \mid \bar{A}_T, \bar{L}_T, W</span><span class="co">]</span>$$</span>
<span id="cb91-624"><a href="#cb91-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-625"><a href="#cb91-625" aria-hidden="true" tabindex="-1"></a>This is the same initial outcome regression as in point-treatment TMLE --- estimate the expected outcome given the full observed history. The difference is that "history" now includes treatment and covariates at every time point.</span>
<span id="cb91-626"><a href="#cb91-626" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-627"><a href="#cb91-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-628"><a href="#cb91-628" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb91-629"><a href="#cb91-629" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Propensity Scores --- One at Every Time Point</span></span>
<span id="cb91-630"><a href="#cb91-630" aria-hidden="true" tabindex="-1"></a>Estimate the treatment mechanism at each time $t$:</span>
<span id="cb91-631"><a href="#cb91-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-632"><a href="#cb91-632" aria-hidden="true" tabindex="-1"></a>$$g_t = P(A_t \mid \bar{A}_{t-1}, \bar{L}_t, W)$$</span>
<span id="cb91-633"><a href="#cb91-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-634"><a href="#cb91-634" aria-hidden="true" tabindex="-1"></a>Unlike point-treatment TMLE which has a single propensity score, here you need $T$ separate propensity models --- one for each treatment decision. Each conditions on the full history available at that time point.</span>
<span id="cb91-635"><a href="#cb91-635" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-636"><a href="#cb91-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-637"><a href="#cb91-637" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb91-638"><a href="#cb91-638" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Clever Covariates --- Cumulative Inverse Probabilities</span></span>
<span id="cb91-639"><a href="#cb91-639" aria-hidden="true" tabindex="-1"></a>For each time $t$ from $T$ down to 1, compute the clever covariate using the cumulative treatment probability:</span>
<span id="cb91-640"><a href="#cb91-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-641"><a href="#cb91-641" aria-hidden="true" tabindex="-1"></a>$$H_t = \frac{I(\bar{A}_t = \bar{a}_t)}{\prod_{s=1}^{t} \hat{g}_s}$$</span>
<span id="cb91-642"><a href="#cb91-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-643"><a href="#cb91-643" aria-hidden="true" tabindex="-1"></a>The clever covariate at time $t$ involves the product of all propensity scores up to that time. This is what links the treatment model to the outcome model at each step of the backwards iteration.</span>
<span id="cb91-644"><a href="#cb91-644" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-645"><a href="#cb91-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-646"><a href="#cb91-646" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb91-647"><a href="#cb91-647" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Targeting --- Update Backwards Through Time</span></span>
<span id="cb91-648"><a href="#cb91-648" aria-hidden="true" tabindex="-1"></a>For each time $t$ from $T$ down to 1, run a targeting (fluctuation) step to update $\hat{Q}_t$:</span>
<span id="cb91-649"><a href="#cb91-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-650"><a href="#cb91-650" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Regress the outcome (or pseudo-outcome from the next step) on the clever covariate $H_t$ with the logit of $\hat{Q}_t$ as offset</span>
<span id="cb91-651"><a href="#cb91-651" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use the estimated fluctuation parameter $\hat{\epsilon}_t$ to update predictions</span>
<span id="cb91-652"><a href="#cb91-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-653"><a href="#cb91-653" aria-hidden="true" tabindex="-1"></a>**Then average** the targeted predictions under the intervention of interest.</span>
<span id="cb91-654"><a href="#cb91-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-655"><a href="#cb91-655" aria-hidden="true" tabindex="-1"></a>Each targeting step corrects the outcome model at that time point using information from the treatment model, achieving sequential double robustness.</span>
<span id="cb91-656"><a href="#cb91-656" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-657"><a href="#cb91-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-658"><a href="#cb91-658" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb91-659"><a href="#cb91-659" aria-hidden="true" tabindex="-1"></a><span class="fu">## How Does This Handle Time-Dependent Confounding?</span></span>
<span id="cb91-660"><a href="#cb91-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-661"><a href="#cb91-661" aria-hidden="true" tabindex="-1"></a>The backwards iteration is the key. At each step:</span>
<span id="cb91-662"><a href="#cb91-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-663"><a href="#cb91-663" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conditioning on $L_t$** in the outcome model at time $t$ correctly adjusts for confounding of $A_t$</span>
<span id="cb91-664"><a href="#cb91-664" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Integrating out $L_t$** in the backwards regression from time $t$ to $t-1$ preserves the mediated effect of $A_{t-1}$ through $L_t$</span>
<span id="cb91-665"><a href="#cb91-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-666"><a href="#cb91-666" aria-hidden="true" tabindex="-1"></a>This is exactly the dilemma that standard regression cannot solve: you need to adjust for $L_t$ as a confounder of $A_t$ but not block it as a mediator of $A_{t-1}$. The sequential backwards structure does both, by conditioning on $L_t$ only at the time step where it is a confounder and then marginalizing over it at the step where it is a mediator.</span>
<span id="cb91-667"><a href="#cb91-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-668"><a href="#cb91-668" aria-hidden="true" tabindex="-1"></a>**In plain language:** L-TMLE "peels off" one layer of time-varying confounding at each step, working from the outcome back to baseline. By the time it reaches the first treatment decision, all the intermediate confounders have been properly handled.</span>
<span id="cb91-669"><a href="#cb91-669" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-670"><a href="#cb91-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-671"><a href="#cb91-671" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why LTMLE is better than longitudinal IPTW</span></span>
<span id="cb91-672"><a href="#cb91-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-673"><a href="#cb91-673" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Does not require computing cumulative weight products (avoids extreme weights)</span>
<span id="cb91-674"><a href="#cb91-674" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Doubly robust at each time step</span>
<span id="cb91-675"><a href="#cb91-675" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Can incorporate Super Learner for each nuisance model</span>
<span id="cb91-676"><a href="#cb91-676" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Provides efficient influence curve-based inference</span>
<span id="cb91-677"><a href="#cb91-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-678"><a href="#cb91-678" aria-hidden="true" tabindex="-1"></a><span class="fu">### Packages</span></span>
<span id="cb91-679"><a href="#cb91-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-680"><a href="#cb91-680" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**ltmle:** The <span class="in">`ltmle`</span> R package implements longitudinal TMLE for binary and continuous treatments with censoring</span>
<span id="cb91-681"><a href="#cb91-681" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**lmtp:** The <span class="in">`lmtp`</span> package implements a more general framework for modified treatment policies (static, dynamic, and stochastic interventions) using TMLE</span>
<span id="cb91-682"><a href="#cb91-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-683"><a href="#cb91-683" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-684"><a href="#cb91-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-685"><a href="#cb91-685" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Implementing Longitudinal TMLE</span></span>
<span id="cb91-686"><a href="#cb91-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-687"><a href="#cb91-687" aria-hidden="true" tabindex="-1"></a>We demonstrate a simplified by-hand longitudinal TMLE for the static "always treat" regime, then show the package interface.</span>
<span id="cb91-688"><a href="#cb91-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-689"><a href="#cb91-689" aria-hidden="true" tabindex="-1"></a><span class="fu">### By-hand sequential regression approach</span></span>
<span id="cb91-690"><a href="#cb91-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-691"><a href="#cb91-691" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb91-692"><a href="#cb91-692" aria-hidden="true" tabindex="-1"></a><span class="fu">## Outcome Model: Initial Sequential Regression</span></span>
<span id="cb91-693"><a href="#cb91-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-694"><a href="#cb91-694" aria-hidden="true" tabindex="-1"></a>First, fit the outcome model at the final time step --- $Q_T = E<span class="co">[</span><span class="ot">Y \mid A_T, L_T, \ldots, W</span><span class="co">]</span>$ --- using all available information. Then predict under the counterfactual where all treatment decisions are set to "high adherence."</span>
<span id="cb91-695"><a href="#cb91-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-696"><a href="#cb91-696" aria-hidden="true" tabindex="-1"></a>This is the starting point: a G-computation estimate that would be correct if the outcome model is perfectly specified, but may be biased otherwise. The targeting steps below will correct this.</span>
<span id="cb91-697"><a href="#cb91-697" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-698"><a href="#cb91-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-701"><a href="#cb91-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-702"><a href="#cb91-702" aria-hidden="true" tabindex="-1"></a><span class="co"># Work with complete cases for the by-hand demonstration</span></span>
<span id="cb91-703"><a href="#cb91-703" aria-hidden="true" tabindex="-1"></a>dat_analysis <span class="ot">&lt;-</span> dat_wide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Y))</span>
<span id="cb91-704"><a href="#cb91-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-705"><a href="#cb91-705" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 1: Fit outcome model at the final time step ---</span></span>
<span id="cb91-706"><a href="#cb91-706" aria-hidden="true" tabindex="-1"></a><span class="co"># Q_T = E[Y | A_T, L_T, ..., W]</span></span>
<span id="cb91-707"><a href="#cb91-707" aria-hidden="true" tabindex="-1"></a><span class="co"># We use all available information</span></span>
<span id="cb91-708"><a href="#cb91-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-709"><a href="#cb91-709" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct features for the final outcome model</span></span>
<span id="cb91-710"><a href="#cb91-710" aria-hidden="true" tabindex="-1"></a>dat_analysis <span class="ot">&lt;-</span> dat_analysis <span class="sc">%&gt;%</span></span>
<span id="cb91-711"><a href="#cb91-711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-712"><a href="#cb91-712" aria-hidden="true" tabindex="-1"></a>    <span class="at">cum_adh =</span> <span class="fu">rowMeans</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"A_"</span>)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb91-713"><a href="#cb91-713" aria-hidden="true" tabindex="-1"></a>    <span class="at">last_cd4 =</span> cd4_6,</span>
<span id="cb91-714"><a href="#cb91-714" aria-hidden="true" tabindex="-1"></a>    <span class="at">last_sympt =</span> sympt_6</span>
<span id="cb91-715"><a href="#cb91-715" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-716"><a href="#cb91-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-717"><a href="#cb91-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial outcome regression</span></span>
<span id="cb91-718"><a href="#cb91-718" aria-hidden="true" tabindex="-1"></a>Q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A_1 <span class="sc">+</span> A_2 <span class="sc">+</span> A_3 <span class="sc">+</span> A_4 <span class="sc">+</span> A_5 <span class="sc">+</span> A_6 <span class="sc">+</span></span>
<span id="cb91-719"><a href="#cb91-719" aria-hidden="true" tabindex="-1"></a>               cd4_bl <span class="sc">+</span> vl_bl <span class="sc">+</span> depress <span class="sc">+</span> age <span class="sc">+</span> male <span class="sc">+</span></span>
<span id="cb91-720"><a href="#cb91-720" aria-hidden="true" tabindex="-1"></a>               cd4_6 <span class="sc">+</span> sympt_6,</span>
<span id="cb91-721"><a href="#cb91-721" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat_analysis)</span>
<span id="cb91-722"><a href="#cb91-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-723"><a href="#cb91-723" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict under always-high adherence (all A_t = 1)</span></span>
<span id="cb91-724"><a href="#cb91-724" aria-hidden="true" tabindex="-1"></a>dat_cf <span class="ot">&lt;-</span> dat_analysis <span class="sc">%&gt;%</span></span>
<span id="cb91-725"><a href="#cb91-725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"A_"</span>), <span class="sc">~</span><span class="dv">1</span>))</span>
<span id="cb91-726"><a href="#cb91-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-727"><a href="#cb91-727" aria-hidden="true" tabindex="-1"></a>Q_star <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">newdata =</span> dat_cf, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-728"><a href="#cb91-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-729"><a href="#cb91-729" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sequential G-computation estimate (no targeting):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-730"><a href="#cb91-730" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression under always-high adherence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Q_star), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-731"><a href="#cb91-731" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-732"><a href="#cb91-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-733"><a href="#cb91-733" aria-hidden="true" tabindex="-1"></a><span class="fu">### Iterative targeting (simplified 2-step)</span></span>
<span id="cb91-734"><a href="#cb91-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-735"><a href="#cb91-735" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb91-736"><a href="#cb91-736" aria-hidden="true" tabindex="-1"></a><span class="fu">## Propensity Scores: Modeling Treatment at Each Time Point</span></span>
<span id="cb91-737"><a href="#cb91-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-738"><a href="#cb91-738" aria-hidden="true" tabindex="-1"></a>We estimate $P(A_t = 1 \mid \text{history}_t)$ at each time point. In this simplified demonstration, we model the cumulative probability of the full "always treat" regime as the product of time-specific propensities.</span>
<span id="cb91-739"><a href="#cb91-739" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-740"><a href="#cb91-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-743"><a href="#cb91-743" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-744"><a href="#cb91-744" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb91-745"><a href="#cb91-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-746"><a href="#cb91-746" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Propensity scores for cumulative treatment ---</span></span>
<span id="cb91-747"><a href="#cb91-747" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified: model P(all A_t = 1 | W) as product of marginals</span></span>
<span id="cb91-748"><a href="#cb91-748" aria-hidden="true" tabindex="-1"></a><span class="co"># This is an approximation for demonstration</span></span>
<span id="cb91-749"><a href="#cb91-749" aria-hidden="true" tabindex="-1"></a>g_cum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(dat_analysis))</span>
<span id="cb91-750"><a href="#cb91-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-751"><a href="#cb91-751" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t_val <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb91-752"><a href="#cb91-752" aria-hidden="true" tabindex="-1"></a>  A_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val)</span>
<span id="cb91-753"><a href="#cb91-753" aria-hidden="true" tabindex="-1"></a>  A_lag_col <span class="ot">&lt;-</span> <span class="cf">if</span>(t_val <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val <span class="sc">-</span> <span class="dv">1</span>) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb91-754"><a href="#cb91-754" aria-hidden="true" tabindex="-1"></a>  cd4_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"cd4_"</span>, t_val)</span>
<span id="cb91-755"><a href="#cb91-755" aria-hidden="true" tabindex="-1"></a>  sympt_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"sympt_"</span>, t_val)</span>
<span id="cb91-756"><a href="#cb91-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-757"><a href="#cb91-757" aria-hidden="true" tabindex="-1"></a>  formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(cd4_col, sympt_col, <span class="st">"depress"</span>, <span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"vl_bl"</span>)</span>
<span id="cb91-758"><a href="#cb91-758" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(A_lag_col)) formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(formula_vars, A_lag_col)</span>
<span id="cb91-759"><a href="#cb91-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-760"><a href="#cb91-760" aria-hidden="true" tabindex="-1"></a>  g_t_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb91-761"><a href="#cb91-761" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.formula</span>(<span class="fu">paste</span>(A_col, <span class="st">"~"</span>, <span class="fu">paste</span>(formula_vars, <span class="at">collapse =</span> <span class="st">" + "</span>))),</span>
<span id="cb91-762"><a href="#cb91-762" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial, <span class="at">data =</span> dat_analysis</span>
<span id="cb91-763"><a href="#cb91-763" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-764"><a href="#cb91-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-765"><a href="#cb91-765" aria-hidden="true" tabindex="-1"></a>  g_t_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_t_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-766"><a href="#cb91-766" aria-hidden="true" tabindex="-1"></a>  g_cum <span class="ot">&lt;-</span> g_cum <span class="sc">*</span> g_t_pred  <span class="co"># cumulative probability of always-treated</span></span>
<span id="cb91-767"><a href="#cb91-767" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-768"><a href="#cb91-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-769"><a href="#cb91-769" aria-hidden="true" tabindex="-1"></a><span class="co"># Bound away from zero</span></span>
<span id="cb91-770"><a href="#cb91-770" aria-hidden="true" tabindex="-1"></a>g_cum <span class="ot">&lt;-</span> <span class="fu">pmax</span>(g_cum, <span class="fl">0.001</span>)</span>
<span id="cb91-771"><a href="#cb91-771" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-772"><a href="#cb91-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-773"><a href="#cb91-773" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb91-774"><a href="#cb91-774" aria-hidden="true" tabindex="-1"></a><span class="fu">## Clever Covariate: Bridging Outcome and Treatment Models</span></span>
<span id="cb91-775"><a href="#cb91-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-776"><a href="#cb91-776" aria-hidden="true" tabindex="-1"></a>The clever covariate for the "always treat" intervention is:</span>
<span id="cb91-777"><a href="#cb91-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-778"><a href="#cb91-778" aria-hidden="true" tabindex="-1"></a>$$H = \frac{I(\text{all } A_t = 1)}{g_{\text{cum}}}$$</span>
<span id="cb91-779"><a href="#cb91-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-780"><a href="#cb91-780" aria-hidden="true" tabindex="-1"></a>For patients who followed the regime at every time point, $H$ equals the inverse of their cumulative probability of doing so. For patients who deviated at any point, $H = 0$. This is the same logic as point-treatment TMLE's $H = I(A=1)/g(W)$, extended to the full treatment history.</span>
<span id="cb91-781"><a href="#cb91-781" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-782"><a href="#cb91-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-785"><a href="#cb91-785" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-786"><a href="#cb91-786" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for the "always treat" intervention</span></span>
<span id="cb91-787"><a href="#cb91-787" aria-hidden="true" tabindex="-1"></a><span class="co"># H = I(all A_t = 1) / g_cum</span></span>
<span id="cb91-788"><a href="#cb91-788" aria-hidden="true" tabindex="-1"></a>all_treated <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(dat_analysis <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"A_"</span>))) <span class="sc">==</span> T_max</span>
<span id="cb91-789"><a href="#cb91-789" aria-hidden="true" tabindex="-1"></a>H_clever <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(all_treated) <span class="sc">/</span> g_cum</span>
<span id="cb91-790"><a href="#cb91-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-791"><a href="#cb91-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-792"><a href="#cb91-792" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb91-793"><a href="#cb91-793" aria-hidden="true" tabindex="-1"></a><span class="fu">## Targeting Step: Updating the Initial Estimates</span></span>
<span id="cb91-794"><a href="#cb91-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-795"><a href="#cb91-795" aria-hidden="true" tabindex="-1"></a>Run a logistic regression of $Y$ on $H$ with the logit of $\hat{Q}$ as an offset. The coefficient $\hat{\epsilon}$ is the fluctuation parameter that corrects the initial outcome model to be unbiased for our specific estimand.</span>
<span id="cb91-796"><a href="#cb91-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-797"><a href="#cb91-797" aria-hidden="true" tabindex="-1"></a>$$\text{logit}(Y) = \text{logit}(\hat{Q}) + \epsilon \cdot H$$</span>
<span id="cb91-798"><a href="#cb91-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-799"><a href="#cb91-799" aria-hidden="true" tabindex="-1"></a>Then update the counterfactual predictions:</span>
<span id="cb91-800"><a href="#cb91-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-801"><a href="#cb91-801" aria-hidden="true" tabindex="-1"></a>$$\hat{Q}^* = \text{expit}(\text{logit}(\hat{Q}_{\text{cf}}) + \hat{\epsilon} \cdot H_{\text{cf}})$$</span>
<span id="cb91-802"><a href="#cb91-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-803"><a href="#cb91-803" aria-hidden="true" tabindex="-1"></a>where $H_{\text{cf}} = 1/g_{\text{cum}}$ because under the intervention, everyone is treated.</span>
<span id="cb91-804"><a href="#cb91-804" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-805"><a href="#cb91-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-808"><a href="#cb91-808" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-809"><a href="#cb91-809" aria-hidden="true" tabindex="-1"></a><span class="co"># Targeting step</span></span>
<span id="cb91-810"><a href="#cb91-810" aria-hidden="true" tabindex="-1"></a>Q_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-811"><a href="#cb91-811" aria-hidden="true" tabindex="-1"></a>fluc_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat_analysis<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(Q_init)) <span class="sc">+</span> H_clever,</span>
<span id="cb91-812"><a href="#cb91-812" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial)</span>
<span id="cb91-813"><a href="#cb91-813" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc_mod)</span>
<span id="cb91-814"><a href="#cb91-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-815"><a href="#cb91-815" aria-hidden="true" tabindex="-1"></a><span class="co"># Update counterfactual predictions</span></span>
<span id="cb91-816"><a href="#cb91-816" aria-hidden="true" tabindex="-1"></a>H_cf <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> g_cum  <span class="co"># under the intervention, everyone is treated</span></span>
<span id="cb91-817"><a href="#cb91-817" aria-hidden="true" tabindex="-1"></a>Q_targeted <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q_star) <span class="sc">+</span> epsilon <span class="sc">*</span> H_cf)</span>
<span id="cb91-818"><a href="#cb91-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-819"><a href="#cb91-819" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Targeted estimate (simplified LTMLE):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-820"><a href="#cb91-820" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Suppression under always-high adherence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Q_targeted), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-821"><a href="#cb91-821" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Epsilon:"</span>, <span class="fu">round</span>(epsilon, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-822"><a href="#cb91-822" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-823"><a href="#cb91-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-824"><a href="#cb91-824" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb91-825"><a href="#cb91-825" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Just Happened?</span></span>
<span id="cb91-826"><a href="#cb91-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-827"><a href="#cb91-827" aria-hidden="true" tabindex="-1"></a>The targeting step nudged the initial G-computation predictions toward the truth by incorporating information from the treatment model. Here is the intuition:</span>
<span id="cb91-828"><a href="#cb91-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-829"><a href="#cb91-829" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the outcome model was **already correct**, the fluctuation parameter $\epsilon$ will be close to zero --- no correction needed</span>
<span id="cb91-830"><a href="#cb91-830" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the outcome model was **biased**, the clever covariate $H$ steers the correction in the right direction, using the treatment mechanism as a guide</span>
<span id="cb91-831"><a href="#cb91-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-832"><a href="#cb91-832" aria-hidden="true" tabindex="-1"></a>The result is **double robustness**: the final estimate is consistent if either the outcome model $\hat{Q}$ or the treatment model $\hat{g}$ is correctly specified. Neither needs to be perfect on its own --- they compensate for each other's errors.</span>
<span id="cb91-833"><a href="#cb91-833" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-834"><a href="#cb91-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-835"><a href="#cb91-835" aria-hidden="true" tabindex="-1"></a><span class="fu">### Influence-curve based inference</span></span>
<span id="cb91-836"><a href="#cb91-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-839"><a href="#cb91-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-840"><a href="#cb91-840" aria-hidden="true" tabindex="-1"></a><span class="co"># EIC for the always-treat estimand</span></span>
<span id="cb91-841"><a href="#cb91-841" aria-hidden="true" tabindex="-1"></a>psi_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q_targeted)</span>
<span id="cb91-842"><a href="#cb91-842" aria-hidden="true" tabindex="-1"></a>eic_long <span class="ot">&lt;-</span> H_cf <span class="sc">*</span> (dat_analysis<span class="sc">$</span>Y <span class="sc">-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_clever)) <span class="sc">+</span></span>
<span id="cb91-843"><a href="#cb91-843" aria-hidden="true" tabindex="-1"></a>            Q_targeted <span class="sc">-</span> psi_hat</span>
<span id="cb91-844"><a href="#cb91-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-845"><a href="#cb91-845" aria-hidden="true" tabindex="-1"></a>se_long <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic_long) <span class="sc">/</span> <span class="fu">nrow</span>(dat_analysis))</span>
<span id="cb91-846"><a href="#cb91-846" aria-hidden="true" tabindex="-1"></a>ci_long <span class="ot">&lt;-</span> psi_hat <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> se_long</span>
<span id="cb91-847"><a href="#cb91-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-848"><a href="#cb91-848" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Simplified LTMLE for always-high adherence:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-849"><a href="#cb91-849" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Estimate:"</span>, <span class="fu">round</span>(psi_hat, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-850"><a href="#cb91-850" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SE:"</span>, <span class="fu">round</span>(se_long, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-851"><a href="#cb91-851" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  95% CI: ["</span>, <span class="fu">round</span>(ci_long[<span class="dv">1</span>], <span class="dv">3</span>), <span class="st">","</span>, <span class="fu">round</span>(ci_long[<span class="dv">2</span>], <span class="dv">3</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-852"><a href="#cb91-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-853"><a href="#cb91-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-854"><a href="#cb91-854" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-855"><a href="#cb91-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-856"><a href="#cb91-856" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Using the LMTP Package</span></span>
<span id="cb91-857"><a href="#cb91-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-858"><a href="#cb91-858" aria-hidden="true" tabindex="-1"></a>The <span class="in">`lmtp`</span> package provides a clean interface for estimating effects of longitudinal modified treatment policies. It handles:</span>
<span id="cb91-859"><a href="#cb91-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-860"><a href="#cb91-860" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Static interventions (always treat)</span>
<span id="cb91-861"><a href="#cb91-861" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Dynamic interventions (treat based on covariate values)</span>
<span id="cb91-862"><a href="#cb91-862" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stochastic interventions (shift treatment probabilities)</span>
<span id="cb91-863"><a href="#cb91-863" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Censoring adjustment</span>
<span id="cb91-864"><a href="#cb91-864" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Super Learner integration</span>
<span id="cb91-865"><a href="#cb91-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-866"><a href="#cb91-866" aria-hidden="true" tabindex="-1"></a><span class="fu">### LMTP interface (conceptual)</span></span>
<span id="cb91-867"><a href="#cb91-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-868"><a href="#cb91-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb91-869"><a href="#cb91-869" aria-hidden="true" tabindex="-1"></a><span class="in">library(lmtp)</span></span>
<span id="cb91-870"><a href="#cb91-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-871"><a href="#cb91-871" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the shift function for "always high adherence"</span></span>
<span id="cb91-872"><a href="#cb91-872" aria-hidden="true" tabindex="-1"></a><span class="in">always_adhere &lt;- function(data, trt) {</span></span>
<span id="cb91-873"><a href="#cb91-873" aria-hidden="true" tabindex="-1"></a><span class="in">  rep(1, nrow(data))</span></span>
<span id="cb91-874"><a href="#cb91-874" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb91-875"><a href="#cb91-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-876"><a href="#cb91-876" aria-hidden="true" tabindex="-1"></a><span class="in"># Define variable names</span></span>
<span id="cb91-877"><a href="#cb91-877" aria-hidden="true" tabindex="-1"></a><span class="in">trt_vars &lt;- paste0("A_", 1:6)</span></span>
<span id="cb91-878"><a href="#cb91-878" aria-hidden="true" tabindex="-1"></a><span class="in">cens_vars &lt;- paste0("C_", 1:6)</span></span>
<span id="cb91-879"><a href="#cb91-879" aria-hidden="true" tabindex="-1"></a><span class="in">baseline_vars &lt;- c("age", "male", "cd4_bl", "vl_bl", "depress")</span></span>
<span id="cb91-880"><a href="#cb91-880" aria-hidden="true" tabindex="-1"></a><span class="in">tv_vars &lt;- list(</span></span>
<span id="cb91-881"><a href="#cb91-881" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("cd4_", 1:6),</span></span>
<span id="cb91-882"><a href="#cb91-882" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("sympt_", 1:6)</span></span>
<span id="cb91-883"><a href="#cb91-883" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-884"><a href="#cb91-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-885"><a href="#cb91-885" aria-hidden="true" tabindex="-1"></a><span class="in"># Run LMTP-TMLE</span></span>
<span id="cb91-886"><a href="#cb91-886" aria-hidden="true" tabindex="-1"></a><span class="in">result_lmtp &lt;- lmtp_tmle(</span></span>
<span id="cb91-887"><a href="#cb91-887" aria-hidden="true" tabindex="-1"></a><span class="in">  data = dat_wide,</span></span>
<span id="cb91-888"><a href="#cb91-888" aria-hidden="true" tabindex="-1"></a><span class="in">  trt = trt_vars,</span></span>
<span id="cb91-889"><a href="#cb91-889" aria-hidden="true" tabindex="-1"></a><span class="in">  outcome = "Y",</span></span>
<span id="cb91-890"><a href="#cb91-890" aria-hidden="true" tabindex="-1"></a><span class="in">  baseline = baseline_vars,</span></span>
<span id="cb91-891"><a href="#cb91-891" aria-hidden="true" tabindex="-1"></a><span class="in">  time_vary = tv_vars,</span></span>
<span id="cb91-892"><a href="#cb91-892" aria-hidden="true" tabindex="-1"></a><span class="in">  cens = cens_vars,</span></span>
<span id="cb91-893"><a href="#cb91-893" aria-hidden="true" tabindex="-1"></a><span class="in">  shift = always_adhere,</span></span>
<span id="cb91-894"><a href="#cb91-894" aria-hidden="true" tabindex="-1"></a><span class="in">  outcome_type = "binomial",</span></span>
<span id="cb91-895"><a href="#cb91-895" aria-hidden="true" tabindex="-1"></a><span class="in">  learners_outcome = c("SL.glm", "SL.glmnet"),</span></span>
<span id="cb91-896"><a href="#cb91-896" aria-hidden="true" tabindex="-1"></a><span class="in">  learners_trt = c("SL.glm", "SL.glmnet"),</span></span>
<span id="cb91-897"><a href="#cb91-897" aria-hidden="true" tabindex="-1"></a><span class="in">  folds = 5</span></span>
<span id="cb91-898"><a href="#cb91-898" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-899"><a href="#cb91-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-900"><a href="#cb91-900" aria-hidden="true" tabindex="-1"></a><span class="in"># View results</span></span>
<span id="cb91-901"><a href="#cb91-901" aria-hidden="true" tabindex="-1"></a><span class="in">result_lmtp</span></span>
<span id="cb91-902"><a href="#cb91-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-903"><a href="#cb91-903" aria-hidden="true" tabindex="-1"></a><span class="in"># Confidence interval</span></span>
<span id="cb91-904"><a href="#cb91-904" aria-hidden="true" tabindex="-1"></a><span class="in">confint(result_lmtp)</span></span>
<span id="cb91-905"><a href="#cb91-905" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-906"><a href="#cb91-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-907"><a href="#cb91-907" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stochastic intervention: shift adherence probability</span></span>
<span id="cb91-908"><a href="#cb91-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-909"><a href="#cb91-909" aria-hidden="true" tabindex="-1"></a>A more realistic intervention does not force 100% adherence but increases the probability of high adherence:</span>
<span id="cb91-910"><a href="#cb91-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-911"><a href="#cb91-911" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb91-912"><a href="#cb91-912" aria-hidden="true" tabindex="-1"></a><span class="in"># Shift function: increase P(A=1) by 20 percentage points</span></span>
<span id="cb91-913"><a href="#cb91-913" aria-hidden="true" tabindex="-1"></a><span class="in"># but cap at 1</span></span>
<span id="cb91-914"><a href="#cb91-914" aria-hidden="true" tabindex="-1"></a><span class="in">shift_adherence &lt;- function(data, trt) {</span></span>
<span id="cb91-915"><a href="#cb91-915" aria-hidden="true" tabindex="-1"></a><span class="in">  pmin(data[[trt]] + 0.2, 1)</span></span>
<span id="cb91-916"><a href="#cb91-916" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb91-917"><a href="#cb91-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-918"><a href="#cb91-918" aria-hidden="true" tabindex="-1"></a><span class="in">result_shift &lt;- lmtp_tmle(</span></span>
<span id="cb91-919"><a href="#cb91-919" aria-hidden="true" tabindex="-1"></a><span class="in">  data = dat_wide,</span></span>
<span id="cb91-920"><a href="#cb91-920" aria-hidden="true" tabindex="-1"></a><span class="in">  trt = trt_vars,</span></span>
<span id="cb91-921"><a href="#cb91-921" aria-hidden="true" tabindex="-1"></a><span class="in">  outcome = "Y",</span></span>
<span id="cb91-922"><a href="#cb91-922" aria-hidden="true" tabindex="-1"></a><span class="in">  baseline = baseline_vars,</span></span>
<span id="cb91-923"><a href="#cb91-923" aria-hidden="true" tabindex="-1"></a><span class="in">  time_vary = tv_vars,</span></span>
<span id="cb91-924"><a href="#cb91-924" aria-hidden="true" tabindex="-1"></a><span class="in">  cens = cens_vars,</span></span>
<span id="cb91-925"><a href="#cb91-925" aria-hidden="true" tabindex="-1"></a><span class="in">  shift = shift_adherence,</span></span>
<span id="cb91-926"><a href="#cb91-926" aria-hidden="true" tabindex="-1"></a><span class="in">  outcome_type = "binomial",</span></span>
<span id="cb91-927"><a href="#cb91-927" aria-hidden="true" tabindex="-1"></a><span class="in">  learners_outcome = c("SL.glm", "SL.glmnet"),</span></span>
<span id="cb91-928"><a href="#cb91-928" aria-hidden="true" tabindex="-1"></a><span class="in">  learners_trt = c("SL.glm", "SL.glmnet"),</span></span>
<span id="cb91-929"><a href="#cb91-929" aria-hidden="true" tabindex="-1"></a><span class="in">  folds = 5</span></span>
<span id="cb91-930"><a href="#cb91-930" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-931"><a href="#cb91-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-932"><a href="#cb91-932" aria-hidden="true" tabindex="-1"></a><span class="in">result_shift</span></span>
<span id="cb91-933"><a href="#cb91-933" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-934"><a href="#cb91-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-935"><a href="#cb91-935" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb91-936"><a href="#cb91-936" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Stochastic Interventions?</span></span>
<span id="cb91-937"><a href="#cb91-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-938"><a href="#cb91-938" aria-hidden="true" tabindex="-1"></a>Stochastic interventions mitigate positivity violations by only shifting treatment probabilities rather than forcing them to 0 or 1. This makes the estimand more realistic --- no intervention can achieve 100% adherence.</span>
<span id="cb91-939"><a href="#cb91-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-940"><a href="#cb91-940" aria-hidden="true" tabindex="-1"></a>**Three reasons to prefer stochastic interventions:**</span>
<span id="cb91-941"><a href="#cb91-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-942"><a href="#cb91-942" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Realistic estimands:** Asking "what if we increased the probability of adherence by 20%?" is more actionable than "what if everyone adhered perfectly?" No real-world program achieves perfect adherence.</span>
<span id="cb91-943"><a href="#cb91-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-944"><a href="#cb91-944" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Positivity preservation:** If some patients have near-zero probability of adhering (e.g., due to severe side effects), a static "always adhere" intervention violates positivity for those patients. A shift intervention only moves probabilities incrementally, staying within the support of the observed data.</span>
<span id="cb91-945"><a href="#cb91-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-946"><a href="#cb91-946" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Policy relevance:** Decision-makers want to know the expected benefit of feasible interventions (SMS reminders, pill organizers, peer support) that shift adherence by realistic amounts --- not the theoretical maximum under impossible conditions.</span>
<span id="cb91-947"><a href="#cb91-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-948"><a href="#cb91-948" aria-hidden="true" tabindex="-1"></a>The <span class="in">`lmtp`</span> package makes stochastic interventions as easy to implement as static ones --- you just change the shift function.</span>
<span id="cb91-949"><a href="#cb91-949" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-950"><a href="#cb91-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-951"><a href="#cb91-951" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-952"><a href="#cb91-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-953"><a href="#cb91-953" aria-hidden="true" tabindex="-1"></a><span class="fu"># 10. Comparison: GEE vs. IPTW-MSM vs. LTMLE</span></span>
<span id="cb91-954"><a href="#cb91-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-957"><a href="#cb91-957" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-958"><a href="#cb91-958" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb91-959"><a href="#cb91-959" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Naive regression (biased)"</span>,</span>
<span id="cb91-960"><a href="#cb91-960" aria-hidden="true" tabindex="-1"></a>             <span class="st">"IPTW-MSM (truncated weights)"</span>,</span>
<span id="cb91-961"><a href="#cb91-961" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Simplified LTMLE"</span>),</span>
<span id="cb91-962"><a href="#cb91-962" aria-hidden="true" tabindex="-1"></a>  <span class="at">Approach =</span> <span class="fu">c</span>(<span class="st">"Conditions on cumulative adherence"</span>,</span>
<span id="cb91-963"><a href="#cb91-963" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Reweights by cumulative propensity"</span>,</span>
<span id="cb91-964"><a href="#cb91-964" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Sequential targeting with EIC inference"</span>),</span>
<span id="cb91-965"><a href="#cb91-965" aria-hidden="true" tabindex="-1"></a>  <span class="at">Issue =</span> <span class="fu">c</span>(<span class="st">"Confounded by time-varying health"</span>,</span>
<span id="cb91-966"><a href="#cb91-966" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Extreme cumulative weights"</span>,</span>
<span id="cb91-967"><a href="#cb91-967" aria-hidden="true" tabindex="-1"></a>            <span class="st">"More complex but doubly robust"</span>)</span>
<span id="cb91-968"><a href="#cb91-968" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-969"><a href="#cb91-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-970"><a href="#cb91-970" aria-hidden="true" tabindex="-1"></a>comparison</span>
<span id="cb91-971"><a href="#cb91-971" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-972"><a href="#cb91-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-973"><a href="#cb91-973" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-974"><a href="#cb91-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-975"><a href="#cb91-975" aria-hidden="true" tabindex="-1"></a><span class="fu"># 11. Diagnostics for Longitudinal Settings</span></span>
<span id="cb91-976"><a href="#cb91-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-977"><a href="#cb91-977" aria-hidden="true" tabindex="-1"></a><span class="fu">## 11.1 Time-specific propensity score overlap</span></span>
<span id="cb91-978"><a href="#cb91-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-981"><a href="#cb91-981" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-982"><a href="#cb91-982" aria-hidden="true" tabindex="-1"></a><span class="co"># Check overlap at each time point</span></span>
<span id="cb91-983"><a href="#cb91-983" aria-hidden="true" tabindex="-1"></a>overlap_checks <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb91-984"><a href="#cb91-984" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t_val <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb91-985"><a href="#cb91-985" aria-hidden="true" tabindex="-1"></a>  A_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val)</span>
<span id="cb91-986"><a href="#cb91-986" aria-hidden="true" tabindex="-1"></a>  cd4_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"cd4_"</span>, t_val)</span>
<span id="cb91-987"><a href="#cb91-987" aria-hidden="true" tabindex="-1"></a>  sympt_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"sympt_"</span>, t_val)</span>
<span id="cb91-988"><a href="#cb91-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-989"><a href="#cb91-989" aria-hidden="true" tabindex="-1"></a>  formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(cd4_col, sympt_col, <span class="st">"depress"</span>, <span class="st">"age"</span>, <span class="st">"male"</span>)</span>
<span id="cb91-990"><a href="#cb91-990" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (t_val <span class="sc">&gt;</span> <span class="dv">1</span>) formula_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(formula_vars, <span class="fu">paste0</span>(<span class="st">"A_"</span>, t_val <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb91-991"><a href="#cb91-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-992"><a href="#cb91-992" aria-hidden="true" tabindex="-1"></a>  g_check <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb91-993"><a href="#cb91-993" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.formula</span>(<span class="fu">paste</span>(A_col, <span class="st">"~"</span>, <span class="fu">paste</span>(formula_vars, <span class="at">collapse =</span> <span class="st">" + "</span>))),</span>
<span id="cb91-994"><a href="#cb91-994" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial, <span class="at">data =</span> dat_analysis</span>
<span id="cb91-995"><a href="#cb91-995" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-996"><a href="#cb91-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-997"><a href="#cb91-997" aria-hidden="true" tabindex="-1"></a>  ps_check <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_check, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-998"><a href="#cb91-998" aria-hidden="true" tabindex="-1"></a>  overlap_checks[[t_val]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb91-999"><a href="#cb91-999" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> t_val,</span>
<span id="cb91-1000"><a href="#cb91-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps =</span> ps_check,</span>
<span id="cb91-1001"><a href="#cb91-1001" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> dat_analysis[[A_col]]</span>
<span id="cb91-1002"><a href="#cb91-1002" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-1003"><a href="#cb91-1003" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-1004"><a href="#cb91-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1005"><a href="#cb91-1005" aria-hidden="true" tabindex="-1"></a>overlap_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(overlap_checks)</span>
<span id="cb91-1006"><a href="#cb91-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1007"><a href="#cb91-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(overlap_df, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low adherence"</span>, <span class="st">"High adherence"</span>)))) <span class="sc">+</span></span>
<span id="cb91-1008"><a href="#cb91-1008" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb91-1009"><a href="#cb91-1009" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">paste</span>(<span class="st">"Time"</span>, time), <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb91-1010"><a href="#cb91-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-1011"><a href="#cb91-1011" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"P(A_t = 1 | history)"</span>,</span>
<span id="cb91-1012"><a href="#cb91-1012" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Adherence"</span>,</span>
<span id="cb91-1013"><a href="#cb91-1013" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Overlap by Time Point"</span></span>
<span id="cb91-1014"><a href="#cb91-1014" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-1015"><a href="#cb91-1015" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb91-1016"><a href="#cb91-1016" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#EE6677"</span>, <span class="st">"#228833"</span>))</span>
<span id="cb91-1017"><a href="#cb91-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-1018"><a href="#cb91-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1019"><a href="#cb91-1019" aria-hidden="true" tabindex="-1"></a><span class="fu">## 11.2 Cumulative weight distribution</span></span>
<span id="cb91-1020"><a href="#cb91-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1023"><a href="#cb91-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-1024"><a href="#cb91-1024" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cumulative IPTW weight summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-1025"><a href="#cb91-1025" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Before truncation:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-1026"><a href="#cb91-1026" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weight_df<span class="sc">$</span>sw)</span>
<span id="cb91-1027"><a href="#cb91-1027" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">After truncation:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-1028"><a href="#cb91-1028" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weight_df<span class="sc">$</span>sw_trunc)</span>
<span id="cb91-1029"><a href="#cb91-1029" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Fraction &gt; 10:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(weight_df<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-1030"><a href="#cb91-1030" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction &gt; 50:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(weight_df<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">50</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb91-1031"><a href="#cb91-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-1032"><a href="#cb91-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1033"><a href="#cb91-1033" aria-hidden="true" tabindex="-1"></a>Large fractions of extreme weights indicate that the longitudinal treatment mechanism is poorly estimated or that positivity is violated. This motivates using LTMLE over IPTW.</span>
<span id="cb91-1034"><a href="#cb91-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1035"><a href="#cb91-1035" aria-hidden="true" tabindex="-1"></a><span class="fu">## 11.3 Adherence patterns over time</span></span>
<span id="cb91-1036"><a href="#cb91-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1039"><a href="#cb91-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-1040"><a href="#cb91-1040" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize adherence trajectories</span></span>
<span id="cb91-1041"><a href="#cb91-1041" aria-hidden="true" tabindex="-1"></a>adh_summary <span class="ot">&lt;-</span> dat_long <span class="sc">%&gt;%</span></span>
<span id="cb91-1042"><a href="#cb91-1042" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(A)) <span class="sc">%&gt;%</span></span>
<span id="cb91-1043"><a href="#cb91-1043" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb91-1044"><a href="#cb91-1044" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb91-1045"><a href="#cb91-1045" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_adherent =</span> <span class="fu">mean</span>(A),</span>
<span id="cb91-1046"><a href="#cb91-1046" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb91-1047"><a href="#cb91-1047" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb91-1048"><a href="#cb91-1048" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-1049"><a href="#cb91-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1050"><a href="#cb91-1050" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(adh_summary, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pct_adherent)) <span class="sc">+</span></span>
<span id="cb91-1051"><a href="#cb91-1051" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#4477AA"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb91-1052"><a href="#cb91-1052" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"#4477AA"</span>) <span class="sc">+</span></span>
<span id="cb91-1053"><a href="#cb91-1053" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb91-1054"><a href="#cb91-1054" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-1055"><a href="#cb91-1055" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time point"</span>,</span>
<span id="cb91-1056"><a href="#cb91-1056" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Proportion with high adherence"</span>,</span>
<span id="cb91-1057"><a href="#cb91-1057" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Adherence Over Time"</span></span>
<span id="cb91-1058"><a href="#cb91-1058" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-1059"><a href="#cb91-1059" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb91-1060"><a href="#cb91-1060" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-1061"><a href="#cb91-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1062"><a href="#cb91-1062" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-1063"><a href="#cb91-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1064"><a href="#cb91-1064" aria-hidden="true" tabindex="-1"></a><span class="fu"># 12. Imperfect Adherence as an Intercurrent Event</span></span>
<span id="cb91-1065"><a href="#cb91-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1066"><a href="#cb91-1066" aria-hidden="true" tabindex="-1"></a>In the ICH E9(R1) framework for clinical trials, adherence departures are **intercurrent events** that affect the interpretation of treatment effects.</span>
<span id="cb91-1067"><a href="#cb91-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1068"><a href="#cb91-1068" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb91-1069"><a href="#cb91-1069" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimand Strategies for Adherence</span></span>
<span id="cb91-1070"><a href="#cb91-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1071"><a href="#cb91-1071" aria-hidden="true" tabindex="-1"></a>The ICH E9(R1) framework provides four strategies for handling intercurrent events like imperfect adherence. Each answers a different scientific question:</span>
<span id="cb91-1072"><a href="#cb91-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1073"><a href="#cb91-1073" aria-hidden="true" tabindex="-1"></a>| Strategy | Interpretation | Method |</span>
<span id="cb91-1074"><a href="#cb91-1074" aria-hidden="true" tabindex="-1"></a>|----------|---------------|--------|</span>
<span id="cb91-1075"><a href="#cb91-1075" aria-hidden="true" tabindex="-1"></a>| Treatment policy | Effect of being assigned treatment, regardless of adherence | ITT / standard comparison |</span>
<span id="cb91-1076"><a href="#cb91-1076" aria-hidden="true" tabindex="-1"></a>| Hypothetical | Effect if adherence had been maintained | Longitudinal TMLE / LMTP |</span>
<span id="cb91-1077"><a href="#cb91-1077" aria-hidden="true" tabindex="-1"></a>| While on treatment | Effect among the period of actual adherence | Censoring-based methods |</span>
<span id="cb91-1078"><a href="#cb91-1078" aria-hidden="true" tabindex="-1"></a>| Composite | Adherence departure is part of the outcome | Modified outcome |</span>
<span id="cb91-1079"><a href="#cb91-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1080"><a href="#cb91-1080" aria-hidden="true" tabindex="-1"></a>**Longitudinal TMLE and LMTP directly estimate the hypothetical strategy** --- they estimate what would have happened under a counterfactual adherence pattern. This is the most relevant estimand for evaluating whether a treatment works when taken properly.</span>
<span id="cb91-1081"><a href="#cb91-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1082"><a href="#cb91-1082" aria-hidden="true" tabindex="-1"></a>**Why does this matter?** Choosing the wrong estimand strategy leads to answering the wrong question. If a drug works when taken but patients stop taking it due to side effects, the treatment policy estimand (ITT) will understate efficacy. The hypothetical estimand answers "does the drug work?" while the treatment policy estimand answers "does prescribing the drug work?" --- both are valid but serve different decisions.</span>
<span id="cb91-1083"><a href="#cb91-1083" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-1084"><a href="#cb91-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1085"><a href="#cb91-1085" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-1086"><a href="#cb91-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1087"><a href="#cb91-1087" aria-hidden="true" tabindex="-1"></a><span class="fu"># 13. Interpretation</span></span>
<span id="cb91-1088"><a href="#cb91-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1089"><a href="#cb91-1089" aria-hidden="true" tabindex="-1"></a><span class="fu">## What would we tell the public health agency?</span></span>
<span id="cb91-1090"><a href="#cb91-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1091"><a href="#cb91-1091" aria-hidden="true" tabindex="-1"></a>Based on our analysis:</span>
<span id="cb91-1092"><a href="#cb91-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1093"><a href="#cb91-1093" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Under the naturally observed adherence pattern, approximately <span class="in">`r round(mean(Y_supp[alive])*100)`</span>% of patients achieve virologic suppression at 12 months</span>
<span id="cb91-1094"><a href="#cb91-1094" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Under a hypothetical always-high-adherence intervention, the estimated suppression rate is approximately <span class="in">`r round(psi_hat*100)`</span>%</span>
<span id="cb91-1095"><a href="#cb91-1095" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The estimated benefit of ensuring high adherence is approximately <span class="in">`r round((psi_hat - mean(Y_supp[alive]))*100, 1)`</span> percentage points of additional suppression</span>
<span id="cb91-1096"><a href="#cb91-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1097"><a href="#cb91-1097" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implications for adherence support programs</span></span>
<span id="cb91-1098"><a href="#cb91-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1099"><a href="#cb91-1099" aria-hidden="true" tabindex="-1"></a>If increasing adherence from observed levels to near-perfect could improve suppression by this magnitude, investments in adherence support (pill organizers, SMS reminders, peer support, reduced pill burden) may be cost-effective.</span>
<span id="cb91-1100"><a href="#cb91-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1101"><a href="#cb91-1101" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fragile assumptions</span></span>
<span id="cb91-1102"><a href="#cb91-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1103"><a href="#cb91-1103" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Sequential exchangeability:** If unmeasured factors (e.g., substance use severity, housing instability) affect both adherence and outcomes, our estimates are biased</span>
<span id="cb91-1104"><a href="#cb91-1104" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Positivity:** If some patient types never achieve high adherence, we cannot estimate the effect of forcing them to adhere --- stochastic interventions are more appropriate</span>
<span id="cb91-1105"><a href="#cb91-1105" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Independent censoring:** If loss to follow-up is driven by unmeasured factors related to both adherence and outcome, even after conditioning on observed covariates, our censoring adjustment is biased</span>
<span id="cb91-1106"><a href="#cb91-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1107"><a href="#cb91-1107" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-1108"><a href="#cb91-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1109"><a href="#cb91-1109" aria-hidden="true" tabindex="-1"></a><span class="fu"># Key Takeaways</span></span>
<span id="cb91-1110"><a href="#cb91-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1111"><a href="#cb91-1111" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Never condition on time-varying adherence in a regression model** when adherence is affected by time-varying confounders. This introduces collider bias through a feedback loop.</span>
<span id="cb91-1112"><a href="#cb91-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1113"><a href="#cb91-1113" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**GEE models that adjust for time-varying covariates are biased** for causal questions about treatment effects under different adherence patterns.</span>
<span id="cb91-1114"><a href="#cb91-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1115"><a href="#cb91-1115" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Longitudinal IPTW (marginal structural models)** correctly handles time-varying confounding but produces unstable estimates when cumulative weights are extreme.</span>
<span id="cb91-1116"><a href="#cb91-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1117"><a href="#cb91-1117" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Longitudinal TMLE (LTMLE)** avoids the extreme weight problem by targeting the sequential outcome regressions directly. It is doubly robust at each time step and provides influence-curve inference.</span>
<span id="cb91-1118"><a href="#cb91-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1119"><a href="#cb91-1119" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**LMTP extends this framework** to stochastic and modified treatment policies, which are more realistic than static "always treat" interventions and mitigate positivity violations.</span>
<span id="cb91-1120"><a href="#cb91-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1121"><a href="#cb91-1121" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Imperfect adherence is an intercurrent event.** The ICH E9(R1) framework helps clarify which estimand (treatment policy, hypothetical, etc.) matches the decision at hand. Longitudinal TMLE directly estimates the hypothetical strategy.</span>
<span id="cb91-1122"><a href="#cb91-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1123"><a href="#cb91-1123" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Diagnostics in longitudinal settings** require checking propensity score overlap at each time point and inspecting cumulative weight distributions. Extreme cumulative weights are a clear signal to prefer TMLE over IPTW.</span>
<span id="cb91-1124"><a href="#cb91-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-1127"><a href="#cb91-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-1128"><a href="#cb91-1128" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb91-1129"><a href="#cb91-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>