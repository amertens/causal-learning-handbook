<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A practical guide to the Causal Roadmap, Targeted Maximum Likelihood Estimation (TMLE), and Super Learner for modern causal inference in epidemiology, with emphasis on pharmacoepidemiology and clinical trial analysis.">

<title>16&nbsp; Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology – Causal Learning Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-09-illustrated-ltmle.html" rel="next">
<link href="./03-07-longitudinal-td-confounding.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b343bb23504f009ddf7b24643a6af19a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-08-tmle-clean-room.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Causal Learning Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/amertens/causal-learning-handbook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Causal Learning Handbook</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-01-regression-vs-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 1.1: Limitations of Standard Regression Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-02-causal-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 1.2: The Causal Roadmap</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-03-identification-estimands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1.3: From Causal Questions to Analysis — Identification, Estimands, and Statistical Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Roadmap for Real-world Evidence Generation: A Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Estimation Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-01-gcomputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-02-iptw.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-03-doubly-robust-tmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-04-tmle-teaching-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superlearner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-03-longitudinal-case-study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-04-effect-modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-05-advanced-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-07-longitudinal-td-confounding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-08-tmle-clean-room.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-09-illustrated-ltmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-10-tmle-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anotated_bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Annotated Bibliography: Modern Causal Inference and Targeted Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#chapter-3.8-tmle-in-the-clean-room-framework" id="toc-chapter-3.8-tmle-in-the-clean-room-framework" class="nav-link active" data-scroll-target="#chapter-3.8-tmle-in-the-clean-room-framework"><span class="header-section-number">17</span> Chapter 3.8: TMLE in the Clean-Room Framework</a></li>
  <li><a href="#clinical-motivation" id="toc-clinical-motivation" class="nav-link" data-scroll-target="#clinical-motivation"><span class="header-section-number">18</span> 1. Clinical Motivation</a>
  <ul class="collapse">
  <li><a href="#the-regulatory-question" id="toc-the-regulatory-question" class="nav-link" data-scroll-target="#the-regulatory-question"><span class="header-section-number">18.1</span> The Regulatory Question</a>
  <ul class="collapse">
  <li><a href="#key-elements" id="toc-key-elements" class="nav-link" data-scroll-target="#key-elements"><span class="header-section-number">18.1.1</span> Key elements</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#clean-room-workflow-overview" id="toc-clean-room-workflow-overview" class="nav-link" data-scroll-target="#clean-room-workflow-overview"><span class="header-section-number">19</span> 2. Clean-Room Workflow Overview</a></li>
  <li><a href="#phase-1-pre-specified-protocol" id="toc-phase-1-pre-specified-protocol" class="nav-link" data-scroll-target="#phase-1-pre-specified-protocol"><span class="header-section-number">20</span> 3. Phase 1: Pre-Specified Protocol</a>
  <ul class="collapse">
  <li><a href="#causal-question-and-estimand" id="toc-causal-question-and-estimand" class="nav-link" data-scroll-target="#causal-question-and-estimand"><span class="header-section-number">20.1</span> 3.1 Causal Question and Estimand</a></li>
  <li><a href="#causal-model-dag" id="toc-causal-model-dag" class="nav-link" data-scroll-target="#causal-model-dag"><span class="header-section-number">20.2</span> 3.2 Causal Model (DAG)</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions"><span class="header-section-number">20.3</span> 3.3 Assumptions</a></li>
  <li><a href="#pre-specified-analysis-plan" id="toc-pre-specified-analysis-plan" class="nav-link" data-scroll-target="#pre-specified-analysis-plan"><span class="header-section-number">20.4</span> 3.4 Pre-Specified Analysis Plan</a></li>
  </ul></li>
  <li><a href="#simulated-claims-like-data" id="toc-simulated-claims-like-data" class="nav-link" data-scroll-target="#simulated-claims-like-data"><span class="header-section-number">21</span> 4. Simulated Claims-Like Data</a>
  <ul class="collapse">
  <li><a href="#true-causal-effect" id="toc-true-causal-effect" class="nav-link" data-scroll-target="#true-causal-effect"><span class="header-section-number">21.0.1</span> True causal effect</a></li>
  <li><a href="#data-summary-what-the-analyst-sees" id="toc-data-summary-what-the-analyst-sees" class="nav-link" data-scroll-target="#data-summary-what-the-analyst-sees"><span class="header-section-number">21.0.2</span> Data summary (what the analyst sees)</a></li>
  </ul></li>
  <li><a href="#phase-3-locked-analysis-pipeline" id="toc-phase-3-locked-analysis-pipeline" class="nav-link" data-scroll-target="#phase-3-locked-analysis-pipeline"><span class="header-section-number">22</span> 5. Phase 3: Locked Analysis Pipeline</a>
  <ul class="collapse">
  <li><a href="#step-1-propensity-score-estimation" id="toc-step-1-propensity-score-estimation" class="nav-link" data-scroll-target="#step-1-propensity-score-estimation"><span class="header-section-number">22.1</span> 5.1 Step 1: Propensity Score Estimation</a></li>
  <li><a href="#step-2-pre-specified-diagnostics-covariate-balance" id="toc-step-2-pre-specified-diagnostics-covariate-balance" class="nav-link" data-scroll-target="#step-2-pre-specified-diagnostics-covariate-balance"><span class="header-section-number">22.2</span> 5.2 Step 2: Pre-Specified Diagnostics (Covariate Balance)</a>
  <ul class="collapse">
  <li><a href="#propensity-score-overlap" id="toc-propensity-score-overlap" class="nav-link" data-scroll-target="#propensity-score-overlap"><span class="header-section-number">22.2.1</span> Propensity score overlap</a></li>
  <li><a href="#covariate-balance-standardized-mean-differences" id="toc-covariate-balance-standardized-mean-differences" class="nav-link" data-scroll-target="#covariate-balance-standardized-mean-differences"><span class="header-section-number">22.2.2</span> Covariate balance: Standardized Mean Differences</a></li>
  <li><a href="#weight-distribution" id="toc-weight-distribution" class="nav-link" data-scroll-target="#weight-distribution"><span class="header-section-number">22.2.3</span> Weight distribution</a></li>
  </ul></li>
  <li><a href="#step-3-primary-estimator-tmle-by-hand" id="toc-step-3-primary-estimator-tmle-by-hand" class="nav-link" data-scroll-target="#step-3-primary-estimator-tmle-by-hand"><span class="header-section-number">22.3</span> 5.3 Step 3: Primary Estimator — TMLE (by hand)</a></li>
  <li><a href="#step-4-secondary-estimators-for-comparison" id="toc-step-4-secondary-estimators-for-comparison" class="nav-link" data-scroll-target="#step-4-secondary-estimators-for-comparison"><span class="header-section-number">22.4</span> 5.4 Step 4: Secondary Estimators (for comparison)</a>
  <ul class="collapse">
  <li><a href="#g-computation" id="toc-g-computation" class="nav-link" data-scroll-target="#g-computation"><span class="header-section-number">22.4.1</span> G-computation</a></li>
  <li><a href="#iptw" id="toc-iptw" class="nav-link" data-scroll-target="#iptw"><span class="header-section-number">22.4.2</span> IPTW</a></li>
  <li><a href="#comparison-table" id="toc-comparison-table" class="nav-link" data-scroll-target="#comparison-table"><span class="header-section-number">22.4.3</span> Comparison table</a></li>
  </ul></li>
  <li><a href="#step-5-post-estimation-diagnostics" id="toc-step-5-post-estimation-diagnostics" class="nav-link" data-scroll-target="#step-5-post-estimation-diagnostics"><span class="header-section-number">22.5</span> 5.5 Step 5: Post-Estimation Diagnostics</a>
  <ul class="collapse">
  <li><a href="#clever-covariate-distribution" id="toc-clever-covariate-distribution" class="nav-link" data-scroll-target="#clever-covariate-distribution"><span class="header-section-number">22.5.1</span> Clever covariate distribution</a></li>
  <li><a href="#influence-curve-stability" id="toc-influence-curve-stability" class="nav-link" data-scroll-target="#influence-curve-stability"><span class="header-section-number">22.5.2</span> Influence curve stability</a></li>
  <li><a href="#predicted-risk-distribution" id="toc-predicted-risk-distribution" class="nav-link" data-scroll-target="#predicted-risk-distribution"><span class="header-section-number">22.5.3</span> Predicted risk distribution</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#super-learner-integration" id="toc-super-learner-integration" class="nav-link" data-scroll-target="#super-learner-integration"><span class="header-section-number">23</span> 6. Super Learner Integration</a>
  <ul class="collapse">
  <li><a href="#pre-specified-super-learner-library-from-sap" id="toc-pre-specified-super-learner-library-from-sap" class="nav-link" data-scroll-target="#pre-specified-super-learner-library-from-sap"><span class="header-section-number">23.0.1</span> Pre-specified Super Learner library (from SAP)</a></li>
  <li><a href="#using-super-learner-predictions-in-tmle" id="toc-using-super-learner-predictions-in-tmle" class="nav-link" data-scroll-target="#using-super-learner-predictions-in-tmle"><span class="header-section-number">23.0.2</span> Using Super Learner predictions in TMLE</a></li>
  </ul></li>
  <li><a href="#the-audit-trail" id="toc-the-audit-trail" class="nav-link" data-scroll-target="#the-audit-trail"><span class="header-section-number">24</span> 7. The Audit Trail</a></li>
  <li><a href="#sensitivity-analysis-e-value" id="toc-sensitivity-analysis-e-value" class="nav-link" data-scroll-target="#sensitivity-analysis-e-value"><span class="header-section-number">25</span> 8. Sensitivity Analysis: E-value</a></li>
  <li><a href="#interpretation-in-regulatory-context" id="toc-interpretation-in-regulatory-context" class="nav-link" data-scroll-target="#interpretation-in-regulatory-context"><span class="header-section-number">26</span> 9. Interpretation in Regulatory Context</a>
  <ul class="collapse">
  <li><a href="#results-summary" id="toc-results-summary" class="nav-link" data-scroll-target="#results-summary"><span class="header-section-number">26.1</span> Results summary</a></li>
  <li><a href="#how-tmle-supports-the-regulatory-decision" id="toc-how-tmle-supports-the-regulatory-decision" class="nav-link" data-scroll-target="#how-tmle-supports-the-regulatory-decision"><span class="header-section-number">26.2</span> How TMLE supports the regulatory decision</a></li>
  <li><a href="#what-assumptions-are-most-fragile" id="toc-what-assumptions-are-most-fragile" class="nav-link" data-scroll-target="#what-assumptions-are-most-fragile"><span class="header-section-number">26.3</span> What assumptions are most fragile?</a></li>
  </ul></li>
  <li><a href="#distributed-data-extension" id="toc-distributed-data-extension" class="nav-link" data-scroll-target="#distributed-data-extension"><span class="header-section-number">27</span> 10. Distributed Data Extension</a>
  <ul class="collapse">
  <li><a href="#site-level-tmle" id="toc-site-level-tmle" class="nav-link" data-scroll-target="#site-level-tmle"><span class="header-section-number">27.0.1</span> Site-level TMLE</a></li>
  <li><a href="#meta-analysis-of-site-level-tmle-estimates" id="toc-meta-analysis-of-site-level-tmle-estimates" class="nav-link" data-scroll-target="#meta-analysis-of-site-level-tmle-estimates"><span class="header-section-number">27.0.2</span> Meta-analysis of site-level TMLE estimates</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">28</span> Key Takeaways</a>
  <ul class="collapse">
  <li><a href="#software-implementation-r" id="toc-software-implementation-r" class="nav-link" data-scroll-target="#software-implementation-r"><span class="header-section-number">28.1</span> Software Implementation (R)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-08-tmle-clean-room.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="chapter-3.8-tmle-in-the-clean-room-framework" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> Chapter 3.8: TMLE in the Clean-Room Framework</h1>
<p><em>Pre-specified, reproducible causal inference for regulatory pharmacoepidemiology</em></p>
<p>In many regulatory settings, analysts cannot freely explore the data. Post-marketing safety studies, multi-database pharmacoepidemiology collaborations, and distributed data network analyses often require a <strong>clean-room workflow</strong>: the analysis plan is pre-specified before data access, code is locked, and the analyst has minimal or no opportunity to iterate on model choices after seeing the data.</p>
<p>This is the opposite of typical exploratory data analysis — and it is where TMLE shines.</p>
<p>This chapter demonstrates how to implement TMLE in a clean-room regulatory context, using a motivating example inspired by the <strong>NSAIDs vs.&nbsp;opioids acute kidney injury (AKI)</strong> safety question.</p>
<hr>
</section>
<section id="clinical-motivation" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> 1. Clinical Motivation</h1>
<section id="the-regulatory-question" class="level2" data-number="18.1">
<h2 data-number="18.1" class="anchored" data-anchor-id="the-regulatory-question"><span class="header-section-number">18.1</span> The Regulatory Question</h2>
<p>A distributed research network (similar to the FDA Sentinel system) has flagged a potential safety signal:</p>
<blockquote class="blockquote">
<p><strong>Does initiation of prescription NSAIDs increase the 90-day risk of acute kidney injury compared to initiation of prescription opioids among adults with musculoskeletal pain?</strong></p>
</blockquote>
<p>This question arises in a post-marketing surveillance context where:</p>
<ul>
<li><strong>Raw patient-level data cannot leave participating sites</strong> (privacy, legal, or contractual constraints)</li>
<li>The analysis must be <strong>pre-specified</strong> in a Statistical Analysis Plan (SAP) before any data access</li>
<li>Results must be <strong>reproducible</strong> — running the same code on the same data yields identical results</li>
<li>The analyst cannot iterate on model specifications after seeing the data</li>
<li>There is an <strong>audit trail</strong> documenting every analysis step</li>
</ul>
<section id="key-elements" class="level3" data-number="18.1.1">
<h3 data-number="18.1.1" class="anchored" data-anchor-id="key-elements"><span class="header-section-number">18.1.1</span> Key elements</h3>
<ul>
<li><strong>Target population:</strong> Adults aged 18-80 with a new musculoskeletal pain diagnosis initiating either NSAIDs or opioids</li>
<li><strong>Treatment:</strong> NSAID initiation (A = 1) vs.&nbsp;opioid initiation (A = 0)</li>
<li><strong>Outcome:</strong> AKI within 90 days (binary)</li>
<li><strong>Decision:</strong> Should the NSAID label carry a stronger AKI warning? Should prescribing guidelines be updated?</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why TMLE for Clean-Room?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Traditional regression-based analyses require the analyst to choose a single model specification — a process that invites data-dependent decisions. Every time an analyst looks at the data and adjusts a model, the pre-specification principle is compromised. TMLE with Super Learner sidesteps this problem entirely:</p>
<ol type="1">
<li><strong>Pre-specify a learner library, not a single model.</strong> The SAP lists the candidate algorithms. Cross-validation — not the analyst — picks the best combination. No post-hoc model selection is required.</li>
<li><strong>Double robustness protects you.</strong> Even if the outcome model or the treatment model is misspecified, the estimate remains consistent as long as at least one is correct. This is invaluable when you cannot iterate after seeing the data.</li>
<li><strong>Influence-curve inference is automatic.</strong> Valid standard errors come directly from the efficient influence curve — no bootstrap needed, no distributional assumptions beyond the nonparametric model.</li>
<li><strong>Full determinism.</strong> Given the same data, learner library, and random seed, the entire pipeline produces bit-identical results. Every run is reproducible.</li>
<li><strong>The audit trail writes itself.</strong> Cross-validated learner weights, the fluctuation parameter, and every diagnostic are logged as natural byproducts of the algorithm.</li>
</ol>
<p>In short, TMLE turns the clean-room constraint from a limitation into a strength: the algorithm makes the decisions that the analyst is not allowed to make.</p>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="clean-room-workflow-overview" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> 2. Clean-Room Workflow Overview</h1>
<p>A clean-room analysis proceeds in distinct phases. Each phase has a clear purpose and strict boundaries. Before we walk through the details, here is the high-level roadmap:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Phase 1: Protocol Development (before data access)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Everything happens on paper before you touch the data. This is the foundation of the entire analysis.</p>
<ul>
<li>Define the causal question, DAG, and estimand</li>
<li>Write the SAP specifying all analysis steps</li>
<li>Pre-specify the Super Learner library</li>
<li>Define all diagnostics that will be run</li>
<li>Lock the analysis code in a version-controlled repository</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Phase 2: Data Preparation (minimal data contact)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Data preparation follows pre-written scripts. The analyst executes queries but does not explore.</p>
<ul>
<li>Execute pre-written data extraction queries</li>
<li>Apply inclusion/exclusion criteria</li>
<li>Create analysis-ready dataset</li>
<li>No exploratory analysis</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Phase 3: Analysis Execution (locked code)
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is where the pre-specified TMLE pipeline runs. The analyst presses “go” and does not modify anything.</p>
<ul>
<li>Run the pre-specified TMLE pipeline</li>
<li>Generate all pre-specified diagnostics</li>
<li>No code modifications allowed</li>
<li>Capture all output deterministically</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Phase 4: Reporting
</div>
</div>
<div class="callout-body-container callout-body">
<p>Results are interpreted according to pre-specified decision rules. Any deviation from the protocol is documented.</p>
<ul>
<li>Interpret results according to pre-specified rules</li>
<li>Document any deviations from the protocol</li>
<li>Maintain audit trail</li>
</ul>
</div>
</div>
<p>We now walk through each phase.</p>
<hr>
</section>
<section id="phase-1-pre-specified-protocol" class="level1" data-number="20">
<h1 data-number="20"><span class="header-section-number">20</span> 3. Phase 1: Pre-Specified Protocol</h1>
<section id="causal-question-and-estimand" class="level2" data-number="20.1">
<h2 data-number="20.1" class="anchored" data-anchor-id="causal-question-and-estimand"><span class="header-section-number">20.1</span> 3.1 Causal Question and Estimand</h2>
<p>Before touching any data, we write down exactly what we want to estimate and why.</p>
<p><strong>Question (plain language):</strong> What is the 90-day AKI risk if all eligible patients initiated NSAIDs, compared to if all eligible patients initiated opioids?</p>
<p><strong>Estimand:</strong> Average Treatment Effect on the risk difference scale:</p>
<p><span class="math display">\[
\psi = E[Y(1)] - E[Y(0)]
\]</span></p>
<p>where <span class="math inline">\(Y(1)\)</span> is the potential AKI outcome under NSAID initiation and <span class="math inline">\(Y(0)\)</span> under opioid initiation.</p>
</section>
<section id="causal-model-dag" class="level2" data-number="20.2">
<h2 data-number="20.2" class="anchored" data-anchor-id="causal-model-dag"><span class="header-section-number">20.2</span> 3.2 Causal Model (DAG)</h2>
<pre><code>Confounders (W):
  age, sex, CKD stage, diabetes, hypertension,
  prior NSAID use, prior opioid use, ACE/ARB use,
  number of concomitant medications, healthcare utilization

      W
     / \
    v   v
    A -&gt; Y</code></pre>
<p>All measured confounders <span class="math inline">\(W\)</span> affect both treatment choice <span class="math inline">\(A\)</span> and outcome <span class="math inline">\(Y\)</span>. The active comparator design (NSAID vs.&nbsp;opioid) helps control for confounding by indication — both groups have pain requiring treatment.</p>
</section>
<section id="assumptions" class="level2" data-number="20.3">
<h2 data-number="20.3" class="anchored" data-anchor-id="assumptions"><span class="header-section-number">20.3</span> 3.3 Assumptions</h2>
<p>The causal identification assumptions must be stated and scrutinized before the analysis begins. These are the claims that no statistical method can verify from data alone.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Causal Assumptions — State Them Clearly, Question Them Honestly
</div>
</div>
<div class="callout-body-container callout-body">
<p>Every causal estimate rests on untestable assumptions. In a clean-room analysis, these are locked into the protocol and cannot be revised after seeing results. Be explicit about where each assumption could fail:</p>
<ul>
<li><strong>Consistency:</strong> Initiation of a new NSAID (or opioid) prescription, irrespective of specific agent within class. This assumes that within-class variation in drug choice does not meaningfully affect AKI risk.</li>
<li><strong>Exchangeability:</strong> Conditional on <span class="math inline">\(W\)</span>, treatment choice is independent of potential outcomes. <em>This is the most fragile assumption.</em> Unmeasured confounders — OTC NSAID use, frailty, kidney function trajectory — could violate it. The E-value sensitivity analysis (Section 8) quantifies how strong such confounding would need to be.</li>
<li><strong>Positivity:</strong> Both drugs are plausible options for all covariate strata. Severe CKD patients are rarely prescribed NSAIDs, which could lead to near-violations. The propensity score overlap diagnostics will flag this.</li>
</ul>
</div>
</div>
</section>
<section id="pre-specified-analysis-plan" class="level2" data-number="20.4">
<h2 data-number="20.4" class="anchored" data-anchor-id="pre-specified-analysis-plan"><span class="header-section-number">20.4</span> 3.4 Pre-Specified Analysis Plan</h2>
<p>The SAP is the contract between the analyst and the regulator. Once signed, every element below is locked.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Statistical Analysis Plan — Locked Before Data Access
</div>
</div>
<div class="callout-body-container callout-body">
<p>The following specifications are frozen in the SAP. No modifications are permitted after data access.</p>
<ol type="1">
<li><strong>Primary estimator:</strong> TMLE with Super Learner</li>
<li><strong>Super Learner library:</strong>
<ul>
<li><code>SL.glm</code> (logistic regression)</li>
<li><code>SL.glm.interaction</code> (logistic with all two-way interactions)</li>
<li><code>SL.step</code> (stepwise regression)</li>
<li><code>SL.mean</code> (intercept-only, for benchmarking)</li>
</ul></li>
<li><strong>Number of cross-validation folds:</strong> 5</li>
<li><strong>Propensity score bounds:</strong> Truncate at [0.025, 0.975]</li>
<li><strong>Secondary estimators:</strong> G-computation, IPTW (for comparison)</li>
<li><strong>Pre-specified diagnostics:</strong> PS overlap, weight distribution, covariate balance (SMD &lt; 0.1 threshold), EIC mean check</li>
<li><strong>Sensitivity analyses:</strong> E-value for unmeasured confounding</li>
<li><strong>Seed:</strong> 20260101 (locked in SAP)</li>
</ol>
<p>Why does each element matter? The learner library determines what models the algorithm can consider. The CV folds control the bias-variance trade-off in model selection. The PS bounds prevent extreme weights. The diagnostics confirm that the estimation procedure is operating in a regime where we trust it. And the seed ensures anyone can reproduce the exact numerical result.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="simulated-claims-like-data" class="level1" data-number="21">
<h1 data-number="21"><span class="header-section-number">21</span> 4. Simulated Claims-Like Data</h1>
<p>We simulate data resembling insurance claims with realistic variable distributions and nonlinear relationships. In a real clean-room analysis, this section would be replaced by the pre-written data extraction queries from Phase 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.6.0
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># LOCKED SEED — specified in the Statistical Analysis Plan</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20260101</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">8000</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline confounders (claims-derived) ---</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Demographics</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>age  <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">runif</span>(n, <span class="dv">18</span>, <span class="dv">80</span>))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>male <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.45</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Comorbidities (from diagnosis codes)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># CKD stage (0=none, 1=mild, 2=moderate, 3=severe)</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>ckd <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="fl">0.15</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>))</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>diabetes   <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">2.0</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> (ckd <span class="sc">&gt;</span> <span class="dv">0</span>)))</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>hypertension <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> male))</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Medication history</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>prior_nsaid <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.35</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>prior_opioid <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.20</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>ace_arb     <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.8</span> <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> hypertension <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> diabetes))</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Healthcare utilization (proxy for overall health burden)</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>n_rx <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="at">lambda =</span> <span class="dv">3</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> (ckd <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">+</span> diabetes)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>n_visits <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="at">lambda =</span> <span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> age <span class="sc">+</span> ckd <span class="sc">+</span> diabetes)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment model ---</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co"># NSAIDs are preferentially prescribed to:</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># - younger patients</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># - those without CKD (contraindication concern)</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># - those with prior NSAID use (familiarity)</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># - those without ACE/ARB use (drug interaction concern)</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes nonlinear age effect and interactions</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="sc">+</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.02</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.0005</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">*</span> diabetes <span class="sc">+</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span> <span class="sc">*</span> prior_nsaid <span class="sc">+</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> prior_opioid <span class="sc">+</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.4</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> n_rx <span class="sc">+</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.15</span> <span class="sc">*</span> male <span class="sc">+</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.3</span> <span class="sc">*</span> prior_nsaid <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">0</span>)  <span class="co"># interaction: prior NSAID use matters more without CKD</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_trt))</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome model ---</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="co"># AKI risk depends on treatment and confounders</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="co"># True effect: NSAIDs moderately increase AKI risk</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>lp_out <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">4.5</span> <span class="sc">+</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.45</span> <span class="sc">*</span> A <span class="sc">+</span>                              <span class="co"># true causal effect (harmful)</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.0003</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.6</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.2</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.4</span> <span class="sc">*</span> diabetes <span class="sc">+</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.3</span> <span class="sc">*</span> hypertension <span class="sc">+</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.05</span> <span class="sc">*</span> n_rx <span class="sc">+</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.25</span> <span class="sc">*</span> A <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span>                <span class="co"># interaction: NSAIDs more harmful with CKD</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.15</span> <span class="sc">*</span> A <span class="sc">*</span> ace_arb <span class="sc">+</span>                    <span class="co"># interaction: NSAIDs + ACE/ARB</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> male</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_out))</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  age, male, ckd, diabetes, hypertension,</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  prior_nsaid, prior_opioid, ace_arb,</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  n_rx, n_visits, A, Y</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="true-causal-effect" class="level3" data-number="21.0.1">
<h3 data-number="21.0.1" class="anchored" data-anchor-id="true-causal-effect"><span class="header-section-number">21.0.1</span> True causal effect</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the true ATE from the data-generating process</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>p1_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">4.5</span> <span class="sc">+</span> <span class="fl">0.45</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span> <span class="fl">0.0003</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.6</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">1.2</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">2.0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.4</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> hypertension <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.05</span> <span class="sc">*</span> n_rx <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> male)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>p0_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">4.5</span> <span class="sc">+</span> <span class="fl">0.45</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span> <span class="fl">0.0003</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.6</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">1.2</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">2.0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.4</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> hypertension <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.05</span> <span class="sc">*</span> n_rx <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> male)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>true_ate <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_true <span class="sc">-</span> p0_true)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE (risk difference):"</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE (risk difference): 0.0334 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under NSAIDs: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p1_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True risk under NSAIDs:  0.0852 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under opioids:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p0_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True risk under opioids: 0.0518 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AKI event rate overall: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Y), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AKI event rate overall:  0.0664 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Treatment prevalence:   "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(A), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Treatment prevalence:    0.5044 </code></pre>
</div>
</div>
</section>
<section id="data-summary-what-the-analyst-sees" class="level3" data-number="21.0.2">
<h3 data-number="21.0.2" class="anchored" data-anchor-id="data-summary-what-the-analyst-sees"><span class="header-section-number">21.0.2</span> Data summary (what the analyst sees)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariate distributions by treatment group</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n          =</span> <span class="fu">n</span>(),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_age   =</span> <span class="fu">mean</span>(age),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_male   =</span> <span class="fu">mean</span>(male),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_ckd_2plus =</span> <span class="fu">mean</span>(ckd <span class="sc">&gt;=</span> <span class="dv">2</span>),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_diabetes  =</span> <span class="fu">mean</span>(diabetes),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_htn    =</span> <span class="fu">mean</span>(hypertension),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_prior_nsaid =</span> <span class="fu">mean</span>(prior_nsaid),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_ace_arb =</span> <span class="fu">mean</span>(ace_arb),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_n_rx  =</span> <span class="fu">mean</span>(n_rx),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">aki_rate   =</span> <span class="fu">mean</span>(Y),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 11
      A     n mean_age pct_male pct_ckd_2plus pct_diabetes pct_htn
  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;   &lt;dbl&gt;
1     0  3965     52.5    0.433        0.211         0.452   0.667
2     1  4035     46.1    0.476        0.0949        0.353   0.589
# ℹ 4 more variables: pct_prior_nsaid &lt;dbl&gt;, pct_ace_arb &lt;dbl&gt;,
#   mean_n_rx &lt;dbl&gt;, aki_rate &lt;dbl&gt;</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-3-locked-analysis-pipeline" class="level1" data-number="22">
<h1 data-number="22"><span class="header-section-number">22</span> 5. Phase 3: Locked Analysis Pipeline</h1>
<p>The following code represents the <strong>locked analysis</strong> that runs without modification. Every step is pre-specified. We walk through each step with a plain-language explanation first, then show the code.</p>
<section id="step-1-propensity-score-estimation" class="level2" data-number="22.1">
<h2 data-number="22.1" class="anchored" data-anchor-id="step-1-propensity-score-estimation"><span class="header-section-number">22.1</span> 5.1 Step 1: Propensity Score Estimation</h2>
<p>Before we can estimate the treatment effect, we need to model the treatment assignment mechanism. The propensity score answers the question: given a patient’s baseline characteristics, how likely were they to receive NSAIDs rather than opioids?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 1: Estimate the Propensity Score
</div>
</div>
<div class="callout-body-container callout-body">
<p>The propensity score <span class="math inline">\(g(W) = P(A = 1 \mid W)\)</span> estimates each patient’s probability of receiving NSAIDs given their baseline covariates. We need this for two reasons:</p>
<ol type="1">
<li>It allows us to construct the <strong>clever covariate</strong> that targets the TMLE update toward the causal parameter of interest.</li>
<li>It helps us assess <strong>positivity</strong> — whether both treatments are plausible for all patients.</li>
</ol>
<p>The model formula and truncation bounds were locked in the SAP before data access. Truncation at [0.025, 0.975] prevents extreme inverse-probability weights from individual observations dominating the estimate.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PRE-SPECIFIED: Propensity score model</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 4.2: Use logistic regression with all baseline</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># covariates, squared age term, and CKD indicators</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"ckd"</span>, <span class="st">"diabetes"</span>, <span class="st">"hypertension"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">"prior_nsaid"</span>, <span class="st">"prior_opioid"</span>, <span class="st">"ace_arb"</span>, <span class="st">"n_rx"</span>, <span class="st">"n_visits"</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert CKD to factor for proper modeling</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ckd_f =</span> <span class="fu">factor</span>(ckd))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>g_formula <span class="ot">&lt;-</span> A <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> male <span class="sc">+</span> ckd_f <span class="sc">+</span> diabetes <span class="sc">+</span> hypertension <span class="sc">+</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  prior_nsaid <span class="sc">+</span> prior_opioid <span class="sc">+</span> ace_arb <span class="sc">+</span> n_rx <span class="sc">+</span> n_visits <span class="sc">+</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  prior_nsaid<span class="sc">:</span>ckd_f <span class="sc">+</span> ace_arb<span class="sc">:</span>diabetes</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(g_formula, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># PRE-SPECIFIED: Truncate at [0.025, 0.975]</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps_trunc <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.025</span>, <span class="fu">pmin</span>(<span class="fl">0.975</span>, dat<span class="sc">$</span>ps))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-pre-specified-diagnostics-covariate-balance" class="level2" data-number="22.2">
<h2 data-number="22.2" class="anchored" data-anchor-id="step-2-pre-specified-diagnostics-covariate-balance"><span class="header-section-number">22.2</span> 5.2 Step 2: Pre-Specified Diagnostics (Covariate Balance)</h2>
<p>These diagnostics are run <strong>before</strong> looking at the effect estimate, to confirm that the propensity score model is adequate. Think of this as a quality gate: if the diagnostics fail, we know the estimation is unreliable regardless of what number comes out.</p>
<section id="propensity-score-overlap" class="level3" data-number="22.2.1">
<h3 data-number="22.2.1" class="anchored" data-anchor-id="propensity-score-overlap"><span class="header-section-number">22.2.1</span> Propensity score overlap</h3>
<p>The overlap plot is the most important single diagnostic. If the two treatment groups have propensity score distributions that do not overlap, we are trying to compare patients who are fundamentally different — and no statistical method can rescue that.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What to Look For: Propensity Score Overlap
</div>
</div>
<div class="callout-body-container callout-body">
<p>A healthy overlap plot shows two distributions that cover a similar range, with substantial overlap in the middle. Warning signs include:</p>
<ul>
<li><strong>Separation:</strong> If the two curves barely overlap, positivity is violated and the estimate will rely heavily on extrapolation.</li>
<li><strong>Spikes near 0 or 1:</strong> Patients with propensity scores near the boundaries contribute extreme weights. The truncation at [0.025, 0.975] mitigates this, but if many patients are truncated, the effective estimand changes.</li>
<li><strong>Asymmetry:</strong> If one group is concentrated in a narrow range while the other is spread out, consider whether the target population needs to be restricted.</li>
</ul>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 1: Propensity score overlap</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.1</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>)))) <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated propensity score P(NSAID | W)"</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 1: Propensity Score Overlap"</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-08-tmle-clean-room_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantile summary</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">Treatment =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min  =</span> <span class="fu">round</span>(<span class="fu">min</span>(ps), <span class="dv">3</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">p5   =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.05</span>), <span class="dv">3</span>),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">p25  =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.25</span>), <span class="dv">3</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">round</span>(<span class="fu">median</span>(ps), <span class="dv">3</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">p75  =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.75</span>), <span class="dv">3</span>),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">p95  =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.95</span>), <span class="dv">3</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">max  =</span> <span class="fu">round</span>(<span class="fu">max</span>(ps), <span class="dv">3</span>),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 8
  Treatment   min    p5   p25 median   p75   p95   max
  &lt;fct&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Opioid    0.075 0.202 0.328  0.447 0.561 0.733 0.841
2 NSAID     0.077 0.287 0.459  0.564 0.667 0.801 0.841</code></pre>
</div>
</div>
</section>
<section id="covariate-balance-standardized-mean-differences" class="level3" data-number="22.2.2">
<h3 data-number="22.2.2" class="anchored" data-anchor-id="covariate-balance-standardized-mean-differences"><span class="header-section-number">22.2.2</span> Covariate balance: Standardized Mean Differences</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What to Look For: Covariate Balance
</div>
</div>
<div class="callout-body-container callout-body">
<p>Standardized Mean Differences (SMDs) measure how different the treatment groups are on each covariate. The SAP pre-specifies a threshold of SMD &lt; 0.1 for adequate balance.</p>
<ul>
<li><strong>Unadjusted SMDs</strong> show the raw imbalance in the data. Large values confirm confounding is present.</li>
<li><strong>Weighted SMDs</strong> show the imbalance after IPTW adjustment. If all weighted SMDs fall below 0.1, the propensity score model has successfully balanced the groups on observed covariates.</li>
<li><strong>The Love plot</strong> visualizes this comparison. Look for all weighted points (green) to fall left of the dashed 0.1 threshold line.</li>
</ul>
<p>If weighted SMDs remain above 0.1 for important confounders, the propensity score model needs refinement — but in a clean-room analysis, this would have been caught in the simulation phase and the model adjusted before locking the code.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 2: Covariate balance before and after weighting</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.2: SMD threshold &lt; 0.1</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>compute_smd <span class="ot">&lt;-</span> <span class="cf">function</span>(data, var, trt, <span class="at">weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(weights)) weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  w1 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  w0 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d1, w1)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d0, w0)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w1 <span class="sc">*</span> (d1 <span class="sc">-</span> m1)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w1))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  s0 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w0 <span class="sc">*</span> (d0 <span class="sc">-</span> m0)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w0))</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  pooled_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((s1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> s0<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pooled_sd <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  (m1 <span class="sc">-</span> m0) <span class="sc">/</span> pooled_sd</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Stabilized IPTW weights for balance assessment</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>p_A <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>A)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                 p_A <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>                 (<span class="dv">1</span> <span class="sc">-</span> p_A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc))</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>balance_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"ckd"</span>, <span class="st">"diabetes"</span>, <span class="st">"hypertension"</span>,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"prior_nsaid"</span>, <span class="st">"prior_opioid"</span>, <span class="st">"ace_arb"</span>, <span class="st">"n_rx"</span>, <span class="st">"n_visits"</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>smd_raw <span class="ot">&lt;-</span> <span class="fu">sapply</span>(balance_vars, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>))</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>smd_wt  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(balance_vars, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>, dat<span class="sc">$</span>sw))</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>balance_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">Covariate  =</span> balance_vars,</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">Unadjusted =</span> <span class="fu">round</span>(<span class="fu">abs</span>(smd_raw), <span class="dv">3</span>),</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">Weighted   =</span> <span class="fu">round</span>(<span class="fu">abs</span>(smd_wt), <span class="dv">3</span>)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>balance_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   Covariate    Unadjusted Weighted
   &lt;chr&gt;             &lt;dbl&gt;    &lt;dbl&gt;
 1 age               0.363    0.005
 2 male              0.086    0.005
 3 ckd               0.344    0.004
 4 diabetes          0.204    0.001
 5 hypertension      0.162    0.003
 6 prior_nsaid       0.373    0.008
 7 prior_opioid      0.076    0.009
 8 ace_arb           0.165    0.005
 9 n_rx              0.283    0.009
10 n_visits          0.225    0.005</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Love plot</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>balance_long <span class="ot">&lt;-</span> balance_df <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>Covariate, <span class="at">names_to =</span> <span class="st">"Method"</span>, <span class="at">values_to =</span> <span class="st">"SMD"</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(balance_long, <span class="fu">aes</span>(<span class="at">x =</span> SMD, <span class="at">y =</span> <span class="fu">reorder</span>(Covariate, SMD),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color =</span> Method, <span class="at">shape =</span> Method)) <span class="sc">+</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Absolute Standardized Mean Difference"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 2: Covariate Balance (Love Plot)"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed line = 0.1 threshold from SAP"</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#EE6677"</span>, <span class="st">"#228833"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-08-tmle-clean-room_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="weight-distribution" class="level3" data-number="22.2.3">
<h3 data-number="22.2.3" class="anchored" data-anchor-id="weight-distribution"><span class="header-section-number">22.2.3</span> Weight distribution</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 3: Weight distribution</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.3</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> sw, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>)))) <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stabilized IPTW weight"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 3: Weight Distribution"</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>)) <span class="sc">+</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-08-tmle-clean-room_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Weight summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Weight summary:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>sw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.5361  0.7450  0.8946  1.0013  1.1163  6.5225 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction &gt; 5:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">5</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fraction &gt; 5: 4e-04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction &gt; 10:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fraction &gt; 10: 0 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-3-primary-estimator-tmle-by-hand" class="level2" data-number="22.3">
<h2 data-number="22.3" class="anchored" data-anchor-id="step-3-primary-estimator-tmle-by-hand"><span class="header-section-number">22.3</span> 5.3 Step 3: Primary Estimator — TMLE (by hand)</h2>
<p>With diagnostics confirming adequate overlap and balance, we proceed to estimation. TMLE is a multi-step algorithm. We walk through each step with a plain-language explanation, then the code. If you have read the KH Stats TMLE tutorial, you will recognize the same logic here — just applied in a clean-room regulatory context.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3a: Fit the Initial Outcome Model (Q)
</div>
</div>
<div class="callout-body-container callout-body">
<p>First, we build a model to predict the outcome (AKI) from treatment and covariates. This is called the “initial Q” — think of it as our first rough guess at each patient’s risk under each treatment scenario.</p>
<p>We fit one model and then generate three sets of predictions:</p>
<ul>
<li><strong>Q1</strong>: predicted risk if the patient had received NSAIDs (set A = 1 for everyone)</li>
<li><strong>Q0</strong>: predicted risk if the patient had received opioids (set A = 0 for everyone)</li>
<li><strong>QA</strong>: predicted risk under the treatment they actually received</li>
</ul>
<p>These predictions are “initial” because TMLE will update them in the targeting step to reduce bias for the specific causal parameter we care about.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PRIMARY ANALYSIS: TMLE</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 6.1</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3a: Initial outcome model ---</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-specified model form from SAP</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>q_formula <span class="ot">&lt;-</span> Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> male <span class="sc">+</span> ckd_f <span class="sc">+</span> diabetes <span class="sc">+</span> hypertension <span class="sc">+</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  prior_nsaid <span class="sc">+</span> prior_opioid <span class="sc">+</span> ace_arb <span class="sc">+</span> n_rx <span class="sc">+</span> n_visits <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  A<span class="sc">:</span>ckd_f <span class="sc">+</span> A<span class="sc">:</span>ace_arb <span class="sc">+</span> A<span class="sc">:</span>diabetes</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(q_formula, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial predictions</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>Q1_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>Q0_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>QA_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Initial outcome model fitted.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial outcome model fitted.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q1 range: 0.0084 0.7659 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q0 range: 0.0045 0.5594 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3b: Compute the Clever Covariate
</div>
</div>
<div class="callout-body-container callout-body">
<p>The clever covariate bridges the outcome model and the treatment model. It tells the fluctuation step <em>where</em> to adjust the initial predictions and <em>by how much</em>.</p>
<p>For the ATE, the clever covariate for each observation is:</p>
<p><span class="math display">\[H(A, W) = \frac{A}{g(W)} - \frac{1-A}{1-g(W)}\]</span></p>
<p>For treated patients (A = 1), this simplifies to <span class="math inline">\(1/g(W)\)</span> — the inverse of their probability of being treated. For controls (A = 0), it is <span class="math inline">\(-1/(1 - g(W))\)</span>. Patients who received an unlikely treatment get a larger clever covariate, meaning the targeting step will adjust their predictions more. This is the mechanism through which TMLE “borrows strength” from the propensity score to correct the outcome model.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3b: Clever covariate ---</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>H_A <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>H_1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>H_0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Clever covariate range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(H_A), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Clever covariate range: -6.28 12.93 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3c: Fluctuation (Targeting) Step
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the step that makes TMLE special. We fit a simple logistic regression with:</p>
<ul>
<li><strong>Outcome:</strong> the observed Y</li>
<li><strong>Offset:</strong> the logit of our initial predictions (QA_init)</li>
<li><strong>Covariate:</strong> the clever covariate H(A, W)</li>
<li><strong>No intercept</strong> (-1 in the formula)</li>
</ul>
<p>The single coefficient from this regression, called epsilon, tells us how much and in which direction to shift our initial predictions. The offset locks in the initial predictions; epsilon only adjusts them in the direction that reduces bias for the ATE specifically.</p>
<p>This is the “targeting” in Targeted Maximum Likelihood — the initial model is updated to be optimal for our specific estimand, not just for prediction in general.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3c: Fluctuation (targeting) model ---</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>fluc <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QA_init)) <span class="sc">+</span> H_A,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> binomial)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon (fluctuation parameter):"</span>, <span class="fu">round</span>(epsilon, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epsilon (fluctuation parameter): -0.00741 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3d-e: Update Predictions and Compute the Final TMLE Estimate
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now we apply the epsilon update to get our final, targeted predictions:</p>
<ul>
<li>Shift Q1_init and Q0_init on the logit scale by epsilon times their respective clever covariates</li>
<li>Transform back to the probability scale using the inverse-logit (plogis)</li>
<li>Average the updated predictions across all patients to get the counterfactual risks</li>
<li>Take the difference to get the ATE</li>
</ul>
<p>The resulting estimate, <span class="math inline">\(\hat{\psi}_{TMLE}\)</span>, is doubly robust: it is consistent if either the outcome model or the propensity score model is correctly specified. It also solves the efficient influence curve estimating equation, which means it achieves the smallest possible variance among regular asymptotically linear estimators.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3d: Updated predictions ---</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>Q1_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q1_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_1)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>Q0_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q0_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_0)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3e: TMLE estimate ---</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>tmle_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_star)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>tmle_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_star)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>tmle_ate   <span class="ot">&lt;-</span> tmle_risk1 <span class="sc">-</span> tmle_risk0</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (NSAIDs): "</span>, <span class="fu">round</span>(tmle_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE risk (NSAIDs):  0.0912 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (opioids):"</span>, <span class="fu">round</span>(tmle_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE risk (opioids): 0.0512 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:           "</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE ATE:            0.04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:           "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:            0.0334 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3f: Inference via efficient influence curve ---</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>eic <span class="ot">&lt;-</span> (dat<span class="sc">$</span>A <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc) <span class="sc">*</span> (dat<span class="sc">$</span>Y <span class="sc">-</span> Q1_star) <span class="sc">+</span> Q1_star <span class="sc">-</span> tmle_risk1 <span class="sc">-</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>       ((<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc)) <span class="sc">*</span> (dat<span class="sc">$</span>Y <span class="sc">-</span> Q0_star) <span class="sc">-</span> Q0_star <span class="sc">+</span> tmle_risk0</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>tmle_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic) <span class="sc">/</span> n)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>tmle_ci <span class="ot">&lt;-</span> tmle_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> tmle_se</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== PRIMARY RESULT ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== PRIMARY RESULT ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:"</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE ATE: 0.04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SE:      "</span>, <span class="fu">round</span>(tmle_se, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SE:       0.0064 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:  ["</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>95% CI:  [ 0.0275 , 0.0525 ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"p-value: "</span>, <span class="fu">round</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(tmle_ate <span class="sc">/</span> tmle_se)), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>p-value:  0 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3g: Verify EIC mean ≈ 0 ---</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic), <span class="dv">8</span>), <span class="st">" (should be ~0)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EIC mean: 0  (should be ~0)</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Is the EIC Mean Zero?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The efficient influence curve (EIC) for the TMLE estimate should have a mean of approximately zero. This is not a coincidence — it is a direct consequence of the targeting step.</p>
<p>When we fit the fluctuation model with the clever covariate, the score equation of that logistic regression forces the EIC estimating equation to be solved. In other words, the targeting step guarantees that the mean of the EIC is (numerically) zero.</p>
<p><strong>Why this matters for clean-room analysis:</strong> The EIC mean is a built-in diagnostic. If it deviates meaningfully from zero, something went wrong in the implementation — perhaps a coding error, numerical overflow in the logit transformation, or a problem with the propensity score truncation. In a locked analysis where you cannot inspect intermediate results, having an automatic self-check is invaluable.</p>
<p><strong>What “approximately zero” means in practice:</strong> Machine precision means you will see values like 1e-15 to 1e-8. Values larger than 1e-4 warrant investigation. Values larger than 1e-2 indicate a serious problem.</p>
</div>
</div>
<hr>
</section>
<section id="step-4-secondary-estimators-for-comparison" class="level2" data-number="22.4">
<h2 data-number="22.4" class="anchored" data-anchor-id="step-4-secondary-estimators-for-comparison"><span class="header-section-number">22.4</span> 5.4 Step 4: Secondary Estimators (for comparison)</h2>
<p>The SAP pre-specifies secondary estimators so that the primary TMLE result can be compared for consistency. If all three estimators agree, this strengthens confidence in the result. If they disagree, the TMLE estimate is preferred due to its double robustness, but the discrepancy is documented.</p>
<section id="g-computation" class="level3" data-number="22.4.1">
<h3 data-number="22.4.1" class="anchored" data-anchor-id="g-computation"><span class="header-section-number">22.4.1</span> G-computation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SECONDARY ANALYSIS 1: G-computation</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 6.2</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>gcomp_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_init)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>gcomp_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_init)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>gcomp_ate   <span class="ot">&lt;-</span> gcomp_risk1 <span class="sc">-</span> gcomp_risk0</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-computation ATE:"</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-computation ATE: 0.0423 </code></pre>
</div>
</div>
</section>
<section id="iptw" class="level3" data-number="22.4.2">
<h3 data-number="22.4.2" class="anchored" data-anchor-id="iptw"><span class="header-section-number">22.4.2</span> IPTW</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SECONDARY ANALYSIS 2: IPTW with stabilized weights</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 6.3</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>risk1_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>risk0_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>iptw_ate   <span class="ot">&lt;-</span> risk1_iptw <span class="sc">-</span> risk0_iptw</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE:"</span>, <span class="fu">round</span>(iptw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW ATE: 0.0408 </code></pre>
</div>
</div>
</section>
<section id="comparison-table" class="level3" data-number="22.4.3">
<h3 data-number="22.4.3" class="anchored" data-anchor-id="comparison-table"><span class="header-section-number">22.4.3</span> Comparison table</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># RESULTS COMPARISON TABLE</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 7</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimator =</span> <span class="fu">c</span>(<span class="st">"Unadjusted"</span>, <span class="st">"G-computation"</span>, <span class="st">"IPTW"</span>, <span class="st">"TMLE"</span>),</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATE =</span> <span class="fu">round</span>(<span class="fu">c</span>(</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>]),</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    gcomp_ate,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    iptw_ate,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    tmle_ate</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  ), <span class="dv">4</span>),</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, tmle_se), <span class="dv">4</span>),</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_lower =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, tmle_ci[<span class="dv">1</span>]), <span class="dv">4</span>),</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_upper =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, tmle_ci[<span class="dv">2</span>]), <span class="dv">4</span>)</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  Estimator        ATE      SE CI_lower CI_upper
  &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 Unadjusted    0.0041 NA       NA       NA     
2 G-computation 0.0423 NA       NA       NA     
3 IPTW          0.0408 NA       NA       NA     
4 TMLE          0.04    0.0064   0.0275   0.0525</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-5-post-estimation-diagnostics" class="level2" data-number="22.5">
<h2 data-number="22.5" class="anchored" data-anchor-id="step-5-post-estimation-diagnostics"><span class="header-section-number">22.5</span> 5.5 Step 5: Post-Estimation Diagnostics</h2>
<section id="clever-covariate-distribution" class="level3" data-number="22.5.1">
<h3 data-number="22.5.1" class="anchored" data-anchor-id="clever-covariate-distribution"><span class="header-section-number">22.5.1</span> Clever covariate distribution</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 4: Clever covariate ranges</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.4</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>cc_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">H =</span> H_A,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Treatment =</span> <span class="fu">factor</span>(dat<span class="sc">$</span>A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>))</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(cc_df, <span class="fu">aes</span>(<span class="at">x =</span> H, <span class="at">fill =</span> Treatment)) <span class="sc">+</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">60</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Clever covariate H(A, W)"</span>,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 4: Clever Covariate Distribution"</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-08-tmle-clean-room_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="influence-curve-stability" class="level3" data-number="22.5.2">
<h3 data-number="22.5.2" class="anchored" data-anchor-id="influence-curve-stability"><span class="header-section-number">22.5.2</span> Influence curve stability</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 5: Influence curve distribution</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.5</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">eic =</span> eic), <span class="fu">aes</span>(<span class="at">x =</span> eic)) <span class="sc">+</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">60</span>, <span class="at">fill =</span> <span class="st">"#228833"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Efficient influence curve value"</span>,</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 5: EIC Distribution"</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-08-tmle-clean-room_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EIC summary:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(eic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-8.35531 -0.09618 -0.04799  0.00000  0.07999  4.88995 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 5 most influential observations:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 5 most influential observations:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">sort</span>(<span class="fu">abs</span>(eic), <span class="at">decreasing =</span> <span class="cn">TRUE</span>), <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      37     4648     3572      501     5800 
8.355309 4.889952 4.527676 4.280250 4.274389 </code></pre>
</div>
</div>
</section>
<section id="predicted-risk-distribution" class="level3" data-number="22.5.3">
<h3 data-number="22.5.3" class="anchored" data-anchor-id="predicted-risk-distribution"><span class="header-section-number">22.5.3</span> Predicted risk distribution</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 6: Predicted outcome distributions</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.6</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>pred_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q1_star =</span> Q1_star,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q0_star =</span> Q0_star,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">diff =</span> Q1_star <span class="sc">-</span> Q0_star</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pred_df, <span class="fu">aes</span>(<span class="at">x =</span> diff)) <span class="sc">+</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#CC6677"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(pred_df<span class="sc">$</span>diff), <span class="at">linetype =</span> <span class="st">"solid"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_ate, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Individual-level risk difference (Q1* - Q0*)"</span>,</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 6: Distribution of Individual Treatment Effects"</span>,</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Black line = TMLE ATE; Red dashed = True ATE"</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-08-tmle-clean-room_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="super-learner-integration" class="level1" data-number="23">
<h1 data-number="23"><span class="header-section-number">23</span> 6. Super Learner Integration</h1>
<p>In the by-hand implementation above, we used parametric logistic regression for both nuisance models. In a real clean-room analysis, the SAP would specify a Super Learner library. This section shows how that integration works conceptually.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Super Learner Eliminates Analyst Discretion
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the key insight that makes TMLE and Super Learner a natural fit for the clean-room framework:</p>
<ol type="1">
<li><strong>No analyst discretion:</strong> The learner library is pre-specified in the SAP. Cross-validation — not the analyst — selects the optimal weighted combination. The analyst never chooses “which model fits better.”</li>
<li><strong>Reproducible:</strong> Given the same data, seed, and library, Super Learner always produces the same result. There is no subjectivity in the model selection step.</li>
<li><strong>Flexible without overfitting:</strong> Multiple candidate models are considered — including flexible machine learning algorithms — but the cross-validation oracle inequality ensures the ensemble performs nearly as well as the best single learner. This reduces the risk of misspecification without introducing analyst degrees of freedom.</li>
<li><strong>Auditable:</strong> The cross-validated risk of each learner and its weight in the ensemble are logged automatically. A reviewer can see exactly which models contributed and how much, providing full transparency into the “black box.”</li>
</ol>
<p>In a traditional analysis, the analyst might try logistic regression, see poor fit, try adding interactions, check AIC, try a different link function — each step introducing data-dependent decisions. Super Learner replaces this entire iterative process with a single, pre-specified, cross-validated procedure.</p>
</div>
</div>
<section id="pre-specified-super-learner-library-from-sap" class="level3" data-number="23.0.1">
<h3 data-number="23.0.1" class="anchored" data-anchor-id="pre-specified-super-learner-library-from-sap"><span class="header-section-number">23.0.1</span> Pre-specified Super Learner library (from SAP)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 4.3: Super Learner specification</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-specified learner library (locked in SAP)</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>SL_library <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SL.glm"</span>,               <span class="co"># logistic regression</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SL.glm.interaction"</span>,   <span class="co"># logistic with interactions</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SL.step"</span>,              <span class="co"># stepwise selection</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SL.mean"</span>               <span class="co"># intercept-only (benchmark)</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: In a webR environment, compiled learners like SL.ranger</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="co"># or SL.xgboost may not be available. The library above uses</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="co"># only R-native learners.</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model via Super Learner</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>W_matrix <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">select</span>(age, male, ckd, diabetes, hypertension,</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>                            prior_nsaid, prior_opioid, ace_arb,</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>                            n_rx, n_visits)</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>Q_SL <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> dat<span class="sc">$</span>Y,</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">cbind</span>(<span class="at">A =</span> dat<span class="sc">$</span>A, W_matrix),</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> SL_library,</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvControl =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">5</span>)</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment model via Super Learner</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>g_SL <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> dat<span class="sc">$</span>A,</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> W_matrix,</span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> SL_library,</span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvControl =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">5</span>)</span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect cross-validated learner weights</span></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Outcome model weights:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>Q_SL<span class="sc">$</span>coef</span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Treatment model weights:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>g_SL<span class="sc">$</span>coef</span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a><span class="co"># These weights are part of the audit trail — they document which</span></span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a><span class="co"># learners contributed most without analyst discretion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="using-super-learner-predictions-in-tmle" class="level3" data-number="23.0.2">
<h3 data-number="23.0.2" class="anchored" data-anchor-id="using-super-learner-predictions-in-tmle"><span class="header-section-number">23.0.2</span> Using Super Learner predictions in TMLE</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions for TMLE</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>Q1_SL <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_SL, <span class="at">newdata =</span> <span class="fu">cbind</span>(<span class="at">A =</span> <span class="dv">1</span>, W_matrix))<span class="sc">$</span>pred</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>Q0_SL <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_SL, <span class="at">newdata =</span> <span class="fu">cbind</span>(<span class="at">A =</span> <span class="dv">0</span>, W_matrix))<span class="sc">$</span>pred</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>QA_SL <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_SL, <span class="at">newdata =</span> <span class="fu">cbind</span>(<span class="at">A =</span> dat<span class="sc">$</span>A, W_matrix))<span class="sc">$</span>pred</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>ps_SL <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_SL, <span class="at">newdata =</span> W_matrix)<span class="sc">$</span>pred</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>ps_SL <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.025</span>, <span class="fu">pmin</span>(<span class="fl">0.975</span>, ps_SL))</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Then proceed with clever covariate, fluctuation, and inference</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co"># exactly as in the by-hand implementation above</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="the-audit-trail" class="level1" data-number="24">
<h1 data-number="24"><span class="header-section-number">24</span> 7. The Audit Trail</h1>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Audit Trail — Every Step Is Documented
</div>
</div>
<div class="callout-body-container callout-body">
<p>A clean-room analysis must maintain a complete record of every computational step. The audit trail is not optional — it is the mechanism by which reviewers, regulators, and future analysts can verify that the pre-specified protocol was followed exactly.</p>
<p>The structure below captures the key elements: protocol version, software environment, diagnostics summary, and all results. In a real analysis, this would be supplemented by the version-controlled git commit hash of the analysis code, the SHA-256 hash of the input dataset, and a log of all computational warnings.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co"># AUDIT TRAIL</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">protocol_version =</span> <span class="st">"v1.0"</span>,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sap_version =</span> <span class="st">"v1.0"</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">analysis_date =</span> <span class="fu">Sys.Date</span>(),</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_version =</span> R.version.string,</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">20260101</span>,</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> n,</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diagnostics summary</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">diagnostics =</span> <span class="fu">list</span>(</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps_range =</span> <span class="fu">round</span>(<span class="fu">range</span>(dat<span class="sc">$</span>ps), <span class="dv">4</span>),</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps_truncation =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>),</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_smd_unadjusted =</span> <span class="fu">round</span>(<span class="fu">max</span>(balance_df<span class="sc">$</span>Unadjusted), <span class="dv">3</span>),</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_smd_weighted =</span> <span class="fu">round</span>(<span class="fu">max</span>(balance_df<span class="sc">$</span>Weighted), <span class="dv">3</span>),</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">smd_threshold =</span> <span class="fl">0.1</span>,</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">balance_achieved =</span> <span class="fu">all</span>(balance_df<span class="sc">$</span>Weighted <span class="sc">&lt;</span> <span class="fl">0.1</span>),</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_weight =</span> <span class="fu">round</span>(<span class="fu">max</span>(dat<span class="sc">$</span>sw), <span class="dv">2</span>),</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">eic_mean =</span> <span class="fu">round</span>(<span class="fu">mean</span>(eic), <span class="dv">8</span>)</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Primary result</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_result =</span> <span class="fu">list</span>(</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimator =</span> <span class="st">"TMLE"</span>,</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">ate =</span> <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>),</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">se =</span> <span class="fu">round</span>(tmle_se, <span class="dv">4</span>),</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_95 =</span> <span class="fu">round</span>(tmle_ci, <span class="dv">4</span>),</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">round</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(tmle_ate <span class="sc">/</span> tmle_se)), <span class="dv">4</span>)</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Secondary results</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">secondary_results =</span> <span class="fu">list</span>(</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">gcomp_ate =</span> <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>),</span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">iptw_ate =</span> <span class="fu">round</span>(iptw_ate, <span class="dv">4</span>)</span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Print audit summary</span></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== AUDIT TRAIL ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== AUDIT TRAIL ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Protocol:"</span>, audit<span class="sc">$</span>protocol_version, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Protocol: v1.0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date:"</span>, <span class="fu">as.character</span>(audit<span class="sc">$</span>analysis_date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Date: 2026-02-25 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"R:"</span>, audit<span class="sc">$</span>r_version, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R: R version 4.4.2 (2024-10-31 ucrt) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Seed:"</span>, audit<span class="sc">$</span>seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Seed: 20260101 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"N:"</span>, audit<span class="sc">$</span>sample_size, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>N: 8000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Diagnostics ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Diagnostics ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"PS range:"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>ps_range, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PS range: 0.0754 0.8414 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Max SMD (weighted):"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>max_smd_weighted, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Max SMD (weighted): 0.009 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Balance achieved:"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>balance_achieved, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance achieved: TRUE </code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>eic_mean, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EIC mean: 0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Primary Result ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Primary Result ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"ATE:"</span>, audit<span class="sc">$</span>primary_result<span class="sc">$</span>ate, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ATE: 0.04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:"</span>, audit<span class="sc">$</span>primary_result<span class="sc">$</span>ci_95, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>95% CI: 0.0275 0.0525 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"p-value:"</span>, audit<span class="sc">$</span>primary_result<span class="sc">$</span>p_value, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>p-value: 0 </code></pre>
</div>
</div>
<hr>
</section>
<section id="sensitivity-analysis-e-value" class="level1" data-number="25">
<h1 data-number="25"><span class="header-section-number">25</span> 8. Sensitivity Analysis: E-value</h1>
<p>The E-value is our quantitative answer to the question: “How strong would unmeasured confounding need to be to explain away this result?” This is always the final step in a causal analysis, because no statistical method — not even TMLE — can address unmeasured confounding from data alone.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpreting the E-value
</div>
</div>
<div class="callout-body-container callout-body">
<p>The E-value quantifies the minimum strength of association that an unmeasured confounder would need to have with <strong>both</strong> the treatment and the outcome (on the risk ratio scale, conditional on measured covariates) to fully explain away the observed causal effect.</p>
<p><strong>How to read it:</strong></p>
<ul>
<li>An E-value of 1.0 means the result is already null — no unmeasured confounding is needed to explain it away.</li>
<li>Larger E-values indicate greater robustness. An E-value of 3.0 means an unmeasured confounder would need to triple the risk of both treatment and outcome (beyond what measured confounders explain) to nullify the finding.</li>
<li>The E-value for the confidence interval bound closest to the null tells you how strong confounding would need to be to make the result statistically non-significant.</li>
</ul>
<p><strong>In the NSAID/AKI context:</strong> Consider what unmeasured confounders might exist — OTC NSAID use (not captured in claims), frailty, kidney function trajectory. Would any of these plausibly have the association strength indicated by the E-value? If the E-value is large relative to known risk factors, the result is more credible.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SENSITIVITY ANALYSIS: E-value</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 8.1</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert risk difference to risk ratio for E-value computation</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>risk_ratio <span class="ot">&lt;-</span> tmle_risk1 <span class="sc">/</span> tmle_risk0</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="co"># E-value formula for risk ratios</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>compute_evalue <span class="ot">&lt;-</span> <span class="cf">function</span>(rr) {</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (rr <span class="sc">&gt;=</span> <span class="dv">1</span>) {</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>    rr <span class="sc">+</span> <span class="fu">sqrt</span>(rr <span class="sc">*</span> (rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">/</span>rr <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>rr <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>evalue_point <span class="ot">&lt;-</span> <span class="fu">compute_evalue</span>(risk_ratio)</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="co"># E-value for confidence interval bound closest to null</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>rr_ci_lower <span class="ot">&lt;-</span> (tmle_risk0 <span class="sc">+</span> tmle_ci[<span class="dv">1</span>]) <span class="sc">/</span> tmle_risk0  <span class="co"># approximate</span></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>evalue_ci <span class="ot">&lt;-</span> <span class="cf">if</span>(rr_ci_lower <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="fu">compute_evalue</span>(rr_ci_lower) <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Risk ratio (NSAIDs vs opioids):"</span>, <span class="fu">round</span>(risk_ratio, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Risk ratio (NSAIDs vs opioids): 1.782 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"E-value (point estimate):"</span>, <span class="fu">round</span>(evalue_point, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>E-value (point estimate): 2.96 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"E-value (CI bound):"</span>, <span class="fu">round</span>(evalue_ci, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>E-value (CI bound): 2.45 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Interpretation: An unmeasured confounder would need an association</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Interpretation: An unmeasured confounder would need an association</code></pre>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"of at least RR ="</span>, <span class="fu">round</span>(evalue_point, <span class="dv">2</span>), <span class="st">"with both treatment and outcome</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>of at least RR = 2.96 with both treatment and outcome</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(above and beyond measured confounders) to explain away the</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(above and beyond measured confounders) to explain away the</code></pre>
</div>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"observed effect.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>observed effect.</code></pre>
</div>
</div>
<hr>
</section>
<section id="interpretation-in-regulatory-context" class="level1" data-number="26">
<h1 data-number="26"><span class="header-section-number">26</span> 9. Interpretation in Regulatory Context</h1>
<section id="results-summary" class="level2" data-number="26.1">
<h2 data-number="26.1" class="anchored" data-anchor-id="results-summary"><span class="header-section-number">26.1</span> Results summary</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== REGULATORY SUMMARY ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== REGULATORY SUMMARY ===</code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Study: Post-marketing safety analysis of NSAIDs vs opioids for AKI risk</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Study: Post-marketing safety analysis of NSAIDs vs opioids for AKI risk</code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Design: Active comparator, new user, cohort study</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Design: Active comparator, new user, cohort study</code></pre>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method: Pre-specified TMLE with parametric nuisance models</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Method: Pre-specified TMLE with parametric nuisance models</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Primary endpoint: 90-day acute kidney injury</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Primary endpoint: 90-day acute kidney injury</code></pre>
</div>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NSAIDs (n ="</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"): estimated 90-day AKI risk ="</span>,</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(tmle_risk1 <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NSAIDs (n = 4035 ): estimated 90-day AKI risk = 9.12 %</code></pre>
</div>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Opioids (n ="</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"): estimated 90-day AKI risk ="</span>,</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(tmle_risk0 <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Opioids (n = 3965 ): estimated 90-day AKI risk = 5.12 %</code></pre>
</div>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Risk difference:"</span>, <span class="fu">round</span>(tmle_ate <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"percentage points</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Risk difference: 4 percentage points</code></pre>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"to"</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"percentage points</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>95% CI: 2.75 to 5.25 percentage points</code></pre>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (tmle_ci[<span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Conclusion: Statistically significant increase in AKI risk with NSAIDs.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The results support updating prescribing guidelines to include AKI risk</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"assessment, particularly for patients with pre-existing CKD.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (tmle_ci[<span class="dv">2</span>] <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Conclusion: Statistically significant decrease in AKI risk with NSAIDs.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Conclusion: The risk difference is not statistically significant.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Continued monitoring is recommended.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Conclusion: Statistically significant increase in AKI risk with NSAIDs.
The results support updating prescribing guidelines to include AKI risk
assessment, particularly for patients with pre-existing CKD.</code></pre>
</div>
</div>
</section>
<section id="how-tmle-supports-the-regulatory-decision" class="level2" data-number="26.2">
<h2 data-number="26.2" class="anchored" data-anchor-id="how-tmle-supports-the-regulatory-decision"><span class="header-section-number">26.2</span> How TMLE supports the regulatory decision</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Regulatory concern</th>
<th>How TMLE addresses it</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Pre-specification required</td>
<td>SAP locks the learner library, seed, and analysis code</td>
</tr>
<tr class="even">
<td>Must be reproducible</td>
<td>Deterministic given data + seed + code</td>
</tr>
<tr class="odd">
<td>Model selection bias</td>
<td>Super Learner eliminates manual model selection</td>
</tr>
<tr class="even">
<td>Robustness to misspecification</td>
<td>Double robustness protects against either nuisance model being wrong</td>
</tr>
<tr class="odd">
<td>Valid inference</td>
<td>Influence-curve standard errors do not require bootstrap</td>
</tr>
<tr class="even">
<td>Auditable</td>
<td>Cross-validated learner weights, diagnostics, and the fluctuation parameter are all logged</td>
</tr>
<tr class="odd">
<td>Transparent</td>
<td>Every step (initial model, clever covariate, targeting, inference) has a clear purpose</td>
</tr>
</tbody>
</table>
</section>
<section id="what-assumptions-are-most-fragile" class="level2" data-number="26.3">
<h2 data-number="26.3" class="anchored" data-anchor-id="what-assumptions-are-most-fragile"><span class="header-section-number">26.3</span> What assumptions are most fragile?</h2>
<ol type="1">
<li><p><strong>Unmeasured confounding:</strong> OTC NSAID use is not captured in claims data. Frailty and functional status are poorly measured. The E-value provides a benchmark for how strong this confounding would need to be.</p></li>
<li><p><strong>Positivity in CKD subgroups:</strong> Patients with severe CKD are rarely prescribed NSAIDs. The propensity score overlap diagnostic should flag this. If violated, consider restricting to the subpopulation with adequate overlap or using stochastic interventions.</p></li>
<li><p><strong>Outcome misclassification:</strong> AKI may be under-coded in claims data. This affects interpretation but not the validity of the TMLE procedure.</p></li>
</ol>
<hr>
</section>
</section>
<section id="distributed-data-extension" class="level1" data-number="27">
<h1 data-number="27"><span class="header-section-number">27</span> 10. Distributed Data Extension</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Meta-Analysis of Site-Level TMLE Estimates Works
</div>
</div>
<div class="callout-body-container callout-body">
<p>In true multi-site analyses (like the FDA Sentinel system), patient-level data cannot be shared across sites. The clean-room TMLE approach handles this naturally through a two-stage procedure:</p>
<p><strong>Stage 1: Ship the locked code.</strong> The coordinating center distributes the identical, version-controlled analysis code to each participating site. Each site runs the full TMLE pipeline — propensity score estimation, diagnostics, targeting, inference — on its own local data. Because the code is locked and the seed is fixed, the analysis is deterministic at each site.</p>
<p><strong>Stage 2: Combine via meta-analysis.</strong> Each site returns only summary statistics: the point estimate, standard error, and sample size. The coordinating center combines these using inverse-variance weighted meta-analysis. No patient-level data ever leaves any site.</p>
<p><strong>Why this works theoretically:</strong> Each site’s TMLE estimate is asymptotically normal with an influence-curve-based standard error. Inverse-variance weighting of asymptotically normal estimators is itself asymptotically efficient. The approach is valid as long as the causal assumptions hold within each site and the estimand is the same across sites.</p>
<p><strong>Practical advantages:</strong></p>
<ul>
<li>Privacy is preserved — only aggregate statistics are shared</li>
<li>Each site can have a different covariate distribution (heterogeneity in confounders)</li>
<li>The forest plot reveals cross-site consistency, which strengthens or weakens the overall conclusion</li>
<li>If one site shows a qualitatively different result, this flags potential site-specific issues (different coding practices, different patient populations) for investigation</li>
</ul>
</div>
</div>
<section id="site-level-tmle" class="level3" data-number="27.0.1">
<h3 data-number="27.0.1" class="anchored" data-anchor-id="site-level-tmle"><span class="header-section-number">27.0.1</span> Site-level TMLE</h3>
<ol type="1">
<li>Ship the locked analysis code to each site</li>
<li>Each site runs the TMLE pipeline on its local data</li>
<li>Sites return summary statistics: point estimate, standard error, sample size</li>
<li>The coordinating center performs meta-analysis across sites</li>
</ol>
</section>
<section id="meta-analysis-of-site-level-tmle-estimates" class="level3" data-number="27.0.2">
<h3 data-number="27.0.2" class="anchored" data-anchor-id="meta-analysis-of-site-level-tmle-estimates"><span class="header-section-number">27.0.2</span> Meta-analysis of site-level TMLE estimates</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulated multi-site results</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>site_results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="st">"Site A"</span>, <span class="st">"Site B"</span>, <span class="st">"Site C"</span>, <span class="st">"Site D"</span>),</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">3200</span>, <span class="dv">2100</span>, <span class="dv">1800</span>, <span class="dv">900</span>),</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ate =</span> <span class="fu">c</span>(<span class="fl">0.018</span>, <span class="fl">0.022</span>, <span class="fl">0.015</span>, <span class="fl">0.025</span>),</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">se =</span> <span class="fu">c</span>(<span class="fl">0.006</span>, <span class="fl">0.008</span>, <span class="fl">0.009</span>, <span class="fl">0.014</span>)</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse-variance weighted meta-analysis</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>site_results <span class="ot">&lt;-</span> site_results <span class="sc">%&gt;%</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> <span class="dv">1</span> <span class="sc">/</span> se<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_ate =</span> w <span class="sc">*</span> ate</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>meta_ate <span class="ot">&lt;-</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>w_ate) <span class="sc">/</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>w)</span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a>meta_se  <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>w))</span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>meta_ci  <span class="ot">&lt;-</span> meta_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> meta_se</span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Meta-analytic TMLE:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Meta-analytic TMLE:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ATE:"</span>, <span class="fu">round</span>(meta_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ATE: 0.019 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SE:"</span>, <span class="fu">round</span>(meta_se, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SE: 0.0041 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  95% CI: ["</span>, <span class="fu">round</span>(meta_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(meta_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  95% CI: [ 0.0111 , 0.027 ]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forest plot of site-level results</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>site_results <span class="ot">&lt;-</span> site_results <span class="sc">%&gt;%</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_low =</span> ate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_high =</span> ate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>meta_row <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">site =</span> <span class="st">"Meta-analysis"</span>,</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>n),</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ate =</span> meta_ate,</span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">se =</span> meta_se,</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_low =</span> meta_ci[<span class="dv">1</span>],</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_high =</span> meta_ci[<span class="dv">2</span>]</span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>forest_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(site_results, meta_row) <span class="sc">%&gt;%</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">factor</span>(site, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">c</span>(site_results<span class="sc">$</span>site, <span class="st">"Meta-analysis"</span>))))</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(forest_df, <span class="fu">aes</span>(<span class="at">x =</span> ate, <span class="at">y =</span> site)) <span class="sc">+</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> <span class="fu">ifelse</span>(site <span class="sc">==</span> <span class="st">"Meta-analysis"</span>, <span class="dv">4</span>, <span class="fl">2.5</span>)),</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="fu">ifelse</span>(forest_df<span class="sc">$</span>site <span class="sc">==</span> <span class="st">"Meta-analysis"</span>, <span class="dv">18</span>, <span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> ci_low, <span class="at">xmax =</span> ci_high), <span class="at">height =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"ATE (Risk Difference)"</span>,</span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Forest Plot: Site-Level TMLE Estimates"</span></span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-08-tmle-clean-room_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="key-takeaways" class="level1" data-number="28">
<h1 data-number="28"><span class="header-section-number">28</span> Key Takeaways</h1>
<ol type="1">
<li><p><strong>TMLE is naturally suited for clean-room regulatory analysis</strong> because it replaces manual model selection with pre-specified machine learning (Super Learner) and cross-validation.</p></li>
<li><p><strong>The entire analysis pipeline can be pre-specified</strong> in a Statistical Analysis Plan: learner library, seed, truncation bounds, diagnostic criteria, and decision rules — all locked before data access.</p></li>
<li><p><strong>Reproducibility is guaranteed</strong> by deterministic seeds, version-controlled code, and the algorithmic nature of TMLE + Super Learner.</p></li>
<li><p><strong>The audit trail documents</strong> propensity score overlap, covariate balance, weight distributions, the fluctuation parameter, influence curve behavior, and cross-validated learner weights — providing full transparency.</p></li>
<li><p><strong>Double robustness</strong> protects the estimate even when one nuisance model is misspecified — a critical property when the analyst cannot iterate on model specifications.</p></li>
<li><p><strong>Influence-curve inference</strong> provides valid standard errors without the computational burden of bootstrap, which matters in distributed settings where each site runs the analysis independently.</p></li>
<li><p><strong>The clean-room framework extends to distributed data networks</strong> by shipping locked code to each site and combining site-level TMLE estimates via meta-analysis.</p></li>
<li><p><strong>Sensitivity analysis (E-value)</strong> should always accompany the primary result to quantify robustness to unmeasured confounding — the one assumption that no statistical method can address.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    
 [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   
 [9] ggplot2_3.5.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 
 [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         
 [9] labeling_0.4.3    generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4
[13] munsell_0.5.1     pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6      
[17] utf8_1.2.4        stringi_1.8.7     xfun_0.49         timechange_0.3.0 
[21] cli_3.6.5         withr_3.0.2       magrittr_2.0.3    digest_0.6.37    
[25] grid_4.4.2        rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4  
[29] vctrs_0.6.5       evaluate_1.0.5    glue_1.8.0        farver_2.1.2     
[33] fansi_1.0.6       colorspace_2.1-1  rmarkdown_2.29    tools_4.4.2      
[37] pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
</div>
<hr>
<section id="software-implementation-r" class="level2" data-number="28.1">
<h2 data-number="28.1" class="anchored" data-anchor-id="software-implementation-r"><span class="header-section-number">28.1</span> Software Implementation (R)</h2>
<p>This <strong>clean-room analysis script</strong> demonstrates a fully prespecified TMLE workflow: every modeling choice is locked before running, a fixed seed and library are declared, and the analysis is self-documenting. This is the discipline advocated in this chapter.</p>
<ul>
<li>All choices documented before execution: estimand, learner library, positivity bounds</li>
<li>Uses a fixed Super Learner library (no data-peeking)</li>
<li>Captures <code>sessionInfo()</code> for full reproducibility</li>
<li>Single <code>tmle()</code> call with prespecified parameters</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ═══════════════════════════════════════════════════════</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="do">## CLEAN-ROOM TMLE ANALYSIS SCRIPT</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Prespecified analysis — no data-adaptive choices below</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ═══════════════════════════════════════════════════════</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 0. Lock random seed and declare estimand ──</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>ESTIMAND   <span class="ot">&lt;-</span> <span class="st">"ATE (risk difference)"</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>POPULATION <span class="ot">&lt;-</span> <span class="st">"Adults with simulated cardiovascular risk factors"</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>TREATMENT  <span class="ot">&lt;-</span> <span class="st">"Drug A vs Drug B"</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 1. Prespecified learner libraries ──</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>Q_LIBRARY  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>)   <span class="co"># outcome model</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>G_LIBRARY  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>)   <span class="co"># treatment model</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>G_BOUNDS   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)  <span class="co"># positivity truncation</span></span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 2. Simulate data (replace with real data read) ──</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>W1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>W2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.35</span>)</span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>W3 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">0.3</span> <span class="sc">*</span> W1)</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>A  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> W2))</span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>Y  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.7</span> <span class="sc">*</span> W2 <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> W3))</span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">W1 =</span> W1, <span class="at">W2 =</span> W2, <span class="at">W3 =</span> W3)</span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 3. Run prespecified analysis ──</span></span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"tmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tmle)</span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">tmle</span>(</span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> Y, <span class="at">A =</span> A, <span class="at">W =</span> W,</span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q.SL.library =</span> Q_LIBRARY,</span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">g.SL.library =</span> G_LIBRARY,</span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">gbound =</span> G_BOUNDS[<span class="dv">1</span>]</span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 4. Report results ──</span></span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"══════════════════════════════════════</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"CLEAN-ROOM TMLE RESULTS</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"══════════════════════════════════════</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Estimand:"</span>, ESTIMAND, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Population:"</span>, POPULATION, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Treatment:"</span>, TREATMENT, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"──────────────────────────────────────</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ATE:    "</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>psi, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>CI, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"p-value:"</span>, <span class="fu">format.pval</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>pvalue, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"──────────────────────────────────────</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Q library:"</span>, <span class="fu">paste</span>(Q_LIBRARY, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"g library:"</span>, <span class="fu">paste</span>(G_LIBRARY, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"g-bounds: ["</span>, G_BOUNDS[<span class="dv">1</span>], <span class="st">","</span>, G_BOUNDS[<span class="dv">2</span>], <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"══════════════════════════════════════</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a>  <span class="do">## EIC diagnostic</span></span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>IC), <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install the 'tmle' package:  install.packages('tmle')"</span>)</span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 5. Session info for reproducibility ──</span></span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">── Session info ──</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amertens\.github\.io\/causal-learning-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-07-longitudinal-td-confounding.html" class="pagination-link" aria-label="Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-09-illustrated-ltmle.html" class="pagination-link" aria-label="An Illustrated Guide to Longitudinal TMLE">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb160" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology"</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 3.8: TMLE in the Clean-Room Framework</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>*Pre-specified, reproducible causal inference for regulatory pharmacoepidemiology*</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>In many regulatory settings, analysts cannot freely explore the data. Post-marketing safety studies, multi-database pharmacoepidemiology collaborations, and distributed data network analyses often require a **clean-room workflow**: the analysis plan is pre-specified before data access, code is locked, and the analyst has minimal or no opportunity to iterate on model choices after seeing the data.</span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>This is the opposite of typical exploratory data analysis --- and it is where TMLE shines.</span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>This chapter demonstrates how to implement TMLE in a clean-room regulatory context, using a motivating example inspired by the **NSAIDs vs. opioids acute kidney injury (AKI)** safety question.</span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. Clinical Motivation</span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Regulatory Question</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>A distributed research network (similar to the FDA Sentinel system) has flagged a potential safety signal:</span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Does initiation of prescription NSAIDs increase the 90-day risk of acute kidney injury compared to initiation of prescription opioids among adults with musculoskeletal pain?**</span></span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>This question arises in a post-marketing surveillance context where:</span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Raw patient-level data cannot leave participating sites** (privacy, legal, or contractual constraints)</span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The analysis must be **pre-specified** in a Statistical Analysis Plan (SAP) before any data access</span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Results must be **reproducible** --- running the same code on the same data yields identical results</span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The analyst cannot iterate on model specifications after seeing the data</span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>There is an **audit trail** documenting every analysis step</span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key elements</span></span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Target population:** Adults aged 18-80 with a new musculoskeletal pain diagnosis initiating either NSAIDs or opioids</span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treatment:** NSAID initiation (A = 1) vs. opioid initiation (A = 0)</span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Outcome:** AKI within 90 days (binary)</span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Decision:** Should the NSAID label carry a stronger AKI warning? Should prescribing guidelines be updated?</span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why TMLE for Clean-Room?</span></span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>Traditional regression-based analyses require the analyst to choose a single model specification --- a process that invites data-dependent decisions. Every time an analyst looks at the data and adjusts a model, the pre-specification principle is compromised. TMLE with Super Learner sidesteps this problem entirely:</span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Pre-specify a learner library, not a single model.** The SAP lists the candidate algorithms. Cross-validation --- not the analyst --- picks the best combination. No post-hoc model selection is required.</span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Double robustness protects you.** Even if the outcome model or the treatment model is misspecified, the estimate remains consistent as long as at least one is correct. This is invaluable when you cannot iterate after seeing the data.</span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Influence-curve inference is automatic.** Valid standard errors come directly from the efficient influence curve --- no bootstrap needed, no distributional assumptions beyond the nonparametric model.</span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Full determinism.** Given the same data, learner library, and random seed, the entire pipeline produces bit-identical results. Every run is reproducible.</span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**The audit trail writes itself.** Cross-validated learner weights, the fluctuation parameter, and every diagnostic are logged as natural byproducts of the algorithm.</span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>In short, TMLE turns the clean-room constraint from a limitation into a strength: the algorithm makes the decisions that the analyst is not allowed to make.</span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-54"><a href="#cb160-54" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-55"><a href="#cb160-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-56"><a href="#cb160-56" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. Clean-Room Workflow Overview</span></span>
<span id="cb160-57"><a href="#cb160-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-58"><a href="#cb160-58" aria-hidden="true" tabindex="-1"></a>A clean-room analysis proceeds in distinct phases. Each phase has a clear purpose and strict boundaries. Before we walk through the details, here is the high-level roadmap:</span>
<span id="cb160-59"><a href="#cb160-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-60"><a href="#cb160-60" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb160-61"><a href="#cb160-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Phase 1: Protocol Development (before data access)</span></span>
<span id="cb160-62"><a href="#cb160-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-63"><a href="#cb160-63" aria-hidden="true" tabindex="-1"></a>Everything happens on paper before you touch the data. This is the foundation of the entire analysis.</span>
<span id="cb160-64"><a href="#cb160-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-65"><a href="#cb160-65" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Define the causal question, DAG, and estimand</span>
<span id="cb160-66"><a href="#cb160-66" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Write the SAP specifying all analysis steps</span>
<span id="cb160-67"><a href="#cb160-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Pre-specify the Super Learner library</span>
<span id="cb160-68"><a href="#cb160-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Define all diagnostics that will be run</span>
<span id="cb160-69"><a href="#cb160-69" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Lock the analysis code in a version-controlled repository</span>
<span id="cb160-70"><a href="#cb160-70" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-71"><a href="#cb160-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-72"><a href="#cb160-72" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb160-73"><a href="#cb160-73" aria-hidden="true" tabindex="-1"></a><span class="fu">## Phase 2: Data Preparation (minimal data contact)</span></span>
<span id="cb160-74"><a href="#cb160-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-75"><a href="#cb160-75" aria-hidden="true" tabindex="-1"></a>Data preparation follows pre-written scripts. The analyst executes queries but does not explore.</span>
<span id="cb160-76"><a href="#cb160-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-77"><a href="#cb160-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Execute pre-written data extraction queries</span>
<span id="cb160-78"><a href="#cb160-78" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Apply inclusion/exclusion criteria</span>
<span id="cb160-79"><a href="#cb160-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create analysis-ready dataset</span>
<span id="cb160-80"><a href="#cb160-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No exploratory analysis</span>
<span id="cb160-81"><a href="#cb160-81" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-82"><a href="#cb160-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-83"><a href="#cb160-83" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb160-84"><a href="#cb160-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## Phase 3: Analysis Execution (locked code)</span></span>
<span id="cb160-85"><a href="#cb160-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-86"><a href="#cb160-86" aria-hidden="true" tabindex="-1"></a>This is where the pre-specified TMLE pipeline runs. The analyst presses "go" and does not modify anything.</span>
<span id="cb160-87"><a href="#cb160-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-88"><a href="#cb160-88" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Run the pre-specified TMLE pipeline</span>
<span id="cb160-89"><a href="#cb160-89" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Generate all pre-specified diagnostics</span>
<span id="cb160-90"><a href="#cb160-90" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No code modifications allowed</span>
<span id="cb160-91"><a href="#cb160-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Capture all output deterministically</span>
<span id="cb160-92"><a href="#cb160-92" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-93"><a href="#cb160-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-94"><a href="#cb160-94" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb160-95"><a href="#cb160-95" aria-hidden="true" tabindex="-1"></a><span class="fu">## Phase 4: Reporting</span></span>
<span id="cb160-96"><a href="#cb160-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-97"><a href="#cb160-97" aria-hidden="true" tabindex="-1"></a>Results are interpreted according to pre-specified decision rules. Any deviation from the protocol is documented.</span>
<span id="cb160-98"><a href="#cb160-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-99"><a href="#cb160-99" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Interpret results according to pre-specified rules</span>
<span id="cb160-100"><a href="#cb160-100" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Document any deviations from the protocol</span>
<span id="cb160-101"><a href="#cb160-101" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Maintain audit trail</span>
<span id="cb160-102"><a href="#cb160-102" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-103"><a href="#cb160-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-104"><a href="#cb160-104" aria-hidden="true" tabindex="-1"></a>We now walk through each phase.</span>
<span id="cb160-105"><a href="#cb160-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-106"><a href="#cb160-106" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-107"><a href="#cb160-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-108"><a href="#cb160-108" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Phase 1: Pre-Specified Protocol</span></span>
<span id="cb160-109"><a href="#cb160-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-110"><a href="#cb160-110" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.1 Causal Question and Estimand</span></span>
<span id="cb160-111"><a href="#cb160-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-112"><a href="#cb160-112" aria-hidden="true" tabindex="-1"></a>Before touching any data, we write down exactly what we want to estimate and why.</span>
<span id="cb160-113"><a href="#cb160-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-114"><a href="#cb160-114" aria-hidden="true" tabindex="-1"></a>**Question (plain language):** What is the 90-day AKI risk if all eligible patients initiated NSAIDs, compared to if all eligible patients initiated opioids?</span>
<span id="cb160-115"><a href="#cb160-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-116"><a href="#cb160-116" aria-hidden="true" tabindex="-1"></a>**Estimand:** Average Treatment Effect on the risk difference scale:</span>
<span id="cb160-117"><a href="#cb160-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-118"><a href="#cb160-118" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb160-119"><a href="#cb160-119" aria-hidden="true" tabindex="-1"></a>\psi = E<span class="co">[</span><span class="ot">Y(1)</span><span class="co">]</span> - E<span class="co">[</span><span class="ot">Y(0)</span><span class="co">]</span></span>
<span id="cb160-120"><a href="#cb160-120" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb160-121"><a href="#cb160-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-122"><a href="#cb160-122" aria-hidden="true" tabindex="-1"></a>where $Y(1)$ is the potential AKI outcome under NSAID initiation and $Y(0)$ under opioid initiation.</span>
<span id="cb160-123"><a href="#cb160-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-124"><a href="#cb160-124" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.2 Causal Model (DAG)</span></span>
<span id="cb160-125"><a href="#cb160-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-126"><a href="#cb160-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-127"><a href="#cb160-127" aria-hidden="true" tabindex="-1"></a><span class="in">Confounders (W):</span></span>
<span id="cb160-128"><a href="#cb160-128" aria-hidden="true" tabindex="-1"></a><span class="in">  age, sex, CKD stage, diabetes, hypertension,</span></span>
<span id="cb160-129"><a href="#cb160-129" aria-hidden="true" tabindex="-1"></a><span class="in">  prior NSAID use, prior opioid use, ACE/ARB use,</span></span>
<span id="cb160-130"><a href="#cb160-130" aria-hidden="true" tabindex="-1"></a><span class="in">  number of concomitant medications, healthcare utilization</span></span>
<span id="cb160-131"><a href="#cb160-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-132"><a href="#cb160-132" aria-hidden="true" tabindex="-1"></a><span class="in">      W</span></span>
<span id="cb160-133"><a href="#cb160-133" aria-hidden="true" tabindex="-1"></a><span class="in">     / \</span></span>
<span id="cb160-134"><a href="#cb160-134" aria-hidden="true" tabindex="-1"></a><span class="in">    v   v</span></span>
<span id="cb160-135"><a href="#cb160-135" aria-hidden="true" tabindex="-1"></a><span class="in">    A -&gt; Y</span></span>
<span id="cb160-136"><a href="#cb160-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-137"><a href="#cb160-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-138"><a href="#cb160-138" aria-hidden="true" tabindex="-1"></a>All measured confounders $W$ affect both treatment choice $A$ and outcome $Y$. The active comparator design (NSAID vs. opioid) helps control for confounding by indication --- both groups have pain requiring treatment.</span>
<span id="cb160-139"><a href="#cb160-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-140"><a href="#cb160-140" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.3 Assumptions</span></span>
<span id="cb160-141"><a href="#cb160-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-142"><a href="#cb160-142" aria-hidden="true" tabindex="-1"></a>The causal identification assumptions must be stated and scrutinized before the analysis begins. These are the claims that no statistical method can verify from data alone.</span>
<span id="cb160-143"><a href="#cb160-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-144"><a href="#cb160-144" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb160-145"><a href="#cb160-145" aria-hidden="true" tabindex="-1"></a><span class="fu">## Causal Assumptions --- State Them Clearly, Question Them Honestly</span></span>
<span id="cb160-146"><a href="#cb160-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-147"><a href="#cb160-147" aria-hidden="true" tabindex="-1"></a>Every causal estimate rests on untestable assumptions. In a clean-room analysis, these are locked into the protocol and cannot be revised after seeing results. Be explicit about where each assumption could fail:</span>
<span id="cb160-148"><a href="#cb160-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-149"><a href="#cb160-149" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Consistency:** Initiation of a new NSAID (or opioid) prescription, irrespective of specific agent within class. This assumes that within-class variation in drug choice does not meaningfully affect AKI risk.</span>
<span id="cb160-150"><a href="#cb160-150" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Exchangeability:** Conditional on $W$, treatment choice is independent of potential outcomes. *This is the most fragile assumption.* Unmeasured confounders --- OTC NSAID use, frailty, kidney function trajectory --- could violate it. The E-value sensitivity analysis (Section 8) quantifies how strong such confounding would need to be.</span>
<span id="cb160-151"><a href="#cb160-151" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Positivity:** Both drugs are plausible options for all covariate strata. Severe CKD patients are rarely prescribed NSAIDs, which could lead to near-violations. The propensity score overlap diagnostics will flag this.</span>
<span id="cb160-152"><a href="#cb160-152" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-153"><a href="#cb160-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-154"><a href="#cb160-154" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.4 Pre-Specified Analysis Plan</span></span>
<span id="cb160-155"><a href="#cb160-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-156"><a href="#cb160-156" aria-hidden="true" tabindex="-1"></a>The SAP is the contract between the analyst and the regulator. Once signed, every element below is locked.</span>
<span id="cb160-157"><a href="#cb160-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-158"><a href="#cb160-158" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb160-159"><a href="#cb160-159" aria-hidden="true" tabindex="-1"></a><span class="fu">## Statistical Analysis Plan --- Locked Before Data Access</span></span>
<span id="cb160-160"><a href="#cb160-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-161"><a href="#cb160-161" aria-hidden="true" tabindex="-1"></a>The following specifications are frozen in the SAP. No modifications are permitted after data access.</span>
<span id="cb160-162"><a href="#cb160-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-163"><a href="#cb160-163" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Primary estimator:** TMLE with Super Learner</span>
<span id="cb160-164"><a href="#cb160-164" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Super Learner library:**</span>
<span id="cb160-165"><a href="#cb160-165" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`SL.glm`</span> (logistic regression)</span>
<span id="cb160-166"><a href="#cb160-166" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`SL.glm.interaction`</span> (logistic with all two-way interactions)</span>
<span id="cb160-167"><a href="#cb160-167" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`SL.step`</span> (stepwise regression)</span>
<span id="cb160-168"><a href="#cb160-168" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`SL.mean`</span> (intercept-only, for benchmarking)</span>
<span id="cb160-169"><a href="#cb160-169" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Number of cross-validation folds:** 5</span>
<span id="cb160-170"><a href="#cb160-170" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Propensity score bounds:** Truncate at <span class="co">[</span><span class="ot">0.025, 0.975</span><span class="co">]</span></span>
<span id="cb160-171"><a href="#cb160-171" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Secondary estimators:** G-computation, IPTW (for comparison)</span>
<span id="cb160-172"><a href="#cb160-172" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Pre-specified diagnostics:** PS overlap, weight distribution, covariate balance (SMD &lt; 0.1 threshold), EIC mean check</span>
<span id="cb160-173"><a href="#cb160-173" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Sensitivity analyses:** E-value for unmeasured confounding</span>
<span id="cb160-174"><a href="#cb160-174" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**Seed:** 20260101 (locked in SAP)</span>
<span id="cb160-175"><a href="#cb160-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-176"><a href="#cb160-176" aria-hidden="true" tabindex="-1"></a>Why does each element matter? The learner library determines what models the algorithm can consider. The CV folds control the bias-variance trade-off in model selection. The PS bounds prevent extreme weights. The diagnostics confirm that the estimation procedure is operating in a regime where we trust it. And the seed ensures anyone can reproduce the exact numerical result.</span>
<span id="cb160-177"><a href="#cb160-177" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-178"><a href="#cb160-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-179"><a href="#cb160-179" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-180"><a href="#cb160-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-181"><a href="#cb160-181" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Simulated Claims-Like Data</span></span>
<span id="cb160-182"><a href="#cb160-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-183"><a href="#cb160-183" aria-hidden="true" tabindex="-1"></a>We simulate data resembling insurance claims with realistic variable distributions and nonlinear relationships. In a real clean-room analysis, this section would be replaced by the pre-written data extraction queries from Phase 2.</span>
<span id="cb160-184"><a href="#cb160-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-187"><a href="#cb160-187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-188"><a href="#cb160-188" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb160-189"><a href="#cb160-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-190"><a href="#cb160-190" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-191"><a href="#cb160-191" aria-hidden="true" tabindex="-1"></a><span class="co"># LOCKED SEED — specified in the Statistical Analysis Plan</span></span>
<span id="cb160-192"><a href="#cb160-192" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-193"><a href="#cb160-193" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20260101</span>)</span>
<span id="cb160-194"><a href="#cb160-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-195"><a href="#cb160-195" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">8000</span></span>
<span id="cb160-196"><a href="#cb160-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-197"><a href="#cb160-197" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline confounders (claims-derived) ---</span></span>
<span id="cb160-198"><a href="#cb160-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-199"><a href="#cb160-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Demographics</span></span>
<span id="cb160-200"><a href="#cb160-200" aria-hidden="true" tabindex="-1"></a>age  <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">runif</span>(n, <span class="dv">18</span>, <span class="dv">80</span>))</span>
<span id="cb160-201"><a href="#cb160-201" aria-hidden="true" tabindex="-1"></a>male <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.45</span>)</span>
<span id="cb160-202"><a href="#cb160-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-203"><a href="#cb160-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Comorbidities (from diagnosis codes)</span></span>
<span id="cb160-204"><a href="#cb160-204" aria-hidden="true" tabindex="-1"></a><span class="co"># CKD stage (0=none, 1=mild, 2=moderate, 3=severe)</span></span>
<span id="cb160-205"><a href="#cb160-205" aria-hidden="true" tabindex="-1"></a>ckd <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb160-206"><a href="#cb160-206" aria-hidden="true" tabindex="-1"></a>              <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="fl">0.15</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>))</span>
<span id="cb160-207"><a href="#cb160-207" aria-hidden="true" tabindex="-1"></a>diabetes   <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">2.0</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> (ckd <span class="sc">&gt;</span> <span class="dv">0</span>)))</span>
<span id="cb160-208"><a href="#cb160-208" aria-hidden="true" tabindex="-1"></a>hypertension <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> male))</span>
<span id="cb160-209"><a href="#cb160-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-210"><a href="#cb160-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Medication history</span></span>
<span id="cb160-211"><a href="#cb160-211" aria-hidden="true" tabindex="-1"></a>prior_nsaid <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.35</span>)</span>
<span id="cb160-212"><a href="#cb160-212" aria-hidden="true" tabindex="-1"></a>prior_opioid <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.20</span>)</span>
<span id="cb160-213"><a href="#cb160-213" aria-hidden="true" tabindex="-1"></a>ace_arb     <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.8</span> <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> hypertension <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> diabetes))</span>
<span id="cb160-214"><a href="#cb160-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-215"><a href="#cb160-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Healthcare utilization (proxy for overall health burden)</span></span>
<span id="cb160-216"><a href="#cb160-216" aria-hidden="true" tabindex="-1"></a>n_rx <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="at">lambda =</span> <span class="dv">3</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> (ckd <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">+</span> diabetes)</span>
<span id="cb160-217"><a href="#cb160-217" aria-hidden="true" tabindex="-1"></a>n_visits <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="at">lambda =</span> <span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> age <span class="sc">+</span> ckd <span class="sc">+</span> diabetes)</span>
<span id="cb160-218"><a href="#cb160-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-219"><a href="#cb160-219" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment model ---</span></span>
<span id="cb160-220"><a href="#cb160-220" aria-hidden="true" tabindex="-1"></a><span class="co"># NSAIDs are preferentially prescribed to:</span></span>
<span id="cb160-221"><a href="#cb160-221" aria-hidden="true" tabindex="-1"></a><span class="co"># - younger patients</span></span>
<span id="cb160-222"><a href="#cb160-222" aria-hidden="true" tabindex="-1"></a><span class="co"># - those without CKD (contraindication concern)</span></span>
<span id="cb160-223"><a href="#cb160-223" aria-hidden="true" tabindex="-1"></a><span class="co"># - those with prior NSAID use (familiarity)</span></span>
<span id="cb160-224"><a href="#cb160-224" aria-hidden="true" tabindex="-1"></a><span class="co"># - those without ACE/ARB use (drug interaction concern)</span></span>
<span id="cb160-225"><a href="#cb160-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes nonlinear age effect and interactions</span></span>
<span id="cb160-226"><a href="#cb160-226" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="sc">+</span></span>
<span id="cb160-227"><a href="#cb160-227" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.02</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb160-228"><a href="#cb160-228" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.0005</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb160-229"><a href="#cb160-229" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb160-230"><a href="#cb160-230" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb160-231"><a href="#cb160-231" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">*</span> diabetes <span class="sc">+</span></span>
<span id="cb160-232"><a href="#cb160-232" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span> <span class="sc">*</span> prior_nsaid <span class="sc">+</span></span>
<span id="cb160-233"><a href="#cb160-233" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> prior_opioid <span class="sc">+</span></span>
<span id="cb160-234"><a href="#cb160-234" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.4</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb160-235"><a href="#cb160-235" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> n_rx <span class="sc">+</span></span>
<span id="cb160-236"><a href="#cb160-236" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.15</span> <span class="sc">*</span> male <span class="sc">+</span></span>
<span id="cb160-237"><a href="#cb160-237" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.3</span> <span class="sc">*</span> prior_nsaid <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">0</span>)  <span class="co"># interaction: prior NSAID use matters more without CKD</span></span>
<span id="cb160-238"><a href="#cb160-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-239"><a href="#cb160-239" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_trt))</span>
<span id="cb160-240"><a href="#cb160-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-241"><a href="#cb160-241" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome model ---</span></span>
<span id="cb160-242"><a href="#cb160-242" aria-hidden="true" tabindex="-1"></a><span class="co"># AKI risk depends on treatment and confounders</span></span>
<span id="cb160-243"><a href="#cb160-243" aria-hidden="true" tabindex="-1"></a><span class="co"># True effect: NSAIDs moderately increase AKI risk</span></span>
<span id="cb160-244"><a href="#cb160-244" aria-hidden="true" tabindex="-1"></a>lp_out <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">4.5</span> <span class="sc">+</span></span>
<span id="cb160-245"><a href="#cb160-245" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.45</span> <span class="sc">*</span> A <span class="sc">+</span>                              <span class="co"># true causal effect (harmful)</span></span>
<span id="cb160-246"><a href="#cb160-246" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb160-247"><a href="#cb160-247" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.0003</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb160-248"><a href="#cb160-248" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.6</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb160-249"><a href="#cb160-249" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.2</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb160-250"><a href="#cb160-250" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb160-251"><a href="#cb160-251" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.4</span> <span class="sc">*</span> diabetes <span class="sc">+</span></span>
<span id="cb160-252"><a href="#cb160-252" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.3</span> <span class="sc">*</span> hypertension <span class="sc">+</span></span>
<span id="cb160-253"><a href="#cb160-253" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb160-254"><a href="#cb160-254" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.05</span> <span class="sc">*</span> n_rx <span class="sc">+</span></span>
<span id="cb160-255"><a href="#cb160-255" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.25</span> <span class="sc">*</span> A <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span>                <span class="co"># interaction: NSAIDs more harmful with CKD</span></span>
<span id="cb160-256"><a href="#cb160-256" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.15</span> <span class="sc">*</span> A <span class="sc">*</span> ace_arb <span class="sc">+</span>                    <span class="co"># interaction: NSAIDs + ACE/ARB</span></span>
<span id="cb160-257"><a href="#cb160-257" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> male</span>
<span id="cb160-258"><a href="#cb160-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-259"><a href="#cb160-259" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_out))</span>
<span id="cb160-260"><a href="#cb160-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-261"><a href="#cb160-261" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb160-262"><a href="#cb160-262" aria-hidden="true" tabindex="-1"></a>  age, male, ckd, diabetes, hypertension,</span>
<span id="cb160-263"><a href="#cb160-263" aria-hidden="true" tabindex="-1"></a>  prior_nsaid, prior_opioid, ace_arb,</span>
<span id="cb160-264"><a href="#cb160-264" aria-hidden="true" tabindex="-1"></a>  n_rx, n_visits, A, Y</span>
<span id="cb160-265"><a href="#cb160-265" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-266"><a href="#cb160-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-267"><a href="#cb160-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-268"><a href="#cb160-268" aria-hidden="true" tabindex="-1"></a><span class="fu">### True causal effect</span></span>
<span id="cb160-269"><a href="#cb160-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-272"><a href="#cb160-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-273"><a href="#cb160-273" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the true ATE from the data-generating process</span></span>
<span id="cb160-274"><a href="#cb160-274" aria-hidden="true" tabindex="-1"></a>p1_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">4.5</span> <span class="sc">+</span> <span class="fl">0.45</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span> <span class="fl">0.0003</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb160-275"><a href="#cb160-275" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.6</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">1.2</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">2.0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb160-276"><a href="#cb160-276" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.4</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> hypertension <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb160-277"><a href="#cb160-277" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.05</span> <span class="sc">*</span> n_rx <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb160-278"><a href="#cb160-278" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> male)</span>
<span id="cb160-279"><a href="#cb160-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-280"><a href="#cb160-280" aria-hidden="true" tabindex="-1"></a>p0_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">4.5</span> <span class="sc">+</span> <span class="fl">0.45</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">+</span> <span class="fl">0.0003</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb160-281"><a href="#cb160-281" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.6</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">1.2</span> <span class="sc">*</span> (ckd <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">2.0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb160-282"><a href="#cb160-282" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.4</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> hypertension <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb160-283"><a href="#cb160-283" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.05</span> <span class="sc">*</span> n_rx <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> (ckd <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> ace_arb <span class="sc">+</span></span>
<span id="cb160-284"><a href="#cb160-284" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> male)</span>
<span id="cb160-285"><a href="#cb160-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-286"><a href="#cb160-286" aria-hidden="true" tabindex="-1"></a>true_ate <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_true <span class="sc">-</span> p0_true)</span>
<span id="cb160-287"><a href="#cb160-287" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE (risk difference):"</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-288"><a href="#cb160-288" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under NSAIDs: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p1_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-289"><a href="#cb160-289" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under opioids:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p0_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-290"><a href="#cb160-290" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AKI event rate overall: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Y), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-291"><a href="#cb160-291" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Treatment prevalence:   "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(A), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-292"><a href="#cb160-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-293"><a href="#cb160-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-294"><a href="#cb160-294" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data summary (what the analyst sees)</span></span>
<span id="cb160-295"><a href="#cb160-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-298"><a href="#cb160-298" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-299"><a href="#cb160-299" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariate distributions by treatment group</span></span>
<span id="cb160-300"><a href="#cb160-300" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb160-301"><a href="#cb160-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb160-302"><a href="#cb160-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb160-303"><a href="#cb160-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">n          =</span> <span class="fu">n</span>(),</span>
<span id="cb160-304"><a href="#cb160-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_age   =</span> <span class="fu">mean</span>(age),</span>
<span id="cb160-305"><a href="#cb160-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_male   =</span> <span class="fu">mean</span>(male),</span>
<span id="cb160-306"><a href="#cb160-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_ckd_2plus =</span> <span class="fu">mean</span>(ckd <span class="sc">&gt;=</span> <span class="dv">2</span>),</span>
<span id="cb160-307"><a href="#cb160-307" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_diabetes  =</span> <span class="fu">mean</span>(diabetes),</span>
<span id="cb160-308"><a href="#cb160-308" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_htn    =</span> <span class="fu">mean</span>(hypertension),</span>
<span id="cb160-309"><a href="#cb160-309" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_prior_nsaid =</span> <span class="fu">mean</span>(prior_nsaid),</span>
<span id="cb160-310"><a href="#cb160-310" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_ace_arb =</span> <span class="fu">mean</span>(ace_arb),</span>
<span id="cb160-311"><a href="#cb160-311" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_n_rx  =</span> <span class="fu">mean</span>(n_rx),</span>
<span id="cb160-312"><a href="#cb160-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">aki_rate   =</span> <span class="fu">mean</span>(Y),</span>
<span id="cb160-313"><a href="#cb160-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb160-314"><a href="#cb160-314" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-315"><a href="#cb160-315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-316"><a href="#cb160-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-317"><a href="#cb160-317" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-318"><a href="#cb160-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-319"><a href="#cb160-319" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. Phase 3: Locked Analysis Pipeline</span></span>
<span id="cb160-320"><a href="#cb160-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-321"><a href="#cb160-321" aria-hidden="true" tabindex="-1"></a>The following code represents the **locked analysis** that runs without modification. Every step is pre-specified. We walk through each step with a plain-language explanation first, then show the code.</span>
<span id="cb160-322"><a href="#cb160-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-323"><a href="#cb160-323" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.1 Step 1: Propensity Score Estimation</span></span>
<span id="cb160-324"><a href="#cb160-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-325"><a href="#cb160-325" aria-hidden="true" tabindex="-1"></a>Before we can estimate the treatment effect, we need to model the treatment assignment mechanism. The propensity score answers the question: given a patient's baseline characteristics, how likely were they to receive NSAIDs rather than opioids?</span>
<span id="cb160-326"><a href="#cb160-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-327"><a href="#cb160-327" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb160-328"><a href="#cb160-328" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Estimate the Propensity Score</span></span>
<span id="cb160-329"><a href="#cb160-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-330"><a href="#cb160-330" aria-hidden="true" tabindex="-1"></a>The propensity score $g(W) = P(A = 1 \mid W)$ estimates each patient's probability of receiving NSAIDs given their baseline covariates. We need this for two reasons:</span>
<span id="cb160-331"><a href="#cb160-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-332"><a href="#cb160-332" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>It allows us to construct the **clever covariate** that targets the TMLE update toward the causal parameter of interest.</span>
<span id="cb160-333"><a href="#cb160-333" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>It helps us assess **positivity** --- whether both treatments are plausible for all patients.</span>
<span id="cb160-334"><a href="#cb160-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-335"><a href="#cb160-335" aria-hidden="true" tabindex="-1"></a>The model formula and truncation bounds were locked in the SAP before data access. Truncation at <span class="co">[</span><span class="ot">0.025, 0.975</span><span class="co">]</span> prevents extreme inverse-probability weights from individual observations dominating the estimate.</span>
<span id="cb160-336"><a href="#cb160-336" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-337"><a href="#cb160-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-340"><a href="#cb160-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-341"><a href="#cb160-341" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-342"><a href="#cb160-342" aria-hidden="true" tabindex="-1"></a><span class="co"># PRE-SPECIFIED: Propensity score model</span></span>
<span id="cb160-343"><a href="#cb160-343" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 4.2: Use logistic regression with all baseline</span></span>
<span id="cb160-344"><a href="#cb160-344" aria-hidden="true" tabindex="-1"></a><span class="co"># covariates, squared age term, and CKD indicators</span></span>
<span id="cb160-345"><a href="#cb160-345" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-346"><a href="#cb160-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-347"><a href="#cb160-347" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"ckd"</span>, <span class="st">"diabetes"</span>, <span class="st">"hypertension"</span>,</span>
<span id="cb160-348"><a href="#cb160-348" aria-hidden="true" tabindex="-1"></a>                <span class="st">"prior_nsaid"</span>, <span class="st">"prior_opioid"</span>, <span class="st">"ace_arb"</span>, <span class="st">"n_rx"</span>, <span class="st">"n_visits"</span>)</span>
<span id="cb160-349"><a href="#cb160-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-350"><a href="#cb160-350" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert CKD to factor for proper modeling</span></span>
<span id="cb160-351"><a href="#cb160-351" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb160-352"><a href="#cb160-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ckd_f =</span> <span class="fu">factor</span>(ckd))</span>
<span id="cb160-353"><a href="#cb160-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-354"><a href="#cb160-354" aria-hidden="true" tabindex="-1"></a>g_formula <span class="ot">&lt;-</span> A <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> male <span class="sc">+</span> ckd_f <span class="sc">+</span> diabetes <span class="sc">+</span> hypertension <span class="sc">+</span></span>
<span id="cb160-355"><a href="#cb160-355" aria-hidden="true" tabindex="-1"></a>  prior_nsaid <span class="sc">+</span> prior_opioid <span class="sc">+</span> ace_arb <span class="sc">+</span> n_rx <span class="sc">+</span> n_visits <span class="sc">+</span></span>
<span id="cb160-356"><a href="#cb160-356" aria-hidden="true" tabindex="-1"></a>  prior_nsaid<span class="sc">:</span>ckd_f <span class="sc">+</span> ace_arb<span class="sc">:</span>diabetes</span>
<span id="cb160-357"><a href="#cb160-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-358"><a href="#cb160-358" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(g_formula, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb160-359"><a href="#cb160-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-360"><a href="#cb160-360" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb160-361"><a href="#cb160-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-362"><a href="#cb160-362" aria-hidden="true" tabindex="-1"></a><span class="co"># PRE-SPECIFIED: Truncate at [0.025, 0.975]</span></span>
<span id="cb160-363"><a href="#cb160-363" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps_trunc <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.025</span>, <span class="fu">pmin</span>(<span class="fl">0.975</span>, dat<span class="sc">$</span>ps))</span>
<span id="cb160-364"><a href="#cb160-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-365"><a href="#cb160-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-366"><a href="#cb160-366" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.2 Step 2: Pre-Specified Diagnostics (Covariate Balance)</span></span>
<span id="cb160-367"><a href="#cb160-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-368"><a href="#cb160-368" aria-hidden="true" tabindex="-1"></a>These diagnostics are run **before** looking at the effect estimate, to confirm that the propensity score model is adequate. Think of this as a quality gate: if the diagnostics fail, we know the estimation is unreliable regardless of what number comes out.</span>
<span id="cb160-369"><a href="#cb160-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-370"><a href="#cb160-370" aria-hidden="true" tabindex="-1"></a><span class="fu">### Propensity score overlap</span></span>
<span id="cb160-371"><a href="#cb160-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-372"><a href="#cb160-372" aria-hidden="true" tabindex="-1"></a>The overlap plot is the most important single diagnostic. If the two treatment groups have propensity score distributions that do not overlap, we are trying to compare patients who are fundamentally different --- and no statistical method can rescue that.</span>
<span id="cb160-373"><a href="#cb160-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-374"><a href="#cb160-374" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb160-375"><a href="#cb160-375" aria-hidden="true" tabindex="-1"></a><span class="fu">## What to Look For: Propensity Score Overlap</span></span>
<span id="cb160-376"><a href="#cb160-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-377"><a href="#cb160-377" aria-hidden="true" tabindex="-1"></a>A healthy overlap plot shows two distributions that cover a similar range, with substantial overlap in the middle. Warning signs include:</span>
<span id="cb160-378"><a href="#cb160-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-379"><a href="#cb160-379" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Separation:** If the two curves barely overlap, positivity is violated and the estimate will rely heavily on extrapolation.</span>
<span id="cb160-380"><a href="#cb160-380" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Spikes near 0 or 1:** Patients with propensity scores near the boundaries contribute extreme weights. The truncation at <span class="co">[</span><span class="ot">0.025, 0.975</span><span class="co">]</span> mitigates this, but if many patients are truncated, the effective estimand changes.</span>
<span id="cb160-381"><a href="#cb160-381" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Asymmetry:** If one group is concentrated in a narrow range while the other is spread out, consider whether the target population needs to be restricted.</span>
<span id="cb160-382"><a href="#cb160-382" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-383"><a href="#cb160-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-386"><a href="#cb160-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-387"><a href="#cb160-387" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-388"><a href="#cb160-388" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 1: Propensity score overlap</span></span>
<span id="cb160-389"><a href="#cb160-389" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.1</span></span>
<span id="cb160-390"><a href="#cb160-390" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-391"><a href="#cb160-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-392"><a href="#cb160-392" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>)))) <span class="sc">+</span></span>
<span id="cb160-393"><a href="#cb160-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb160-394"><a href="#cb160-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-395"><a href="#cb160-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated propensity score P(NSAID | W)"</span>,</span>
<span id="cb160-396"><a href="#cb160-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb160-397"><a href="#cb160-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb160-398"><a href="#cb160-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 1: Propensity Score Overlap"</span></span>
<span id="cb160-399"><a href="#cb160-399" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-400"><a href="#cb160-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb160-401"><a href="#cb160-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb160-402"><a href="#cb160-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-403"><a href="#cb160-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-406"><a href="#cb160-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-407"><a href="#cb160-407" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantile summary</span></span>
<span id="cb160-408"><a href="#cb160-408" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb160-409"><a href="#cb160-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">Treatment =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb160-410"><a href="#cb160-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb160-411"><a href="#cb160-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">min  =</span> <span class="fu">round</span>(<span class="fu">min</span>(ps), <span class="dv">3</span>),</span>
<span id="cb160-412"><a href="#cb160-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">p5   =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.05</span>), <span class="dv">3</span>),</span>
<span id="cb160-413"><a href="#cb160-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">p25  =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.25</span>), <span class="dv">3</span>),</span>
<span id="cb160-414"><a href="#cb160-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">round</span>(<span class="fu">median</span>(ps), <span class="dv">3</span>),</span>
<span id="cb160-415"><a href="#cb160-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">p75  =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.75</span>), <span class="dv">3</span>),</span>
<span id="cb160-416"><a href="#cb160-416" aria-hidden="true" tabindex="-1"></a>    <span class="at">p95  =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(ps, <span class="fl">0.95</span>), <span class="dv">3</span>),</span>
<span id="cb160-417"><a href="#cb160-417" aria-hidden="true" tabindex="-1"></a>    <span class="at">max  =</span> <span class="fu">round</span>(<span class="fu">max</span>(ps), <span class="dv">3</span>),</span>
<span id="cb160-418"><a href="#cb160-418" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb160-419"><a href="#cb160-419" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-420"><a href="#cb160-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-421"><a href="#cb160-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-422"><a href="#cb160-422" aria-hidden="true" tabindex="-1"></a><span class="fu">### Covariate balance: Standardized Mean Differences</span></span>
<span id="cb160-423"><a href="#cb160-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-424"><a href="#cb160-424" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb160-425"><a href="#cb160-425" aria-hidden="true" tabindex="-1"></a><span class="fu">## What to Look For: Covariate Balance</span></span>
<span id="cb160-426"><a href="#cb160-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-427"><a href="#cb160-427" aria-hidden="true" tabindex="-1"></a>Standardized Mean Differences (SMDs) measure how different the treatment groups are on each covariate. The SAP pre-specifies a threshold of SMD &lt; 0.1 for adequate balance.</span>
<span id="cb160-428"><a href="#cb160-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-429"><a href="#cb160-429" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Unadjusted SMDs** show the raw imbalance in the data. Large values confirm confounding is present.</span>
<span id="cb160-430"><a href="#cb160-430" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Weighted SMDs** show the imbalance after IPTW adjustment. If all weighted SMDs fall below 0.1, the propensity score model has successfully balanced the groups on observed covariates.</span>
<span id="cb160-431"><a href="#cb160-431" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The Love plot** visualizes this comparison. Look for all weighted points (green) to fall left of the dashed 0.1 threshold line.</span>
<span id="cb160-432"><a href="#cb160-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-433"><a href="#cb160-433" aria-hidden="true" tabindex="-1"></a>If weighted SMDs remain above 0.1 for important confounders, the propensity score model needs refinement --- but in a clean-room analysis, this would have been caught in the simulation phase and the model adjusted before locking the code.</span>
<span id="cb160-434"><a href="#cb160-434" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-435"><a href="#cb160-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-438"><a href="#cb160-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-439"><a href="#cb160-439" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-440"><a href="#cb160-440" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 2: Covariate balance before and after weighting</span></span>
<span id="cb160-441"><a href="#cb160-441" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.2: SMD threshold &lt; 0.1</span></span>
<span id="cb160-442"><a href="#cb160-442" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-443"><a href="#cb160-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-444"><a href="#cb160-444" aria-hidden="true" tabindex="-1"></a>compute_smd <span class="ot">&lt;-</span> <span class="cf">function</span>(data, var, trt, <span class="at">weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb160-445"><a href="#cb160-445" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(weights)) weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb160-446"><a href="#cb160-446" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb160-447"><a href="#cb160-447" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb160-448"><a href="#cb160-448" aria-hidden="true" tabindex="-1"></a>  w1 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb160-449"><a href="#cb160-449" aria-hidden="true" tabindex="-1"></a>  w0 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb160-450"><a href="#cb160-450" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d1, w1)</span>
<span id="cb160-451"><a href="#cb160-451" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d0, w0)</span>
<span id="cb160-452"><a href="#cb160-452" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w1 <span class="sc">*</span> (d1 <span class="sc">-</span> m1)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w1))</span>
<span id="cb160-453"><a href="#cb160-453" aria-hidden="true" tabindex="-1"></a>  s0 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w0 <span class="sc">*</span> (d0 <span class="sc">-</span> m0)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w0))</span>
<span id="cb160-454"><a href="#cb160-454" aria-hidden="true" tabindex="-1"></a>  pooled_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((s1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> s0<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb160-455"><a href="#cb160-455" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pooled_sd <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb160-456"><a href="#cb160-456" aria-hidden="true" tabindex="-1"></a>  (m1 <span class="sc">-</span> m0) <span class="sc">/</span> pooled_sd</span>
<span id="cb160-457"><a href="#cb160-457" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-458"><a href="#cb160-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-459"><a href="#cb160-459" aria-hidden="true" tabindex="-1"></a><span class="co"># Stabilized IPTW weights for balance assessment</span></span>
<span id="cb160-460"><a href="#cb160-460" aria-hidden="true" tabindex="-1"></a>p_A <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>A)</span>
<span id="cb160-461"><a href="#cb160-461" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>sw <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb160-462"><a href="#cb160-462" aria-hidden="true" tabindex="-1"></a>                 p_A <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc,</span>
<span id="cb160-463"><a href="#cb160-463" aria-hidden="true" tabindex="-1"></a>                 (<span class="dv">1</span> <span class="sc">-</span> p_A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc))</span>
<span id="cb160-464"><a href="#cb160-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-465"><a href="#cb160-465" aria-hidden="true" tabindex="-1"></a>balance_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"ckd"</span>, <span class="st">"diabetes"</span>, <span class="st">"hypertension"</span>,</span>
<span id="cb160-466"><a href="#cb160-466" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"prior_nsaid"</span>, <span class="st">"prior_opioid"</span>, <span class="st">"ace_arb"</span>, <span class="st">"n_rx"</span>, <span class="st">"n_visits"</span>)</span>
<span id="cb160-467"><a href="#cb160-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-468"><a href="#cb160-468" aria-hidden="true" tabindex="-1"></a>smd_raw <span class="ot">&lt;-</span> <span class="fu">sapply</span>(balance_vars, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>))</span>
<span id="cb160-469"><a href="#cb160-469" aria-hidden="true" tabindex="-1"></a>smd_wt  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(balance_vars, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>, dat<span class="sc">$</span>sw))</span>
<span id="cb160-470"><a href="#cb160-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-471"><a href="#cb160-471" aria-hidden="true" tabindex="-1"></a>balance_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb160-472"><a href="#cb160-472" aria-hidden="true" tabindex="-1"></a>  <span class="at">Covariate  =</span> balance_vars,</span>
<span id="cb160-473"><a href="#cb160-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">Unadjusted =</span> <span class="fu">round</span>(<span class="fu">abs</span>(smd_raw), <span class="dv">3</span>),</span>
<span id="cb160-474"><a href="#cb160-474" aria-hidden="true" tabindex="-1"></a>  <span class="at">Weighted   =</span> <span class="fu">round</span>(<span class="fu">abs</span>(smd_wt), <span class="dv">3</span>)</span>
<span id="cb160-475"><a href="#cb160-475" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-476"><a href="#cb160-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-477"><a href="#cb160-477" aria-hidden="true" tabindex="-1"></a>balance_df</span>
<span id="cb160-478"><a href="#cb160-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-479"><a href="#cb160-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-482"><a href="#cb160-482" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-483"><a href="#cb160-483" aria-hidden="true" tabindex="-1"></a><span class="co"># Love plot</span></span>
<span id="cb160-484"><a href="#cb160-484" aria-hidden="true" tabindex="-1"></a>balance_long <span class="ot">&lt;-</span> balance_df <span class="sc">%&gt;%</span></span>
<span id="cb160-485"><a href="#cb160-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>Covariate, <span class="at">names_to =</span> <span class="st">"Method"</span>, <span class="at">values_to =</span> <span class="st">"SMD"</span>)</span>
<span id="cb160-486"><a href="#cb160-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-487"><a href="#cb160-487" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(balance_long, <span class="fu">aes</span>(<span class="at">x =</span> SMD, <span class="at">y =</span> <span class="fu">reorder</span>(Covariate, SMD),</span>
<span id="cb160-488"><a href="#cb160-488" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color =</span> Method, <span class="at">shape =</span> Method)) <span class="sc">+</span></span>
<span id="cb160-489"><a href="#cb160-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb160-490"><a href="#cb160-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb160-491"><a href="#cb160-491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-492"><a href="#cb160-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Absolute Standardized Mean Difference"</span>,</span>
<span id="cb160-493"><a href="#cb160-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb160-494"><a href="#cb160-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 2: Covariate Balance (Love Plot)"</span>,</span>
<span id="cb160-495"><a href="#cb160-495" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed line = 0.1 threshold from SAP"</span></span>
<span id="cb160-496"><a href="#cb160-496" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-497"><a href="#cb160-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb160-498"><a href="#cb160-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#EE6677"</span>, <span class="st">"#228833"</span>))</span>
<span id="cb160-499"><a href="#cb160-499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-500"><a href="#cb160-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-501"><a href="#cb160-501" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weight distribution</span></span>
<span id="cb160-502"><a href="#cb160-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-505"><a href="#cb160-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-506"><a href="#cb160-506" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-507"><a href="#cb160-507" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 3: Weight distribution</span></span>
<span id="cb160-508"><a href="#cb160-508" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.3</span></span>
<span id="cb160-509"><a href="#cb160-509" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-510"><a href="#cb160-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-511"><a href="#cb160-511" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> sw, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>)))) <span class="sc">+</span></span>
<span id="cb160-512"><a href="#cb160-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb160-513"><a href="#cb160-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-514"><a href="#cb160-514" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stabilized IPTW weight"</span>,</span>
<span id="cb160-515"><a href="#cb160-515" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb160-516"><a href="#cb160-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb160-517"><a href="#cb160-517" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 3: Weight Distribution"</span></span>
<span id="cb160-518"><a href="#cb160-518" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-519"><a href="#cb160-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb160-520"><a href="#cb160-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>)) <span class="sc">+</span></span>
<span id="cb160-521"><a href="#cb160-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>)</span>
<span id="cb160-522"><a href="#cb160-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-523"><a href="#cb160-523" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Weight summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-524"><a href="#cb160-524" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>sw)</span>
<span id="cb160-525"><a href="#cb160-525" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction &gt; 5:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">5</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-526"><a href="#cb160-526" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction &gt; 10:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-527"><a href="#cb160-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-528"><a href="#cb160-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-529"><a href="#cb160-529" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-530"><a href="#cb160-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-531"><a href="#cb160-531" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.3 Step 3: Primary Estimator --- TMLE (by hand)</span></span>
<span id="cb160-532"><a href="#cb160-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-533"><a href="#cb160-533" aria-hidden="true" tabindex="-1"></a>With diagnostics confirming adequate overlap and balance, we proceed to estimation. TMLE is a multi-step algorithm. We walk through each step with a plain-language explanation, then the code. If you have read the KH Stats TMLE tutorial, you will recognize the same logic here --- just applied in a clean-room regulatory context.</span>
<span id="cb160-534"><a href="#cb160-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-535"><a href="#cb160-535" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb160-536"><a href="#cb160-536" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3a: Fit the Initial Outcome Model (Q)</span></span>
<span id="cb160-537"><a href="#cb160-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-538"><a href="#cb160-538" aria-hidden="true" tabindex="-1"></a>First, we build a model to predict the outcome (AKI) from treatment and covariates. This is called the "initial Q" --- think of it as our first rough guess at each patient's risk under each treatment scenario.</span>
<span id="cb160-539"><a href="#cb160-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-540"><a href="#cb160-540" aria-hidden="true" tabindex="-1"></a>We fit one model and then generate three sets of predictions:</span>
<span id="cb160-541"><a href="#cb160-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-542"><a href="#cb160-542" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Q1**: predicted risk if the patient had received NSAIDs (set A = 1 for everyone)</span>
<span id="cb160-543"><a href="#cb160-543" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Q0**: predicted risk if the patient had received opioids (set A = 0 for everyone)</span>
<span id="cb160-544"><a href="#cb160-544" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**QA**: predicted risk under the treatment they actually received</span>
<span id="cb160-545"><a href="#cb160-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-546"><a href="#cb160-546" aria-hidden="true" tabindex="-1"></a>These predictions are "initial" because TMLE will update them in the targeting step to reduce bias for the specific causal parameter we care about.</span>
<span id="cb160-547"><a href="#cb160-547" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-548"><a href="#cb160-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-551"><a href="#cb160-551" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-552"><a href="#cb160-552" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-553"><a href="#cb160-553" aria-hidden="true" tabindex="-1"></a><span class="co"># PRIMARY ANALYSIS: TMLE</span></span>
<span id="cb160-554"><a href="#cb160-554" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 6.1</span></span>
<span id="cb160-555"><a href="#cb160-555" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-556"><a href="#cb160-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-557"><a href="#cb160-557" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb160-558"><a href="#cb160-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-559"><a href="#cb160-559" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3a: Initial outcome model ---</span></span>
<span id="cb160-560"><a href="#cb160-560" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-specified model form from SAP</span></span>
<span id="cb160-561"><a href="#cb160-561" aria-hidden="true" tabindex="-1"></a>q_formula <span class="ot">&lt;-</span> Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> male <span class="sc">+</span> ckd_f <span class="sc">+</span> diabetes <span class="sc">+</span> hypertension <span class="sc">+</span></span>
<span id="cb160-562"><a href="#cb160-562" aria-hidden="true" tabindex="-1"></a>  prior_nsaid <span class="sc">+</span> prior_opioid <span class="sc">+</span> ace_arb <span class="sc">+</span> n_rx <span class="sc">+</span> n_visits <span class="sc">+</span></span>
<span id="cb160-563"><a href="#cb160-563" aria-hidden="true" tabindex="-1"></a>  A<span class="sc">:</span>ckd_f <span class="sc">+</span> A<span class="sc">:</span>ace_arb <span class="sc">+</span> A<span class="sc">:</span>diabetes</span>
<span id="cb160-564"><a href="#cb160-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-565"><a href="#cb160-565" aria-hidden="true" tabindex="-1"></a>q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(q_formula, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb160-566"><a href="#cb160-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-567"><a href="#cb160-567" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial predictions</span></span>
<span id="cb160-568"><a href="#cb160-568" aria-hidden="true" tabindex="-1"></a>Q1_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb160-569"><a href="#cb160-569" aria-hidden="true" tabindex="-1"></a>Q0_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb160-570"><a href="#cb160-570" aria-hidden="true" tabindex="-1"></a>QA_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb160-571"><a href="#cb160-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-572"><a href="#cb160-572" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Initial outcome model fitted.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-573"><a href="#cb160-573" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-574"><a href="#cb160-574" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-575"><a href="#cb160-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-576"><a href="#cb160-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-577"><a href="#cb160-577" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb160-578"><a href="#cb160-578" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3b: Compute the Clever Covariate</span></span>
<span id="cb160-579"><a href="#cb160-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-580"><a href="#cb160-580" aria-hidden="true" tabindex="-1"></a>The clever covariate bridges the outcome model and the treatment model. It tells the fluctuation step *where* to adjust the initial predictions and *by how much*.</span>
<span id="cb160-581"><a href="#cb160-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-582"><a href="#cb160-582" aria-hidden="true" tabindex="-1"></a>For the ATE, the clever covariate for each observation is:</span>
<span id="cb160-583"><a href="#cb160-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-584"><a href="#cb160-584" aria-hidden="true" tabindex="-1"></a>$$H(A, W) = \frac{A}{g(W)} - \frac{1-A}{1-g(W)}$$</span>
<span id="cb160-585"><a href="#cb160-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-586"><a href="#cb160-586" aria-hidden="true" tabindex="-1"></a>For treated patients (A = 1), this simplifies to $1/g(W)$ --- the inverse of their probability of being treated. For controls (A = 0), it is $-1/(1 - g(W))$. Patients who received an unlikely treatment get a larger clever covariate, meaning the targeting step will adjust their predictions more. This is the mechanism through which TMLE "borrows strength" from the propensity score to correct the outcome model.</span>
<span id="cb160-587"><a href="#cb160-587" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-588"><a href="#cb160-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-591"><a href="#cb160-591" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-592"><a href="#cb160-592" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3b: Clever covariate ---</span></span>
<span id="cb160-593"><a href="#cb160-593" aria-hidden="true" tabindex="-1"></a>H_A <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc)</span>
<span id="cb160-594"><a href="#cb160-594" aria-hidden="true" tabindex="-1"></a>H_1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc</span>
<span id="cb160-595"><a href="#cb160-595" aria-hidden="true" tabindex="-1"></a>H_0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc)</span>
<span id="cb160-596"><a href="#cb160-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-597"><a href="#cb160-597" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Clever covariate range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(H_A), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-598"><a href="#cb160-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-599"><a href="#cb160-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-600"><a href="#cb160-600" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb160-601"><a href="#cb160-601" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3c: Fluctuation (Targeting) Step</span></span>
<span id="cb160-602"><a href="#cb160-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-603"><a href="#cb160-603" aria-hidden="true" tabindex="-1"></a>This is the step that makes TMLE special. We fit a simple logistic regression with:</span>
<span id="cb160-604"><a href="#cb160-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-605"><a href="#cb160-605" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Outcome:** the observed Y</span>
<span id="cb160-606"><a href="#cb160-606" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Offset:** the logit of our initial predictions (QA_init)</span>
<span id="cb160-607"><a href="#cb160-607" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Covariate:** the clever covariate H(A, W)</span>
<span id="cb160-608"><a href="#cb160-608" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**No intercept** (-1 in the formula)</span>
<span id="cb160-609"><a href="#cb160-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-610"><a href="#cb160-610" aria-hidden="true" tabindex="-1"></a>The single coefficient from this regression, called epsilon, tells us how much and in which direction to shift our initial predictions. The offset locks in the initial predictions; epsilon only adjusts them in the direction that reduces bias for the ATE specifically.</span>
<span id="cb160-611"><a href="#cb160-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-612"><a href="#cb160-612" aria-hidden="true" tabindex="-1"></a>This is the "targeting" in Targeted Maximum Likelihood --- the initial model is updated to be optimal for our specific estimand, not just for prediction in general.</span>
<span id="cb160-613"><a href="#cb160-613" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-614"><a href="#cb160-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-617"><a href="#cb160-617" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-618"><a href="#cb160-618" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3c: Fluctuation (targeting) model ---</span></span>
<span id="cb160-619"><a href="#cb160-619" aria-hidden="true" tabindex="-1"></a>fluc <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QA_init)) <span class="sc">+</span> H_A,</span>
<span id="cb160-620"><a href="#cb160-620" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> binomial)</span>
<span id="cb160-621"><a href="#cb160-621" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc)</span>
<span id="cb160-622"><a href="#cb160-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-623"><a href="#cb160-623" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon (fluctuation parameter):"</span>, <span class="fu">round</span>(epsilon, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-624"><a href="#cb160-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-625"><a href="#cb160-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-626"><a href="#cb160-626" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb160-627"><a href="#cb160-627" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3d-e: Update Predictions and Compute the Final TMLE Estimate</span></span>
<span id="cb160-628"><a href="#cb160-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-629"><a href="#cb160-629" aria-hidden="true" tabindex="-1"></a>Now we apply the epsilon update to get our final, targeted predictions:</span>
<span id="cb160-630"><a href="#cb160-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-631"><a href="#cb160-631" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Shift Q1_init and Q0_init on the logit scale by epsilon times their respective clever covariates</span>
<span id="cb160-632"><a href="#cb160-632" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Transform back to the probability scale using the inverse-logit (plogis)</span>
<span id="cb160-633"><a href="#cb160-633" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Average the updated predictions across all patients to get the counterfactual risks</span>
<span id="cb160-634"><a href="#cb160-634" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Take the difference to get the ATE</span>
<span id="cb160-635"><a href="#cb160-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-636"><a href="#cb160-636" aria-hidden="true" tabindex="-1"></a>The resulting estimate, $\hat{\psi}_{TMLE}$, is doubly robust: it is consistent if either the outcome model or the propensity score model is correctly specified. It also solves the efficient influence curve estimating equation, which means it achieves the smallest possible variance among regular asymptotically linear estimators.</span>
<span id="cb160-637"><a href="#cb160-637" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-638"><a href="#cb160-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-641"><a href="#cb160-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-642"><a href="#cb160-642" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3d: Updated predictions ---</span></span>
<span id="cb160-643"><a href="#cb160-643" aria-hidden="true" tabindex="-1"></a>Q1_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q1_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_1)</span>
<span id="cb160-644"><a href="#cb160-644" aria-hidden="true" tabindex="-1"></a>Q0_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q0_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_0)</span>
<span id="cb160-645"><a href="#cb160-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-646"><a href="#cb160-646" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3e: TMLE estimate ---</span></span>
<span id="cb160-647"><a href="#cb160-647" aria-hidden="true" tabindex="-1"></a>tmle_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_star)</span>
<span id="cb160-648"><a href="#cb160-648" aria-hidden="true" tabindex="-1"></a>tmle_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_star)</span>
<span id="cb160-649"><a href="#cb160-649" aria-hidden="true" tabindex="-1"></a>tmle_ate   <span class="ot">&lt;-</span> tmle_risk1 <span class="sc">-</span> tmle_risk0</span>
<span id="cb160-650"><a href="#cb160-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-651"><a href="#cb160-651" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (NSAIDs): "</span>, <span class="fu">round</span>(tmle_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-652"><a href="#cb160-652" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (opioids):"</span>, <span class="fu">round</span>(tmle_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-653"><a href="#cb160-653" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:           "</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-654"><a href="#cb160-654" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:           "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-655"><a href="#cb160-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-656"><a href="#cb160-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-659"><a href="#cb160-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-660"><a href="#cb160-660" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3f: Inference via efficient influence curve ---</span></span>
<span id="cb160-661"><a href="#cb160-661" aria-hidden="true" tabindex="-1"></a>eic <span class="ot">&lt;-</span> (dat<span class="sc">$</span>A <span class="sc">/</span> dat<span class="sc">$</span>ps_trunc) <span class="sc">*</span> (dat<span class="sc">$</span>Y <span class="sc">-</span> Q1_star) <span class="sc">+</span> Q1_star <span class="sc">-</span> tmle_risk1 <span class="sc">-</span></span>
<span id="cb160-662"><a href="#cb160-662" aria-hidden="true" tabindex="-1"></a>       ((<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps_trunc)) <span class="sc">*</span> (dat<span class="sc">$</span>Y <span class="sc">-</span> Q0_star) <span class="sc">-</span> Q0_star <span class="sc">+</span> tmle_risk0</span>
<span id="cb160-663"><a href="#cb160-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-664"><a href="#cb160-664" aria-hidden="true" tabindex="-1"></a>tmle_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic) <span class="sc">/</span> n)</span>
<span id="cb160-665"><a href="#cb160-665" aria-hidden="true" tabindex="-1"></a>tmle_ci <span class="ot">&lt;-</span> tmle_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> tmle_se</span>
<span id="cb160-666"><a href="#cb160-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-667"><a href="#cb160-667" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== PRIMARY RESULT ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-668"><a href="#cb160-668" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:"</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-669"><a href="#cb160-669" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SE:      "</span>, <span class="fu">round</span>(tmle_se, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-670"><a href="#cb160-670" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:  ["</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-671"><a href="#cb160-671" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"p-value: "</span>, <span class="fu">round</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(tmle_ate <span class="sc">/</span> tmle_se)), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-672"><a href="#cb160-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-673"><a href="#cb160-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-676"><a href="#cb160-676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-677"><a href="#cb160-677" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3g: Verify EIC mean ≈ 0 ---</span></span>
<span id="cb160-678"><a href="#cb160-678" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic), <span class="dv">8</span>), <span class="st">" (should be ~0)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-679"><a href="#cb160-679" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-680"><a href="#cb160-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-681"><a href="#cb160-681" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb160-682"><a href="#cb160-682" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Is the EIC Mean Zero?</span></span>
<span id="cb160-683"><a href="#cb160-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-684"><a href="#cb160-684" aria-hidden="true" tabindex="-1"></a>The efficient influence curve (EIC) for the TMLE estimate should have a mean of approximately zero. This is not a coincidence --- it is a direct consequence of the targeting step.</span>
<span id="cb160-685"><a href="#cb160-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-686"><a href="#cb160-686" aria-hidden="true" tabindex="-1"></a>When we fit the fluctuation model with the clever covariate, the score equation of that logistic regression forces the EIC estimating equation to be solved. In other words, the targeting step guarantees that the mean of the EIC is (numerically) zero.</span>
<span id="cb160-687"><a href="#cb160-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-688"><a href="#cb160-688" aria-hidden="true" tabindex="-1"></a>**Why this matters for clean-room analysis:** The EIC mean is a built-in diagnostic. If it deviates meaningfully from zero, something went wrong in the implementation --- perhaps a coding error, numerical overflow in the logit transformation, or a problem with the propensity score truncation. In a locked analysis where you cannot inspect intermediate results, having an automatic self-check is invaluable.</span>
<span id="cb160-689"><a href="#cb160-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-690"><a href="#cb160-690" aria-hidden="true" tabindex="-1"></a>**What "approximately zero" means in practice:** Machine precision means you will see values like 1e-15 to 1e-8. Values larger than 1e-4 warrant investigation. Values larger than 1e-2 indicate a serious problem.</span>
<span id="cb160-691"><a href="#cb160-691" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-692"><a href="#cb160-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-693"><a href="#cb160-693" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-694"><a href="#cb160-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-695"><a href="#cb160-695" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.4 Step 4: Secondary Estimators (for comparison)</span></span>
<span id="cb160-696"><a href="#cb160-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-697"><a href="#cb160-697" aria-hidden="true" tabindex="-1"></a>The SAP pre-specifies secondary estimators so that the primary TMLE result can be compared for consistency. If all three estimators agree, this strengthens confidence in the result. If they disagree, the TMLE estimate is preferred due to its double robustness, but the discrepancy is documented.</span>
<span id="cb160-698"><a href="#cb160-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-699"><a href="#cb160-699" aria-hidden="true" tabindex="-1"></a><span class="fu">### G-computation</span></span>
<span id="cb160-700"><a href="#cb160-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-703"><a href="#cb160-703" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-704"><a href="#cb160-704" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-705"><a href="#cb160-705" aria-hidden="true" tabindex="-1"></a><span class="co"># SECONDARY ANALYSIS 1: G-computation</span></span>
<span id="cb160-706"><a href="#cb160-706" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 6.2</span></span>
<span id="cb160-707"><a href="#cb160-707" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-708"><a href="#cb160-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-709"><a href="#cb160-709" aria-hidden="true" tabindex="-1"></a>gcomp_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_init)</span>
<span id="cb160-710"><a href="#cb160-710" aria-hidden="true" tabindex="-1"></a>gcomp_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_init)</span>
<span id="cb160-711"><a href="#cb160-711" aria-hidden="true" tabindex="-1"></a>gcomp_ate   <span class="ot">&lt;-</span> gcomp_risk1 <span class="sc">-</span> gcomp_risk0</span>
<span id="cb160-712"><a href="#cb160-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-713"><a href="#cb160-713" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-computation ATE:"</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-714"><a href="#cb160-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-715"><a href="#cb160-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-716"><a href="#cb160-716" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPTW</span></span>
<span id="cb160-717"><a href="#cb160-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-720"><a href="#cb160-720" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-721"><a href="#cb160-721" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-722"><a href="#cb160-722" aria-hidden="true" tabindex="-1"></a><span class="co"># SECONDARY ANALYSIS 2: IPTW with stabilized weights</span></span>
<span id="cb160-723"><a href="#cb160-723" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 6.3</span></span>
<span id="cb160-724"><a href="#cb160-724" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-725"><a href="#cb160-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-726"><a href="#cb160-726" aria-hidden="true" tabindex="-1"></a>risk1_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb160-727"><a href="#cb160-727" aria-hidden="true" tabindex="-1"></a>risk0_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb160-728"><a href="#cb160-728" aria-hidden="true" tabindex="-1"></a>iptw_ate   <span class="ot">&lt;-</span> risk1_iptw <span class="sc">-</span> risk0_iptw</span>
<span id="cb160-729"><a href="#cb160-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-730"><a href="#cb160-730" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE:"</span>, <span class="fu">round</span>(iptw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-731"><a href="#cb160-731" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-732"><a href="#cb160-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-733"><a href="#cb160-733" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparison table</span></span>
<span id="cb160-734"><a href="#cb160-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-737"><a href="#cb160-737" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-738"><a href="#cb160-738" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-739"><a href="#cb160-739" aria-hidden="true" tabindex="-1"></a><span class="co"># RESULTS COMPARISON TABLE</span></span>
<span id="cb160-740"><a href="#cb160-740" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 7</span></span>
<span id="cb160-741"><a href="#cb160-741" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-742"><a href="#cb160-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-743"><a href="#cb160-743" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb160-744"><a href="#cb160-744" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimator =</span> <span class="fu">c</span>(<span class="st">"Unadjusted"</span>, <span class="st">"G-computation"</span>, <span class="st">"IPTW"</span>, <span class="st">"TMLE"</span>),</span>
<span id="cb160-745"><a href="#cb160-745" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATE =</span> <span class="fu">round</span>(<span class="fu">c</span>(</span>
<span id="cb160-746"><a href="#cb160-746" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>]),</span>
<span id="cb160-747"><a href="#cb160-747" aria-hidden="true" tabindex="-1"></a>    gcomp_ate,</span>
<span id="cb160-748"><a href="#cb160-748" aria-hidden="true" tabindex="-1"></a>    iptw_ate,</span>
<span id="cb160-749"><a href="#cb160-749" aria-hidden="true" tabindex="-1"></a>    tmle_ate</span>
<span id="cb160-750"><a href="#cb160-750" aria-hidden="true" tabindex="-1"></a>  ), <span class="dv">4</span>),</span>
<span id="cb160-751"><a href="#cb160-751" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, tmle_se), <span class="dv">4</span>),</span>
<span id="cb160-752"><a href="#cb160-752" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_lower =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, tmle_ci[<span class="dv">1</span>]), <span class="dv">4</span>),</span>
<span id="cb160-753"><a href="#cb160-753" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_upper =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, tmle_ci[<span class="dv">2</span>]), <span class="dv">4</span>)</span>
<span id="cb160-754"><a href="#cb160-754" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-755"><a href="#cb160-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-756"><a href="#cb160-756" aria-hidden="true" tabindex="-1"></a>results</span>
<span id="cb160-757"><a href="#cb160-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-758"><a href="#cb160-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-759"><a href="#cb160-759" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-760"><a href="#cb160-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-761"><a href="#cb160-761" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.5 Step 5: Post-Estimation Diagnostics</span></span>
<span id="cb160-762"><a href="#cb160-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-763"><a href="#cb160-763" aria-hidden="true" tabindex="-1"></a><span class="fu">### Clever covariate distribution</span></span>
<span id="cb160-764"><a href="#cb160-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-767"><a href="#cb160-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-768"><a href="#cb160-768" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-769"><a href="#cb160-769" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 4: Clever covariate ranges</span></span>
<span id="cb160-770"><a href="#cb160-770" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.4</span></span>
<span id="cb160-771"><a href="#cb160-771" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-772"><a href="#cb160-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-773"><a href="#cb160-773" aria-hidden="true" tabindex="-1"></a>cc_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb160-774"><a href="#cb160-774" aria-hidden="true" tabindex="-1"></a>  <span class="at">H =</span> H_A,</span>
<span id="cb160-775"><a href="#cb160-775" aria-hidden="true" tabindex="-1"></a>  <span class="at">Treatment =</span> <span class="fu">factor</span>(dat<span class="sc">$</span>A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Opioid"</span>, <span class="st">"NSAID"</span>))</span>
<span id="cb160-776"><a href="#cb160-776" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-777"><a href="#cb160-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-778"><a href="#cb160-778" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(cc_df, <span class="fu">aes</span>(<span class="at">x =</span> H, <span class="at">fill =</span> Treatment)) <span class="sc">+</span></span>
<span id="cb160-779"><a href="#cb160-779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">60</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb160-780"><a href="#cb160-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-781"><a href="#cb160-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Clever covariate H(A, W)"</span>,</span>
<span id="cb160-782"><a href="#cb160-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb160-783"><a href="#cb160-783" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb160-784"><a href="#cb160-784" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 4: Clever Covariate Distribution"</span></span>
<span id="cb160-785"><a href="#cb160-785" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-786"><a href="#cb160-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb160-787"><a href="#cb160-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb160-788"><a href="#cb160-788" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-789"><a href="#cb160-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-790"><a href="#cb160-790" aria-hidden="true" tabindex="-1"></a><span class="fu">### Influence curve stability</span></span>
<span id="cb160-791"><a href="#cb160-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-794"><a href="#cb160-794" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-795"><a href="#cb160-795" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-796"><a href="#cb160-796" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 5: Influence curve distribution</span></span>
<span id="cb160-797"><a href="#cb160-797" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.5</span></span>
<span id="cb160-798"><a href="#cb160-798" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-799"><a href="#cb160-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-800"><a href="#cb160-800" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">eic =</span> eic), <span class="fu">aes</span>(<span class="at">x =</span> eic)) <span class="sc">+</span></span>
<span id="cb160-801"><a href="#cb160-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">60</span>, <span class="at">fill =</span> <span class="st">"#228833"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb160-802"><a href="#cb160-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb160-803"><a href="#cb160-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-804"><a href="#cb160-804" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Efficient influence curve value"</span>,</span>
<span id="cb160-805"><a href="#cb160-805" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb160-806"><a href="#cb160-806" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 5: EIC Distribution"</span></span>
<span id="cb160-807"><a href="#cb160-807" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-808"><a href="#cb160-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb160-809"><a href="#cb160-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-810"><a href="#cb160-810" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-811"><a href="#cb160-811" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(eic)</span>
<span id="cb160-812"><a href="#cb160-812" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 5 most influential observations:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-813"><a href="#cb160-813" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">sort</span>(<span class="fu">abs</span>(eic), <span class="at">decreasing =</span> <span class="cn">TRUE</span>), <span class="dv">5</span>)</span>
<span id="cb160-814"><a href="#cb160-814" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-815"><a href="#cb160-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-816"><a href="#cb160-816" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predicted risk distribution</span></span>
<span id="cb160-817"><a href="#cb160-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-820"><a href="#cb160-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-821"><a href="#cb160-821" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-822"><a href="#cb160-822" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 6: Predicted outcome distributions</span></span>
<span id="cb160-823"><a href="#cb160-823" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 5.6</span></span>
<span id="cb160-824"><a href="#cb160-824" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-825"><a href="#cb160-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-826"><a href="#cb160-826" aria-hidden="true" tabindex="-1"></a>pred_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb160-827"><a href="#cb160-827" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q1_star =</span> Q1_star,</span>
<span id="cb160-828"><a href="#cb160-828" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q0_star =</span> Q0_star,</span>
<span id="cb160-829"><a href="#cb160-829" aria-hidden="true" tabindex="-1"></a>  <span class="at">diff =</span> Q1_star <span class="sc">-</span> Q0_star</span>
<span id="cb160-830"><a href="#cb160-830" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-831"><a href="#cb160-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-832"><a href="#cb160-832" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pred_df, <span class="fu">aes</span>(<span class="at">x =</span> diff)) <span class="sc">+</span></span>
<span id="cb160-833"><a href="#cb160-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#CC6677"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb160-834"><a href="#cb160-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(pred_df<span class="sc">$</span>diff), <span class="at">linetype =</span> <span class="st">"solid"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb160-835"><a href="#cb160-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_ate, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb160-836"><a href="#cb160-836" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-837"><a href="#cb160-837" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Individual-level risk difference (Q1* - Q0*)"</span>,</span>
<span id="cb160-838"><a href="#cb160-838" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb160-839"><a href="#cb160-839" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic 6: Distribution of Individual Treatment Effects"</span>,</span>
<span id="cb160-840"><a href="#cb160-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Black line = TMLE ATE; Red dashed = True ATE"</span></span>
<span id="cb160-841"><a href="#cb160-841" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-842"><a href="#cb160-842" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb160-843"><a href="#cb160-843" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-844"><a href="#cb160-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-845"><a href="#cb160-845" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-846"><a href="#cb160-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-847"><a href="#cb160-847" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. Super Learner Integration</span></span>
<span id="cb160-848"><a href="#cb160-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-849"><a href="#cb160-849" aria-hidden="true" tabindex="-1"></a>In the by-hand implementation above, we used parametric logistic regression for both nuisance models. In a real clean-room analysis, the SAP would specify a Super Learner library. This section shows how that integration works conceptually.</span>
<span id="cb160-850"><a href="#cb160-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-851"><a href="#cb160-851" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb160-852"><a href="#cb160-852" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Super Learner Eliminates Analyst Discretion</span></span>
<span id="cb160-853"><a href="#cb160-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-854"><a href="#cb160-854" aria-hidden="true" tabindex="-1"></a>This is the key insight that makes TMLE and Super Learner a natural fit for the clean-room framework:</span>
<span id="cb160-855"><a href="#cb160-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-856"><a href="#cb160-856" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**No analyst discretion:** The learner library is pre-specified in the SAP. Cross-validation --- not the analyst --- selects the optimal weighted combination. The analyst never chooses "which model fits better."</span>
<span id="cb160-857"><a href="#cb160-857" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Reproducible:** Given the same data, seed, and library, Super Learner always produces the same result. There is no subjectivity in the model selection step.</span>
<span id="cb160-858"><a href="#cb160-858" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Flexible without overfitting:** Multiple candidate models are considered --- including flexible machine learning algorithms --- but the cross-validation oracle inequality ensures the ensemble performs nearly as well as the best single learner. This reduces the risk of misspecification without introducing analyst degrees of freedom.</span>
<span id="cb160-859"><a href="#cb160-859" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Auditable:** The cross-validated risk of each learner and its weight in the ensemble are logged automatically. A reviewer can see exactly which models contributed and how much, providing full transparency into the "black box."</span>
<span id="cb160-860"><a href="#cb160-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-861"><a href="#cb160-861" aria-hidden="true" tabindex="-1"></a>In a traditional analysis, the analyst might try logistic regression, see poor fit, try adding interactions, check AIC, try a different link function --- each step introducing data-dependent decisions. Super Learner replaces this entire iterative process with a single, pre-specified, cross-validated procedure.</span>
<span id="cb160-862"><a href="#cb160-862" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-863"><a href="#cb160-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-864"><a href="#cb160-864" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pre-specified Super Learner library (from SAP)</span></span>
<span id="cb160-865"><a href="#cb160-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-866"><a href="#cb160-866" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb160-867"><a href="#cb160-867" aria-hidden="true" tabindex="-1"></a><span class="in"># ============================================================</span></span>
<span id="cb160-868"><a href="#cb160-868" aria-hidden="true" tabindex="-1"></a><span class="in"># SAP Section 4.3: Super Learner specification</span></span>
<span id="cb160-869"><a href="#cb160-869" aria-hidden="true" tabindex="-1"></a><span class="in"># ============================================================</span></span>
<span id="cb160-870"><a href="#cb160-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-871"><a href="#cb160-871" aria-hidden="true" tabindex="-1"></a><span class="in">library(SuperLearner)</span></span>
<span id="cb160-872"><a href="#cb160-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-873"><a href="#cb160-873" aria-hidden="true" tabindex="-1"></a><span class="in"># Pre-specified learner library (locked in SAP)</span></span>
<span id="cb160-874"><a href="#cb160-874" aria-hidden="true" tabindex="-1"></a><span class="in">SL_library &lt;- c(</span></span>
<span id="cb160-875"><a href="#cb160-875" aria-hidden="true" tabindex="-1"></a><span class="in">  "SL.glm",               # logistic regression</span></span>
<span id="cb160-876"><a href="#cb160-876" aria-hidden="true" tabindex="-1"></a><span class="in">  "SL.glm.interaction",   # logistic with interactions</span></span>
<span id="cb160-877"><a href="#cb160-877" aria-hidden="true" tabindex="-1"></a><span class="in">  "SL.step",              # stepwise selection</span></span>
<span id="cb160-878"><a href="#cb160-878" aria-hidden="true" tabindex="-1"></a><span class="in">  "SL.mean"               # intercept-only (benchmark)</span></span>
<span id="cb160-879"><a href="#cb160-879" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb160-880"><a href="#cb160-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-881"><a href="#cb160-881" aria-hidden="true" tabindex="-1"></a><span class="in"># NOTE: In a webR environment, compiled learners like SL.ranger</span></span>
<span id="cb160-882"><a href="#cb160-882" aria-hidden="true" tabindex="-1"></a><span class="in"># or SL.xgboost may not be available. The library above uses</span></span>
<span id="cb160-883"><a href="#cb160-883" aria-hidden="true" tabindex="-1"></a><span class="in"># only R-native learners.</span></span>
<span id="cb160-884"><a href="#cb160-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-885"><a href="#cb160-885" aria-hidden="true" tabindex="-1"></a><span class="in"># Outcome model via Super Learner</span></span>
<span id="cb160-886"><a href="#cb160-886" aria-hidden="true" tabindex="-1"></a><span class="in">W_matrix &lt;- dat %&gt;% select(age, male, ckd, diabetes, hypertension,</span></span>
<span id="cb160-887"><a href="#cb160-887" aria-hidden="true" tabindex="-1"></a><span class="in">                            prior_nsaid, prior_opioid, ace_arb,</span></span>
<span id="cb160-888"><a href="#cb160-888" aria-hidden="true" tabindex="-1"></a><span class="in">                            n_rx, n_visits)</span></span>
<span id="cb160-889"><a href="#cb160-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-890"><a href="#cb160-890" aria-hidden="true" tabindex="-1"></a><span class="in">Q_SL &lt;- SuperLearner(</span></span>
<span id="cb160-891"><a href="#cb160-891" aria-hidden="true" tabindex="-1"></a><span class="in">  Y = dat$Y,</span></span>
<span id="cb160-892"><a href="#cb160-892" aria-hidden="true" tabindex="-1"></a><span class="in">  X = cbind(A = dat$A, W_matrix),</span></span>
<span id="cb160-893"><a href="#cb160-893" aria-hidden="true" tabindex="-1"></a><span class="in">  family = binomial(),</span></span>
<span id="cb160-894"><a href="#cb160-894" aria-hidden="true" tabindex="-1"></a><span class="in">  SL.library = SL_library,</span></span>
<span id="cb160-895"><a href="#cb160-895" aria-hidden="true" tabindex="-1"></a><span class="in">  cvControl = list(V = 5)</span></span>
<span id="cb160-896"><a href="#cb160-896" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb160-897"><a href="#cb160-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-898"><a href="#cb160-898" aria-hidden="true" tabindex="-1"></a><span class="in"># Treatment model via Super Learner</span></span>
<span id="cb160-899"><a href="#cb160-899" aria-hidden="true" tabindex="-1"></a><span class="in">g_SL &lt;- SuperLearner(</span></span>
<span id="cb160-900"><a href="#cb160-900" aria-hidden="true" tabindex="-1"></a><span class="in">  Y = dat$A,</span></span>
<span id="cb160-901"><a href="#cb160-901" aria-hidden="true" tabindex="-1"></a><span class="in">  X = W_matrix,</span></span>
<span id="cb160-902"><a href="#cb160-902" aria-hidden="true" tabindex="-1"></a><span class="in">  family = binomial(),</span></span>
<span id="cb160-903"><a href="#cb160-903" aria-hidden="true" tabindex="-1"></a><span class="in">  SL.library = SL_library,</span></span>
<span id="cb160-904"><a href="#cb160-904" aria-hidden="true" tabindex="-1"></a><span class="in">  cvControl = list(V = 5)</span></span>
<span id="cb160-905"><a href="#cb160-905" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb160-906"><a href="#cb160-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-907"><a href="#cb160-907" aria-hidden="true" tabindex="-1"></a><span class="in"># Inspect cross-validated learner weights</span></span>
<span id="cb160-908"><a href="#cb160-908" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Outcome model weights:\n")</span></span>
<span id="cb160-909"><a href="#cb160-909" aria-hidden="true" tabindex="-1"></a><span class="in">Q_SL$coef</span></span>
<span id="cb160-910"><a href="#cb160-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-911"><a href="#cb160-911" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\nTreatment model weights:\n")</span></span>
<span id="cb160-912"><a href="#cb160-912" aria-hidden="true" tabindex="-1"></a><span class="in">g_SL$coef</span></span>
<span id="cb160-913"><a href="#cb160-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-914"><a href="#cb160-914" aria-hidden="true" tabindex="-1"></a><span class="in"># These weights are part of the audit trail — they document which</span></span>
<span id="cb160-915"><a href="#cb160-915" aria-hidden="true" tabindex="-1"></a><span class="in"># learners contributed most without analyst discretion</span></span>
<span id="cb160-916"><a href="#cb160-916" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-917"><a href="#cb160-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-918"><a href="#cb160-918" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using Super Learner predictions in TMLE</span></span>
<span id="cb160-919"><a href="#cb160-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-920"><a href="#cb160-920" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb160-921"><a href="#cb160-921" aria-hidden="true" tabindex="-1"></a><span class="in"># Predictions for TMLE</span></span>
<span id="cb160-922"><a href="#cb160-922" aria-hidden="true" tabindex="-1"></a><span class="in">Q1_SL &lt;- predict(Q_SL, newdata = cbind(A = 1, W_matrix))$pred</span></span>
<span id="cb160-923"><a href="#cb160-923" aria-hidden="true" tabindex="-1"></a><span class="in">Q0_SL &lt;- predict(Q_SL, newdata = cbind(A = 0, W_matrix))$pred</span></span>
<span id="cb160-924"><a href="#cb160-924" aria-hidden="true" tabindex="-1"></a><span class="in">QA_SL &lt;- predict(Q_SL, newdata = cbind(A = dat$A, W_matrix))$pred</span></span>
<span id="cb160-925"><a href="#cb160-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-926"><a href="#cb160-926" aria-hidden="true" tabindex="-1"></a><span class="in">ps_SL &lt;- predict(g_SL, newdata = W_matrix)$pred</span></span>
<span id="cb160-927"><a href="#cb160-927" aria-hidden="true" tabindex="-1"></a><span class="in">ps_SL &lt;- pmax(0.025, pmin(0.975, ps_SL))</span></span>
<span id="cb160-928"><a href="#cb160-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-929"><a href="#cb160-929" aria-hidden="true" tabindex="-1"></a><span class="in"># Then proceed with clever covariate, fluctuation, and inference</span></span>
<span id="cb160-930"><a href="#cb160-930" aria-hidden="true" tabindex="-1"></a><span class="in"># exactly as in the by-hand implementation above</span></span>
<span id="cb160-931"><a href="#cb160-931" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-932"><a href="#cb160-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-933"><a href="#cb160-933" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-934"><a href="#cb160-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-935"><a href="#cb160-935" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. The Audit Trail</span></span>
<span id="cb160-936"><a href="#cb160-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-937"><a href="#cb160-937" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb160-938"><a href="#cb160-938" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Audit Trail --- Every Step Is Documented</span></span>
<span id="cb160-939"><a href="#cb160-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-940"><a href="#cb160-940" aria-hidden="true" tabindex="-1"></a>A clean-room analysis must maintain a complete record of every computational step. The audit trail is not optional --- it is the mechanism by which reviewers, regulators, and future analysts can verify that the pre-specified protocol was followed exactly.</span>
<span id="cb160-941"><a href="#cb160-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-942"><a href="#cb160-942" aria-hidden="true" tabindex="-1"></a>The structure below captures the key elements: protocol version, software environment, diagnostics summary, and all results. In a real analysis, this would be supplemented by the version-controlled git commit hash of the analysis code, the SHA-256 hash of the input dataset, and a log of all computational warnings.</span>
<span id="cb160-943"><a href="#cb160-943" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-944"><a href="#cb160-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-947"><a href="#cb160-947" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-948"><a href="#cb160-948" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-949"><a href="#cb160-949" aria-hidden="true" tabindex="-1"></a><span class="co"># AUDIT TRAIL</span></span>
<span id="cb160-950"><a href="#cb160-950" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-951"><a href="#cb160-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-952"><a href="#cb160-952" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb160-953"><a href="#cb160-953" aria-hidden="true" tabindex="-1"></a>  <span class="at">protocol_version =</span> <span class="st">"v1.0"</span>,</span>
<span id="cb160-954"><a href="#cb160-954" aria-hidden="true" tabindex="-1"></a>  <span class="at">sap_version =</span> <span class="st">"v1.0"</span>,</span>
<span id="cb160-955"><a href="#cb160-955" aria-hidden="true" tabindex="-1"></a>  <span class="at">analysis_date =</span> <span class="fu">Sys.Date</span>(),</span>
<span id="cb160-956"><a href="#cb160-956" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_version =</span> R.version.string,</span>
<span id="cb160-957"><a href="#cb160-957" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">20260101</span>,</span>
<span id="cb160-958"><a href="#cb160-958" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> n,</span>
<span id="cb160-959"><a href="#cb160-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-960"><a href="#cb160-960" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diagnostics summary</span></span>
<span id="cb160-961"><a href="#cb160-961" aria-hidden="true" tabindex="-1"></a>  <span class="at">diagnostics =</span> <span class="fu">list</span>(</span>
<span id="cb160-962"><a href="#cb160-962" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps_range =</span> <span class="fu">round</span>(<span class="fu">range</span>(dat<span class="sc">$</span>ps), <span class="dv">4</span>),</span>
<span id="cb160-963"><a href="#cb160-963" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps_truncation =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>),</span>
<span id="cb160-964"><a href="#cb160-964" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_smd_unadjusted =</span> <span class="fu">round</span>(<span class="fu">max</span>(balance_df<span class="sc">$</span>Unadjusted), <span class="dv">3</span>),</span>
<span id="cb160-965"><a href="#cb160-965" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_smd_weighted =</span> <span class="fu">round</span>(<span class="fu">max</span>(balance_df<span class="sc">$</span>Weighted), <span class="dv">3</span>),</span>
<span id="cb160-966"><a href="#cb160-966" aria-hidden="true" tabindex="-1"></a>    <span class="at">smd_threshold =</span> <span class="fl">0.1</span>,</span>
<span id="cb160-967"><a href="#cb160-967" aria-hidden="true" tabindex="-1"></a>    <span class="at">balance_achieved =</span> <span class="fu">all</span>(balance_df<span class="sc">$</span>Weighted <span class="sc">&lt;</span> <span class="fl">0.1</span>),</span>
<span id="cb160-968"><a href="#cb160-968" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_weight =</span> <span class="fu">round</span>(<span class="fu">max</span>(dat<span class="sc">$</span>sw), <span class="dv">2</span>),</span>
<span id="cb160-969"><a href="#cb160-969" aria-hidden="true" tabindex="-1"></a>    <span class="at">eic_mean =</span> <span class="fu">round</span>(<span class="fu">mean</span>(eic), <span class="dv">8</span>)</span>
<span id="cb160-970"><a href="#cb160-970" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb160-971"><a href="#cb160-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-972"><a href="#cb160-972" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Primary result</span></span>
<span id="cb160-973"><a href="#cb160-973" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_result =</span> <span class="fu">list</span>(</span>
<span id="cb160-974"><a href="#cb160-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimator =</span> <span class="st">"TMLE"</span>,</span>
<span id="cb160-975"><a href="#cb160-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">ate =</span> <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>),</span>
<span id="cb160-976"><a href="#cb160-976" aria-hidden="true" tabindex="-1"></a>    <span class="at">se =</span> <span class="fu">round</span>(tmle_se, <span class="dv">4</span>),</span>
<span id="cb160-977"><a href="#cb160-977" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_95 =</span> <span class="fu">round</span>(tmle_ci, <span class="dv">4</span>),</span>
<span id="cb160-978"><a href="#cb160-978" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">round</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(tmle_ate <span class="sc">/</span> tmle_se)), <span class="dv">4</span>)</span>
<span id="cb160-979"><a href="#cb160-979" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb160-980"><a href="#cb160-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-981"><a href="#cb160-981" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Secondary results</span></span>
<span id="cb160-982"><a href="#cb160-982" aria-hidden="true" tabindex="-1"></a>  <span class="at">secondary_results =</span> <span class="fu">list</span>(</span>
<span id="cb160-983"><a href="#cb160-983" aria-hidden="true" tabindex="-1"></a>    <span class="at">gcomp_ate =</span> <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>),</span>
<span id="cb160-984"><a href="#cb160-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">iptw_ate =</span> <span class="fu">round</span>(iptw_ate, <span class="dv">4</span>)</span>
<span id="cb160-985"><a href="#cb160-985" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-986"><a href="#cb160-986" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-987"><a href="#cb160-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-988"><a href="#cb160-988" aria-hidden="true" tabindex="-1"></a><span class="co"># Print audit summary</span></span>
<span id="cb160-989"><a href="#cb160-989" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== AUDIT TRAIL ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-990"><a href="#cb160-990" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Protocol:"</span>, audit<span class="sc">$</span>protocol_version, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-991"><a href="#cb160-991" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date:"</span>, <span class="fu">as.character</span>(audit<span class="sc">$</span>analysis_date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-992"><a href="#cb160-992" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"R:"</span>, audit<span class="sc">$</span>r_version, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-993"><a href="#cb160-993" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Seed:"</span>, audit<span class="sc">$</span>seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-994"><a href="#cb160-994" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"N:"</span>, audit<span class="sc">$</span>sample_size, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-995"><a href="#cb160-995" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Diagnostics ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-996"><a href="#cb160-996" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"PS range:"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>ps_range, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-997"><a href="#cb160-997" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Max SMD (weighted):"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>max_smd_weighted, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-998"><a href="#cb160-998" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Balance achieved:"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>balance_achieved, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-999"><a href="#cb160-999" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, audit<span class="sc">$</span>diagnostics<span class="sc">$</span>eic_mean, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1000"><a href="#cb160-1000" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Primary Result ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1001"><a href="#cb160-1001" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"ATE:"</span>, audit<span class="sc">$</span>primary_result<span class="sc">$</span>ate, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1002"><a href="#cb160-1002" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:"</span>, audit<span class="sc">$</span>primary_result<span class="sc">$</span>ci_95, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1003"><a href="#cb160-1003" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"p-value:"</span>, audit<span class="sc">$</span>primary_result<span class="sc">$</span>p_value, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1004"><a href="#cb160-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-1005"><a href="#cb160-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1006"><a href="#cb160-1006" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-1007"><a href="#cb160-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1008"><a href="#cb160-1008" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Sensitivity Analysis: E-value</span></span>
<span id="cb160-1009"><a href="#cb160-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1010"><a href="#cb160-1010" aria-hidden="true" tabindex="-1"></a>The E-value is our quantitative answer to the question: "How strong would unmeasured confounding need to be to explain away this result?" This is always the final step in a causal analysis, because no statistical method --- not even TMLE --- can address unmeasured confounding from data alone.</span>
<span id="cb160-1011"><a href="#cb160-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1012"><a href="#cb160-1012" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb160-1013"><a href="#cb160-1013" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting the E-value</span></span>
<span id="cb160-1014"><a href="#cb160-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1015"><a href="#cb160-1015" aria-hidden="true" tabindex="-1"></a>The E-value quantifies the minimum strength of association that an unmeasured confounder would need to have with **both** the treatment and the outcome (on the risk ratio scale, conditional on measured covariates) to fully explain away the observed causal effect.</span>
<span id="cb160-1016"><a href="#cb160-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1017"><a href="#cb160-1017" aria-hidden="true" tabindex="-1"></a>**How to read it:**</span>
<span id="cb160-1018"><a href="#cb160-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1019"><a href="#cb160-1019" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>An E-value of 1.0 means the result is already null --- no unmeasured confounding is needed to explain it away.</span>
<span id="cb160-1020"><a href="#cb160-1020" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Larger E-values indicate greater robustness. An E-value of 3.0 means an unmeasured confounder would need to triple the risk of both treatment and outcome (beyond what measured confounders explain) to nullify the finding.</span>
<span id="cb160-1021"><a href="#cb160-1021" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The E-value for the confidence interval bound closest to the null tells you how strong confounding would need to be to make the result statistically non-significant.</span>
<span id="cb160-1022"><a href="#cb160-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1023"><a href="#cb160-1023" aria-hidden="true" tabindex="-1"></a>**In the NSAID/AKI context:** Consider what unmeasured confounders might exist --- OTC NSAID use (not captured in claims), frailty, kidney function trajectory. Would any of these plausibly have the association strength indicated by the E-value? If the E-value is large relative to known risk factors, the result is more credible.</span>
<span id="cb160-1024"><a href="#cb160-1024" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-1025"><a href="#cb160-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1028"><a href="#cb160-1028" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-1029"><a href="#cb160-1029" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-1030"><a href="#cb160-1030" aria-hidden="true" tabindex="-1"></a><span class="co"># SENSITIVITY ANALYSIS: E-value</span></span>
<span id="cb160-1031"><a href="#cb160-1031" aria-hidden="true" tabindex="-1"></a><span class="co"># SAP Section 8.1</span></span>
<span id="cb160-1032"><a href="#cb160-1032" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb160-1033"><a href="#cb160-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1034"><a href="#cb160-1034" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert risk difference to risk ratio for E-value computation</span></span>
<span id="cb160-1035"><a href="#cb160-1035" aria-hidden="true" tabindex="-1"></a>risk_ratio <span class="ot">&lt;-</span> tmle_risk1 <span class="sc">/</span> tmle_risk0</span>
<span id="cb160-1036"><a href="#cb160-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1037"><a href="#cb160-1037" aria-hidden="true" tabindex="-1"></a><span class="co"># E-value formula for risk ratios</span></span>
<span id="cb160-1038"><a href="#cb160-1038" aria-hidden="true" tabindex="-1"></a>compute_evalue <span class="ot">&lt;-</span> <span class="cf">function</span>(rr) {</span>
<span id="cb160-1039"><a href="#cb160-1039" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (rr <span class="sc">&gt;=</span> <span class="dv">1</span>) {</span>
<span id="cb160-1040"><a href="#cb160-1040" aria-hidden="true" tabindex="-1"></a>    rr <span class="sc">+</span> <span class="fu">sqrt</span>(rr <span class="sc">*</span> (rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb160-1041"><a href="#cb160-1041" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb160-1042"><a href="#cb160-1042" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">/</span>rr <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>rr <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb160-1043"><a href="#cb160-1043" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-1044"><a href="#cb160-1044" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-1045"><a href="#cb160-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1046"><a href="#cb160-1046" aria-hidden="true" tabindex="-1"></a>evalue_point <span class="ot">&lt;-</span> <span class="fu">compute_evalue</span>(risk_ratio)</span>
<span id="cb160-1047"><a href="#cb160-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1048"><a href="#cb160-1048" aria-hidden="true" tabindex="-1"></a><span class="co"># E-value for confidence interval bound closest to null</span></span>
<span id="cb160-1049"><a href="#cb160-1049" aria-hidden="true" tabindex="-1"></a>rr_ci_lower <span class="ot">&lt;-</span> (tmle_risk0 <span class="sc">+</span> tmle_ci[<span class="dv">1</span>]) <span class="sc">/</span> tmle_risk0  <span class="co"># approximate</span></span>
<span id="cb160-1050"><a href="#cb160-1050" aria-hidden="true" tabindex="-1"></a>evalue_ci <span class="ot">&lt;-</span> <span class="cf">if</span>(rr_ci_lower <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="fu">compute_evalue</span>(rr_ci_lower) <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb160-1051"><a href="#cb160-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1052"><a href="#cb160-1052" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Risk ratio (NSAIDs vs opioids):"</span>, <span class="fu">round</span>(risk_ratio, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1053"><a href="#cb160-1053" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"E-value (point estimate):"</span>, <span class="fu">round</span>(evalue_point, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1054"><a href="#cb160-1054" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"E-value (CI bound):"</span>, <span class="fu">round</span>(evalue_ci, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1055"><a href="#cb160-1055" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Interpretation: An unmeasured confounder would need an association</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1056"><a href="#cb160-1056" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"of at least RR ="</span>, <span class="fu">round</span>(evalue_point, <span class="dv">2</span>), <span class="st">"with both treatment and outcome</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1057"><a href="#cb160-1057" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(above and beyond measured confounders) to explain away the</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1058"><a href="#cb160-1058" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"observed effect.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1059"><a href="#cb160-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-1060"><a href="#cb160-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1061"><a href="#cb160-1061" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-1062"><a href="#cb160-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1063"><a href="#cb160-1063" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Interpretation in Regulatory Context</span></span>
<span id="cb160-1064"><a href="#cb160-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1065"><a href="#cb160-1065" aria-hidden="true" tabindex="-1"></a><span class="fu">## Results summary</span></span>
<span id="cb160-1066"><a href="#cb160-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1069"><a href="#cb160-1069" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-1070"><a href="#cb160-1070" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== REGULATORY SUMMARY ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb160-1071"><a href="#cb160-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Study: Post-marketing safety analysis of NSAIDs vs opioids for AKI risk</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1072"><a href="#cb160-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Design: Active comparator, new user, cohort study</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1073"><a href="#cb160-1073" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method: Pre-specified TMLE with parametric nuisance models</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb160-1074"><a href="#cb160-1074" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Primary endpoint: 90-day acute kidney injury</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1075"><a href="#cb160-1075" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NSAIDs (n ="</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"): estimated 90-day AKI risk ="</span>,</span>
<span id="cb160-1076"><a href="#cb160-1076" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(tmle_risk1 <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1077"><a href="#cb160-1077" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Opioids (n ="</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"): estimated 90-day AKI risk ="</span>,</span>
<span id="cb160-1078"><a href="#cb160-1078" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(tmle_risk0 <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1079"><a href="#cb160-1079" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Risk difference:"</span>, <span class="fu">round</span>(tmle_ate <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"percentage points</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1080"><a href="#cb160-1080" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>), <span class="st">"to"</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb160-1081"><a href="#cb160-1081" aria-hidden="true" tabindex="-1"></a>    <span class="st">"percentage points</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb160-1082"><a href="#cb160-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1083"><a href="#cb160-1083" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (tmle_ci[<span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-1084"><a href="#cb160-1084" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Conclusion: Statistically significant increase in AKI risk with NSAIDs.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1085"><a href="#cb160-1085" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The results support updating prescribing guidelines to include AKI risk</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1086"><a href="#cb160-1086" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"assessment, particularly for patients with pre-existing CKD.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1087"><a href="#cb160-1087" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (tmle_ci[<span class="dv">2</span>] <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-1088"><a href="#cb160-1088" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Conclusion: Statistically significant decrease in AKI risk with NSAIDs.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1089"><a href="#cb160-1089" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb160-1090"><a href="#cb160-1090" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Conclusion: The risk difference is not statistically significant.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1091"><a href="#cb160-1091" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Continued monitoring is recommended.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1092"><a href="#cb160-1092" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-1093"><a href="#cb160-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-1094"><a href="#cb160-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1095"><a href="#cb160-1095" aria-hidden="true" tabindex="-1"></a><span class="fu">## How TMLE supports the regulatory decision</span></span>
<span id="cb160-1096"><a href="#cb160-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1097"><a href="#cb160-1097" aria-hidden="true" tabindex="-1"></a>| Regulatory concern | How TMLE addresses it |</span>
<span id="cb160-1098"><a href="#cb160-1098" aria-hidden="true" tabindex="-1"></a>|---|---|</span>
<span id="cb160-1099"><a href="#cb160-1099" aria-hidden="true" tabindex="-1"></a>| Pre-specification required | SAP locks the learner library, seed, and analysis code |</span>
<span id="cb160-1100"><a href="#cb160-1100" aria-hidden="true" tabindex="-1"></a>| Must be reproducible | Deterministic given data + seed + code |</span>
<span id="cb160-1101"><a href="#cb160-1101" aria-hidden="true" tabindex="-1"></a>| Model selection bias | Super Learner eliminates manual model selection |</span>
<span id="cb160-1102"><a href="#cb160-1102" aria-hidden="true" tabindex="-1"></a>| Robustness to misspecification | Double robustness protects against either nuisance model being wrong |</span>
<span id="cb160-1103"><a href="#cb160-1103" aria-hidden="true" tabindex="-1"></a>| Valid inference | Influence-curve standard errors do not require bootstrap |</span>
<span id="cb160-1104"><a href="#cb160-1104" aria-hidden="true" tabindex="-1"></a>| Auditable | Cross-validated learner weights, diagnostics, and the fluctuation parameter are all logged |</span>
<span id="cb160-1105"><a href="#cb160-1105" aria-hidden="true" tabindex="-1"></a>| Transparent | Every step (initial model, clever covariate, targeting, inference) has a clear purpose |</span>
<span id="cb160-1106"><a href="#cb160-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1107"><a href="#cb160-1107" aria-hidden="true" tabindex="-1"></a><span class="fu">## What assumptions are most fragile?</span></span>
<span id="cb160-1108"><a href="#cb160-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1109"><a href="#cb160-1109" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Unmeasured confounding:** OTC NSAID use is not captured in claims data. Frailty and functional status are poorly measured. The E-value provides a benchmark for how strong this confounding would need to be.</span>
<span id="cb160-1110"><a href="#cb160-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1111"><a href="#cb160-1111" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Positivity in CKD subgroups:** Patients with severe CKD are rarely prescribed NSAIDs. The propensity score overlap diagnostic should flag this. If violated, consider restricting to the subpopulation with adequate overlap or using stochastic interventions.</span>
<span id="cb160-1112"><a href="#cb160-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1113"><a href="#cb160-1113" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Outcome misclassification:** AKI may be under-coded in claims data. This affects interpretation but not the validity of the TMLE procedure.</span>
<span id="cb160-1114"><a href="#cb160-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1115"><a href="#cb160-1115" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-1116"><a href="#cb160-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1117"><a href="#cb160-1117" aria-hidden="true" tabindex="-1"></a><span class="fu"># 10. Distributed Data Extension</span></span>
<span id="cb160-1118"><a href="#cb160-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1119"><a href="#cb160-1119" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb160-1120"><a href="#cb160-1120" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Meta-Analysis of Site-Level TMLE Estimates Works</span></span>
<span id="cb160-1121"><a href="#cb160-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1122"><a href="#cb160-1122" aria-hidden="true" tabindex="-1"></a>In true multi-site analyses (like the FDA Sentinel system), patient-level data cannot be shared across sites. The clean-room TMLE approach handles this naturally through a two-stage procedure:</span>
<span id="cb160-1123"><a href="#cb160-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1124"><a href="#cb160-1124" aria-hidden="true" tabindex="-1"></a>**Stage 1: Ship the locked code.** The coordinating center distributes the identical, version-controlled analysis code to each participating site. Each site runs the full TMLE pipeline --- propensity score estimation, diagnostics, targeting, inference --- on its own local data. Because the code is locked and the seed is fixed, the analysis is deterministic at each site.</span>
<span id="cb160-1125"><a href="#cb160-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1126"><a href="#cb160-1126" aria-hidden="true" tabindex="-1"></a>**Stage 2: Combine via meta-analysis.** Each site returns only summary statistics: the point estimate, standard error, and sample size. The coordinating center combines these using inverse-variance weighted meta-analysis. No patient-level data ever leaves any site.</span>
<span id="cb160-1127"><a href="#cb160-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1128"><a href="#cb160-1128" aria-hidden="true" tabindex="-1"></a>**Why this works theoretically:** Each site's TMLE estimate is asymptotically normal with an influence-curve-based standard error. Inverse-variance weighting of asymptotically normal estimators is itself asymptotically efficient. The approach is valid as long as the causal assumptions hold within each site and the estimand is the same across sites.</span>
<span id="cb160-1129"><a href="#cb160-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1130"><a href="#cb160-1130" aria-hidden="true" tabindex="-1"></a>**Practical advantages:**</span>
<span id="cb160-1131"><a href="#cb160-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1132"><a href="#cb160-1132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Privacy is preserved --- only aggregate statistics are shared</span>
<span id="cb160-1133"><a href="#cb160-1133" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each site can have a different covariate distribution (heterogeneity in confounders)</span>
<span id="cb160-1134"><a href="#cb160-1134" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The forest plot reveals cross-site consistency, which strengthens or weakens the overall conclusion</span>
<span id="cb160-1135"><a href="#cb160-1135" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If one site shows a qualitatively different result, this flags potential site-specific issues (different coding practices, different patient populations) for investigation</span>
<span id="cb160-1136"><a href="#cb160-1136" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb160-1137"><a href="#cb160-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1138"><a href="#cb160-1138" aria-hidden="true" tabindex="-1"></a><span class="fu">### Site-level TMLE</span></span>
<span id="cb160-1139"><a href="#cb160-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1140"><a href="#cb160-1140" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Ship the locked analysis code to each site</span>
<span id="cb160-1141"><a href="#cb160-1141" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Each site runs the TMLE pipeline on its local data</span>
<span id="cb160-1142"><a href="#cb160-1142" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Sites return summary statistics: point estimate, standard error, sample size</span>
<span id="cb160-1143"><a href="#cb160-1143" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>The coordinating center performs meta-analysis across sites</span>
<span id="cb160-1144"><a href="#cb160-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1145"><a href="#cb160-1145" aria-hidden="true" tabindex="-1"></a><span class="fu">### Meta-analysis of site-level TMLE estimates</span></span>
<span id="cb160-1146"><a href="#cb160-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1149"><a href="#cb160-1149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-1150"><a href="#cb160-1150" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulated multi-site results</span></span>
<span id="cb160-1151"><a href="#cb160-1151" aria-hidden="true" tabindex="-1"></a>site_results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb160-1152"><a href="#cb160-1152" aria-hidden="true" tabindex="-1"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="st">"Site A"</span>, <span class="st">"Site B"</span>, <span class="st">"Site C"</span>, <span class="st">"Site D"</span>),</span>
<span id="cb160-1153"><a href="#cb160-1153" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">3200</span>, <span class="dv">2100</span>, <span class="dv">1800</span>, <span class="dv">900</span>),</span>
<span id="cb160-1154"><a href="#cb160-1154" aria-hidden="true" tabindex="-1"></a>  <span class="at">ate =</span> <span class="fu">c</span>(<span class="fl">0.018</span>, <span class="fl">0.022</span>, <span class="fl">0.015</span>, <span class="fl">0.025</span>),</span>
<span id="cb160-1155"><a href="#cb160-1155" aria-hidden="true" tabindex="-1"></a>  <span class="at">se =</span> <span class="fu">c</span>(<span class="fl">0.006</span>, <span class="fl">0.008</span>, <span class="fl">0.009</span>, <span class="fl">0.014</span>)</span>
<span id="cb160-1156"><a href="#cb160-1156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-1157"><a href="#cb160-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1158"><a href="#cb160-1158" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse-variance weighted meta-analysis</span></span>
<span id="cb160-1159"><a href="#cb160-1159" aria-hidden="true" tabindex="-1"></a>site_results <span class="ot">&lt;-</span> site_results <span class="sc">%&gt;%</span></span>
<span id="cb160-1160"><a href="#cb160-1160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb160-1161"><a href="#cb160-1161" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> <span class="dv">1</span> <span class="sc">/</span> se<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb160-1162"><a href="#cb160-1162" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_ate =</span> w <span class="sc">*</span> ate</span>
<span id="cb160-1163"><a href="#cb160-1163" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-1164"><a href="#cb160-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1165"><a href="#cb160-1165" aria-hidden="true" tabindex="-1"></a>meta_ate <span class="ot">&lt;-</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>w_ate) <span class="sc">/</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>w)</span>
<span id="cb160-1166"><a href="#cb160-1166" aria-hidden="true" tabindex="-1"></a>meta_se  <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>w))</span>
<span id="cb160-1167"><a href="#cb160-1167" aria-hidden="true" tabindex="-1"></a>meta_ci  <span class="ot">&lt;-</span> meta_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> meta_se</span>
<span id="cb160-1168"><a href="#cb160-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1169"><a href="#cb160-1169" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Meta-analytic TMLE:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1170"><a href="#cb160-1170" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ATE:"</span>, <span class="fu">round</span>(meta_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1171"><a href="#cb160-1171" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SE:"</span>, <span class="fu">round</span>(meta_se, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1172"><a href="#cb160-1172" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  95% CI: ["</span>, <span class="fu">round</span>(meta_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(meta_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1173"><a href="#cb160-1173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-1174"><a href="#cb160-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1177"><a href="#cb160-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-1178"><a href="#cb160-1178" aria-hidden="true" tabindex="-1"></a><span class="co"># Forest plot of site-level results</span></span>
<span id="cb160-1179"><a href="#cb160-1179" aria-hidden="true" tabindex="-1"></a>site_results <span class="ot">&lt;-</span> site_results <span class="sc">%&gt;%</span></span>
<span id="cb160-1180"><a href="#cb160-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb160-1181"><a href="#cb160-1181" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_low =</span> ate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb160-1182"><a href="#cb160-1182" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_high =</span> ate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb160-1183"><a href="#cb160-1183" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-1184"><a href="#cb160-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1185"><a href="#cb160-1185" aria-hidden="true" tabindex="-1"></a>meta_row <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb160-1186"><a href="#cb160-1186" aria-hidden="true" tabindex="-1"></a>  <span class="at">site =</span> <span class="st">"Meta-analysis"</span>,</span>
<span id="cb160-1187"><a href="#cb160-1187" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="fu">sum</span>(site_results<span class="sc">$</span>n),</span>
<span id="cb160-1188"><a href="#cb160-1188" aria-hidden="true" tabindex="-1"></a>  <span class="at">ate =</span> meta_ate,</span>
<span id="cb160-1189"><a href="#cb160-1189" aria-hidden="true" tabindex="-1"></a>  <span class="at">se =</span> meta_se,</span>
<span id="cb160-1190"><a href="#cb160-1190" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_low =</span> meta_ci[<span class="dv">1</span>],</span>
<span id="cb160-1191"><a href="#cb160-1191" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_high =</span> meta_ci[<span class="dv">2</span>]</span>
<span id="cb160-1192"><a href="#cb160-1192" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-1193"><a href="#cb160-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1194"><a href="#cb160-1194" aria-hidden="true" tabindex="-1"></a>forest_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(site_results, meta_row) <span class="sc">%&gt;%</span></span>
<span id="cb160-1195"><a href="#cb160-1195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">factor</span>(site, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">c</span>(site_results<span class="sc">$</span>site, <span class="st">"Meta-analysis"</span>))))</span>
<span id="cb160-1196"><a href="#cb160-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1197"><a href="#cb160-1197" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(forest_df, <span class="fu">aes</span>(<span class="at">x =</span> ate, <span class="at">y =</span> site)) <span class="sc">+</span></span>
<span id="cb160-1198"><a href="#cb160-1198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> <span class="fu">ifelse</span>(site <span class="sc">==</span> <span class="st">"Meta-analysis"</span>, <span class="dv">4</span>, <span class="fl">2.5</span>)),</span>
<span id="cb160-1199"><a href="#cb160-1199" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="fu">ifelse</span>(forest_df<span class="sc">$</span>site <span class="sc">==</span> <span class="st">"Meta-analysis"</span>, <span class="dv">18</span>, <span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb160-1200"><a href="#cb160-1200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> ci_low, <span class="at">xmax =</span> ci_high), <span class="at">height =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb160-1201"><a href="#cb160-1201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb160-1202"><a href="#cb160-1202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-1203"><a href="#cb160-1203" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"ATE (Risk Difference)"</span>,</span>
<span id="cb160-1204"><a href="#cb160-1204" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb160-1205"><a href="#cb160-1205" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Forest Plot: Site-Level TMLE Estimates"</span></span>
<span id="cb160-1206"><a href="#cb160-1206" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-1207"><a href="#cb160-1207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb160-1208"><a href="#cb160-1208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb160-1209"><a href="#cb160-1209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-1210"><a href="#cb160-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1211"><a href="#cb160-1211" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-1212"><a href="#cb160-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1213"><a href="#cb160-1213" aria-hidden="true" tabindex="-1"></a><span class="fu"># Key Takeaways</span></span>
<span id="cb160-1214"><a href="#cb160-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1215"><a href="#cb160-1215" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**TMLE is naturally suited for clean-room regulatory analysis** because it replaces manual model selection with pre-specified machine learning (Super Learner) and cross-validation.</span>
<span id="cb160-1216"><a href="#cb160-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1217"><a href="#cb160-1217" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**The entire analysis pipeline can be pre-specified** in a Statistical Analysis Plan: learner library, seed, truncation bounds, diagnostic criteria, and decision rules --- all locked before data access.</span>
<span id="cb160-1218"><a href="#cb160-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1219"><a href="#cb160-1219" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Reproducibility is guaranteed** by deterministic seeds, version-controlled code, and the algorithmic nature of TMLE + Super Learner.</span>
<span id="cb160-1220"><a href="#cb160-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1221"><a href="#cb160-1221" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**The audit trail documents** propensity score overlap, covariate balance, weight distributions, the fluctuation parameter, influence curve behavior, and cross-validated learner weights --- providing full transparency.</span>
<span id="cb160-1222"><a href="#cb160-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1223"><a href="#cb160-1223" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Double robustness** protects the estimate even when one nuisance model is misspecified --- a critical property when the analyst cannot iterate on model specifications.</span>
<span id="cb160-1224"><a href="#cb160-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1225"><a href="#cb160-1225" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Influence-curve inference** provides valid standard errors without the computational burden of bootstrap, which matters in distributed settings where each site runs the analysis independently.</span>
<span id="cb160-1226"><a href="#cb160-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1227"><a href="#cb160-1227" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**The clean-room framework extends to distributed data networks** by shipping locked code to each site and combining site-level TMLE estimates via meta-analysis.</span>
<span id="cb160-1228"><a href="#cb160-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1229"><a href="#cb160-1229" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**Sensitivity analysis (E-value)** should always accompany the primary result to quantify robustness to unmeasured confounding --- the one assumption that no statistical method can address.</span>
<span id="cb160-1230"><a href="#cb160-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1233"><a href="#cb160-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-1234"><a href="#cb160-1234" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb160-1235"><a href="#cb160-1235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb160-1236"><a href="#cb160-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1237"><a href="#cb160-1237" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb160-1238"><a href="#cb160-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1239"><a href="#cb160-1239" aria-hidden="true" tabindex="-1"></a><span class="fu">## Software Implementation (R)</span></span>
<span id="cb160-1240"><a href="#cb160-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1241"><a href="#cb160-1241" aria-hidden="true" tabindex="-1"></a>This **clean-room analysis script** demonstrates a fully prespecified TMLE workflow: every modeling choice is locked before running, a fixed seed and library are declared, and the analysis is self-documenting. This is the discipline advocated in this chapter.</span>
<span id="cb160-1242"><a href="#cb160-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1243"><a href="#cb160-1243" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>All choices documented before execution: estimand, learner library, positivity bounds</span>
<span id="cb160-1244"><a href="#cb160-1244" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Uses a fixed Super Learner library (no data-peeking)</span>
<span id="cb160-1245"><a href="#cb160-1245" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Captures <span class="in">`sessionInfo()`</span> for full reproducibility</span>
<span id="cb160-1246"><a href="#cb160-1246" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Single <span class="in">`tmle()`</span> call with prespecified parameters</span>
<span id="cb160-1247"><a href="#cb160-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1250"><a href="#cb160-1250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb160-1251"><a href="#cb160-1251" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb160-1252"><a href="#cb160-1252" aria-hidden="true" tabindex="-1"></a><span class="do">## ═══════════════════════════════════════════════════════</span></span>
<span id="cb160-1253"><a href="#cb160-1253" aria-hidden="true" tabindex="-1"></a><span class="do">## CLEAN-ROOM TMLE ANALYSIS SCRIPT</span></span>
<span id="cb160-1254"><a href="#cb160-1254" aria-hidden="true" tabindex="-1"></a><span class="do">## Prespecified analysis — no data-adaptive choices below</span></span>
<span id="cb160-1255"><a href="#cb160-1255" aria-hidden="true" tabindex="-1"></a><span class="do">## ═══════════════════════════════════════════════════════</span></span>
<span id="cb160-1256"><a href="#cb160-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1257"><a href="#cb160-1257" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 0. Lock random seed and declare estimand ──</span></span>
<span id="cb160-1258"><a href="#cb160-1258" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb160-1259"><a href="#cb160-1259" aria-hidden="true" tabindex="-1"></a>ESTIMAND   <span class="ot">&lt;-</span> <span class="st">"ATE (risk difference)"</span></span>
<span id="cb160-1260"><a href="#cb160-1260" aria-hidden="true" tabindex="-1"></a>POPULATION <span class="ot">&lt;-</span> <span class="st">"Adults with simulated cardiovascular risk factors"</span></span>
<span id="cb160-1261"><a href="#cb160-1261" aria-hidden="true" tabindex="-1"></a>TREATMENT  <span class="ot">&lt;-</span> <span class="st">"Drug A vs Drug B"</span></span>
<span id="cb160-1262"><a href="#cb160-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1263"><a href="#cb160-1263" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 1. Prespecified learner libraries ──</span></span>
<span id="cb160-1264"><a href="#cb160-1264" aria-hidden="true" tabindex="-1"></a>Q_LIBRARY  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>)   <span class="co"># outcome model</span></span>
<span id="cb160-1265"><a href="#cb160-1265" aria-hidden="true" tabindex="-1"></a>G_LIBRARY  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>)   <span class="co"># treatment model</span></span>
<span id="cb160-1266"><a href="#cb160-1266" aria-hidden="true" tabindex="-1"></a>G_BOUNDS   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)  <span class="co"># positivity truncation</span></span>
<span id="cb160-1267"><a href="#cb160-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1268"><a href="#cb160-1268" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 2. Simulate data (replace with real data read) ──</span></span>
<span id="cb160-1269"><a href="#cb160-1269" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb160-1270"><a href="#cb160-1270" aria-hidden="true" tabindex="-1"></a>W1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb160-1271"><a href="#cb160-1271" aria-hidden="true" tabindex="-1"></a>W2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.35</span>)</span>
<span id="cb160-1272"><a href="#cb160-1272" aria-hidden="true" tabindex="-1"></a>W3 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">0.3</span> <span class="sc">*</span> W1)</span>
<span id="cb160-1273"><a href="#cb160-1273" aria-hidden="true" tabindex="-1"></a>A  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> W2))</span>
<span id="cb160-1274"><a href="#cb160-1274" aria-hidden="true" tabindex="-1"></a>Y  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.7</span> <span class="sc">*</span> W2 <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> W3))</span>
<span id="cb160-1275"><a href="#cb160-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1276"><a href="#cb160-1276" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">W1 =</span> W1, <span class="at">W2 =</span> W2, <span class="at">W3 =</span> W3)</span>
<span id="cb160-1277"><a href="#cb160-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1278"><a href="#cb160-1278" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 3. Run prespecified analysis ──</span></span>
<span id="cb160-1279"><a href="#cb160-1279" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"tmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb160-1280"><a href="#cb160-1280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tmle)</span>
<span id="cb160-1281"><a href="#cb160-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1282"><a href="#cb160-1282" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">tmle</span>(</span>
<span id="cb160-1283"><a href="#cb160-1283" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> Y, <span class="at">A =</span> A, <span class="at">W =</span> W,</span>
<span id="cb160-1284"><a href="#cb160-1284" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb160-1285"><a href="#cb160-1285" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q.SL.library =</span> Q_LIBRARY,</span>
<span id="cb160-1286"><a href="#cb160-1286" aria-hidden="true" tabindex="-1"></a>    <span class="at">g.SL.library =</span> G_LIBRARY,</span>
<span id="cb160-1287"><a href="#cb160-1287" aria-hidden="true" tabindex="-1"></a>    <span class="at">gbound =</span> G_BOUNDS[<span class="dv">1</span>]</span>
<span id="cb160-1288"><a href="#cb160-1288" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-1289"><a href="#cb160-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1290"><a href="#cb160-1290" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 4. Report results ──</span></span>
<span id="cb160-1291"><a href="#cb160-1291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"══════════════════════════════════════</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1292"><a href="#cb160-1292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"CLEAN-ROOM TMLE RESULTS</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1293"><a href="#cb160-1293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"══════════════════════════════════════</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1294"><a href="#cb160-1294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Estimand:"</span>, ESTIMAND, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1295"><a href="#cb160-1295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Population:"</span>, POPULATION, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1296"><a href="#cb160-1296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Treatment:"</span>, TREATMENT, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1297"><a href="#cb160-1297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"──────────────────────────────────────</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1298"><a href="#cb160-1298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ATE:    "</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>psi, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1299"><a href="#cb160-1299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>CI, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1300"><a href="#cb160-1300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"p-value:"</span>, <span class="fu">format.pval</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>pvalue, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1301"><a href="#cb160-1301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"──────────────────────────────────────</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1302"><a href="#cb160-1302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Q library:"</span>, <span class="fu">paste</span>(Q_LIBRARY, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1303"><a href="#cb160-1303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"g library:"</span>, <span class="fu">paste</span>(G_LIBRARY, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1304"><a href="#cb160-1304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"g-bounds: ["</span>, G_BOUNDS[<span class="dv">1</span>], <span class="st">","</span>, G_BOUNDS[<span class="dv">2</span>], <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1305"><a href="#cb160-1305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"══════════════════════════════════════</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1306"><a href="#cb160-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1307"><a href="#cb160-1307" aria-hidden="true" tabindex="-1"></a>  <span class="do">## EIC diagnostic</span></span>
<span id="cb160-1308"><a href="#cb160-1308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>IC), <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1309"><a href="#cb160-1309" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb160-1310"><a href="#cb160-1310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install the 'tmle' package:  install.packages('tmle')"</span>)</span>
<span id="cb160-1311"><a href="#cb160-1311" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-1312"><a href="#cb160-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-1313"><a href="#cb160-1313" aria-hidden="true" tabindex="-1"></a><span class="do">## ── 5. Session info for reproducibility ──</span></span>
<span id="cb160-1314"><a href="#cb160-1314" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">── Session info ──</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-1315"><a href="#cb160-1315" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb160-1316"><a href="#cb160-1316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>