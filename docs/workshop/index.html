<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Workshop: The Causal Roadmap and TMLE in Pharmacoepidemiology – Targeted Learning for Real-World Evidence</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-1322888c997fad56b0b4d776d35cf542.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Targeted Learning for Real-World Evidence</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../workshop/index.html" aria-current="page"> 
<span class="menu-text">Workshop</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../estimands/index.qmd"> 
<span class="menu-text">Estimands</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../advanced/index.html"> 
<span class="menu-text">Advanced</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../cases/index.html"> 
<span class="menu-text">Case Studies</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../bibliography/index.html"> 
<span class="menu-text">Bibliography</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resources/index.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#motivating-example-post-market-safety-of-prolia" id="toc-motivating-example-post-market-safety-of-prolia" class="nav-link active" data-scroll-target="#motivating-example-post-market-safety-of-prolia">Motivating Example: Post-Market Safety of Prolia</a>
  <ul class="collapse">
  <li><a href="#to-add" id="toc-to-add" class="nav-link" data-scroll-target="#to-add">To add:</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#why-venture-down-a-new-path" id="toc-why-venture-down-a-new-path" class="nav-link" data-scroll-target="#why-venture-down-a-new-path">Why venture down a new path?</a></li>
  <li><a href="#notation" id="toc-notation" class="nav-link" data-scroll-target="#notation">Notation</a></li>
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#the-causal-roadmap" id="toc-the-causal-roadmap" class="nav-link" data-scroll-target="#the-causal-roadmap">The Causal Roadmap</a></li>
  <li><a href="#step-1a-state-the-question-and-define-the-causal-estimand" id="toc-step-1a-state-the-question-and-define-the-causal-estimand" class="nav-link" data-scroll-target="#step-1a-state-the-question-and-define-the-causal-estimand">Step 1a: State the question and define the causal estimand</a></li>
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">notes</a></li>
  <li><a href="#step-1b-define-the-causal-model" id="toc-step-1b-define-the-causal-model" class="nav-link" data-scroll-target="#step-1b-define-the-causal-model">Step 1b: Define the causal model</a></li>
  <li><a href="#step-2-link-to-observed-data" id="toc-step-2-link-to-observed-data" class="nav-link" data-scroll-target="#step-2-link-to-observed-data">Step 2: Link to observed data</a></li>
  <li><a href="#step-3-assess-identifiablity" id="toc-step-3-assess-identifiablity" class="nav-link" data-scroll-target="#step-3-assess-identifiablity">Step 3: Assess Identifiablity</a></li>
  <li><a href="#step-4-define-the-statistical-estimand" id="toc-step-4-define-the-statistical-estimand" class="nav-link" data-scroll-target="#step-4-define-the-statistical-estimand">Step 4: Define the Statistical Estimand</a></li>
  <li><a href="#step-5-choose-and-apply-the-estimator" id="toc-step-5-choose-and-apply-the-estimator" class="nav-link" data-scroll-target="#step-5-choose-and-apply-the-estimator">Step 5: Choose and apply the estimator</a>
  <ul class="collapse">
  <li><a href="#simple-substitution-estimator" id="toc-simple-substitution-estimator" class="nav-link" data-scroll-target="#simple-substitution-estimator">Simple substitution estimator</a></li>
  <li><a href="#iptw--inverse-probability-of-treatment-weighting-estimator" id="toc-iptw--inverse-probability-of-treatment-weighting-estimator" class="nav-link" data-scroll-target="#iptw--inverse-probability-of-treatment-weighting-estimator">IPTW- Inverse Probability of Treatment Weighting estimator</a></li>
  <li><a href="#tmle--targeted-maximum-likelihood-estimation" id="toc-tmle--targeted-maximum-likelihood-estimation" class="nav-link" data-scroll-target="#tmle--targeted-maximum-likelihood-estimation">TMLE- targeted maximum likelihood estimation</a></li>
  <li><a href="#estimator-properties" id="toc-estimator-properties" class="nav-link" data-scroll-target="#estimator-properties">Estimator Properties</a></li>
  </ul></li>
  <li><a href="#step-6-specify-the-sensitivity-analyses-interpreting-findings" id="toc-step-6-specify-the-sensitivity-analyses-interpreting-findings" class="nav-link" data-scroll-target="#step-6-specify-the-sensitivity-analyses-interpreting-findings">Step 6: Specify the sensitivity analyses (interpreting findings)</a></li>
  <li><a href="#step-7-interpret-findings" id="toc-step-7-interpret-findings" class="nav-link" data-scroll-target="#step-7-interpret-findings">Step 7: Interpret findings</a></li>
  <li><a href="#step-7-compare-alternative-study-designs" id="toc-step-7-compare-alternative-study-designs" class="nav-link" data-scroll-target="#step-7-compare-alternative-study-designs">Step 7: Compare Alternative Study Designs</a></li>
  <li><a href="#caution-use-your-tools-well." id="toc-caution-use-your-tools-well." class="nav-link" data-scroll-target="#caution-use-your-tools-well.">Caution: Use your tools well.</a></li>
  <li><a href="#summary-and-discussion" id="toc-summary-and-discussion" class="nav-link" data-scroll-target="#summary-and-discussion">Summary and Discussion</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Workshop: The Causal Roadmap and TMLE in Pharmacoepidemiology</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="motivating-example-post-market-safety-of-prolia" class="level1">
<h1>Motivating Example: Post-Market Safety of Prolia</h1>
<p>This workshop introduces the <em>Causal Roadmap</em> and <em>Targeted Maximum Likelihood Estimation (TMLE)</em> through a motivating example: a post-market evaluation of <strong>cardiovascular safety among patients treated with denosumab (Prolia) vs.&nbsp;zoledronic acid</strong> for osteoporosis. The goal is to show how causal inference frameworks help produce transparent, reproducible real-world evidence.</p>
<p>In 2023, Amgen conducted a large-scale retrospective cohort study across two US claims databases, comparing denosumab with zoledronic acid. After adjusting for confounding using inverse probability weighting, the study found <strong>no increased risk of myocardial infarction or stroke</strong> up to 36 months of follow-up【204†source】. Here, we will reconstruct a simplified version of this question using the <em>causal roadmap</em> and a TMLE implementation.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Goal:</strong> Learn how to define, identify, and estimate a causal effect with TMLE, using machine learning for nuisance function estimation.</p>
</div>
</div>
<p><img src="../images/roadmap_placeholder.png" class="img-fluid" alt="Placeholder diagram: Flowchart of the Causal Roadmap steps."> <em>Figure 1. The Causal Roadmap, adapted for pharmacoepidemiologic safety analysis.</em></p>
<section id="to-add" class="level2">
<h2 class="anchored" data-anchor-id="to-add">To add:</h2>
<ul>
<li>(Joy) Make a bit more narrative versus bullet pointed</li>
<li>(Andrew) Add more on the causal roadmap</li>
<li>(Andrew) Include a Worked Interpretation Section (Not Just the computation)</li>
<li>Maybe add Q&amp;A’s throughout for those taking it asynchronously?</li>
<li>(joy) add references (key roadmap, tmle, and superlearner papers- ask Andrew if you need any specific ones)</li>
</ul>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This tutorial provides a gentle introduction to the Causal Roadmap and its applications in pharmaco-epidemiologic research. It is designed for a broad audience, including learners from both academia and industry. We systematically walk through each step of the Causal Roadmap—from explicitly formulating a research question, to translating it into a formal causal estimand, to identifying and estimating that estimand from observed data, and finally to drawing valid inferences and interpreting results. Each step is illustrated using a working example from a pharmaco-epidemiology setting, accompanied by interactive, built-in code to facilitate hands-on learning. The structure and content of this tutorial follow, in an analytical way, the Introduction to Causal Inference and the causal Roadmap course (htp://www.ucbbiostat.com/) Petersen and Balzer.</p>
</section>
<section id="why-venture-down-a-new-path" class="level2">
<h2 class="anchored" data-anchor-id="why-venture-down-a-new-path">Why venture down a new path?</h2>
<p>Adopting the Causal Roadmap in our approach to research in causal inference enables us to clearly state a scientific question and select an analtyic approach that matches the question being asked while ensuring systematic assessment of our ability/feasibility to answer this question from the data we observe (identifiability). Head to head analysis method comparison lets us select the best approach.</p>
<p>We will now formally introduce the Causal Roadmap but before let us go over some notation!</p>
</section>
<section id="notation" class="level2">
<h2 class="anchored" data-anchor-id="notation">Notation</h2>
<ul>
<li><strong><em>A</em></strong>: Exposure/Treatement
<ul>
<li>The term treatment is often used in causal inference even with exposures that are not medical treatments. We shall use A=1 for exposed (treated) and A=0 for unexposed (untreated)</li>
</ul></li>
<li><strong><em>Y</em></strong>: outcome</li>
<li><strong><em>W</em></strong>: set of measured confounding variables</li>
<li><strong><em>U</em></strong>: set of unmeasured factors</li>
<li><span class="math inline">\(\mathbb{E}[Y|A=a]\)</span>: expected outcome Y among those who experience exposure A=a in our population. This is a descriptive measure</li>
<li><span class="math inline">\(\mathbb{E}[Y_{a}]\)</span>: expected counterfactual outcome <span class="math inline">\(Y_a\)</span> when all experience exposure A=a in our population. This is a causal quantity. Generally <span class="math inline">\(\mathbb{E}[Y|A=a]\)</span> does not equal to <span class="math inline">\(\mathbb{E}[Y_{a}]\)</span> and this is the fundamental problem of causal inference</li>
<li><span class="math inline">\(\mathbb{E}[Y|A=a,W=w]\)</span>: expected outcome Y among those who expereince exposure A=a and have covariates W=w, in our population. For example this can be the mean outcome among exposed men. These conditional expectations are often estimated using multivariable regression models.</li>
<li><span class="math inline">\(\mathbb{E}[\mathbb{E}[Y|A=a,W=w]]\)</span>:expected outcome Y among those who experience exposure A=a and have covariates W=w,averaged across covariate strata in the population. This is a marginal expectation.</li>
</ul>
</section>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>Given our motivating example, suppose we are interested in understanding the causal impact of denosumab (Prolia) versus zoledronic acid on the risk of myocardial infarction or stroke among postmenopausal women with osteoporosis. In many applied settings, a common analytic approach would be to collect data on treatment assignment, the binary cardiovascular outcome, and a set of measured covariates. Because the outcome is binary, analysts often default to fitting a logistic regression model and interpreting the exponentiated coefficient on treatment as an estimate of the conditional odds ratio.</p>
<p>However, this approach has an important limitation: it allows the statistical tool i.e.&nbsp;logistic regression to implicitly define the scientific question being answered. Rather than starting with a clearly articulated causal question and picking amongst the tools that allow us answer it, we risk answering a question that is convenient for the model, such as a conditional odds ratio, which may not align with the effect measure of true scientific or clinical interest.</p>
<p>To address this issue, we introduce the Causal Roadmap, a principled framework that emphasizes starting with a well-defined causal question and then selecting appropriate statistical tools to answer that question. By separating the scientific question from the estimation method, the Causal Roadmap helps ensure that our analyses are aligned with the causal effect we truly care about, rather than being driven by default modeling choices.</p>
</section>
<section id="the-causal-roadmap" class="level2">
<h2 class="anchored" data-anchor-id="the-causal-roadmap">The Causal Roadmap</h2>
<p><strong>NOTE</strong> Make below a numbered list, reference Dang et al 2022 JCTS paper (and make sure the steps line up)</p>
<p>The Causal Roadmap is a framework that provides a systematic process to move from a research question to estimation and interpretation which guides investigators on how to design and analyse their studies a priori. This framework has the following steps <span class="citation" data-cites="dang2022causal">[@dang2022causal]</span>;</p>
<ul>
<li>Step 1a: Stating the research question and defining the causal estimand.</li>
<li>Step 1b: Defining the causal model and parameter of interest</li>
<li>Step 2: Linking the causal model to the observed data and defining the statistical model</li>
<li>Step 3: Assessing identifiability: are the data and knowledge about their generation sufficient to answer the causal question of interest?</li>
<li>Step 4: Defining the statistical estimand</li>
<li>Step 5: Selecting and applying the estimator and an estimate of the sampling distribution (method of inference)</li>
<li>Step 6: Specify the sensitivity analyses (interpreting findings)</li>
<li>Step 7: Compare feasible study designs.</li>
</ul>
<p>We shall now delve into each of these steps in details!</p>
</section>
<section id="step-1a-state-the-question-and-define-the-causal-estimand" class="level2">
<h2 class="anchored" data-anchor-id="step-1a-state-the-question-and-define-the-causal-estimand">Step 1a: State the question and define the causal estimand</h2>
<p>The first step of the Causal Roadmap is to clearly state the scientific question and define the corresponding causal estimand. A helpful way to do this is to explicitly state the hypothetical experiment that would unambiguously yield an estimate of the causal effect of interest.For example, consider the question: What is the effect of denosumab (Prolia) versus zoledronic acid on the risk of myocardial infarction or stroke among postmenopausal women with osteoporosis?</p>
<p>One way to formalize this question is to imagine a hypothetical experiment in which all eligible women are assigned to receive denosumab (Prolia), and to compare their myocardial infarction or stroke incidence to what would have been observed had all the same women instead received zoledronic. To sharply define this research question, it is important to be explicit about several components of the hypothetical experiment. These include the target population (e.g., postmenopausal women of a particular age range or geographic region), the exposure or intervention (including dosage, formulation, and frequency), the outcome (and the time window over which it is measured), and the intervention strategies under consideration.</p>
<p>Importantly, many different hypothetical experiments may be of interest, even within the same clinical context. For instance, one could ask what the difference in myocardial infarction or stroke incidence would be if patients were initiated on denosumab (Prolia) only after reaching a certain cardiovascular risk threshold, compared to initiating denosumab (Prolia) regardless of baseline risk.</p>
<p>Alternatively, one might consider a policy-relevant estimand, such as the difference in cardiovascular disease incidence if an additional 10% of patients received the intervention compared to if treatment uptake remained at its observed level. These examples highlight that there is substantial flexibility in how hypothetical experiments can be defined.</p>
<p>Once a causal question is clearly define, the causal estimand represents the question in mathematical terms must be defined. The ICH E9 (R1) <span class="citation" data-cites="ich2019estimand">[@ich2019estimand]</span> and Target Trial Emulation <span class="citation" data-cites="hernan2016target">[@hernan2016target]</span> frameworks provide detailed guidelines of defining a causal question and estimand.</p>
</section>
<section id="notes" class="level2">
<h2 class="anchored" data-anchor-id="notes">notes</h2>
<ul>
<li>Adding something about ICH E9 (R1) estimand framework and target trial emulation</li>
</ul>
</section>
<section id="step-1b-define-the-causal-model" class="level2">
<h2 class="anchored" data-anchor-id="step-1b-define-the-causal-model">Step 1b: Define the causal model</h2>
<p>Causal modeling provides a formal way to encode our scientific knowledge, however limited it may be,about how variables relate to one another. By explicitly stating assumptions, causal models allow us to explore which variables affect each other, consider the potential role of unmeasured factors, and reason about the functional form of relationships among variables. In this tutorial, we focus on structural causal models and their corresponding causal graphs as introduced by Pearl (2000). We note, however, that this is only one of several available causal inference frameworks, each with its own strengths and areas of application.</p>
<ul>
<li>The figure 1 below corresponds to a simple causal graph with corresponding structural casual model as follows;
<ul>
<li><span class="math inline">\(W= f_w(U_w)\)</span></li>
<li><span class="math inline">\(A= f_A(W,U_A)\)</span></li>
<li><span class="math inline">\(Y = f_Y(W,A,U_Y)\)</span></li>
</ul></li>
<li>We make no assumptions on the background factors <span class="math inline">\((U_w,U_A,U_Y)\)</span> or on the functional forms of functions <span class="math inline">\((f_w,f_A,f_Y)\)</span></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cm1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>If you believed no unmeasured confounding, a possible causal model and graph (figure 2) would be;
<ul>
<li><span class="math inline">\(W= f_w(U_w)\)</span></li>
<li><span class="math inline">\(A= f_A(W,U_A)\)</span></li>
<li><span class="math inline">\(Y = f_Y(W,A,U_Y)\)</span></li>
</ul></li>
<li>Here we assume that the background factors are all independent but still make no assumption on the functional forms of <span class="math inline">\((f_w,f_A,f_Y)\)</span></li>
<li>However, it is important to note that wishing for something does not make it true.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cm2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We now define counterfactuals by intervening on the causal model. We can do this by setting the exposure to a specific level e.g A=1 for all units.
<ul>
<li><span class="math inline">\(W= f_w(U_w)\)</span></li>
<li><span class="math inline">\(A= 1\)</span></li>
<li><span class="math inline">\(Y_1 = f_Y(W,1,U_Y)\)</span> where <span class="math inline">\(Y_1\)</span> is the outcome if possibly-contrary to fact, the unit was exposed (A=1)</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cm3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Analogously, we can intervene on the causal model by setting A=0
<ul>
<li><span class="math inline">\(W= f_w(U_w)\)</span></li>
<li><span class="math inline">\(A= 0\)</span></li>
<li><span class="math inline">\(Y_0 = f_Y(W,0,U_Y)\)</span> where <span class="math inline">\(Y_0\)</span> is the outcome if possibly-contrary to fact, the unit was exposed (A=0)</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cm5.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>We use counterfactual outcomes to formally define causal parameters. For example, one common estimand is the average treatment effect (ATE), defined as the difference between the expected outcomes under two interventions i.e <span class="math inline">\(\mathbb{E}[Y_1]-\mathbb{E}[Y_0]\)</span>.When the outcome is binary, this contrast is often expressed as the causal risk difference (CRD) given by <span class="math inline">\(\mathbb{P}(Y_1=1)-\mathbb{P}(Y_0=1)\)</span>.</p>
<p>Importantly, these are just two examples. Many other causal parameters can be defined depending on the scientific question of interest, the outcome type, and the decision context.</p>
</section>
<section id="step-2-link-to-observed-data" class="level2">
<h2 class="anchored" data-anchor-id="step-2-link-to-observed-data">Step 2: Link to observed data</h2>
<p>We denote the observed data by O=(W,A,Y), where W represents measured covariates, A is the exposure, and Y is the outcome. We assume that the causal model describes the data-generating process both under the existing conditions of the real world (the observed data) and under hypothetical interventions (the counterfactual world).This provides a link between the causal world and the observed world.</p>
<p>As a result, the causal model implies a statistical model, defined as the set of possible probability distributions for the observed data. The causal model may but often does not place any restrictions on the statistical model in which case the statistical model is <strong><em>non parametric</em></strong>.For example, a causal model may state that the exposure A,is generated as a function of covariates W, and unmeasured factors <span class="math inline">\(U_A\)</span>, written as A= <span class="math inline">\(f_A(W,U_A)\)</span> but does not specify the functional form of <span class="math inline">\(f_A\)</span>.If substantive knowledge justifies a particular functional form, that information should be encoded explicitly in the causal model; otherwise, the model remains agnostic, leading to a flexible, nonparametric statistical model.</p>
</section>
<section id="step-3-assess-identifiablity" class="level2">
<h2 class="anchored" data-anchor-id="step-3-assess-identifiablity">Step 3: Assess Identifiablity</h2>
<ul>
<li><p>This step of the roadmap involves linking the causal effect to the parameter estimable from observed data. This requires some assumptions as follows:</p>
<ul>
<li>Temporality: exposure precedes the outcome. This is indicated by an arrow on the causal graph from A to Y</li>
<li>Consistency: <span class="math inline">\(Y_a\)</span>=Y where A=a. If an individual received treatment A=a, then their observed outcome Y is equal to their potential outcome under that treatment <span class="math inline">\(Y_a\)</span>.</li>
<li>Stability: We require no interference between units. This is indicated by the fact that the outcomes Y are only a function of each unit’s exposure A in the causal model and graph.</li>
<li>Randomization:No unmeasured confounding such that <span class="math inline">\(Y_a \perp A \mid W\)</span></li>
<li>Positivity: We require sufficient variability in exposure within confounder values i.e.&nbsp;<span class="math inline">\(0 &lt; \mathbb{P}(A=1|W)&lt;1\)</span>.</li>
</ul></li>
</ul>
</section>
<section id="step-4-define-the-statistical-estimand" class="level2">
<h2 class="anchored" data-anchor-id="step-4-define-the-statistical-estimand">Step 4: Define the Statistical Estimand</h2>
<p>Under these assumptions, we can express our causal target parameter—which is defined in terms of counterfactuals as a function of the observed data. Specifically i.e <span class="math display">\[
    \begin{aligned}
    \mathbb{E}(Y_a)
      &amp;= \mathbb{E}\big[ \mathbb{E}(Y_a \mid W) \big] \\
      &amp;= \mathbb{E}\big[ \mathbb{E}(Y_a \mid A=a, W) \big]  under \ randomization\\
      &amp;= \mathbb{E}\big[ \mathbb{E}(Y \mid A=a, W) \big] under \ consistency
    \end{aligned}
    \]</span></p>
<p>Of course, simply wishing these assumptions to hold does not make them true. Their plausibility must be carefully assessed using subject-matter knowledge, study design considerations, and an understanding of the data-generating process.</p>
<p>When the assumptions are deemed reasonable, we obtain the G-computation identifiability result (Robins, 1986). In particular, the average treatment effect can be written as <span class="math inline">\(\mathbb{E}[Y_1-Y_0] = \mathbb{E}\big[\mathbb{E}(Y\mid A=1,W)-\mathbb{E}(Y\mid A=0,W)]\)</span> where the right-hand side is a function of the observed data distribution and therefore defines our statistical estimand. For a binary outcome, this corresponds to the marginal risk difference, $$. This is marginal because the outer expectation averages over the confounder distribution.</p>
<p>Finally, it is important to consider what happens when one or more of the identifying assumptions may not hold—for example, if there is concern about unmeasured confounding or if the data structure does not clearly establish temporality. In such cases, possible options include:</p>
<ul>
<li>Giving up (rarely the most satisfying choice)</li>
<li>Changing the research question, the exposure, the outcome or the target population</li>
<li>Proceeding to do the best job possible estimating the target parameter provided the question is still well-defined and interpretable and that we can still get as close as possible to the wished for causal parameter given the limitations in the data.</li>
</ul>
</section>
<section id="step-5-choose-and-apply-the-estimator" class="level2">
<h2 class="anchored" data-anchor-id="step-5-choose-and-apply-the-estimator">Step 5: Choose and apply the estimator</h2>
<p>An estimator is an algorithm that, when applied to observed data, produces an estimate of the statistical parameter of interest. In our setting, this statistical parameter corresponds to the average treatment effect (ATE) when the identifiability assumptions hold. There are several classes of estimators that can be used to estimate this parameter. These include substitution estimators, such as parametric G-computation; propensity score–based estimators, including inverse probability of treatment weighting (IPTW) and matching; and doubly robust estimators, such as targeted maximum likelihood estimation (TMLE) and augmented IPTW (A-IPTW). Each of these approaches relies on different modeling strategies and assumptions, and each has its own strengths and limitations.</p>
<p>Before exploring these estimators in detail, it is helpful to pause and reflect on the approach that is most commonly used in practice. In many applied analyses, one would simply fit a logistic regression model for the binary outcome Y (e.g., risk of cardiovascular disease) as a function of the exposure (denosumab (Prolia) versus zoledronic acid) and baseline confounders W, and then interpret the resulting coefficient on the exposure as the effect of interest.</p>
<p><span class="math display">\[
\text{logit}\big( \mathbb{E}(Y \mid A, W) \big)
    = \beta_0 + \beta_1 A + \beta_2 W_1 + \cdots + \beta_{19} W_{18}.
\]</span></p>
<p>They would then exponentiate the coefficient on the exposure and interpret the result as an odds ratio, often described as a conditional effect, meaning the association between treatment and outcome while holding other covariates constant.The problem here is that our target parameter (ATE) does not equal <span class="math inline">\(e^{\beta_{1}}\)</span>. Rather we are letting the estimation approach drive the question. Additionally, this estimation approach relies on the main terms logisitic regression being correct.</p>
<p>Estimation strategies can be broadly categorized as parametric, nonparametric, or semiparametric, depending on the assumptions made about the relationships among the covariates W, the exposure A and the outcome Y.</p>
<p>A <strong>parametric</strong> estimation approach assumes we know the relationship between covariates W, the exposure A and the outcome Y and have correctly specified this relation with a finite set of constants called “parameters”. For example, we can specify a regression with main terms for covariates and a few interactions or squared terms that we think are reasonable. If we had this knowledge, we should encode it in our causal model so we avoid introducing new assumptions during estimation. However, with parametric regression models, we are likely assuming we know more than we actually know.</p>
<p>A <strong>non-parametric</strong> estimation approach acknowledges that we do not know the form of the relations beetween the covariates W, the exposure A and the outcome Y.For example, one could divide the data into all combinations of (A,W), calculate and average the stratum specific A and Y relations. Unfortunately, when the number of covariates is large or when covariates are continuous, this approach quickly becomes infeasible due to sparse or empty strata. This phenomenon is commonly referred to as the curse of dimensionality since the number of strata increases exponentially with dimension of W!</p>
<p>In a <strong>semi parametric</strong> estimation approach, we often “know nothing” (i.e.&nbsp;have a non-paramteric statistical model) but also need to smooth over regions of data with weak support during estimation.This is typically achieved using data-adaptive methods or machine learning. Rather than committing to a single algorithm such as stepwise regression, LOESS, or polynomial splines without a principled basis for choosing among them, we allow a broad class of candidate algorithms to compete and we select the best algorithm with cross-validation. This is the basis of <strong><em>Super Learner</em></strong> which we will focus on in this tutorial.</p>
<p>Recall our statistical parameter is <span class="math inline">\(\mathbb{E}\big[\mathbb{E}(Y\mid A=1,W)-\mathbb{E}(Y\mid A=0,W)\big]\)</span> which equals the ATE if the identifiability results hold. We shall now discuss the following estimators and provide example implementations in R; - Simple substitution estimator a.k.a paramteric G-computation or parametric g-formula - Inverse probability of treatment weighting (IPTW) - Targeted maximum likelihood estimation (TMLE) with Super Learner</p>
<section id="simple-substitution-estimator" class="level3">
<h3 class="anchored" data-anchor-id="simple-substitution-estimator">Simple substitution estimator</h3>
<p>To build intuition for the simple substitution estimator, it is helpful to think of causal inference as a problem of missing information. For each individual, we observe the outcome under the observed exposure, but we are missing the outcome under the alternative exposure condition. In this approach, we use a parametric regression model to estimate the conditional mean outcome as a function of the exposure and measured confounders. This model is then used to predict each individual’s outcome under both exposure conditions. Finally, we average these predicted outcomes across individuals and compare them to obtain an estimate of the causal effect. We now describe this procedure step by step. First, we load the simulated dataset, CausalWorkshop.csv, and set the random seed to ensure reproducibility.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span>  <span class="fu">read_csv</span>(<span class="st">"CausalWorkshop.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 200 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (6): W1, W2, W3, W4, A, Y

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
     W1    W2     W3     W4     A      Y
  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1 0.704  0.312  0.441     0 0.0467
2     0 0.696  0.438  1.38      0 0.0771
3     0 0.394 -0.538 -1.44      0 0.177 
4     0 0.642  0.767  1.25      0 0.0330
5     1 0.426 -0.203 -0.146     0 0.105 
6     1 0.458  1.60   0.709     0 0.0228</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
     W1     W2     W3      W4     A       Y
  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1     0 0.856   1.17   2.10       1 0.00278
2     0 0.434   0.545 -0.238      0 0.0469 
3     1 0.243  -1.80  -0.769      0 0.0675 
4     0 0.629  -0.229  0.0750     1 0.109  
5     0 0.0913 -0.100  0.761      0 0.117  
6     1 0.543  -1.48  -0.794      0 0.0531 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 200   6</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol type="1">
<li>We the estimate the mean outcome Y as a function of exposure (treatment) A and measured confounders W. In this example we run a main terms logistic regression.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>outcome.regression <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> W1<span class="sc">+</span>W2<span class="sc">+</span>W3<span class="sc">+</span>W4, <span class="at">family=</span><span class="st">'binomial'</span>, <span class="at">data=</span>data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in eval(family$initialize): non-integer #successes in a binomial glm!</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>We use estimates from 1 above to predict outcomes for each unit while “setting” the exposure to different values e.g.&nbsp;A=1 and A=0</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data.A1 <span class="ot">&lt;-</span> data.A0 <span class="ot">&lt;-</span> data</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>data.A1<span class="sc">$</span>A <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>data.A0<span class="sc">$</span>A <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(data.A1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         W1          W2          W3          W4           A           Y 
 0.52000000  0.51459003  0.02187934 -0.01958053  1.00000000  0.06244803 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(data.A0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         W1          W2          W3          W4           A           Y 
 0.52000000  0.51459003  0.02187934 -0.01958053  0.00000000  0.06244803 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>predict.outcome.A1 <span class="ot">&lt;-</span> <span class="fu">predict</span>( outcome.regression, <span class="at">newdata=</span>data.A1, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>predict.outcome.A0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(outcome.regression, <span class="at">newdata=</span>data.A0, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type=</span><span class="st">'response'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Average predictions to estimate the marginal risks in the population under exposure and no exposure. To compare estimates, take the difference in means.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(predict.outcome.A1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03877997</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(predict.outcome.A0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07258282</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>Simple.Subs <span class="ot">&lt;-</span> <span class="fu">mean</span>(predict.outcome.A1 <span class="sc">-</span> predict.outcome.A0)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>Simple.Subs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.03380285</code></pre>
</div>
</div>
</section>
<section id="iptw--inverse-probability-of-treatment-weighting-estimator" class="level3">
<h3 class="anchored" data-anchor-id="iptw--inverse-probability-of-treatment-weighting-estimator">IPTW- Inverse Probability of Treatment Weighting estimator</h3>
<p>The intuition behind inverse probability of treatment weighting (IPTW) is to view confounding as a problem of biased sampling. In observational data, some exposure–covariate subgroups are overrepresented, while others are underrepresented, relative to what we would expect in a randomized trial.</p>
<p>IPTW addresses this issue by reweighting the data to create a pseudo-population in which treatment assignment is independent of measured confounders. Weights are applied to up-weight under-represented units and down-weight over-represented units. Causal effects are then estimated by averaging and comparing the weighted outcomes across treatment groups. The algorithm for implementing the IPTW estimator is described below.</p>
<ol type="1">
<li>Estimate the probability of being exposed/treated A as a function of measured confounders W:<span class="math inline">\(\mathbb{P}(A=1\mid W)\)</span>. This is often referred to as the propensity score. We can estimate the propensity score by running a main terms logistic regression as illustrated below</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>pscore.regression <span class="ot">&lt;-</span> <span class="fu">glm</span>(A<span class="sc">~</span> W1<span class="sc">+</span>W2<span class="sc">+</span>W3<span class="sc">+</span>W4, <span class="at">family=</span><span class="st">'binomial'</span>,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data=</span>data)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pscore.regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = A ~ W1 + W2 + W3 + W4, family = "binomial", data = data)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  -1.3445     0.3821  -3.519 0.000433 ***
W1            0.4637     0.3130   1.482 0.138399    
W2            0.5113     0.5629   0.908 0.363744    
W3            0.4483     0.3208   1.397 0.162360    
W4           -0.2676     0.3095  -0.865 0.387227    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 247.64  on 199  degrees of freedom
Residual deviance: 241.99  on 195  degrees of freedom
AIC: 251.99

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>We then use estimates from 1 above to calculate exposed/treated weights: 1/<span class="math inline">\(\mathbb{P}(A=1\mid W)\)</span> and unexposed/untreated weights:1/<span class="math inline">\(\mathbb{P}(A=0\mid W)\)</span></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>predict.prob.A1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(pscore.regression, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(predict.prob.A1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.1555  0.2521  0.3034  0.3100  0.3658  0.5145 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>predict.prob.A0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> predict.prob.A1</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>wt1 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>( data<span class="sc">$</span>A<span class="sc">==</span><span class="dv">1</span>)<span class="sc">/</span>predict.prob.A1</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>wt0 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>( data<span class="sc">$</span>A<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span>predict.prob.A0</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="at">A=</span>data<span class="sc">$</span>A, <span class="dv">1</span><span class="sc">/</span>predict.prob.A1, wt1, wt0)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  A       V2 wt1      wt0
1 0 2.646982   0 1.607171
2 0 4.197342   0 1.312760
3 0 3.718918   0 1.367793
4 0 3.735871   0 1.365514
5 0 3.044577   0 1.489099
6 0 2.128806   0 1.885892</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>We then apply the weights and average the weighted outcomes to estimate the marginal risks in the population under A=1 and A=0. To compare estimates, we take the difference in weighted means.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(wt1<span class="sc">*</span>data<span class="sc">$</span>Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03973564</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(wt0<span class="sc">*</span>data<span class="sc">$</span>Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07234258</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>IPW <span class="ot">&lt;-</span> <span class="fu">mean</span>(wt1<span class="sc">*</span>data<span class="sc">$</span>Y) <span class="sc">-</span> <span class="fu">mean</span>(wt0<span class="sc">*</span>data<span class="sc">$</span>Y)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>IPW</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.03260694</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>( (wt1<span class="sc">-</span>wt0)<span class="sc">*</span>data<span class="sc">$</span>Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.03260694</code></pre>
</div>
</div>
</section>
<section id="tmle--targeted-maximum-likelihood-estimation" class="level3">
<h3 class="anchored" data-anchor-id="tmle--targeted-maximum-likelihood-estimation">TMLE- targeted maximum likelihood estimation</h3>
<p>To build intuition for targeted maximum likelihood estimation (TMLE), we again view causal inference as a problem of missing information.As in simple substitution, the first step is to predict outcomes for all units under both the exposed and unexposed conditions.TMLE begins by fitting an initial outcome regression using a flexible estimation approach, such as Super Learner, to avoid relying on strong parametric assumptions when the true regression model is unknown. When reliable parametric knowledge is available, it can be incorporated directly.</p>
<p>TMLE then incorporates information about the exposure–covariate relationship through a targeted update of the initial estimator.This targeting step is designed specifically to improve estimation of the causal parameter of interest. Because TMLE uses both the outcome model and the exposure model, it offers double robustness: the estimator remains consistent if at least one of these models is correctly specified. This estimator is also asymptotically linear and therefore we can obtain normal curve inference.Finally, causal effects are obtained by averaging and comparing the targeted predicted outcomes under exposure and no exposure.</p>
<section id="what-is-super-learner" class="level4">
<h4 class="anchored" data-anchor-id="what-is-super-learner">What is Super Learner?</h4>
<p>This is a supervised machine learning algorithm that offers a flexible and data daptive approach to learn complex relationships from data. This algorithm uses cross-validation(sample splitting) to evaluate the performance of a library of candidate estimators.The library should be diverse including simple (e.g expert informed parametric regressions) and more adaptive algorithms (e.g penalized regressions, stepwise regression, adaptive splines) Performance is assessed using a specified loss function, such as the squared prediction error, which quantifies how well each algorithm predicts outcomes on new data.</p>
<p>Cross-validation allows us to compare algorithms based on how they perform on independent data. The data are partitioned into folds, and each algorithm is repeatedly trained on a subset of the data and evaluated on the held-out validation set. This process is rotated across folds, and the resulting risk estimates are averaged to obtain a single cross-validated performance measure for each algorithm. Rather than selecting only the single best-performing algorithm, Super Learner constructs an optimal weighted combination of algorithm-specific predictions. In the next section, we illustrate how to fit a Super Learner in practice.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'SuperLearner'</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>SL.library <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'SL.glm'</span>, <span class="st">'SL.step.interaction'</span>, <span class="st">'SL.gam'</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>SL.outcome.regression <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">SuperLearner</span>(<span class="at">Y=</span>data<span class="sc">$</span>Y, </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X=</span><span class="fu">subset</span>(data, <span class="at">select=</span><span class="sc">-</span>Y),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">SL.library=</span>SL.library, </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">family=</span><span class="st">'binomial'</span>))</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>SL.outcome.regression</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
SuperLearner(Y = data$Y, X = subset(data, select = -Y), family = "binomial",  
    SL.library = SL.library) 

                               Risk      Coef
SL.glm_All              0.002745489 0.0000000
SL.step.interaction_All 0.001407506 0.1134166
SL.gam_All              0.001164327 0.8865834</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>SL.predict.outcome <span class="ot">&lt;-</span> <span class="fu">predict</span>(SL.outcome.regression, </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">newdata=</span><span class="fu">subset</span>(data, <span class="at">select=</span><span class="sc">-</span>Y))<span class="sc">$</span>pred</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(SL.predict.outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,] 0.06057937
[2,] 0.03497212
[3,] 0.09365564
[4,] 0.02889967
[5,] 0.08963054
[6,] 0.01211914</code></pre>
</div>
</div>
</section>
<section id="why-do-i-need-to-target" class="level4">
<h4 class="anchored" data-anchor-id="why-do-i-need-to-target">Why do I need to target?</h4>
<p>We could use Super Learner to predict the outcomes for each unit while “setting” the exposure to different levels and then average and contrast the predictions.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>SL.predict.outcome.A1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(SL.outcome.regression, </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">newdata=</span><span class="fu">subset</span>(data.A1, <span class="at">select=</span><span class="sc">-</span>Y))<span class="sc">$</span>pred</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(SL.predict.outcome.A1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            [,1]
[1,] 0.037893675
[2,] 0.021656007
[3,] 0.059409745
[4,] 0.017819346
[5,] 0.056743415
[6,] 0.007417174</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>SL.predict.outcome.A0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(SL.outcome.regression, <span class="at">newdata=</span><span class="fu">subset</span>(data.A0, <span class="at">select=</span><span class="sc">-</span>Y))<span class="sc">$</span>pred</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># simple subst estimator</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(SL.predict.outcome.A1) <span class="sc">-</span> <span class="fu">mean</span>(SL.predict.outcome.A0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.02523567</code></pre>
</div>
</div>
<p>However, Super Learner is focused on <span class="math inline">\(\mathbb{E}(Y\mid A,W)\)</span> and not our parameter of interest. It makes the wrong bias-variance trade-off and specifically incurs too much bias.There is also no reliable way to obtain statistical inference (i.e create 95% confidence intervals)</p>
</section>
<section id="what-is-targeting" class="level4">
<h4 class="anchored" data-anchor-id="what-is-targeting">What is targeting?</h4>
<p>Targeting step uses information in the estimated propensity score <span class="math inline">\(\mathbb{P}(A=1\mid W)\)</span> to update the initial (Super Learner) estimator of <span class="math inline">\(\mathbb{E}(Y\mid A,W)\)</span>. It involves running a univariate regression of the outcome Y on a clever covariate with offset the initial estimator. Why “clever”? It ensures that the targeting step moves the initial estimator in a direction that removes bias. The estimated coefficient from this regression is then used to update the initial predicted outcomes under both the exposed and unexposed conditions.</p>
</section>
<section id="how-do-i-target-one-approach" class="level4">
<h4 class="anchored" data-anchor-id="how-do-i-target-one-approach">How do i target? (One approach)</h4>
<ol type="1">
<li>Use Super Learner to estimate the propensity score <span class="math inline">\(\mathbb{P}(A=1\mid W)\)</span></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>SL.pscore <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(<span class="at">Y=</span>data<span class="sc">$</span>A, <span class="at">X=</span><span class="fu">subset</span>(data, <span class="at">select=</span><span class="sc">-</span><span class="fu">c</span>(A,Y)),</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library=</span>SL.library, <span class="at">family=</span><span class="st">'binomial'</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>SL.pscore</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
SuperLearner(Y = data$A, X = subset(data, select = -c(A, Y)), family = "binomial",  
    SL.library = SL.library) 

                             Risk      Coef
SL.glm_All              0.2193296 0.0000000
SL.step.interaction_All 0.2073331 0.2986055
SL.gam_All              0.2048874 0.7013945</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>SL.predict.prob.A1 <span class="ot">&lt;-</span> SL.pscore<span class="sc">$</span>SL.predict</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(SL.predict.prob.A1 <span class="sc">-</span> <span class="fu">predict</span>(SL.pscore, <span class="at">newdata=</span><span class="fu">subset</span>(data,<span class="at">select=</span><span class="sc">-</span><span class="fu">c</span>(A,Y)))<span class="sc">$</span>pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       V1   
 Min.   :0  
 1st Qu.:0  
 Median :0  
 Mean   :0  
 3rd Qu.:0  
 Max.   :0  </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(SL.predict.prob.A1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       V1        
 Min.   :0.1560  
 1st Qu.:0.2378  
 Median :0.2748  
 Mean   :0.3100  
 3rd Qu.:0.3501  
 Max.   :0.9270  </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>SL.predict.prob.A0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> SL.predict.prob.A1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong><em>Note</em></strong>: As you run this code you might encounter a warning “non-integer #successes in a binomial glm!”. This simply means that our outcome Y is not binary much as it’s bounded between 0 and 1. This is okay and can be ignored.</p>
<ol start="2" type="1">
<li>Calculate the “clever covariate”</li>
</ol>
<p><span class="math display">\[H(A,W)= \frac{\mathbb{I}(A=1)}{\mathbb{P}(A=1\mid W)}- \frac{\mathbb{I}(A=0)}{\mathbb{P}(A=0\mid W)}\]</span></p>
<p>Here’s code to evaluate the “clever covariate”</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>H.AW <span class="ot">&lt;-</span> (data<span class="sc">$</span>A<span class="sc">==</span><span class="dv">1</span>)<span class="sc">/</span>SL.predict.prob.A1 <span class="sc">-</span> (data<span class="sc">$</span>A<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span>SL.predict.prob.A0</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(H.AW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       V1           
 Min.   :-2.186965  
 1st Qu.:-1.407155  
 Median :-1.301617  
 Mean   : 0.006879  
 3rd Qu.: 1.988451  
 Max.   : 5.879362  </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>H<span class="fl">.1</span>W <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>SL.predict.prob.A1</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>H<span class="fl">.0</span>W <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>SL.predict.prob.A0</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(<span class="fu">data.frame</span>(<span class="at">A=</span>data<span class="sc">$</span>A, H.AW, H<span class="fl">.1</span>W, H<span class="fl">.0</span>W))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    A      H.AW     H.1W      H.0W
195 1  2.475907 2.475907 -1.677550
196 0 -1.394124 3.537274 -1.394124
197 0 -1.326598 4.061867 -1.326598
198 1  5.371782 5.371782 -1.228740
199 0 -1.184825 6.410513 -1.184825
200 0 -1.339610 3.944556 -1.339610</code></pre>
</div>
</div>
<p>3.Run logistic regression of the outcome on this covariate using logit of the initial estimator <span class="math inline">\(\mathbb{E}(Y\mid A,W)\)</span> as offset where logit(x)= log[x/(1-x)]</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>logitUpdate <span class="ot">&lt;-</span> <span class="fu">glm</span>( data<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span><span class="fu">offset</span>( <span class="fu">qlogis</span>(SL.predict.outcome)) <span class="sc">+</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                      H.AW, <span class="at">family=</span><span class="st">'binomial'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in eval(family$initialize): non-integer #successes in a binomial glm!</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> logitUpdate<span class="sc">$</span>coef</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>epsilon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       H.AW 
0.004130237 </code></pre>
</div>
</div>
<ol start="4" type="1">
<li>Plug in the estimated coefficient <span class="math inline">\(\epsilon\)</span> to yield our targeted estimator <span class="math inline">\(\mathbb{E^*}(Y\mid A,W)\)</span> and use the targeted estimator <span class="math inline">\(\mathbb{E^*}(Y\mid A,W)\)</span> to predict outcomes for all under A=1 and A=0</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>target.predict.outcome.A1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>( <span class="fu">qlogis</span>(SL.predict.outcome.A1)<span class="sc">+</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                                       epsilon<span class="sc">*</span>H<span class="fl">.1</span>W)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>target.predict.outcome.A0 <span class="ot">&lt;-</span> <span class="fu">plogis</span>( <span class="fu">qlogis</span>(SL.predict.outcome.A0)<span class="sc">+</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                                      epsilon<span class="sc">*</span>H<span class="fl">.0</span>W)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>Average the predictions to estimate the marginal risks in the population under exposure and no exposure. Compare the estimates by taking the difference.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>TMLE <span class="ot">&lt;-</span> <span class="fu">mean</span>( target.predict.outcome.A1 <span class="sc">-</span> target.predict.outcome.A0)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>TMLE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.02419038</code></pre>
</div>
</div>
</section>
</section>
<section id="estimator-properties" class="level3">
<h3 class="anchored" data-anchor-id="estimator-properties">Estimator Properties</h3>
<p>We have now discussed three estimators and walked through their implementation. We next summarize the key properties of each estimator and highlight important considerations when choosing among them;</p>
<ul>
<li>Simple substitution estimator
<ul>
<li>This relies on consistently estimating the mean outcome <span class="math inline">\(\mathbb{E^*}(Y\mid A,W)\)</span>. In settings where there is strong substantive knowledge about the relationship between the outcome and the exposure–covariate set, a correctly specified parametric regression model may perform well. However, in many applications our knowledge of this relationship is limited. In such cases, assuming an incorrect parametric form can lead to biased estimates and misleading inference</li>
</ul></li>
<li>IPTW
<ul>
<li>Relies on consistently estimating the propensity score <span class="math inline">\(\mathbb{P}(A=1\mid W)\)</span>. While sometimes we have a lot of knowledge about how the exposure was assigned, other times our knowledge is limited and assuming a parametric regression model can result in bias and misleading inference. This estimator is also unstable under positivity violations. When covariate groups only have a few exposed or unexposed observations, weights can blow up!!. If some strata contain no exposed or no unexposed observations, the estimator may appear numerically stable, but it will generally be biased and its variance underestimated.</li>
</ul></li>
<li>TMLE
<ul>
<li>This estimator is doubly robust i.e.&nbsp;yields a consistent estimate if either the conditional mean <span class="math inline">\(\mathbb{E^*}(Y\mid A,W)\)</span> or the propensity score <span class="math inline">\(\mathbb{P}(A=1\mid W)\)</span> is consistently estimated. We get two chances to get it right !!TMLE is also semiparametrically efficient, achieving the lowest possible asymptotic variance among a broad class of estimators when both models are estimated at sufficient rates. Importantly, TMLE is supported by formal theory that allows for valid statistical inference under mild conditions even when machine learning methods are used.Being a substitution estimator (plug-in), it is robust under positivity violations,strong confounding and rare outcomes. In addition, there is well-developed software available for implementation, including packages such as ltmle,lmptp packages in R.</li>
</ul></li>
</ul>
<p>After estimating the parameter of interest, the next step is to quantify statistical uncertainty.Doing so requires an estimate of the sampling distribution.We can consider doing a non-parametric bootstrap where we re-sample the observed data with replacement, apply the entire estimation process (including machine learning algorithms) to the re-sampled data, repeat X times and estimate the variance with the bootstrapped point estimates. Alternatively, we can use influence curve based inference asymptotic linearity to directly estimate standard errors. We shall not discuss this here but this form of inference is available in the R packages.</p>
<p>With this, we conclude the estimation component of the analysis. Having selected an estimator and obtained an estimate of our parameter of interest and inference, we now return to the broader Causal Roadmap to consider interpretation, diagnostics, and sensitivity to assumptions</p>
</section>
</section>
<section id="step-6-specify-the-sensitivity-analyses-interpreting-findings" class="level2">
<h2 class="anchored" data-anchor-id="step-6-specify-the-sensitivity-analyses-interpreting-findings">Step 6: Specify the sensitivity analyses (interpreting findings)</h2>
</section>
<section id="step-7-interpret-findings" class="level2">
<h2 class="anchored" data-anchor-id="step-7-interpret-findings">Step 7: Interpret findings</h2>
<ul>
<li><p>The final step of the Causal Roadmap is to interpret the findings. At this stage, we evaluate whether and to what extent the underlying assumptions have been met in order to determine the strength of interpretation.</p></li>
<li><p>Findings support a statistical interpretation if (1) the statistical estimator has negligible bias and its variance is well estimated</p></li>
<li><p>Findings support a causal interpretation if 1 holds and (2) if the non testable identifiability assumptions hold.</p></li>
<li><p>Can be interpreted as if implemented in the real-world if 1 and 2 hold and if (3) the intervention is feasible and applicable to the real world population.</p></li>
<li><p>Findings can be interpreted as if we had emulated a randomized trial if 1-3 hold and the exposure could have been randomized to that population.</p></li>
<li><p>If there are concerns about causal assumptions (e.g.&nbsp;temporal odering is unclear, unmeasured confounding), the results can be interpreted as <strong><em>associational</em></strong>. In this case the estimand, <span class="math inline">\(\mathbb{E}\big[\mathbb{E}(Y\mid A=1,W)-\mathbb{E}(Y\mid A=0,W)]\)</span> can be interpreted as;</p>
<ul>
<li>The marginal difference in the expected outcome associated with the exposure, after accounting for the measured confounders</li>
<li>The difference in the mean outcome between persons exposed versus unexposed but with the same values of the adjustment covariates (averaged with respect to the distribution of those covariates in the population).e.g The difference in the risk of cardiovascular disease with intervention A vs B is X, accounting for region,age,sex,SES etc</li>
<li>Alternatively one can report that this is as close as we can get to the causal effet of A on Y given the limitations of the data detailing all limitations and including a causal graph to empower the reader to assess the plausibility of assumptions.</li>
</ul></li>
<li><p>If the authors believe causal assumptions are met, the parameter can be interpreted as the population average treatment effect <span class="math inline">\(\mathbb{E}\big[Y_1-Y_0\big]\)</span>.</p>
<ul>
<li>In words, this would be the difference in the expected outcome if everyone were exposed compared if everyone were unexposed. For example, there would be an X difference in the risk of cardiovascular disease if all patients in the population received intervention A vs B.</li>
</ul></li>
</ul>
</section>
<section id="step-7-compare-alternative-study-designs" class="level2">
<h2 class="anchored" data-anchor-id="step-7-compare-alternative-study-designs">Step 7: Compare Alternative Study Designs</h2>
</section>
<section id="caution-use-your-tools-well." class="level2">
<h2 class="anchored" data-anchor-id="caution-use-your-tools-well.">Caution: Use your tools well.</h2>
<p>TMLE with Super Learner is a powerful approach, but it should be viewed as one tool within a broader toolbox. No matter how sophisticated the estimator, careful thinking throughout the earlier steps of the Causal Roadmap remains essential.</p>
<p>It is especially important to formally derive adjustment sets and clearly define the statistical parameter before estimation. Failure to do so can lead to errors of causal model neglect, where the quantity being estimated differs meaningfully from any interpretable causal effect.</p>
<p>Doubly robust estimators (e.g TMLE or A-IPW) can incorporate machine learning while maintaining basis for valid statistical inference. This helps us avoid errors of “statistical model neglect”, occurring when relying on unsubstantiated (parametric) assumptions during estimation.However, these benefits depend on careful implementation. In particular, the Super Learner library must be specified thoughtfully: diversity among candidate learners is crucial, and overfitting should be avoided through proper sample splitting and cross-validation.</p>
<p>In practice, positivity violations can and do occur. Poor support for certain exposure–covariate combinations may lead to bias and underestimated variance. Potential strategies for addressing these issues include using substitution estimators such as G-computation or TMLE, modifying the targeting step in TMLE (e.g., via weighted regression), employing robust variance estimators (e.g., Tran et al., 2018; Benkeser et al., 2017), or bounding estimated propensity scores away from zero and one.</p>
<p>Finally, simulation studies play a critical role in responsible causal analysis. By simulating data that mimic key features of the observed setting—such as sample size, confounding structure, missingness mechanisms, sparsity, dependence, or practical positivity challenges—we can better understand estimator behavior and use these insights to guide analytic decisions.</p>
</section>
<section id="summary-and-discussion" class="level2">
<h2 class="anchored" data-anchor-id="summary-and-discussion">Summary and Discussion</h2>
<p>Congratulations! You have successfully worked through this tutorial and implemented three core estimators for causal inference: the simple substitution estimator, inverse probability of treatment weighting (IPTW), and targeted maximum likelihood estimation (TMLE). Along the way, you have built both intuitive and technical understanding of how these estimators operate, what assumptions they rely on, and how they behave in practice.</p>
<p>You have also completed a high-speed tour of the Causal Roadmap, and by now its strengths should be apparent. The Roadmap emphasizes the importance of starting with clearly defined scientific questions and ensures that the parameters we estimate are aligned with those questions. It makes explicit the assumptions required to interpret estimates as causal effects.When assumptions are not met, the unmet assumptions provide clear guidance on how future research must be improved to increase the potential of causal interpretation.Working in this framework can improve interpretability and relevance of epidemiologic research.</p>
<p>Although this tutorial focused on estimating the average treatment effect, the same framework naturally extends to a wide range of causal questions and data structures, including effects among treated or untreated populations, mediation analyses, longitudinal interventions, and dynamic treatment regimes.</p>
<p>For readers interested in exploring these more advanced settings, we provide links to additional resources below.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>