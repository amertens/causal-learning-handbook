<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A practical guide to the Causal Roadmap, Targeted Maximum Likelihood Estimation (TMLE), and Super Learner for modern causal inference in epidemiology, with emphasis on pharmacoepidemiology and clinical trial analysis.">

<title>19&nbsp; Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial – Causal Learning Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./common-pitfalls.html" rel="next">
<link href="./03-10-tmle-mediation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b343bb23504f009ddf7b24643a6af19a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-11-estimands-tte-safety.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Causal Learning Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/amertens/causal-learning-handbook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Causal Learning Handbook</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-01-regression-vs-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 1.1: Limitations of Standard Regression Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-02-causal-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 1.2: The Causal Roadmap</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-03-identification-estimands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1.3: From Causal Questions to Analysis — Identification, Estimands, and Statistical Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Roadmap for Real-world Evidence Generation: A Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Estimation Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-01-gcomputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-02-iptw.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-03-doubly-robust-tmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-04-tmle-teaching-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superlearner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-03-longitudinal-case-study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-04-effect-modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-05-advanced-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-07-longitudinal-td-confounding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-08-tmle-clean-room.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-09-illustrated-ltmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-10-tmle-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-11-estimands-tte-safety.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anotated_bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Annotated Bibliography: Modern Causal Inference and Targeted Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#estimands-in-time-to-event-real-world-safety-analyses" id="toc-estimands-in-time-to-event-real-world-safety-analyses" class="nav-link active" data-scroll-target="#estimands-in-time-to-event-real-world-safety-analyses"><span class="header-section-number">20</span> Estimands in Time-to-Event Real-World Safety Analyses</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">21</span> 1. Introduction</a>
  <ul class="collapse">
  <li><a href="#the-regulatory-context" id="toc-the-regulatory-context" class="nav-link" data-scroll-target="#the-regulatory-context"><span class="header-section-number">21.1</span> The Regulatory Context</a></li>
  <li><a href="#three-estimand-strategies" id="toc-three-estimand-strategies" class="nav-link" data-scroll-target="#three-estimand-strategies"><span class="header-section-number">21.2</span> Three Estimand Strategies</a></li>
  </ul></li>
  <li><a href="#simulating-a-safety-study-de-novo" id="toc-simulating-a-safety-study-de-novo" class="nav-link" data-scroll-target="#simulating-a-safety-study-de-novo"><span class="header-section-number">22</span> 2. Simulating a Safety Study De Novo</a>
  <ul class="collapse">
  <li><a href="#generate-baseline-covariates" id="toc-generate-baseline-covariates" class="nav-link" data-scroll-target="#generate-baseline-covariates"><span class="header-section-number">22.1</span> 2.1 Generate Baseline Covariates</a></li>
  <li><a href="#simulate-confounded-treatment-assignment" id="toc-simulate-confounded-treatment-assignment" class="nav-link" data-scroll-target="#simulate-confounded-treatment-assignment"><span class="header-section-number">22.2</span> 2.2 Simulate Confounded Treatment Assignment</a></li>
  <li><a href="#simulate-event-times-with-time-varying-hazard" id="toc-simulate-event-times-with-time-varying-hazard" class="nav-link" data-scroll-target="#simulate-event-times-with-time-varying-hazard"><span class="header-section-number">22.3</span> 2.3 Simulate Event Times with Time-Varying Hazard</a></li>
  <li><a href="#simulate-treatment-switching" id="toc-simulate-treatment-switching" class="nav-link" data-scroll-target="#simulate-treatment-switching"><span class="header-section-number">22.4</span> 2.4 Simulate Treatment Switching</a></li>
  <li><a href="#administrative-censoring-and-final-dataset" id="toc-administrative-censoring-and-final-dataset" class="nav-link" data-scroll-target="#administrative-censoring-and-final-dataset"><span class="header-section-number">22.5</span> 2.5 Administrative Censoring and Final Dataset</a></li>
  </ul></li>
  <li><a href="#defining-three-estimands" id="toc-defining-three-estimands" class="nav-link" data-scroll-target="#defining-three-estimands"><span class="header-section-number">23</span> 3. Defining Three Estimands</a>
  <ul class="collapse">
  <li><a href="#a.-treatment-policy-estimand" id="toc-a.-treatment-policy-estimand" class="nav-link" data-scroll-target="#a.-treatment-policy-estimand"><span class="header-section-number">23.1</span> 3a. Treatment-Policy Estimand</a></li>
  <li><a href="#b.-while-on-treatment-estimand" id="toc-b.-while-on-treatment-estimand" class="nav-link" data-scroll-target="#b.-while-on-treatment-estimand"><span class="header-section-number">23.2</span> 3b. While-on-Treatment Estimand</a></li>
  <li><a href="#c.-hypothetical-no-switch-estimand" id="toc-c.-hypothetical-no-switch-estimand" class="nav-link" data-scroll-target="#c.-hypothetical-no-switch-estimand"><span class="header-section-number">23.3</span> 3c. Hypothetical (No-Switch) Estimand</a></li>
  </ul></li>
  <li><a href="#estimation-approaches" id="toc-estimation-approaches" class="nav-link" data-scroll-target="#estimation-approaches"><span class="header-section-number">24</span> 4. Estimation Approaches</a>
  <ul class="collapse">
  <li><a href="#kaplan-meier-estimates" id="toc-kaplan-meier-estimates" class="nav-link" data-scroll-target="#kaplan-meier-estimates"><span class="header-section-number">24.1</span> 4.1 Kaplan-Meier Estimates</a></li>
  <li><a href="#iptw-adjusted-estimates" id="toc-iptw-adjusted-estimates" class="nav-link" data-scroll-target="#iptw-adjusted-estimates"><span class="header-section-number">24.2</span> 4.2 IPTW-Adjusted Estimates</a>
  <ul class="collapse">
  <li><a href="#weighted-90-day-risk-estimates" id="toc-weighted-90-day-risk-estimates" class="nav-link" data-scroll-target="#weighted-90-day-risk-estimates"><span class="header-section-number">24.2.1</span> Weighted 90-day risk estimates</a></li>
  </ul></li>
  <li><a href="#tmle-based-estimation" id="toc-tmle-based-estimation" class="nav-link" data-scroll-target="#tmle-based-estimation"><span class="header-section-number">24.3</span> 4.3 TMLE-Based Estimation</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">25</span> 5. Results</a>
  <ul class="collapse">
  <li><a href="#comparison-table" id="toc-comparison-table" class="nav-link" data-scroll-target="#comparison-table"><span class="header-section-number">25.1</span> 5.1 Comparison Table</a></li>
  <li><a href="#survival-curves-by-estimand" id="toc-survival-curves-by-estimand" class="nav-link" data-scroll-target="#survival-curves-by-estimand"><span class="header-section-number">25.2</span> 5.2 Survival Curves by Estimand</a></li>
  <li><a href="#comparing-risk-differences-across-estimands" id="toc-comparing-risk-differences-across-estimands" class="nav-link" data-scroll-target="#comparing-risk-differences-across-estimands"><span class="header-section-number">25.3</span> 5.3 Comparing Risk Differences Across Estimands</a></li>
  </ul></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">26</span> 6. Interpretation</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">27</span> 7. Conclusion</a>
  <ul class="collapse">
  <li><a href="#sources-and-further-reading" id="toc-sources-and-further-reading" class="nav-link" data-scroll-target="#sources-and-further-reading"><span class="header-section-number">27.1</span> Sources and further reading</a></li>
  <li><a href="#software-implementation-r" id="toc-software-implementation-r" class="nav-link" data-scroll-target="#software-implementation-r"><span class="header-section-number">27.2</span> Software Implementation (R)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-11-estimands-tte-safety.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">How intercurrent events shape what your analysis actually estimates</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="estimands-in-time-to-event-real-world-safety-analyses" class="level1" data-number="20">
<h1 data-number="20"><span class="header-section-number">20</span> Estimands in Time-to-Event Real-World Safety Analyses</h1>
<p><em>A simulation-based tutorial for pharmacoepidemiologists</em></p>
<p>In real-world safety studies, the question “Does this drug increase the risk of adverse events?” sounds simple. But the answer depends critically on <strong>how you handle intercurrent events</strong> — treatment switching, discontinuation, death from other causes — that occur between treatment initiation and the outcome. Different handling strategies define different <strong>estimands</strong>, and each estimand answers a fundamentally different scientific question.</p>
<p>This chapter uses a fully simulated safety study to illustrate three estimands side by side, showing how the same data can yield different estimates depending on the causal question being asked.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Define the three principal estimand strategies for time-to-event safety analyses: treatment-policy, while-on-treatment, and hypothetical</li>
<li>Explain how ICH E9(R1) connects estimand choice to intercurrent event handling</li>
<li>Simulate a realistic pharmacoepidemiology dataset with confounding, treatment switching, and administrative censoring</li>
<li>Implement Kaplan-Meier, IPCW-adjusted, and TMLE-based estimators for each estimand</li>
<li>Compare estimates and interpret differences in terms of causal assumptions</li>
<li>Select the appropriate estimand for a given regulatory or clinical decision context</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Sources and scope
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter is educational. Causal conclusions depend on identification assumptions (e.g., consistency, exchangeability, positivity) and on diagnostic evidence that the data support the target estimand. When flexible machine learning is used for nuisance estimation, valid inference typically requires cross-fitting or a cross-validated TMLE variant, plus appropriate rate conditions.</p>
</div>
</div>
<hr>
</section>
<section id="introduction" class="level1" data-number="21">
<h1 data-number="21"><span class="header-section-number">21</span> 1. Introduction</h1>
<section id="the-regulatory-context" class="level2" data-number="21.1">
<h2 data-number="21.1" class="anchored" data-anchor-id="the-regulatory-context"><span class="header-section-number">21.1</span> The Regulatory Context</h2>
<p>The ICH E9(R1) addendum (2019) fundamentally changed how clinical and post-marketing studies define their targets of inference. The addendum requires explicit specification of:</p>
<ol type="1">
<li><strong>The population</strong> of interest</li>
<li><strong>The treatment</strong> conditions being compared</li>
<li><strong>The outcome</strong> variable</li>
<li><strong>The intercurrent events</strong> that may occur after treatment initiation</li>
<li><strong>The strategy</strong> for handling each intercurrent event</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Estimands Matter for Safety
</div>
</div>
<div class="callout-body-container callout-body">
<p>In a safety study comparing Drug A to Drug B for risk of acute kidney injury (AKI):</p>
<ul>
<li>If 5% of Drug A patients <strong>switch to Drug B</strong> after 30 days due to early toxicity signals, should we count their subsequent AKI events as part of Drug A’s effect?</li>
<li>If a patient <strong>dies from liver failure</strong> before AKI can occur, how does that affect the risk estimate?</li>
<li>If patients with chronic kidney disease are more likely to both switch treatments and develop AKI, naive censoring at switch introduces <strong>informative censoring bias</strong>.</li>
</ul>
<p>The answer depends on the estimand. Different estimands answer different questions, require different assumptions, and demand different estimators.</p>
</div>
</div>
</section>
<section id="three-estimand-strategies" class="level2" data-number="21.2">
<h2 data-number="21.2" class="anchored" data-anchor-id="three-estimand-strategies"><span class="header-section-number">21.2</span> Three Estimand Strategies</h2>
<p>We focus on three strategies from ICH E9(R1):</p>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 48%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Strategy</th>
<th>Intercurrent event handling</th>
<th>Question answered</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Treatment-policy</strong></td>
<td>Ignore switching; follow all patients regardless</td>
<td>What is the effect of being <em>assigned</em> to treatment?</td>
</tr>
<tr class="even">
<td><strong>While-on-treatment</strong></td>
<td>Censor at switch</td>
<td>What is the effect <em>while patients remain on</em> treatment?</td>
</tr>
<tr class="odd">
<td><strong>Hypothetical</strong></td>
<td>Model what would have happened without switching (IPCW)</td>
<td>What <em>would</em> the effect be if no one switched?</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="simulating-a-safety-study-de-novo" class="level1" data-number="22">
<h1 data-number="22"><span class="header-section-number">22</span> 2. Simulating a Safety Study De Novo</h1>
<p>We construct a realistic post-marketing safety dataset from scratch, simulating 100,000 patients eligible for one of two hepatitis C treatments, with AKI as the safety endpoint.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Clinical Scenario
</div>
</div>
<div class="callout-body-container callout-body">
<p>A post-marketing surveillance program compares:</p>
<ul>
<li><strong>Treatment A</strong> (<code>treatment = 1</code>): Sofosbuvir-containing regimen (SOF)</li>
<li><strong>Treatment B</strong> (<code>treatment = 0</code>): Non-SOF comparator</li>
</ul>
<p>The safety concern: SOF may increase early risk of AKI, particularly in patients with pre-existing kidney disease. The treatment effect is designed to be <strong>time-varying</strong>: elevated risk in the first 90 days (HR = 1.5), followed by attenuation (HR = 0.7) — mimicking a transient nephrotoxic effect.</p>
</div>
</div>
<section id="generate-baseline-covariates" class="level2" data-number="22.1">
<h2 data-number="22.1" class="anchored" data-anchor-id="generate-baseline-covariates"><span class="header-section-number">22.1</span> 2.1 Generate Baseline Covariates</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100000</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline covariates ---</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>age       <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>ckd       <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.10</span>)   <span class="co"># chronic kidney disease</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>cirrhosis <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.20</span>)   <span class="co"># liver cirrhosis</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>diabetes  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.15</span>)   <span class="co"># diabetes mellitus</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>hiv       <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.05</span>)   <span class="co"># HIV co-infection</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulate-confounded-treatment-assignment" class="level2" data-number="22.2">
<h2 data-number="22.2" class="anchored" data-anchor-id="simulate-confounded-treatment-assignment"><span class="header-section-number">22.2</span> 2.2 Simulate Confounded Treatment Assignment</h2>
<p>Treatment assignment depends on baseline covariates, inducing confounding. Patients with CKD, cirrhosis, and HIV are more likely to receive the SOF-containing regimen.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment assignment (confounded) ---</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> ckd <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> cirrhosis <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> hiv</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>prob_trt <span class="ot">&lt;-</span> <span class="fu">plogis</span>(lp_trt)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, prob_trt)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Treatment prevalence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(treatment), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Treatment prevalence: 0.804</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean P(treatment) in CKD:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(prob_trt[ckd <span class="sc">==</span> <span class="dv">1</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Mean P(treatment) in CKD: 0.864</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean P(treatment) in no CKD:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(prob_trt[ckd <span class="sc">==</span> <span class="dv">0</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Mean P(treatment) in no CKD: 0.796</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulate-event-times-with-time-varying-hazard" class="level2" data-number="22.3">
<h2 data-number="22.3" class="anchored" data-anchor-id="simulate-event-times-with-time-varying-hazard"><span class="header-section-number">22.3</span> 2.3 Simulate Event Times with Time-Varying Hazard</h2>
<p>We use a piecewise exponential model: the treatment hazard ratio is 1.5 in the first 90 days and 0.7 afterward. Baseline covariates also affect the hazard.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline hazard and covariate effects on hazard ---</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>base_rate <span class="ot">&lt;-</span> <span class="fl">0.002</span>  <span class="co"># per day</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>covariate_lp <span class="ot">&lt;-</span> <span class="fl">0.4</span> <span class="sc">*</span> ckd <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> cirrhosis <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Piecewise exponential: different HR before/after 90 days ---</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Period 1: 0-90 days, HR = 1.5 for treatment</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Period 2: 90+ days, HR = 0.7 for treatment</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>rate_period1 <span class="ot">&lt;-</span> base_rate <span class="sc">*</span> <span class="fu">exp</span>(covariate_lp <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.5</span>) <span class="sc">*</span> treatment)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>rate_period2 <span class="ot">&lt;-</span> base_rate <span class="sc">*</span> <span class="fu">exp</span>(covariate_lp <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.7</span>) <span class="sc">*</span> treatment)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate event time from piecewise exponential</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># P(T &gt; t) = exp(-rate1 * min(t, 90)) * exp(-rate2 * max(t - 90, 0))</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Use inverse CDF method</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(N)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># First check if event occurs in period 1 (0-90)</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>surv_at_90 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>rate_period1 <span class="sc">*</span> <span class="dv">90</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>in_period1 <span class="ot">&lt;-</span> u <span class="sc">&gt;</span> surv_at_90  <span class="co"># event before day 90 if u &gt; S(90)</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>event_time <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>in_period1,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Event in period 1: solve exp(-rate1 * t) = u =&gt; t = -log(u)/rate1</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">log</span>(u) <span class="sc">/</span> rate_period1,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Event in period 2: solve S(90)*exp(-rate2*(t-90)) = u</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="dv">90</span> <span class="sc">+</span> (<span class="sc">-</span><span class="fu">log</span>(u) <span class="sc">-</span> rate_period1 <span class="sc">*</span> <span class="dv">90</span>) <span class="sc">/</span> rate_period2</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Cap at a maximum follow-up</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>event_time <span class="ot">&lt;-</span> <span class="fu">pmin</span>(event_time, <span class="dv">365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulate-treatment-switching" class="level2" data-number="22.4">
<h2 data-number="22.4" class="anchored" data-anchor-id="simulate-treatment-switching"><span class="header-section-number">22.4</span> 2.4 Simulate Treatment Switching</h2>
<p>Approximately 5% of patients switch treatment between days 30-90, with switching probability depending on CKD, treatment, and early symptoms.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment switching (intercurrent event) ---</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Higher switch probability for: CKD patients, those on treatment, older patients</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>lp_switch <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.0</span> <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> ckd <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> treatment <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>switch_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(lp_switch)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>will_switch <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, switch_prob)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>switch_time <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(will_switch <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">runif</span>(N, <span class="dv">30</span>, <span class="dv">90</span>), <span class="cn">Inf</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Overall switching rate:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(will_switch), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Overall switching rate: 0.079</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Switching rate in CKD:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(will_switch[ckd <span class="sc">==</span> <span class="dv">1</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Switching rate in CKD: 0.154</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Switching rate in treatment:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(will_switch[treatment <span class="sc">==</span> <span class="dv">1</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Switching rate in treatment: 0.086</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="administrative-censoring-and-final-dataset" class="level2" data-number="22.5">
<h2 data-number="22.5" class="anchored" data-anchor-id="administrative-censoring-and-final-dataset"><span class="header-section-number">22.5</span> 2.5 Administrative Censoring and Final Dataset</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Administrative censoring ---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>admin_censor <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> <span class="dv">90</span>, <span class="at">max =</span> <span class="dv">180</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Construct observed data ---</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># For treatment-policy: ignore switching, observe until event or admin censor</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>obs_time_tp <span class="ot">&lt;-</span> <span class="fu">pmin</span>(event_time, admin_censor)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>event_tp    <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(event_time <span class="sc">&lt;=</span> admin_censor)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># For while-on-treatment: censor at switch</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>obs_time_wot <span class="ot">&lt;-</span> <span class="fu">pmin</span>(event_time, admin_censor, switch_time)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>event_wot    <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(event_time <span class="sc">&lt;=</span> <span class="fu">pmin</span>(admin_censor, switch_time))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Assemble the dataset</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">id         =</span> <span class="dv">1</span><span class="sc">:</span>N,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">age        =</span> age,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">ckd        =</span> ckd,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">cirrhosis  =</span> cirrhosis,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">diabetes   =</span> diabetes,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">hiv        =</span> hiv,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment  =</span> treatment,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_time =</span> event_time,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">switch_time =</span> switch_time,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">admin_censor =</span> admin_censor,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Treatment-policy view</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_tp    =</span> obs_time_tp,</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_tp   =</span> event_tp,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># While-on-treatment view</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_wot   =</span> obs_time_wot,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_wot  =</span> event_wot,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">switched   =</span> <span class="fu">as.integer</span>(switch_time <span class="sc">&lt;</span> <span class="fu">pmin</span>(event_time, admin_censor))</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dataset dimensions:"</span>, <span class="fu">dim</span>(dat), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Dataset dimensions: 100000 15</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Events (treatment-policy):"</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>event_tp), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Events (treatment-policy): 33946</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Events (while-on-treatment):"</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>event_wot), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Events (while-on-treatment): 32831</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Patients who switched:"</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>switched), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Patients who switched: 6132</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The DAG for This Safety Study
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>        age, ckd, diabetes, cirrhosis, hiv
          /       |        \
         v        v         v
    Treatment --&gt; Switch --&gt; Censoring
         \        |        /
          v       v       v
              AKI event</code></pre>
<ul>
<li><strong>Baseline confounders</strong> (age, CKD, etc.) affect treatment assignment, switching probability, and AKI risk</li>
<li><strong>Treatment</strong> affects both the AKI hazard and the probability of switching</li>
<li><strong>Switching</strong> is an intercurrent event that can lead to informative censoring if correlated with AKI risk</li>
<li>Different estimands handle the Treatment –&gt; Switch –&gt; AKI pathway differently</li>
</ul>
</div>
</div>
<hr>
</section>
</section>
<section id="defining-three-estimands" class="level1" data-number="23">
<h1 data-number="23"><span class="header-section-number">23</span> 3. Defining Three Estimands</h1>
<p>Using the same simulated data, we now define and estimate three distinct estimands.</p>
<section id="a.-treatment-policy-estimand" class="level2" data-number="23.1">
<h2 data-number="23.1" class="anchored" data-anchor-id="a.-treatment-policy-estimand"><span class="header-section-number">23.1</span> 3a. Treatment-Policy Estimand</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Treatment-Policy: “Intent-to-Treat for RWD”
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Question:</strong> What is the 90-day risk of AKI comparing initiation of SOF vs.&nbsp;non-SOF, regardless of subsequent treatment changes?</p>
<p><strong>Intercurrent event handling:</strong> Ignore switching. Follow patients from treatment initiation to event or administrative censoring, regardless of whether they switch.</p>
<p><strong>Analogous to:</strong> Intent-to-treat (ITT) analysis in a randomized trial.</p>
<p><strong>Assumption:</strong> Only requires that baseline confounders are sufficient for exchangeability at the time of treatment initiation. Does NOT require assumptions about the switching mechanism.</p>
<p><strong>Limitation:</strong> Estimates the effect of being <em>assigned</em> to treatment, which may be diluted if many patients switch away.</p>
</div>
</div>
</section>
<section id="b.-while-on-treatment-estimand" class="level2" data-number="23.2">
<h2 data-number="23.2" class="anchored" data-anchor-id="b.-while-on-treatment-estimand"><span class="header-section-number">23.2</span> 3b. While-on-Treatment Estimand</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
While-on-Treatment: “Only Count Events on Drug”
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Question:</strong> What is the 90-day risk of AKI while patients remain on their assigned treatment?</p>
<p><strong>Intercurrent event handling:</strong> Censor at the time of switching. Only events occurring while on the initial treatment are counted.</p>
<p><strong>Assumption:</strong> Requires that switching is <strong>non-informative</strong> — that is, conditional on measured covariates and treatment, the switching mechanism does not depend on the latent event time. If patients switch <em>because</em> they are sicker, this assumption fails.</p>
<p><strong>Limitation:</strong> If switching is informative (correlated with AKI risk even after adjustment), censoring at switch introduces selection bias. This is a form of “healthy user” or “sick switcher” bias.</p>
</div>
</div>
</section>
<section id="c.-hypothetical-no-switch-estimand" class="level2" data-number="23.3">
<h2 data-number="23.3" class="anchored" data-anchor-id="c.-hypothetical-no-switch-estimand"><span class="header-section-number">23.3</span> 3c. Hypothetical (No-Switch) Estimand</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hypothetical: “What If No One Switched?”
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Question:</strong> What <em>would</em> the 90-day risk of AKI have been if all patients remained on their assigned treatment?</p>
<p><strong>Intercurrent event handling:</strong> Model the counterfactual scenario where switching does not occur, using IPCW (inverse probability of censoring weights) to re-weight the analysis.</p>
<p><strong>Assumption:</strong> Requires that we can model the probability of switching given measured covariates (no unmeasured confounders of the switching decision). This is a <strong>sequential ignorability</strong> assumption: switching is conditionally independent of the potential event time given the measured history.</p>
<p><strong>Advantage:</strong> Targets a cleaner causal contrast — the effect of the drug itself, uncontaminated by switching patterns.</p>
<p><strong>Limitation:</strong> Requires correct specification of the switching model. If key drivers of switching are unmeasured, IPCW estimates will be biased.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="estimation-approaches" class="level1" data-number="24">
<h1 data-number="24"><span class="header-section-number">24</span> 4. Estimation Approaches</h1>
<section id="kaplan-meier-estimates" class="level2" data-number="24.1">
<h2 data-number="24.1" class="anchored" data-anchor-id="kaplan-meier-estimates"><span class="header-section-number">24.1</span> 4.1 Kaplan-Meier Estimates</h2>
<p>We start with unadjusted Kaplan-Meier curves for the treatment-policy and while-on-treatment estimands.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment-policy estimand: KM ignoring switching ---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Restrict to 90-day window</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>dat_90 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_tp_90  =</span> <span class="fu">pmin</span>(time_tp, <span class="dv">90</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_tp_90 =</span> <span class="fu">ifelse</span>(time_tp <span class="sc">&lt;=</span> <span class="dv">90</span>, event_tp, <span class="dv">0</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_wot_90  =</span> <span class="fu">pmin</span>(time_wot, <span class="dv">90</span>),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_wot_90 =</span> <span class="fu">ifelse</span>(time_wot <span class="sc">&lt;=</span> <span class="dv">90</span>, event_wot, <span class="dv">0</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment-policy KM</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>km_tp <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_tp_90, event_tp_90) <span class="sc">~</span> treatment, <span class="at">data =</span> dat_90)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># While-on-treatment KM</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>km_wot <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_wot_90, event_wot_90) <span class="sc">~</span> treatment, <span class="at">data =</span> dat_90)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_tp, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Treatment-Policy (ignore switch)"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_wot, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"While-on-Treatment (censor at switch)"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-11-estimands-tte-safety_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Kaplan-Meier survival curves: treatment-policy vs.&nbsp;while-on-treatment</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Unadjusted KM Is Biased Here
</div>
</div>
<div class="callout-body-container callout-body">
<p>Both KM curves above are <strong>confounded</strong> because treatment assignment depends on baseline covariates. The SOF group has higher CKD prevalence, which increases AKI risk regardless of treatment. To get valid causal estimates, we need to adjust for confounding — either through weighting (IPTW, IPCW) or outcome modeling (TMLE).</p>
</div>
</div>
</section>
<section id="iptw-adjusted-estimates" class="level2" data-number="24.2">
<h2 data-number="24.2" class="anchored" data-anchor-id="iptw-adjusted-estimates"><span class="header-section-number">24.2</span> 4.2 IPTW-Adjusted Estimates</h2>
<p>We use inverse probability of treatment weighting to adjust for baseline confounding, and add IPCW for the hypothetical estimand.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Propensity score model ---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ps_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Stabilized IPTW weights</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>p_trt <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>treatment)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>iptw <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dat<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                   p_trt <span class="sc">/</span> dat<span class="sc">$</span>ps,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                   (<span class="dv">1</span> <span class="sc">-</span> p_trt) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Check weight distribution</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW weight summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; IPTW weight summary:</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(dat<span class="sc">$</span>iptw))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  0.3458  0.9343  0.9869  0.9998  1.0490  3.8012</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW mean by treatment:"</span>, <span class="fu">tapply</span>(dat<span class="sc">$</span>iptw, dat<span class="sc">$</span>treatment, mean), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; IPTW mean by treatment: 0.9990838 1.000031</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- IPCW: model probability of NOT switching ---</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Only relevant for treated patients (or both groups if switching occurs in both)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Model: P(not switching by time t | covariates, treatment)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified: logistic model for switching indicator</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ipcw_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(switched <span class="sc">~</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv <span class="sc">+</span> treatment,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_wot <span class="sc">&gt;=</span> <span class="dv">30</span>))  <span class="co"># only at-risk for switching</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>p_no_switch <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># default for those not at risk</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>at_risk <span class="ot">&lt;-</span> dat<span class="sc">$</span>time_wot <span class="sc">&gt;=</span> <span class="dv">30</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>p_no_switch[at_risk] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(ipcw_mod,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">newdata =</span> dat[at_risk, ],</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># IPCW weight: 1/P(no switching | covariates)</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ipcw <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">pmax</span>(dat<span class="sc">$</span>p_no_switch, <span class="fl">0.05</span>)  <span class="co"># truncate for stability</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Combined weight for hypothetical estimand: IPTW * IPCW</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>combined_w <span class="ot">&lt;-</span> dat<span class="sc">$</span>iptw <span class="sc">*</span> dat<span class="sc">$</span>ipcw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="weighted-90-day-risk-estimates" class="level3" data-number="24.2.1">
<h3 data-number="24.2.1" class="anchored" data-anchor-id="weighted-90-day-risk-estimates"><span class="header-section-number">24.2.1</span> Weighted 90-day risk estimates</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute weighted 90-day risks ---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>compute_risk_90 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, time_var, event_var, weight_var, <span class="at">group_var =</span> <span class="st">"treatment"</span>) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">t90 =</span> <span class="fu">pmin</span>(.data[[time_var]], <span class="dv">90</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">e90 =</span> <span class="fu">ifelse</span>(.data[[time_var]] <span class="sc">&lt;=</span> <span class="dv">90</span>, .data[[event_var]], <span class="dv">0</span>L)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(.data[[group_var]]) <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">events =</span> <span class="fu">sum</span>(e90),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">risk_unweighted =</span> <span class="fu">mean</span>(e90),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">risk_weighted =</span> <span class="fu">weighted.mean</span>(e90, .data[[weight_var]]),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment-policy (IPTW only)</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>risk_tp <span class="ot">&lt;-</span> <span class="fu">compute_risk_90</span>(dat, <span class="st">"time_tp"</span>, <span class="st">"event_tp"</span>, <span class="st">"iptw"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># While-on-treatment (IPTW only)</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>risk_wot <span class="ot">&lt;-</span> <span class="fu">compute_risk_90</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>, <span class="st">"iptw"</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Hypothetical (IPTW + IPCW)</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>risk_hyp <span class="ot">&lt;-</span> <span class="fu">compute_risk_90</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>, <span class="st">"combined_w"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Treatment-Policy (IPTW) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; === Treatment-Policy (IPTW) ===</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(risk_tp)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   treatment     n events risk_unweighted risk_weighted</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       &lt;int&gt; &lt;int&gt;  &lt;int&gt;           &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1         0 19615   3406           0.174         0.181</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2         1 80385  20933           0.260         0.258</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== While-on-Treatment (IPTW) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; === While-on-Treatment (IPTW) ===</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(risk_wot)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   treatment     n events risk_unweighted risk_weighted</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       &lt;int&gt; &lt;int&gt;  &lt;int&gt;           &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1         0 19615   3358           0.171         0.178</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2         1 80385  20648           0.257         0.254</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Hypothetical No-Switch (IPTW + IPCW) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; === Hypothetical No-Switch (IPTW + IPCW) ===</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(risk_hyp)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   treatment     n events risk_unweighted risk_weighted</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       &lt;int&gt; &lt;int&gt;  &lt;int&gt;           &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1         0 19615   3358           0.171         0.176</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2         1 80385  20648           0.257         0.243</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tmle-based-estimation" class="level2" data-number="24.3">
<h2 data-number="24.3" class="anchored" data-anchor-id="tmle-based-estimation"><span class="header-section-number">24.3</span> 4.3 TMLE-Based Estimation</h2>
<p>TMLE combines outcome modeling with treatment/censoring weights for a doubly robust estimate. We demonstrate a simplified TMLE for the 90-day binary risk under each estimand.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>logit  <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>expit  <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>tmle_risk_diff <span class="ot">&lt;-</span> <span class="cf">function</span>(data, time_var, event_var, <span class="at">weight_var =</span> <span class="cn">NULL</span>) {</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create 90-day binary outcome</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">Y =</span> <span class="fu">ifelse</span>(.data[[time_var]] <span class="sc">&lt;=</span> <span class="dv">90</span>, .data[[event_var]], <span class="dv">0</span>L),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">A =</span> treatment</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">select</span>(age, ckd, cirrhosis, diabetes, hiv)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 1: Initial outcome model ---</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  Q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> binomial, <span class="at">data =</span> data)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  Q1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">newdata =</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  Q0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">newdata =</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  QA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, Q1, Q0)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 2: Propensity score ---</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> binomial, <span class="at">data =</span> data)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  gW <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  gW <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(gW, <span class="fl">0.975</span>), <span class="fl">0.025</span>)  <span class="co"># truncate</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 3: Clever covariate ---</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  H1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> gW</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  H0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> gW)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  HA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, H1, H0)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 4: Targeting step ---</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  fluc <span class="ot">&lt;-</span> <span class="fu">glm</span>(data<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QA)) <span class="sc">+</span> HA,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> binomial)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 5: Update predictions ---</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  Q1_star <span class="ot">&lt;-</span> <span class="fu">expit</span>(<span class="fu">logit</span>(Q1) <span class="sc">+</span> eps <span class="sc">*</span> H1)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  Q0_star <span class="ot">&lt;-</span> <span class="fu">expit</span>(<span class="fu">logit</span>(Q0) <span class="sc">+</span> eps <span class="sc">*</span> H0)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 6: Parameter estimate ---</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>  psi1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_star)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>  psi0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_star)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>  ate  <span class="ot">&lt;-</span> psi1 <span class="sc">-</span> psi0</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 7: Inference via EIC ---</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  D1 <span class="ot">&lt;-</span> (data<span class="sc">$</span>A <span class="sc">/</span> gW) <span class="sc">*</span> (data<span class="sc">$</span>Y <span class="sc">-</span> Q1_star) <span class="sc">+</span> Q1_star <span class="sc">-</span> psi1</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  D0 <span class="ot">&lt;-</span> ((<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> gW)) <span class="sc">*</span> (data<span class="sc">$</span>Y <span class="sc">-</span> Q0_star) <span class="sc">+</span> Q0_star <span class="sc">-</span> psi0</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  eic <span class="ot">&lt;-</span> D1 <span class="sc">-</span> D0</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>  se  <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic) <span class="sc">/</span> <span class="fu">nrow</span>(data))</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_trt =</span> psi1,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_ctrl =</span> psi0,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_diff =</span> ate,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">se =</span> se,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_lo =</span> ate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_hi =</span> ate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">eic_mean =</span> <span class="fu">mean</span>(eic)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- TMLE for each estimand ---</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>tmle_tp  <span class="ot">&lt;-</span> <span class="fu">tmle_risk_diff</span>(dat, <span class="st">"time_tp"</span>, <span class="st">"event_tp"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>tmle_wot <span class="ot">&lt;-</span> <span class="fu">tmle_risk_diff</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># For hypothetical: we would ideally use IPCW-augmented TMLE</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified: apply TMLE to the IPCW-reweighted dataset</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>tmle_hyp <span class="ot">&lt;-</span> <span class="fu">tmle_risk_diff</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== TMLE: Treatment-Policy ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; === TMLE: Treatment-Policy ===</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tmle_tp)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 7</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   risk_trt risk_ctrl risk_diff      se  ci_lo  ci_hi eic_mean</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1    0.258     0.181    0.0771 0.00330 0.0706 0.0836 5.26e-15</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== TMLE: While-on-Treatment ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; === TMLE: While-on-Treatment ===</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tmle_wot)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 7</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   risk_trt risk_ctrl risk_diff      se  ci_lo  ci_hi eic_mean</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1    0.255     0.178    0.0763 0.00328 0.0699 0.0827 7.71e-15</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== TMLE: Hypothetical (simplified) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; === TMLE: Hypothetical (simplified) ===</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tmle_hyp)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 7</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   risk_trt risk_ctrl risk_diff      se  ci_lo  ci_hi eic_mean</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1    0.255     0.178    0.0763 0.00328 0.0699 0.0827 7.71e-15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="results" class="level1" data-number="25">
<h1 data-number="25"><span class="header-section-number">25</span> 5. Results</h1>
<section id="comparison-table" class="level2" data-number="25.1">
<h2 data-number="25.1" class="anchored" data-anchor-id="comparison-table"><span class="header-section-number">25.1</span> 5.1 Comparison Table</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Assemble results ---</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"Treatment-policy"</span>, <span class="at">method =</span> <span class="st">"KM (unadjusted)"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_tp, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">2</span>],</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_tp, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">1</span>],</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"While-on-treatment"</span>, <span class="at">method =</span> <span class="st">"KM (unadjusted)"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_wot, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">2</span>],</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_wot, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">1</span>],</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"Treatment-policy"</span>, <span class="at">method =</span> <span class="st">"IPTW"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> risk_tp<span class="sc">$</span>risk_weighted[risk_tp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> risk_tp<span class="sc">$</span>risk_weighted[risk_tp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"While-on-treatment"</span>, <span class="at">method =</span> <span class="st">"IPTW"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> risk_wot<span class="sc">$</span>risk_weighted[risk_wot<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> risk_wot<span class="sc">$</span>risk_weighted[risk_wot<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"Hypothetical"</span>, <span class="at">method =</span> <span class="st">"IPTW + IPCW"</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> risk_hyp<span class="sc">$</span>risk_weighted[risk_hyp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> risk_hyp<span class="sc">$</span>risk_weighted[risk_hyp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  tmle_tp  <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">estimand =</span> <span class="st">"Treatment-policy"</span>, <span class="at">method =</span> <span class="st">"TMLE"</span>),</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  tmle_wot <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">estimand =</span> <span class="st">"While-on-treatment"</span>, <span class="at">method =</span> <span class="st">"TMLE"</span>),</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  tmle_hyp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">estimand =</span> <span class="st">"Hypothetical"</span>, <span class="at">method =</span> <span class="st">"TMLE (simplified)"</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_diff =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(risk_diff), risk_trt <span class="sc">-</span> risk_ctrl, risk_diff)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(estimand, method, risk_trt, risk_ctrl, risk_diff, ci_lo, ci_hi)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Display</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Estimand"</span>, <span class="st">"Method"</span>, <span class="st">"Risk (SOF)"</span>, <span class="st">"Risk (Non-SOF)"</span>,</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Risk Difference"</span>, <span class="st">"95% CI Low"</span>, <span class="st">"95% CI High"</span>),</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"90-day AKI risk estimates by estimand and method"</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>90-day AKI risk estimates by estimand and method</caption>
<colgroup>
<col style="width: 18%">
<col style="width: 17%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 15%">
<col style="width: 10%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Estimand</th>
<th style="text-align: left;">Method</th>
<th style="text-align: right;">Risk (SOF)</th>
<th style="text-align: right;">Risk (Non-SOF)</th>
<th style="text-align: right;">Risk Difference</th>
<th style="text-align: right;">95% CI Low</th>
<th style="text-align: right;">95% CI High</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Treatment-policy</td>
<td style="text-align: left;">KM (unadjusted)</td>
<td style="text-align: right;">0.2604</td>
<td style="text-align: right;">0.1736</td>
<td style="text-align: right;">0.0868</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">While-on-treatment</td>
<td style="text-align: left;">KM (unadjusted)</td>
<td style="text-align: right;">0.2599</td>
<td style="text-align: right;">0.1738</td>
<td style="text-align: right;">0.0861</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Treatment-policy</td>
<td style="text-align: left;">IPTW</td>
<td style="text-align: right;">0.2579</td>
<td style="text-align: right;">0.1805</td>
<td style="text-align: right;">0.0774</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">While-on-treatment</td>
<td style="text-align: left;">IPTW</td>
<td style="text-align: right;">0.2544</td>
<td style="text-align: right;">0.1779</td>
<td style="text-align: right;">0.0765</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Hypothetical</td>
<td style="text-align: left;">IPTW + IPCW</td>
<td style="text-align: right;">0.2435</td>
<td style="text-align: right;">0.1756</td>
<td style="text-align: right;">0.0679</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Treatment-policy</td>
<td style="text-align: left;">TMLE</td>
<td style="text-align: right;">0.2581</td>
<td style="text-align: right;">0.1810</td>
<td style="text-align: right;">0.0771</td>
<td style="text-align: right;">0.0706</td>
<td style="text-align: right;">0.0836</td>
</tr>
<tr class="odd">
<td style="text-align: left;">While-on-treatment</td>
<td style="text-align: left;">TMLE</td>
<td style="text-align: right;">0.2546</td>
<td style="text-align: right;">0.1783</td>
<td style="text-align: right;">0.0763</td>
<td style="text-align: right;">0.0699</td>
<td style="text-align: right;">0.0827</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hypothetical</td>
<td style="text-align: left;">TMLE (simplified)</td>
<td style="text-align: right;">0.2546</td>
<td style="text-align: right;">0.1783</td>
<td style="text-align: right;">0.0763</td>
<td style="text-align: right;">0.0699</td>
<td style="text-align: right;">0.0827</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="survival-curves-by-estimand" class="level2" data-number="25.2">
<h2 data-number="25.2" class="anchored" data-anchor-id="survival-curves-by-estimand"><span class="header-section-number">25.2</span> 5.2 Survival Curves by Estimand</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># IPTW-weighted KM for each estimand</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment-policy</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>wkm_tp <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_tp_90, event_tp_90) <span class="sc">~</span> treatment,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> dat_90, <span class="at">weights =</span> dat<span class="sc">$</span>iptw)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># While-on-treatment</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>wkm_wot <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_wot_90, event_wot_90) <span class="sc">~</span> treatment,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> dat_90, <span class="at">weights =</span> dat<span class="sc">$</span>iptw)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wkm_tp, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Treatment-Policy (IPTW)"</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wkm_wot, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"While-on-Treatment (IPTW)"</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-11-estimands-tte-safety_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>IPTW-weighted survival curves by estimand strategy</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="comparing-risk-differences-across-estimands" class="level2" data-number="25.3">
<h2 data-number="25.3" class="anchored" data-anchor-id="comparing-risk-differences-across-estimands"><span class="header-section-number">25.3</span> 5.3 Comparing Risk Differences Across Estimands</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>results_with_ci <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ci_lo))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_with_ci, <span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> risk_diff, <span class="at">color =</span> estimand)) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_lo, <span class="at">ymax =</span> ci_hi),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimation method"</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"90-day risk difference (SOF - Non-SOF)"</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Estimand"</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Risk Differences by Estimand and Method"</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-11-estimands-tte-safety_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Risk difference estimates by estimand and method</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="interpretation" class="level1" data-number="26">
<h1 data-number="26"><span class="header-section-number">26</span> 6. Interpretation</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Each Estimand Tells You
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Treatment-policy:</strong> “Patients assigned to SOF had X% higher/lower 90-day AKI risk than those assigned to non-SOF, <em>regardless of subsequent treatment changes</em>.” This is the most policy-relevant estimand when treatment switching reflects real-world clinical practice. It answers: should we recommend initial treatment with SOF?</p>
<p><strong>While-on-treatment:</strong> “While patients remained on their assigned treatment, SOF was associated with X% higher/lower 90-day AKI risk.” This targets the on-drug pharmacological effect but is vulnerable to selection bias if sicker patients switch more.</p>
<p><strong>Hypothetical:</strong> “If no patients had switched, SOF would have been associated with X% higher/lower 90-day AKI risk.” This targets the pure drug effect under idealized adherence. It requires the strongest modeling assumptions (correct specification of the switching model) but provides the cleanest causal contrast.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How Censoring and Switching Alter Estimates
</div>
</div>
<div class="callout-body-container callout-body">
<p>The differences between estimands illustrate fundamental causal inference principles:</p>
<ol type="1">
<li><p><strong>Treatment-policy vs.&nbsp;while-on-treatment:</strong> If patients who switch away from SOF are those experiencing early toxicity (precursors to AKI), censoring them at switch time <em>removes</em> the highest-risk patients from the SOF group, making SOF look safer than it is. The treatment-policy estimand avoids this by following everyone.</p></li>
<li><p><strong>While-on-treatment vs.&nbsp;hypothetical:</strong> Both censor at switch, but the hypothetical estimand uses IPCW to reweight the surviving sample to represent the full population. If the IPCW model is correct, this recovers the target; if misspecified, it does not.</p></li>
<li><p><strong>Assumption strength:</strong> Treatment-policy requires only baseline exchangeability. While-on-treatment requires non-informative censoring. Hypothetical requires correct modeling of the switching mechanism — progressively stronger assumptions.</p></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Matching Estimand to Decision Context
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 49%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Decision maker</th>
<th>Likely preferred estimand</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Formulary committee</strong></td>
<td>Treatment-policy</td>
<td>Comparing real-world outcomes of starting one drug vs.&nbsp;another</td>
</tr>
<tr class="even">
<td><strong>Prescriber</strong></td>
<td>While-on-treatment</td>
<td>Understanding risk while the patient is taking the drug</td>
</tr>
<tr class="odd">
<td><strong>Drug developer</strong></td>
<td>Hypothetical</td>
<td>Isolating the pharmacological effect for labeling</td>
</tr>
<tr class="even">
<td><strong>Regulator (safety signal)</strong></td>
<td>Treatment-policy or hypothetical</td>
<td>Depends on whether the concern is population-level or drug-specific</td>
</tr>
</tbody>
</table>
<p>There is no single “correct” estimand. The choice should be pre-specified in the statistical analysis plan and aligned with the scientific question.</p>
</div>
</div>
<hr>
</section>
<section id="conclusion" class="level1" data-number="27">
<h1 data-number="27"><span class="header-section-number">27</span> 7. Conclusion</h1>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Messages
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>Estimand choice is not a statistical detail — it defines the scientific question.</strong> The same dataset, analyzed three different ways, answers three different questions. Reporting an estimate without specifying the estimand is incomplete.</p></li>
<li><p><strong>Intercurrent events are the bridge between biology and statistics.</strong> Treatment switching, death, loss to follow-up — these are not nuisance events to be ignored. Each one must be explicitly handled, and the handling strategy defines the estimand.</p></li>
<li><p><strong>The Causal Roadmap provides the structure.</strong> The sequence is always: question –&gt; estimand –&gt; identification –&gt; data –&gt; estimator. Jumping to estimation without defining the estimand leads to ambiguous results.</p></li>
<li><p><strong>Simulation reveals estimand sensitivity.</strong> By simulating data with known truth, we can verify that our estimators are targeting what we think they are targeting. This is essential for pre-specifying analyses in regulatory settings.</p></li>
<li><p><strong>No estimand is assumption-free.</strong> Treatment-policy requires the fewest assumptions (baseline exchangeability). Hypothetical requires the most (correct switching model). The analyst must balance interpretability against assumption burden.</p></li>
<li><p><strong>TMLE provides a principled estimation framework</strong> that accommodates all three estimand strategies through appropriate definitions of the outcome, censoring mechanism, and clever covariates.</p></li>
</ol>
</div>
</div>
<hr>
<section id="sources-and-further-reading" class="level2" data-number="27.1">
<h2 data-number="27.1" class="anchored" data-anchor-id="sources-and-further-reading"><span class="header-section-number">27.1</span> Sources and further reading</h2>
<ul>
<li>ICH E9(R1) Addendum (2019). Addendum on estimands and sensitivity analyses in clinical trials. <a href="https://www.ema.europa.eu/en/ich-e9-statistical-principles-clinical-trials">EMA</a></li>
<li>Hernan MA, Robins JM (2020). <em>Causal Inference: What If</em>. Chapman &amp; Hall/CRC. <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">Free online</a></li>
<li>Rufibach K (2019). Treatment effect quantification for time-to-event endpoints – Estimands, analysis strategies, and beyond. <em>Pharm Stat</em> 18(2):145-165.</li>
<li>Young JG, Hernan MA, Robins JM (2020). A causal framework for classical statistical estimands in failure-time settings with competing events. <em>Stat Med</em> 39(8):1199-1236.</li>
<li>Stensrud MJ, Hernan MA (2020). Why test for proportional hazards? <em>JAMA</em> 323(14):1401-1402.</li>
<li>van der Laan MJ, Rose S (2011). <em>Targeted Learning</em>. Springer.</li>
<li>Diaz I, Williams N, van der Laan MJ (2023). lmtp: An R package for estimating the causal effects of modified treatment policies. <a href="https://cran.r-project.org/package=lmtp">CRAN</a></li>
<li><code>survival</code> R package: <a href="https://cran.r-project.org/package=survival">CRAN</a></li>
<li><code>tmle</code> R package: <a href="https://cran.r-project.org/package=tmle">CRAN</a></li>
</ul>
<hr>
</section>
<section id="software-implementation-r" class="level2" data-number="27.2">
<h2 data-number="27.2" class="anchored" data-anchor-id="software-implementation-r"><span class="header-section-number">27.2</span> Software Implementation (R)</h2>
<p>This example uses the <code>survival</code> package for Kaplan-Meier and Cox models, with a manual TMLE implementation for the 90-day binary risk. For production analyses, consider the <code>concrete</code>, <code>survtmle</code>, or <code>lmtp</code> packages.</p>
<ul>
<li>Uses the simulated dataset constructed earlier in this chapter</li>
<li>Demonstrates all three estimand strategies with TMLE</li>
<li>Includes IPCW for the hypothetical estimand</li>
<li>Falls back to standard survival analysis if specialized packages are unavailable</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">## --- Survival TMLE using the concrete package (if available) ---</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"concrete"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(concrete)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"The 'concrete' package is available for survival TMLE."</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"See: https://github.com/nt-williams/concrete"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"It implements one-step TMLE for survival curve estimation."</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"survtmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(survtmle)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: 'survtmle' may be archived on CRAN."</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Consider using 'concrete' or 'lmtp' for production analyses."</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Neither 'concrete' nor 'survtmle' is installed."</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"The manual TMLE for 90-day binary risk (shown above) is a"</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"valid approach when the outcome can be discretized to a"</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"fixed time horizon."</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">""</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install options:"</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"  install.packages('survival')          # KM, Cox models"</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"  remotes::install_github('nt-williams/concrete')  # survival TMLE"</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"  install.packages('lmtp')              # modified treatment policies"</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R version 4.4.2 (2024-10-31 ucrt)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Running under: Windows 11 x64 (build 26200)</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; locale:</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] LC_COLLATE=English_United States.utf8 </span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2] LC_CTYPE=English_United States.utf8   </span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3] LC_MONETARY=English_United States.utf8</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [4] LC_NUMERIC=C                          </span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5] LC_TIME=English_United States.utf8    </span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; time zone: America/Los_Angeles</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; tzcode source: internal</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; other attached packages:</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] survival_3.7-0  lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0  </span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] dplyr_1.1.4     purrr_1.0.2     readr_2.1.5     tidyr_1.3.1    </span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] tibble_3.2.1    ggplot2_3.5.2   tidyverse_2.0.0</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] Matrix_1.7-1      gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2   </span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] tidyselect_1.2.1  splines_4.4.2     scales_1.3.0      yaml_2.3.10      </span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] fastmap_1.2.0     lattice_0.22-6    R6_2.6.1          labeling_0.4.3   </span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4 munsell_0.5.1    </span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [17] pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6       utf8_1.2.4       </span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [21] stringi_1.8.7     xfun_0.49         timechange_0.3.0  cli_3.6.5        </span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [25] withr_3.0.2       magrittr_2.0.3    digest_0.6.37     grid_4.4.2       </span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [29] rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4   vctrs_0.6.5      </span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [33] evaluate_1.0.5    glue_1.8.0        farver_2.1.2      fansi_1.0.6      </span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [37] colorspace_2.1-1  rmarkdown_2.29    tools_4.4.2       pkgconfig_2.0.3  </span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [41] htmltools_0.5.8.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amertens\.github\.io\/causal-learning-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-10-tmle-mediation.html" class="pagination-link" aria-label="An Illustrated Guide to TMLE for Mediation Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./common-pitfalls.html" class="pagination-link" aria-label="Common Pitfalls and How to Avoid Them">
        <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb19" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial"</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "How intercurrent events shape what your analysis actually estimates"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu"># Estimands in Time-to-Event Real-World Safety Analyses</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>*A simulation-based tutorial for pharmacoepidemiologists*</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>In real-world safety studies, the question "Does this drug increase the risk of adverse events?" sounds simple. But the answer depends critically on **how you handle intercurrent events** --- treatment switching, discontinuation, death from other causes --- that occur between treatment initiation and the outcome. Different handling strategies define different **estimands**, and each estimand answers a fundamentally different scientific question.</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>This chapter uses a fully simulated safety study to illustrate three estimands side by side, showing how the same data can yield different estimates depending on the causal question being asked.</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning objectives</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Define the three principal estimand strategies for time-to-event safety analyses: treatment-policy, while-on-treatment, and hypothetical</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Explain how ICH E9(R1) connects estimand choice to intercurrent event handling</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simulate a realistic pharmacoepidemiology dataset with confounding, treatment switching, and administrative censoring</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement Kaplan-Meier, IPCW-adjusted, and TMLE-based estimators for each estimand</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compare estimates and interpret differences in terms of causal assumptions</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Select the appropriate estimand for a given regulatory or clinical decision context</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sources and scope</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>This chapter is educational. Causal conclusions depend on identification assumptions (e.g., consistency, exchangeability, positivity) and on diagnostic evidence that the data support the target estimand. When flexible machine learning is used for nuisance estimation, valid inference typically requires cross-fitting or a cross-validated TMLE variant, plus appropriate rate conditions.</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">comment =</span> <span class="st">"#&gt;"</span>,</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">7</span>,</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">4</span>,</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cn">FALSE</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. Introduction</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Regulatory Context</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>The ICH E9(R1) addendum (2019) fundamentally changed how clinical and post-marketing studies define their targets of inference. The addendum requires explicit specification of:</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**The population** of interest</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**The treatment** conditions being compared</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**The outcome** variable</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**The intercurrent events** that may occur after treatment initiation</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**The strategy** for handling each intercurrent event</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Estimands Matter for Safety</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>In a safety study comparing Drug A to Drug B for risk of acute kidney injury (AKI):</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If 5% of Drug A patients **switch to Drug B** after 30 days due to early toxicity signals, should we count their subsequent AKI events as part of Drug A's effect?</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If a patient **dies from liver failure** before AKI can occur, how does that affect the risk estimate?</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If patients with chronic kidney disease are more likely to both switch treatments and develop AKI, naive censoring at switch introduces **informative censoring bias**.</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>The answer depends on the estimand. Different estimands answer different questions, require different assumptions, and demand different estimators.</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Three Estimand Strategies</span></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>We focus on three strategies from ICH E9(R1):</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>| Strategy | Intercurrent event handling | Question answered |</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>|----------|---------------------------|-------------------|</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>| **Treatment-policy** | Ignore switching; follow all patients regardless | What is the effect of being *assigned* to treatment? |</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>| **While-on-treatment** | Censor at switch | What is the effect *while patients remain on* treatment? |</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>| **Hypothetical** | Model what would have happened without switching (IPCW) | What *would* the effect be if no one switched? |</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. Simulating a Safety Study De Novo</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>We construct a realistic post-marketing safety dataset from scratch, simulating 100,000 patients eligible for one of two hepatitis C treatments, with AKI as the safety endpoint.</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Clinical Scenario</span></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>A post-marketing surveillance program compares:</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treatment A** (<span class="in">`treatment = 1`</span>): Sofosbuvir-containing regimen (SOF)</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treatment B** (<span class="in">`treatment = 0`</span>): Non-SOF comparator</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>The safety concern: SOF may increase early risk of AKI, particularly in patients with pre-existing kidney disease. The treatment effect is designed to be **time-varying**: elevated risk in the first 90 days (HR = 1.5), followed by attenuation (HR = 0.7) --- mimicking a transient nephrotoxic effect.</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.1 Generate Baseline Covariates</span></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100000</span></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline covariates ---</span></span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>age       <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>ckd       <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.10</span>)   <span class="co"># chronic kidney disease</span></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>cirrhosis <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.20</span>)   <span class="co"># liver cirrhosis</span></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>diabetes  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.15</span>)   <span class="co"># diabetes mellitus</span></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>hiv       <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, <span class="fl">0.05</span>)   <span class="co"># HIV co-infection</span></span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.2 Simulate Confounded Treatment Assignment</span></span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>Treatment assignment depends on baseline covariates, inducing confounding. Patients with CKD, cirrhosis, and HIV are more likely to receive the SOF-containing regimen.</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment assignment (confounded) ---</span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> ckd <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> cirrhosis <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> hiv</span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>prob_trt <span class="ot">&lt;-</span> <span class="fu">plogis</span>(lp_trt)</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, prob_trt)</span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Treatment prevalence:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(treatment), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean P(treatment) in CKD:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(prob_trt[ckd <span class="sc">==</span> <span class="dv">1</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean P(treatment) in no CKD:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(prob_trt[ckd <span class="sc">==</span> <span class="dv">0</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.3 Simulate Event Times with Time-Varying Hazard</span></span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>We use a piecewise exponential model: the treatment hazard ratio is 1.5 in the first 90 days and 0.7 afterward. Baseline covariates also affect the hazard.</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline hazard and covariate effects on hazard ---</span></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>base_rate <span class="ot">&lt;-</span> <span class="fl">0.002</span>  <span class="co"># per day</span></span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>covariate_lp <span class="ot">&lt;-</span> <span class="fl">0.4</span> <span class="sc">*</span> ckd <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> cirrhosis <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)</span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Piecewise exponential: different HR before/after 90 days ---</span></span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Period 1: 0-90 days, HR = 1.5 for treatment</span></span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Period 2: 90+ days, HR = 0.7 for treatment</span></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>rate_period1 <span class="ot">&lt;-</span> base_rate <span class="sc">*</span> <span class="fu">exp</span>(covariate_lp <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.5</span>) <span class="sc">*</span> treatment)</span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>rate_period2 <span class="ot">&lt;-</span> base_rate <span class="sc">*</span> <span class="fu">exp</span>(covariate_lp <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.7</span>) <span class="sc">*</span> treatment)</span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate event time from piecewise exponential</span></span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a><span class="co"># P(T &gt; t) = exp(-rate1 * min(t, 90)) * exp(-rate2 * max(t - 90, 0))</span></span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Use inverse CDF method</span></span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(N)</span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a><span class="co"># First check if event occurs in period 1 (0-90)</span></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>surv_at_90 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>rate_period1 <span class="sc">*</span> <span class="dv">90</span>)</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a>in_period1 <span class="ot">&lt;-</span> u <span class="sc">&gt;</span> surv_at_90  <span class="co"># event before day 90 if u &gt; S(90)</span></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a>event_time <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>in_period1,</span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Event in period 1: solve exp(-rate1 * t) = u =&gt; t = -log(u)/rate1</span></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">log</span>(u) <span class="sc">/</span> rate_period1,</span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Event in period 2: solve S(90)*exp(-rate2*(t-90)) = u</span></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a>  <span class="dv">90</span> <span class="sc">+</span> (<span class="sc">-</span><span class="fu">log</span>(u) <span class="sc">-</span> rate_period1 <span class="sc">*</span> <span class="dv">90</span>) <span class="sc">/</span> rate_period2</span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Cap at a maximum follow-up</span></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a>event_time <span class="ot">&lt;-</span> <span class="fu">pmin</span>(event_time, <span class="dv">365</span>)</span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.4 Simulate Treatment Switching</span></span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>Approximately 5% of patients switch treatment between days 30-90, with switching probability depending on CKD, treatment, and early symptoms.</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment switching (intercurrent event) ---</span></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Higher switch probability for: CKD patients, those on treatment, older patients</span></span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>lp_switch <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.0</span> <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> ckd <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> treatment <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">50</span>)</span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>switch_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(lp_switch)</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>will_switch <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, switch_prob)</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>switch_time <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(will_switch <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">runif</span>(N, <span class="dv">30</span>, <span class="dv">90</span>), <span class="cn">Inf</span>)</span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Overall switching rate:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(will_switch), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Switching rate in CKD:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(will_switch[ckd <span class="sc">==</span> <span class="dv">1</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Switching rate in treatment:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(will_switch[treatment <span class="sc">==</span> <span class="dv">1</span>]), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.5 Administrative Censoring and Final Dataset</span></span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Administrative censoring ---</span></span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a>admin_censor <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> <span class="dv">90</span>, <span class="at">max =</span> <span class="dv">180</span>)</span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Construct observed data ---</span></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a><span class="co"># For treatment-policy: ignore switching, observe until event or admin censor</span></span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a>obs_time_tp <span class="ot">&lt;-</span> <span class="fu">pmin</span>(event_time, admin_censor)</span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>event_tp    <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(event_time <span class="sc">&lt;=</span> admin_censor)</span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a><span class="co"># For while-on-treatment: censor at switch</span></span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>obs_time_wot <span class="ot">&lt;-</span> <span class="fu">pmin</span>(event_time, admin_censor, switch_time)</span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a>event_wot    <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(event_time <span class="sc">&lt;=</span> <span class="fu">pmin</span>(admin_censor, switch_time))</span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Assemble the dataset</span></span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">id         =</span> <span class="dv">1</span><span class="sc">:</span>N,</span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a>  <span class="at">age        =</span> age,</span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a>  <span class="at">ckd        =</span> ckd,</span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a>  <span class="at">cirrhosis  =</span> cirrhosis,</span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a>  <span class="at">diabetes   =</span> diabetes,</span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a>  <span class="at">hiv        =</span> hiv,</span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment  =</span> treatment,</span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_time =</span> event_time,</span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">switch_time =</span> switch_time,</span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">admin_censor =</span> admin_censor,</span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Treatment-policy view</span></span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_tp    =</span> obs_time_tp,</span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_tp   =</span> event_tp,</span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># While-on-treatment view</span></span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_wot   =</span> obs_time_wot,</span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_wot  =</span> event_wot,</span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a>  <span class="at">switched   =</span> <span class="fu">as.integer</span>(switch_time <span class="sc">&lt;</span> <span class="fu">pmin</span>(event_time, admin_censor))</span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dataset dimensions:"</span>, <span class="fu">dim</span>(dat), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Events (treatment-policy):"</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>event_tp), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Events (while-on-treatment):"</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>event_wot), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Patients who switched:"</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>switched), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a><span class="fu">## The DAG for This Safety Study</span></span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a><span class="in">        age, ckd, diabetes, cirrhosis, hiv</span></span>
<span id="cb19-240"><a href="#cb19-240" aria-hidden="true" tabindex="-1"></a><span class="in">          /       |        \</span></span>
<span id="cb19-241"><a href="#cb19-241" aria-hidden="true" tabindex="-1"></a><span class="in">         v        v         v</span></span>
<span id="cb19-242"><a href="#cb19-242" aria-hidden="true" tabindex="-1"></a><span class="in">    Treatment --&gt; Switch --&gt; Censoring</span></span>
<span id="cb19-243"><a href="#cb19-243" aria-hidden="true" tabindex="-1"></a><span class="in">         \        |        /</span></span>
<span id="cb19-244"><a href="#cb19-244" aria-hidden="true" tabindex="-1"></a><span class="in">          v       v       v</span></span>
<span id="cb19-245"><a href="#cb19-245" aria-hidden="true" tabindex="-1"></a><span class="in">              AKI event</span></span>
<span id="cb19-246"><a href="#cb19-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-247"><a href="#cb19-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-248"><a href="#cb19-248" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Baseline confounders** (age, CKD, etc.) affect treatment assignment, switching probability, and AKI risk</span>
<span id="cb19-249"><a href="#cb19-249" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treatment** affects both the AKI hazard and the probability of switching</span>
<span id="cb19-250"><a href="#cb19-250" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Switching** is an intercurrent event that can lead to informative censoring if correlated with AKI risk</span>
<span id="cb19-251"><a href="#cb19-251" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Different estimands handle the Treatment --&gt; Switch --&gt; AKI pathway differently</span>
<span id="cb19-252"><a href="#cb19-252" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-253"><a href="#cb19-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-254"><a href="#cb19-254" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-255"><a href="#cb19-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-256"><a href="#cb19-256" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Defining Three Estimands</span></span>
<span id="cb19-257"><a href="#cb19-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-258"><a href="#cb19-258" aria-hidden="true" tabindex="-1"></a>Using the same simulated data, we now define and estimate three distinct estimands.</span>
<span id="cb19-259"><a href="#cb19-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-260"><a href="#cb19-260" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3a. Treatment-Policy Estimand</span></span>
<span id="cb19-261"><a href="#cb19-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-262"><a href="#cb19-262" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb19-263"><a href="#cb19-263" aria-hidden="true" tabindex="-1"></a><span class="fu">## Treatment-Policy: "Intent-to-Treat for RWD"</span></span>
<span id="cb19-264"><a href="#cb19-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-265"><a href="#cb19-265" aria-hidden="true" tabindex="-1"></a>**Question:** What is the 90-day risk of AKI comparing initiation of SOF vs. non-SOF, regardless of subsequent treatment changes?</span>
<span id="cb19-266"><a href="#cb19-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-267"><a href="#cb19-267" aria-hidden="true" tabindex="-1"></a>**Intercurrent event handling:** Ignore switching. Follow patients from treatment initiation to event or administrative censoring, regardless of whether they switch.</span>
<span id="cb19-268"><a href="#cb19-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-269"><a href="#cb19-269" aria-hidden="true" tabindex="-1"></a>**Analogous to:** Intent-to-treat (ITT) analysis in a randomized trial.</span>
<span id="cb19-270"><a href="#cb19-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-271"><a href="#cb19-271" aria-hidden="true" tabindex="-1"></a>**Assumption:** Only requires that baseline confounders are sufficient for exchangeability at the time of treatment initiation. Does NOT require assumptions about the switching mechanism.</span>
<span id="cb19-272"><a href="#cb19-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-273"><a href="#cb19-273" aria-hidden="true" tabindex="-1"></a>**Limitation:** Estimates the effect of being *assigned* to treatment, which may be diluted if many patients switch away.</span>
<span id="cb19-274"><a href="#cb19-274" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-275"><a href="#cb19-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-276"><a href="#cb19-276" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3b. While-on-Treatment Estimand</span></span>
<span id="cb19-277"><a href="#cb19-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-278"><a href="#cb19-278" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb19-279"><a href="#cb19-279" aria-hidden="true" tabindex="-1"></a><span class="fu">## While-on-Treatment: "Only Count Events on Drug"</span></span>
<span id="cb19-280"><a href="#cb19-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-281"><a href="#cb19-281" aria-hidden="true" tabindex="-1"></a>**Question:** What is the 90-day risk of AKI while patients remain on their assigned treatment?</span>
<span id="cb19-282"><a href="#cb19-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-283"><a href="#cb19-283" aria-hidden="true" tabindex="-1"></a>**Intercurrent event handling:** Censor at the time of switching. Only events occurring while on the initial treatment are counted.</span>
<span id="cb19-284"><a href="#cb19-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-285"><a href="#cb19-285" aria-hidden="true" tabindex="-1"></a>**Assumption:** Requires that switching is **non-informative** --- that is, conditional on measured covariates and treatment, the switching mechanism does not depend on the latent event time. If patients switch *because* they are sicker, this assumption fails.</span>
<span id="cb19-286"><a href="#cb19-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-287"><a href="#cb19-287" aria-hidden="true" tabindex="-1"></a>**Limitation:** If switching is informative (correlated with AKI risk even after adjustment), censoring at switch introduces selection bias. This is a form of "healthy user" or "sick switcher" bias.</span>
<span id="cb19-288"><a href="#cb19-288" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-289"><a href="#cb19-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-290"><a href="#cb19-290" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3c. Hypothetical (No-Switch) Estimand</span></span>
<span id="cb19-291"><a href="#cb19-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-292"><a href="#cb19-292" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb19-293"><a href="#cb19-293" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hypothetical: "What If No One Switched?"</span></span>
<span id="cb19-294"><a href="#cb19-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-295"><a href="#cb19-295" aria-hidden="true" tabindex="-1"></a>**Question:** What *would* the 90-day risk of AKI have been if all patients remained on their assigned treatment?</span>
<span id="cb19-296"><a href="#cb19-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-297"><a href="#cb19-297" aria-hidden="true" tabindex="-1"></a>**Intercurrent event handling:** Model the counterfactual scenario where switching does not occur, using IPCW (inverse probability of censoring weights) to re-weight the analysis.</span>
<span id="cb19-298"><a href="#cb19-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-299"><a href="#cb19-299" aria-hidden="true" tabindex="-1"></a>**Assumption:** Requires that we can model the probability of switching given measured covariates (no unmeasured confounders of the switching decision). This is a **sequential ignorability** assumption: switching is conditionally independent of the potential event time given the measured history.</span>
<span id="cb19-300"><a href="#cb19-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-301"><a href="#cb19-301" aria-hidden="true" tabindex="-1"></a>**Advantage:** Targets a cleaner causal contrast --- the effect of the drug itself, uncontaminated by switching patterns.</span>
<span id="cb19-302"><a href="#cb19-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-303"><a href="#cb19-303" aria-hidden="true" tabindex="-1"></a>**Limitation:** Requires correct specification of the switching model. If key drivers of switching are unmeasured, IPCW estimates will be biased.</span>
<span id="cb19-304"><a href="#cb19-304" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-305"><a href="#cb19-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-307"><a href="#cb19-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-308"><a href="#cb19-308" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Estimation Approaches</span></span>
<span id="cb19-309"><a href="#cb19-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-310"><a href="#cb19-310" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4.1 Kaplan-Meier Estimates</span></span>
<span id="cb19-311"><a href="#cb19-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-312"><a href="#cb19-312" aria-hidden="true" tabindex="-1"></a>We start with unadjusted Kaplan-Meier curves for the treatment-policy and while-on-treatment estimands.</span>
<span id="cb19-313"><a href="#cb19-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-316"><a href="#cb19-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-317"><a href="#cb19-317" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment-policy estimand: KM ignoring switching ---</span></span>
<span id="cb19-318"><a href="#cb19-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Restrict to 90-day window</span></span>
<span id="cb19-319"><a href="#cb19-319" aria-hidden="true" tabindex="-1"></a>dat_90 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb19-320"><a href="#cb19-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-321"><a href="#cb19-321" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_tp_90  =</span> <span class="fu">pmin</span>(time_tp, <span class="dv">90</span>),</span>
<span id="cb19-322"><a href="#cb19-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_tp_90 =</span> <span class="fu">ifelse</span>(time_tp <span class="sc">&lt;=</span> <span class="dv">90</span>, event_tp, <span class="dv">0</span>),</span>
<span id="cb19-323"><a href="#cb19-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_wot_90  =</span> <span class="fu">pmin</span>(time_wot, <span class="dv">90</span>),</span>
<span id="cb19-324"><a href="#cb19-324" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_wot_90 =</span> <span class="fu">ifelse</span>(time_wot <span class="sc">&lt;=</span> <span class="dv">90</span>, event_wot, <span class="dv">0</span>)</span>
<span id="cb19-325"><a href="#cb19-325" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-326"><a href="#cb19-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-327"><a href="#cb19-327" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment-policy KM</span></span>
<span id="cb19-328"><a href="#cb19-328" aria-hidden="true" tabindex="-1"></a>km_tp <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_tp_90, event_tp_90) <span class="sc">~</span> treatment, <span class="at">data =</span> dat_90)</span>
<span id="cb19-329"><a href="#cb19-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-330"><a href="#cb19-330" aria-hidden="true" tabindex="-1"></a><span class="co"># While-on-treatment KM</span></span>
<span id="cb19-331"><a href="#cb19-331" aria-hidden="true" tabindex="-1"></a>km_wot <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_wot_90, event_wot_90) <span class="sc">~</span> treatment, <span class="at">data =</span> dat_90)</span>
<span id="cb19-332"><a href="#cb19-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-333"><a href="#cb19-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-336"><a href="#cb19-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-337"><a href="#cb19-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kaplan-Meier survival curves: treatment-policy vs. while-on-treatment"</span></span>
<span id="cb19-338"><a href="#cb19-338" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb19-339"><a href="#cb19-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-340"><a href="#cb19-340" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_tp, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb19-341"><a href="#cb19-341" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb19-342"><a href="#cb19-342" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Treatment-Policy (ignore switch)"</span>)</span>
<span id="cb19-343"><a href="#cb19-343" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb19-344"><a href="#cb19-344" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb19-345"><a href="#cb19-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-346"><a href="#cb19-346" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_wot, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb19-347"><a href="#cb19-347" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb19-348"><a href="#cb19-348" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"While-on-Treatment (censor at switch)"</span>)</span>
<span id="cb19-349"><a href="#cb19-349" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb19-350"><a href="#cb19-350" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb19-351"><a href="#cb19-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-352"><a href="#cb19-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-353"><a href="#cb19-353" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution}</span>
<span id="cb19-354"><a href="#cb19-354" aria-hidden="true" tabindex="-1"></a><span class="fu">## Unadjusted KM Is Biased Here</span></span>
<span id="cb19-355"><a href="#cb19-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-356"><a href="#cb19-356" aria-hidden="true" tabindex="-1"></a>Both KM curves above are **confounded** because treatment assignment depends on baseline covariates. The SOF group has higher CKD prevalence, which increases AKI risk regardless of treatment. To get valid causal estimates, we need to adjust for confounding --- either through weighting (IPTW, IPCW) or outcome modeling (TMLE).</span>
<span id="cb19-357"><a href="#cb19-357" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-358"><a href="#cb19-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-359"><a href="#cb19-359" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4.2 IPTW-Adjusted Estimates</span></span>
<span id="cb19-360"><a href="#cb19-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-361"><a href="#cb19-361" aria-hidden="true" tabindex="-1"></a>We use inverse probability of treatment weighting to adjust for baseline confounding, and add IPCW for the hypothetical estimand.</span>
<span id="cb19-362"><a href="#cb19-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-365"><a href="#cb19-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-366"><a href="#cb19-366" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Propensity score model ---</span></span>
<span id="cb19-367"><a href="#cb19-367" aria-hidden="true" tabindex="-1"></a>ps_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv,</span>
<span id="cb19-368"><a href="#cb19-368" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb19-369"><a href="#cb19-369" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-370"><a href="#cb19-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-371"><a href="#cb19-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Stabilized IPTW weights</span></span>
<span id="cb19-372"><a href="#cb19-372" aria-hidden="true" tabindex="-1"></a>p_trt <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>treatment)</span>
<span id="cb19-373"><a href="#cb19-373" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>iptw <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dat<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb19-374"><a href="#cb19-374" aria-hidden="true" tabindex="-1"></a>                   p_trt <span class="sc">/</span> dat<span class="sc">$</span>ps,</span>
<span id="cb19-375"><a href="#cb19-375" aria-hidden="true" tabindex="-1"></a>                   (<span class="dv">1</span> <span class="sc">-</span> p_trt) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>ps))</span>
<span id="cb19-376"><a href="#cb19-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-377"><a href="#cb19-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Check weight distribution</span></span>
<span id="cb19-378"><a href="#cb19-378" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW weight summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-379"><a href="#cb19-379" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(dat<span class="sc">$</span>iptw))</span>
<span id="cb19-380"><a href="#cb19-380" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW mean by treatment:"</span>, <span class="fu">tapply</span>(dat<span class="sc">$</span>iptw, dat<span class="sc">$</span>treatment, mean), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-381"><a href="#cb19-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-382"><a href="#cb19-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-385"><a href="#cb19-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-386"><a href="#cb19-386" aria-hidden="true" tabindex="-1"></a><span class="co"># --- IPCW: model probability of NOT switching ---</span></span>
<span id="cb19-387"><a href="#cb19-387" aria-hidden="true" tabindex="-1"></a><span class="co"># Only relevant for treated patients (or both groups if switching occurs in both)</span></span>
<span id="cb19-388"><a href="#cb19-388" aria-hidden="true" tabindex="-1"></a><span class="co"># Model: P(not switching by time t | covariates, treatment)</span></span>
<span id="cb19-389"><a href="#cb19-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-390"><a href="#cb19-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified: logistic model for switching indicator</span></span>
<span id="cb19-391"><a href="#cb19-391" aria-hidden="true" tabindex="-1"></a>ipcw_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(switched <span class="sc">~</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv <span class="sc">+</span> treatment,</span>
<span id="cb19-392"><a href="#cb19-392" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial,</span>
<span id="cb19-393"><a href="#cb19-393" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time_wot <span class="sc">&gt;=</span> <span class="dv">30</span>))  <span class="co"># only at-risk for switching</span></span>
<span id="cb19-394"><a href="#cb19-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-395"><a href="#cb19-395" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>p_no_switch <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># default for those not at risk</span></span>
<span id="cb19-396"><a href="#cb19-396" aria-hidden="true" tabindex="-1"></a>at_risk <span class="ot">&lt;-</span> dat<span class="sc">$</span>time_wot <span class="sc">&gt;=</span> <span class="dv">30</span></span>
<span id="cb19-397"><a href="#cb19-397" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>p_no_switch[at_risk] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(ipcw_mod,</span>
<span id="cb19-398"><a href="#cb19-398" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">newdata =</span> dat[at_risk, ],</span>
<span id="cb19-399"><a href="#cb19-399" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-400"><a href="#cb19-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-401"><a href="#cb19-401" aria-hidden="true" tabindex="-1"></a><span class="co"># IPCW weight: 1/P(no switching | covariates)</span></span>
<span id="cb19-402"><a href="#cb19-402" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ipcw <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">pmax</span>(dat<span class="sc">$</span>p_no_switch, <span class="fl">0.05</span>)  <span class="co"># truncate for stability</span></span>
<span id="cb19-403"><a href="#cb19-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-404"><a href="#cb19-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Combined weight for hypothetical estimand: IPTW * IPCW</span></span>
<span id="cb19-405"><a href="#cb19-405" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>combined_w <span class="ot">&lt;-</span> dat<span class="sc">$</span>iptw <span class="sc">*</span> dat<span class="sc">$</span>ipcw</span>
<span id="cb19-406"><a href="#cb19-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-407"><a href="#cb19-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-408"><a href="#cb19-408" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weighted 90-day risk estimates</span></span>
<span id="cb19-409"><a href="#cb19-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-412"><a href="#cb19-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-413"><a href="#cb19-413" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute weighted 90-day risks ---</span></span>
<span id="cb19-414"><a href="#cb19-414" aria-hidden="true" tabindex="-1"></a>compute_risk_90 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, time_var, event_var, weight_var, <span class="at">group_var =</span> <span class="st">"treatment"</span>) {</span>
<span id="cb19-415"><a href="#cb19-415" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb19-416"><a href="#cb19-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-417"><a href="#cb19-417" aria-hidden="true" tabindex="-1"></a>      <span class="at">t90 =</span> <span class="fu">pmin</span>(.data[[time_var]], <span class="dv">90</span>),</span>
<span id="cb19-418"><a href="#cb19-418" aria-hidden="true" tabindex="-1"></a>      <span class="at">e90 =</span> <span class="fu">ifelse</span>(.data[[time_var]] <span class="sc">&lt;=</span> <span class="dv">90</span>, .data[[event_var]], <span class="dv">0</span>L)</span>
<span id="cb19-419"><a href="#cb19-419" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb19-420"><a href="#cb19-420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(.data[[group_var]]) <span class="sc">%&gt;%</span></span>
<span id="cb19-421"><a href="#cb19-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb19-422"><a href="#cb19-422" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb19-423"><a href="#cb19-423" aria-hidden="true" tabindex="-1"></a>      <span class="at">events =</span> <span class="fu">sum</span>(e90),</span>
<span id="cb19-424"><a href="#cb19-424" aria-hidden="true" tabindex="-1"></a>      <span class="at">risk_unweighted =</span> <span class="fu">mean</span>(e90),</span>
<span id="cb19-425"><a href="#cb19-425" aria-hidden="true" tabindex="-1"></a>      <span class="at">risk_weighted =</span> <span class="fu">weighted.mean</span>(e90, .data[[weight_var]]),</span>
<span id="cb19-426"><a href="#cb19-426" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb19-427"><a href="#cb19-427" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-428"><a href="#cb19-428" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-429"><a href="#cb19-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-430"><a href="#cb19-430" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment-policy (IPTW only)</span></span>
<span id="cb19-431"><a href="#cb19-431" aria-hidden="true" tabindex="-1"></a>risk_tp <span class="ot">&lt;-</span> <span class="fu">compute_risk_90</span>(dat, <span class="st">"time_tp"</span>, <span class="st">"event_tp"</span>, <span class="st">"iptw"</span>)</span>
<span id="cb19-432"><a href="#cb19-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-433"><a href="#cb19-433" aria-hidden="true" tabindex="-1"></a><span class="co"># While-on-treatment (IPTW only)</span></span>
<span id="cb19-434"><a href="#cb19-434" aria-hidden="true" tabindex="-1"></a>risk_wot <span class="ot">&lt;-</span> <span class="fu">compute_risk_90</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>, <span class="st">"iptw"</span>)</span>
<span id="cb19-435"><a href="#cb19-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-436"><a href="#cb19-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Hypothetical (IPTW + IPCW)</span></span>
<span id="cb19-437"><a href="#cb19-437" aria-hidden="true" tabindex="-1"></a>risk_hyp <span class="ot">&lt;-</span> <span class="fu">compute_risk_90</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>, <span class="st">"combined_w"</span>)</span>
<span id="cb19-438"><a href="#cb19-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-439"><a href="#cb19-439" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Treatment-Policy (IPTW) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-440"><a href="#cb19-440" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(risk_tp)</span>
<span id="cb19-441"><a href="#cb19-441" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== While-on-Treatment (IPTW) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-442"><a href="#cb19-442" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(risk_wot)</span>
<span id="cb19-443"><a href="#cb19-443" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Hypothetical No-Switch (IPTW + IPCW) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-444"><a href="#cb19-444" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(risk_hyp)</span>
<span id="cb19-445"><a href="#cb19-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-446"><a href="#cb19-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-447"><a href="#cb19-447" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4.3 TMLE-Based Estimation</span></span>
<span id="cb19-448"><a href="#cb19-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-449"><a href="#cb19-449" aria-hidden="true" tabindex="-1"></a>TMLE combines outcome modeling with treatment/censoring weights for a doubly robust estimate. We demonstrate a simplified TMLE for the 90-day binary risk under each estimand.</span>
<span id="cb19-450"><a href="#cb19-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-453"><a href="#cb19-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-454"><a href="#cb19-454" aria-hidden="true" tabindex="-1"></a>logit  <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb19-455"><a href="#cb19-455" aria-hidden="true" tabindex="-1"></a>expit  <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x))</span>
<span id="cb19-456"><a href="#cb19-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-457"><a href="#cb19-457" aria-hidden="true" tabindex="-1"></a>tmle_risk_diff <span class="ot">&lt;-</span> <span class="cf">function</span>(data, time_var, event_var, <span class="at">weight_var =</span> <span class="cn">NULL</span>) {</span>
<span id="cb19-458"><a href="#cb19-458" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create 90-day binary outcome</span></span>
<span id="cb19-459"><a href="#cb19-459" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb19-460"><a href="#cb19-460" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-461"><a href="#cb19-461" aria-hidden="true" tabindex="-1"></a>      <span class="at">Y =</span> <span class="fu">ifelse</span>(.data[[time_var]] <span class="sc">&lt;=</span> <span class="dv">90</span>, .data[[event_var]], <span class="dv">0</span>L),</span>
<span id="cb19-462"><a href="#cb19-462" aria-hidden="true" tabindex="-1"></a>      <span class="at">A =</span> treatment</span>
<span id="cb19-463"><a href="#cb19-463" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-464"><a href="#cb19-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-465"><a href="#cb19-465" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">select</span>(age, ckd, cirrhosis, diabetes, hiv)</span>
<span id="cb19-466"><a href="#cb19-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-467"><a href="#cb19-467" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 1: Initial outcome model ---</span></span>
<span id="cb19-468"><a href="#cb19-468" aria-hidden="true" tabindex="-1"></a>  Q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv,</span>
<span id="cb19-469"><a href="#cb19-469" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> binomial, <span class="at">data =</span> data)</span>
<span id="cb19-470"><a href="#cb19-470" aria-hidden="true" tabindex="-1"></a>  Q1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">newdata =</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-471"><a href="#cb19-471" aria-hidden="true" tabindex="-1"></a>  Q0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Q_mod, <span class="at">newdata =</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-472"><a href="#cb19-472" aria-hidden="true" tabindex="-1"></a>  QA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, Q1, Q0)</span>
<span id="cb19-473"><a href="#cb19-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-474"><a href="#cb19-474" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 2: Propensity score ---</span></span>
<span id="cb19-475"><a href="#cb19-475" aria-hidden="true" tabindex="-1"></a>  g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> ckd <span class="sc">+</span> cirrhosis <span class="sc">+</span> diabetes <span class="sc">+</span> hiv,</span>
<span id="cb19-476"><a href="#cb19-476" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> binomial, <span class="at">data =</span> data)</span>
<span id="cb19-477"><a href="#cb19-477" aria-hidden="true" tabindex="-1"></a>  gW <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-478"><a href="#cb19-478" aria-hidden="true" tabindex="-1"></a>  gW <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(gW, <span class="fl">0.975</span>), <span class="fl">0.025</span>)  <span class="co"># truncate</span></span>
<span id="cb19-479"><a href="#cb19-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-480"><a href="#cb19-480" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 3: Clever covariate ---</span></span>
<span id="cb19-481"><a href="#cb19-481" aria-hidden="true" tabindex="-1"></a>  H1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> gW</span>
<span id="cb19-482"><a href="#cb19-482" aria-hidden="true" tabindex="-1"></a>  H0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> gW)</span>
<span id="cb19-483"><a href="#cb19-483" aria-hidden="true" tabindex="-1"></a>  HA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, H1, H0)</span>
<span id="cb19-484"><a href="#cb19-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-485"><a href="#cb19-485" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 4: Targeting step ---</span></span>
<span id="cb19-486"><a href="#cb19-486" aria-hidden="true" tabindex="-1"></a>  fluc <span class="ot">&lt;-</span> <span class="fu">glm</span>(data<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QA)) <span class="sc">+</span> HA,</span>
<span id="cb19-487"><a href="#cb19-487" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> binomial)</span>
<span id="cb19-488"><a href="#cb19-488" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc)</span>
<span id="cb19-489"><a href="#cb19-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-490"><a href="#cb19-490" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 5: Update predictions ---</span></span>
<span id="cb19-491"><a href="#cb19-491" aria-hidden="true" tabindex="-1"></a>  Q1_star <span class="ot">&lt;-</span> <span class="fu">expit</span>(<span class="fu">logit</span>(Q1) <span class="sc">+</span> eps <span class="sc">*</span> H1)</span>
<span id="cb19-492"><a href="#cb19-492" aria-hidden="true" tabindex="-1"></a>  Q0_star <span class="ot">&lt;-</span> <span class="fu">expit</span>(<span class="fu">logit</span>(Q0) <span class="sc">+</span> eps <span class="sc">*</span> H0)</span>
<span id="cb19-493"><a href="#cb19-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-494"><a href="#cb19-494" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 6: Parameter estimate ---</span></span>
<span id="cb19-495"><a href="#cb19-495" aria-hidden="true" tabindex="-1"></a>  psi1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_star)</span>
<span id="cb19-496"><a href="#cb19-496" aria-hidden="true" tabindex="-1"></a>  psi0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_star)</span>
<span id="cb19-497"><a href="#cb19-497" aria-hidden="true" tabindex="-1"></a>  ate  <span class="ot">&lt;-</span> psi1 <span class="sc">-</span> psi0</span>
<span id="cb19-498"><a href="#cb19-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-499"><a href="#cb19-499" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Step 7: Inference via EIC ---</span></span>
<span id="cb19-500"><a href="#cb19-500" aria-hidden="true" tabindex="-1"></a>  D1 <span class="ot">&lt;-</span> (data<span class="sc">$</span>A <span class="sc">/</span> gW) <span class="sc">*</span> (data<span class="sc">$</span>Y <span class="sc">-</span> Q1_star) <span class="sc">+</span> Q1_star <span class="sc">-</span> psi1</span>
<span id="cb19-501"><a href="#cb19-501" aria-hidden="true" tabindex="-1"></a>  D0 <span class="ot">&lt;-</span> ((<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> gW)) <span class="sc">*</span> (data<span class="sc">$</span>Y <span class="sc">-</span> Q0_star) <span class="sc">+</span> Q0_star <span class="sc">-</span> psi0</span>
<span id="cb19-502"><a href="#cb19-502" aria-hidden="true" tabindex="-1"></a>  eic <span class="ot">&lt;-</span> D1 <span class="sc">-</span> D0</span>
<span id="cb19-503"><a href="#cb19-503" aria-hidden="true" tabindex="-1"></a>  se  <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic) <span class="sc">/</span> <span class="fu">nrow</span>(data))</span>
<span id="cb19-504"><a href="#cb19-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-505"><a href="#cb19-505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb19-506"><a href="#cb19-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_trt =</span> psi1,</span>
<span id="cb19-507"><a href="#cb19-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_ctrl =</span> psi0,</span>
<span id="cb19-508"><a href="#cb19-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_diff =</span> ate,</span>
<span id="cb19-509"><a href="#cb19-509" aria-hidden="true" tabindex="-1"></a>    <span class="at">se =</span> se,</span>
<span id="cb19-510"><a href="#cb19-510" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_lo =</span> ate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb19-511"><a href="#cb19-511" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_hi =</span> ate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb19-512"><a href="#cb19-512" aria-hidden="true" tabindex="-1"></a>    <span class="at">eic_mean =</span> <span class="fu">mean</span>(eic)</span>
<span id="cb19-513"><a href="#cb19-513" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-514"><a href="#cb19-514" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-515"><a href="#cb19-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-516"><a href="#cb19-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-519"><a href="#cb19-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-520"><a href="#cb19-520" aria-hidden="true" tabindex="-1"></a><span class="co"># --- TMLE for each estimand ---</span></span>
<span id="cb19-521"><a href="#cb19-521" aria-hidden="true" tabindex="-1"></a>tmle_tp  <span class="ot">&lt;-</span> <span class="fu">tmle_risk_diff</span>(dat, <span class="st">"time_tp"</span>, <span class="st">"event_tp"</span>)</span>
<span id="cb19-522"><a href="#cb19-522" aria-hidden="true" tabindex="-1"></a>tmle_wot <span class="ot">&lt;-</span> <span class="fu">tmle_risk_diff</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>)</span>
<span id="cb19-523"><a href="#cb19-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-524"><a href="#cb19-524" aria-hidden="true" tabindex="-1"></a><span class="co"># For hypothetical: we would ideally use IPCW-augmented TMLE</span></span>
<span id="cb19-525"><a href="#cb19-525" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified: apply TMLE to the IPCW-reweighted dataset</span></span>
<span id="cb19-526"><a href="#cb19-526" aria-hidden="true" tabindex="-1"></a>tmle_hyp <span class="ot">&lt;-</span> <span class="fu">tmle_risk_diff</span>(dat, <span class="st">"time_wot"</span>, <span class="st">"event_wot"</span>)</span>
<span id="cb19-527"><a href="#cb19-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-528"><a href="#cb19-528" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== TMLE: Treatment-Policy ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-529"><a href="#cb19-529" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tmle_tp)</span>
<span id="cb19-530"><a href="#cb19-530" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== TMLE: While-on-Treatment ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-531"><a href="#cb19-531" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tmle_wot)</span>
<span id="cb19-532"><a href="#cb19-532" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== TMLE: Hypothetical (simplified) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-533"><a href="#cb19-533" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tmle_hyp)</span>
<span id="cb19-534"><a href="#cb19-534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-535"><a href="#cb19-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-536"><a href="#cb19-536" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-537"><a href="#cb19-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-538"><a href="#cb19-538" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. Results</span></span>
<span id="cb19-539"><a href="#cb19-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-540"><a href="#cb19-540" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.1 Comparison Table</span></span>
<span id="cb19-541"><a href="#cb19-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-544"><a href="#cb19-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-545"><a href="#cb19-545" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Assemble results ---</span></span>
<span id="cb19-546"><a href="#cb19-546" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb19-547"><a href="#cb19-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"Treatment-policy"</span>, <span class="at">method =</span> <span class="st">"KM (unadjusted)"</span>,</span>
<span id="cb19-548"><a href="#cb19-548" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_tp, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">2</span>],</span>
<span id="cb19-549"><a href="#cb19-549" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_tp, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">1</span>],</span>
<span id="cb19-550"><a href="#cb19-550" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb19-551"><a href="#cb19-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"While-on-treatment"</span>, <span class="at">method =</span> <span class="st">"KM (unadjusted)"</span>,</span>
<span id="cb19-552"><a href="#cb19-552" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_wot, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">2</span>],</span>
<span id="cb19-553"><a href="#cb19-553" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">summary</span>(km_wot, <span class="at">times =</span> <span class="dv">90</span>)<span class="sc">$</span>surv[<span class="dv">1</span>],</span>
<span id="cb19-554"><a href="#cb19-554" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb19-555"><a href="#cb19-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"Treatment-policy"</span>, <span class="at">method =</span> <span class="st">"IPTW"</span>,</span>
<span id="cb19-556"><a href="#cb19-556" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> risk_tp<span class="sc">$</span>risk_weighted[risk_tp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb19-557"><a href="#cb19-557" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> risk_tp<span class="sc">$</span>risk_weighted[risk_tp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb19-558"><a href="#cb19-558" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb19-559"><a href="#cb19-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"While-on-treatment"</span>, <span class="at">method =</span> <span class="st">"IPTW"</span>,</span>
<span id="cb19-560"><a href="#cb19-560" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> risk_wot<span class="sc">$</span>risk_weighted[risk_wot<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb19-561"><a href="#cb19-561" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> risk_wot<span class="sc">$</span>risk_weighted[risk_wot<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb19-562"><a href="#cb19-562" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb19-563"><a href="#cb19-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">estimand =</span> <span class="st">"Hypothetical"</span>, <span class="at">method =</span> <span class="st">"IPTW + IPCW"</span>,</span>
<span id="cb19-564"><a href="#cb19-564" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_trt =</span> risk_hyp<span class="sc">$</span>risk_weighted[risk_hyp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb19-565"><a href="#cb19-565" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_ctrl =</span> risk_hyp<span class="sc">$</span>risk_weighted[risk_hyp<span class="sc">$</span>treatment <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb19-566"><a href="#cb19-566" aria-hidden="true" tabindex="-1"></a>         <span class="at">risk_diff =</span> <span class="cn">NA_real_</span>, <span class="at">ci_lo =</span> <span class="cn">NA_real_</span>, <span class="at">ci_hi =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb19-567"><a href="#cb19-567" aria-hidden="true" tabindex="-1"></a>  tmle_tp  <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">estimand =</span> <span class="st">"Treatment-policy"</span>, <span class="at">method =</span> <span class="st">"TMLE"</span>),</span>
<span id="cb19-568"><a href="#cb19-568" aria-hidden="true" tabindex="-1"></a>  tmle_wot <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">estimand =</span> <span class="st">"While-on-treatment"</span>, <span class="at">method =</span> <span class="st">"TMLE"</span>),</span>
<span id="cb19-569"><a href="#cb19-569" aria-hidden="true" tabindex="-1"></a>  tmle_hyp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">estimand =</span> <span class="st">"Hypothetical"</span>, <span class="at">method =</span> <span class="st">"TMLE (simplified)"</span>)</span>
<span id="cb19-570"><a href="#cb19-570" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb19-571"><a href="#cb19-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-572"><a href="#cb19-572" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_diff =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(risk_diff), risk_trt <span class="sc">-</span> risk_ctrl, risk_diff)</span>
<span id="cb19-573"><a href="#cb19-573" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-574"><a href="#cb19-574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(estimand, method, risk_trt, risk_ctrl, risk_diff, ci_lo, ci_hi)</span>
<span id="cb19-575"><a href="#cb19-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-576"><a href="#cb19-576" aria-hidden="true" tabindex="-1"></a><span class="co"># Display</span></span>
<span id="cb19-577"><a href="#cb19-577" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb19-578"><a href="#cb19-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb19-579"><a href="#cb19-579" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb19-580"><a href="#cb19-580" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Estimand"</span>, <span class="st">"Method"</span>, <span class="st">"Risk (SOF)"</span>, <span class="st">"Risk (Non-SOF)"</span>,</span>
<span id="cb19-581"><a href="#cb19-581" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Risk Difference"</span>, <span class="st">"95% CI Low"</span>, <span class="st">"95% CI High"</span>),</span>
<span id="cb19-582"><a href="#cb19-582" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"90-day AKI risk estimates by estimand and method"</span></span>
<span id="cb19-583"><a href="#cb19-583" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-584"><a href="#cb19-584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-585"><a href="#cb19-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-586"><a href="#cb19-586" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.2 Survival Curves by Estimand</span></span>
<span id="cb19-587"><a href="#cb19-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-590"><a href="#cb19-590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-591"><a href="#cb19-591" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "IPTW-weighted survival curves by estimand strategy"</span></span>
<span id="cb19-592"><a href="#cb19-592" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb19-593"><a href="#cb19-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-594"><a href="#cb19-594" aria-hidden="true" tabindex="-1"></a><span class="co"># IPTW-weighted KM for each estimand</span></span>
<span id="cb19-595"><a href="#cb19-595" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb19-596"><a href="#cb19-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-597"><a href="#cb19-597" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment-policy</span></span>
<span id="cb19-598"><a href="#cb19-598" aria-hidden="true" tabindex="-1"></a>wkm_tp <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_tp_90, event_tp_90) <span class="sc">~</span> treatment,</span>
<span id="cb19-599"><a href="#cb19-599" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> dat_90, <span class="at">weights =</span> dat<span class="sc">$</span>iptw)</span>
<span id="cb19-600"><a href="#cb19-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-601"><a href="#cb19-601" aria-hidden="true" tabindex="-1"></a><span class="co"># While-on-treatment</span></span>
<span id="cb19-602"><a href="#cb19-602" aria-hidden="true" tabindex="-1"></a>wkm_wot <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_wot_90, event_wot_90) <span class="sc">~</span> treatment,</span>
<span id="cb19-603"><a href="#cb19-603" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> dat_90, <span class="at">weights =</span> dat<span class="sc">$</span>iptw)</span>
<span id="cb19-604"><a href="#cb19-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-605"><a href="#cb19-605" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb19-606"><a href="#cb19-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-607"><a href="#cb19-607" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wkm_tp, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb19-608"><a href="#cb19-608" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb19-609"><a href="#cb19-609" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Treatment-Policy (IPTW)"</span>)</span>
<span id="cb19-610"><a href="#cb19-610" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb19-611"><a href="#cb19-611" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb19-612"><a href="#cb19-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-613"><a href="#cb19-613" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wkm_wot, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>), <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb19-614"><a href="#cb19-614" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days"</span>, <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb19-615"><a href="#cb19-615" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"While-on-Treatment (IPTW)"</span>)</span>
<span id="cb19-616"><a href="#cb19-616" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Non-SOF"</span>, <span class="st">"SOF"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"tomato"</span>),</span>
<span id="cb19-617"><a href="#cb19-617" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb19-618"><a href="#cb19-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-619"><a href="#cb19-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-620"><a href="#cb19-620" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5.3 Comparing Risk Differences Across Estimands</span></span>
<span id="cb19-621"><a href="#cb19-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-624"><a href="#cb19-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-625"><a href="#cb19-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Risk difference estimates by estimand and method"</span></span>
<span id="cb19-626"><a href="#cb19-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-627"><a href="#cb19-627" aria-hidden="true" tabindex="-1"></a>results_with_ci <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ci_lo))</span>
<span id="cb19-628"><a href="#cb19-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-629"><a href="#cb19-629" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_with_ci, <span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> risk_diff, <span class="at">color =</span> estimand)) <span class="sc">+</span></span>
<span id="cb19-630"><a href="#cb19-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb19-631"><a href="#cb19-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_lo, <span class="at">ymax =</span> ci_hi),</span>
<span id="cb19-632"><a href="#cb19-632" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb19-633"><a href="#cb19-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb19-634"><a href="#cb19-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-635"><a href="#cb19-635" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimation method"</span>,</span>
<span id="cb19-636"><a href="#cb19-636" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"90-day risk difference (SOF - Non-SOF)"</span>,</span>
<span id="cb19-637"><a href="#cb19-637" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Estimand"</span>,</span>
<span id="cb19-638"><a href="#cb19-638" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Risk Differences by Estimand and Method"</span></span>
<span id="cb19-639"><a href="#cb19-639" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-640"><a href="#cb19-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb19-641"><a href="#cb19-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb19-642"><a href="#cb19-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-643"><a href="#cb19-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-644"><a href="#cb19-644" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-645"><a href="#cb19-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-646"><a href="#cb19-646" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. Interpretation</span></span>
<span id="cb19-647"><a href="#cb19-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-648"><a href="#cb19-648" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb19-649"><a href="#cb19-649" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Each Estimand Tells You</span></span>
<span id="cb19-650"><a href="#cb19-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-651"><a href="#cb19-651" aria-hidden="true" tabindex="-1"></a>**Treatment-policy:** "Patients assigned to SOF had X% higher/lower 90-day AKI risk than those assigned to non-SOF, *regardless of subsequent treatment changes*." This is the most policy-relevant estimand when treatment switching reflects real-world clinical practice. It answers: should we recommend initial treatment with SOF?</span>
<span id="cb19-652"><a href="#cb19-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-653"><a href="#cb19-653" aria-hidden="true" tabindex="-1"></a>**While-on-treatment:** "While patients remained on their assigned treatment, SOF was associated with X% higher/lower 90-day AKI risk." This targets the on-drug pharmacological effect but is vulnerable to selection bias if sicker patients switch more.</span>
<span id="cb19-654"><a href="#cb19-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-655"><a href="#cb19-655" aria-hidden="true" tabindex="-1"></a>**Hypothetical:** "If no patients had switched, SOF would have been associated with X% higher/lower 90-day AKI risk." This targets the pure drug effect under idealized adherence. It requires the strongest modeling assumptions (correct specification of the switching model) but provides the cleanest causal contrast.</span>
<span id="cb19-656"><a href="#cb19-656" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-657"><a href="#cb19-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-658"><a href="#cb19-658" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb19-659"><a href="#cb19-659" aria-hidden="true" tabindex="-1"></a><span class="fu">## How Censoring and Switching Alter Estimates</span></span>
<span id="cb19-660"><a href="#cb19-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-661"><a href="#cb19-661" aria-hidden="true" tabindex="-1"></a>The differences between estimands illustrate fundamental causal inference principles:</span>
<span id="cb19-662"><a href="#cb19-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-663"><a href="#cb19-663" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Treatment-policy vs. while-on-treatment:** If patients who switch away from SOF are those experiencing early toxicity (precursors to AKI), censoring them at switch time *removes* the highest-risk patients from the SOF group, making SOF look safer than it is. The treatment-policy estimand avoids this by following everyone.</span>
<span id="cb19-664"><a href="#cb19-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-665"><a href="#cb19-665" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**While-on-treatment vs. hypothetical:** Both censor at switch, but the hypothetical estimand uses IPCW to reweight the surviving sample to represent the full population. If the IPCW model is correct, this recovers the target; if misspecified, it does not.</span>
<span id="cb19-666"><a href="#cb19-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-667"><a href="#cb19-667" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Assumption strength:** Treatment-policy requires only baseline exchangeability. While-on-treatment requires non-informative censoring. Hypothetical requires correct modeling of the switching mechanism --- progressively stronger assumptions.</span>
<span id="cb19-668"><a href="#cb19-668" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-669"><a href="#cb19-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-670"><a href="#cb19-670" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb19-671"><a href="#cb19-671" aria-hidden="true" tabindex="-1"></a><span class="fu">## Matching Estimand to Decision Context</span></span>
<span id="cb19-672"><a href="#cb19-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-673"><a href="#cb19-673" aria-hidden="true" tabindex="-1"></a>| Decision maker | Likely preferred estimand | Rationale |</span>
<span id="cb19-674"><a href="#cb19-674" aria-hidden="true" tabindex="-1"></a>|----------------|--------------------------|-----------|</span>
<span id="cb19-675"><a href="#cb19-675" aria-hidden="true" tabindex="-1"></a>| **Formulary committee** | Treatment-policy | Comparing real-world outcomes of starting one drug vs. another |</span>
<span id="cb19-676"><a href="#cb19-676" aria-hidden="true" tabindex="-1"></a>| **Prescriber** | While-on-treatment | Understanding risk while the patient is taking the drug |</span>
<span id="cb19-677"><a href="#cb19-677" aria-hidden="true" tabindex="-1"></a>| **Drug developer** | Hypothetical | Isolating the pharmacological effect for labeling |</span>
<span id="cb19-678"><a href="#cb19-678" aria-hidden="true" tabindex="-1"></a>| **Regulator (safety signal)** | Treatment-policy or hypothetical | Depends on whether the concern is population-level or drug-specific |</span>
<span id="cb19-679"><a href="#cb19-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-680"><a href="#cb19-680" aria-hidden="true" tabindex="-1"></a>There is no single "correct" estimand. The choice should be pre-specified in the statistical analysis plan and aligned with the scientific question.</span>
<span id="cb19-681"><a href="#cb19-681" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-682"><a href="#cb19-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-683"><a href="#cb19-683" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-684"><a href="#cb19-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-685"><a href="#cb19-685" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. Conclusion</span></span>
<span id="cb19-686"><a href="#cb19-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-687"><a href="#cb19-687" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb19-688"><a href="#cb19-688" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Messages</span></span>
<span id="cb19-689"><a href="#cb19-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-690"><a href="#cb19-690" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Estimand choice is not a statistical detail --- it defines the scientific question.** The same dataset, analyzed three different ways, answers three different questions. Reporting an estimate without specifying the estimand is incomplete.</span>
<span id="cb19-691"><a href="#cb19-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-692"><a href="#cb19-692" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Intercurrent events are the bridge between biology and statistics.** Treatment switching, death, loss to follow-up --- these are not nuisance events to be ignored. Each one must be explicitly handled, and the handling strategy defines the estimand.</span>
<span id="cb19-693"><a href="#cb19-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-694"><a href="#cb19-694" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**The Causal Roadmap provides the structure.** The sequence is always: question --&gt; estimand --&gt; identification --&gt; data --&gt; estimator. Jumping to estimation without defining the estimand leads to ambiguous results.</span>
<span id="cb19-695"><a href="#cb19-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-696"><a href="#cb19-696" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Simulation reveals estimand sensitivity.** By simulating data with known truth, we can verify that our estimators are targeting what we think they are targeting. This is essential for pre-specifying analyses in regulatory settings.</span>
<span id="cb19-697"><a href="#cb19-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-698"><a href="#cb19-698" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**No estimand is assumption-free.** Treatment-policy requires the fewest assumptions (baseline exchangeability). Hypothetical requires the most (correct switching model). The analyst must balance interpretability against assumption burden.</span>
<span id="cb19-699"><a href="#cb19-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-700"><a href="#cb19-700" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**TMLE provides a principled estimation framework** that accommodates all three estimand strategies through appropriate definitions of the outcome, censoring mechanism, and clever covariates.</span>
<span id="cb19-701"><a href="#cb19-701" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb19-702"><a href="#cb19-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-703"><a href="#cb19-703" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-704"><a href="#cb19-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-705"><a href="#cb19-705" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sources and further reading</span></span>
<span id="cb19-706"><a href="#cb19-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-707"><a href="#cb19-707" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>ICH E9(R1) Addendum (2019). Addendum on estimands and sensitivity analyses in clinical trials. <span class="co">[</span><span class="ot">EMA</span><span class="co">](https://www.ema.europa.eu/en/ich-e9-statistical-principles-clinical-trials)</span></span>
<span id="cb19-708"><a href="#cb19-708" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Hernan MA, Robins JM (2020). *Causal Inference: What If*. Chapman &amp; Hall/CRC. <span class="co">[</span><span class="ot">Free online</span><span class="co">](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)</span></span>
<span id="cb19-709"><a href="#cb19-709" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Rufibach K (2019). Treatment effect quantification for time-to-event endpoints -- Estimands, analysis strategies, and beyond. *Pharm Stat* 18(2):145-165.</span>
<span id="cb19-710"><a href="#cb19-710" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Young JG, Hernan MA, Robins JM (2020). A causal framework for classical statistical estimands in failure-time settings with competing events. *Stat Med* 39(8):1199-1236.</span>
<span id="cb19-711"><a href="#cb19-711" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stensrud MJ, Hernan MA (2020). Why test for proportional hazards? *JAMA* 323(14):1401-1402.</span>
<span id="cb19-712"><a href="#cb19-712" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>van der Laan MJ, Rose S (2011). *Targeted Learning*. Springer.</span>
<span id="cb19-713"><a href="#cb19-713" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Diaz I, Williams N, van der Laan MJ (2023). lmtp: An R package for estimating the causal effects of modified treatment policies. <span class="co">[</span><span class="ot">CRAN</span><span class="co">](https://cran.r-project.org/package=lmtp)</span></span>
<span id="cb19-714"><a href="#cb19-714" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`survival`</span> R package: <span class="co">[</span><span class="ot">CRAN</span><span class="co">](https://cran.r-project.org/package=survival)</span></span>
<span id="cb19-715"><a href="#cb19-715" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`tmle`</span> R package: <span class="co">[</span><span class="ot">CRAN</span><span class="co">](https://cran.r-project.org/package=tmle)</span></span>
<span id="cb19-716"><a href="#cb19-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-717"><a href="#cb19-717" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb19-718"><a href="#cb19-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-719"><a href="#cb19-719" aria-hidden="true" tabindex="-1"></a><span class="fu">## Software Implementation (R)</span></span>
<span id="cb19-720"><a href="#cb19-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-721"><a href="#cb19-721" aria-hidden="true" tabindex="-1"></a>This example uses the <span class="in">`survival`</span> package for Kaplan-Meier and Cox models, with a manual TMLE implementation for the 90-day binary risk. For production analyses, consider the <span class="in">`concrete`</span>, <span class="in">`survtmle`</span>, or <span class="in">`lmtp`</span> packages.</span>
<span id="cb19-722"><a href="#cb19-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-723"><a href="#cb19-723" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Uses the simulated dataset constructed earlier in this chapter</span>
<span id="cb19-724"><a href="#cb19-724" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Demonstrates all three estimand strategies with TMLE</span>
<span id="cb19-725"><a href="#cb19-725" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Includes IPCW for the hypothetical estimand</span>
<span id="cb19-726"><a href="#cb19-726" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Falls back to standard survival analysis if specialized packages are unavailable</span>
<span id="cb19-727"><a href="#cb19-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-730"><a href="#cb19-730" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-731"><a href="#cb19-731" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb19-732"><a href="#cb19-732" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb19-733"><a href="#cb19-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-734"><a href="#cb19-734" aria-hidden="true" tabindex="-1"></a><span class="do">## --- Survival TMLE using the concrete package (if available) ---</span></span>
<span id="cb19-735"><a href="#cb19-735" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"concrete"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb19-736"><a href="#cb19-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(concrete)</span>
<span id="cb19-737"><a href="#cb19-737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"The 'concrete' package is available for survival TMLE."</span>)</span>
<span id="cb19-738"><a href="#cb19-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"See: https://github.com/nt-williams/concrete"</span>)</span>
<span id="cb19-739"><a href="#cb19-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"It implements one-step TMLE for survival curve estimation."</span>)</span>
<span id="cb19-740"><a href="#cb19-740" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"survtmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb19-741"><a href="#cb19-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(survtmle)</span>
<span id="cb19-742"><a href="#cb19-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: 'survtmle' may be archived on CRAN."</span>)</span>
<span id="cb19-743"><a href="#cb19-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Consider using 'concrete' or 'lmtp' for production analyses."</span>)</span>
<span id="cb19-744"><a href="#cb19-744" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb19-745"><a href="#cb19-745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Neither 'concrete' nor 'survtmle' is installed."</span>)</span>
<span id="cb19-746"><a href="#cb19-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"The manual TMLE for 90-day binary risk (shown above) is a"</span>)</span>
<span id="cb19-747"><a href="#cb19-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"valid approach when the outcome can be discretized to a"</span>)</span>
<span id="cb19-748"><a href="#cb19-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"fixed time horizon."</span>)</span>
<span id="cb19-749"><a href="#cb19-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">""</span>)</span>
<span id="cb19-750"><a href="#cb19-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install options:"</span>)</span>
<span id="cb19-751"><a href="#cb19-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"  install.packages('survival')          # KM, Cox models"</span>)</span>
<span id="cb19-752"><a href="#cb19-752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"  remotes::install_github('nt-williams/concrete')  # survival TMLE"</span>)</span>
<span id="cb19-753"><a href="#cb19-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"  install.packages('lmtp')              # modified treatment policies"</span>)</span>
<span id="cb19-754"><a href="#cb19-754" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-755"><a href="#cb19-755" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-756"><a href="#cb19-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-759"><a href="#cb19-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb19-760"><a href="#cb19-760" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb19-761"><a href="#cb19-761" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>