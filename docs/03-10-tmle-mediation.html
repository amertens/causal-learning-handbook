<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A practical guide to the Causal Roadmap, Targeted Maximum Likelihood Estimation (TMLE), and Super Learner for modern causal inference in epidemiology, with emphasis on pharmacoepidemiology and clinical trial analysis.">

<title>18&nbsp; An Illustrated Guide to TMLE for Mediation Analysis – Causal Learning Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-11-estimands-tte-safety.html" rel="next">
<link href="./03-09-illustrated-ltmle.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b343bb23504f009ddf7b24643a6af19a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-10-tmle-mediation.html"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Causal Learning Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/amertens/causal-learning-handbook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Causal Learning Handbook</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-01-regression-vs-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 1.1: Limitations of Standard Regression Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-02-causal-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 1.2: The Causal Roadmap</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-03-identification-estimands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1.3: From Causal Questions to Analysis — Identification, Estimands, and Statistical Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Roadmap for Real-world Evidence Generation: A Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Estimation Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-01-gcomputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-02-iptw.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-03-doubly-robust-tmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-04-tmle-teaching-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superlearner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-03-longitudinal-case-study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-04-effect-modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-05-advanced-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-07-longitudinal-td-confounding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-08-tmle-clean-room.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-09-illustrated-ltmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-10-tmle-mediation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-11-estimands-tte-safety.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anotated_bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Annotated Bibliography: Modern Causal Inference and Targeted Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#an-illustrated-guide-to-tmle-for-mediation-analysis" id="toc-an-illustrated-guide-to-tmle-for-mediation-analysis" class="nav-link active" data-scroll-target="#an-illustrated-guide-to-tmle-for-mediation-analysis"><span class="header-section-number">19</span> An Illustrated Guide to TMLE for Mediation Analysis</a></li>
  <li><a href="#clinical-motivation" id="toc-clinical-motivation" class="nav-link" data-scroll-target="#clinical-motivation"><span class="header-section-number">20</span> 1. Clinical Motivation</a>
  <ul class="collapse">
  <li><a href="#the-pharmacoepidemiologic-question" id="toc-the-pharmacoepidemiologic-question" class="nav-link" data-scroll-target="#the-pharmacoepidemiologic-question"><span class="header-section-number">20.1</span> The Pharmacoepidemiologic Question</a></li>
  </ul></li>
  <li><a href="#mediation-analysis-the-causal-roadmap" id="toc-mediation-analysis-the-causal-roadmap" class="nav-link" data-scroll-target="#mediation-analysis-the-causal-roadmap"><span class="header-section-number">21</span> 2. Mediation Analysis: The Causal Roadmap</a>
  <ul class="collapse">
  <li><a href="#step-1-define-the-causal-question" id="toc-step-1-define-the-causal-question" class="nav-link" data-scroll-target="#step-1-define-the-causal-question"><span class="header-section-number">21.1</span> Step 1: Define the Causal Question</a></li>
  <li><a href="#step-2-the-causal-model-dag" id="toc-step-2-the-causal-model-dag" class="nav-link" data-scroll-target="#step-2-the-causal-model-dag"><span class="header-section-number">21.2</span> Step 2: The Causal Model (DAG)</a></li>
  <li><a href="#step-3-assumptions-for-mediation" id="toc-step-3-assumptions-for-mediation" class="nav-link" data-scroll-target="#step-3-assumptions-for-mediation"><span class="header-section-number">21.3</span> Step 3: Assumptions for Mediation</a></li>
  <li><a href="#step-4-statistical-estimands" id="toc-step-4-statistical-estimands" class="nav-link" data-scroll-target="#step-4-statistical-estimands"><span class="header-section-number">21.4</span> Step 4: Statistical Estimands</a></li>
  <li><a href="#step-5-why-tmle-for-mediation" id="toc-step-5-why-tmle-for-mediation" class="nav-link" data-scroll-target="#step-5-why-tmle-for-mediation"><span class="header-section-number">21.5</span> Step 5: Why TMLE for Mediation?</a></li>
  </ul></li>
  <li><a href="#data-simulation" id="toc-data-simulation" class="nav-link" data-scroll-target="#data-simulation"><span class="header-section-number">22</span> 3. Data Simulation</a>
  <ul class="collapse">
  <li><a href="#true-causal-effects" id="toc-true-causal-effects" class="nav-link" data-scroll-target="#true-causal-effects"><span class="header-section-number">22.0.1</span> True causal effects</a></li>
  </ul></li>
  <li><a href="#why-naive-approaches-fail" id="toc-why-naive-approaches-fail" class="nav-link" data-scroll-target="#why-naive-approaches-fail"><span class="header-section-number">23</span> 4. Why Naive Approaches Fail</a>
  <ul class="collapse">
  <li><a href="#a.-the-baron-kenny-trap" id="toc-a.-the-baron-kenny-trap" class="nav-link" data-scroll-target="#a.-the-baron-kenny-trap"><span class="header-section-number">23.1</span> 4A. The Baron-Kenny Trap</a></li>
  <li><a href="#b.-naive-regression-based-decomposition-on-the-risk-difference-scale" id="toc-b.-naive-regression-based-decomposition-on-the-risk-difference-scale" class="nav-link" data-scroll-target="#b.-naive-regression-based-decomposition-on-the-risk-difference-scale"><span class="header-section-number">23.2</span> 4B. Naive Regression-Based Decomposition on the Risk Difference Scale</a></li>
  </ul></li>
  <li><a href="#tmle-for-mediation-step-by-step" id="toc-tmle-for-mediation-step-by-step" class="nav-link" data-scroll-target="#tmle-for-mediation-step-by-step"><span class="header-section-number">24</span> 5. TMLE for Mediation: Step by Step</a>
  <ul class="collapse">
  <li><a href="#the-algorithm-overview" id="toc-the-algorithm-overview" class="nav-link" data-scroll-target="#the-algorithm-overview"><span class="header-section-number">24.1</span> The Algorithm Overview</a></li>
  <li><a href="#step-1-fit-the-outcome-model" id="toc-step-1-fit-the-outcome-model" class="nav-link" data-scroll-target="#step-1-fit-the-outcome-model"><span class="header-section-number">24.2</span> Step 1: Fit the Outcome Model</a></li>
  <li><a href="#step-2-fit-the-mediator-model" id="toc-step-2-fit-the-mediator-model" class="nav-link" data-scroll-target="#step-2-fit-the-mediator-model"><span class="header-section-number">24.3</span> Step 2: Fit the Mediator Model</a></li>
  <li><a href="#step-3-fit-the-treatment-model" id="toc-step-3-fit-the-treatment-model" class="nav-link" data-scroll-target="#step-3-fit-the-treatment-model"><span class="header-section-number">24.4</span> Step 3: Fit the Treatment Model</a></li>
  <li><a href="#step-4-the-mediation-clever-covariates" id="toc-step-4-the-mediation-clever-covariates" class="nav-link" data-scroll-target="#step-4-the-mediation-clever-covariates"><span class="header-section-number">24.5</span> Step 4: The Mediation Clever Covariates</a></li>
  <li><a href="#step-5-targeting-fluctuation-for-nde" id="toc-step-5-targeting-fluctuation-for-nde" class="nav-link" data-scroll-target="#step-5-targeting-fluctuation-for-nde"><span class="header-section-number">24.6</span> Step 5: Targeting (Fluctuation) for NDE</a></li>
  <li><a href="#step-6-compute-the-nde" id="toc-step-6-compute-the-nde" class="nav-link" data-scroll-target="#step-6-compute-the-nde"><span class="header-section-number">24.7</span> Step 6: Compute the NDE</a></li>
  <li><a href="#step-7-targeting-and-computing-the-nie" id="toc-step-7-targeting-and-computing-the-nie" class="nav-link" data-scroll-target="#step-7-targeting-and-computing-the-nie"><span class="header-section-number">24.8</span> Step 7: Targeting and Computing the NIE</a></li>
  </ul></li>
  <li><a href="#results-comparison" id="toc-results-comparison" class="nav-link" data-scroll-target="#results-comparison"><span class="header-section-number">25</span> 6. Results Comparison</a></li>
  <li><a href="#diagnostics-for-mediation-tmle" id="toc-diagnostics-for-mediation-tmle" class="nav-link" data-scroll-target="#diagnostics-for-mediation-tmle"><span class="header-section-number">26</span> 7. Diagnostics for Mediation TMLE</a>
  <ul class="collapse">
  <li><a href="#propensity-score-overlap" id="toc-propensity-score-overlap" class="nav-link" data-scroll-target="#propensity-score-overlap"><span class="header-section-number">26.1</span> 7.1 Propensity Score Overlap</a></li>
  <li><a href="#mediator-distribution-by-treatment" id="toc-mediator-distribution-by-treatment" class="nav-link" data-scroll-target="#mediator-distribution-by-treatment"><span class="header-section-number">26.2</span> 7.2 Mediator Distribution by Treatment</a></li>
  <li><a href="#density-ratio-distribution" id="toc-density-ratio-distribution" class="nav-link" data-scroll-target="#density-ratio-distribution"><span class="header-section-number">26.3</span> 7.3 Density Ratio Distribution</a></li>
  <li><a href="#mediator-outcome-relationship" id="toc-mediator-outcome-relationship" class="nav-link" data-scroll-target="#mediator-outcome-relationship"><span class="header-section-number">26.4</span> 7.4 Mediator-Outcome Relationship</a></li>
  </ul></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">27</span> 8. Interpretation</a>
  <ul class="collapse">
  <li><a href="#fragile-assumptions" id="toc-fragile-assumptions" class="nav-link" data-scroll-target="#fragile-assumptions"><span class="header-section-number">27.0.1</span> Fragile Assumptions</a></li>
  </ul></li>
  <li><a href="#advanced-interventional-indirect-effects" id="toc-advanced-interventional-indirect-effects" class="nav-link" data-scroll-target="#advanced-interventional-indirect-effects"><span class="header-section-number">28</span> 9. Advanced: Interventional (In)Direct Effects</a></li>
  <li><a href="#comparison-mediation-methods" id="toc-comparison-mediation-methods" class="nav-link" data-scroll-target="#comparison-mediation-methods"><span class="header-section-number">29</span> 10. Comparison: Mediation Methods</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">30</span> Key Takeaways</a>
  <ul class="collapse">
  <li><a href="#sources-and-further-reading" id="toc-sources-and-further-reading" class="nav-link" data-scroll-target="#sources-and-further-reading"><span class="header-section-number">30.1</span> Sources and further reading</a></li>
  <li><a href="#software-implementation-r" id="toc-software-implementation-r" class="nav-link" data-scroll-target="#software-implementation-r"><span class="header-section-number">30.2</span> Software Implementation (R)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-03-longitudinal-case-study.html">Part III: Advanced Topics</a></li><li class="breadcrumb-item"><a href="./03-10-tmle-mediation.html"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Decomposing total effects into direct and indirect pathways</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="an-illustrated-guide-to-tmle-for-mediation-analysis" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> An Illustrated Guide to TMLE for Mediation Analysis</h1>
<p><em>How to decompose a drug’s total effect into what works directly and what works through an intermediate mechanism</em></p>
<p>In pharmacoepidemiology, we often want to know not just <strong>whether</strong> a drug works, but <strong>how</strong> it works. Does dapagliflozin reduce cardiovascular events because it lowers blood pressure, because it improves glucose control, or through some other mechanism entirely?</p>
<p><strong>Mediation analysis</strong> decomposes a total causal effect into:</p>
<ul>
<li>A <strong>direct effect</strong> — the part of the treatment effect NOT operating through the mediator</li>
<li>An <strong>indirect effect</strong> — the part operating THROUGH the mediator</li>
</ul>
<p>TMLE provides a principled framework for this decomposition that is doubly robust and compatible with machine learning.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Define natural direct effects (NDE) and natural indirect effects (NIE) using potential outcomes</li>
<li>Explain the cross-world independence assumption and why it is required for mediation</li>
<li>Construct the density ratio clever covariates used in TMLE for mediation</li>
<li>Implement NDE and NIE estimation via Monte Carlo integration within TMLE</li>
<li>Use the <code>crumble</code> package for automated TMLE-based mediation analysis</li>
<li>Interpret decomposed effects in a pharmacoepidemiology context (e.g., drug mechanism elucidation)</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Sources and scope
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter is educational. Causal conclusions depend on identification assumptions (e.g., consistency, exchangeability, positivity) and on diagnostic evidence that the data support the target estimand. When flexible machine learning is used for nuisance estimation, valid inference typically requires cross-fitting or a cross-validated TMLE variant, plus appropriate rate conditions.</p>
</div>
</div>
<hr>
</section>
<section id="clinical-motivation" class="level1" data-number="20">
<h1 data-number="20"><span class="header-section-number">20</span> 1. Clinical Motivation</h1>
<section id="the-pharmacoepidemiologic-question" class="level2" data-number="20.1">
<h2 data-number="20.1" class="anchored" data-anchor-id="the-pharmacoepidemiologic-question"><span class="header-section-number">20.1</span> The Pharmacoepidemiologic Question</h2>
<p>SGLT2 inhibitors (like dapagliflozin) have shown surprising cardiovascular benefits in type 2 diabetes trials. The FDA and sponsor want to understand <strong>the mechanism</strong>:</p>
<blockquote class="blockquote">
<p><strong>How much of dapagliflozin’s effect on reducing MACE operates through HbA1c reduction (glycemic pathway), and how much operates through other mechanisms (e.g., blood pressure, weight loss, direct cardiac effects)?</strong></p>
</blockquote>
<p>This matters because:</p>
<ul>
<li>If the effect is entirely through glycemic control, other glucose-lowering drugs should work too</li>
<li>If the effect is mostly direct, SGLT2 inhibitors have a unique cardiovascular benefit worth highlighting in labeling</li>
<li>Understanding mechanisms guides future drug development</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Setup
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Treatment (A):</strong> Dapagliflozin vs.&nbsp;sulfonylurea</li>
<li><strong>Mediator (M):</strong> 6-month HbA1c change (glycemic improvement)</li>
<li><strong>Outcome (Y):</strong> 1-year MACE</li>
<li><strong>Confounders (W):</strong> Age, BMI, baseline HbA1c, prior CVD, eGFR, statin use</li>
<li><strong>Question:</strong> How much of the <span class="math inline">\(A \to Y\)</span> effect goes through <span class="math inline">\(A \to M \to Y\)</span>?</li>
</ul>
</div>
</div>
<hr>
</section>
</section>
<section id="mediation-analysis-the-causal-roadmap" class="level1" data-number="21">
<h1 data-number="21"><span class="header-section-number">21</span> 2. Mediation Analysis: The Causal Roadmap</h1>
<section id="step-1-define-the-causal-question" class="level2" data-number="21.1">
<h2 data-number="21.1" class="anchored" data-anchor-id="step-1-define-the-causal-question"><span class="header-section-number">21.1</span> Step 1: Define the Causal Question</h2>
<p>In mediation, we decompose the <strong>total effect</strong> into two pieces:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Total Effect = Natural Direct Effect + Natural Indirect Effect
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Total Effect (TE):</strong> <span class="math display">\[TE = E[Y(1, M(1))] - E[Y(0, M(0))]\]</span> The overall effect of treatment on outcome (what we estimated in Chapter 2.4).</p>
<p><strong>Natural Direct Effect (NDE):</strong> <span class="math display">\[NDE = E[Y(1, M(0))] - E[Y(0, M(0))]\]</span> The effect of treatment on outcome if we could <strong>hold the mediator at its control value</strong>. “What if we gave the drug but magically blocked it from changing HbA1c?”</p>
<p><strong>Natural Indirect Effect (NIE):</strong> <span class="math display">\[NIE = E[Y(1, M(1))] - E[Y(1, M(0))]\]</span> The effect of the mediator change induced by treatment, <strong>while keeping treatment on</strong>. “What if we didn’t change the drug assignment but shifted HbA1c as dapagliflozin would?”</p>
</div>
</div>
<p>The decomposition is: <span class="math inline">\(TE = NDE + NIE\)</span></p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Plain Language
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>NDE:</strong> “How much does the drug help even if it didn’t change HbA1c at all?” (the direct pathway — blood pressure, weight, cardiac remodeling, etc.)</li>
<li><strong>NIE:</strong> “How much does the drug help specifically because it lowers HbA1c?” (the glycemic pathway)</li>
</ul>
<p>If the NIE is large, glycemic control is the main mechanism. If the NDE is large, the drug works through non-glycemic pathways.</p>
</div>
</div>
</section>
<section id="step-2-the-causal-model-dag" class="level2" data-number="21.2">
<h2 data-number="21.2" class="anchored" data-anchor-id="step-2-the-causal-model-dag"><span class="header-section-number">21.2</span> Step 2: The Causal Model (DAG)</h2>
<p>The mediation DAG adds one node compared to the standard confounding DAG:</p>
<pre><code>              W (confounders)
            / | \
           /  |  \
          v   v   v
          A → M → Y
          |       ↑
          └───────┘
            (direct)</code></pre>
<ul>
<li><span class="math inline">\(W \to A\)</span>: confounders affect treatment</li>
<li><span class="math inline">\(W \to M\)</span>: confounders affect the mediator</li>
<li><span class="math inline">\(W \to Y\)</span>: confounders affect the outcome</li>
<li><span class="math inline">\(A \to M\)</span>: treatment affects the mediator (dapagliflozin lowers HbA1c)</li>
<li><span class="math inline">\(M \to Y\)</span>: the mediator affects the outcome (HbA1c affects MACE risk)</li>
<li><span class="math inline">\(A \to Y\)</span>: treatment directly affects the outcome (non-glycemic pathways)</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Critical Assumption: No Mediator-Outcome Confounding Affected by Treatment
</div>
</div>
<div class="callout-body-container callout-body">
<p>For mediation to work, there must be <strong>no confounder of the M → Y relationship that is itself affected by treatment</strong>. If treatment changes a variable <span class="math inline">\(Z\)</span> that confounds <span class="math inline">\(M \to Y\)</span>, the natural direct and indirect effects are not identifiable from observed data.</p>
<pre><code>     A → Z → M → Y       ← Z confounds M→Y AND is affected by A
              ↑
              Z ──────→ Y  ← This breaks identification!</code></pre>
<p>This is the hardest assumption in mediation analysis. In our example: does dapagliflozin change something (like blood pressure or weight) that both affects HbA1c trajectory AND independently affects MACE? If so, we need more advanced methods (interventional effects).</p>
</div>
</div>
</section>
<section id="step-3-assumptions-for-mediation" class="level2" data-number="21.3">
<h2 data-number="21.3" class="anchored" data-anchor-id="step-3-assumptions-for-mediation"><span class="header-section-number">21.3</span> Step 3: Assumptions for Mediation</h2>
<p>To identify the NDE and NIE, we need the standard confounding assumptions PLUS additional ones:</p>
<ol type="1">
<li><strong>No unmeasured treatment-outcome confounding:</strong> <span class="math inline">\(Y(a, m) \perp\!\!\!\perp A \mid W\)</span></li>
<li><strong>No unmeasured mediator-outcome confounding:</strong> <span class="math inline">\(Y(a, m) \perp\!\!\!\perp M \mid A, W\)</span></li>
<li><strong>No unmeasured treatment-mediator confounding:</strong> <span class="math inline">\(M(a) \perp\!\!\!\perp A \mid W\)</span></li>
<li><strong>Cross-world independence:</strong> No <span class="math inline">\(W\)</span>-adjusted confounder of <span class="math inline">\(M \to Y\)</span> is affected by <span class="math inline">\(A\)</span></li>
</ol>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Cross-World Problem
</div>
</div>
<div class="callout-body-container callout-body">
<p>Assumption 4 is called the “cross-world” assumption because the NDE involves a quantity <span class="math inline">\(Y(1, M(0))\)</span> — the outcome under treatment <span class="math inline">\(A = 1\)</span> with the mediator value that <strong>would have occurred</strong> under <span class="math inline">\(A = 0\)</span>. This never happens in reality; it combines potential outcomes from two different “worlds.”</p>
<p>This assumption is untestable and often debated. If you are uncomfortable with it, consider <strong>interventional (in)direct effects</strong>, which replace the cross-world assumption with a weaker one. We briefly discuss this in Section 9.</p>
</div>
</div>
</section>
<section id="step-4-statistical-estimands" class="level2" data-number="21.4">
<h2 data-number="21.4" class="anchored" data-anchor-id="step-4-statistical-estimands"><span class="header-section-number">21.4</span> Step 4: Statistical Estimands</h2>
<p>Under the assumptions above, the NDE and NIE are identified by statistical quantities:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Mediation G-Computation Formulas
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>NDE:</strong> <span class="math display">\[NDE = \sum_m \sum_w \big[E[Y \mid A=1, M=m, W=w] - E[Y \mid A=0, M=m, W=w]\big] \cdot P(M=m \mid A=0, W=w) \cdot P(W=w)\]</span></p>
<p><strong>NIE:</strong> <span class="math display">\[NIE = \sum_m \sum_w E[Y \mid A=1, M=m, W=w] \cdot \big[P(M=m \mid A=1, W=w) - P(M=m \mid A=0, W=w)\big] \cdot P(W=w)\]</span></p>
<p>These formulas require:</p>
<ul>
<li>An <strong>outcome model:</strong> <span class="math inline">\(E[Y \mid A, M, W]\)</span></li>
<li>A <strong>mediator model:</strong> <span class="math inline">\(P(M \mid A, W)\)</span></li>
<li>A <strong>treatment model:</strong> <span class="math inline">\(P(A \mid W)\)</span> (for the TMLE targeting step)</li>
</ul>
</div>
</div>
</section>
<section id="step-5-why-tmle-for-mediation" class="level2" data-number="21.5">
<h2 data-number="21.5" class="anchored" data-anchor-id="step-5-why-tmle-for-mediation"><span class="header-section-number">21.5</span> Step 5: Why TMLE for Mediation?</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 42%">
<col style="width: 57%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Limitation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Baron-Kenny regression</td>
<td>Assumes linear models, no interactions, continuous mediator</td>
</tr>
<tr class="even">
<td>Parametric G-computation</td>
<td>Works but depends on correct outcome AND mediator models</td>
</tr>
<tr class="odd">
<td>Weighting-based</td>
<td>Can be unstable with continuous mediators</td>
</tr>
<tr class="even">
<td><strong>TMLE for mediation</strong></td>
<td>Doubly robust, handles nonlinear effects, works with Super Learner</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="data-simulation" class="level1" data-number="22">
<h1 data-number="22"><span class="header-section-number">22</span> 3. Data Simulation</h1>
<p>We simulate a dataset where dapagliflozin reduces MACE both directly and through HbA1c improvement.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">4000</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline confounders ---</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>age    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">62</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>bmi    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">31</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>hba1c_bl <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">8.2</span>, <span class="at">sd =</span> <span class="fl">1.3</span>)   <span class="co"># baseline HbA1c</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>cvd    <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> bmi))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>egfr   <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">15</span>, <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">95</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">60</span>), <span class="at">sd =</span> <span class="dv">15</span>))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>statin <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">1.8</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> age))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment model ---</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">+</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.02</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.03</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.015</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_trt))</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Mediator: 6-month HbA1c change ---</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Dapagliflozin lowers HbA1c more than sulfonylurea</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Negative values = improvement (reduction in HbA1c)</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">-</span> <span class="fl">0.005</span> <span class="sc">*</span> egfr <span class="sc">+</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>         <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="fl">0.6</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome: 1-year MACE ---</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct effect of A (non-glycemic) + indirect effect through M</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>lp_out <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> A <span class="sc">+</span>           <span class="co"># DIRECT effect (non-glycemic pathways)</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.40</span> <span class="sc">*</span> M <span class="sc">+</span>            <span class="co"># mediator effect (higher HbA1c change → more MACE)</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.90</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.25</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.15</span> <span class="sc">*</span> A <span class="sc">*</span> cvd        <span class="co"># treatment-confounder interaction on direct path</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_out))</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(age, bmi, hba1c_bl, cvd, egfr, statin, A, M, Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="true-causal-effects" class="level3" data-number="22.0.1">
<h3 data-number="22.0.1" class="anchored" data-anchor-id="true-causal-effects"><span class="header-section-number">22.0.1</span> True causal effects</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute true NDE and NIE from the structural model ---</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We need: E[M | A=0, W] and E[M | A=1, W]</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>M_mean_A0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">-</span> <span class="fl">0.005</span> <span class="sc">*</span> egfr <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>M_mean_A1 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">-</span> <span class="fl">0.005</span> <span class="sc">*</span> egfr <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Monte Carlo integration over M distribution</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">999</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>n_mc <span class="ot">&lt;-</span> <span class="dv">50</span>  <span class="co"># MC samples per observation</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>true_nde_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>true_nie_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>true_te_vals  <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample M values from P(M | A=0, W)</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  m_samples_A0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_A0[i], <span class="at">sd =</span> <span class="fl">0.6</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample M values from P(M | A=1, W)</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  m_samples_A1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_A1[i], <span class="at">sd =</span> <span class="fl">0.6</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  w_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(age[i], bmi[i], cvd[i], egfr[i], statin[i])</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E[Y(1, M(0))] - average over M drawn from P(M|A=0,W)</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  lp_1_m0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.40</span> <span class="sc">*</span> m_samples_A0 <span class="sc">+</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.04</span> <span class="sc">*</span> (w_vec[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (w_vec[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.90</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>] <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (w_vec[<span class="dv">4</span>] <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.25</span> <span class="sc">*</span> w_vec[<span class="dv">5</span>] <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  EY_1_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_1_m0))</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E[Y(0, M(0))]</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  lp_0_m0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.40</span> <span class="sc">*</span> m_samples_A0 <span class="sc">+</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.04</span> <span class="sc">*</span> (w_vec[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (w_vec[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.90</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>] <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (w_vec[<span class="dv">4</span>] <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.25</span> <span class="sc">*</span> w_vec[<span class="dv">5</span>] <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>]</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  EY_0_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_0_m0))</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E[Y(1, M(1))]</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  lp_1_m1 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.40</span> <span class="sc">*</span> m_samples_A1 <span class="sc">+</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.04</span> <span class="sc">*</span> (w_vec[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (w_vec[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.90</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>] <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (w_vec[<span class="dv">4</span>] <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.25</span> <span class="sc">*</span> w_vec[<span class="dv">5</span>] <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>]</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  EY_1_M1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_1_m1))</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  true_nde_vals[i] <span class="ot">&lt;-</span> EY_1_M0 <span class="sc">-</span> EY_0_M0</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  true_nie_vals[i] <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_1_M0</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  true_te_vals[i]  <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_0_M0</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>true_NDE <span class="ot">&lt;-</span> <span class="fu">mean</span>(true_nde_vals)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>true_NIE <span class="ot">&lt;-</span> <span class="fu">mean</span>(true_nie_vals)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>true_TE  <span class="ot">&lt;-</span> <span class="fu">mean</span>(true_te_vals)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True Total Effect: "</span>, <span class="fu">round</span>(true_TE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; True Total Effect:  -0.0122</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True NDE (direct): "</span>, <span class="fu">round</span>(true_NDE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; True NDE (direct):  -0.0054</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True NIE (via M):  "</span>, <span class="fu">round</span>(true_NIE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; True NIE (via M):   -0.0068</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NDE + NIE:         "</span>, <span class="fu">round</span>(true_NDE <span class="sc">+</span> true_NIE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; NDE + NIE:          -0.0122</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion mediated:"</span>, <span class="fu">round</span>(true_NIE <span class="sc">/</span> true_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Proportion mediated: 55.5 %</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="why-naive-approaches-fail" class="level1" data-number="23">
<h1 data-number="23"><span class="header-section-number">23</span> 4. Why Naive Approaches Fail</h1>
<section id="a.-the-baron-kenny-trap" class="level2" data-number="23.1">
<h2 data-number="23.1" class="anchored" data-anchor-id="a.-the-baron-kenny-trap"><span class="header-section-number">23.1</span> 4A. The Baron-Kenny Trap</h2>
<p>The classic approach fits two regressions and reads off coefficients. Let’s see what it gives us:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Total effect</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>total_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Mediator model</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>med_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(M <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> dat)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Outcome model with mediator</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>full_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Baron-Kenny style coefficients ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; --- Baron-Kenny style coefficients ---</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total effect (A in model without M):"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(total_mod)[<span class="st">"A"</span>], <span class="dv">3</span>), <span class="st">"(log-OR)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Total effect (A in model without M): -0.548 (log-OR)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Direct effect (A in model with M):  "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(full_mod)[<span class="st">"A"</span>], <span class="dv">3</span>), <span class="st">"(log-OR)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Direct effect (A in model with M):   -0.205 (log-OR)</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mediator effect (M on Y):           "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(full_mod)[<span class="st">"M"</span>], <span class="dv">3</span>), <span class="st">"(log-OR)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Mediator effect (M on Y):            0.689 (log-OR)</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Treatment on mediator:              "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(med_mod)[<span class="st">"A"</span>], <span class="dv">3</span>), <span class="st">"(mean change)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Treatment on mediator:               -0.514 (mean change)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What’s Wrong with Baron-Kenny Here?
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>Scale:</strong> The coefficients are on the log-odds scale. The “difference in coefficients” method (<span class="math inline">\(TE - DE\)</span>) does not equal the indirect effect on the risk difference scale for non-linear models.</p></li>
<li><p><strong>Non-collapsibility:</strong> The log-odds ratio is non-collapsible — the coefficient of <span class="math inline">\(A\)</span> changes when you add <span class="math inline">\(M\)</span> to the model, even if there is NO mediation, simply because of the non-linear link function.</p></li>
<li><p><strong>No valid standard errors</strong> for the indirect effect without additional assumptions.</p></li>
<li><p><strong>No double robustness</strong> — if either model is misspecified, everything is biased.</p></li>
</ol>
<p>We need a proper decomposition on the risk difference scale.</p>
</div>
</div>
<hr>
</section>
<section id="b.-naive-regression-based-decomposition-on-the-risk-difference-scale" class="level2" data-number="23.2">
<h2 data-number="23.2" class="anchored" data-anchor-id="b.-naive-regression-based-decomposition-on-the-risk-difference-scale"><span class="header-section-number">23.2</span> 4B. Naive Regression-Based Decomposition on the Risk Difference Scale</h2>
<p>A better approach: use G-computation-style prediction, but decompose manually.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model including the mediator</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>q_med_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                   A<span class="sc">:</span>cvd,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Mediator model</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>m_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(M <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> egfr, <span class="at">data =</span> dat)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted mediator values under A=0 and A=1</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>M_hat_A0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>M_hat_A1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># E[Y(1, M(0))]: set A=1, M=M_hat_A0</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>EY_1_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(q_med_mod,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> M_hat_A0),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># E[Y(0, M(0))]: set A=0, M=M_hat_A0</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>EY_0_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(q_med_mod,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>, <span class="at">M =</span> M_hat_A0),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># E[Y(1, M(1))]: set A=1, M=M_hat_A1</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>EY_1_M1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(q_med_mod,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> M_hat_A1),</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>naive_NDE <span class="ot">&lt;-</span> EY_1_M0 <span class="sc">-</span> EY_0_M0</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>naive_NIE <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_1_M0</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>naive_TE  <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_0_M0</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp NDE:"</span>, <span class="fu">round</span>(naive_NDE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NDE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Naive G-comp NDE: -0.0081  (true: -0.0054 )</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp NIE:"</span>, <span class="fu">round</span>(naive_NIE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NIE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Naive G-comp NIE: -0.0103  (true: -0.0068 )</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp TE: "</span>, <span class="fu">round</span>(naive_TE, <span class="dv">4</span>),  <span class="st">" (true:"</span>, <span class="fu">round</span>(true_TE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Naive G-comp TE:  -0.0184  (true: -0.0122 )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This Is G-Computation for Mediation
</div>
</div>
<div class="callout-body-container callout-body">
<p>This approach correctly decomposes the effect on the risk difference scale. But it has the same weakness as point-treatment G-computation: it depends entirely on both the outcome model AND the mediator model being correctly specified. There is no robustness to misspecification.</p>
<p>TMLE adds targeting to make this doubly robust.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="tmle-for-mediation-step-by-step" class="level1" data-number="24">
<h1 data-number="24"><span class="header-section-number">24</span> 5. TMLE for Mediation: Step by Step</h1>
<p>We now implement a TMLE-based mediation analysis. The algorithm extends the point-treatment TMLE in a specific way: we need to “target” the outcome model not just for the treatment mechanism, but also for the mediator mechanism.</p>
<section id="the-algorithm-overview" class="level2" data-number="24.1">
<h2 data-number="24.1" class="anchored" data-anchor-id="the-algorithm-overview"><span class="header-section-number">24.1</span> The Algorithm Overview</h2>
<pre><code>┌───────────────────────────────────────┐
│ Step 1: Fit the outcome model         │
│ Q(A, M, W) = E[Y | A, M, W]          │
│ Predict under (A=1,M) and (A=0,M)    │
└───────────────┬───────────────────────┘
                │
┌───────────────▼───────────────────────┐
│ Step 2: Fit the mediator model        │
│ P(M | A, W)                           │
│ Needed for NDE/NIE decomposition      │
└───────────────┬───────────────────────┘
                │
┌───────────────▼───────────────────────┐
│ Step 3: Fit the treatment model       │
│ g(W) = P(A=1 | W)                     │
│ Needed for the clever covariate       │
└───────────────┬───────────────────────┘
                │
┌───────────────▼───────────────────────┐
│ Step 4: Compute mediation-specific    │
│ clever covariates for NDE and NIE     │
└───────────────┬───────────────────────┘
                │
┌───────────────▼───────────────────────┐
│ Step 5: Fluctuate Q to get Q*         │
│ (targeting step for each effect)      │
└───────────────┬───────────────────────┘
                │
┌───────────────▼───────────────────────┐
│ Step 6: Plug Q* into mediation        │
│ formulas to estimate NDE and NIE      │
└───────────────────────────────────────┘</code></pre>
<hr>
</section>
<section id="step-1-fit-the-outcome-model" class="level2" data-number="24.2">
<h2 data-number="24.2" class="anchored" data-anchor-id="step-1-fit-the-outcome-model"><span class="header-section-number">24.2</span> Step 1: Fit the Outcome Model</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 1: Model E[Y | A, M, W]
</div>
</div>
<div class="callout-body-container callout-body">
<p>Just like standard TMLE, start by fitting a model for the expected outcome. But now the model includes the <strong>mediator</strong> <span class="math inline">\(M\)</span> as a predictor alongside treatment <span class="math inline">\(A\)</span> and confounders <span class="math inline">\(W\)</span>.</p>
<p><span class="math display">\[\hat{Q}(A, M, W) = \hat{E}[Y \mid A, M, W]\]</span></p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model: includes treatment, mediator, and confounders</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>               A<span class="sc">:</span>cvd <span class="sc">+</span> A<span class="sc">:</span>M,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict at observed values</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>QAM_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict under counterfactual treatment values (keeping M observed)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>Q1M_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>Q0M_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q(A,M,W) range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(QAM_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Q(A,M,W) range: 0.0011 0.3803</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="step-2-fit-the-mediator-model" class="level2" data-number="24.3">
<h2 data-number="24.3" class="anchored" data-anchor-id="step-2-fit-the-mediator-model"><span class="header-section-number">24.3</span> Step 2: Fit the Mediator Model</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 2: Model P(M | A, W) — The Mediator Distribution
</div>
</div>
<div class="callout-body-container callout-body">
<p>To decompose the total effect, we need to know how the mediator distribution shifts under treatment vs.&nbsp;control. For a continuous mediator, we model <span class="math inline">\(M \mid A, W\)</span> as normally distributed.</p>
<p>This model serves two purposes:</p>
<ol type="1">
<li>It tells us what <span class="math inline">\(M\)</span> values to expect under <span class="math inline">\(A = 0\)</span> vs.&nbsp;<span class="math inline">\(A = 1\)</span></li>
<li>It provides density ratios needed for the clever covariate</li>
</ol>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mediator model: how does M depend on A and W?</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>m_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(M <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> egfr, <span class="at">data =</span> dat)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>sigma_m <span class="ot">&lt;-</span> <span class="fu">sigma</span>(m_mod)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted mediator mean under A=0 and A=1</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>M_mean_a0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>M_mean_a1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Density of observed M under each treatment condition</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># P(M_obs | A=0, W) and P(M_obs | A=1, W)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>dens_M_A0 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(dat<span class="sc">$</span>M, <span class="at">mean =</span> M_mean_a0, <span class="at">sd =</span> sigma_m)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>dens_M_A1 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(dat<span class="sc">$</span>M, <span class="at">mean =</span> M_mean_a1, <span class="at">sd =</span> sigma_m)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean mediator shift (A=1 vs A=0):"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(M_mean_a1 <span class="sc">-</span> M_mean_a0), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Mean mediator shift (A=1 vs A=0): -0.512</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="step-3-fit-the-treatment-model" class="level2" data-number="24.4">
<h2 data-number="24.4" class="anchored" data-anchor-id="step-3-fit-the-treatment-model"><span class="header-section-number">24.4</span> Step 3: Fit the Treatment Model</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3: Model P(A = 1 | W) — The Propensity Score
</div>
</div>
<div class="callout-body-container callout-body">
<p>Same as standard TMLE. The propensity score is needed for the clever covariates.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.01</span>, <span class="fu">pmin</span>(<span class="fl">0.99</span>, ps))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Propensity score range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(ps), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Propensity score range: 0.112 0.707</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="step-4-the-mediation-clever-covariates" class="level2" data-number="24.5">
<h2 data-number="24.5" class="anchored" data-anchor-id="step-4-the-mediation-clever-covariates"><span class="header-section-number">24.5</span> Step 4: The Mediation Clever Covariates</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 4: Clever Covariates for NDE and NIE
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is where mediation TMLE differs from standard TMLE. The clever covariate for the NDE is different from the one for the NIE, because they target different estimands.</p>
<p><strong>For the NDE</strong>, we need the expected outcome under <span class="math inline">\(A = 1\)</span> vs.&nbsp;<span class="math inline">\(A = 0\)</span> while holding <span class="math inline">\(M\)</span> at its distribution under <span class="math inline">\(A = 0\)</span>. The clever covariate involves a <strong>density ratio</strong> that reweights the mediator distribution:</p>
<p><span class="math display">\[H^{NDE}(A, M, W) = \frac{I(A=1) \cdot f(M \mid A=0, W)}{g(W) \cdot f(M \mid A=1, W)} - \frac{I(A=0)}{1 - g(W)}\]</span></p>
<p><strong>For the NIE</strong>, we need the expected outcome under <span class="math inline">\(A = 1\)</span> comparing the mediator distribution under <span class="math inline">\(A = 1\)</span> vs.&nbsp;<span class="math inline">\(A = 0\)</span>:</p>
<p><span class="math display">\[H^{NIE}(A, M, W) = \frac{I(A=1)}{g(W)} - \frac{I(A=1) \cdot f(M \mid A=0, W)}{g(W) \cdot f(M \mid A=1, W)}\]</span></p>
<p>The density ratio <span class="math inline">\(f(M \mid A=0, W) / f(M \mid A=1, W)\)</span> is what connects the mediator model to the targeting step. It reweights the treated group’s mediator values to look like the control group’s mediator distribution.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Density ratio: P(M | A=0, W) / P(M | A=1, W)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This ratio "transports" the mediator distribution from control to treatment</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>density_ratio <span class="ot">&lt;-</span> dens_M_A0 <span class="sc">/</span> <span class="fu">pmax</span>(dens_M_A1, <span class="fl">1e-10</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for NDE</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>H_NDE <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">*</span> density_ratio <span class="sc">/</span> ps <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for NIE</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>H_NIE <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">/</span> ps <span class="sc">-</span> dat<span class="sc">$</span>A <span class="sc">*</span> density_ratio <span class="sc">/</span> ps</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Density ratio range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(density_ratio), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Density ratio range: 0.057 21.999</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"H_NDE range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(H_NDE), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; H_NDE range: -3.37 31.78</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"H_NIE range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(H_NIE), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; H_NIE range: -29 4.32</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Does the Density Ratio Do?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The density ratio <span class="math inline">\(f(M \mid A=0, W) / f(M \mid A=1, W)\)</span> answers: “How much more (or less) likely is this particular mediator value under control than under treatment?”</p>
<ul>
<li><strong>Ratio &gt; 1:</strong> This mediator value is more typical of the control group → gets upweighted</li>
<li><strong>Ratio &lt; 1:</strong> This mediator value is more typical of the treatment group → gets downweighted</li>
<li><strong>Ratio ≈ 1:</strong> This mediator value is equally likely under both treatments</li>
</ul>
<p>When we multiply a treated patient’s outcome by this ratio, we effectively “transport” their mediator to what it would have looked like without treatment — which is exactly what the NDE requires.</p>
</div>
</div>
<hr>
</section>
<section id="step-5-targeting-fluctuation-for-nde" class="level2" data-number="24.6">
<h2 data-number="24.6" class="anchored" data-anchor-id="step-5-targeting-fluctuation-for-nde"><span class="header-section-number">24.6</span> Step 5: Targeting (Fluctuation) for NDE</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 5: Fluctuate Q to Target the NDE
</div>
</div>
<div class="callout-body-container callout-body">
<p>Just like standard TMLE, we fit a logistic regression with the initial <span class="math inline">\(\hat{Q}\)</span> as an offset and the NDE clever covariate as the predictor. The coefficient <span class="math inline">\(\epsilon\)</span> tells us how much to update.</p>
<p><span class="math display">\[\text{logit}(Y) = \text{logit}(\hat{Q}(A, M, W)) + \epsilon_{NDE} \cdot H_{NDE}\]</span></p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fluctuation for NDE</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>fluc_nde <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QAM_init)) <span class="sc">+</span> H_NDE,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>eps_nde <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc_nde)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon NDE:"</span>, <span class="fu">round</span>(eps_nde, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Epsilon NDE: -0.0087</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Update Q predictions</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>Q1M_star_nde <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q1M_init) <span class="sc">+</span> eps_nde <span class="sc">*</span> density_ratio <span class="sc">/</span> ps)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>Q0M_star_nde <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q0M_init) <span class="sc">+</span> eps_nde <span class="sc">*</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="step-6-compute-the-nde" class="level2" data-number="24.7">
<h2 data-number="24.7" class="anchored" data-anchor-id="step-6-compute-the-nde"><span class="header-section-number">24.7</span> Step 6: Compute the NDE</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 6: Plug-in NDE Estimate
</div>
</div>
<div class="callout-body-container callout-body">
<p>The NDE is the difference in the targeted outcome predictions, averaged over the population, where the mediator is held at its <strong>control</strong> distribution.</p>
<p>For the treated group (with density-reweighted mediator), we average: <span class="math display">\[\widehat{NDE} = \frac{1}{n}\sum_i \hat{Q}^*_1(M_i, W_i) \cdot r(M_i, W_i) - \frac{1}{n}\sum_i \hat{Q}^*_0(M_i, W_i)\]</span></p>
<p>where <span class="math inline">\(r(M_i, W_i)\)</span> is a normalized version of the density ratio that integrates properly.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For the NDE, we need E[Q*(1,M,W)] where M ~ P(M|A=0,W)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We use the density-ratio weighted average among treated</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and the direct average among controls</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach: Monte Carlo integration over P(M | A=0, W)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>n_mc <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>nde_mc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  m_draws <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Density ratio for each MC draw: f(m|A=0,W) / f(m|A=1,W)</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  dr_draws <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(m_draws, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m) <span class="sc">/</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">pmax</span>(<span class="fu">dnorm</span>(m_draws, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m), <span class="fl">1e-10</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q*(1, m, W) for each m draw</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># H_NDE at (A=1, m) = density_ratio(m) / ps</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  newdat_1 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> m_draws)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  q1m <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  q1m_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q1m) <span class="sc">+</span> eps_nde <span class="sc">*</span> dr_draws <span class="sc">/</span> ps[i])</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q*(0, m, W) for each m draw</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># H_NDE at (A=0, m) = -1 / (1 - ps)</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  newdat_0 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>, <span class="at">M =</span> m_draws)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  q0m <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_0, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  q0m_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q0m) <span class="sc">+</span> eps_nde <span class="sc">*</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps[i])))</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  nde_mc[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(q1m_star) <span class="sc">-</span> <span class="fu">mean</span>(q0m_star)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>tmle_NDE <span class="ot">&lt;-</span> <span class="fu">mean</span>(nde_mc)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE NDE:"</span>, <span class="fu">round</span>(tmle_NDE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NDE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; TMLE NDE: -0.0106  (true: -0.0054 )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="step-7-targeting-and-computing-the-nie" class="level2" data-number="24.8">
<h2 data-number="24.8" class="anchored" data-anchor-id="step-7-targeting-and-computing-the-nie"><span class="header-section-number">24.8</span> Step 7: Targeting and Computing the NIE</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fluctuation for NIE</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>fluc_nie <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QAM_init)) <span class="sc">+</span> H_NIE,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>eps_nie <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc_nie)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon NIE:"</span>, <span class="fu">round</span>(eps_nie, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Epsilon NIE: 0.0217</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Monte Carlo integration for NIE</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>nie_mc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># M draws from P(M|A=1,W)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  m_draws_a1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># M draws from P(M|A=0,W)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  m_draws_a0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Density ratios for each draw: f(m|A=0,W) / f(m|A=1,W)</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  dr_a1 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(m_draws_a1, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m) <span class="sc">/</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>           <span class="fu">pmax</span>(<span class="fu">dnorm</span>(m_draws_a1, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m), <span class="fl">1e-10</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  dr_a0 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(m_draws_a0, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m) <span class="sc">/</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>           <span class="fu">pmax</span>(<span class="fu">dnorm</span>(m_draws_a0, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m), <span class="fl">1e-10</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q*(1, M(1), W) - Q*(1, M(0), W)</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># H_NIE at (A=1, m) = (1 - density_ratio(m)) / ps</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  newdat_1_m1 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> m_draws_a1)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  newdat_1_m0 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> m_draws_a0)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  q_m1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_1_m1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  q_m0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_1_m0, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  q_m1_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q_m1) <span class="sc">+</span> eps_nie <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> dr_a1) <span class="sc">/</span> ps[i])</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  q_m0_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q_m0) <span class="sc">+</span> eps_nie <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> dr_a0) <span class="sc">/</span> ps[i])</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  nie_mc[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(q_m1_star) <span class="sc">-</span> <span class="fu">mean</span>(q_m0_star)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>tmle_NIE <span class="ot">&lt;-</span> <span class="fu">mean</span>(nie_mc)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>tmle_TE  <span class="ot">&lt;-</span> tmle_NDE <span class="sc">+</span> tmle_NIE</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE NIE:"</span>, <span class="fu">round</span>(tmle_NIE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NIE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; TMLE NIE: -0.0087  (true: -0.0068 )</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE TE: "</span>, <span class="fu">round</span>(tmle_TE, <span class="dv">4</span>),  <span class="st">" (true:"</span>, <span class="fu">round</span>(true_TE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; TMLE TE:  -0.0193  (true: -0.0122 )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="results-comparison" class="level1" data-number="25">
<h1 data-number="25"><span class="header-section-number">25</span> 6. Results Comparison</h1>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Effect =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Total Effect"</span>, <span class="st">"Natural Direct Effect"</span>, <span class="st">"Natural Indirect Effect"</span>), <span class="dv">3</span>),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"Naive G-comp"</span>, <span class="st">"TMLE"</span>), <span class="at">each =</span> <span class="dv">3</span>),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">c</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    true_TE, true_NDE, true_NIE,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    naive_TE, naive_NDE, naive_NIE,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    tmle_TE, tmle_NDE, tmle_NIE</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Method, <span class="at">values_from =</span> Estimate) <span class="sc">%&gt;%</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>)))</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 4</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Effect                     True `Naive G-comp`    TMLE</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;                     &lt;dbl&gt;          &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 Total Effect            -0.0122        -0.0184 -0.0193</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 Natural Direct Effect   -0.0054        -0.0081 -0.0106</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 Natural Indirect Effect -0.0068        -0.0103 -0.0087</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> Estimate, <span class="at">y =</span> Effect, <span class="at">color =</span> Method, <span class="at">shape =</span> Method)) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Effect Estimate (Risk Difference)"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Mediation Decomposition: Comparing Methods"</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#228833"</span>, <span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-10-tmle-mediation_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Proportion mediated</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Proportion Mediated ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; === Proportion Mediated ===</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True:       "</span>, <span class="fu">round</span>(true_NIE <span class="sc">/</span> true_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; True:        55.5 %</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp:"</span>, <span class="fu">round</span>(naive_NIE <span class="sc">/</span> naive_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Naive G-comp: 55.9 %</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE:       "</span>, <span class="fu">round</span>(tmle_NIE <span class="sc">/</span> tmle_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; TMLE:        45 %</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="diagnostics-for-mediation-tmle" class="level1" data-number="26">
<h1 data-number="26"><span class="header-section-number">26</span> 7. Diagnostics for Mediation TMLE</h1>
<section id="propensity-score-overlap" class="level2" data-number="26.1">
<h2 data-number="26.1" class="anchored" data-anchor-id="propensity-score-overlap"><span class="header-section-number">26.1</span> 7.1 Propensity Score Overlap</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"P(A=1 | W)"</span>, <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Propensity Score Overlap"</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-10-tmle-mediation_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mediator-distribution-by-treatment" class="level2" data-number="26.2">
<h2 data-number="26.2" class="anchored" data-anchor-id="mediator-distribution-by-treatment"><span class="header-section-number">26.2</span> 7.2 Mediator Distribution by Treatment</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why This Matters
</div>
</div>
<div class="callout-body-container callout-body">
<p>The NIE depends on the treatment actually <strong>shifting</strong> the mediator distribution. If the mediator distributions under <span class="math inline">\(A = 0\)</span> and <span class="math inline">\(A = 1\)</span> are identical, there is no indirect effect to detect.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> M, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"6-month HbA1c change (M)"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Mediator Distribution by Treatment Group"</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-10-tmle-mediation_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="density-ratio-distribution" class="level2" data-number="26.3">
<h2 data-number="26.3" class="anchored" data-anchor-id="density-ratio-distribution"><span class="header-section-number">26.3</span> 7.3 Density Ratio Distribution</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Density Ratio Instability
</div>
</div>
<div class="callout-body-container callout-body">
<p>Extreme density ratios indicate that some observed mediator values are very unlikely under one treatment but common under the other. This creates instability analogous to extreme IPTW weights.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">r =</span> density_ratio), <span class="fu">aes</span>(<span class="at">x =</span> r)) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#CC6677"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Density ratio f(M|A=0,W) / f(M|A=1,W)"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Mediator Density Ratio"</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-10-tmle-mediation_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Density ratio summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Density ratio summary:</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(density_ratio)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  0.05709  0.59038  1.10575  1.63305  2.02503 21.99932</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion &gt; 3:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(density_ratio <span class="sc">&gt;</span> <span class="dv">3</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Proportion &gt; 3: 0.135</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mediator-outcome-relationship" class="level2" data-number="26.4">
<h2 data-number="26.4" class="anchored" data-anchor-id="mediator-outcome-relationship"><span class="header-section-number">26.4</span> 7.4 Mediator-Outcome Relationship</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that M actually predicts Y (otherwise no mediation to find)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> M, <span class="at">y =</span> Y)) <span class="sc">+</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"#228833"</span>) <span class="sc">+</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>))) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"6-month HbA1c change (M)"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"P(MACE)"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Mediator-Outcome Relationship by Treatment"</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03-10-tmle-mediation_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="interpretation" class="level1" data-number="27">
<h1 data-number="27"><span class="header-section-number">27</span> 8. Interpretation</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Would We Tell the FDA?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Based on the TMLE mediation analysis:</p>
<ul>
<li><strong>Total effect:</strong> Dapagliflozin reduces 1-year MACE risk by approximately 1.9 percentage points compared to sulfonylurea</li>
<li><strong>Direct effect (NDE):</strong> Approximately 1.1 percentage points of this reduction operates through <strong>non-glycemic pathways</strong> (blood pressure reduction, weight loss, direct cardiac effects)</li>
<li><strong>Indirect effect via HbA1c (NIE):</strong> Approximately 0.9 percentage points operates through <strong>glycemic improvement</strong></li>
<li><strong>Proportion mediated:</strong> About 45% of the cardiovascular benefit is attributable to HbA1c reduction</li>
</ul>
<p><strong>Implication:</strong> The majority of the CV benefit appears to be through non-glycemic mechanisms, suggesting SGLT2 inhibitors have a unique cardioprotective effect beyond glucose lowering. This supports differentiated labeling.</p>
</div>
</div>
<section id="fragile-assumptions" class="level3" data-number="27.0.1">
<h3 data-number="27.0.1" class="anchored" data-anchor-id="fragile-assumptions"><span class="header-section-number">27.0.1</span> Fragile Assumptions</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Could Go Wrong?
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>Unmeasured mediator-outcome confounders affected by treatment:</strong> If dapagliflozin changes blood pressure (call it <span class="math inline">\(Z\)</span>), and blood pressure both affects HbA1c trajectory AND directly affects MACE, the NDE/NIE decomposition is biased. This is the cross-world assumption.</p></li>
<li><p><strong>Mediator measurement error:</strong> If 6-month HbA1c is a noisy proxy for the true glycemic pathway, the NIE will be attenuated (biased toward zero) and the NDE will absorb the missing indirect effect.</p></li>
<li><p><strong>Mediator model misspecification:</strong> If the true mediator distribution is non-normal or has treatment-dependent variance, the density ratio may be miscalibrated.</p></li>
</ol>
</div>
</div>
<hr>
</section>
</section>
<section id="advanced-interventional-indirect-effects" class="level1" data-number="28">
<h1 data-number="28"><span class="header-section-number">28</span> 9. Advanced: Interventional (In)Direct Effects</h1>
<p>If the cross-world assumption (no treatment-affected mediator-outcome confounders) is violated, natural direct and indirect effects are not identified. An alternative is the <strong>interventional (in)direct effect</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interventional Effects: A Weaker Assumption
</div>
</div>
<div class="callout-body-container callout-body">
<p>Instead of asking “what if we set <span class="math inline">\(M\)</span> to <span class="math inline">\(M(0)\)</span>?” (cross-world), interventional effects ask “what if we drew <span class="math inline">\(M\)</span> randomly from <span class="math inline">\(P(M \mid A = 0, W)\)</span>?” (a stochastic intervention on the mediator).</p>
<p><strong>Interventional Direct Effect (IDE):</strong> <span class="math display">\[IDE = E\big[Y(1, G_0)\big] - E\big[Y(0, G_0)\big]\]</span></p>
<p><strong>Interventional Indirect Effect (IIE):</strong> <span class="math display">\[IIE = E\big[Y(1, G_1)\big] - E\big[Y(1, G_0)\big]\]</span></p>
<p>where <span class="math inline">\(G_a\)</span> denotes a random draw from <span class="math inline">\(P(M \mid A = a, W)\)</span>.</p>
<p>The IDE and IIE do NOT require the cross-world assumption. They only need the standard no-unmeasured-confounding assumptions for <span class="math inline">\(A \to Y\)</span>, <span class="math inline">\(A \to M\)</span>, and <span class="math inline">\(M \to Y\)</span> (conditional on <span class="math inline">\(A\)</span> and <span class="math inline">\(W\)</span>).</p>
<p>The <code>lmtp</code> package can estimate interventional effects for longitudinal mediation settings.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conceptual: LMTP for interventional effects</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtp)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift the mediator distribution as if treatment were control</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>shift_mediator <span class="ot">&lt;-</span> <span class="cf">function</span>(data, trt) {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw M from P(M | A=0, W) instead of P(M | A=observed, W)</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  data[[trt]]  <span class="co"># placeholder — real implementation uses mediator density</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># See lmtp documentation for full mediation analysis interface</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="comparison-mediation-methods" class="level1" data-number="29">
<h1 data-number="29"><span class="header-section-number">29</span> 10. Comparison: Mediation Methods</h1>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 24%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 22%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Handles nonlinearity</th>
<th>Doubly robust</th>
<th>Works with ML</th>
<th>Cross-world needed</th>
<th>Package</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Baron-Kenny</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>Implicitly yes</td>
<td>Base R</td>
</tr>
<tr class="even">
<td>Parametric G-comp</td>
<td>Partially</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td><code>mediation</code></td>
</tr>
<tr class="odd">
<td>Weighting-based</td>
<td>Yes</td>
<td>No</td>
<td>Partially</td>
<td>Yes</td>
<td><code>CMAverse</code></td>
</tr>
<tr class="even">
<td><strong>TMLE for NDE/NIE</strong></td>
<td><strong>Yes</strong></td>
<td><strong>Yes</strong></td>
<td><strong>Yes</strong></td>
<td><strong>Yes</strong></td>
<td><code>tmle</code></td>
</tr>
<tr class="odd">
<td>Interventional effects</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td><strong>No</strong></td>
<td><code>lmtp</code></td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="key-takeaways" class="level1" data-number="30">
<h1 data-number="30"><span class="header-section-number">30</span> Key Takeaways</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Summary
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>Mediation analysis decomposes a total effect</strong> into direct (not through the mediator) and indirect (through the mediator) components. This tells us <em>how</em> a drug works.</p></li>
<li><p><strong>Baron-Kenny regression fails</strong> for binary outcomes because of non-collapsibility. Even for continuous outcomes, it assumes linearity and no interactions.</p></li>
<li><p><strong>TMLE for mediation</strong> extends the standard TMLE algorithm with a mediator-specific <strong>density ratio</strong> in the clever covariate. This density ratio “transports” the mediator distribution from one treatment arm to the other.</p></li>
<li><p><strong>The cross-world assumption</strong> (no treatment-affected mediator-outcome confounders) is required for natural direct/indirect effects. If violated, consider <strong>interventional effects</strong> which require only standard confounding assumptions.</p></li>
<li><p><strong>Diagnostics matter:</strong> check propensity score overlap, mediator distribution shift, density ratio stability, and the mediator-outcome relationship.</p></li>
<li><p><strong>The proportion mediated</strong> tells decision-makers whether a drug works primarily through a specific mechanism or through other pathways — critical for labeling, mechanistic understanding, and competitor drug development.</p></li>
</ol>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R version 4.4.2 (2024-10-31 ucrt)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Running under: Windows 11 x64 (build 26200)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; locale:</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] LC_COLLATE=English_United States.utf8 </span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2] LC_CTYPE=English_United States.utf8   </span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3] LC_MONETARY=English_United States.utf8</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [4] LC_NUMERIC=C                          </span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5] LC_TIME=English_United States.utf8    </span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; time zone: America/Los_Angeles</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; tzcode source: internal</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; other attached packages:</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    </span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   </span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] ggplot2_3.5.2   tidyverse_2.0.0</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] Matrix_1.7-1      gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2   </span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] tidyselect_1.2.1  splines_4.4.2     scales_1.3.0      yaml_2.3.10      </span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] fastmap_1.2.0     lattice_0.22-6    R6_2.6.1          labeling_0.4.3   </span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4 munsell_0.5.1    </span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [17] pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6       utf8_1.2.4       </span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [21] stringi_1.8.7     xfun_0.49         timechange_0.3.0  cli_3.6.5        </span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [25] mgcv_1.9-1        withr_3.0.2       magrittr_2.0.3    digest_0.6.37    </span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [29] grid_4.4.2        rstudioapi_0.17.1 hms_1.1.3         nlme_3.1-166     </span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [33] lifecycle_1.0.4   vctrs_0.6.5       evaluate_1.0.5    glue_1.8.0       </span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [37] farver_2.1.2      fansi_1.0.6       colorspace_2.1-1  rmarkdown_2.29   </span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [41] tools_4.4.2       pkgconfig_2.0.3   htmltools_0.5.8.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<section id="sources-and-further-reading" class="level2" data-number="30.1">
<h2 data-number="30.1" class="anchored" data-anchor-id="sources-and-further-reading"><span class="header-section-number">30.1</span> Sources and further reading</h2>
<ul>
<li>Zheng Z, van der Laan MJ (2012). Targeted maximum likelihood estimation of natural direct effects. <em>Int J Biostat</em> 8(1):Article 3.</li>
<li>VanderWeele TJ (2015). <em>Explanation in Causal Inference: Methods for Mediation and Interaction</em>. Oxford University Press.</li>
<li>Diaz I, Hejazi NS (2020). Causal mediation analysis for stochastic interventions. <em>JRSS-B</em> 82(3):661-683.</li>
<li>Pearl J (2001). Direct and indirect effects. <em>Proceedings of the 17th Conference on Uncertainty in Artificial Intelligence</em>, 411-420.</li>
<li>Robins JM, Richardson TS (2010). Alternative graphical causal models and the identification of direct effects. In <em>Causality and Psychopathology</em>, Oxford University Press.</li>
<li>Williams NT, Diaz I (2024). crumble: An R package for TMLE-based mediation analysis. <a href="https://github.com/nt-williams/crumble">GitHub</a></li>
<li><code>medltmle</code> (if available): <a href="https://github.com/topics/mediation-analysis">GitHub search</a></li>
<li>van der Laan MJ, Rose S (2011). <em>Targeted Learning</em>. Springer.</li>
</ul>
<hr>
</section>
<section id="software-implementation-r" class="level2" data-number="30.2">
<h2 data-number="30.2" class="anchored" data-anchor-id="software-implementation-r"><span class="header-section-number">30.2</span> Software Implementation (R)</h2>
<p>This example uses the <code>crumble</code> package (if available) to estimate the <strong>natural direct effect (NDE)</strong> and <strong>natural indirect effect (NIE)</strong> via TMLE-based mediation analysis. The <code>crumble</code> package implements targeted learning for mediation with flexible nuisance estimation.</p>
<ul>
<li>Simulate data with a binary treatment <span class="math inline">\(A\)</span>, continuous mediator <span class="math inline">\(M\)</span>, and binary outcome <span class="math inline">\(Y\)</span></li>
<li>Estimate NDE and NIE using <code>crumble::crumble()</code> with cross-fitting</li>
<li>Falls back to a manual decomposition using <code>tmle</code> if <code>crumble</code> is unavailable</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="fl">0.3</span> <span class="sc">*</span> W))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> W <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> <span class="fl">0.8</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> M <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> W))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">W =</span> W, <span class="at">A =</span> A, <span class="at">M =</span> M, <span class="at">Y =</span> Y)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"crumble"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(crumble)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## crumble estimates interventional (in)direct effects</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## using TMLE with cross-fitting</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">crumble</span>(</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">trt =</span> <span class="st">"A"</span>,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">mediators =</span> <span class="st">"M"</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline =</span> <span class="st">"W"</span>,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome_type =</span> <span class="st">"binomial"</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">learners =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.mean"</span>),</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">nn_module =</span> <span class="cn">NULL</span>  <span class="co"># use standard SL, not neural net</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"── Mediation TMLE via crumble ──</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(result)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"'crumble' package not found."</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install from GitHub:  remotes::install_github('nt-williams/crumble')"</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Falling back to a manual total-effect decomposition...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"tmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tmle)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Total effect only (not a true mediation decomposition)</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">tmle</span>(<span class="at">Y =</span> Y, <span class="at">A =</span> A, <span class="at">W =</span> <span class="fu">data.frame</span>(<span class="at">W =</span> W),</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>                <span class="at">Q.SL.library =</span> <span class="st">"SL.glm"</span>, <span class="at">g.SL.library =</span> <span class="st">"SL.glm"</span>)</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Total effect (ATE):"</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>psi, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>CI, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Note: This is the total effect only.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"For NDE/NIE decomposition, install the crumble package.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Install 'tmle':  install.packages('tmle')"</span>)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amertens\.github\.io\/causal-learning-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-09-illustrated-ltmle.html" class="pagination-link" aria-label="An Illustrated Guide to Longitudinal TMLE">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-11-estimands-tte-safety.html" class="pagination-link" aria-label="Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial">
        <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb26" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "An Illustrated Guide to TMLE for Mediation Analysis"</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Decomposing total effects into direct and indirect pathways"</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu"># An Illustrated Guide to TMLE for Mediation Analysis</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>*How to decompose a drug's total effect into what works directly and what works through an intermediate mechanism*</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>In pharmacoepidemiology, we often want to know not just **whether** a drug works, but **how** it works. Does dapagliflozin reduce cardiovascular events because it lowers blood pressure, because it improves glucose control, or through some other mechanism entirely?</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>**Mediation analysis** decomposes a total causal effect into:</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A **direct effect** — the part of the treatment effect NOT operating through the mediator</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>An **indirect effect** — the part operating THROUGH the mediator</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>TMLE provides a principled framework for this decomposition that is doubly robust and compatible with machine learning.</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning objectives</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Define natural direct effects (NDE) and natural indirect effects (NIE) using potential outcomes</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Explain the cross-world independence assumption and why it is required for mediation</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Construct the density ratio clever covariates used in TMLE for mediation</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement NDE and NIE estimation via Monte Carlo integration within TMLE</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use the <span class="in">`crumble`</span> package for automated TMLE-based mediation analysis</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Interpret decomposed effects in a pharmacoepidemiology context (e.g., drug mechanism elucidation)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sources and scope</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>This chapter is educational. Causal conclusions depend on identification assumptions (e.g., consistency, exchangeability, positivity) and on diagnostic evidence that the data support the target estimand. When flexible machine learning is used for nuisance estimation, valid inference typically requires cross-fitting or a cross-validated TMLE variant, plus appropriate rate conditions.</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">comment =</span> <span class="st">"#&gt;"</span>,</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">7</span>,</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">4</span>,</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cn">FALSE</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. Clinical Motivation</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Pharmacoepidemiologic Question</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>SGLT2 inhibitors (like dapagliflozin) have shown surprising cardiovascular benefits in type 2 diabetes trials. The FDA and sponsor want to understand **the mechanism**:</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **How much of dapagliflozin's effect on reducing MACE operates through HbA1c reduction (glycemic pathway), and how much operates through other mechanisms (e.g., blood pressure, weight loss, direct cardiac effects)?**</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>This matters because:</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the effect is entirely through glycemic control, other glucose-lowering drugs should work too</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the effect is mostly direct, SGLT2 inhibitors have a unique cardiovascular benefit worth highlighting in labeling</span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understanding mechanisms guides future drug development</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Setup</span></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treatment (A):** Dapagliflozin vs. sulfonylurea</span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Mediator (M):** 6-month HbA1c change (glycemic improvement)</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Outcome (Y):** 1-year MACE</span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Confounders (W):** Age, BMI, baseline HbA1c, prior CVD, eGFR, statin use</span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Question:** How much of the $A \to Y$ effect goes through $A \to M \to Y$?</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. Mediation Analysis: The Causal Roadmap</span></span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Define the Causal Question</span></span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>In mediation, we decompose the **total effect** into two pieces:</span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## Total Effect = Natural Direct Effect + Natural Indirect Effect</span></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>**Total Effect (TE):**</span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>$$TE = E<span class="co">[</span><span class="ot">Y(1, M(1))</span><span class="co">]</span> - E<span class="co">[</span><span class="ot">Y(0, M(0))</span><span class="co">]</span>$$</span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>The overall effect of treatment on outcome (what we estimated in Chapter 2.4).</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>**Natural Direct Effect (NDE):**</span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>$$NDE = E<span class="co">[</span><span class="ot">Y(1, M(0))</span><span class="co">]</span> - E<span class="co">[</span><span class="ot">Y(0, M(0))</span><span class="co">]</span>$$</span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>The effect of treatment on outcome if we could **hold the mediator at its control value**.</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>"What if we gave the drug but magically blocked it from changing HbA1c?"</span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>**Natural Indirect Effect (NIE):**</span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>$$NIE = E<span class="co">[</span><span class="ot">Y(1, M(1))</span><span class="co">]</span> - E<span class="co">[</span><span class="ot">Y(1, M(0))</span><span class="co">]</span>$$</span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>The effect of the mediator change induced by treatment, **while keeping treatment on**.</span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>"What if we didn't change the drug assignment but shifted HbA1c as dapagliflozin would?"</span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>The decomposition is: $TE = NDE + NIE$</span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plain Language</span></span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**NDE:** "How much does the drug help even if it didn't change HbA1c at all?" (the direct pathway — blood pressure, weight, cardiac remodeling, etc.)</span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**NIE:** "How much does the drug help specifically because it lowers HbA1c?" (the glycemic pathway)</span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a>If the NIE is large, glycemic control is the main mechanism. If the NDE is large, the drug works through non-glycemic pathways.</span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: The Causal Model (DAG)</span></span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>The mediation DAG adds one node compared to the standard confounding DAG:</span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a><span class="in">              W (confounders)</span></span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a><span class="in">            / | \</span></span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a><span class="in">           /  |  \</span></span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a><span class="in">          v   v   v</span></span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a><span class="in">          A → M → Y</span></span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a><span class="in">          |       ↑</span></span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a><span class="in">          └───────┘</span></span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a><span class="in">            (direct)</span></span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$W \to A$: confounders affect treatment</span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$W \to M$: confounders affect the mediator</span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$W \to Y$: confounders affect the outcome</span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$A \to M$: treatment affects the mediator (dapagliflozin lowers HbA1c)</span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$M \to Y$: the mediator affects the outcome (HbA1c affects MACE risk)</span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$A \to Y$: treatment directly affects the outcome (non-glycemic pathways)</span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a><span class="fu">## Critical Assumption: No Mediator-Outcome Confounding Affected by Treatment</span></span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a>For mediation to work, there must be **no confounder of the M → Y relationship that is itself affected by treatment**. If treatment changes a variable $Z$ that confounds $M \to Y$, the natural direct and indirect effects are not identifiable from observed data.</span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a><span class="in">     A → Z → M → Y       ← Z confounds M→Y AND is affected by A</span></span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a><span class="in">              ↑</span></span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a><span class="in">              Z ──────→ Y  ← This breaks identification!</span></span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>This is the hardest assumption in mediation analysis. In our example: does dapagliflozin change something (like blood pressure or weight) that both affects HbA1c trajectory AND independently affects MACE? If so, we need more advanced methods (interventional effects).</span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Assumptions for Mediation</span></span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a>To identify the NDE and NIE, we need the standard confounding assumptions PLUS additional ones:</span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**No unmeasured treatment-outcome confounding:** $Y(a, m) \perp<span class="sc">\!\!\!</span>\perp A \mid W$</span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**No unmeasured mediator-outcome confounding:** $Y(a, m) \perp<span class="sc">\!\!\!</span>\perp M \mid A, W$</span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**No unmeasured treatment-mediator confounding:** $M(a) \perp<span class="sc">\!\!\!</span>\perp A \mid W$</span>
<span id="cb26-155"><a href="#cb26-155" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Cross-world independence:** No $W$-adjusted confounder of $M \to Y$ is affected by $A$</span>
<span id="cb26-156"><a href="#cb26-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-157"><a href="#cb26-157" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb26-158"><a href="#cb26-158" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Cross-World Problem</span></span>
<span id="cb26-159"><a href="#cb26-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-160"><a href="#cb26-160" aria-hidden="true" tabindex="-1"></a>Assumption 4 is called the "cross-world" assumption because the NDE involves a quantity $Y(1, M(0))$ — the outcome under treatment $A = 1$ with the mediator value that **would have occurred** under $A = 0$. This never happens in reality; it combines potential outcomes from two different "worlds."</span>
<span id="cb26-161"><a href="#cb26-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-162"><a href="#cb26-162" aria-hidden="true" tabindex="-1"></a>This assumption is untestable and often debated. If you are uncomfortable with it, consider **interventional (in)direct effects**, which replace the cross-world assumption with a weaker one. We briefly discuss this in Section 9.</span>
<span id="cb26-163"><a href="#cb26-163" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-164"><a href="#cb26-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-165"><a href="#cb26-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Statistical Estimands</span></span>
<span id="cb26-166"><a href="#cb26-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-167"><a href="#cb26-167" aria-hidden="true" tabindex="-1"></a>Under the assumptions above, the NDE and NIE are identified by statistical quantities:</span>
<span id="cb26-168"><a href="#cb26-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-169"><a href="#cb26-169" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb26-170"><a href="#cb26-170" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Mediation G-Computation Formulas</span></span>
<span id="cb26-171"><a href="#cb26-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-172"><a href="#cb26-172" aria-hidden="true" tabindex="-1"></a>**NDE:**</span>
<span id="cb26-173"><a href="#cb26-173" aria-hidden="true" tabindex="-1"></a>$$NDE = \sum_m \sum_w \big<span class="co">[</span><span class="ot">E[Y \mid A=1, M=m, W=w] - E[Y \mid A=0, M=m, W=w]\big</span><span class="co">]</span> \cdot P(M=m \mid A=0, W=w) \cdot P(W=w)$$</span>
<span id="cb26-174"><a href="#cb26-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-175"><a href="#cb26-175" aria-hidden="true" tabindex="-1"></a>**NIE:**</span>
<span id="cb26-176"><a href="#cb26-176" aria-hidden="true" tabindex="-1"></a>$$NIE = \sum_m \sum_w E<span class="co">[</span><span class="ot">Y \mid A=1, M=m, W=w</span><span class="co">]</span> \cdot \big<span class="co">[</span><span class="ot">P(M=m \mid A=1, W=w) - P(M=m \mid A=0, W=w)\big</span><span class="co">]</span> \cdot P(W=w)$$</span>
<span id="cb26-177"><a href="#cb26-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-178"><a href="#cb26-178" aria-hidden="true" tabindex="-1"></a>These formulas require:</span>
<span id="cb26-179"><a href="#cb26-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-180"><a href="#cb26-180" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>An **outcome model:** $E<span class="co">[</span><span class="ot">Y \mid A, M, W</span><span class="co">]</span>$</span>
<span id="cb26-181"><a href="#cb26-181" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A **mediator model:** $P(M \mid A, W)$</span>
<span id="cb26-182"><a href="#cb26-182" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A **treatment model:** $P(A \mid W)$ (for the TMLE targeting step)</span>
<span id="cb26-183"><a href="#cb26-183" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-184"><a href="#cb26-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-185"><a href="#cb26-185" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Why TMLE for Mediation?</span></span>
<span id="cb26-186"><a href="#cb26-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-187"><a href="#cb26-187" aria-hidden="true" tabindex="-1"></a>| Method | Limitation |</span>
<span id="cb26-188"><a href="#cb26-188" aria-hidden="true" tabindex="-1"></a>|--------|-----------|</span>
<span id="cb26-189"><a href="#cb26-189" aria-hidden="true" tabindex="-1"></a>| Baron-Kenny regression | Assumes linear models, no interactions, continuous mediator |</span>
<span id="cb26-190"><a href="#cb26-190" aria-hidden="true" tabindex="-1"></a>| Parametric G-computation | Works but depends on correct outcome AND mediator models |</span>
<span id="cb26-191"><a href="#cb26-191" aria-hidden="true" tabindex="-1"></a>| Weighting-based | Can be unstable with continuous mediators |</span>
<span id="cb26-192"><a href="#cb26-192" aria-hidden="true" tabindex="-1"></a>| **TMLE for mediation** | Doubly robust, handles nonlinear effects, works with Super Learner |</span>
<span id="cb26-193"><a href="#cb26-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-194"><a href="#cb26-194" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-195"><a href="#cb26-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-196"><a href="#cb26-196" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Data Simulation</span></span>
<span id="cb26-197"><a href="#cb26-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-198"><a href="#cb26-198" aria-hidden="true" tabindex="-1"></a>We simulate a dataset where dapagliflozin reduces MACE both directly and through HbA1c improvement.</span>
<span id="cb26-199"><a href="#cb26-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-202"><a href="#cb26-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-203"><a href="#cb26-203" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb26-204"><a href="#cb26-204" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb26-205"><a href="#cb26-205" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">4000</span></span>
<span id="cb26-206"><a href="#cb26-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-207"><a href="#cb26-207" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline confounders ---</span></span>
<span id="cb26-208"><a href="#cb26-208" aria-hidden="true" tabindex="-1"></a>age    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">62</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb26-209"><a href="#cb26-209" aria-hidden="true" tabindex="-1"></a>bmi    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">31</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb26-210"><a href="#cb26-210" aria-hidden="true" tabindex="-1"></a>hba1c_bl <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">8.2</span>, <span class="at">sd =</span> <span class="fl">1.3</span>)   <span class="co"># baseline HbA1c</span></span>
<span id="cb26-211"><a href="#cb26-211" aria-hidden="true" tabindex="-1"></a>cvd    <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> bmi))</span>
<span id="cb26-212"><a href="#cb26-212" aria-hidden="true" tabindex="-1"></a>egfr   <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">15</span>, <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">95</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">60</span>), <span class="at">sd =</span> <span class="dv">15</span>))</span>
<span id="cb26-213"><a href="#cb26-213" aria-hidden="true" tabindex="-1"></a>statin <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">1.8</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> age))</span>
<span id="cb26-214"><a href="#cb26-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-215"><a href="#cb26-215" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment model ---</span></span>
<span id="cb26-216"><a href="#cb26-216" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">+</span></span>
<span id="cb26-217"><a href="#cb26-217" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.02</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb26-218"><a href="#cb26-218" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.03</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb26-219"><a href="#cb26-219" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb26-220"><a href="#cb26-220" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb26-221"><a href="#cb26-221" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.015</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>)</span>
<span id="cb26-222"><a href="#cb26-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-223"><a href="#cb26-223" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_trt))</span>
<span id="cb26-224"><a href="#cb26-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-225"><a href="#cb26-225" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Mediator: 6-month HbA1c change ---</span></span>
<span id="cb26-226"><a href="#cb26-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Dapagliflozin lowers HbA1c more than sulfonylurea</span></span>
<span id="cb26-227"><a href="#cb26-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Negative values = improvement (reduction in HbA1c)</span></span>
<span id="cb26-228"><a href="#cb26-228" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,</span>
<span id="cb26-229"><a href="#cb26-229" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">-</span> <span class="fl">0.005</span> <span class="sc">*</span> egfr <span class="sc">+</span></span>
<span id="cb26-230"><a href="#cb26-230" aria-hidden="true" tabindex="-1"></a>         <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>),</span>
<span id="cb26-231"><a href="#cb26-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="fl">0.6</span></span>
<span id="cb26-232"><a href="#cb26-232" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-233"><a href="#cb26-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-234"><a href="#cb26-234" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome: 1-year MACE ---</span></span>
<span id="cb26-235"><a href="#cb26-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct effect of A (non-glycemic) + indirect effect through M</span></span>
<span id="cb26-236"><a href="#cb26-236" aria-hidden="true" tabindex="-1"></a>lp_out <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span></span>
<span id="cb26-237"><a href="#cb26-237" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> A <span class="sc">+</span>           <span class="co"># DIRECT effect (non-glycemic pathways)</span></span>
<span id="cb26-238"><a href="#cb26-238" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.40</span> <span class="sc">*</span> M <span class="sc">+</span>            <span class="co"># mediator effect (higher HbA1c change → more MACE)</span></span>
<span id="cb26-239"><a href="#cb26-239" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb26-240"><a href="#cb26-240" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb26-241"><a href="#cb26-241" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.90</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb26-242"><a href="#cb26-242" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb26-243"><a href="#cb26-243" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.25</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb26-244"><a href="#cb26-244" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.15</span> <span class="sc">*</span> A <span class="sc">*</span> cvd        <span class="co"># treatment-confounder interaction on direct path</span></span>
<span id="cb26-245"><a href="#cb26-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-246"><a href="#cb26-246" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_out))</span>
<span id="cb26-247"><a href="#cb26-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-248"><a href="#cb26-248" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(age, bmi, hba1c_bl, cvd, egfr, statin, A, M, Y)</span>
<span id="cb26-249"><a href="#cb26-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-250"><a href="#cb26-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-251"><a href="#cb26-251" aria-hidden="true" tabindex="-1"></a><span class="fu">### True causal effects</span></span>
<span id="cb26-252"><a href="#cb26-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-255"><a href="#cb26-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-256"><a href="#cb26-256" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute true NDE and NIE from the structural model ---</span></span>
<span id="cb26-257"><a href="#cb26-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-258"><a href="#cb26-258" aria-hidden="true" tabindex="-1"></a><span class="co"># We need: E[M | A=0, W] and E[M | A=1, W]</span></span>
<span id="cb26-259"><a href="#cb26-259" aria-hidden="true" tabindex="-1"></a>M_mean_A0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">-</span> <span class="fl">0.005</span> <span class="sc">*</span> egfr <span class="sc">+</span></span>
<span id="cb26-260"><a href="#cb26-260" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)</span>
<span id="cb26-261"><a href="#cb26-261" aria-hidden="true" tabindex="-1"></a>M_mean_A1 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> (hba1c_bl <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">-</span> <span class="fl">0.005</span> <span class="sc">*</span> egfr <span class="sc">+</span></span>
<span id="cb26-262"><a href="#cb26-262" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)</span>
<span id="cb26-263"><a href="#cb26-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-264"><a href="#cb26-264" aria-hidden="true" tabindex="-1"></a><span class="co"># Monte Carlo integration over M distribution</span></span>
<span id="cb26-265"><a href="#cb26-265" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">999</span>)</span>
<span id="cb26-266"><a href="#cb26-266" aria-hidden="true" tabindex="-1"></a>n_mc <span class="ot">&lt;-</span> <span class="dv">50</span>  <span class="co"># MC samples per observation</span></span>
<span id="cb26-267"><a href="#cb26-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-268"><a href="#cb26-268" aria-hidden="true" tabindex="-1"></a>true_nde_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb26-269"><a href="#cb26-269" aria-hidden="true" tabindex="-1"></a>true_nie_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb26-270"><a href="#cb26-270" aria-hidden="true" tabindex="-1"></a>true_te_vals  <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb26-271"><a href="#cb26-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-272"><a href="#cb26-272" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb26-273"><a href="#cb26-273" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample M values from P(M | A=0, W)</span></span>
<span id="cb26-274"><a href="#cb26-274" aria-hidden="true" tabindex="-1"></a>  m_samples_A0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_A0[i], <span class="at">sd =</span> <span class="fl">0.6</span>)</span>
<span id="cb26-275"><a href="#cb26-275" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample M values from P(M | A=1, W)</span></span>
<span id="cb26-276"><a href="#cb26-276" aria-hidden="true" tabindex="-1"></a>  m_samples_A1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_A1[i], <span class="at">sd =</span> <span class="fl">0.6</span>)</span>
<span id="cb26-277"><a href="#cb26-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-278"><a href="#cb26-278" aria-hidden="true" tabindex="-1"></a>  w_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(age[i], bmi[i], cvd[i], egfr[i], statin[i])</span>
<span id="cb26-279"><a href="#cb26-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-280"><a href="#cb26-280" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E[Y(1, M(0))] - average over M drawn from P(M|A=0,W)</span></span>
<span id="cb26-281"><a href="#cb26-281" aria-hidden="true" tabindex="-1"></a>  lp_1_m0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.40</span> <span class="sc">*</span> m_samples_A0 <span class="sc">+</span></span>
<span id="cb26-282"><a href="#cb26-282" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.04</span> <span class="sc">*</span> (w_vec[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (w_vec[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb26-283"><a href="#cb26-283" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.90</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>] <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (w_vec[<span class="dv">4</span>] <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb26-284"><a href="#cb26-284" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.25</span> <span class="sc">*</span> w_vec[<span class="dv">5</span>] <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>]</span>
<span id="cb26-285"><a href="#cb26-285" aria-hidden="true" tabindex="-1"></a>  EY_1_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_1_m0))</span>
<span id="cb26-286"><a href="#cb26-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-287"><a href="#cb26-287" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E[Y(0, M(0))]</span></span>
<span id="cb26-288"><a href="#cb26-288" aria-hidden="true" tabindex="-1"></a>  lp_0_m0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.40</span> <span class="sc">*</span> m_samples_A0 <span class="sc">+</span></span>
<span id="cb26-289"><a href="#cb26-289" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.04</span> <span class="sc">*</span> (w_vec[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (w_vec[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb26-290"><a href="#cb26-290" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.90</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>] <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (w_vec[<span class="dv">4</span>] <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb26-291"><a href="#cb26-291" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.25</span> <span class="sc">*</span> w_vec[<span class="dv">5</span>] <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>]</span>
<span id="cb26-292"><a href="#cb26-292" aria-hidden="true" tabindex="-1"></a>  EY_0_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_0_m0))</span>
<span id="cb26-293"><a href="#cb26-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-294"><a href="#cb26-294" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E[Y(1, M(1))]</span></span>
<span id="cb26-295"><a href="#cb26-295" aria-hidden="true" tabindex="-1"></a>  lp_1_m1 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.25</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.40</span> <span class="sc">*</span> m_samples_A1 <span class="sc">+</span></span>
<span id="cb26-296"><a href="#cb26-296" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.04</span> <span class="sc">*</span> (w_vec[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (w_vec[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb26-297"><a href="#cb26-297" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.90</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>] <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (w_vec[<span class="dv">4</span>] <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb26-298"><a href="#cb26-298" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.25</span> <span class="sc">*</span> w_vec[<span class="dv">5</span>] <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> w_vec[<span class="dv">3</span>]</span>
<span id="cb26-299"><a href="#cb26-299" aria-hidden="true" tabindex="-1"></a>  EY_1_M1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">plogis</span>(lp_1_m1))</span>
<span id="cb26-300"><a href="#cb26-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-301"><a href="#cb26-301" aria-hidden="true" tabindex="-1"></a>  true_nde_vals[i] <span class="ot">&lt;-</span> EY_1_M0 <span class="sc">-</span> EY_0_M0</span>
<span id="cb26-302"><a href="#cb26-302" aria-hidden="true" tabindex="-1"></a>  true_nie_vals[i] <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_1_M0</span>
<span id="cb26-303"><a href="#cb26-303" aria-hidden="true" tabindex="-1"></a>  true_te_vals[i]  <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_0_M0</span>
<span id="cb26-304"><a href="#cb26-304" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-305"><a href="#cb26-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-306"><a href="#cb26-306" aria-hidden="true" tabindex="-1"></a>true_NDE <span class="ot">&lt;-</span> <span class="fu">mean</span>(true_nde_vals)</span>
<span id="cb26-307"><a href="#cb26-307" aria-hidden="true" tabindex="-1"></a>true_NIE <span class="ot">&lt;-</span> <span class="fu">mean</span>(true_nie_vals)</span>
<span id="cb26-308"><a href="#cb26-308" aria-hidden="true" tabindex="-1"></a>true_TE  <span class="ot">&lt;-</span> <span class="fu">mean</span>(true_te_vals)</span>
<span id="cb26-309"><a href="#cb26-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-310"><a href="#cb26-310" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True Total Effect: "</span>, <span class="fu">round</span>(true_TE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-311"><a href="#cb26-311" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True NDE (direct): "</span>, <span class="fu">round</span>(true_NDE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-312"><a href="#cb26-312" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True NIE (via M):  "</span>, <span class="fu">round</span>(true_NIE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-313"><a href="#cb26-313" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NDE + NIE:         "</span>, <span class="fu">round</span>(true_NDE <span class="sc">+</span> true_NIE, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-314"><a href="#cb26-314" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion mediated:"</span>, <span class="fu">round</span>(true_NIE <span class="sc">/</span> true_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-315"><a href="#cb26-315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-316"><a href="#cb26-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-317"><a href="#cb26-317" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-318"><a href="#cb26-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-319"><a href="#cb26-319" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Why Naive Approaches Fail</span></span>
<span id="cb26-320"><a href="#cb26-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-321"><a href="#cb26-321" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4A. The Baron-Kenny Trap</span></span>
<span id="cb26-322"><a href="#cb26-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-323"><a href="#cb26-323" aria-hidden="true" tabindex="-1"></a>The classic approach fits two regressions and reads off coefficients. Let's see what it gives us:</span>
<span id="cb26-324"><a href="#cb26-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-327"><a href="#cb26-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-328"><a href="#cb26-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Total effect</span></span>
<span id="cb26-329"><a href="#cb26-329" aria-hidden="true" tabindex="-1"></a>total_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb26-330"><a href="#cb26-330" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb26-331"><a href="#cb26-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-332"><a href="#cb26-332" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Mediator model</span></span>
<span id="cb26-333"><a href="#cb26-333" aria-hidden="true" tabindex="-1"></a>med_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(M <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb26-334"><a href="#cb26-334" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> dat)</span>
<span id="cb26-335"><a href="#cb26-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-336"><a href="#cb26-336" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Outcome model with mediator</span></span>
<span id="cb26-337"><a href="#cb26-337" aria-hidden="true" tabindex="-1"></a>full_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb26-338"><a href="#cb26-338" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb26-339"><a href="#cb26-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-340"><a href="#cb26-340" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Baron-Kenny style coefficients ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-341"><a href="#cb26-341" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total effect (A in model without M):"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(total_mod)[<span class="st">"A"</span>], <span class="dv">3</span>), <span class="st">"(log-OR)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-342"><a href="#cb26-342" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Direct effect (A in model with M):  "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(full_mod)[<span class="st">"A"</span>], <span class="dv">3</span>), <span class="st">"(log-OR)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-343"><a href="#cb26-343" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mediator effect (M on Y):           "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(full_mod)[<span class="st">"M"</span>], <span class="dv">3</span>), <span class="st">"(log-OR)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-344"><a href="#cb26-344" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Treatment on mediator:              "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(med_mod)[<span class="st">"A"</span>], <span class="dv">3</span>), <span class="st">"(mean change)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-345"><a href="#cb26-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-346"><a href="#cb26-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-347"><a href="#cb26-347" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb26-348"><a href="#cb26-348" aria-hidden="true" tabindex="-1"></a><span class="fu">## What's Wrong with Baron-Kenny Here?</span></span>
<span id="cb26-349"><a href="#cb26-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-350"><a href="#cb26-350" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Scale:** The coefficients are on the log-odds scale. The "difference in coefficients" method ($TE - DE$) does not equal the indirect effect on the risk difference scale for non-linear models.</span>
<span id="cb26-351"><a href="#cb26-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-352"><a href="#cb26-352" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Non-collapsibility:** The log-odds ratio is non-collapsible — the coefficient of $A$ changes when you add $M$ to the model, even if there is NO mediation, simply because of the non-linear link function.</span>
<span id="cb26-353"><a href="#cb26-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-354"><a href="#cb26-354" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**No valid standard errors** for the indirect effect without additional assumptions.</span>
<span id="cb26-355"><a href="#cb26-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-356"><a href="#cb26-356" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**No double robustness** — if either model is misspecified, everything is biased.</span>
<span id="cb26-357"><a href="#cb26-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-358"><a href="#cb26-358" aria-hidden="true" tabindex="-1"></a>We need a proper decomposition on the risk difference scale.</span>
<span id="cb26-359"><a href="#cb26-359" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-360"><a href="#cb26-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-361"><a href="#cb26-361" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-362"><a href="#cb26-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-363"><a href="#cb26-363" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4B. Naive Regression-Based Decomposition on the Risk Difference Scale</span></span>
<span id="cb26-364"><a href="#cb26-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-365"><a href="#cb26-365" aria-hidden="true" tabindex="-1"></a>A better approach: use G-computation-style prediction, but decompose manually.</span>
<span id="cb26-366"><a href="#cb26-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-369"><a href="#cb26-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-370"><a href="#cb26-370" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model including the mediator</span></span>
<span id="cb26-371"><a href="#cb26-371" aria-hidden="true" tabindex="-1"></a>q_med_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb26-372"><a href="#cb26-372" aria-hidden="true" tabindex="-1"></a>                   A<span class="sc">:</span>cvd,</span>
<span id="cb26-373"><a href="#cb26-373" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb26-374"><a href="#cb26-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-375"><a href="#cb26-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Mediator model</span></span>
<span id="cb26-376"><a href="#cb26-376" aria-hidden="true" tabindex="-1"></a>m_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(M <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> egfr, <span class="at">data =</span> dat)</span>
<span id="cb26-377"><a href="#cb26-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-378"><a href="#cb26-378" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted mediator values under A=0 and A=1</span></span>
<span id="cb26-379"><a href="#cb26-379" aria-hidden="true" tabindex="-1"></a>M_hat_A0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>))</span>
<span id="cb26-380"><a href="#cb26-380" aria-hidden="true" tabindex="-1"></a>M_hat_A1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>))</span>
<span id="cb26-381"><a href="#cb26-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-382"><a href="#cb26-382" aria-hidden="true" tabindex="-1"></a><span class="co"># E[Y(1, M(0))]: set A=1, M=M_hat_A0</span></span>
<span id="cb26-383"><a href="#cb26-383" aria-hidden="true" tabindex="-1"></a>EY_1_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(q_med_mod,</span>
<span id="cb26-384"><a href="#cb26-384" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> M_hat_A0),</span>
<span id="cb26-385"><a href="#cb26-385" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb26-386"><a href="#cb26-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-387"><a href="#cb26-387" aria-hidden="true" tabindex="-1"></a><span class="co"># E[Y(0, M(0))]: set A=0, M=M_hat_A0</span></span>
<span id="cb26-388"><a href="#cb26-388" aria-hidden="true" tabindex="-1"></a>EY_0_M0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(q_med_mod,</span>
<span id="cb26-389"><a href="#cb26-389" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>, <span class="at">M =</span> M_hat_A0),</span>
<span id="cb26-390"><a href="#cb26-390" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb26-391"><a href="#cb26-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-392"><a href="#cb26-392" aria-hidden="true" tabindex="-1"></a><span class="co"># E[Y(1, M(1))]: set A=1, M=M_hat_A1</span></span>
<span id="cb26-393"><a href="#cb26-393" aria-hidden="true" tabindex="-1"></a>EY_1_M1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">predict</span>(q_med_mod,</span>
<span id="cb26-394"><a href="#cb26-394" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> M_hat_A1),</span>
<span id="cb26-395"><a href="#cb26-395" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb26-396"><a href="#cb26-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-397"><a href="#cb26-397" aria-hidden="true" tabindex="-1"></a>naive_NDE <span class="ot">&lt;-</span> EY_1_M0 <span class="sc">-</span> EY_0_M0</span>
<span id="cb26-398"><a href="#cb26-398" aria-hidden="true" tabindex="-1"></a>naive_NIE <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_1_M0</span>
<span id="cb26-399"><a href="#cb26-399" aria-hidden="true" tabindex="-1"></a>naive_TE  <span class="ot">&lt;-</span> EY_1_M1 <span class="sc">-</span> EY_0_M0</span>
<span id="cb26-400"><a href="#cb26-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-401"><a href="#cb26-401" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp NDE:"</span>, <span class="fu">round</span>(naive_NDE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NDE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-402"><a href="#cb26-402" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp NIE:"</span>, <span class="fu">round</span>(naive_NIE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NIE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-403"><a href="#cb26-403" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp TE: "</span>, <span class="fu">round</span>(naive_TE, <span class="dv">4</span>),  <span class="st">" (true:"</span>, <span class="fu">round</span>(true_TE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-404"><a href="#cb26-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-405"><a href="#cb26-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-406"><a href="#cb26-406" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb26-407"><a href="#cb26-407" aria-hidden="true" tabindex="-1"></a><span class="fu">## This Is G-Computation for Mediation</span></span>
<span id="cb26-408"><a href="#cb26-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-409"><a href="#cb26-409" aria-hidden="true" tabindex="-1"></a>This approach correctly decomposes the effect on the risk difference scale. But it has the same weakness as point-treatment G-computation: it depends entirely on both the outcome model AND the mediator model being correctly specified. There is no robustness to misspecification.</span>
<span id="cb26-410"><a href="#cb26-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-411"><a href="#cb26-411" aria-hidden="true" tabindex="-1"></a>TMLE adds targeting to make this doubly robust.</span>
<span id="cb26-412"><a href="#cb26-412" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-413"><a href="#cb26-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-414"><a href="#cb26-414" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-415"><a href="#cb26-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-416"><a href="#cb26-416" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. TMLE for Mediation: Step by Step</span></span>
<span id="cb26-417"><a href="#cb26-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-418"><a href="#cb26-418" aria-hidden="true" tabindex="-1"></a>We now implement a TMLE-based mediation analysis. The algorithm extends the point-treatment TMLE in a specific way: we need to "target" the outcome model not just for the treatment mechanism, but also for the mediator mechanism.</span>
<span id="cb26-419"><a href="#cb26-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-420"><a href="#cb26-420" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Algorithm Overview</span></span>
<span id="cb26-421"><a href="#cb26-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-422"><a href="#cb26-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-423"><a href="#cb26-423" aria-hidden="true" tabindex="-1"></a><span class="in">┌───────────────────────────────────────┐</span></span>
<span id="cb26-424"><a href="#cb26-424" aria-hidden="true" tabindex="-1"></a><span class="in">│ Step 1: Fit the outcome model         │</span></span>
<span id="cb26-425"><a href="#cb26-425" aria-hidden="true" tabindex="-1"></a><span class="in">│ Q(A, M, W) = E[Y | A, M, W]          │</span></span>
<span id="cb26-426"><a href="#cb26-426" aria-hidden="true" tabindex="-1"></a><span class="in">│ Predict under (A=1,M) and (A=0,M)    │</span></span>
<span id="cb26-427"><a href="#cb26-427" aria-hidden="true" tabindex="-1"></a><span class="in">└───────────────┬───────────────────────┘</span></span>
<span id="cb26-428"><a href="#cb26-428" aria-hidden="true" tabindex="-1"></a><span class="in">                │</span></span>
<span id="cb26-429"><a href="#cb26-429" aria-hidden="true" tabindex="-1"></a><span class="in">┌───────────────▼───────────────────────┐</span></span>
<span id="cb26-430"><a href="#cb26-430" aria-hidden="true" tabindex="-1"></a><span class="in">│ Step 2: Fit the mediator model        │</span></span>
<span id="cb26-431"><a href="#cb26-431" aria-hidden="true" tabindex="-1"></a><span class="in">│ P(M | A, W)                           │</span></span>
<span id="cb26-432"><a href="#cb26-432" aria-hidden="true" tabindex="-1"></a><span class="in">│ Needed for NDE/NIE decomposition      │</span></span>
<span id="cb26-433"><a href="#cb26-433" aria-hidden="true" tabindex="-1"></a><span class="in">└───────────────┬───────────────────────┘</span></span>
<span id="cb26-434"><a href="#cb26-434" aria-hidden="true" tabindex="-1"></a><span class="in">                │</span></span>
<span id="cb26-435"><a href="#cb26-435" aria-hidden="true" tabindex="-1"></a><span class="in">┌───────────────▼───────────────────────┐</span></span>
<span id="cb26-436"><a href="#cb26-436" aria-hidden="true" tabindex="-1"></a><span class="in">│ Step 3: Fit the treatment model       │</span></span>
<span id="cb26-437"><a href="#cb26-437" aria-hidden="true" tabindex="-1"></a><span class="in">│ g(W) = P(A=1 | W)                     │</span></span>
<span id="cb26-438"><a href="#cb26-438" aria-hidden="true" tabindex="-1"></a><span class="in">│ Needed for the clever covariate       │</span></span>
<span id="cb26-439"><a href="#cb26-439" aria-hidden="true" tabindex="-1"></a><span class="in">└───────────────┬───────────────────────┘</span></span>
<span id="cb26-440"><a href="#cb26-440" aria-hidden="true" tabindex="-1"></a><span class="in">                │</span></span>
<span id="cb26-441"><a href="#cb26-441" aria-hidden="true" tabindex="-1"></a><span class="in">┌───────────────▼───────────────────────┐</span></span>
<span id="cb26-442"><a href="#cb26-442" aria-hidden="true" tabindex="-1"></a><span class="in">│ Step 4: Compute mediation-specific    │</span></span>
<span id="cb26-443"><a href="#cb26-443" aria-hidden="true" tabindex="-1"></a><span class="in">│ clever covariates for NDE and NIE     │</span></span>
<span id="cb26-444"><a href="#cb26-444" aria-hidden="true" tabindex="-1"></a><span class="in">└───────────────┬───────────────────────┘</span></span>
<span id="cb26-445"><a href="#cb26-445" aria-hidden="true" tabindex="-1"></a><span class="in">                │</span></span>
<span id="cb26-446"><a href="#cb26-446" aria-hidden="true" tabindex="-1"></a><span class="in">┌───────────────▼───────────────────────┐</span></span>
<span id="cb26-447"><a href="#cb26-447" aria-hidden="true" tabindex="-1"></a><span class="in">│ Step 5: Fluctuate Q to get Q*         │</span></span>
<span id="cb26-448"><a href="#cb26-448" aria-hidden="true" tabindex="-1"></a><span class="in">│ (targeting step for each effect)      │</span></span>
<span id="cb26-449"><a href="#cb26-449" aria-hidden="true" tabindex="-1"></a><span class="in">└───────────────┬───────────────────────┘</span></span>
<span id="cb26-450"><a href="#cb26-450" aria-hidden="true" tabindex="-1"></a><span class="in">                │</span></span>
<span id="cb26-451"><a href="#cb26-451" aria-hidden="true" tabindex="-1"></a><span class="in">┌───────────────▼───────────────────────┐</span></span>
<span id="cb26-452"><a href="#cb26-452" aria-hidden="true" tabindex="-1"></a><span class="in">│ Step 6: Plug Q* into mediation        │</span></span>
<span id="cb26-453"><a href="#cb26-453" aria-hidden="true" tabindex="-1"></a><span class="in">│ formulas to estimate NDE and NIE      │</span></span>
<span id="cb26-454"><a href="#cb26-454" aria-hidden="true" tabindex="-1"></a><span class="in">└───────────────────────────────────────┘</span></span>
<span id="cb26-455"><a href="#cb26-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-456"><a href="#cb26-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-457"><a href="#cb26-457" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-458"><a href="#cb26-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-459"><a href="#cb26-459" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Fit the Outcome Model</span></span>
<span id="cb26-460"><a href="#cb26-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-461"><a href="#cb26-461" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb26-462"><a href="#cb26-462" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Model E[Y | A, M, W]</span></span>
<span id="cb26-463"><a href="#cb26-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-464"><a href="#cb26-464" aria-hidden="true" tabindex="-1"></a>Just like standard TMLE, start by fitting a model for the expected outcome. But now the model includes the **mediator** $M$ as a predictor alongside treatment $A$ and confounders $W$.</span>
<span id="cb26-465"><a href="#cb26-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-466"><a href="#cb26-466" aria-hidden="true" tabindex="-1"></a>$$\hat{Q}(A, M, W) = \hat{E}<span class="co">[</span><span class="ot">Y \mid A, M, W</span><span class="co">]</span>$$</span>
<span id="cb26-467"><a href="#cb26-467" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-468"><a href="#cb26-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-471"><a href="#cb26-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-472"><a href="#cb26-472" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb26-473"><a href="#cb26-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-474"><a href="#cb26-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model: includes treatment, mediator, and confounders</span></span>
<span id="cb26-475"><a href="#cb26-475" aria-hidden="true" tabindex="-1"></a>q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb26-476"><a href="#cb26-476" aria-hidden="true" tabindex="-1"></a>               A<span class="sc">:</span>cvd <span class="sc">+</span> A<span class="sc">:</span>M,</span>
<span id="cb26-477"><a href="#cb26-477" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb26-478"><a href="#cb26-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-479"><a href="#cb26-479" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict at observed values</span></span>
<span id="cb26-480"><a href="#cb26-480" aria-hidden="true" tabindex="-1"></a>QAM_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-481"><a href="#cb26-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-482"><a href="#cb26-482" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict under counterfactual treatment values (keeping M observed)</span></span>
<span id="cb26-483"><a href="#cb26-483" aria-hidden="true" tabindex="-1"></a>Q1M_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-484"><a href="#cb26-484" aria-hidden="true" tabindex="-1"></a>Q0M_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-485"><a href="#cb26-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-486"><a href="#cb26-486" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q(A,M,W) range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(QAM_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-487"><a href="#cb26-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-488"><a href="#cb26-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-489"><a href="#cb26-489" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-490"><a href="#cb26-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-491"><a href="#cb26-491" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Fit the Mediator Model</span></span>
<span id="cb26-492"><a href="#cb26-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-493"><a href="#cb26-493" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb26-494"><a href="#cb26-494" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Model P(M | A, W) — The Mediator Distribution</span></span>
<span id="cb26-495"><a href="#cb26-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-496"><a href="#cb26-496" aria-hidden="true" tabindex="-1"></a>To decompose the total effect, we need to know how the mediator distribution shifts under treatment vs. control. For a continuous mediator, we model $M \mid A, W$ as normally distributed.</span>
<span id="cb26-497"><a href="#cb26-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-498"><a href="#cb26-498" aria-hidden="true" tabindex="-1"></a>This model serves two purposes:</span>
<span id="cb26-499"><a href="#cb26-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-500"><a href="#cb26-500" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>It tells us what $M$ values to expect under $A = 0$ vs. $A = 1$</span>
<span id="cb26-501"><a href="#cb26-501" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>It provides density ratios needed for the clever covariate</span>
<span id="cb26-502"><a href="#cb26-502" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-503"><a href="#cb26-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-506"><a href="#cb26-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-507"><a href="#cb26-507" aria-hidden="true" tabindex="-1"></a><span class="co"># Mediator model: how does M depend on A and W?</span></span>
<span id="cb26-508"><a href="#cb26-508" aria-hidden="true" tabindex="-1"></a>m_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(M <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> egfr, <span class="at">data =</span> dat)</span>
<span id="cb26-509"><a href="#cb26-509" aria-hidden="true" tabindex="-1"></a>sigma_m <span class="ot">&lt;-</span> <span class="fu">sigma</span>(m_mod)</span>
<span id="cb26-510"><a href="#cb26-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-511"><a href="#cb26-511" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted mediator mean under A=0 and A=1</span></span>
<span id="cb26-512"><a href="#cb26-512" aria-hidden="true" tabindex="-1"></a>M_mean_a0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>))</span>
<span id="cb26-513"><a href="#cb26-513" aria-hidden="true" tabindex="-1"></a>M_mean_a1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>))</span>
<span id="cb26-514"><a href="#cb26-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-515"><a href="#cb26-515" aria-hidden="true" tabindex="-1"></a><span class="co"># Density of observed M under each treatment condition</span></span>
<span id="cb26-516"><a href="#cb26-516" aria-hidden="true" tabindex="-1"></a><span class="co"># P(M_obs | A=0, W) and P(M_obs | A=1, W)</span></span>
<span id="cb26-517"><a href="#cb26-517" aria-hidden="true" tabindex="-1"></a>dens_M_A0 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(dat<span class="sc">$</span>M, <span class="at">mean =</span> M_mean_a0, <span class="at">sd =</span> sigma_m)</span>
<span id="cb26-518"><a href="#cb26-518" aria-hidden="true" tabindex="-1"></a>dens_M_A1 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(dat<span class="sc">$</span>M, <span class="at">mean =</span> M_mean_a1, <span class="at">sd =</span> sigma_m)</span>
<span id="cb26-519"><a href="#cb26-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-520"><a href="#cb26-520" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean mediator shift (A=1 vs A=0):"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(M_mean_a1 <span class="sc">-</span> M_mean_a0), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-521"><a href="#cb26-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-522"><a href="#cb26-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-523"><a href="#cb26-523" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-524"><a href="#cb26-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-525"><a href="#cb26-525" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Fit the Treatment Model</span></span>
<span id="cb26-526"><a href="#cb26-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-527"><a href="#cb26-527" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb26-528"><a href="#cb26-528" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Model P(A = 1 | W) — The Propensity Score</span></span>
<span id="cb26-529"><a href="#cb26-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-530"><a href="#cb26-530" aria-hidden="true" tabindex="-1"></a>Same as standard TMLE. The propensity score is needed for the clever covariates.</span>
<span id="cb26-531"><a href="#cb26-531" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-532"><a href="#cb26-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-535"><a href="#cb26-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-536"><a href="#cb26-536" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c_bl <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin,</span>
<span id="cb26-537"><a href="#cb26-537" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb26-538"><a href="#cb26-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-539"><a href="#cb26-539" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-540"><a href="#cb26-540" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.01</span>, <span class="fu">pmin</span>(<span class="fl">0.99</span>, ps))</span>
<span id="cb26-541"><a href="#cb26-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-542"><a href="#cb26-542" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Propensity score range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(ps), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-543"><a href="#cb26-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-544"><a href="#cb26-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-545"><a href="#cb26-545" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-546"><a href="#cb26-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-547"><a href="#cb26-547" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: The Mediation Clever Covariates</span></span>
<span id="cb26-548"><a href="#cb26-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-549"><a href="#cb26-549" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb26-550"><a href="#cb26-550" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Clever Covariates for NDE and NIE</span></span>
<span id="cb26-551"><a href="#cb26-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-552"><a href="#cb26-552" aria-hidden="true" tabindex="-1"></a>This is where mediation TMLE differs from standard TMLE. The clever covariate for the NDE is different from the one for the NIE, because they target different estimands.</span>
<span id="cb26-553"><a href="#cb26-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-554"><a href="#cb26-554" aria-hidden="true" tabindex="-1"></a>**For the NDE**, we need the expected outcome under $A = 1$ vs. $A = 0$ while holding $M$ at its distribution under $A = 0$. The clever covariate involves a **density ratio** that reweights the mediator distribution:</span>
<span id="cb26-555"><a href="#cb26-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-556"><a href="#cb26-556" aria-hidden="true" tabindex="-1"></a>$$H^{NDE}(A, M, W) = \frac{I(A=1) \cdot f(M \mid A=0, W)}{g(W) \cdot f(M \mid A=1, W)} - \frac{I(A=0)}{1 - g(W)}$$</span>
<span id="cb26-557"><a href="#cb26-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-558"><a href="#cb26-558" aria-hidden="true" tabindex="-1"></a>**For the NIE**, we need the expected outcome under $A = 1$ comparing the mediator distribution under $A = 1$ vs. $A = 0$:</span>
<span id="cb26-559"><a href="#cb26-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-560"><a href="#cb26-560" aria-hidden="true" tabindex="-1"></a>$$H^{NIE}(A, M, W) = \frac{I(A=1)}{g(W)} - \frac{I(A=1) \cdot f(M \mid A=0, W)}{g(W) \cdot f(M \mid A=1, W)}$$</span>
<span id="cb26-561"><a href="#cb26-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-562"><a href="#cb26-562" aria-hidden="true" tabindex="-1"></a>The density ratio $f(M \mid A=0, W) / f(M \mid A=1, W)$ is what connects the mediator model to the targeting step. It reweights the treated group's mediator values to look like the control group's mediator distribution.</span>
<span id="cb26-563"><a href="#cb26-563" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-564"><a href="#cb26-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-567"><a href="#cb26-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-568"><a href="#cb26-568" aria-hidden="true" tabindex="-1"></a><span class="co"># Density ratio: P(M | A=0, W) / P(M | A=1, W)</span></span>
<span id="cb26-569"><a href="#cb26-569" aria-hidden="true" tabindex="-1"></a><span class="co"># This ratio "transports" the mediator distribution from control to treatment</span></span>
<span id="cb26-570"><a href="#cb26-570" aria-hidden="true" tabindex="-1"></a>density_ratio <span class="ot">&lt;-</span> dens_M_A0 <span class="sc">/</span> <span class="fu">pmax</span>(dens_M_A1, <span class="fl">1e-10</span>)</span>
<span id="cb26-571"><a href="#cb26-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-572"><a href="#cb26-572" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for NDE</span></span>
<span id="cb26-573"><a href="#cb26-573" aria-hidden="true" tabindex="-1"></a>H_NDE <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">*</span> density_ratio <span class="sc">/</span> ps <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)</span>
<span id="cb26-574"><a href="#cb26-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-575"><a href="#cb26-575" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for NIE</span></span>
<span id="cb26-576"><a href="#cb26-576" aria-hidden="true" tabindex="-1"></a>H_NIE <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">/</span> ps <span class="sc">-</span> dat<span class="sc">$</span>A <span class="sc">*</span> density_ratio <span class="sc">/</span> ps</span>
<span id="cb26-577"><a href="#cb26-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-578"><a href="#cb26-578" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Density ratio range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(density_ratio), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-579"><a href="#cb26-579" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"H_NDE range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(H_NDE), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-580"><a href="#cb26-580" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"H_NIE range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(H_NIE), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-581"><a href="#cb26-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-582"><a href="#cb26-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-583"><a href="#cb26-583" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb26-584"><a href="#cb26-584" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Does the Density Ratio Do?</span></span>
<span id="cb26-585"><a href="#cb26-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-586"><a href="#cb26-586" aria-hidden="true" tabindex="-1"></a>The density ratio $f(M \mid A=0, W) / f(M \mid A=1, W)$ answers: "How much more (or less) likely is this particular mediator value under control than under treatment?"</span>
<span id="cb26-587"><a href="#cb26-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-588"><a href="#cb26-588" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Ratio &gt; 1:** This mediator value is more typical of the control group → gets upweighted</span>
<span id="cb26-589"><a href="#cb26-589" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Ratio &lt; 1:** This mediator value is more typical of the treatment group → gets downweighted</span>
<span id="cb26-590"><a href="#cb26-590" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Ratio ≈ 1:** This mediator value is equally likely under both treatments</span>
<span id="cb26-591"><a href="#cb26-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-592"><a href="#cb26-592" aria-hidden="true" tabindex="-1"></a>When we multiply a treated patient's outcome by this ratio, we effectively "transport" their mediator to what it would have looked like without treatment — which is exactly what the NDE requires.</span>
<span id="cb26-593"><a href="#cb26-593" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-594"><a href="#cb26-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-595"><a href="#cb26-595" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-596"><a href="#cb26-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-597"><a href="#cb26-597" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Targeting (Fluctuation) for NDE</span></span>
<span id="cb26-598"><a href="#cb26-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-599"><a href="#cb26-599" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb26-600"><a href="#cb26-600" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Fluctuate Q to Target the NDE</span></span>
<span id="cb26-601"><a href="#cb26-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-602"><a href="#cb26-602" aria-hidden="true" tabindex="-1"></a>Just like standard TMLE, we fit a logistic regression with the initial $\hat{Q}$ as an offset and the NDE clever covariate as the predictor. The coefficient $\epsilon$ tells us how much to update.</span>
<span id="cb26-603"><a href="#cb26-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-604"><a href="#cb26-604" aria-hidden="true" tabindex="-1"></a>$$\text{logit}(Y) = \text{logit}(\hat{Q}(A, M, W)) + \epsilon_{NDE} \cdot H_{NDE}$$</span>
<span id="cb26-605"><a href="#cb26-605" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-606"><a href="#cb26-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-609"><a href="#cb26-609" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-610"><a href="#cb26-610" aria-hidden="true" tabindex="-1"></a><span class="co"># Fluctuation for NDE</span></span>
<span id="cb26-611"><a href="#cb26-611" aria-hidden="true" tabindex="-1"></a>fluc_nde <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QAM_init)) <span class="sc">+</span> H_NDE,</span>
<span id="cb26-612"><a href="#cb26-612" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial)</span>
<span id="cb26-613"><a href="#cb26-613" aria-hidden="true" tabindex="-1"></a>eps_nde <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc_nde)</span>
<span id="cb26-614"><a href="#cb26-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-615"><a href="#cb26-615" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon NDE:"</span>, <span class="fu">round</span>(eps_nde, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-616"><a href="#cb26-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-617"><a href="#cb26-617" aria-hidden="true" tabindex="-1"></a><span class="co"># Update Q predictions</span></span>
<span id="cb26-618"><a href="#cb26-618" aria-hidden="true" tabindex="-1"></a>Q1M_star_nde <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q1M_init) <span class="sc">+</span> eps_nde <span class="sc">*</span> density_ratio <span class="sc">/</span> ps)</span>
<span id="cb26-619"><a href="#cb26-619" aria-hidden="true" tabindex="-1"></a>Q0M_star_nde <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q0M_init) <span class="sc">+</span> eps_nde <span class="sc">*</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)))</span>
<span id="cb26-620"><a href="#cb26-620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-621"><a href="#cb26-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-622"><a href="#cb26-622" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-623"><a href="#cb26-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-624"><a href="#cb26-624" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 6: Compute the NDE</span></span>
<span id="cb26-625"><a href="#cb26-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-626"><a href="#cb26-626" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb26-627"><a href="#cb26-627" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 6: Plug-in NDE Estimate</span></span>
<span id="cb26-628"><a href="#cb26-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-629"><a href="#cb26-629" aria-hidden="true" tabindex="-1"></a>The NDE is the difference in the targeted outcome predictions, averaged over the population, where the mediator is held at its **control** distribution.</span>
<span id="cb26-630"><a href="#cb26-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-631"><a href="#cb26-631" aria-hidden="true" tabindex="-1"></a>For the treated group (with density-reweighted mediator), we average:</span>
<span id="cb26-632"><a href="#cb26-632" aria-hidden="true" tabindex="-1"></a>$$\widehat{NDE} = \frac{1}{n}\sum_i \hat{Q}^*_1(M_i, W_i) \cdot r(M_i, W_i) - \frac{1}{n}\sum_i \hat{Q}^*_0(M_i, W_i)$$</span>
<span id="cb26-633"><a href="#cb26-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-634"><a href="#cb26-634" aria-hidden="true" tabindex="-1"></a>where $r(M_i, W_i)$ is a normalized version of the density ratio that integrates properly.</span>
<span id="cb26-635"><a href="#cb26-635" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-636"><a href="#cb26-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-639"><a href="#cb26-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-640"><a href="#cb26-640" aria-hidden="true" tabindex="-1"></a><span class="co"># For the NDE, we need E[Q*(1,M,W)] where M ~ P(M|A=0,W)</span></span>
<span id="cb26-641"><a href="#cb26-641" aria-hidden="true" tabindex="-1"></a><span class="co"># We use the density-ratio weighted average among treated</span></span>
<span id="cb26-642"><a href="#cb26-642" aria-hidden="true" tabindex="-1"></a><span class="co"># and the direct average among controls</span></span>
<span id="cb26-643"><a href="#cb26-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-644"><a href="#cb26-644" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach: Monte Carlo integration over P(M | A=0, W)</span></span>
<span id="cb26-645"><a href="#cb26-645" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb26-646"><a href="#cb26-646" aria-hidden="true" tabindex="-1"></a>n_mc <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb26-647"><a href="#cb26-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-648"><a href="#cb26-648" aria-hidden="true" tabindex="-1"></a>nde_mc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb26-649"><a href="#cb26-649" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb26-650"><a href="#cb26-650" aria-hidden="true" tabindex="-1"></a>  m_draws <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m)</span>
<span id="cb26-651"><a href="#cb26-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-652"><a href="#cb26-652" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Density ratio for each MC draw: f(m|A=0,W) / f(m|A=1,W)</span></span>
<span id="cb26-653"><a href="#cb26-653" aria-hidden="true" tabindex="-1"></a>  dr_draws <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(m_draws, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m) <span class="sc">/</span></span>
<span id="cb26-654"><a href="#cb26-654" aria-hidden="true" tabindex="-1"></a>              <span class="fu">pmax</span>(<span class="fu">dnorm</span>(m_draws, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m), <span class="fl">1e-10</span>)</span>
<span id="cb26-655"><a href="#cb26-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-656"><a href="#cb26-656" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q*(1, m, W) for each m draw</span></span>
<span id="cb26-657"><a href="#cb26-657" aria-hidden="true" tabindex="-1"></a>  <span class="co"># H_NDE at (A=1, m) = density_ratio(m) / ps</span></span>
<span id="cb26-658"><a href="#cb26-658" aria-hidden="true" tabindex="-1"></a>  newdat_1 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> m_draws)</span>
<span id="cb26-659"><a href="#cb26-659" aria-hidden="true" tabindex="-1"></a>  q1m <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-660"><a href="#cb26-660" aria-hidden="true" tabindex="-1"></a>  q1m_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q1m) <span class="sc">+</span> eps_nde <span class="sc">*</span> dr_draws <span class="sc">/</span> ps[i])</span>
<span id="cb26-661"><a href="#cb26-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-662"><a href="#cb26-662" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q*(0, m, W) for each m draw</span></span>
<span id="cb26-663"><a href="#cb26-663" aria-hidden="true" tabindex="-1"></a>  <span class="co"># H_NDE at (A=0, m) = -1 / (1 - ps)</span></span>
<span id="cb26-664"><a href="#cb26-664" aria-hidden="true" tabindex="-1"></a>  newdat_0 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>, <span class="at">M =</span> m_draws)</span>
<span id="cb26-665"><a href="#cb26-665" aria-hidden="true" tabindex="-1"></a>  q0m <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_0, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-666"><a href="#cb26-666" aria-hidden="true" tabindex="-1"></a>  q0m_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q0m) <span class="sc">+</span> eps_nde <span class="sc">*</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps[i])))</span>
<span id="cb26-667"><a href="#cb26-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-668"><a href="#cb26-668" aria-hidden="true" tabindex="-1"></a>  nde_mc[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(q1m_star) <span class="sc">-</span> <span class="fu">mean</span>(q0m_star)</span>
<span id="cb26-669"><a href="#cb26-669" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-670"><a href="#cb26-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-671"><a href="#cb26-671" aria-hidden="true" tabindex="-1"></a>tmle_NDE <span class="ot">&lt;-</span> <span class="fu">mean</span>(nde_mc)</span>
<span id="cb26-672"><a href="#cb26-672" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE NDE:"</span>, <span class="fu">round</span>(tmle_NDE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NDE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-673"><a href="#cb26-673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-674"><a href="#cb26-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-675"><a href="#cb26-675" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-676"><a href="#cb26-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-677"><a href="#cb26-677" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 7: Targeting and Computing the NIE</span></span>
<span id="cb26-678"><a href="#cb26-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-681"><a href="#cb26-681" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-682"><a href="#cb26-682" aria-hidden="true" tabindex="-1"></a><span class="co"># Fluctuation for NIE</span></span>
<span id="cb26-683"><a href="#cb26-683" aria-hidden="true" tabindex="-1"></a>fluc_nie <span class="ot">&lt;-</span> <span class="fu">glm</span>(dat<span class="sc">$</span>Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QAM_init)) <span class="sc">+</span> H_NIE,</span>
<span id="cb26-684"><a href="#cb26-684" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial)</span>
<span id="cb26-685"><a href="#cb26-685" aria-hidden="true" tabindex="-1"></a>eps_nie <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc_nie)</span>
<span id="cb26-686"><a href="#cb26-686" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon NIE:"</span>, <span class="fu">round</span>(eps_nie, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-687"><a href="#cb26-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-688"><a href="#cb26-688" aria-hidden="true" tabindex="-1"></a><span class="co"># Monte Carlo integration for NIE</span></span>
<span id="cb26-689"><a href="#cb26-689" aria-hidden="true" tabindex="-1"></a>nie_mc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb26-690"><a href="#cb26-690" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb26-691"><a href="#cb26-691" aria-hidden="true" tabindex="-1"></a>  <span class="co"># M draws from P(M|A=1,W)</span></span>
<span id="cb26-692"><a href="#cb26-692" aria-hidden="true" tabindex="-1"></a>  m_draws_a1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m)</span>
<span id="cb26-693"><a href="#cb26-693" aria-hidden="true" tabindex="-1"></a>  <span class="co"># M draws from P(M|A=0,W)</span></span>
<span id="cb26-694"><a href="#cb26-694" aria-hidden="true" tabindex="-1"></a>  m_draws_a0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m)</span>
<span id="cb26-695"><a href="#cb26-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-696"><a href="#cb26-696" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Density ratios for each draw: f(m|A=0,W) / f(m|A=1,W)</span></span>
<span id="cb26-697"><a href="#cb26-697" aria-hidden="true" tabindex="-1"></a>  dr_a1 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(m_draws_a1, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m) <span class="sc">/</span></span>
<span id="cb26-698"><a href="#cb26-698" aria-hidden="true" tabindex="-1"></a>           <span class="fu">pmax</span>(<span class="fu">dnorm</span>(m_draws_a1, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m), <span class="fl">1e-10</span>)</span>
<span id="cb26-699"><a href="#cb26-699" aria-hidden="true" tabindex="-1"></a>  dr_a0 <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(m_draws_a0, <span class="at">mean =</span> M_mean_a0[i], <span class="at">sd =</span> sigma_m) <span class="sc">/</span></span>
<span id="cb26-700"><a href="#cb26-700" aria-hidden="true" tabindex="-1"></a>           <span class="fu">pmax</span>(<span class="fu">dnorm</span>(m_draws_a0, <span class="at">mean =</span> M_mean_a1[i], <span class="at">sd =</span> sigma_m), <span class="fl">1e-10</span>)</span>
<span id="cb26-701"><a href="#cb26-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-702"><a href="#cb26-702" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q*(1, M(1), W) - Q*(1, M(0), W)</span></span>
<span id="cb26-703"><a href="#cb26-703" aria-hidden="true" tabindex="-1"></a>  <span class="co"># H_NIE at (A=1, m) = (1 - density_ratio(m)) / ps</span></span>
<span id="cb26-704"><a href="#cb26-704" aria-hidden="true" tabindex="-1"></a>  newdat_1_m1 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> m_draws_a1)</span>
<span id="cb26-705"><a href="#cb26-705" aria-hidden="true" tabindex="-1"></a>  newdat_1_m0 <span class="ot">&lt;-</span> dat[<span class="fu">rep</span>(i, n_mc), ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>, <span class="at">M =</span> m_draws_a0)</span>
<span id="cb26-706"><a href="#cb26-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-707"><a href="#cb26-707" aria-hidden="true" tabindex="-1"></a>  q_m1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_1_m1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-708"><a href="#cb26-708" aria-hidden="true" tabindex="-1"></a>  q_m0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> newdat_1_m0, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-709"><a href="#cb26-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-710"><a href="#cb26-710" aria-hidden="true" tabindex="-1"></a>  q_m1_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q_m1) <span class="sc">+</span> eps_nie <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> dr_a1) <span class="sc">/</span> ps[i])</span>
<span id="cb26-711"><a href="#cb26-711" aria-hidden="true" tabindex="-1"></a>  q_m0_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(q_m0) <span class="sc">+</span> eps_nie <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> dr_a0) <span class="sc">/</span> ps[i])</span>
<span id="cb26-712"><a href="#cb26-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-713"><a href="#cb26-713" aria-hidden="true" tabindex="-1"></a>  nie_mc[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(q_m1_star) <span class="sc">-</span> <span class="fu">mean</span>(q_m0_star)</span>
<span id="cb26-714"><a href="#cb26-714" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-715"><a href="#cb26-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-716"><a href="#cb26-716" aria-hidden="true" tabindex="-1"></a>tmle_NIE <span class="ot">&lt;-</span> <span class="fu">mean</span>(nie_mc)</span>
<span id="cb26-717"><a href="#cb26-717" aria-hidden="true" tabindex="-1"></a>tmle_TE  <span class="ot">&lt;-</span> tmle_NDE <span class="sc">+</span> tmle_NIE</span>
<span id="cb26-718"><a href="#cb26-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-719"><a href="#cb26-719" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE NIE:"</span>, <span class="fu">round</span>(tmle_NIE, <span class="dv">4</span>), <span class="st">" (true:"</span>, <span class="fu">round</span>(true_NIE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-720"><a href="#cb26-720" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE TE: "</span>, <span class="fu">round</span>(tmle_TE, <span class="dv">4</span>),  <span class="st">" (true:"</span>, <span class="fu">round</span>(true_TE, <span class="dv">4</span>), <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-721"><a href="#cb26-721" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-722"><a href="#cb26-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-723"><a href="#cb26-723" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-724"><a href="#cb26-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-725"><a href="#cb26-725" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. Results Comparison</span></span>
<span id="cb26-726"><a href="#cb26-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-729"><a href="#cb26-729" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-730"><a href="#cb26-730" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb26-731"><a href="#cb26-731" aria-hidden="true" tabindex="-1"></a>  <span class="at">Effect =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Total Effect"</span>, <span class="st">"Natural Direct Effect"</span>, <span class="st">"Natural Indirect Effect"</span>), <span class="dv">3</span>),</span>
<span id="cb26-732"><a href="#cb26-732" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"Naive G-comp"</span>, <span class="st">"TMLE"</span>), <span class="at">each =</span> <span class="dv">3</span>),</span>
<span id="cb26-733"><a href="#cb26-733" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">c</span>(</span>
<span id="cb26-734"><a href="#cb26-734" aria-hidden="true" tabindex="-1"></a>    true_TE, true_NDE, true_NIE,</span>
<span id="cb26-735"><a href="#cb26-735" aria-hidden="true" tabindex="-1"></a>    naive_TE, naive_NDE, naive_NIE,</span>
<span id="cb26-736"><a href="#cb26-736" aria-hidden="true" tabindex="-1"></a>    tmle_TE, tmle_NDE, tmle_NIE</span>
<span id="cb26-737"><a href="#cb26-737" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-738"><a href="#cb26-738" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-739"><a href="#cb26-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-740"><a href="#cb26-740" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb26-741"><a href="#cb26-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Method, <span class="at">values_from =</span> Estimate) <span class="sc">%&gt;%</span></span>
<span id="cb26-742"><a href="#cb26-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>)))</span>
<span id="cb26-743"><a href="#cb26-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-744"><a href="#cb26-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-747"><a href="#cb26-747" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-748"><a href="#cb26-748" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb26-749"><a href="#cb26-749" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> Estimate, <span class="at">y =</span> Effect, <span class="at">color =</span> Method, <span class="at">shape =</span> Method)) <span class="sc">+</span></span>
<span id="cb26-750"><a href="#cb26-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb26-751"><a href="#cb26-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-752"><a href="#cb26-752" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Effect Estimate (Risk Difference)"</span>,</span>
<span id="cb26-753"><a href="#cb26-753" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb26-754"><a href="#cb26-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Mediation Decomposition: Comparing Methods"</span></span>
<span id="cb26-755"><a href="#cb26-755" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-756"><a href="#cb26-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-757"><a href="#cb26-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#228833"</span>, <span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb26-758"><a href="#cb26-758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-759"><a href="#cb26-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-762"><a href="#cb26-762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-763"><a href="#cb26-763" aria-hidden="true" tabindex="-1"></a><span class="co"># Proportion mediated</span></span>
<span id="cb26-764"><a href="#cb26-764" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Proportion Mediated ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-765"><a href="#cb26-765" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True:       "</span>, <span class="fu">round</span>(true_NIE <span class="sc">/</span> true_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-766"><a href="#cb26-766" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive G-comp:"</span>, <span class="fu">round</span>(naive_NIE <span class="sc">/</span> naive_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-767"><a href="#cb26-767" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE:       "</span>, <span class="fu">round</span>(tmle_NIE <span class="sc">/</span> tmle_TE <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-768"><a href="#cb26-768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-769"><a href="#cb26-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-770"><a href="#cb26-770" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-771"><a href="#cb26-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-772"><a href="#cb26-772" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. Diagnostics for Mediation TMLE</span></span>
<span id="cb26-773"><a href="#cb26-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-774"><a href="#cb26-774" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7.1 Propensity Score Overlap</span></span>
<span id="cb26-775"><a href="#cb26-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-778"><a href="#cb26-778" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-779"><a href="#cb26-779" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb26-780"><a href="#cb26-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb26-781"><a href="#cb26-781" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-782"><a href="#cb26-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"P(A=1 | W)"</span>, <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb26-783"><a href="#cb26-783" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Propensity Score Overlap"</span></span>
<span id="cb26-784"><a href="#cb26-784" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-785"><a href="#cb26-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-786"><a href="#cb26-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb26-787"><a href="#cb26-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-788"><a href="#cb26-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-789"><a href="#cb26-789" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7.2 Mediator Distribution by Treatment</span></span>
<span id="cb26-790"><a href="#cb26-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-791"><a href="#cb26-791" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb26-792"><a href="#cb26-792" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why This Matters</span></span>
<span id="cb26-793"><a href="#cb26-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-794"><a href="#cb26-794" aria-hidden="true" tabindex="-1"></a>The NIE depends on the treatment actually **shifting** the mediator distribution. If the mediator distributions under $A = 0$ and $A = 1$ are identical, there is no indirect effect to detect.</span>
<span id="cb26-795"><a href="#cb26-795" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-796"><a href="#cb26-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-799"><a href="#cb26-799" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-800"><a href="#cb26-800" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> M, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb26-801"><a href="#cb26-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb26-802"><a href="#cb26-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-803"><a href="#cb26-803" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"6-month HbA1c change (M)"</span>,</span>
<span id="cb26-804"><a href="#cb26-804" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb26-805"><a href="#cb26-805" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Mediator Distribution by Treatment Group"</span></span>
<span id="cb26-806"><a href="#cb26-806" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-807"><a href="#cb26-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-808"><a href="#cb26-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb26-809"><a href="#cb26-809" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-810"><a href="#cb26-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-811"><a href="#cb26-811" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7.3 Density Ratio Distribution</span></span>
<span id="cb26-812"><a href="#cb26-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-813"><a href="#cb26-813" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb26-814"><a href="#cb26-814" aria-hidden="true" tabindex="-1"></a><span class="fu">## Density Ratio Instability</span></span>
<span id="cb26-815"><a href="#cb26-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-816"><a href="#cb26-816" aria-hidden="true" tabindex="-1"></a>Extreme density ratios indicate that some observed mediator values are very unlikely under one treatment but common under the other. This creates instability analogous to extreme IPTW weights.</span>
<span id="cb26-817"><a href="#cb26-817" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-818"><a href="#cb26-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-821"><a href="#cb26-821" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-822"><a href="#cb26-822" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">r =</span> density_ratio), <span class="fu">aes</span>(<span class="at">x =</span> r)) <span class="sc">+</span></span>
<span id="cb26-823"><a href="#cb26-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#CC6677"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb26-824"><a href="#cb26-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb26-825"><a href="#cb26-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-826"><a href="#cb26-826" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Density ratio f(M|A=0,W) / f(M|A=1,W)"</span>,</span>
<span id="cb26-827"><a href="#cb26-827" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb26-828"><a href="#cb26-828" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Mediator Density Ratio"</span></span>
<span id="cb26-829"><a href="#cb26-829" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-830"><a href="#cb26-830" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb26-831"><a href="#cb26-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-832"><a href="#cb26-832" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Density ratio summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-833"><a href="#cb26-833" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(density_ratio)</span>
<span id="cb26-834"><a href="#cb26-834" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion &gt; 3:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(density_ratio <span class="sc">&gt;</span> <span class="dv">3</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-835"><a href="#cb26-835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-836"><a href="#cb26-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-837"><a href="#cb26-837" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7.4 Mediator-Outcome Relationship</span></span>
<span id="cb26-838"><a href="#cb26-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-841"><a href="#cb26-841" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-842"><a href="#cb26-842" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that M actually predicts Y (otherwise no mediation to find)</span></span>
<span id="cb26-843"><a href="#cb26-843" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> M, <span class="at">y =</span> Y)) <span class="sc">+</span></span>
<span id="cb26-844"><a href="#cb26-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"#228833"</span>) <span class="sc">+</span></span>
<span id="cb26-845"><a href="#cb26-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>))) <span class="sc">+</span></span>
<span id="cb26-846"><a href="#cb26-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-847"><a href="#cb26-847" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"6-month HbA1c change (M)"</span>,</span>
<span id="cb26-848"><a href="#cb26-848" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"P(MACE)"</span>,</span>
<span id="cb26-849"><a href="#cb26-849" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Diagnostic: Mediator-Outcome Relationship by Treatment"</span></span>
<span id="cb26-850"><a href="#cb26-850" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-851"><a href="#cb26-851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb26-852"><a href="#cb26-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-853"><a href="#cb26-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-854"><a href="#cb26-854" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-855"><a href="#cb26-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-856"><a href="#cb26-856" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Interpretation</span></span>
<span id="cb26-857"><a href="#cb26-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-858"><a href="#cb26-858" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb26-859"><a href="#cb26-859" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Would We Tell the FDA?</span></span>
<span id="cb26-860"><a href="#cb26-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-861"><a href="#cb26-861" aria-hidden="true" tabindex="-1"></a>Based on the TMLE mediation analysis:</span>
<span id="cb26-862"><a href="#cb26-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-863"><a href="#cb26-863" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Total effect:** Dapagliflozin reduces 1-year MACE risk by approximately <span class="in">`r round(abs(tmle_TE)*100, 1)`</span> percentage points compared to sulfonylurea</span>
<span id="cb26-864"><a href="#cb26-864" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Direct effect (NDE):** Approximately `r round(abs(tmle_NDE)*100, 1)` percentage points of this reduction operates through **non-glycemic pathways** (blood pressure reduction, weight loss, direct cardiac effects)</span>
<span id="cb26-865"><a href="#cb26-865" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Indirect effect via HbA1c (NIE):** Approximately `r round(abs(tmle_NIE)*100, 1)` percentage points operates through **glycemic improvement**</span>
<span id="cb26-866"><a href="#cb26-866" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Proportion mediated:** About <span class="in">`r round(abs(tmle_NIE / tmle_TE) * 100)`</span>% of the cardiovascular benefit is attributable to HbA1c reduction</span>
<span id="cb26-867"><a href="#cb26-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-868"><a href="#cb26-868" aria-hidden="true" tabindex="-1"></a>**Implication:** The majority of the CV benefit appears to be through non-glycemic mechanisms, suggesting SGLT2 inhibitors have a unique cardioprotective effect beyond glucose lowering. This supports differentiated labeling.</span>
<span id="cb26-869"><a href="#cb26-869" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-870"><a href="#cb26-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-871"><a href="#cb26-871" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fragile Assumptions</span></span>
<span id="cb26-872"><a href="#cb26-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-873"><a href="#cb26-873" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb26-874"><a href="#cb26-874" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Could Go Wrong?</span></span>
<span id="cb26-875"><a href="#cb26-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-876"><a href="#cb26-876" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Unmeasured mediator-outcome confounders affected by treatment:** If dapagliflozin changes blood pressure (call it $Z$), and blood pressure both affects HbA1c trajectory AND directly affects MACE, the NDE/NIE decomposition is biased. This is the cross-world assumption.</span>
<span id="cb26-877"><a href="#cb26-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-878"><a href="#cb26-878" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Mediator measurement error:** If 6-month HbA1c is a noisy proxy for the true glycemic pathway, the NIE will be attenuated (biased toward zero) and the NDE will absorb the missing indirect effect.</span>
<span id="cb26-879"><a href="#cb26-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-880"><a href="#cb26-880" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Mediator model misspecification:** If the true mediator distribution is non-normal or has treatment-dependent variance, the density ratio may be miscalibrated.</span>
<span id="cb26-881"><a href="#cb26-881" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-882"><a href="#cb26-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-883"><a href="#cb26-883" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-884"><a href="#cb26-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-885"><a href="#cb26-885" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Advanced: Interventional (In)Direct Effects</span></span>
<span id="cb26-886"><a href="#cb26-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-887"><a href="#cb26-887" aria-hidden="true" tabindex="-1"></a>If the cross-world assumption (no treatment-affected mediator-outcome confounders) is violated, natural direct and indirect effects are not identified. An alternative is the **interventional (in)direct effect**.</span>
<span id="cb26-888"><a href="#cb26-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-889"><a href="#cb26-889" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb26-890"><a href="#cb26-890" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interventional Effects: A Weaker Assumption</span></span>
<span id="cb26-891"><a href="#cb26-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-892"><a href="#cb26-892" aria-hidden="true" tabindex="-1"></a>Instead of asking "what if we set $M$ to $M(0)$?" (cross-world), interventional effects ask "what if we drew $M$ randomly from $P(M \mid A = 0, W)$?" (a stochastic intervention on the mediator).</span>
<span id="cb26-893"><a href="#cb26-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-894"><a href="#cb26-894" aria-hidden="true" tabindex="-1"></a>**Interventional Direct Effect (IDE):**</span>
<span id="cb26-895"><a href="#cb26-895" aria-hidden="true" tabindex="-1"></a>$$IDE = E\big<span class="co">[</span><span class="ot">Y(1, G_0)\big</span><span class="co">]</span> - E\big<span class="co">[</span><span class="ot">Y(0, G_0)\big</span><span class="co">]</span>$$</span>
<span id="cb26-896"><a href="#cb26-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-897"><a href="#cb26-897" aria-hidden="true" tabindex="-1"></a>**Interventional Indirect Effect (IIE):**</span>
<span id="cb26-898"><a href="#cb26-898" aria-hidden="true" tabindex="-1"></a>$$IIE = E\big<span class="co">[</span><span class="ot">Y(1, G_1)\big</span><span class="co">]</span> - E\big<span class="co">[</span><span class="ot">Y(1, G_0)\big</span><span class="co">]</span>$$</span>
<span id="cb26-899"><a href="#cb26-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-900"><a href="#cb26-900" aria-hidden="true" tabindex="-1"></a>where $G_a$ denotes a random draw from $P(M \mid A = a, W)$.</span>
<span id="cb26-901"><a href="#cb26-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-902"><a href="#cb26-902" aria-hidden="true" tabindex="-1"></a>The IDE and IIE do NOT require the cross-world assumption. They only need the standard no-unmeasured-confounding assumptions for $A \to Y$, $A \to M$, and $M \to Y$ (conditional on $A$ and $W$).</span>
<span id="cb26-903"><a href="#cb26-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-904"><a href="#cb26-904" aria-hidden="true" tabindex="-1"></a>The <span class="in">`lmtp`</span> package can estimate interventional effects for longitudinal mediation settings.</span>
<span id="cb26-905"><a href="#cb26-905" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-906"><a href="#cb26-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-907"><a href="#cb26-907" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb26-908"><a href="#cb26-908" aria-hidden="true" tabindex="-1"></a><span class="in"># Conceptual: LMTP for interventional effects</span></span>
<span id="cb26-909"><a href="#cb26-909" aria-hidden="true" tabindex="-1"></a><span class="in">library(lmtp)</span></span>
<span id="cb26-910"><a href="#cb26-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-911"><a href="#cb26-911" aria-hidden="true" tabindex="-1"></a><span class="in"># Shift the mediator distribution as if treatment were control</span></span>
<span id="cb26-912"><a href="#cb26-912" aria-hidden="true" tabindex="-1"></a><span class="in">shift_mediator &lt;- function(data, trt) {</span></span>
<span id="cb26-913"><a href="#cb26-913" aria-hidden="true" tabindex="-1"></a><span class="in">  # Draw M from P(M | A=0, W) instead of P(M | A=observed, W)</span></span>
<span id="cb26-914"><a href="#cb26-914" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[trt]]  # placeholder — real implementation uses mediator density</span></span>
<span id="cb26-915"><a href="#cb26-915" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb26-916"><a href="#cb26-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-917"><a href="#cb26-917" aria-hidden="true" tabindex="-1"></a><span class="in"># See lmtp documentation for full mediation analysis interface</span></span>
<span id="cb26-918"><a href="#cb26-918" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-919"><a href="#cb26-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-920"><a href="#cb26-920" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-921"><a href="#cb26-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-922"><a href="#cb26-922" aria-hidden="true" tabindex="-1"></a><span class="fu"># 10. Comparison: Mediation Methods</span></span>
<span id="cb26-923"><a href="#cb26-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-924"><a href="#cb26-924" aria-hidden="true" tabindex="-1"></a>| Method | Handles nonlinearity | Doubly robust | Works with ML | Cross-world needed | Package |</span>
<span id="cb26-925"><a href="#cb26-925" aria-hidden="true" tabindex="-1"></a>|--------|---------------------|--------------|--------------|-------------------|---------|</span>
<span id="cb26-926"><a href="#cb26-926" aria-hidden="true" tabindex="-1"></a>| Baron-Kenny | No | No | No | Implicitly yes | Base R |</span>
<span id="cb26-927"><a href="#cb26-927" aria-hidden="true" tabindex="-1"></a>| Parametric G-comp | Partially | No | No | Yes | <span class="in">`mediation`</span> |</span>
<span id="cb26-928"><a href="#cb26-928" aria-hidden="true" tabindex="-1"></a>| Weighting-based | Yes | No | Partially | Yes | <span class="in">`CMAverse`</span> |</span>
<span id="cb26-929"><a href="#cb26-929" aria-hidden="true" tabindex="-1"></a>| **TMLE for NDE/NIE** | **Yes** | **Yes** | **Yes** | **Yes** | <span class="in">`tmle`</span> |</span>
<span id="cb26-930"><a href="#cb26-930" aria-hidden="true" tabindex="-1"></a>| Interventional effects | Yes | Yes | Yes | **No** | <span class="in">`lmtp`</span> |</span>
<span id="cb26-931"><a href="#cb26-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-932"><a href="#cb26-932" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-933"><a href="#cb26-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-934"><a href="#cb26-934" aria-hidden="true" tabindex="-1"></a><span class="fu"># Key Takeaways</span></span>
<span id="cb26-935"><a href="#cb26-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-936"><a href="#cb26-936" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb26-937"><a href="#cb26-937" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb26-938"><a href="#cb26-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-939"><a href="#cb26-939" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Mediation analysis decomposes a total effect** into direct (not through the mediator) and indirect (through the mediator) components. This tells us *how* a drug works.</span>
<span id="cb26-940"><a href="#cb26-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-941"><a href="#cb26-941" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Baron-Kenny regression fails** for binary outcomes because of non-collapsibility. Even for continuous outcomes, it assumes linearity and no interactions.</span>
<span id="cb26-942"><a href="#cb26-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-943"><a href="#cb26-943" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**TMLE for mediation** extends the standard TMLE algorithm with a mediator-specific **density ratio** in the clever covariate. This density ratio "transports" the mediator distribution from one treatment arm to the other.</span>
<span id="cb26-944"><a href="#cb26-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-945"><a href="#cb26-945" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**The cross-world assumption** (no treatment-affected mediator-outcome confounders) is required for natural direct/indirect effects. If violated, consider **interventional effects** which require only standard confounding assumptions.</span>
<span id="cb26-946"><a href="#cb26-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-947"><a href="#cb26-947" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Diagnostics matter:** check propensity score overlap, mediator distribution shift, density ratio stability, and the mediator-outcome relationship.</span>
<span id="cb26-948"><a href="#cb26-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-949"><a href="#cb26-949" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**The proportion mediated** tells decision-makers whether a drug works primarily through a specific mechanism or through other pathways — critical for labeling, mechanistic understanding, and competitor drug development.</span>
<span id="cb26-950"><a href="#cb26-950" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb26-951"><a href="#cb26-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-954"><a href="#cb26-954" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-955"><a href="#cb26-955" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb26-956"><a href="#cb26-956" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-957"><a href="#cb26-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-958"><a href="#cb26-958" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-959"><a href="#cb26-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-960"><a href="#cb26-960" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sources and further reading</span></span>
<span id="cb26-961"><a href="#cb26-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-962"><a href="#cb26-962" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Zheng Z, van der Laan MJ (2012). Targeted maximum likelihood estimation of natural direct effects. *Int J Biostat* 8(1):Article 3.</span>
<span id="cb26-963"><a href="#cb26-963" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>VanderWeele TJ (2015). *Explanation in Causal Inference: Methods for Mediation and Interaction*. Oxford University Press.</span>
<span id="cb26-964"><a href="#cb26-964" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Diaz I, Hejazi NS (2020). Causal mediation analysis for stochastic interventions. *JRSS-B* 82(3):661-683.</span>
<span id="cb26-965"><a href="#cb26-965" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Pearl J (2001). Direct and indirect effects. *Proceedings of the 17th Conference on Uncertainty in Artificial Intelligence*, 411-420.</span>
<span id="cb26-966"><a href="#cb26-966" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Robins JM, Richardson TS (2010). Alternative graphical causal models and the identification of direct effects. In *Causality and Psychopathology*, Oxford University Press.</span>
<span id="cb26-967"><a href="#cb26-967" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Williams NT, Diaz I (2024). crumble: An R package for TMLE-based mediation analysis. <span class="co">[</span><span class="ot">GitHub</span><span class="co">](https://github.com/nt-williams/crumble)</span></span>
<span id="cb26-968"><a href="#cb26-968" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`medltmle`</span> (if available): <span class="co">[</span><span class="ot">GitHub search</span><span class="co">](https://github.com/topics/mediation-analysis)</span></span>
<span id="cb26-969"><a href="#cb26-969" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>van der Laan MJ, Rose S (2011). *Targeted Learning*. Springer.</span>
<span id="cb26-970"><a href="#cb26-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-971"><a href="#cb26-971" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb26-972"><a href="#cb26-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-973"><a href="#cb26-973" aria-hidden="true" tabindex="-1"></a><span class="fu">## Software Implementation (R)</span></span>
<span id="cb26-974"><a href="#cb26-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-975"><a href="#cb26-975" aria-hidden="true" tabindex="-1"></a>This example uses the <span class="in">`crumble`</span> package (if available) to estimate the **natural direct effect (NDE)** and **natural indirect effect (NIE)** via TMLE-based mediation analysis. The <span class="in">`crumble`</span> package implements targeted learning for mediation with flexible nuisance estimation.</span>
<span id="cb26-976"><a href="#cb26-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-977"><a href="#cb26-977" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simulate data with a binary treatment $A$, continuous mediator $M$, and binary outcome $Y$</span>
<span id="cb26-978"><a href="#cb26-978" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Estimate NDE and NIE using <span class="in">`crumble::crumble()`</span> with cross-fitting</span>
<span id="cb26-979"><a href="#cb26-979" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Falls back to a manual decomposition using <span class="in">`tmle`</span> if <span class="in">`crumble`</span> is unavailable</span>
<span id="cb26-980"><a href="#cb26-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-983"><a href="#cb26-983" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-984"><a href="#cb26-984" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-985"><a href="#cb26-985" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb26-986"><a href="#cb26-986" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb26-987"><a href="#cb26-987" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb26-988"><a href="#cb26-988" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="fl">0.3</span> <span class="sc">*</span> W))</span>
<span id="cb26-989"><a href="#cb26-989" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> W <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> <span class="fl">0.8</span>)</span>
<span id="cb26-990"><a href="#cb26-990" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> M <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> W))</span>
<span id="cb26-991"><a href="#cb26-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-992"><a href="#cb26-992" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">W =</span> W, <span class="at">A =</span> A, <span class="at">M =</span> M, <span class="at">Y =</span> Y)</span>
<span id="cb26-993"><a href="#cb26-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-994"><a href="#cb26-994" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"crumble"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb26-995"><a href="#cb26-995" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(crumble)</span>
<span id="cb26-996"><a href="#cb26-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-997"><a href="#cb26-997" aria-hidden="true" tabindex="-1"></a>  <span class="do">## crumble estimates interventional (in)direct effects</span></span>
<span id="cb26-998"><a href="#cb26-998" aria-hidden="true" tabindex="-1"></a>  <span class="do">## using TMLE with cross-fitting</span></span>
<span id="cb26-999"><a href="#cb26-999" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">crumble</span>(</span>
<span id="cb26-1000"><a href="#cb26-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat,</span>
<span id="cb26-1001"><a href="#cb26-1001" aria-hidden="true" tabindex="-1"></a>    <span class="at">trt =</span> <span class="st">"A"</span>,</span>
<span id="cb26-1002"><a href="#cb26-1002" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb26-1003"><a href="#cb26-1003" aria-hidden="true" tabindex="-1"></a>    <span class="at">mediators =</span> <span class="st">"M"</span>,</span>
<span id="cb26-1004"><a href="#cb26-1004" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline =</span> <span class="st">"W"</span>,</span>
<span id="cb26-1005"><a href="#cb26-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome_type =</span> <span class="st">"binomial"</span>,</span>
<span id="cb26-1006"><a href="#cb26-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">learners =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.mean"</span>),</span>
<span id="cb26-1007"><a href="#cb26-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">nn_module =</span> <span class="cn">NULL</span>  <span class="co"># use standard SL, not neural net</span></span>
<span id="cb26-1008"><a href="#cb26-1008" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-1009"><a href="#cb26-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1010"><a href="#cb26-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"── Mediation TMLE via crumble ──</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-1011"><a href="#cb26-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(result)</span>
<span id="cb26-1012"><a href="#cb26-1012" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-1013"><a href="#cb26-1013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"'crumble' package not found."</span>)</span>
<span id="cb26-1014"><a href="#cb26-1014" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install from GitHub:  remotes::install_github('nt-williams/crumble')"</span>)</span>
<span id="cb26-1015"><a href="#cb26-1015" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Falling back to a manual total-effect decomposition...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-1016"><a href="#cb26-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1017"><a href="#cb26-1017" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"tmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb26-1018"><a href="#cb26-1018" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tmle)</span>
<span id="cb26-1019"><a href="#cb26-1019" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Total effect only (not a true mediation decomposition)</span></span>
<span id="cb26-1020"><a href="#cb26-1020" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">tmle</span>(<span class="at">Y =</span> Y, <span class="at">A =</span> A, <span class="at">W =</span> <span class="fu">data.frame</span>(<span class="at">W =</span> W),</span>
<span id="cb26-1021"><a href="#cb26-1021" aria-hidden="true" tabindex="-1"></a>                <span class="at">Q.SL.library =</span> <span class="st">"SL.glm"</span>, <span class="at">g.SL.library =</span> <span class="st">"SL.glm"</span>)</span>
<span id="cb26-1022"><a href="#cb26-1022" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Total effect (ATE):"</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>psi, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-1023"><a href="#cb26-1023" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>CI, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-1024"><a href="#cb26-1024" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Note: This is the total effect only.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-1025"><a href="#cb26-1025" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"For NDE/NIE decomposition, install the crumble package.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-1026"><a href="#cb26-1026" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb26-1027"><a href="#cb26-1027" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Install 'tmle':  install.packages('tmle')"</span>)</span>
<span id="cb26-1028"><a href="#cb26-1028" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-1029"><a href="#cb26-1029" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-1030"><a href="#cb26-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>