<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A practical guide to the Causal Roadmap, Targeted Maximum Likelihood Estimation (TMLE), and Super Learner for modern causal inference in epidemiology, with emphasis on pharmacoepidemiology and clinical trial analysis.">

<title>9&nbsp; Chapter 2.4: From Question to Estimate — TMLE in Practice – Causal Learning Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./superlearner.html" rel="next">
<link href="./02-03-doubly-robust-tmle.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b343bb23504f009ddf7b24643a6af19a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-01-gcomputation.html">Part II: Estimation Methods</a></li><li class="breadcrumb-item"><a href="./02-04-tmle-teaching-examples.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Causal Learning Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/amertens/causal-learning-handbook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Causal Learning Handbook</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-01-regression-vs-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 1.1: Limitations of Standard Regression Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-02-causal-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 1.2: The Causal Roadmap</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-03-identification-estimands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1.3: From Causal Questions to Analysis — Identification, Estimands, and Statistical Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Roadmap for Real-world Evidence Generation: A Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Estimation Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-01-gcomputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-02-iptw.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-03-doubly-robust-tmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-04-tmle-teaching-examples.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superlearner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-03-longitudinal-case-study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-04-effect-modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-05-advanced-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-07-longitudinal-td-confounding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-08-tmle-clean-room.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-09-illustrated-ltmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-10-tmle-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anotated_bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Annotated Bibliography: Modern Causal Inference and Targeted Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#chapter-2.4-from-question-to-estimate-tmle-in-practice" id="toc-chapter-2.4-from-question-to-estimate-tmle-in-practice" class="nav-link active" data-scroll-target="#chapter-2.4-from-question-to-estimate-tmle-in-practice"><span class="header-section-number">10</span> Chapter 2.4: From Question to Estimate — TMLE in Practice</a></li>
  <li><a href="#clinical-motivation" id="toc-clinical-motivation" class="nav-link" data-scroll-target="#clinical-motivation"><span class="header-section-number">11</span> 1. Clinical Motivation</a>
  <ul class="collapse">
  <li><a href="#the-regulatory-question" id="toc-the-regulatory-question" class="nav-link" data-scroll-target="#the-regulatory-question"><span class="header-section-number">11.1</span> The Regulatory Question</a>
  <ul class="collapse">
  <li><a href="#key-elements" id="toc-key-elements" class="nav-link" data-scroll-target="#key-elements"><span class="header-section-number">11.1.1</span> Key elements</a></li>
  <li><a href="#why-standard-regression-falls-short" id="toc-why-standard-regression-falls-short" class="nav-link" data-scroll-target="#why-standard-regression-falls-short"><span class="header-section-number">11.1.2</span> Why standard regression falls short</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#the-causal-roadmap" id="toc-the-causal-roadmap" class="nav-link" data-scroll-target="#the-causal-roadmap"><span class="header-section-number">12</span> 2. The Causal Roadmap</a></li>
  <li><a href="#data-simulation" id="toc-data-simulation" class="nav-link" data-scroll-target="#data-simulation"><span class="header-section-number">13</span> 3. Data Simulation</a>
  <ul class="collapse">
  <li><a href="#true-causal-effect" id="toc-true-causal-effect" class="nav-link" data-scroll-target="#true-causal-effect"><span class="header-section-number">13.0.1</span> True causal effect</a></li>
  <li><a href="#inspect-the-data" id="toc-inspect-the-data" class="nav-link" data-scroll-target="#inspect-the-data"><span class="header-section-number">13.0.2</span> Inspect the data</a></li>
  </ul></li>
  <li><a href="#progressive-estimation" id="toc-progressive-estimation" class="nav-link" data-scroll-target="#progressive-estimation"><span class="header-section-number">14</span> 4. Progressive Estimation</a>
  <ul class="collapse">
  <li><a href="#b.-g-computation-outcome-modeling" id="toc-b.-g-computation-outcome-modeling" class="nav-link" data-scroll-target="#b.-g-computation-outcome-modeling"><span class="header-section-number">14.1</span> 4B. G-Computation (Outcome Modeling)</a>
  <ul class="collapse">
  <li><a href="#bootstrap-confidence-interval-for-g-computation" id="toc-bootstrap-confidence-interval-for-g-computation" class="nav-link" data-scroll-target="#bootstrap-confidence-interval-for-g-computation"><span class="header-section-number">14.1.1</span> Bootstrap confidence interval for G-computation</a></li>
  </ul></li>
  <li><a href="#c.-iptw-treatment-modeling" id="toc-c.-iptw-treatment-modeling" class="nav-link" data-scroll-target="#c.-iptw-treatment-modeling"><span class="header-section-number">14.2</span> 4C. IPTW (Treatment Modeling)</a>
  <ul class="collapse">
  <li><a href="#step-2-assess-propensity-score-overlap" id="toc-step-2-assess-propensity-score-overlap" class="nav-link" data-scroll-target="#step-2-assess-propensity-score-overlap"><span class="header-section-number">14.2.1</span> Step 2: Assess propensity score overlap</a></li>
  <li><a href="#step-3-construct-stabilized-weights" id="toc-step-3-construct-stabilized-weights" class="nav-link" data-scroll-target="#step-3-construct-stabilized-weights"><span class="header-section-number">14.2.2</span> Step 3: Construct stabilized weights</a></li>
  <li><a href="#step-4-diagnose-weights" id="toc-step-4-diagnose-weights" class="nav-link" data-scroll-target="#step-4-diagnose-weights"><span class="header-section-number">14.2.3</span> Step 4: Diagnose weights</a></li>
  <li><a href="#step-5-check-covariate-balance-after-weighting" id="toc-step-5-check-covariate-balance-after-weighting" class="nav-link" data-scroll-target="#step-5-check-covariate-balance-after-weighting"><span class="header-section-number">14.2.4</span> Step 5: Check covariate balance after weighting</a></li>
  <li><a href="#step-6-estimate-the-ate" id="toc-step-6-estimate-the-ate" class="nav-link" data-scroll-target="#step-6-estimate-the-ate"><span class="header-section-number">14.2.5</span> Step 6: Estimate the ATE</a></li>
  <li><a href="#weight-truncation" id="toc-weight-truncation" class="nav-link" data-scroll-target="#weight-truncation"><span class="header-section-number">14.2.6</span> Weight truncation</a></li>
  </ul></li>
  <li><a href="#d.-aipw-augmented-inverse-probability-weighting" id="toc-d.-aipw-augmented-inverse-probability-weighting" class="nav-link" data-scroll-target="#d.-aipw-augmented-inverse-probability-weighting"><span class="header-section-number">14.3</span> 4D. AIPW (Augmented Inverse Probability Weighting)</a>
  <ul class="collapse">
  <li><a href="#influence-curve-and-inference" id="toc-influence-curve-and-inference" class="nav-link" data-scroll-target="#influence-curve-and-inference"><span class="header-section-number">14.3.1</span> Influence curve and inference</a></li>
  </ul></li>
  <li><a href="#e.-tmle-targeted-maximum-likelihood-estimation" id="toc-e.-tmle-targeted-maximum-likelihood-estimation" class="nav-link" data-scroll-target="#e.-tmle-targeted-maximum-likelihood-estimation"><span class="header-section-number">14.4</span> 4E. TMLE (Targeted Maximum Likelihood Estimation)</a>
  <ul class="collapse">
  <li><a href="#conceptual-overview" id="toc-conceptual-overview" class="nav-link" data-scroll-target="#conceptual-overview"><span class="header-section-number">14.4.1</span> Conceptual overview</a></li>
  <li><a href="#step-by-step-implementation" id="toc-step-by-step-implementation" class="nav-link" data-scroll-target="#step-by-step-implementation"><span class="header-section-number">14.4.2</span> Step-by-step implementation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#comparing-all-estimators" id="toc-comparing-all-estimators" class="nav-link" data-scroll-target="#comparing-all-estimators"><span class="header-section-number">15</span> 5. Comparing All Estimators</a></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics"><span class="header-section-number">16</span> 6. Diagnostics</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">17</span> 7. Interpretation</a></li>
  <li><a href="#why-super-learner-improves-nuisance-estimation" id="toc-why-super-learner-improves-nuisance-estimation" class="nav-link" data-scroll-target="#why-super-learner-improves-nuisance-estimation"><span class="header-section-number">18</span> 8. Why Super Learner Improves Nuisance Estimation</a>
  <ul class="collapse">
  <li><a href="#conceptual-demonstration" id="toc-conceptual-demonstration" class="nav-link" data-scroll-target="#conceptual-demonstration"><span class="header-section-number">18.0.1</span> Conceptual demonstration</a></li>
  <li><a href="#software-implementation-r" id="toc-software-implementation-r" class="nav-link" data-scroll-target="#software-implementation-r"><span class="header-section-number">18.1</span> Software Implementation (R)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-01-gcomputation.html">Part II: Estimation Methods</a></li><li class="breadcrumb-item"><a href="./02-04-tmle-teaching-examples.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="chapter-2.4-from-question-to-estimate-tmle-in-practice" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Chapter 2.4: From Question to Estimate — TMLE in Practice</h1>
<p><em>A progressive tutorial for pharmacoepidemiologists</em></p>
<p>This chapter walks through a complete causal analysis from start to finish, building each estimator step-by-step so you can see exactly where bias enters, how each method addresses it, and why TMLE provides a principled solution.</p>
<p>We use a realistic post-marketing safety scenario: <strong>evaluating the cardiovascular safety of a new diabetes drug</strong>.</p>
<p>By the end of this chapter, you will have implemented:</p>
<ol type="1">
<li>A naive (unadjusted) model</li>
<li>G-computation (outcome modeling)</li>
<li>IPTW (treatment modeling)</li>
<li>AIPW (combining both)</li>
<li>TMLE (targeting the estimate)</li>
</ol>
<p>Each method builds on what came before. Every step includes code, diagnostics, and interpretation.</p>
<hr>
</section>
<section id="clinical-motivation" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> 1. Clinical Motivation</h1>
<section id="the-regulatory-question" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="the-regulatory-question"><span class="header-section-number">11.1</span> The Regulatory Question</h2>
<p>A new sodium-glucose co-transporter 2 (SGLT2) inhibitor, <strong>dapagliflozin</strong>, has been approved for type 2 diabetes. Post-marketing surveillance data from insurance claims suggest a potential cardiovascular safety signal. The FDA’s Office of Surveillance and Epidemiology asks:</p>
<blockquote class="blockquote">
<p><strong>Does initiation of dapagliflozin (vs.&nbsp;a sulfonylurea comparator) increase the 1-year risk of major adverse cardiovascular events (MACE) in adults with type 2 diabetes?</strong></p>
</blockquote>
<p>This is a classic <strong>active comparator, new user</strong> design question.</p>
<section id="key-elements" class="level3" data-number="11.1.1">
<h3 data-number="11.1.1" class="anchored" data-anchor-id="key-elements"><span class="header-section-number">11.1.1</span> Key elements</h3>
<ul>
<li><strong>Target population:</strong> Adults aged 40-85 with type 2 diabetes initiating a new oral glucose-lowering agent</li>
<li><strong>Treatment strategies:</strong> Initiate dapagliflozin (A = 1) vs.&nbsp;initiate sulfonylurea (A = 0)</li>
<li><strong>Outcome:</strong> 1-year MACE (composite of MI, stroke, CV death), binary</li>
<li><strong>Intercurrent events:</strong> Treatment discontinuation, switching, death from non-CV causes</li>
<li><strong>Decision:</strong> Should the label carry a cardiovascular warning? Is a formal safety trial needed?</li>
</ul>
</section>
<section id="why-standard-regression-falls-short" class="level3" data-number="11.1.2">
<h3 data-number="11.1.2" class="anchored" data-anchor-id="why-standard-regression-falls-short"><span class="header-section-number">11.1.2</span> Why standard regression falls short</h3>
<p>A logistic regression of MACE on treatment will confound the effect with differences in baseline health. Patients prescribed newer, more expensive agents may differ systematically from those prescribed sulfonylureas — in age, comorbidity burden, prior cardiovascular history, renal function, and concomitant medications.</p>
<p>We need methods that explicitly separate confounding from causal effects.</p>
<hr>
</section>
</section>
</section>
<section id="the-causal-roadmap" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> 2. The Causal Roadmap</h1>
<p>We follow a five-step workflow that structures every causal analysis.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 1: Define the Causal Question
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>In plain language:</strong> What would happen to 1-year MACE risk if every eligible patient started dapagliflozin, compared to if every eligible patient started a sulfonylurea?</p>
<p><strong>As a counterfactual estimand:</strong></p>
<p>The Average Treatment Effect (ATE) on the risk difference scale:</p>
<p><span class="math display">\[
\psi = E[Y(1)] - E[Y(0)]
\]</span></p>
<p>where <span class="math inline">\(Y(a)\)</span> is the potential outcome under treatment strategy <span class="math inline">\(a\)</span>.</p>
<ul>
<li><span class="math inline">\(E[Y(1)]\)</span> = population risk of MACE if everyone took dapagliflozin</li>
<li><span class="math inline">\(E[Y(0)]\)</span> = population risk of MACE if everyone took sulfonylurea</li>
<li>A negative <span class="math inline">\(\psi\)</span> means dapagliflozin is protective; a positive <span class="math inline">\(\psi\)</span> means increased risk</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 2: Define the Causal Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>We posit the following causal structure. Confounders <span class="math inline">\(W\)</span> affect both treatment choice <span class="math inline">\(A\)</span> and the outcome <span class="math inline">\(Y\)</span>. Treatment <span class="math inline">\(A\)</span> also affects <span class="math inline">\(Y\)</span> directly.</p>
<p>The confounders include:</p>
<ul>
<li><strong>Age</strong> — older patients have higher CV risk and may receive different prescriptions</li>
<li><strong>BMI</strong> — obesity correlates with both drug choice and CV risk</li>
<li><strong>HbA1c</strong> — glycemic control at baseline affects prescribing and outcomes</li>
<li><strong>Prior CVD</strong> — history of cardiovascular disease is a strong confounder</li>
<li><strong>eGFR</strong> — renal function influences both drug eligibility and CV risk</li>
<li><strong>Statin use</strong> — a marker of CV risk management</li>
</ul>
<p>The DAG (directed acyclic graph):</p>
<pre><code>       W (age, BMI, HbA1c, prior CVD, eGFR, statin)
      / \
     v   v
     A --&gt; Y</code></pre>
<p>All arrows from <span class="math inline">\(W\)</span> point to both <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span>. There is a direct arrow from <span class="math inline">\(A\)</span> to <span class="math inline">\(Y\)</span>. There are no arrows from <span class="math inline">\(A\)</span> back to <span class="math inline">\(W\)</span> (this is a point-treatment analysis at baseline).</p>
<p>Structural equations:</p>
<ul>
<li><span class="math inline">\(W\)</span> is drawn from the population distribution</li>
<li><span class="math inline">\(A = f_A(W, U_A)\)</span> — treatment depends on confounders and unmeasured factors</li>
<li><span class="math inline">\(Y = f_Y(A, W, U_Y)\)</span> — outcome depends on treatment, confounders, and unmeasured factors</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3: Identify Assumptions
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the causal estimand <span class="math inline">\(\psi = E[Y(1)] - E[Y(0)]\)</span> to be identified from observational data, we need three untestable assumptions:</p>
<p><strong>Consistency:</strong> The observed outcome for a patient who received treatment <span class="math inline">\(a\)</span> equals their potential outcome <span class="math inline">\(Y(a)\)</span>. This requires a well-defined intervention — “initiate dapagliflozin” must mean the same thing across patients. In practice, we define treatment as filling a new prescription.</p>
<p><strong>Exchangeability (no unmeasured confounding):</strong> <span class="math inline">\(Y(a) \perp\!\!\!\perp A \mid W\)</span> for all <span class="math inline">\(a\)</span>. Conditional on measured baseline covariates, treatment assignment is as-good-as-random. This is the most vulnerable assumption. We cannot test it, but we can make it more plausible by adjusting for a rich set of confounders.</p>
<p><strong>Positivity:</strong> <span class="math inline">\(0 &lt; P(A = 1 \mid W = w) &lt; 1\)</span> for all <span class="math inline">\(w\)</span> with <span class="math inline">\(P(W = w) &gt; 0\)</span>. Every patient type has some chance of receiving either drug. Violations occur when, for example, patients with severe renal impairment are never prescribed dapagliflozin.</p>
<p>Each assumption is untestable but can be made more or less plausible by study design.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 4: Map to a Statistical Estimand
</div>
</div>
<div class="callout-body-container callout-body">
<p>Under the three assumptions above, the causal estimand equals a statistical quantity we can estimate from data:</p>
<p><span class="math display">\[
\psi = E_W\big[E[Y \mid A=1, W]\big] - E_W\big[E[Y \mid A=0, W]\big]
\]</span></p>
<p>This is the <strong>G-computation identification formula</strong>. It says: fit a model for <span class="math inline">\(E[Y \mid A, W]\)</span>, predict under <span class="math inline">\(A = 1\)</span> and <span class="math inline">\(A = 0\)</span> for every patient, and average over the population distribution of <span class="math inline">\(W\)</span>.</p>
<p>Equivalently, using the propensity score <span class="math inline">\(g(W) = P(A=1 \mid W)\)</span>:</p>
<p><span class="math display">\[
E[Y(a)] = E\left[\frac{I(A=a) Y}{P(A=a \mid W)}\right]
\]</span></p>
<p>This is the <strong>IPTW identification formula</strong>.</p>
<p>Both representations target the same quantity. They differ in which nuisance function they rely on.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 5: Choose an Estimation Strategy
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 27%">
<col style="width: 27%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Relies on</th>
<th>Robust to</th>
<th>Weakness</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>G-computation</td>
<td>Outcome model <span class="math inline">\(E[Y \mid A, W]\)</span></td>
<td>Treatment model misspecification</td>
<td>Sensitive to outcome model misspecification</td>
</tr>
<tr class="even">
<td>IPTW</td>
<td>Treatment model <span class="math inline">\(P(A \mid W)\)</span></td>
<td>Outcome model misspecification</td>
<td>Sensitive to positivity violations and weight instability</td>
</tr>
<tr class="odd">
<td>AIPW</td>
<td>Both models</td>
<td>Misspecification of either one model</td>
<td>Not targeted; can produce out-of-bounds estimates</td>
</tr>
<tr class="even">
<td>TMLE</td>
<td>Both models</td>
<td>Misspecification of either one model</td>
<td>More complex to implement; requires understanding the targeting step</td>
</tr>
</tbody>
</table>
<p>TMLE additionally:</p>
<ul>
<li>Respects the natural bounds of the parameter space (probabilities stay between 0 and 1)</li>
<li>Achieves the semiparametric efficiency bound when both models are well-specified</li>
<li>Provides valid inference through the efficient influence curve</li>
<li>Integrates naturally with machine learning via Super Learner</li>
</ul>
<p>We now implement each estimator progressively.</p>
<hr>
</section>
<section id="data-simulation" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> 3. Data Simulation</h1>
<p>We simulate a realistic claims-like dataset with multiple confounders, nonlinear effects, and treatment-confounder interactions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.6.0
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline confounders ---</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>age    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">62</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>bmi    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">31</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>hba1c  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">8.2</span>, <span class="at">sd =</span> <span class="fl">1.3</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior CVD: more likely with age and high BMI</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>cvd    <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> bmi))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># eGFR: lower with age, higher with lower BMI</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>egfr   <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">15</span>, <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">95</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">-</span> <span class="fl">0.3</span> <span class="sc">*</span> bmi, <span class="at">sd =</span> <span class="dv">15</span>))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Statin use: more likely with CVD and age</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>statin <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">1.8</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> age))</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment model (propensity score) ---</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Dapagliflozin is preferentially prescribed to:</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># - younger patients, higher eGFR (renal eligibility), higher BMI, lower HbA1c</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes nonlinear terms and interactions</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">+</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.15</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span>         <span class="co"># interaction</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.002</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span>             <span class="co"># nonlinear age effect</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_trt))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome model ---</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># MACE risk depends on treatment, confounders, with nonlinearities</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># True treatment effect: dapagliflozin REDUCES MACE risk (protective)</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>lp_out <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> A <span class="sc">+</span>                       <span class="co"># true causal effect (protective)</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span>        <span class="co"># interaction</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span>           <span class="co"># nonlinear age effect</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> A <span class="sc">*</span> cvd                   <span class="co"># treatment-confounder interaction</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_out))</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(age, bmi, hba1c, cvd, egfr, statin, A, Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="true-causal-effect" class="level3" data-number="13.0.1">
<h3 data-number="13.0.1" class="anchored" data-anchor-id="true-causal-effect"><span class="header-section-number">13.0.1</span> True causal effect</h3>
<p>We compute the true ATE from the data-generating process:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># True potential outcomes from the structural model</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>p1_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span> <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span> <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> cvd)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>p0_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span> <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span> <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> cvd)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>true_ate <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_true <span class="sc">-</span> p0_true)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE (risk difference):"</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE (risk difference): -0.0338 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under dapagliflozin:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p1_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True risk under dapagliflozin: 0.0691 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under sulfonylurea: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p0_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True risk under sulfonylurea:  0.1029 </code></pre>
</div>
</div>
</section>
<section id="inspect-the-data" class="level3" data-number="13.0.2">
<h3 data-number="13.0.2" class="anchored" data-anchor-id="inspect-the-data"><span class="header-section-number">13.0.2</span> Inspect the data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n          =</span> <span class="fu">n</span>(),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_age   =</span> <span class="fu">mean</span>(age),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_bmi   =</span> <span class="fu">mean</span>(bmi),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_hba1c =</span> <span class="fu">mean</span>(hba1c),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_cvd    =</span> <span class="fu">mean</span>(cvd),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_egfr  =</span> <span class="fu">mean</span>(egfr),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_statin =</span> <span class="fu">mean</span>(statin),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mace_rate  =</span> <span class="fu">mean</span>(Y),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 9
      A     n mean_age mean_bmi mean_hba1c pct_cvd mean_egfr pct_statin
  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
1     0  3828     62.6     30.9       8.27   0.532      83.7      0.653
2     1  1172     59.7     31.7       8.01   0.334      89.1      0.515
# ℹ 1 more variable: mace_rate &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Notice the imbalances: dapagliflozin patients are younger, have higher eGFR, and less prior CVD. These differences will bias a naive comparison.</p>
<hr>
</section>
</section>
<section id="progressive-estimation" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> 4. Progressive Estimation</h1>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
4A. Naive (Unadjusted) Model — What Happens Without Adjustment?
</div>
</div>
<div class="callout-body-container callout-body">
<p>We start with what many analysts would try first: a simple comparison of MACE rates by treatment group. This establishes the baseline from which all other methods improve.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unadjusted risk difference</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>risk_A1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>risk_A0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>naive_rd <span class="ot">&lt;-</span> risk_A1 <span class="sc">-</span> risk_A0</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk (dapagliflozin):"</span>, <span class="fu">round</span>(risk_A1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Naive risk (dapagliflozin): 0.0444 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk (sulfonylurea): "</span>, <span class="fu">round</span>(risk_A0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Naive risk (sulfonylurea):  0.11 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk difference:     "</span>, <span class="fu">round</span>(naive_rd, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Naive risk difference:      -0.0656 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                  "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                   -0.0338 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unadjusted logistic regression</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>naive_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(naive_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Y ~ A, family = binomial, data = dat)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -2.09095    0.05166 -40.475  &lt; 2e-16 ***
A           -0.97889    0.15095  -6.485 8.89e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 3130.5  on 4999  degrees of freedom
Residual deviance: 3078.2  on 4998  degrees of freedom
AIC: 3082.2

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Went Wrong?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The naive estimate is biased because dapagliflozin patients differ systematically from sulfonylurea patients. The treatment groups are not exchangeable. The naive estimate conflates the drug effect with the confounding by indication.</p>
<p><strong>The lesson:</strong> Never interpret unadjusted treatment comparisons as causal effects in observational data. The difference in MACE rates reflects both the drug’s effect AND the differences in who gets each drug.</p>
</div>
</div>
<hr>
<section id="b.-g-computation-outcome-modeling" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="b.-g-computation-outcome-modeling"><span class="header-section-number">14.1</span> 4B. G-Computation (Outcome Modeling)</h2>
<p>G-computation directly implements the identification formula by modeling <span class="math inline">\(E[Y \mid A, W]\)</span>, then standardizing.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
G-Computation Step 1: Fit the Outcome Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fit a model for <span class="math inline">\(E[Y \mid A, W]\)</span> — the expected outcome given treatment and confounders. This model will be used to predict what would happen to each patient under each treatment scenario.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parametric outcome model (logistic regression)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We include main effects and key interactions</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>               A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
G-Computation Step 2: Predict Counterfactual Outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ask: “What would this patient’s outcome be if they received dapagliflozin? And if they received sulfonylurea?” We generate these predictions for <em>every</em> patient, regardless of what they actually received.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create counterfactual datasets</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>dat1 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict potential outcomes for each individual</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>Q1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>Q0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat0, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
G-Computation Step 3: Standardize (Average Over the Population)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Average the predicted outcomes across all patients. This implements the G-computation formula: <span class="math inline">\(E_W[E[Y \mid A=a, W]]\)</span>.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>gcomp_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>gcomp_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>gcomp_ate   <span class="ot">&lt;-</span> gcomp_risk1 <span class="sc">-</span> gcomp_risk0</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp risk (dapagliflozin):"</span>, <span class="fu">round</span>(gcomp_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp risk (dapagliflozin): 0.0629 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp risk (sulfonylurea): "</span>, <span class="fu">round</span>(gcomp_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp risk (sulfonylurea):  0.0996 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp ATE:                 "</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp ATE:                  -0.0367 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                   "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                    -0.0338 </code></pre>
</div>
</div>
<section id="bootstrap-confidence-interval-for-g-computation" class="level3" data-number="14.1.1">
<h3 data-number="14.1.1" class="anchored" data-anchor-id="bootstrap-confidence-interval-for-g-computation"><span class="header-section-number">14.1.1</span> Bootstrap confidence interval for G-computation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>n_boot <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>boot_ate <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_boot)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_boot) {</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  dat_b <span class="ot">&lt;-</span> dat[idx, ]</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  mod_b <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>                  A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial, <span class="at">data =</span> dat_b)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  Q1_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_b, <span class="at">newdata =</span> dat_b <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  Q0_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_b, <span class="at">newdata =</span> dat_b <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  boot_ate[b] <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_b <span class="sc">-</span> Q0_b)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>gcomp_se <span class="ot">&lt;-</span> <span class="fu">sd</span>(boot_ate)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>gcomp_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_ate, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp ATE:"</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>),</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(gcomp_se, <span class="dv">4</span>),</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(gcomp_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(gcomp_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>G-comp ATE: -0.0367  SE: 0.0098  95% CI: [ -0.0569 , -0.0191 ]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Just Happened?
</div>
</div>
<div class="callout-body-container callout-body">
<p>G-computation gave a much better estimate than the naive approach by adjusting for confounders. It works by predicting what would happen to each patient under each treatment, then averaging.</p>
<p><strong>But there is a catch:</strong> G-computation depends entirely on the outcome model being correct. If we misspecified the functional form (missed interactions, nonlinearities), the estimate would be biased. And we would have no way to know.</p>
<p><strong>This motivates IPTW</strong> — which adjusts for confounding using the <em>treatment</em> model instead.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="c.-iptw-treatment-modeling" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="c.-iptw-treatment-modeling"><span class="header-section-number">14.2</span> 4C. IPTW (Treatment Modeling)</h2>
<p>IPTW takes a different approach: instead of modeling the outcome, it models treatment assignment and reweights the data to create a pseudo-population where confounders are balanced.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
IPTW Step 1: Estimate the Propensity Score
</div>
</div>
<div class="callout-body-container callout-body">
<p>The propensity score <span class="math inline">\(g(W) = P(A = 1 \mid W)\)</span> answers: given a patient’s covariates, how likely were they to receive dapagliflozin? We use this to reweight the data so that treatment looks “as-if-randomized.”</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Propensity score model</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> age<span class="sc">:</span>cvd,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ps =</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of propensity scores</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.002505 0.146338 0.220684 0.234400 0.314028 0.632319 </code></pre>
</div>
</div>
<section id="step-2-assess-propensity-score-overlap" class="level3" data-number="14.2.1">
<h3 data-number="14.2.1" class="anchored" data-anchor-id="step-2-assess-propensity-score-overlap"><span class="header-section-number">14.2.1</span> Step 2: Assess propensity score overlap</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated propensity score P(A=1 | W)"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Overlap"</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Good overlap means every type of patient has some chance of getting either drug. If the distributions barely overlap, IPTW will produce extreme weights and unstable estimates.</p>
</section>
<section id="step-3-construct-stabilized-weights" class="level3" data-number="14.2.2">
<h3 data-number="14.2.2" class="anchored" data-anchor-id="step-3-construct-stabilized-weights"><span class="header-section-number">14.2.2</span> Step 3: Construct stabilized weights</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal treatment probability</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>p_A <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>A)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unstabilized weights</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_unstab =</span> <span class="fu">ifelse</span>(A <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> ps, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stabilized weights</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sw =</span> <span class="fu">ifelse</span>(A <span class="sc">==</span> <span class="dv">1</span>, p_A <span class="sc">/</span> ps, (<span class="dv">1</span> <span class="sc">-</span> p_A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4-diagnose-weights" class="level3" data-number="14.2.3">
<h3 data-number="14.2.3" class="anchored" data-anchor-id="step-4-diagnose-weights"><span class="header-section-number">14.2.3</span> Step 4: Diagnose weights</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Weight diagnostics</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_w  =</span> <span class="fu">min</span>(sw),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">p01_w  =</span> <span class="fu">quantile</span>(sw, <span class="fl">0.01</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(sw),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">p99_w  =</span> <span class="fu">quantile</span>(sw, <span class="fl">0.99</span>),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_w  =</span> <span class="fu">max</span>(sw),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_w =</span> <span class="fu">mean</span>(sw),</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_w   =</span> <span class="fu">sd</span>(sw),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 8
      A min_w p01_w median p99_w max_w mean_w  sd_w
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1     0 0.768 0.784  0.960  1.50  2.08  1.00  0.161
2     1 0.373 0.406  0.817  3.22  7.06  0.991 0.594</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Weight distribution plot</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> sw, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stabilized IPTW weight"</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of Stabilized IPTW Weights"</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>)) <span class="sc">+</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>What to look for:</strong></p>
<ul>
<li>Weights should be centered around 1 (for stabilized weights)</li>
<li>Very large weights (&gt; 10) indicate positivity problems</li>
<li>The mean of stabilized weights should be approximately 1</li>
</ul>
</section>
<section id="step-5-check-covariate-balance-after-weighting" class="level3" data-number="14.2.4">
<h3 data-number="14.2.4" class="anchored" data-anchor-id="step-5-check-covariate-balance-after-weighting"><span class="header-section-number">14.2.4</span> Step 5: Check covariate balance after weighting</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardized mean differences: unweighted vs weighted</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>compute_smd <span class="ot">&lt;-</span> <span class="cf">function</span>(data, var, trt, <span class="at">weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(weights)) weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  w1 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  w0 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d1, w1)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d0, w0)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w1 <span class="sc">*</span> (d1 <span class="sc">-</span> m1)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w1))</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  s0 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w0 <span class="sc">*</span> (d0 <span class="sc">-</span> m0)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w0))</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  pooled_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((s1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> s0<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  (m1 <span class="sc">-</span> m0) <span class="sc">/</span> pooled_sd</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"bmi"</span>, <span class="st">"hba1c"</span>, <span class="st">"cvd"</span>, <span class="st">"egfr"</span>, <span class="st">"statin"</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>smd_raw <span class="ot">&lt;-</span> <span class="fu">sapply</span>(covariates, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>))</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>smd_wt  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(covariates, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>, dat<span class="sc">$</span>sw))</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>smd_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> covariates,</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">Unadjusted =</span> <span class="fu">abs</span>(smd_raw),</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">Weighted   =</span> <span class="fu">abs</span>(smd_wt)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>variable, <span class="at">names_to =</span> <span class="st">"Method"</span>, <span class="at">values_to =</span> <span class="st">"SMD"</span>)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(smd_df, <span class="fu">aes</span>(<span class="at">x =</span> SMD, <span class="at">y =</span> <span class="fu">reorder</span>(variable, SMD), <span class="at">color =</span> Method, <span class="at">shape =</span> Method)) <span class="sc">+</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Absolute Standardized Mean Difference"</span>,</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Covariate Balance: Before and After IPTW"</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#EE6677"</span>, <span class="st">"#228833"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The dashed line at 0.1 is a common threshold. After weighting, all covariates should be below this line.</p>
</section>
<section id="step-6-estimate-the-ate" class="level3" data-number="14.2.5">
<h3 data-number="14.2.5" class="anchored" data-anchor-id="step-6-estimate-the-ate"><span class="header-section-number">14.2.5</span> Step 6: Estimate the ATE</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hajek (ratio) estimator with stabilized weights</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>risk1_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>risk0_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>iptw_ate   <span class="ot">&lt;-</span> risk1_iptw <span class="sc">-</span> risk0_iptw</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW risk (dapagliflozin):"</span>, <span class="fu">round</span>(risk1_iptw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW risk (dapagliflozin): 0.0559 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW risk (sulfonylurea): "</span>, <span class="fu">round</span>(risk0_iptw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW risk (sulfonylurea):  0.0996 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE:                 "</span>, <span class="fu">round</span>(iptw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW ATE:                  -0.0438 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                  -0.0338 </code></pre>
</div>
</div>
</section>
<section id="weight-truncation" class="level3" data-number="14.2.6">
<h3 data-number="14.2.6" class="anchored" data-anchor-id="weight-truncation"><span class="header-section-number">14.2.6</span> Weight truncation</h3>
<p>If weights are extreme, truncation can improve stability at the cost of a small amount of bias:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Truncate at 1st and 99th percentiles</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>trunc_lower <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw, <span class="fl">0.01</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>trunc_upper <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw, <span class="fl">0.99</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sw_trunc =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(sw, trunc_lower), trunc_upper))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>risk1_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>risk0_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>iptw_ate_trunc <span class="ot">&lt;-</span> risk1_trunc <span class="sc">-</span> risk0_trunc</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE (truncated weights):"</span>, <span class="fu">round</span>(iptw_ate_trunc, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IPTW ATE (truncated weights): -0.0472 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Just Happened?
</div>
</div>
<div class="callout-body-container callout-body">
<p>IPTW adjusts for confounding through the treatment model alone. It does not use information about the outcome-confounder relationship.</p>
<p><strong>The weakness:</strong> If the propensity score model is wrong, IPTW is biased. If positivity is limited, weights become extreme and the estimate becomes unstable. And unlike G-computation, IPTW does not use the outcome model at all.</p>
<p><strong>This motivates doubly robust methods</strong> — which use BOTH the outcome model and the treatment model, so that if either one is correct, the estimate is consistent.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="d.-aipw-augmented-inverse-probability-weighting" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="d.-aipw-augmented-inverse-probability-weighting"><span class="header-section-number">14.3</span> 4D. AIPW (Augmented Inverse Probability Weighting)</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Doubly Robust Idea
</div>
</div>
<div class="callout-body-container callout-body">
<p>What if we could use BOTH the outcome model and the treatment model, and as long as EITHER one is correct, get a consistent estimate? This is exactly what AIPW (and TMLE) provide.</p>
</div>
</div>
<p>AIPW combines the outcome model and the treatment model. It is <strong>doubly robust</strong>: consistent if either model is correct.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using models from previous steps:</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1, Q0 = predicted outcomes from g-computation</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ps     = propensity scores from IPTW</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># AIPW components</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>mu1_aipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">mean</span>(</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  Q1 <span class="sc">+</span> A <span class="sc">*</span> (Y <span class="sc">-</span> Q1) <span class="sc">/</span> ps</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>mu0_aipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">mean</span>(</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  Q0 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">*</span> (Y <span class="sc">-</span> Q0) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>aipw_ate <span class="ot">&lt;-</span> mu1_aipw <span class="sc">-</span> mu0_aipw</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW risk (dapagliflozin):"</span>, <span class="fu">round</span>(mu1_aipw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW risk (dapagliflozin): 0.0596 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW risk (sulfonylurea): "</span>, <span class="fu">round</span>(mu0_aipw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW risk (sulfonylurea):  0.0995 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW ATE:                 "</span>, <span class="fu">round</span>(aipw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW ATE:                  -0.04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                  -0.0338 </code></pre>
</div>
</div>
<section id="influence-curve-and-inference" class="level3" data-number="14.3.1">
<h3 data-number="14.3.1" class="anchored" data-anchor-id="influence-curve-and-inference"><span class="header-section-number">14.3.1</span> Influence curve and inference</h3>
<p>The efficient influence curve (EIC) for the ATE gives us individual-level “scores” that measure each observation’s contribution to the estimate. The variance of these scores provides valid standard errors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Efficient influence curve for ATE</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>eic <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  (A <span class="sc">/</span> ps) <span class="sc">*</span> (Y <span class="sc">-</span> Q1) <span class="sc">+</span> Q1 <span class="sc">-</span> mu1_aipw <span class="sc">-</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  ((<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)) <span class="sc">*</span> (Y <span class="sc">-</span> Q0) <span class="sc">-</span> Q0 <span class="sc">+</span> mu0_aipw</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>aipw_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic) <span class="sc">/</span> n)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>aipw_ci <span class="ot">&lt;-</span> aipw_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> aipw_se</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW ATE:"</span>, <span class="fu">round</span>(aipw_ate, <span class="dv">4</span>),</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(aipw_se, <span class="dv">4</span>),</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(aipw_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(aipw_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AIPW ATE: -0.04  SE: 0.0101  95% CI: [ -0.0598 , -0.0201 ]</code></pre>
</div>
</div>
<p><strong>Key insight:</strong> AIPW improves on both g-computation and IPTW by using both models. However, AIPW does not “target” its initial estimates — it can produce predicted probabilities outside [0, 1], and it does not solve the efficient influence curve equation exactly when machine learning is used. TMLE addresses both issues.</p>
<hr>
</section>
</section>
<section id="e.-tmle-targeted-maximum-likelihood-estimation" class="level2" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="e.-tmle-targeted-maximum-likelihood-estimation"><span class="header-section-number">14.4</span> 4E. TMLE (Targeted Maximum Likelihood Estimation)</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why TMLE?
</div>
</div>
<div class="callout-body-container callout-body">
<p>TMLE is the centerpiece of this chapter. It combines the best properties of all previous methods:</p>
<ul>
<li>Uses both outcome and treatment models (<strong>doubly robust</strong>)</li>
<li><strong>Targets</strong> the specific estimand of interest (not just fitting a good outcome model)</li>
<li>Respects natural parameter bounds (probabilities stay in [0, 1])</li>
<li>Solves the efficient influence curve equation, ensuring <strong>valid inference</strong></li>
<li>Integrates naturally with machine learning (Super Learner)</li>
</ul>
</div>
</div>
<section id="conceptual-overview" class="level3" data-number="14.4.1">
<h3 data-number="14.4.1" class="anchored" data-anchor-id="conceptual-overview"><span class="header-section-number">14.4.1</span> Conceptual overview</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TMLE in Three Stages
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><strong>Initial estimate:</strong> Fit an outcome model <span class="math inline">\(\hat{Q}^0(A, W) = \hat{E}[Y \mid A, W]\)</span> (like g-computation)</li>
<li><strong>Targeting step:</strong> Update <span class="math inline">\(\hat{Q}^0\)</span> using information from the propensity score to reduce bias for the specific estimand</li>
<li><strong>Substitution estimate:</strong> Plug the updated <span class="math inline">\(\hat{Q}^*\)</span> into the G-computation formula</li>
</ol>
<p>The targeting step is what makes TMLE special. It uses the <strong>clever covariate</strong> — a function of the propensity score — to fluctuate the initial outcome model in the direction that solves the efficient influence curve equation.</p>
</div>
</div>
</section>
<section id="step-by-step-implementation" class="level3" data-number="14.4.2">
<h3 data-number="14.4.2" class="anchored" data-anchor-id="step-by-step-implementation"><span class="header-section-number">14.4.2</span> Step-by-step implementation</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 1: Initial Outcome Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the same as G-computation — fit <span class="math inline">\(E[Y \mid A, W]\)</span>. Think of this as your “first draft” of the outcome model. It does not need to be perfect; the targeting step will correct it.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same as g-computation — fit E[Y | A, W]</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>q_init <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial predictions</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>Q1_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>Q0_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>QA_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">type =</span> <span class="st">"response"</span>)  <span class="co"># predictions at observed A</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 2: Estimate the Propensity Score
</div>
</div>
<div class="callout-body-container callout-body">
<p>Same as IPTW — model the probability of treatment given confounders. We bound the scores away from 0 and 1 to prevent numerical instability.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same model as IPTW</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>g_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> age<span class="sc">:</span>cvd,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>ps_tmle <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_fit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Bound propensity scores away from 0 and 1 for stability</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>ps_tmle <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.01</span>, <span class="fu">pmin</span>(<span class="fl">0.99</span>, ps_tmle))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3: Compute the Clever Covariate
</div>
</div>
<div class="callout-body-container callout-body">
<p>The clever covariate <span class="math inline">\(H(A, W)\)</span> is the bridge between the treatment model and the outcome model. It tells the targeting step <em>which observations are most informative</em> about the causal effect.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for each observation at their OBSERVED treatment</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>H_A <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">/</span> ps_tmle <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate under A=1 and A=0 (for prediction)</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>H_1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ps_tmle</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>H_0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The clever covariate is large when a patient’s treatment was unlikely given their covariates — exactly the patients who are most informative about the causal effect.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 4: Fluctuation (The Targeting Step)
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is <strong>the key step</strong> that makes TMLE different from every other estimator. We fit a logistic regression of <span class="math inline">\(Y\)</span> on <span class="math inline">\(H(A, W)\)</span> with the initial <span class="math inline">\(\hat{Q}^0\)</span> as an offset. The coefficient <span class="math inline">\(\epsilon\)</span> tells us how much to “nudge” the initial estimate toward solving the efficient influence curve equation.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fluctuation model: logit(Y) ~ offset(logit(Q_init)) + H</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>fluc <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QA_init)) <span class="sc">+</span> H_A,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon (fluctuation parameter):"</span>, <span class="fu">round</span>(epsilon, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epsilon (fluctuation parameter): -0.00633 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpreting Epsilon
</div>
</div>
<div class="callout-body-container callout-body">
<p>A small <span class="math inline">\(\epsilon\)</span> means the initial model was already close to solving the EIC equation. A large <span class="math inline">\(\epsilon\)</span> means the targeting step made a substantial correction.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 5: Update Predictions
</div>
</div>
<div class="callout-body-container callout-body">
<p>Apply the fluctuation to get the <strong>targeted</strong> predictions. Because we use the inverse-logit function (<code>plogis</code>), predictions are guaranteed to stay in [0, 1] — the natural bounds for a probability.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the fluctuation to counterfactual predictions</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>Q1_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q1_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_1)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>Q0_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q0_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 6: Compute the TMLE Estimate
</div>
</div>
<div class="callout-body-container callout-body">
<p>Average the targeted predictions across the population — just like the final step of G-computation, but now using the <strong>updated</strong> <span class="math inline">\(\hat{Q}^*\)</span> that has been targeted for our specific estimand.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>tmle_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_star)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>tmle_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_star)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>tmle_ate   <span class="ot">&lt;-</span> tmle_risk1 <span class="sc">-</span> tmle_risk0</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (dapagliflozin):"</span>, <span class="fu">round</span>(tmle_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE risk (dapagliflozin): 0.0594 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (sulfonylurea): "</span>, <span class="fu">round</span>(tmle_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE risk (sulfonylurea):  0.1002 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:                 "</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE ATE:                  -0.0409 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATE:                  -0.0338 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 7: Inference via the Efficient Influence Curve
</div>
</div>
<div class="callout-body-container callout-body">
<p>The EIC gives each observation a “score” measuring its contribution to the estimate. The variance of these scores provides asymptotically valid standard errors — no bootstrap needed.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># EIC evaluated at the TMLE estimates</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>eic_tmle <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  (A <span class="sc">/</span> ps_tmle) <span class="sc">*</span> (Y <span class="sc">-</span> Q1_star) <span class="sc">+</span> Q1_star <span class="sc">-</span> tmle_risk1 <span class="sc">-</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  ((<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)) <span class="sc">*</span> (Y <span class="sc">-</span> Q0_star) <span class="sc">-</span> Q0_star <span class="sc">+</span> tmle_risk0</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>tmle_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic_tmle) <span class="sc">/</span> n)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>tmle_ci <span class="ot">&lt;-</span> tmle_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> tmle_se</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:"</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>),</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(tmle_se, <span class="dv">4</span>),</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TMLE ATE: -0.0409  SE: 0.0102  95% CI: [ -0.0608 , -0.021 ]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Verify: Is the EIC Mean Zero?
</div>
</div>
<div class="callout-body-container callout-body">
<p>A correctly implemented TMLE solves the efficient influence curve equation, meaning the sample mean of the EIC should be approximately zero. This is how you know the targeting step worked correctly.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of EIC:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic_tmle), <span class="dv">8</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean of EIC: 0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(Should be very close to zero)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Should be very close to zero)</code></pre>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Putting It All Together
</div>
</div>
<div class="callout-body-container callout-body">
<p>We now have five estimators of the same causal quantity. Let’s see how they compare. If our models are reasonable, the doubly robust methods (AIPW and TMLE) should be closest to the truth.</p>
</div>
</div>
</section>
</section>
</section>
<section id="comparing-all-estimators" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> 5. Comparing All Estimators</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method  =</span> <span class="fu">c</span>(<span class="st">"Naive"</span>, <span class="st">"G-computation"</span>, <span class="st">"IPTW"</span>, <span class="st">"IPTW (truncated)"</span>, <span class="st">"AIPW"</span>, <span class="st">"TMLE"</span>),</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATE     =</span> <span class="fu">c</span>(naive_rd, gcomp_ate, iptw_ate, iptw_ate_trunc, aipw_ate, tmle_ate),</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE      =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_se, <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_se, tmle_se),</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_low  =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_ci[<span class="dv">1</span>], <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_ci[<span class="dv">1</span>], tmle_ci[<span class="dv">1</span>]),</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_high =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_ci[<span class="dv">2</span>], <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_ci[<span class="dv">2</span>], tmle_ci[<span class="dv">2</span>])</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  Method               ATE      SE  CI_low CI_high
  &lt;chr&gt;              &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 Naive            -0.0656 NA      NA      NA     
2 G-computation    -0.0367  0.0098 -0.0569 -0.0191
3 IPTW             -0.0438 NA      NA      NA     
4 IPTW (truncated) -0.0472 NA      NA      NA     
5 AIPW             -0.04    0.0101 -0.0598 -0.0201
6 TMLE             -0.0409  0.0102 -0.0608 -0.021 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the comparison</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(SE)) <span class="sc">%&gt;%</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="fu">factor</span>(Method, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"G-computation"</span>, <span class="st">"AIPW"</span>, <span class="st">"TMLE"</span>)))</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> ATE, <span class="at">y =</span> Method)) <span class="sc">+</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> CI_low, <span class="at">xmax =</span> CI_high), <span class="at">height =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_ate, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> true_ate, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">label =</span> <span class="st">"True ATE"</span>,</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated ATE (Risk Difference)"</span>,</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Causal Estimators"</span>,</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red dashed line = true causal effect"</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="diagnostics" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> 6. Diagnostics</h1>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Diagnostics Are Non-Negotiable
</div>
</div>
<div class="callout-body-container callout-body">
<p>Good estimation is nothing without good diagnostics. <strong>Never report a causal estimate without checking these diagnostics.</strong> They tell you whether your assumptions are plausible and whether the estimator is well-behaved.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
6.1 Propensity Score Overlap
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the propensity score distributions for treated and untreated overlap well, the positivity assumption is plausible. <strong>Gaps</strong> indicate regions where one treatment is rarely or never prescribed — all methods will struggle there, but IPTW is especially vulnerable.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps_tmle, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">40</span>, <span class="at">alpha =</span> <span class="fl">0.55</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Propensity score"</span>,</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Distribution by Treatment Group"</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
6.2 Weight Distribution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stabilized weights should center around 1. Very large weights (&gt; 10) indicate <strong>practical positivity violations</strong> — patients who almost never receive their observed treatment. These patients dominate IPTW estimates and destabilize the clever covariate in TMLE.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Unstabilized weight summary ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Unstabilized weight summary ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>w_unstab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.003   1.182   1.337   1.991   1.828  30.108 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Stabilized weight summary ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Stabilized weight summary ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>sw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3727  0.8562  0.9480  0.9977  1.0891  7.0573 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Proportion of stabilized weights &gt; 5:"</span>, <span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Proportion of stabilized weights &gt; 5: 6e-04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion of stabilized weights &gt; 10:"</span>, <span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Proportion of stabilized weights &gt; 10: 0 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
6.3 Clever Covariate Diagnostics
</div>
</div>
<div class="callout-body-container callout-body">
<p>The clever covariate drives the TMLE targeting step. Extreme values indicate potential instability — if <span class="math inline">\(H(A, W)\)</span> has heavy tails, the targeting step may overfit to a few influential observations.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>clever_cov_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">H =</span> H_A,</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="fu">factor</span>(dat<span class="sc">$</span>A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>))</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(clever_cov_df, <span class="fu">aes</span>(<span class="at">x =</span> H, <span class="at">fill =</span> treatment)) <span class="sc">+</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Clever covariate H(A, W)"</span>,</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of the Clever Covariate"</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
6.4 Influence Curve Diagnostics
</div>
</div>
<div class="callout-body-container callout-body">
<p>The EIC values reveal <strong>influential observations</strong>. A well-behaved TMLE has EIC values centered near zero with no extreme outliers. If you see long tails or a non-zero mean, something may be wrong with the targeting step or the propensity score model.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>eic_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">eic =</span> eic_tmle)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(eic_df, <span class="fu">aes</span>(<span class="at">x =</span> eic)) <span class="sc">+</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#228833"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Efficient influence curve value"</span>,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of TMLE Influence Curve Values"</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-04-tmle-teaching-examples_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EIC summary:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(eic_tmle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-4.80971 -0.02585  0.08820  0.00000  0.12378 24.86376 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic_tmle), <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EIC mean: 0 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
6.5 Extreme Prediction Check
</div>
</div>
<div class="callout-body-container callout-body">
<p>One of TMLE’s advantages: because the targeting step uses a logistic fluctuation, predictions are guaranteed to stay in [0, 1]. Compare the initial and targeted ranges — the targeting step may shift predictions, but never outside the natural bounds.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Predicted outcome range (initial model) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Predicted outcome range (initial model) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q1 range: 0.0088 0.7715 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q0 range: 0.0091 0.877 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Predicted outcome range (after targeting) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Predicted outcome range (after targeting) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1* range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_star), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q1* range: 0.0087 0.6419 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0* range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_star), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Q0* range: 0.0092 0.8777 </code></pre>
</div>
</div>
<hr>
</section>
<section id="interpretation" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> 7. Interpretation</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Translating to Regulatory Language
</div>
</div>
<div class="callout-body-container callout-body">
<p>Based on the TMLE analysis:</p>
</div>
</div>
<ul>
<li><strong>Point estimate:</strong> Dapagliflozin is estimated to reduce 1-year MACE risk by approximately 4.1 percentage points compared to sulfonylurea</li>
<li><strong>Confidence interval:</strong> The 95% CI is [-6.1, -2.1] percentage points</li>
<li><strong>Risk difference vs.&nbsp;odds ratio:</strong> We report on the risk difference scale because it is directly interpretable. An odds ratio would obscure the magnitude of absolute risk change, which is what matters for labeling and clinical decisions.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Regulatory Decision
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the confidence interval excludes zero and the point estimate is negative (protective), the data do not support adding a cardiovascular warning. If the CI includes zero, the evidence is inconclusive and further monitoring or a dedicated outcomes trial may be warranted.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Sensitivity to Assumptions — Which Are Most Fragile?
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>No unmeasured confounding (exchangeability):</strong> This is always the weakest link in observational data. Lifestyle factors (diet, exercise, smoking) may confound and are poorly captured in claims data.</p></li>
<li><p><strong>Positivity:</strong> If some patient types never receive one drug (e.g., patients with very low eGFR are ineligible for SGLT2 inhibitors), the ATE is not identifiable for the full population. Consider restricting to a subpopulation where positivity holds.</p></li>
<li><p><strong>Consistency:</strong> If treatment initiation is not well-defined (e.g., varying doses), the potential outcomes are ambiguous.</p></li>
</ol>
<p><strong>What if unmeasured confounding exists?</strong> A sensitivity analysis (E-value or bias analysis) can quantify how strong unmeasured confounding would need to be to explain away the observed effect.</p>
</div>
</div>
<hr>
</section>
<section id="why-super-learner-improves-nuisance-estimation" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> 8. Why Super Learner Improves Nuisance Estimation</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Problem With Parametric Models
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the examples above, we used parametric logistic regression for both the outcome and treatment models. In practice, these models may be misspecified — missing interactions, wrong functional forms, or overly rigid assumptions. <strong>Super Learner</strong> eliminates the need to guess the right model.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What Is Super Learner?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Super Learner is an ensemble machine learning method that:</p>
<ol type="1">
<li>Takes a <strong>library of candidate learners</strong> (logistic regression, LASSO, random forest, etc.)</li>
<li>Uses <strong>cross-validation</strong> to evaluate each learner’s performance</li>
<li>Combines them using <strong>optimally weighted stacking</strong></li>
<li>Guarantees performance at least as good as the best individual learner (asymptotically)</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why This Matters for TMLE
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>TMLE is doubly robust: consistent if either the outcome or treatment model is correct</li>
<li>But TMLE is <strong>efficient</strong> when both models are consistent at reasonable rates</li>
<li>Super Learner reduces the risk of misspecifying either model</li>
<li>Cross-validation within Super Learner protects against overfitting</li>
</ul>
<p><strong>Bottom line:</strong> Super Learner + TMLE = data-adaptive, doubly robust, efficient estimation with valid inference.</p>
</div>
</div>
<section id="conceptual-demonstration" class="level3" data-number="18.0.1">
<h3 data-number="18.0.1" class="anchored" data-anchor-id="conceptual-demonstration"><span class="header-section-number">18.0.1</span> Conceptual demonstration</h3>
<p>The following shows how Super Learner would be integrated (this requires the SuperLearner package, which may not run in all webR environments):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define learner library</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>SL_lib <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.gam"</span>, <span class="st">"SL.mean"</span>)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model via Super Learner</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>Q_SL <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> dat<span class="sc">$</span>Y,</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> dat <span class="sc">%&gt;%</span> <span class="fu">select</span>(A, age, bmi, hba1c, cvd, egfr, statin),</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> SL_lib</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment model via Super Learner</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>g_SL <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> dat<span class="sc">$</span>A,</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> dat <span class="sc">%&gt;%</span> <span class="fu">select</span>(age, bmi, hba1c, cvd, egfr, statin),</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> SL_lib</span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a><span class="co"># View the cross-validated weights</span></span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>Q_SL<span class="sc">$</span>coef  <span class="co"># how much each learner contributes to the outcome model</span></span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>g_SL<span class="sc">$</span>coef  <span class="co"># how much each learner contributes to the treatment model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Super Learner automatically determines which learners are most useful and how to combine them — no manual model selection required.</p>
<hr>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
9. Summary of Estimator Trade-offs
</div>
</div>
<div class="callout-body-container callout-body">
<p>The table below summarizes the key properties of each estimator. TMLE stands out as the only method that is doubly robust, respects parameter bounds, solves the EIC, and integrates naturally with machine learning.</p>
</div>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 22%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Property</th>
<th>G-comp</th>
<th>IPTW</th>
<th>AIPW</th>
<th>TMLE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Uses outcome model</td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Uses treatment model</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Doubly robust</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Respects bounds</td>
<td>Depends</td>
<td>N/A</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Efficient (solves EIC)</td>
<td>No</td>
<td>No</td>
<td>Asymptotically</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Works with ML</td>
<td>Partially</td>
<td>Partially</td>
<td>Needs cross-fitting</td>
<td>Naturally</td>
</tr>
<tr class="odd">
<td>Inference method</td>
<td>Bootstrap</td>
<td>Sandwich</td>
<td>Influence curve</td>
<td>Influence curve</td>
</tr>
</tbody>
</table>
<hr>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Takeaways
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>The naive estimate is biased</strong> because treatment groups differ in baseline characteristics. Never interpret unadjusted comparisons as causal effects.</p></li>
<li><p><strong>G-computation is intuitive</strong> but depends on correctly modeling the outcome. It implements the identification formula directly.</p></li>
<li><p><strong>IPTW tackles confounding through reweighting</strong> but is sensitive to positivity violations and propensity score misspecification. Always check weight distributions.</p></li>
<li><p><strong>AIPW is doubly robust</strong> — consistent if either the outcome or treatment model is correct. But it does not target the parameter of interest and can produce out-of-bounds predictions.</p></li>
<li><p><strong>TMLE combines the strengths of all methods.</strong> It starts with an outcome model, targets it using the propensity score, respects parameter bounds, and provides efficient inference through the influence curve.</p></li>
<li><p><strong>Super Learner</strong> reduces the risk of model misspecification by ensembling multiple learners with cross-validated weights. It pairs naturally with TMLE.</p></li>
<li><p><strong>Diagnostics are non-negotiable.</strong> Always inspect propensity score overlap, weight distributions, covariate balance, and influence curve behavior before trusting any estimate.</p></li>
<li><p><strong>Every step of the causal roadmap matters.</strong> The estimate is only as valid as the assumptions that identify the causal effect from observational data.</p></li>
</ol>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
10. Where to Go Next
</div>
</div>
<div class="callout-body-container callout-body">
<p>The framework in this chapter extends to several important settings — each covered in subsequent chapters:</p>
<ul>
<li><strong>Dynamic treatment regimes:</strong> Treatment rules that depend on patient characteristics (e.g., “prescribe dapagliflozin if eGFR &gt; 45, else sulfonylurea”)</li>
<li><strong>Stochastic interventions:</strong> Shift the probability of treatment rather than forcing a deterministic assignment — useful when positivity is limited</li>
<li><strong>Mediation analysis:</strong> Decompose the total effect into direct and indirect pathways (see Chapter 3.10)</li>
<li><strong>Longitudinal TMLE (LTMLE):</strong> Handle time-varying treatments and confounders (see Chapters 3.7 and 3.9)</li>
<li><strong>Clean-room TMLE:</strong> Pre-specified, locked, auditable analysis for regulatory submissions (see Chapter 3.8)</li>
<li><strong>Conditional average treatment effects (CATE):</strong> Estimate how the treatment effect varies across subgroups</li>
<li><strong>Variable importance:</strong> Identify which confounders matter most for the treatment effect</li>
</ul>
<p>Each extension follows the same causal roadmap: define the question, specify the causal model, verify assumptions, identify the statistical estimand, and choose an appropriate estimator.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    
 [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   
 [9] ggplot2_3.5.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 
 [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         
 [9] labeling_0.4.3    generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4
[13] munsell_0.5.1     pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6      
[17] utf8_1.2.4        stringi_1.8.7     xfun_0.49         timechange_0.3.0 
[21] cli_3.6.5         withr_3.0.2       magrittr_2.0.3    digest_0.6.37    
[25] grid_4.4.2        rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4  
[29] vctrs_0.6.5       evaluate_1.0.5    glue_1.8.0        farver_2.1.2     
[33] fansi_1.0.6       colorspace_2.1-1  rmarkdown_2.29    tools_4.4.2      
[37] pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
</div>
<hr>
</section>
<section id="software-implementation-r" class="level2" data-number="18.1">
<h2 data-number="18.1" class="anchored" data-anchor-id="software-implementation-r"><span class="header-section-number">18.1</span> Software Implementation (R)</h2>
<p>This example brings together the progressive estimation sequence from this chapter (naive → g-computation → IPTW → TMLE) using the <code>tmle</code> package with Super Learner.</p>
<ul>
<li>Simulate a pharmacoepi-style dataset with multiple confounders</li>
<li>Run the <code>tmle()</code> function with a diverse Super Learner library</li>
<li>Extract and interpret: ATE, risk difference, confidence interval, and influence curve diagnostics</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">800</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>W1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)                                      <span class="co"># age (standardized)</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>W2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.3</span>)                             <span class="co"># diabetes indicator</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>W3 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">0.5</span> <span class="sc">*</span> W1)                     <span class="co"># BMI (standardized)</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>A  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> W2 <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> W3))</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>Y  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> W2 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> W3))</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"tmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tmle)</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">W1 =</span> W1, <span class="at">W2 =</span> W2, <span class="at">W3 =</span> W3)</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>  tmle_fit <span class="ot">&lt;-</span> <span class="fu">tmle</span>(</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> Y, <span class="at">A =</span> A, <span class="at">W =</span> W,</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q.SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.step"</span>, <span class="st">"SL.mean"</span>),</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">g.SL.library  =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.step"</span>, <span class="st">"SL.mean"</span>)</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"── TMLE results ─────────────────────</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ATE (risk difference):"</span>, <span class="fu">round</span>(tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>psi, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>CI, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"p-value:"</span>, <span class="fu">format.pval</span>(tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>pvalue, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Influence curve diagnostic (mean should be ≈ 0)</span></span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>  ic <span class="ot">&lt;-</span> tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>IC</span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Influence curve mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(ic), <span class="dv">6</span>),</span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">" (should be ≈ 0)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install the 'tmle' package:  install.packages('tmle')"</span>)</span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amertens\.github\.io\/causal-learning-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02-03-doubly-robust-tmle.html" class="pagination-link" aria-label="Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./superlearner.html" class="pagination-link" aria-label="Chapter 2.4: SuperLearner and Machine Learning for Causal Inference">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb125" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 2.4: From Question to Estimate — TMLE in Practice"</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>*A progressive tutorial for pharmacoepidemiologists*</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>This chapter walks through a complete causal analysis from start to finish, building each estimator step-by-step so you can see exactly where bias enters, how each method addresses it, and why TMLE provides a principled solution.</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>We use a realistic post-marketing safety scenario: **evaluating the cardiovascular safety of a new diabetes drug**.</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, you will have implemented:</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>A naive (unadjusted) model</span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>G-computation (outcome modeling)</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>IPTW (treatment modeling)</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>AIPW (combining both)</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>TMLE (targeting the estimate)</span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>Each method builds on what came before. Every step includes code, diagnostics, and interpretation.</span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. Clinical Motivation</span></span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Regulatory Question</span></span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a>A new sodium-glucose co-transporter 2 (SGLT2) inhibitor, **dapagliflozin**, has been approved for type 2 diabetes. Post-marketing surveillance data from insurance claims suggest a potential cardiovascular safety signal. The FDA's Office of Surveillance and Epidemiology asks:</span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Does initiation of dapagliflozin (vs. a sulfonylurea comparator) increase the 1-year risk of major adverse cardiovascular events (MACE) in adults with type 2 diabetes?**</span></span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a>This is a classic **active comparator, new user** design question.</span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key elements</span></span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-37"><a href="#cb125-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Target population:** Adults aged 40-85 with type 2 diabetes initiating a new oral glucose-lowering agent</span>
<span id="cb125-38"><a href="#cb125-38" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treatment strategies:** Initiate dapagliflozin (A = 1) vs. initiate sulfonylurea (A = 0)</span>
<span id="cb125-39"><a href="#cb125-39" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Outcome:** 1-year MACE (composite of MI, stroke, CV death), binary</span>
<span id="cb125-40"><a href="#cb125-40" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Intercurrent events:** Treatment discontinuation, switching, death from non-CV causes</span>
<span id="cb125-41"><a href="#cb125-41" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Decision:** Should the label carry a cardiovascular warning? Is a formal safety trial needed?</span>
<span id="cb125-42"><a href="#cb125-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-43"><a href="#cb125-43" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why standard regression falls short</span></span>
<span id="cb125-44"><a href="#cb125-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-45"><a href="#cb125-45" aria-hidden="true" tabindex="-1"></a>A logistic regression of MACE on treatment will confound the effect with differences in baseline health. Patients prescribed newer, more expensive agents may differ systematically from those prescribed sulfonylureas — in age, comorbidity burden, prior cardiovascular history, renal function, and concomitant medications.</span>
<span id="cb125-46"><a href="#cb125-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-47"><a href="#cb125-47" aria-hidden="true" tabindex="-1"></a>We need methods that explicitly separate confounding from causal effects.</span>
<span id="cb125-48"><a href="#cb125-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-49"><a href="#cb125-49" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-50"><a href="#cb125-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-51"><a href="#cb125-51" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. The Causal Roadmap</span></span>
<span id="cb125-52"><a href="#cb125-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-53"><a href="#cb125-53" aria-hidden="true" tabindex="-1"></a>We follow a five-step workflow that structures every causal analysis.</span>
<span id="cb125-54"><a href="#cb125-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-55"><a href="#cb125-55" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-56"><a href="#cb125-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Define the Causal Question</span></span>
<span id="cb125-57"><a href="#cb125-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-58"><a href="#cb125-58" aria-hidden="true" tabindex="-1"></a>**In plain language:**</span>
<span id="cb125-59"><a href="#cb125-59" aria-hidden="true" tabindex="-1"></a>What would happen to 1-year MACE risk if every eligible patient started dapagliflozin, compared to if every eligible patient started a sulfonylurea?</span>
<span id="cb125-60"><a href="#cb125-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-61"><a href="#cb125-61" aria-hidden="true" tabindex="-1"></a>**As a counterfactual estimand:**</span>
<span id="cb125-62"><a href="#cb125-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-63"><a href="#cb125-63" aria-hidden="true" tabindex="-1"></a>The Average Treatment Effect (ATE) on the risk difference scale:</span>
<span id="cb125-64"><a href="#cb125-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-65"><a href="#cb125-65" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb125-66"><a href="#cb125-66" aria-hidden="true" tabindex="-1"></a>\psi = E<span class="co">[</span><span class="ot">Y(1)</span><span class="co">]</span> - E<span class="co">[</span><span class="ot">Y(0)</span><span class="co">]</span></span>
<span id="cb125-67"><a href="#cb125-67" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb125-68"><a href="#cb125-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-69"><a href="#cb125-69" aria-hidden="true" tabindex="-1"></a>where $Y(a)$ is the potential outcome under treatment strategy $a$.</span>
<span id="cb125-70"><a href="#cb125-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-71"><a href="#cb125-71" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$E<span class="co">[</span><span class="ot">Y(1)</span><span class="co">]</span>$ = population risk of MACE if everyone took dapagliflozin</span>
<span id="cb125-72"><a href="#cb125-72" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$E<span class="co">[</span><span class="ot">Y(0)</span><span class="co">]</span>$ = population risk of MACE if everyone took sulfonylurea</span>
<span id="cb125-73"><a href="#cb125-73" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A negative $\psi$ means dapagliflozin is protective; a positive $\psi$ means increased risk</span>
<span id="cb125-74"><a href="#cb125-74" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-75"><a href="#cb125-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-76"><a href="#cb125-76" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-77"><a href="#cb125-77" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Define the Causal Model</span></span>
<span id="cb125-78"><a href="#cb125-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-79"><a href="#cb125-79" aria-hidden="true" tabindex="-1"></a>We posit the following causal structure. Confounders $W$ affect both treatment choice $A$ and the outcome $Y$. Treatment $A$ also affects $Y$ directly.</span>
<span id="cb125-80"><a href="#cb125-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-81"><a href="#cb125-81" aria-hidden="true" tabindex="-1"></a>The confounders include:</span>
<span id="cb125-82"><a href="#cb125-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-83"><a href="#cb125-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Age** — older patients have higher CV risk and may receive different prescriptions</span>
<span id="cb125-84"><a href="#cb125-84" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**BMI** — obesity correlates with both drug choice and CV risk</span>
<span id="cb125-85"><a href="#cb125-85" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**HbA1c** — glycemic control at baseline affects prescribing and outcomes</span>
<span id="cb125-86"><a href="#cb125-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Prior CVD** — history of cardiovascular disease is a strong confounder</span>
<span id="cb125-87"><a href="#cb125-87" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**eGFR** — renal function influences both drug eligibility and CV risk</span>
<span id="cb125-88"><a href="#cb125-88" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Statin use** — a marker of CV risk management</span>
<span id="cb125-89"><a href="#cb125-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-90"><a href="#cb125-90" aria-hidden="true" tabindex="-1"></a>The DAG (directed acyclic graph):</span>
<span id="cb125-91"><a href="#cb125-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-92"><a href="#cb125-92" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-93"><a href="#cb125-93" aria-hidden="true" tabindex="-1"></a><span class="in">       W (age, BMI, HbA1c, prior CVD, eGFR, statin)</span></span>
<span id="cb125-94"><a href="#cb125-94" aria-hidden="true" tabindex="-1"></a><span class="in">      / \</span></span>
<span id="cb125-95"><a href="#cb125-95" aria-hidden="true" tabindex="-1"></a><span class="in">     v   v</span></span>
<span id="cb125-96"><a href="#cb125-96" aria-hidden="true" tabindex="-1"></a><span class="in">     A --&gt; Y</span></span>
<span id="cb125-97"><a href="#cb125-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-98"><a href="#cb125-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-99"><a href="#cb125-99" aria-hidden="true" tabindex="-1"></a>All arrows from $W$ point to both $A$ and $Y$. There is a direct arrow from $A$ to $Y$. There are no arrows from $A$ back to $W$ (this is a point-treatment analysis at baseline).</span>
<span id="cb125-100"><a href="#cb125-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-101"><a href="#cb125-101" aria-hidden="true" tabindex="-1"></a>Structural equations:</span>
<span id="cb125-102"><a href="#cb125-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-103"><a href="#cb125-103" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$W$ is drawn from the population distribution</span>
<span id="cb125-104"><a href="#cb125-104" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$A = f_A(W, U_A)$ — treatment depends on confounders and unmeasured factors</span>
<span id="cb125-105"><a href="#cb125-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y = f_Y(A, W, U_Y)$ — outcome depends on treatment, confounders, and unmeasured factors</span>
<span id="cb125-106"><a href="#cb125-106" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-107"><a href="#cb125-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-108"><a href="#cb125-108" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb125-109"><a href="#cb125-109" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Identify Assumptions</span></span>
<span id="cb125-110"><a href="#cb125-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-111"><a href="#cb125-111" aria-hidden="true" tabindex="-1"></a>For the causal estimand $\psi = E<span class="co">[</span><span class="ot">Y(1)</span><span class="co">]</span> - E<span class="co">[</span><span class="ot">Y(0)</span><span class="co">]</span>$ to be identified from observational data, we need three untestable assumptions:</span>
<span id="cb125-112"><a href="#cb125-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-113"><a href="#cb125-113" aria-hidden="true" tabindex="-1"></a>**Consistency:**</span>
<span id="cb125-114"><a href="#cb125-114" aria-hidden="true" tabindex="-1"></a>The observed outcome for a patient who received treatment $a$ equals their potential outcome $Y(a)$. This requires a well-defined intervention — "initiate dapagliflozin" must mean the same thing across patients. In practice, we define treatment as filling a new prescription.</span>
<span id="cb125-115"><a href="#cb125-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-116"><a href="#cb125-116" aria-hidden="true" tabindex="-1"></a>**Exchangeability (no unmeasured confounding):**</span>
<span id="cb125-117"><a href="#cb125-117" aria-hidden="true" tabindex="-1"></a>$Y(a) \perp<span class="sc">\!\!\!</span>\perp A \mid W$ for all $a$. Conditional on measured baseline covariates, treatment assignment is as-good-as-random. This is the most vulnerable assumption. We cannot test it, but we can make it more plausible by adjusting for a rich set of confounders.</span>
<span id="cb125-118"><a href="#cb125-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-119"><a href="#cb125-119" aria-hidden="true" tabindex="-1"></a>**Positivity:**</span>
<span id="cb125-120"><a href="#cb125-120" aria-hidden="true" tabindex="-1"></a>$0 &lt; P(A = 1 \mid W = w) &lt; 1$ for all $w$ with $P(W = w) &gt; 0$. Every patient type has some chance of receiving either drug. Violations occur when, for example, patients with severe renal impairment are never prescribed dapagliflozin.</span>
<span id="cb125-121"><a href="#cb125-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-122"><a href="#cb125-122" aria-hidden="true" tabindex="-1"></a>Each assumption is untestable but can be made more or less plausible by study design.</span>
<span id="cb125-123"><a href="#cb125-123" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-124"><a href="#cb125-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-125"><a href="#cb125-125" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-126"><a href="#cb125-126" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Map to a Statistical Estimand</span></span>
<span id="cb125-127"><a href="#cb125-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-128"><a href="#cb125-128" aria-hidden="true" tabindex="-1"></a>Under the three assumptions above, the causal estimand equals a statistical quantity we can estimate from data:</span>
<span id="cb125-129"><a href="#cb125-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-130"><a href="#cb125-130" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb125-131"><a href="#cb125-131" aria-hidden="true" tabindex="-1"></a>\psi = E_W\big<span class="co">[</span><span class="ot">E[Y \mid A=1, W]\big</span><span class="co">]</span> - E_W\big<span class="co">[</span><span class="ot">E[Y \mid A=0, W]\big</span><span class="co">]</span></span>
<span id="cb125-132"><a href="#cb125-132" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb125-133"><a href="#cb125-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-134"><a href="#cb125-134" aria-hidden="true" tabindex="-1"></a>This is the **G-computation identification formula**. It says: fit a model for $E<span class="co">[</span><span class="ot">Y \mid A, W</span><span class="co">]</span>$, predict under $A = 1$ and $A = 0$ for every patient, and average over the population distribution of $W$.</span>
<span id="cb125-135"><a href="#cb125-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-136"><a href="#cb125-136" aria-hidden="true" tabindex="-1"></a>Equivalently, using the propensity score $g(W) = P(A=1 \mid W)$:</span>
<span id="cb125-137"><a href="#cb125-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-138"><a href="#cb125-138" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb125-139"><a href="#cb125-139" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">Y(a)</span><span class="co">]</span> = E\left<span class="co">[</span><span class="ot">\frac{I(A=a) Y}{P(A=a \mid W)}\right</span><span class="co">]</span></span>
<span id="cb125-140"><a href="#cb125-140" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb125-141"><a href="#cb125-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-142"><a href="#cb125-142" aria-hidden="true" tabindex="-1"></a>This is the **IPTW identification formula**.</span>
<span id="cb125-143"><a href="#cb125-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-144"><a href="#cb125-144" aria-hidden="true" tabindex="-1"></a>Both representations target the same quantity. They differ in which nuisance function they rely on.</span>
<span id="cb125-145"><a href="#cb125-145" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-146"><a href="#cb125-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-147"><a href="#cb125-147" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb125-148"><a href="#cb125-148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Choose an Estimation Strategy</span></span>
<span id="cb125-149"><a href="#cb125-149" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-150"><a href="#cb125-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-151"><a href="#cb125-151" aria-hidden="true" tabindex="-1"></a>| Method | Relies on | Robust to | Weakness |</span>
<span id="cb125-152"><a href="#cb125-152" aria-hidden="true" tabindex="-1"></a>|--------|-----------|-----------|----------|</span>
<span id="cb125-153"><a href="#cb125-153" aria-hidden="true" tabindex="-1"></a>| G-computation | Outcome model $E<span class="co">[</span><span class="ot">Y \mid A, W</span><span class="co">]</span>$ | Treatment model misspecification | Sensitive to outcome model misspecification |</span>
<span id="cb125-154"><a href="#cb125-154" aria-hidden="true" tabindex="-1"></a>| IPTW | Treatment model $P(A \mid W)$ | Outcome model misspecification | Sensitive to positivity violations and weight instability |</span>
<span id="cb125-155"><a href="#cb125-155" aria-hidden="true" tabindex="-1"></a>| AIPW | Both models | Misspecification of either one model | Not targeted; can produce out-of-bounds estimates |</span>
<span id="cb125-156"><a href="#cb125-156" aria-hidden="true" tabindex="-1"></a>| TMLE | Both models | Misspecification of either one model | More complex to implement; requires understanding the targeting step |</span>
<span id="cb125-157"><a href="#cb125-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-158"><a href="#cb125-158" aria-hidden="true" tabindex="-1"></a>TMLE additionally:</span>
<span id="cb125-159"><a href="#cb125-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-160"><a href="#cb125-160" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Respects the natural bounds of the parameter space (probabilities stay between 0 and 1)</span>
<span id="cb125-161"><a href="#cb125-161" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Achieves the semiparametric efficiency bound when both models are well-specified</span>
<span id="cb125-162"><a href="#cb125-162" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Provides valid inference through the efficient influence curve</span>
<span id="cb125-163"><a href="#cb125-163" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Integrates naturally with machine learning via Super Learner</span>
<span id="cb125-164"><a href="#cb125-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-165"><a href="#cb125-165" aria-hidden="true" tabindex="-1"></a>We now implement each estimator progressively.</span>
<span id="cb125-166"><a href="#cb125-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-167"><a href="#cb125-167" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-168"><a href="#cb125-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-169"><a href="#cb125-169" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Data Simulation</span></span>
<span id="cb125-170"><a href="#cb125-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-171"><a href="#cb125-171" aria-hidden="true" tabindex="-1"></a>We simulate a realistic claims-like dataset with multiple confounders, nonlinear effects, and treatment-confounder interactions.</span>
<span id="cb125-172"><a href="#cb125-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-175"><a href="#cb125-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-176"><a href="#cb125-176" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb125-177"><a href="#cb125-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-178"><a href="#cb125-178" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)</span>
<span id="cb125-179"><a href="#cb125-179" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb125-180"><a href="#cb125-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-181"><a href="#cb125-181" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Baseline confounders ---</span></span>
<span id="cb125-182"><a href="#cb125-182" aria-hidden="true" tabindex="-1"></a>age    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">62</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb125-183"><a href="#cb125-183" aria-hidden="true" tabindex="-1"></a>bmi    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">31</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb125-184"><a href="#cb125-184" aria-hidden="true" tabindex="-1"></a>hba1c  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">8.2</span>, <span class="at">sd =</span> <span class="fl">1.3</span>)</span>
<span id="cb125-185"><a href="#cb125-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior CVD: more likely with age and high BMI</span></span>
<span id="cb125-186"><a href="#cb125-186" aria-hidden="true" tabindex="-1"></a>cvd    <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.5</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.03</span> <span class="sc">*</span> bmi))</span>
<span id="cb125-187"><a href="#cb125-187" aria-hidden="true" tabindex="-1"></a><span class="co"># eGFR: lower with age, higher with lower BMI</span></span>
<span id="cb125-188"><a href="#cb125-188" aria-hidden="true" tabindex="-1"></a>egfr   <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">15</span>, <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">95</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">-</span> <span class="fl">0.3</span> <span class="sc">*</span> bmi, <span class="at">sd =</span> <span class="dv">15</span>))</span>
<span id="cb125-189"><a href="#cb125-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Statin use: more likely with CVD and age</span></span>
<span id="cb125-190"><a href="#cb125-190" aria-hidden="true" tabindex="-1"></a>statin <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.5</span> <span class="sc">+</span> <span class="fl">1.8</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> age))</span>
<span id="cb125-191"><a href="#cb125-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-192"><a href="#cb125-192" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Treatment model (propensity score) ---</span></span>
<span id="cb125-193"><a href="#cb125-193" aria-hidden="true" tabindex="-1"></a><span class="co"># Dapagliflozin is preferentially prescribed to:</span></span>
<span id="cb125-194"><a href="#cb125-194" aria-hidden="true" tabindex="-1"></a><span class="co"># - younger patients, higher eGFR (renal eligibility), higher BMI, lower HbA1c</span></span>
<span id="cb125-195"><a href="#cb125-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes nonlinear terms and interactions</span></span>
<span id="cb125-196"><a href="#cb125-196" aria-hidden="true" tabindex="-1"></a>lp_trt <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">+</span></span>
<span id="cb125-197"><a href="#cb125-197" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.03</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb125-198"><a href="#cb125-198" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb125-199"><a href="#cb125-199" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.15</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb125-200"><a href="#cb125-200" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb125-201"><a href="#cb125-201" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb125-202"><a href="#cb125-202" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb125-203"><a href="#cb125-203" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.01</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span>         <span class="co"># interaction</span></span>
<span id="cb125-204"><a href="#cb125-204" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.002</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span>             <span class="co"># nonlinear age effect</span></span>
<span id="cb125-205"><a href="#cb125-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-206"><a href="#cb125-206" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_trt))</span>
<span id="cb125-207"><a href="#cb125-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-208"><a href="#cb125-208" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome model ---</span></span>
<span id="cb125-209"><a href="#cb125-209" aria-hidden="true" tabindex="-1"></a><span class="co"># MACE risk depends on treatment, confounders, with nonlinearities</span></span>
<span id="cb125-210"><a href="#cb125-210" aria-hidden="true" tabindex="-1"></a><span class="co"># True treatment effect: dapagliflozin REDUCES MACE risk (protective)</span></span>
<span id="cb125-211"><a href="#cb125-211" aria-hidden="true" tabindex="-1"></a>lp_out <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span></span>
<span id="cb125-212"><a href="#cb125-212" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> A <span class="sc">+</span>                       <span class="co"># true causal effect (protective)</span></span>
<span id="cb125-213"><a href="#cb125-213" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span></span>
<span id="cb125-214"><a href="#cb125-214" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb125-215"><a href="#cb125-215" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span></span>
<span id="cb125-216"><a href="#cb125-216" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb125-217"><a href="#cb125-217" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb125-218"><a href="#cb125-218" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span></span>
<span id="cb125-219"><a href="#cb125-219" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span>        <span class="co"># interaction</span></span>
<span id="cb125-220"><a href="#cb125-220" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span>           <span class="co"># nonlinear age effect</span></span>
<span id="cb125-221"><a href="#cb125-221" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> A <span class="sc">*</span> cvd                   <span class="co"># treatment-confounder interaction</span></span>
<span id="cb125-222"><a href="#cb125-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-223"><a href="#cb125-223" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(lp_out))</span>
<span id="cb125-224"><a href="#cb125-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-225"><a href="#cb125-225" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(age, bmi, hba1c, cvd, egfr, statin, A, Y)</span>
<span id="cb125-226"><a href="#cb125-226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-227"><a href="#cb125-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-228"><a href="#cb125-228" aria-hidden="true" tabindex="-1"></a><span class="fu">### True causal effect</span></span>
<span id="cb125-229"><a href="#cb125-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-230"><a href="#cb125-230" aria-hidden="true" tabindex="-1"></a>We compute the true ATE from the data-generating process:</span>
<span id="cb125-231"><a href="#cb125-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-234"><a href="#cb125-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-235"><a href="#cb125-235" aria-hidden="true" tabindex="-1"></a><span class="co"># True potential outcomes from the structural model</span></span>
<span id="cb125-236"><a href="#cb125-236" aria-hidden="true" tabindex="-1"></a>p1_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb125-237"><a href="#cb125-237" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span> <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb125-238"><a href="#cb125-238" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span> <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb125-239"><a href="#cb125-239" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> <span class="dv">1</span> <span class="sc">*</span> cvd)</span>
<span id="cb125-240"><a href="#cb125-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-241"><a href="#cb125-241" aria-hidden="true" tabindex="-1"></a>p0_true <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">3.2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.40</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fl">0.04</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (bmi <span class="sc">-</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb125-242"><a href="#cb125-242" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.10</span> <span class="sc">*</span> (hba1c <span class="sc">-</span> <span class="fl">8.2</span>) <span class="sc">+</span> <span class="fl">1.00</span> <span class="sc">*</span> cvd <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.01</span> <span class="sc">*</span> (egfr <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb125-243"><a href="#cb125-243" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.30</span> <span class="sc">*</span> statin <span class="sc">+</span> <span class="fl">0.015</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>) <span class="sc">*</span> cvd <span class="sc">+</span></span>
<span id="cb125-244"><a href="#cb125-244" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.0008</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">62</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="sc">-</span><span class="fl">0.10</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> cvd)</span>
<span id="cb125-245"><a href="#cb125-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-246"><a href="#cb125-246" aria-hidden="true" tabindex="-1"></a>true_ate <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_true <span class="sc">-</span> p0_true)</span>
<span id="cb125-247"><a href="#cb125-247" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE (risk difference):"</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-248"><a href="#cb125-248" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under dapagliflozin:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p1_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-249"><a href="#cb125-249" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True risk under sulfonylurea: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(p0_true), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-250"><a href="#cb125-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-251"><a href="#cb125-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-252"><a href="#cb125-252" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspect the data</span></span>
<span id="cb125-253"><a href="#cb125-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-256"><a href="#cb125-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-257"><a href="#cb125-257" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb125-258"><a href="#cb125-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb125-259"><a href="#cb125-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb125-260"><a href="#cb125-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">n          =</span> <span class="fu">n</span>(),</span>
<span id="cb125-261"><a href="#cb125-261" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_age   =</span> <span class="fu">mean</span>(age),</span>
<span id="cb125-262"><a href="#cb125-262" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_bmi   =</span> <span class="fu">mean</span>(bmi),</span>
<span id="cb125-263"><a href="#cb125-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_hba1c =</span> <span class="fu">mean</span>(hba1c),</span>
<span id="cb125-264"><a href="#cb125-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_cvd    =</span> <span class="fu">mean</span>(cvd),</span>
<span id="cb125-265"><a href="#cb125-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_egfr  =</span> <span class="fu">mean</span>(egfr),</span>
<span id="cb125-266"><a href="#cb125-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_statin =</span> <span class="fu">mean</span>(statin),</span>
<span id="cb125-267"><a href="#cb125-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">mace_rate  =</span> <span class="fu">mean</span>(Y),</span>
<span id="cb125-268"><a href="#cb125-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb125-269"><a href="#cb125-269" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb125-270"><a href="#cb125-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-271"><a href="#cb125-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-272"><a href="#cb125-272" aria-hidden="true" tabindex="-1"></a>Notice the imbalances: dapagliflozin patients are younger, have higher eGFR, and less prior CVD. These differences will bias a naive comparison.</span>
<span id="cb125-273"><a href="#cb125-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-274"><a href="#cb125-274" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-275"><a href="#cb125-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-276"><a href="#cb125-276" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Progressive Estimation</span></span>
<span id="cb125-277"><a href="#cb125-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-278"><a href="#cb125-278" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb125-279"><a href="#cb125-279" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4A. Naive (Unadjusted) Model — What Happens Without Adjustment?</span></span>
<span id="cb125-280"><a href="#cb125-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-281"><a href="#cb125-281" aria-hidden="true" tabindex="-1"></a>We start with what many analysts would try first: a simple comparison of MACE rates by treatment group. This establishes the baseline from which all other methods improve.</span>
<span id="cb125-282"><a href="#cb125-282" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-283"><a href="#cb125-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-286"><a href="#cb125-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-287"><a href="#cb125-287" aria-hidden="true" tabindex="-1"></a><span class="co"># Unadjusted risk difference</span></span>
<span id="cb125-288"><a href="#cb125-288" aria-hidden="true" tabindex="-1"></a>risk_A1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb125-289"><a href="#cb125-289" aria-hidden="true" tabindex="-1"></a>risk_A0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>Y[dat<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb125-290"><a href="#cb125-290" aria-hidden="true" tabindex="-1"></a>naive_rd <span class="ot">&lt;-</span> risk_A1 <span class="sc">-</span> risk_A0</span>
<span id="cb125-291"><a href="#cb125-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-292"><a href="#cb125-292" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk (dapagliflozin):"</span>, <span class="fu">round</span>(risk_A1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-293"><a href="#cb125-293" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk (sulfonylurea): "</span>, <span class="fu">round</span>(risk_A0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-294"><a href="#cb125-294" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Naive risk difference:     "</span>, <span class="fu">round</span>(naive_rd, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-295"><a href="#cb125-295" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                  "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-296"><a href="#cb125-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-297"><a href="#cb125-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-300"><a href="#cb125-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-301"><a href="#cb125-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Unadjusted logistic regression</span></span>
<span id="cb125-302"><a href="#cb125-302" aria-hidden="true" tabindex="-1"></a>naive_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb125-303"><a href="#cb125-303" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(naive_mod)</span>
<span id="cb125-304"><a href="#cb125-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-305"><a href="#cb125-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-306"><a href="#cb125-306" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb125-307"><a href="#cb125-307" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Went Wrong?</span></span>
<span id="cb125-308"><a href="#cb125-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-309"><a href="#cb125-309" aria-hidden="true" tabindex="-1"></a>The naive estimate is biased because dapagliflozin patients differ systematically from sulfonylurea patients. The treatment groups are not exchangeable. The naive estimate conflates the drug effect with the confounding by indication.</span>
<span id="cb125-310"><a href="#cb125-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-311"><a href="#cb125-311" aria-hidden="true" tabindex="-1"></a>**The lesson:** Never interpret unadjusted treatment comparisons as causal effects in observational data. The difference in MACE rates reflects both the drug's effect AND the differences in who gets each drug.</span>
<span id="cb125-312"><a href="#cb125-312" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-313"><a href="#cb125-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-314"><a href="#cb125-314" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-315"><a href="#cb125-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-316"><a href="#cb125-316" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4B. G-Computation (Outcome Modeling)</span></span>
<span id="cb125-317"><a href="#cb125-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-318"><a href="#cb125-318" aria-hidden="true" tabindex="-1"></a>G-computation directly implements the identification formula by modeling $E<span class="co">[</span><span class="ot">Y \mid A, W</span><span class="co">]</span>$, then standardizing.</span>
<span id="cb125-319"><a href="#cb125-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-320"><a href="#cb125-320" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-321"><a href="#cb125-321" aria-hidden="true" tabindex="-1"></a><span class="fu">## G-Computation Step 1: Fit the Outcome Model</span></span>
<span id="cb125-322"><a href="#cb125-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-323"><a href="#cb125-323" aria-hidden="true" tabindex="-1"></a>Fit a model for $E<span class="co">[</span><span class="ot">Y \mid A, W</span><span class="co">]</span>$ — the expected outcome given treatment and confounders. This model will be used to predict what would happen to each patient under each treatment scenario.</span>
<span id="cb125-324"><a href="#cb125-324" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-325"><a href="#cb125-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-328"><a href="#cb125-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-329"><a href="#cb125-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Parametric outcome model (logistic regression)</span></span>
<span id="cb125-330"><a href="#cb125-330" aria-hidden="true" tabindex="-1"></a><span class="co"># We include main effects and key interactions</span></span>
<span id="cb125-331"><a href="#cb125-331" aria-hidden="true" tabindex="-1"></a>q_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb125-332"><a href="#cb125-332" aria-hidden="true" tabindex="-1"></a>               A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb125-333"><a href="#cb125-333" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb125-334"><a href="#cb125-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-335"><a href="#cb125-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-336"><a href="#cb125-336" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-337"><a href="#cb125-337" aria-hidden="true" tabindex="-1"></a><span class="fu">## G-Computation Step 2: Predict Counterfactual Outcomes</span></span>
<span id="cb125-338"><a href="#cb125-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-339"><a href="#cb125-339" aria-hidden="true" tabindex="-1"></a>Ask: "What would this patient's outcome be if they received dapagliflozin? And if they received sulfonylurea?" We generate these predictions for *every* patient, regardless of what they actually received.</span>
<span id="cb125-340"><a href="#cb125-340" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-341"><a href="#cb125-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-344"><a href="#cb125-344" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-345"><a href="#cb125-345" aria-hidden="true" tabindex="-1"></a><span class="co"># Create counterfactual datasets</span></span>
<span id="cb125-346"><a href="#cb125-346" aria-hidden="true" tabindex="-1"></a>dat1 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>)</span>
<span id="cb125-347"><a href="#cb125-347" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>)</span>
<span id="cb125-348"><a href="#cb125-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-349"><a href="#cb125-349" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict potential outcomes for each individual</span></span>
<span id="cb125-350"><a href="#cb125-350" aria-hidden="true" tabindex="-1"></a>Q1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb125-351"><a href="#cb125-351" aria-hidden="true" tabindex="-1"></a>Q0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_mod, <span class="at">newdata =</span> dat0, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb125-352"><a href="#cb125-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-353"><a href="#cb125-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-354"><a href="#cb125-354" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb125-355"><a href="#cb125-355" aria-hidden="true" tabindex="-1"></a><span class="fu">## G-Computation Step 3: Standardize (Average Over the Population)</span></span>
<span id="cb125-356"><a href="#cb125-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-357"><a href="#cb125-357" aria-hidden="true" tabindex="-1"></a>Average the predicted outcomes across all patients. This implements the G-computation formula: $E_W<span class="co">[</span><span class="ot">E[Y \mid A=a, W]</span><span class="co">]</span>$.</span>
<span id="cb125-358"><a href="#cb125-358" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-359"><a href="#cb125-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-362"><a href="#cb125-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-363"><a href="#cb125-363" aria-hidden="true" tabindex="-1"></a>gcomp_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1)</span>
<span id="cb125-364"><a href="#cb125-364" aria-hidden="true" tabindex="-1"></a>gcomp_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0)</span>
<span id="cb125-365"><a href="#cb125-365" aria-hidden="true" tabindex="-1"></a>gcomp_ate   <span class="ot">&lt;-</span> gcomp_risk1 <span class="sc">-</span> gcomp_risk0</span>
<span id="cb125-366"><a href="#cb125-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-367"><a href="#cb125-367" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp risk (dapagliflozin):"</span>, <span class="fu">round</span>(gcomp_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-368"><a href="#cb125-368" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp risk (sulfonylurea): "</span>, <span class="fu">round</span>(gcomp_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-369"><a href="#cb125-369" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp ATE:                 "</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-370"><a href="#cb125-370" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                   "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-371"><a href="#cb125-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-372"><a href="#cb125-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-373"><a href="#cb125-373" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bootstrap confidence interval for G-computation</span></span>
<span id="cb125-374"><a href="#cb125-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-377"><a href="#cb125-377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-378"><a href="#cb125-378" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb125-379"><a href="#cb125-379" aria-hidden="true" tabindex="-1"></a>n_boot <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb125-380"><a href="#cb125-380" aria-hidden="true" tabindex="-1"></a>boot_ate <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_boot)</span>
<span id="cb125-381"><a href="#cb125-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-382"><a href="#cb125-382" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_boot) {</span>
<span id="cb125-383"><a href="#cb125-383" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb125-384"><a href="#cb125-384" aria-hidden="true" tabindex="-1"></a>  dat_b <span class="ot">&lt;-</span> dat[idx, ]</span>
<span id="cb125-385"><a href="#cb125-385" aria-hidden="true" tabindex="-1"></a>  mod_b <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb125-386"><a href="#cb125-386" aria-hidden="true" tabindex="-1"></a>                  A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb125-387"><a href="#cb125-387" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> binomial, <span class="at">data =</span> dat_b)</span>
<span id="cb125-388"><a href="#cb125-388" aria-hidden="true" tabindex="-1"></a>  Q1_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_b, <span class="at">newdata =</span> dat_b <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb125-389"><a href="#cb125-389" aria-hidden="true" tabindex="-1"></a>  Q0_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod_b, <span class="at">newdata =</span> dat_b <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb125-390"><a href="#cb125-390" aria-hidden="true" tabindex="-1"></a>  boot_ate[b] <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_b <span class="sc">-</span> Q0_b)</span>
<span id="cb125-391"><a href="#cb125-391" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb125-392"><a href="#cb125-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-393"><a href="#cb125-393" aria-hidden="true" tabindex="-1"></a>gcomp_se <span class="ot">&lt;-</span> <span class="fu">sd</span>(boot_ate)</span>
<span id="cb125-394"><a href="#cb125-394" aria-hidden="true" tabindex="-1"></a>gcomp_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_ate, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb125-395"><a href="#cb125-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-396"><a href="#cb125-396" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"G-comp ATE:"</span>, <span class="fu">round</span>(gcomp_ate, <span class="dv">4</span>),</span>
<span id="cb125-397"><a href="#cb125-397" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(gcomp_se, <span class="dv">4</span>),</span>
<span id="cb125-398"><a href="#cb125-398" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(gcomp_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(gcomp_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-399"><a href="#cb125-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-400"><a href="#cb125-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-401"><a href="#cb125-401" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb125-402"><a href="#cb125-402" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Just Happened?</span></span>
<span id="cb125-403"><a href="#cb125-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-404"><a href="#cb125-404" aria-hidden="true" tabindex="-1"></a>G-computation gave a much better estimate than the naive approach by adjusting for confounders. It works by predicting what would happen to each patient under each treatment, then averaging.</span>
<span id="cb125-405"><a href="#cb125-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-406"><a href="#cb125-406" aria-hidden="true" tabindex="-1"></a>**But there is a catch:** G-computation depends entirely on the outcome model being correct. If we misspecified the functional form (missed interactions, nonlinearities), the estimate would be biased. And we would have no way to know.</span>
<span id="cb125-407"><a href="#cb125-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-408"><a href="#cb125-408" aria-hidden="true" tabindex="-1"></a>**This motivates IPTW** — which adjusts for confounding using the *treatment* model instead.</span>
<span id="cb125-409"><a href="#cb125-409" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-410"><a href="#cb125-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-411"><a href="#cb125-411" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-412"><a href="#cb125-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-413"><a href="#cb125-413" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4C. IPTW (Treatment Modeling)</span></span>
<span id="cb125-414"><a href="#cb125-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-415"><a href="#cb125-415" aria-hidden="true" tabindex="-1"></a>IPTW takes a different approach: instead of modeling the outcome, it models treatment assignment and reweights the data to create a pseudo-population where confounders are balanced.</span>
<span id="cb125-416"><a href="#cb125-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-417"><a href="#cb125-417" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-418"><a href="#cb125-418" aria-hidden="true" tabindex="-1"></a><span class="fu">## IPTW Step 1: Estimate the Propensity Score</span></span>
<span id="cb125-419"><a href="#cb125-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-420"><a href="#cb125-420" aria-hidden="true" tabindex="-1"></a>The propensity score $g(W) = P(A = 1 \mid W)$ answers: given a patient's covariates, how likely were they to receive dapagliflozin? We use this to reweight the data so that treatment looks "as-if-randomized."</span>
<span id="cb125-421"><a href="#cb125-421" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-422"><a href="#cb125-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-425"><a href="#cb125-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-426"><a href="#cb125-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Propensity score model</span></span>
<span id="cb125-427"><a href="#cb125-427" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb125-428"><a href="#cb125-428" aria-hidden="true" tabindex="-1"></a>               <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> age<span class="sc">:</span>cvd,</span>
<span id="cb125-429"><a href="#cb125-429" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb125-430"><a href="#cb125-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-431"><a href="#cb125-431" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb125-432"><a href="#cb125-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ps =</span> <span class="fu">predict</span>(g_mod, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb125-433"><a href="#cb125-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-434"><a href="#cb125-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of propensity scores</span></span>
<span id="cb125-435"><a href="#cb125-435" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>ps)</span>
<span id="cb125-436"><a href="#cb125-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-437"><a href="#cb125-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-438"><a href="#cb125-438" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 2: Assess propensity score overlap</span></span>
<span id="cb125-439"><a href="#cb125-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-442"><a href="#cb125-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-443"><a href="#cb125-443" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb125-444"><a href="#cb125-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb125-445"><a href="#cb125-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-446"><a href="#cb125-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated propensity score P(A=1 | W)"</span>,</span>
<span id="cb125-447"><a href="#cb125-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb125-448"><a href="#cb125-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb125-449"><a href="#cb125-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Overlap"</span></span>
<span id="cb125-450"><a href="#cb125-450" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb125-451"><a href="#cb125-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb125-452"><a href="#cb125-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb125-453"><a href="#cb125-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-454"><a href="#cb125-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-455"><a href="#cb125-455" aria-hidden="true" tabindex="-1"></a>Good overlap means every type of patient has some chance of getting either drug. If the distributions barely overlap, IPTW will produce extreme weights and unstable estimates.</span>
<span id="cb125-456"><a href="#cb125-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-457"><a href="#cb125-457" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 3: Construct stabilized weights</span></span>
<span id="cb125-458"><a href="#cb125-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-461"><a href="#cb125-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-462"><a href="#cb125-462" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal treatment probability</span></span>
<span id="cb125-463"><a href="#cb125-463" aria-hidden="true" tabindex="-1"></a>p_A <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>A)</span>
<span id="cb125-464"><a href="#cb125-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-465"><a href="#cb125-465" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb125-466"><a href="#cb125-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb125-467"><a href="#cb125-467" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unstabilized weights</span></span>
<span id="cb125-468"><a href="#cb125-468" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_unstab =</span> <span class="fu">ifelse</span>(A <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> ps, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)),</span>
<span id="cb125-469"><a href="#cb125-469" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stabilized weights</span></span>
<span id="cb125-470"><a href="#cb125-470" aria-hidden="true" tabindex="-1"></a>    <span class="at">sw =</span> <span class="fu">ifelse</span>(A <span class="sc">==</span> <span class="dv">1</span>, p_A <span class="sc">/</span> ps, (<span class="dv">1</span> <span class="sc">-</span> p_A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb125-471"><a href="#cb125-471" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb125-472"><a href="#cb125-472" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-473"><a href="#cb125-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-474"><a href="#cb125-474" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 4: Diagnose weights</span></span>
<span id="cb125-475"><a href="#cb125-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-478"><a href="#cb125-478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-479"><a href="#cb125-479" aria-hidden="true" tabindex="-1"></a><span class="co"># Weight diagnostics</span></span>
<span id="cb125-480"><a href="#cb125-480" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb125-481"><a href="#cb125-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span></span>
<span id="cb125-482"><a href="#cb125-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb125-483"><a href="#cb125-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_w  =</span> <span class="fu">min</span>(sw),</span>
<span id="cb125-484"><a href="#cb125-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">p01_w  =</span> <span class="fu">quantile</span>(sw, <span class="fl">0.01</span>),</span>
<span id="cb125-485"><a href="#cb125-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(sw),</span>
<span id="cb125-486"><a href="#cb125-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">p99_w  =</span> <span class="fu">quantile</span>(sw, <span class="fl">0.99</span>),</span>
<span id="cb125-487"><a href="#cb125-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_w  =</span> <span class="fu">max</span>(sw),</span>
<span id="cb125-488"><a href="#cb125-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_w =</span> <span class="fu">mean</span>(sw),</span>
<span id="cb125-489"><a href="#cb125-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_w   =</span> <span class="fu">sd</span>(sw),</span>
<span id="cb125-490"><a href="#cb125-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb125-491"><a href="#cb125-491" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb125-492"><a href="#cb125-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-493"><a href="#cb125-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-496"><a href="#cb125-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-497"><a href="#cb125-497" aria-hidden="true" tabindex="-1"></a><span class="co"># Weight distribution plot</span></span>
<span id="cb125-498"><a href="#cb125-498" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> sw, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb125-499"><a href="#cb125-499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb125-500"><a href="#cb125-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-501"><a href="#cb125-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stabilized IPTW weight"</span>,</span>
<span id="cb125-502"><a href="#cb125-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb125-503"><a href="#cb125-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb125-504"><a href="#cb125-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of Stabilized IPTW Weights"</span></span>
<span id="cb125-505"><a href="#cb125-505" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb125-506"><a href="#cb125-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb125-507"><a href="#cb125-507" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>)) <span class="sc">+</span></span>
<span id="cb125-508"><a href="#cb125-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>)</span>
<span id="cb125-509"><a href="#cb125-509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-510"><a href="#cb125-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-511"><a href="#cb125-511" aria-hidden="true" tabindex="-1"></a>**What to look for:**</span>
<span id="cb125-512"><a href="#cb125-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-513"><a href="#cb125-513" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Weights should be centered around 1 (for stabilized weights)</span>
<span id="cb125-514"><a href="#cb125-514" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Very large weights (&gt; 10) indicate positivity problems</span>
<span id="cb125-515"><a href="#cb125-515" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The mean of stabilized weights should be approximately 1</span>
<span id="cb125-516"><a href="#cb125-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-517"><a href="#cb125-517" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 5: Check covariate balance after weighting</span></span>
<span id="cb125-518"><a href="#cb125-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-521"><a href="#cb125-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-522"><a href="#cb125-522" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardized mean differences: unweighted vs weighted</span></span>
<span id="cb125-523"><a href="#cb125-523" aria-hidden="true" tabindex="-1"></a>compute_smd <span class="ot">&lt;-</span> <span class="cf">function</span>(data, var, trt, <span class="at">weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb125-524"><a href="#cb125-524" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(weights)) weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb125-525"><a href="#cb125-525" aria-hidden="true" tabindex="-1"></a>  d1 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb125-526"><a href="#cb125-526" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">&lt;-</span> data[[var]][data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb125-527"><a href="#cb125-527" aria-hidden="true" tabindex="-1"></a>  w1 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb125-528"><a href="#cb125-528" aria-hidden="true" tabindex="-1"></a>  w0 <span class="ot">&lt;-</span> weights[data[[trt]] <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb125-529"><a href="#cb125-529" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d1, w1)</span>
<span id="cb125-530"><a href="#cb125-530" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(d0, w0)</span>
<span id="cb125-531"><a href="#cb125-531" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w1 <span class="sc">*</span> (d1 <span class="sc">-</span> m1)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w1))</span>
<span id="cb125-532"><a href="#cb125-532" aria-hidden="true" tabindex="-1"></a>  s0 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(w0 <span class="sc">*</span> (d0 <span class="sc">-</span> m0)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>(w0))</span>
<span id="cb125-533"><a href="#cb125-533" aria-hidden="true" tabindex="-1"></a>  pooled_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((s1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> s0<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb125-534"><a href="#cb125-534" aria-hidden="true" tabindex="-1"></a>  (m1 <span class="sc">-</span> m0) <span class="sc">/</span> pooled_sd</span>
<span id="cb125-535"><a href="#cb125-535" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb125-536"><a href="#cb125-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-537"><a href="#cb125-537" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"bmi"</span>, <span class="st">"hba1c"</span>, <span class="st">"cvd"</span>, <span class="st">"egfr"</span>, <span class="st">"statin"</span>)</span>
<span id="cb125-538"><a href="#cb125-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-539"><a href="#cb125-539" aria-hidden="true" tabindex="-1"></a>smd_raw <span class="ot">&lt;-</span> <span class="fu">sapply</span>(covariates, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>))</span>
<span id="cb125-540"><a href="#cb125-540" aria-hidden="true" tabindex="-1"></a>smd_wt  <span class="ot">&lt;-</span> <span class="fu">sapply</span>(covariates, <span class="cf">function</span>(v) <span class="fu">compute_smd</span>(dat, v, <span class="st">"A"</span>, dat<span class="sc">$</span>sw))</span>
<span id="cb125-541"><a href="#cb125-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-542"><a href="#cb125-542" aria-hidden="true" tabindex="-1"></a>smd_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb125-543"><a href="#cb125-543" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> covariates,</span>
<span id="cb125-544"><a href="#cb125-544" aria-hidden="true" tabindex="-1"></a>  <span class="at">Unadjusted =</span> <span class="fu">abs</span>(smd_raw),</span>
<span id="cb125-545"><a href="#cb125-545" aria-hidden="true" tabindex="-1"></a>  <span class="at">Weighted   =</span> <span class="fu">abs</span>(smd_wt)</span>
<span id="cb125-546"><a href="#cb125-546" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb125-547"><a href="#cb125-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>variable, <span class="at">names_to =</span> <span class="st">"Method"</span>, <span class="at">values_to =</span> <span class="st">"SMD"</span>)</span>
<span id="cb125-548"><a href="#cb125-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-549"><a href="#cb125-549" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(smd_df, <span class="fu">aes</span>(<span class="at">x =</span> SMD, <span class="at">y =</span> <span class="fu">reorder</span>(variable, SMD), <span class="at">color =</span> Method, <span class="at">shape =</span> Method)) <span class="sc">+</span></span>
<span id="cb125-550"><a href="#cb125-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb125-551"><a href="#cb125-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb125-552"><a href="#cb125-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-553"><a href="#cb125-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Absolute Standardized Mean Difference"</span>,</span>
<span id="cb125-554"><a href="#cb125-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb125-555"><a href="#cb125-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Covariate Balance: Before and After IPTW"</span></span>
<span id="cb125-556"><a href="#cb125-556" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb125-557"><a href="#cb125-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb125-558"><a href="#cb125-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#EE6677"</span>, <span class="st">"#228833"</span>))</span>
<span id="cb125-559"><a href="#cb125-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-560"><a href="#cb125-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-561"><a href="#cb125-561" aria-hidden="true" tabindex="-1"></a>The dashed line at 0.1 is a common threshold. After weighting, all covariates should be below this line.</span>
<span id="cb125-562"><a href="#cb125-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-563"><a href="#cb125-563" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 6: Estimate the ATE</span></span>
<span id="cb125-564"><a href="#cb125-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-567"><a href="#cb125-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-568"><a href="#cb125-568" aria-hidden="true" tabindex="-1"></a><span class="co"># Hajek (ratio) estimator with stabilized weights</span></span>
<span id="cb125-569"><a href="#cb125-569" aria-hidden="true" tabindex="-1"></a>risk1_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb125-570"><a href="#cb125-570" aria-hidden="true" tabindex="-1"></a>risk0_iptw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb125-571"><a href="#cb125-571" aria-hidden="true" tabindex="-1"></a>iptw_ate   <span class="ot">&lt;-</span> risk1_iptw <span class="sc">-</span> risk0_iptw</span>
<span id="cb125-572"><a href="#cb125-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-573"><a href="#cb125-573" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW risk (dapagliflozin):"</span>, <span class="fu">round</span>(risk1_iptw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-574"><a href="#cb125-574" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW risk (sulfonylurea): "</span>, <span class="fu">round</span>(risk0_iptw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-575"><a href="#cb125-575" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE:                 "</span>, <span class="fu">round</span>(iptw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-576"><a href="#cb125-576" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-577"><a href="#cb125-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-578"><a href="#cb125-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-579"><a href="#cb125-579" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weight truncation</span></span>
<span id="cb125-580"><a href="#cb125-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-581"><a href="#cb125-581" aria-hidden="true" tabindex="-1"></a>If weights are extreme, truncation can improve stability at the cost of a small amount of bias:</span>
<span id="cb125-582"><a href="#cb125-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-585"><a href="#cb125-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-586"><a href="#cb125-586" aria-hidden="true" tabindex="-1"></a><span class="co"># Truncate at 1st and 99th percentiles</span></span>
<span id="cb125-587"><a href="#cb125-587" aria-hidden="true" tabindex="-1"></a>trunc_lower <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw, <span class="fl">0.01</span>)</span>
<span id="cb125-588"><a href="#cb125-588" aria-hidden="true" tabindex="-1"></a>trunc_upper <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw, <span class="fl">0.99</span>)</span>
<span id="cb125-589"><a href="#cb125-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-590"><a href="#cb125-590" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb125-591"><a href="#cb125-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sw_trunc =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(sw, trunc_lower), trunc_upper))</span>
<span id="cb125-592"><a href="#cb125-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-593"><a href="#cb125-593" aria-hidden="true" tabindex="-1"></a>risk1_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb125-594"><a href="#cb125-594" aria-hidden="true" tabindex="-1"></a>risk0_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb125-595"><a href="#cb125-595" aria-hidden="true" tabindex="-1"></a>iptw_ate_trunc <span class="ot">&lt;-</span> risk1_trunc <span class="sc">-</span> risk0_trunc</span>
<span id="cb125-596"><a href="#cb125-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-597"><a href="#cb125-597" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IPTW ATE (truncated weights):"</span>, <span class="fu">round</span>(iptw_ate_trunc, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-598"><a href="#cb125-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-599"><a href="#cb125-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-600"><a href="#cb125-600" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb125-601"><a href="#cb125-601" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Just Happened?</span></span>
<span id="cb125-602"><a href="#cb125-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-603"><a href="#cb125-603" aria-hidden="true" tabindex="-1"></a>IPTW adjusts for confounding through the treatment model alone. It does not use information about the outcome-confounder relationship.</span>
<span id="cb125-604"><a href="#cb125-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-605"><a href="#cb125-605" aria-hidden="true" tabindex="-1"></a>**The weakness:** If the propensity score model is wrong, IPTW is biased. If positivity is limited, weights become extreme and the estimate becomes unstable. And unlike G-computation, IPTW does not use the outcome model at all.</span>
<span id="cb125-606"><a href="#cb125-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-607"><a href="#cb125-607" aria-hidden="true" tabindex="-1"></a>**This motivates doubly robust methods** — which use BOTH the outcome model and the treatment model, so that if either one is correct, the estimate is consistent.</span>
<span id="cb125-608"><a href="#cb125-608" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-609"><a href="#cb125-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-610"><a href="#cb125-610" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-611"><a href="#cb125-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-612"><a href="#cb125-612" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4D. AIPW (Augmented Inverse Probability Weighting)</span></span>
<span id="cb125-613"><a href="#cb125-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-614"><a href="#cb125-614" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-615"><a href="#cb125-615" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Doubly Robust Idea</span></span>
<span id="cb125-616"><a href="#cb125-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-617"><a href="#cb125-617" aria-hidden="true" tabindex="-1"></a>What if we could use BOTH the outcome model and the treatment model, and as long as EITHER one is correct, get a consistent estimate? This is exactly what AIPW (and TMLE) provide.</span>
<span id="cb125-618"><a href="#cb125-618" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-619"><a href="#cb125-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-620"><a href="#cb125-620" aria-hidden="true" tabindex="-1"></a>AIPW combines the outcome model and the treatment model. It is **doubly robust**: consistent if either model is correct.</span>
<span id="cb125-621"><a href="#cb125-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-624"><a href="#cb125-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-625"><a href="#cb125-625" aria-hidden="true" tabindex="-1"></a><span class="co"># Using models from previous steps:</span></span>
<span id="cb125-626"><a href="#cb125-626" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1, Q0 = predicted outcomes from g-computation</span></span>
<span id="cb125-627"><a href="#cb125-627" aria-hidden="true" tabindex="-1"></a><span class="co"># ps     = propensity scores from IPTW</span></span>
<span id="cb125-628"><a href="#cb125-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-629"><a href="#cb125-629" aria-hidden="true" tabindex="-1"></a><span class="co"># AIPW components</span></span>
<span id="cb125-630"><a href="#cb125-630" aria-hidden="true" tabindex="-1"></a>mu1_aipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">mean</span>(</span>
<span id="cb125-631"><a href="#cb125-631" aria-hidden="true" tabindex="-1"></a>  Q1 <span class="sc">+</span> A <span class="sc">*</span> (Y <span class="sc">-</span> Q1) <span class="sc">/</span> ps</span>
<span id="cb125-632"><a href="#cb125-632" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb125-633"><a href="#cb125-633" aria-hidden="true" tabindex="-1"></a>mu0_aipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">mean</span>(</span>
<span id="cb125-634"><a href="#cb125-634" aria-hidden="true" tabindex="-1"></a>  Q0 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">*</span> (Y <span class="sc">-</span> Q0) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)</span>
<span id="cb125-635"><a href="#cb125-635" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb125-636"><a href="#cb125-636" aria-hidden="true" tabindex="-1"></a>aipw_ate <span class="ot">&lt;-</span> mu1_aipw <span class="sc">-</span> mu0_aipw</span>
<span id="cb125-637"><a href="#cb125-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-638"><a href="#cb125-638" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW risk (dapagliflozin):"</span>, <span class="fu">round</span>(mu1_aipw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-639"><a href="#cb125-639" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW risk (sulfonylurea): "</span>, <span class="fu">round</span>(mu0_aipw, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-640"><a href="#cb125-640" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW ATE:                 "</span>, <span class="fu">round</span>(aipw_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-641"><a href="#cb125-641" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-642"><a href="#cb125-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-643"><a href="#cb125-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-644"><a href="#cb125-644" aria-hidden="true" tabindex="-1"></a><span class="fu">### Influence curve and inference</span></span>
<span id="cb125-645"><a href="#cb125-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-646"><a href="#cb125-646" aria-hidden="true" tabindex="-1"></a>The efficient influence curve (EIC) for the ATE gives us individual-level "scores" that measure each observation's contribution to the estimate. The variance of these scores provides valid standard errors.</span>
<span id="cb125-647"><a href="#cb125-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-650"><a href="#cb125-650" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-651"><a href="#cb125-651" aria-hidden="true" tabindex="-1"></a><span class="co"># Efficient influence curve for ATE</span></span>
<span id="cb125-652"><a href="#cb125-652" aria-hidden="true" tabindex="-1"></a>eic <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,</span>
<span id="cb125-653"><a href="#cb125-653" aria-hidden="true" tabindex="-1"></a>  (A <span class="sc">/</span> ps) <span class="sc">*</span> (Y <span class="sc">-</span> Q1) <span class="sc">+</span> Q1 <span class="sc">-</span> mu1_aipw <span class="sc">-</span></span>
<span id="cb125-654"><a href="#cb125-654" aria-hidden="true" tabindex="-1"></a>  ((<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)) <span class="sc">*</span> (Y <span class="sc">-</span> Q0) <span class="sc">-</span> Q0 <span class="sc">+</span> mu0_aipw</span>
<span id="cb125-655"><a href="#cb125-655" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-656"><a href="#cb125-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-657"><a href="#cb125-657" aria-hidden="true" tabindex="-1"></a>aipw_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic) <span class="sc">/</span> n)</span>
<span id="cb125-658"><a href="#cb125-658" aria-hidden="true" tabindex="-1"></a>aipw_ci <span class="ot">&lt;-</span> aipw_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> aipw_se</span>
<span id="cb125-659"><a href="#cb125-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-660"><a href="#cb125-660" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIPW ATE:"</span>, <span class="fu">round</span>(aipw_ate, <span class="dv">4</span>),</span>
<span id="cb125-661"><a href="#cb125-661" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(aipw_se, <span class="dv">4</span>),</span>
<span id="cb125-662"><a href="#cb125-662" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(aipw_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(aipw_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-663"><a href="#cb125-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-664"><a href="#cb125-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-665"><a href="#cb125-665" aria-hidden="true" tabindex="-1"></a>**Key insight:** AIPW improves on both g-computation and IPTW by using both models. However, AIPW does not "target" its initial estimates — it can produce predicted probabilities outside <span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>, and it does not solve the efficient influence curve equation exactly when machine learning is used. TMLE addresses both issues.</span>
<span id="cb125-666"><a href="#cb125-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-667"><a href="#cb125-667" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-668"><a href="#cb125-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-669"><a href="#cb125-669" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4E. TMLE (Targeted Maximum Likelihood Estimation)</span></span>
<span id="cb125-670"><a href="#cb125-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-671"><a href="#cb125-671" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb125-672"><a href="#cb125-672" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why TMLE?</span></span>
<span id="cb125-673"><a href="#cb125-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-674"><a href="#cb125-674" aria-hidden="true" tabindex="-1"></a>TMLE is the centerpiece of this chapter. It combines the best properties of all previous methods:</span>
<span id="cb125-675"><a href="#cb125-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-676"><a href="#cb125-676" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Uses both outcome and treatment models (**doubly robust**)</span>
<span id="cb125-677"><a href="#cb125-677" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Targets** the specific estimand of interest (not just fitting a good outcome model)</span>
<span id="cb125-678"><a href="#cb125-678" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Respects natural parameter bounds (probabilities stay in <span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>)</span>
<span id="cb125-679"><a href="#cb125-679" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Solves the efficient influence curve equation, ensuring **valid inference**</span>
<span id="cb125-680"><a href="#cb125-680" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Integrates naturally with machine learning (Super Learner)</span>
<span id="cb125-681"><a href="#cb125-681" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-682"><a href="#cb125-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-683"><a href="#cb125-683" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conceptual overview</span></span>
<span id="cb125-684"><a href="#cb125-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-685"><a href="#cb125-685" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-686"><a href="#cb125-686" aria-hidden="true" tabindex="-1"></a><span class="fu">## TMLE in Three Stages</span></span>
<span id="cb125-687"><a href="#cb125-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-688"><a href="#cb125-688" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Initial estimate:** Fit an outcome model $\hat{Q}^0(A, W) = \hat{E}<span class="co">[</span><span class="ot">Y \mid A, W</span><span class="co">]</span>$ (like g-computation)</span>
<span id="cb125-689"><a href="#cb125-689" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Targeting step:** Update $\hat{Q}^0$ using information from the propensity score to reduce bias for the specific estimand</span>
<span id="cb125-690"><a href="#cb125-690" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Substitution estimate:** Plug the updated $\hat{Q}^*$ into the G-computation formula</span>
<span id="cb125-691"><a href="#cb125-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-692"><a href="#cb125-692" aria-hidden="true" tabindex="-1"></a>The targeting step is what makes TMLE special. It uses the **clever covariate** — a function of the propensity score — to fluctuate the initial outcome model in the direction that solves the efficient influence curve equation.</span>
<span id="cb125-693"><a href="#cb125-693" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-694"><a href="#cb125-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-695"><a href="#cb125-695" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step-by-step implementation</span></span>
<span id="cb125-696"><a href="#cb125-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-697"><a href="#cb125-697" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-698"><a href="#cb125-698" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 1: Initial Outcome Model</span></span>
<span id="cb125-699"><a href="#cb125-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-700"><a href="#cb125-700" aria-hidden="true" tabindex="-1"></a>This is the same as G-computation — fit $E<span class="co">[</span><span class="ot">Y \mid A, W</span><span class="co">]</span>$. Think of this as your "first draft" of the outcome model. It does not need to be perfect; the targeting step will correct it.</span>
<span id="cb125-701"><a href="#cb125-701" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-702"><a href="#cb125-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-705"><a href="#cb125-705" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-706"><a href="#cb125-706" aria-hidden="true" tabindex="-1"></a><span class="co"># Same as g-computation — fit E[Y | A, W]</span></span>
<span id="cb125-707"><a href="#cb125-707" aria-hidden="true" tabindex="-1"></a>q_init <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb125-708"><a href="#cb125-708" aria-hidden="true" tabindex="-1"></a>                A<span class="sc">:</span>cvd <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb125-709"><a href="#cb125-709" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb125-710"><a href="#cb125-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-711"><a href="#cb125-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial predictions</span></span>
<span id="cb125-712"><a href="#cb125-712" aria-hidden="true" tabindex="-1"></a>Q1_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb125-713"><a href="#cb125-713" aria-hidden="true" tabindex="-1"></a>Q0_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb125-714"><a href="#cb125-714" aria-hidden="true" tabindex="-1"></a>QA_init <span class="ot">&lt;-</span> <span class="fu">predict</span>(q_init, <span class="at">type =</span> <span class="st">"response"</span>)  <span class="co"># predictions at observed A</span></span>
<span id="cb125-715"><a href="#cb125-715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-716"><a href="#cb125-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-717"><a href="#cb125-717" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-718"><a href="#cb125-718" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 2: Estimate the Propensity Score</span></span>
<span id="cb125-719"><a href="#cb125-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-720"><a href="#cb125-720" aria-hidden="true" tabindex="-1"></a>Same as IPTW — model the probability of treatment given confounders. We bound the scores away from 0 and 1 to prevent numerical instability.</span>
<span id="cb125-721"><a href="#cb125-721" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-722"><a href="#cb125-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-725"><a href="#cb125-725" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-726"><a href="#cb125-726" aria-hidden="true" tabindex="-1"></a><span class="co"># Same model as IPTW</span></span>
<span id="cb125-727"><a href="#cb125-727" aria-hidden="true" tabindex="-1"></a>g_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> bmi <span class="sc">+</span> hba1c <span class="sc">+</span> cvd <span class="sc">+</span> egfr <span class="sc">+</span> statin <span class="sc">+</span></span>
<span id="cb125-728"><a href="#cb125-728" aria-hidden="true" tabindex="-1"></a>               <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> age<span class="sc">:</span>cvd,</span>
<span id="cb125-729"><a href="#cb125-729" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb125-730"><a href="#cb125-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-731"><a href="#cb125-731" aria-hidden="true" tabindex="-1"></a>ps_tmle <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_fit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb125-732"><a href="#cb125-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-733"><a href="#cb125-733" aria-hidden="true" tabindex="-1"></a><span class="co"># Bound propensity scores away from 0 and 1 for stability</span></span>
<span id="cb125-734"><a href="#cb125-734" aria-hidden="true" tabindex="-1"></a>ps_tmle <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fl">0.01</span>, <span class="fu">pmin</span>(<span class="fl">0.99</span>, ps_tmle))</span>
<span id="cb125-735"><a href="#cb125-735" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-736"><a href="#cb125-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-737"><a href="#cb125-737" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb125-738"><a href="#cb125-738" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 3: Compute the Clever Covariate</span></span>
<span id="cb125-739"><a href="#cb125-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-740"><a href="#cb125-740" aria-hidden="true" tabindex="-1"></a>The clever covariate $H(A, W)$ is the bridge between the treatment model and the outcome model. It tells the targeting step *which observations are most informative* about the causal effect.</span>
<span id="cb125-741"><a href="#cb125-741" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-742"><a href="#cb125-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-745"><a href="#cb125-745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-746"><a href="#cb125-746" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate for each observation at their OBSERVED treatment</span></span>
<span id="cb125-747"><a href="#cb125-747" aria-hidden="true" tabindex="-1"></a>H_A <span class="ot">&lt;-</span> dat<span class="sc">$</span>A <span class="sc">/</span> ps_tmle <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> dat<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)</span>
<span id="cb125-748"><a href="#cb125-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-749"><a href="#cb125-749" aria-hidden="true" tabindex="-1"></a><span class="co"># Clever covariate under A=1 and A=0 (for prediction)</span></span>
<span id="cb125-750"><a href="#cb125-750" aria-hidden="true" tabindex="-1"></a>H_1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ps_tmle</span>
<span id="cb125-751"><a href="#cb125-751" aria-hidden="true" tabindex="-1"></a>H_0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)</span>
<span id="cb125-752"><a href="#cb125-752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-753"><a href="#cb125-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-754"><a href="#cb125-754" aria-hidden="true" tabindex="-1"></a>The clever covariate is large when a patient's treatment was unlikely given their covariates — exactly the patients who are most informative about the causal effect.</span>
<span id="cb125-755"><a href="#cb125-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-756"><a href="#cb125-756" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb125-757"><a href="#cb125-757" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 4: Fluctuation (The Targeting Step)</span></span>
<span id="cb125-758"><a href="#cb125-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-759"><a href="#cb125-759" aria-hidden="true" tabindex="-1"></a>This is **the key step** that makes TMLE different from every other estimator. We fit a logistic regression of $Y$ on $H(A, W)$ with the initial $\hat{Q}^0$ as an offset. The coefficient $\epsilon$ tells us how much to "nudge" the initial estimate toward solving the efficient influence curve equation.</span>
<span id="cb125-760"><a href="#cb125-760" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-761"><a href="#cb125-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-764"><a href="#cb125-764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-765"><a href="#cb125-765" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb125-766"><a href="#cb125-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-767"><a href="#cb125-767" aria-hidden="true" tabindex="-1"></a><span class="co"># Fluctuation model: logit(Y) ~ offset(logit(Q_init)) + H</span></span>
<span id="cb125-768"><a href="#cb125-768" aria-hidden="true" tabindex="-1"></a>fluc <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">logit</span>(QA_init)) <span class="sc">+</span> H_A,</span>
<span id="cb125-769"><a href="#cb125-769" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb125-770"><a href="#cb125-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-771"><a href="#cb125-771" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(fluc)</span>
<span id="cb125-772"><a href="#cb125-772" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Epsilon (fluctuation parameter):"</span>, <span class="fu">round</span>(epsilon, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-773"><a href="#cb125-773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-774"><a href="#cb125-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-775"><a href="#cb125-775" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-776"><a href="#cb125-776" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting Epsilon</span></span>
<span id="cb125-777"><a href="#cb125-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-778"><a href="#cb125-778" aria-hidden="true" tabindex="-1"></a>A small $\epsilon$ means the initial model was already close to solving the EIC equation. A large $\epsilon$ means the targeting step made a substantial correction.</span>
<span id="cb125-779"><a href="#cb125-779" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-780"><a href="#cb125-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-781"><a href="#cb125-781" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-782"><a href="#cb125-782" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 5: Update Predictions</span></span>
<span id="cb125-783"><a href="#cb125-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-784"><a href="#cb125-784" aria-hidden="true" tabindex="-1"></a>Apply the fluctuation to get the **targeted** predictions. Because we use the inverse-logit function (<span class="in">`plogis`</span>), predictions are guaranteed to stay in <span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span> — the natural bounds for a probability.</span>
<span id="cb125-785"><a href="#cb125-785" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-786"><a href="#cb125-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-789"><a href="#cb125-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-790"><a href="#cb125-790" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the fluctuation to counterfactual predictions</span></span>
<span id="cb125-791"><a href="#cb125-791" aria-hidden="true" tabindex="-1"></a>Q1_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q1_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_1)</span>
<span id="cb125-792"><a href="#cb125-792" aria-hidden="true" tabindex="-1"></a>Q0_star <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">logit</span>(Q0_init) <span class="sc">+</span> epsilon <span class="sc">*</span> H_0)</span>
<span id="cb125-793"><a href="#cb125-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-794"><a href="#cb125-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-795"><a href="#cb125-795" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-796"><a href="#cb125-796" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 6: Compute the TMLE Estimate</span></span>
<span id="cb125-797"><a href="#cb125-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-798"><a href="#cb125-798" aria-hidden="true" tabindex="-1"></a>Average the targeted predictions across the population — just like the final step of G-computation, but now using the **updated** $\hat{Q}^*$ that has been targeted for our specific estimand.</span>
<span id="cb125-799"><a href="#cb125-799" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-800"><a href="#cb125-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-803"><a href="#cb125-803" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-804"><a href="#cb125-804" aria-hidden="true" tabindex="-1"></a>tmle_risk1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1_star)</span>
<span id="cb125-805"><a href="#cb125-805" aria-hidden="true" tabindex="-1"></a>tmle_risk0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q0_star)</span>
<span id="cb125-806"><a href="#cb125-806" aria-hidden="true" tabindex="-1"></a>tmle_ate   <span class="ot">&lt;-</span> tmle_risk1 <span class="sc">-</span> tmle_risk0</span>
<span id="cb125-807"><a href="#cb125-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-808"><a href="#cb125-808" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (dapagliflozin):"</span>, <span class="fu">round</span>(tmle_risk1, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-809"><a href="#cb125-809" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE risk (sulfonylurea): "</span>, <span class="fu">round</span>(tmle_risk0, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-810"><a href="#cb125-810" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:                 "</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-811"><a href="#cb125-811" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATE:                 "</span>, <span class="fu">round</span>(true_ate, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-812"><a href="#cb125-812" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-813"><a href="#cb125-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-814"><a href="#cb125-814" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb125-815"><a href="#cb125-815" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 7: Inference via the Efficient Influence Curve</span></span>
<span id="cb125-816"><a href="#cb125-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-817"><a href="#cb125-817" aria-hidden="true" tabindex="-1"></a>The EIC gives each observation a "score" measuring its contribution to the estimate. The variance of these scores provides asymptotically valid standard errors — no bootstrap needed.</span>
<span id="cb125-818"><a href="#cb125-818" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-819"><a href="#cb125-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-822"><a href="#cb125-822" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-823"><a href="#cb125-823" aria-hidden="true" tabindex="-1"></a><span class="co"># EIC evaluated at the TMLE estimates</span></span>
<span id="cb125-824"><a href="#cb125-824" aria-hidden="true" tabindex="-1"></a>eic_tmle <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,</span>
<span id="cb125-825"><a href="#cb125-825" aria-hidden="true" tabindex="-1"></a>  (A <span class="sc">/</span> ps_tmle) <span class="sc">*</span> (Y <span class="sc">-</span> Q1_star) <span class="sc">+</span> Q1_star <span class="sc">-</span> tmle_risk1 <span class="sc">-</span></span>
<span id="cb125-826"><a href="#cb125-826" aria-hidden="true" tabindex="-1"></a>  ((<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps_tmle)) <span class="sc">*</span> (Y <span class="sc">-</span> Q0_star) <span class="sc">-</span> Q0_star <span class="sc">+</span> tmle_risk0</span>
<span id="cb125-827"><a href="#cb125-827" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-828"><a href="#cb125-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-829"><a href="#cb125-829" aria-hidden="true" tabindex="-1"></a>tmle_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(eic_tmle) <span class="sc">/</span> n)</span>
<span id="cb125-830"><a href="#cb125-830" aria-hidden="true" tabindex="-1"></a>tmle_ci <span class="ot">&lt;-</span> tmle_ate <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> tmle_se</span>
<span id="cb125-831"><a href="#cb125-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-832"><a href="#cb125-832" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TMLE ATE:"</span>, <span class="fu">round</span>(tmle_ate, <span class="dv">4</span>),</span>
<span id="cb125-833"><a href="#cb125-833" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE:"</span>, <span class="fu">round</span>(tmle_se, <span class="dv">4</span>),</span>
<span id="cb125-834"><a href="#cb125-834" aria-hidden="true" tabindex="-1"></a>    <span class="st">" 95% CI: ["</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">","</span>, <span class="fu">round</span>(tmle_ci[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-835"><a href="#cb125-835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-836"><a href="#cb125-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-837"><a href="#cb125-837" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb125-838"><a href="#cb125-838" aria-hidden="true" tabindex="-1"></a><span class="fu">### Verify: Is the EIC Mean Zero?</span></span>
<span id="cb125-839"><a href="#cb125-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-840"><a href="#cb125-840" aria-hidden="true" tabindex="-1"></a>A correctly implemented TMLE solves the efficient influence curve equation, meaning the sample mean of the EIC should be approximately zero. This is how you know the targeting step worked correctly.</span>
<span id="cb125-841"><a href="#cb125-841" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-842"><a href="#cb125-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-845"><a href="#cb125-845" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-846"><a href="#cb125-846" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of EIC:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic_tmle), <span class="dv">8</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-847"><a href="#cb125-847" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(Should be very close to zero)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-848"><a href="#cb125-848" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-849"><a href="#cb125-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-850"><a href="#cb125-850" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-851"><a href="#cb125-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-852"><a href="#cb125-852" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-853"><a href="#cb125-853" aria-hidden="true" tabindex="-1"></a><span class="fu">## Putting It All Together</span></span>
<span id="cb125-854"><a href="#cb125-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-855"><a href="#cb125-855" aria-hidden="true" tabindex="-1"></a>We now have five estimators of the same causal quantity. Let's see how they compare. If our models are reasonable, the doubly robust methods (AIPW and TMLE) should be closest to the truth.</span>
<span id="cb125-856"><a href="#cb125-856" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-857"><a href="#cb125-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-858"><a href="#cb125-858" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. Comparing All Estimators</span></span>
<span id="cb125-859"><a href="#cb125-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-862"><a href="#cb125-862" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-863"><a href="#cb125-863" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb125-864"><a href="#cb125-864" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method  =</span> <span class="fu">c</span>(<span class="st">"Naive"</span>, <span class="st">"G-computation"</span>, <span class="st">"IPTW"</span>, <span class="st">"IPTW (truncated)"</span>, <span class="st">"AIPW"</span>, <span class="st">"TMLE"</span>),</span>
<span id="cb125-865"><a href="#cb125-865" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATE     =</span> <span class="fu">c</span>(naive_rd, gcomp_ate, iptw_ate, iptw_ate_trunc, aipw_ate, tmle_ate),</span>
<span id="cb125-866"><a href="#cb125-866" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE      =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_se, <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_se, tmle_se),</span>
<span id="cb125-867"><a href="#cb125-867" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_low  =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_ci[<span class="dv">1</span>], <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_ci[<span class="dv">1</span>], tmle_ci[<span class="dv">1</span>]),</span>
<span id="cb125-868"><a href="#cb125-868" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_high =</span> <span class="fu">c</span>(<span class="cn">NA</span>, gcomp_ci[<span class="dv">2</span>], <span class="cn">NA</span>, <span class="cn">NA</span>, aipw_ci[<span class="dv">2</span>], tmle_ci[<span class="dv">2</span>])</span>
<span id="cb125-869"><a href="#cb125-869" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-870"><a href="#cb125-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-871"><a href="#cb125-871" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb125-872"><a href="#cb125-872" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">4</span>)))</span>
<span id="cb125-873"><a href="#cb125-873" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-874"><a href="#cb125-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-877"><a href="#cb125-877" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-878"><a href="#cb125-878" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the comparison</span></span>
<span id="cb125-879"><a href="#cb125-879" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb125-880"><a href="#cb125-880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(SE)) <span class="sc">%&gt;%</span></span>
<span id="cb125-881"><a href="#cb125-881" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="fu">factor</span>(Method, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"G-computation"</span>, <span class="st">"AIPW"</span>, <span class="st">"TMLE"</span>)))</span>
<span id="cb125-882"><a href="#cb125-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-883"><a href="#cb125-883" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> ATE, <span class="at">y =</span> Method)) <span class="sc">+</span></span>
<span id="cb125-884"><a href="#cb125-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb125-885"><a href="#cb125-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> CI_low, <span class="at">xmax =</span> CI_high), <span class="at">height =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb125-886"><a href="#cb125-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_ate, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb125-887"><a href="#cb125-887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> true_ate, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">label =</span> <span class="st">"True ATE"</span>,</span>
<span id="cb125-888"><a href="#cb125-888" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb125-889"><a href="#cb125-889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-890"><a href="#cb125-890" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated ATE (Risk Difference)"</span>,</span>
<span id="cb125-891"><a href="#cb125-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb125-892"><a href="#cb125-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Causal Estimators"</span>,</span>
<span id="cb125-893"><a href="#cb125-893" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red dashed line = true causal effect"</span></span>
<span id="cb125-894"><a href="#cb125-894" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb125-895"><a href="#cb125-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb125-896"><a href="#cb125-896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-897"><a href="#cb125-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-898"><a href="#cb125-898" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-899"><a href="#cb125-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-900"><a href="#cb125-900" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. Diagnostics</span></span>
<span id="cb125-901"><a href="#cb125-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-902"><a href="#cb125-902" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb125-903"><a href="#cb125-903" aria-hidden="true" tabindex="-1"></a><span class="fu">## Diagnostics Are Non-Negotiable</span></span>
<span id="cb125-904"><a href="#cb125-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-905"><a href="#cb125-905" aria-hidden="true" tabindex="-1"></a>Good estimation is nothing without good diagnostics. **Never report a causal estimate without checking these diagnostics.** They tell you whether your assumptions are plausible and whether the estimator is well-behaved.</span>
<span id="cb125-906"><a href="#cb125-906" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-907"><a href="#cb125-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-908"><a href="#cb125-908" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-909"><a href="#cb125-909" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.1 Propensity Score Overlap</span></span>
<span id="cb125-910"><a href="#cb125-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-911"><a href="#cb125-911" aria-hidden="true" tabindex="-1"></a>If the propensity score distributions for treated and untreated overlap well, the positivity assumption is plausible. **Gaps** indicate regions where one treatment is rarely or never prescribed — all methods will struggle there, but IPTW is especially vulnerable.</span>
<span id="cb125-912"><a href="#cb125-912" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-913"><a href="#cb125-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-916"><a href="#cb125-916" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-917"><a href="#cb125-917" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps_tmle, <span class="at">fill =</span> <span class="fu">factor</span>(A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>)))) <span class="sc">+</span></span>
<span id="cb125-918"><a href="#cb125-918" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">40</span>, <span class="at">alpha =</span> <span class="fl">0.55</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb125-919"><a href="#cb125-919" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-920"><a href="#cb125-920" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Propensity score"</span>,</span>
<span id="cb125-921"><a href="#cb125-921" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb125-922"><a href="#cb125-922" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb125-923"><a href="#cb125-923" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity Score Distribution by Treatment Group"</span></span>
<span id="cb125-924"><a href="#cb125-924" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb125-925"><a href="#cb125-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb125-926"><a href="#cb125-926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb125-927"><a href="#cb125-927" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-928"><a href="#cb125-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-929"><a href="#cb125-929" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-930"><a href="#cb125-930" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.2 Weight Distribution</span></span>
<span id="cb125-931"><a href="#cb125-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-932"><a href="#cb125-932" aria-hidden="true" tabindex="-1"></a>Stabilized weights should center around 1. Very large weights (&gt; 10) indicate **practical positivity violations** — patients who almost never receive their observed treatment. These patients dominate IPTW estimates and destabilize the clever covariate in TMLE.</span>
<span id="cb125-933"><a href="#cb125-933" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-934"><a href="#cb125-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-937"><a href="#cb125-937" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-938"><a href="#cb125-938" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Unstabilized weight summary ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-939"><a href="#cb125-939" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>w_unstab)</span>
<span id="cb125-940"><a href="#cb125-940" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Stabilized weight summary ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-941"><a href="#cb125-941" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>sw)</span>
<span id="cb125-942"><a href="#cb125-942" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Proportion of stabilized weights &gt; 5:"</span>, <span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-943"><a href="#cb125-943" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion of stabilized weights &gt; 10:"</span>, <span class="fu">mean</span>(dat<span class="sc">$</span>sw <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-944"><a href="#cb125-944" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-945"><a href="#cb125-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-946"><a href="#cb125-946" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb125-947"><a href="#cb125-947" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.3 Clever Covariate Diagnostics</span></span>
<span id="cb125-948"><a href="#cb125-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-949"><a href="#cb125-949" aria-hidden="true" tabindex="-1"></a>The clever covariate drives the TMLE targeting step. Extreme values indicate potential instability — if $H(A, W)$ has heavy tails, the targeting step may overfit to a few influential observations.</span>
<span id="cb125-950"><a href="#cb125-950" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-951"><a href="#cb125-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-954"><a href="#cb125-954" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-955"><a href="#cb125-955" aria-hidden="true" tabindex="-1"></a>clever_cov_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb125-956"><a href="#cb125-956" aria-hidden="true" tabindex="-1"></a>  <span class="at">H =</span> H_A,</span>
<span id="cb125-957"><a href="#cb125-957" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="fu">factor</span>(dat<span class="sc">$</span>A, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Sulfonylurea"</span>, <span class="st">"Dapagliflozin"</span>))</span>
<span id="cb125-958"><a href="#cb125-958" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-959"><a href="#cb125-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-960"><a href="#cb125-960" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(clever_cov_df, <span class="fu">aes</span>(<span class="at">x =</span> H, <span class="at">fill =</span> treatment)) <span class="sc">+</span></span>
<span id="cb125-961"><a href="#cb125-961" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb125-962"><a href="#cb125-962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-963"><a href="#cb125-963" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Clever covariate H(A, W)"</span>,</span>
<span id="cb125-964"><a href="#cb125-964" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb125-965"><a href="#cb125-965" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb125-966"><a href="#cb125-966" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of the Clever Covariate"</span></span>
<span id="cb125-967"><a href="#cb125-967" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb125-968"><a href="#cb125-968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb125-969"><a href="#cb125-969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4477AA"</span>, <span class="st">"#EE6677"</span>))</span>
<span id="cb125-970"><a href="#cb125-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-971"><a href="#cb125-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-972"><a href="#cb125-972" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb125-973"><a href="#cb125-973" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.4 Influence Curve Diagnostics</span></span>
<span id="cb125-974"><a href="#cb125-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-975"><a href="#cb125-975" aria-hidden="true" tabindex="-1"></a>The EIC values reveal **influential observations**. A well-behaved TMLE has EIC values centered near zero with no extreme outliers. If you see long tails or a non-zero mean, something may be wrong with the targeting step or the propensity score model.</span>
<span id="cb125-976"><a href="#cb125-976" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-977"><a href="#cb125-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-980"><a href="#cb125-980" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-981"><a href="#cb125-981" aria-hidden="true" tabindex="-1"></a>eic_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">eic =</span> eic_tmle)</span>
<span id="cb125-982"><a href="#cb125-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-983"><a href="#cb125-983" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(eic_df, <span class="fu">aes</span>(<span class="at">x =</span> eic)) <span class="sc">+</span></span>
<span id="cb125-984"><a href="#cb125-984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#228833"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb125-985"><a href="#cb125-985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb125-986"><a href="#cb125-986" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb125-987"><a href="#cb125-987" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Efficient influence curve value"</span>,</span>
<span id="cb125-988"><a href="#cb125-988" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb125-989"><a href="#cb125-989" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of TMLE Influence Curve Values"</span></span>
<span id="cb125-990"><a href="#cb125-990" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb125-991"><a href="#cb125-991" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb125-992"><a href="#cb125-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-993"><a href="#cb125-993" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-994"><a href="#cb125-994" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(eic_tmle)</span>
<span id="cb125-995"><a href="#cb125-995" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"EIC mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(eic_tmle), <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-996"><a href="#cb125-996" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-997"><a href="#cb125-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-998"><a href="#cb125-998" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-999"><a href="#cb125-999" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.5 Extreme Prediction Check</span></span>
<span id="cb125-1000"><a href="#cb125-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1001"><a href="#cb125-1001" aria-hidden="true" tabindex="-1"></a>One of TMLE's advantages: because the targeting step uses a logistic fluctuation, predictions are guaranteed to stay in <span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>. Compare the initial and targeted ranges — the targeting step may shift predictions, but never outside the natural bounds.</span>
<span id="cb125-1002"><a href="#cb125-1002" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1003"><a href="#cb125-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1006"><a href="#cb125-1006" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-1007"><a href="#cb125-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Predicted outcome range (initial model) ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1008"><a href="#cb125-1008" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1009"><a href="#cb125-1009" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0 range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_init), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1010"><a href="#cb125-1010" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Predicted outcome range (after targeting) ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1011"><a href="#cb125-1011" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q1* range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q1_star), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1012"><a href="#cb125-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Q0* range:"</span>, <span class="fu">round</span>(<span class="fu">range</span>(Q0_star), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1013"><a href="#cb125-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-1014"><a href="#cb125-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1015"><a href="#cb125-1015" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-1016"><a href="#cb125-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1017"><a href="#cb125-1017" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. Interpretation</span></span>
<span id="cb125-1018"><a href="#cb125-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1019"><a href="#cb125-1019" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-1020"><a href="#cb125-1020" aria-hidden="true" tabindex="-1"></a><span class="fu">## Translating to Regulatory Language</span></span>
<span id="cb125-1021"><a href="#cb125-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1022"><a href="#cb125-1022" aria-hidden="true" tabindex="-1"></a>Based on the TMLE analysis:</span>
<span id="cb125-1023"><a href="#cb125-1023" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1024"><a href="#cb125-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1025"><a href="#cb125-1025" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Point estimate:** Dapagliflozin is estimated to reduce 1-year MACE risk by approximately <span class="in">`r round(abs(tmle_ate)*100, 1)`</span> percentage points compared to sulfonylurea</span>
<span id="cb125-1026"><a href="#cb125-1026" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Confidence interval:** The 95% CI is <span class="co">[</span><span class="ot">`r round(tmle_ci[1]*100, 1)`, `r round(tmle_ci[2]*100, 1)`</span><span class="co">]</span> percentage points</span>
<span id="cb125-1027"><a href="#cb125-1027" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Risk difference vs. odds ratio:** We report on the risk difference scale because it is directly interpretable. An odds ratio would obscure the magnitude of absolute risk change, which is what matters for labeling and clinical decisions.</span>
<span id="cb125-1028"><a href="#cb125-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1029"><a href="#cb125-1029" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-1030"><a href="#cb125-1030" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regulatory Decision</span></span>
<span id="cb125-1031"><a href="#cb125-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1032"><a href="#cb125-1032" aria-hidden="true" tabindex="-1"></a>If the confidence interval excludes zero and the point estimate is negative (protective), the data do not support adding a cardiovascular warning. If the CI includes zero, the evidence is inconclusive and further monitoring or a dedicated outcomes trial may be warranted.</span>
<span id="cb125-1033"><a href="#cb125-1033" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1034"><a href="#cb125-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1035"><a href="#cb125-1035" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb125-1036"><a href="#cb125-1036" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sensitivity to Assumptions — Which Are Most Fragile?</span></span>
<span id="cb125-1037"><a href="#cb125-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1038"><a href="#cb125-1038" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**No unmeasured confounding (exchangeability):** This is always the weakest link in observational data. Lifestyle factors (diet, exercise, smoking) may confound and are poorly captured in claims data.</span>
<span id="cb125-1039"><a href="#cb125-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1040"><a href="#cb125-1040" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Positivity:** If some patient types never receive one drug (e.g., patients with very low eGFR are ineligible for SGLT2 inhibitors), the ATE is not identifiable for the full population. Consider restricting to a subpopulation where positivity holds.</span>
<span id="cb125-1041"><a href="#cb125-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1042"><a href="#cb125-1042" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Consistency:** If treatment initiation is not well-defined (e.g., varying doses), the potential outcomes are ambiguous.</span>
<span id="cb125-1043"><a href="#cb125-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1044"><a href="#cb125-1044" aria-hidden="true" tabindex="-1"></a>**What if unmeasured confounding exists?** A sensitivity analysis (E-value or bias analysis) can quantify how strong unmeasured confounding would need to be to explain away the observed effect.</span>
<span id="cb125-1045"><a href="#cb125-1045" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1046"><a href="#cb125-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1047"><a href="#cb125-1047" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-1048"><a href="#cb125-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1049"><a href="#cb125-1049" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Why Super Learner Improves Nuisance Estimation</span></span>
<span id="cb125-1050"><a href="#cb125-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1051"><a href="#cb125-1051" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-1052"><a href="#cb125-1052" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Problem With Parametric Models</span></span>
<span id="cb125-1053"><a href="#cb125-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1054"><a href="#cb125-1054" aria-hidden="true" tabindex="-1"></a>In the examples above, we used parametric logistic regression for both the outcome and treatment models. In practice, these models may be misspecified — missing interactions, wrong functional forms, or overly rigid assumptions. **Super Learner** eliminates the need to guess the right model.</span>
<span id="cb125-1055"><a href="#cb125-1055" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1056"><a href="#cb125-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1057"><a href="#cb125-1057" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-1058"><a href="#cb125-1058" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Is Super Learner?</span></span>
<span id="cb125-1059"><a href="#cb125-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1060"><a href="#cb125-1060" aria-hidden="true" tabindex="-1"></a>Super Learner is an ensemble machine learning method that:</span>
<span id="cb125-1061"><a href="#cb125-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1062"><a href="#cb125-1062" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Takes a **library of candidate learners** (logistic regression, LASSO, random forest, etc.)</span>
<span id="cb125-1063"><a href="#cb125-1063" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Uses **cross-validation** to evaluate each learner's performance</span>
<span id="cb125-1064"><a href="#cb125-1064" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Combines them using **optimally weighted stacking**</span>
<span id="cb125-1065"><a href="#cb125-1065" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Guarantees performance at least as good as the best individual learner (asymptotically)</span>
<span id="cb125-1066"><a href="#cb125-1066" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1067"><a href="#cb125-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1068"><a href="#cb125-1068" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb125-1069"><a href="#cb125-1069" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why This Matters for TMLE</span></span>
<span id="cb125-1070"><a href="#cb125-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1071"><a href="#cb125-1071" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>TMLE is doubly robust: consistent if either the outcome or treatment model is correct</span>
<span id="cb125-1072"><a href="#cb125-1072" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>But TMLE is **efficient** when both models are consistent at reasonable rates</span>
<span id="cb125-1073"><a href="#cb125-1073" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Super Learner reduces the risk of misspecifying either model</span>
<span id="cb125-1074"><a href="#cb125-1074" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cross-validation within Super Learner protects against overfitting</span>
<span id="cb125-1075"><a href="#cb125-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1076"><a href="#cb125-1076" aria-hidden="true" tabindex="-1"></a>**Bottom line:** Super Learner + TMLE = data-adaptive, doubly robust, efficient estimation with valid inference.</span>
<span id="cb125-1077"><a href="#cb125-1077" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1078"><a href="#cb125-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1079"><a href="#cb125-1079" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conceptual demonstration</span></span>
<span id="cb125-1080"><a href="#cb125-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1081"><a href="#cb125-1081" aria-hidden="true" tabindex="-1"></a>The following shows how Super Learner would be integrated (this requires the SuperLearner package, which may not run in all webR environments):</span>
<span id="cb125-1082"><a href="#cb125-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1083"><a href="#cb125-1083" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb125-1084"><a href="#cb125-1084" aria-hidden="true" tabindex="-1"></a><span class="in">library(SuperLearner)</span></span>
<span id="cb125-1085"><a href="#cb125-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1086"><a href="#cb125-1086" aria-hidden="true" tabindex="-1"></a><span class="in"># Define learner library</span></span>
<span id="cb125-1087"><a href="#cb125-1087" aria-hidden="true" tabindex="-1"></a><span class="in">SL_lib &lt;- c("SL.glm", "SL.glmnet", "SL.gam", "SL.mean")</span></span>
<span id="cb125-1088"><a href="#cb125-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1089"><a href="#cb125-1089" aria-hidden="true" tabindex="-1"></a><span class="in"># Outcome model via Super Learner</span></span>
<span id="cb125-1090"><a href="#cb125-1090" aria-hidden="true" tabindex="-1"></a><span class="in">Q_SL &lt;- SuperLearner(</span></span>
<span id="cb125-1091"><a href="#cb125-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  Y = dat$Y,</span></span>
<span id="cb125-1092"><a href="#cb125-1092" aria-hidden="true" tabindex="-1"></a><span class="in">  X = dat %&gt;% select(A, age, bmi, hba1c, cvd, egfr, statin),</span></span>
<span id="cb125-1093"><a href="#cb125-1093" aria-hidden="true" tabindex="-1"></a><span class="in">  family = binomial(),</span></span>
<span id="cb125-1094"><a href="#cb125-1094" aria-hidden="true" tabindex="-1"></a><span class="in">  SL.library = SL_lib</span></span>
<span id="cb125-1095"><a href="#cb125-1095" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb125-1096"><a href="#cb125-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1097"><a href="#cb125-1097" aria-hidden="true" tabindex="-1"></a><span class="in"># Treatment model via Super Learner</span></span>
<span id="cb125-1098"><a href="#cb125-1098" aria-hidden="true" tabindex="-1"></a><span class="in">g_SL &lt;- SuperLearner(</span></span>
<span id="cb125-1099"><a href="#cb125-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  Y = dat$A,</span></span>
<span id="cb125-1100"><a href="#cb125-1100" aria-hidden="true" tabindex="-1"></a><span class="in">  X = dat %&gt;% select(age, bmi, hba1c, cvd, egfr, statin),</span></span>
<span id="cb125-1101"><a href="#cb125-1101" aria-hidden="true" tabindex="-1"></a><span class="in">  family = binomial(),</span></span>
<span id="cb125-1102"><a href="#cb125-1102" aria-hidden="true" tabindex="-1"></a><span class="in">  SL.library = SL_lib</span></span>
<span id="cb125-1103"><a href="#cb125-1103" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb125-1104"><a href="#cb125-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1105"><a href="#cb125-1105" aria-hidden="true" tabindex="-1"></a><span class="in"># View the cross-validated weights</span></span>
<span id="cb125-1106"><a href="#cb125-1106" aria-hidden="true" tabindex="-1"></a><span class="in">Q_SL$coef  # how much each learner contributes to the outcome model</span></span>
<span id="cb125-1107"><a href="#cb125-1107" aria-hidden="true" tabindex="-1"></a><span class="in">g_SL$coef  # how much each learner contributes to the treatment model</span></span>
<span id="cb125-1108"><a href="#cb125-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-1109"><a href="#cb125-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1110"><a href="#cb125-1110" aria-hidden="true" tabindex="-1"></a>The Super Learner automatically determines which learners are most useful and how to combine them — no manual model selection required.</span>
<span id="cb125-1111"><a href="#cb125-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1112"><a href="#cb125-1112" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-1113"><a href="#cb125-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1114"><a href="#cb125-1114" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-1115"><a href="#cb125-1115" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Summary of Estimator Trade-offs</span></span>
<span id="cb125-1116"><a href="#cb125-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1117"><a href="#cb125-1117" aria-hidden="true" tabindex="-1"></a>The table below summarizes the key properties of each estimator. TMLE stands out as the only method that is doubly robust, respects parameter bounds, solves the EIC, and integrates naturally with machine learning.</span>
<span id="cb125-1118"><a href="#cb125-1118" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1119"><a href="#cb125-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1120"><a href="#cb125-1120" aria-hidden="true" tabindex="-1"></a>| Property | G-comp | IPTW | AIPW | TMLE |</span>
<span id="cb125-1121"><a href="#cb125-1121" aria-hidden="true" tabindex="-1"></a>|----------|--------|------|------|------|</span>
<span id="cb125-1122"><a href="#cb125-1122" aria-hidden="true" tabindex="-1"></a>| Uses outcome model | Yes | No | Yes | Yes |</span>
<span id="cb125-1123"><a href="#cb125-1123" aria-hidden="true" tabindex="-1"></a>| Uses treatment model | No | Yes | Yes | Yes |</span>
<span id="cb125-1124"><a href="#cb125-1124" aria-hidden="true" tabindex="-1"></a>| Doubly robust | No | No | Yes | Yes |</span>
<span id="cb125-1125"><a href="#cb125-1125" aria-hidden="true" tabindex="-1"></a>| Respects bounds | Depends | N/A | No | Yes |</span>
<span id="cb125-1126"><a href="#cb125-1126" aria-hidden="true" tabindex="-1"></a>| Efficient (solves EIC) | No | No | Asymptotically | Yes |</span>
<span id="cb125-1127"><a href="#cb125-1127" aria-hidden="true" tabindex="-1"></a>| Works with ML | Partially | Partially | Needs cross-fitting | Naturally |</span>
<span id="cb125-1128"><a href="#cb125-1128" aria-hidden="true" tabindex="-1"></a>| Inference method | Bootstrap | Sandwich | Influence curve | Influence curve |</span>
<span id="cb125-1129"><a href="#cb125-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1130"><a href="#cb125-1130" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-1131"><a href="#cb125-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1132"><a href="#cb125-1132" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb125-1133"><a href="#cb125-1133" aria-hidden="true" tabindex="-1"></a><span class="fu"># Key Takeaways</span></span>
<span id="cb125-1134"><a href="#cb125-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1135"><a href="#cb125-1135" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**The naive estimate is biased** because treatment groups differ in baseline characteristics. Never interpret unadjusted comparisons as causal effects.</span>
<span id="cb125-1136"><a href="#cb125-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1137"><a href="#cb125-1137" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**G-computation is intuitive** but depends on correctly modeling the outcome. It implements the identification formula directly.</span>
<span id="cb125-1138"><a href="#cb125-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1139"><a href="#cb125-1139" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**IPTW tackles confounding through reweighting** but is sensitive to positivity violations and propensity score misspecification. Always check weight distributions.</span>
<span id="cb125-1140"><a href="#cb125-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1141"><a href="#cb125-1141" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**AIPW is doubly robust** — consistent if either the outcome or treatment model is correct. But it does not target the parameter of interest and can produce out-of-bounds predictions.</span>
<span id="cb125-1142"><a href="#cb125-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1143"><a href="#cb125-1143" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**TMLE combines the strengths of all methods.** It starts with an outcome model, targets it using the propensity score, respects parameter bounds, and provides efficient inference through the influence curve.</span>
<span id="cb125-1144"><a href="#cb125-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1145"><a href="#cb125-1145" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Super Learner** reduces the risk of model misspecification by ensembling multiple learners with cross-validated weights. It pairs naturally with TMLE.</span>
<span id="cb125-1146"><a href="#cb125-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1147"><a href="#cb125-1147" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Diagnostics are non-negotiable.** Always inspect propensity score overlap, weight distributions, covariate balance, and influence curve behavior before trusting any estimate.</span>
<span id="cb125-1148"><a href="#cb125-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1149"><a href="#cb125-1149" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**Every step of the causal roadmap matters.** The estimate is only as valid as the assumptions that identify the causal effect from observational data.</span>
<span id="cb125-1150"><a href="#cb125-1150" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1151"><a href="#cb125-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1152"><a href="#cb125-1152" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-1153"><a href="#cb125-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1154"><a href="#cb125-1154" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb125-1155"><a href="#cb125-1155" aria-hidden="true" tabindex="-1"></a><span class="fu"># 10. Where to Go Next</span></span>
<span id="cb125-1156"><a href="#cb125-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1157"><a href="#cb125-1157" aria-hidden="true" tabindex="-1"></a>The framework in this chapter extends to several important settings — each covered in subsequent chapters:</span>
<span id="cb125-1158"><a href="#cb125-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1159"><a href="#cb125-1159" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Dynamic treatment regimes:** Treatment rules that depend on patient characteristics (e.g., "prescribe dapagliflozin if eGFR &gt; 45, else sulfonylurea")</span>
<span id="cb125-1160"><a href="#cb125-1160" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Stochastic interventions:** Shift the probability of treatment rather than forcing a deterministic assignment — useful when positivity is limited</span>
<span id="cb125-1161"><a href="#cb125-1161" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Mediation analysis:** Decompose the total effect into direct and indirect pathways (see Chapter 3.10)</span>
<span id="cb125-1162"><a href="#cb125-1162" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Longitudinal TMLE (LTMLE):** Handle time-varying treatments and confounders (see Chapters 3.7 and 3.9)</span>
<span id="cb125-1163"><a href="#cb125-1163" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Clean-room TMLE:** Pre-specified, locked, auditable analysis for regulatory submissions (see Chapter 3.8)</span>
<span id="cb125-1164"><a href="#cb125-1164" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conditional average treatment effects (CATE):** Estimate how the treatment effect varies across subgroups</span>
<span id="cb125-1165"><a href="#cb125-1165" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Variable importance:** Identify which confounders matter most for the treatment effect</span>
<span id="cb125-1166"><a href="#cb125-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1167"><a href="#cb125-1167" aria-hidden="true" tabindex="-1"></a>Each extension follows the same causal roadmap: define the question, specify the causal model, verify assumptions, identify the statistical estimand, and choose an appropriate estimator.</span>
<span id="cb125-1168"><a href="#cb125-1168" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb125-1169"><a href="#cb125-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1172"><a href="#cb125-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-1173"><a href="#cb125-1173" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb125-1174"><a href="#cb125-1174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb125-1175"><a href="#cb125-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1176"><a href="#cb125-1176" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb125-1177"><a href="#cb125-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1178"><a href="#cb125-1178" aria-hidden="true" tabindex="-1"></a><span class="fu">## Software Implementation (R)</span></span>
<span id="cb125-1179"><a href="#cb125-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1180"><a href="#cb125-1180" aria-hidden="true" tabindex="-1"></a>This example brings together the progressive estimation sequence from this chapter (naive → g-computation → IPTW → TMLE) using the <span class="in">`tmle`</span> package with Super Learner.</span>
<span id="cb125-1181"><a href="#cb125-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1182"><a href="#cb125-1182" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simulate a pharmacoepi-style dataset with multiple confounders</span>
<span id="cb125-1183"><a href="#cb125-1183" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Run the <span class="in">`tmle()`</span> function with a diverse Super Learner library</span>
<span id="cb125-1184"><a href="#cb125-1184" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Extract and interpret: ATE, risk difference, confidence interval, and influence curve diagnostics</span>
<span id="cb125-1185"><a href="#cb125-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1188"><a href="#cb125-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb125-1189"><a href="#cb125-1189" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb125-1190"><a href="#cb125-1190" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb125-1191"><a href="#cb125-1191" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">800</span></span>
<span id="cb125-1192"><a href="#cb125-1192" aria-hidden="true" tabindex="-1"></a>W1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)                                      <span class="co"># age (standardized)</span></span>
<span id="cb125-1193"><a href="#cb125-1193" aria-hidden="true" tabindex="-1"></a>W2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.3</span>)                             <span class="co"># diabetes indicator</span></span>
<span id="cb125-1194"><a href="#cb125-1194" aria-hidden="true" tabindex="-1"></a>W3 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">0.5</span> <span class="sc">*</span> W1)                     <span class="co"># BMI (standardized)</span></span>
<span id="cb125-1195"><a href="#cb125-1195" aria-hidden="true" tabindex="-1"></a>A  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> W2 <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> W3))</span>
<span id="cb125-1196"><a href="#cb125-1196" aria-hidden="true" tabindex="-1"></a>Y  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> A <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> W1 <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> W2 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> W3))</span>
<span id="cb125-1197"><a href="#cb125-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1198"><a href="#cb125-1198" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"tmle"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb125-1199"><a href="#cb125-1199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tmle)</span>
<span id="cb125-1200"><a href="#cb125-1200" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">W1 =</span> W1, <span class="at">W2 =</span> W2, <span class="at">W3 =</span> W3)</span>
<span id="cb125-1201"><a href="#cb125-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1202"><a href="#cb125-1202" aria-hidden="true" tabindex="-1"></a>  tmle_fit <span class="ot">&lt;-</span> <span class="fu">tmle</span>(</span>
<span id="cb125-1203"><a href="#cb125-1203" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> Y, <span class="at">A =</span> A, <span class="at">W =</span> W,</span>
<span id="cb125-1204"><a href="#cb125-1204" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb125-1205"><a href="#cb125-1205" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q.SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.step"</span>, <span class="st">"SL.mean"</span>),</span>
<span id="cb125-1206"><a href="#cb125-1206" aria-hidden="true" tabindex="-1"></a>    <span class="at">g.SL.library  =</span> <span class="fu">c</span>(<span class="st">"SL.glm"</span>, <span class="st">"SL.step"</span>, <span class="st">"SL.mean"</span>)</span>
<span id="cb125-1207"><a href="#cb125-1207" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb125-1208"><a href="#cb125-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1209"><a href="#cb125-1209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"── TMLE results ─────────────────────</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1210"><a href="#cb125-1210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ATE (risk difference):"</span>, <span class="fu">round</span>(tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>psi, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1211"><a href="#cb125-1211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"95% CI:"</span>, <span class="fu">round</span>(tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>CI, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1212"><a href="#cb125-1212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"p-value:"</span>, <span class="fu">format.pval</span>(tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>pvalue, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1213"><a href="#cb125-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-1214"><a href="#cb125-1214" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Influence curve diagnostic (mean should be ≈ 0)</span></span>
<span id="cb125-1215"><a href="#cb125-1215" aria-hidden="true" tabindex="-1"></a>  ic <span class="ot">&lt;-</span> tmle_fit<span class="sc">$</span>estimates<span class="sc">$</span>ATE<span class="sc">$</span>IC</span>
<span id="cb125-1216"><a href="#cb125-1216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Influence curve mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(ic), <span class="dv">6</span>),</span>
<span id="cb125-1217"><a href="#cb125-1217" aria-hidden="true" tabindex="-1"></a>      <span class="st">" (should be ≈ 0)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb125-1218"><a href="#cb125-1218" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb125-1219"><a href="#cb125-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Install the 'tmle' package:  install.packages('tmle')"</span>)</span>
<span id="cb125-1220"><a href="#cb125-1220" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb125-1221"><a href="#cb125-1221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>