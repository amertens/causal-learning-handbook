<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A practical guide to the Causal Roadmap, Targeted Maximum Likelihood Estimation (TMLE), and Super Learner for modern causal inference in epidemiology, with emphasis on pharmacoepidemiology and clinical trial analysis.">

<title>7&nbsp; Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW) – Causal Learning Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./02-03-doubly-robust-tmle.html" rel="next">
<link href="./02-01-gcomputation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b343bb23504f009ddf7b24643a6af19a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-01-gcomputation.html">Part II: Estimation Methods</a></li><li class="breadcrumb-item"><a href="./02-02-iptw.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Causal Learning Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/amertens/causal-learning-handbook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Causal Learning Handbook</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-01-regression-vs-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 1.1: Limitations of Standard Regression Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-02-causal-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 1.2: The Causal Roadmap</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-03-identification-estimands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1.3: From Causal Questions to Analysis — Identification, Estimands, and Statistical Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Roadmap for Real-world Evidence Generation: A Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Estimation Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-01-gcomputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-02-iptw.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-03-doubly-robust-tmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-04-tmle-teaching-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 2.4: From Question to Estimate — TMLE in Practice</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superlearner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 2.4: SuperLearner and Machine Learning for Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-03-longitudinal-case-study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 3.3: Case Study – Real-World Application in Longitudinal Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-04-effect-modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 3.4: Effect Modification and Heterogeneous Treatment Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-05-advanced-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 3.5: Advanced Diagnostics and Sensitivity Analyses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-06-rwd-meets-rct-hybrid-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 3.6: When RWD Meets RCT – Hybrid Designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-07-longitudinal-td-confounding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 3.7: Imperfect Adherence, Time-Varying Confounding, and Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-08-tmle-clean-room.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 3.8: TMLE in the Clean-Room Framework for Pharmacoepidemiology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-09-illustrated-ltmle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">An Illustrated Guide to Longitudinal TMLE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-10-tmle-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">An Illustrated Guide to TMLE for Mediation Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-11-estimands-tte-safety.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimands in Time-to-Event Real-World Safety Analyses: A Simulation-Based Tutorial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Common Pitfalls and How to Avoid Them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anotated_bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Annotated Bibliography: Modern Causal Inference and Targeted Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#chapter-2.2-inverse-probability-of-treatment-weighting" id="toc-chapter-2.2-inverse-probability-of-treatment-weighting" class="nav-link active" data-scroll-target="#chapter-2.2-inverse-probability-of-treatment-weighting"><span class="header-section-number">8</span> Chapter 2.2: Inverse Probability of Treatment Weighting</a></li>
  <li><a href="#intuition-reweighting-to-mimic-a-trial" id="toc-intuition-reweighting-to-mimic-a-trial" class="nav-link" data-scroll-target="#intuition-reweighting-to-mimic-a-trial"><span class="header-section-number">9</span> 1. Intuition: Reweighting to Mimic a Trial</a></li>
  <li><a href="#identification-using-iptw" id="toc-identification-using-iptw" class="nav-link" data-scroll-target="#identification-using-iptw"><span class="header-section-number">10</span> 2. Identification Using IPTW</a></li>
  <li><a href="#simulated-example" id="toc-simulated-example" class="nav-link" data-scroll-target="#simulated-example"><span class="header-section-number">11</span> 3. Simulated Example</a></li>
  <li><a href="#estimating-the-propensity-score" id="toc-estimating-the-propensity-score" class="nav-link" data-scroll-target="#estimating-the-propensity-score"><span class="header-section-number">12</span> 4. Estimating the Propensity Score</a></li>
  <li><a href="#constructing-iptw-weights" id="toc-constructing-iptw-weights" class="nav-link" data-scroll-target="#constructing-iptw-weights"><span class="header-section-number">13</span> 5. Constructing IPTW Weights</a></li>
  <li><a href="#estimating-the-ate-via-iptw" id="toc-estimating-the-ate-via-iptw" class="nav-link" data-scroll-target="#estimating-the-ate-via-iptw"><span class="header-section-number">14</span> 6. Estimating the ATE via IPTW</a>
  <ul class="collapse">
  <li><a href="#direct-weighted-mean-of-outcomes" id="toc-direct-weighted-mean-of-outcomes" class="nav-link" data-scroll-target="#direct-weighted-mean-of-outcomes"><span class="header-section-number">14.1</span> 6.1 Direct weighted mean of outcomes</a></li>
  <li><a href="#weighted-regression-model" id="toc-weighted-regression-model" class="nav-link" data-scroll-target="#weighted-regression-model"><span class="header-section-number">14.2</span> 6.2 Weighted regression model</a></li>
  </ul></li>
  <li><a href="#comparing-iptw-and-g-computation" id="toc-comparing-iptw-and-g-computation" class="nav-link" data-scroll-target="#comparing-iptw-and-g-computation"><span class="header-section-number">15</span> 7. Comparing IPTW and G Computation</a></li>
  <li><a href="#diagnostics-and-practical-tips" id="toc-diagnostics-and-practical-tips" class="nav-link" data-scroll-target="#diagnostics-and-practical-tips"><span class="header-section-number">16</span> 8. Diagnostics and Practical Tips</a>
  <ul class="collapse">
  <li><a href="#check-propensity-score-overlap" id="toc-check-propensity-score-overlap" class="nav-link" data-scroll-target="#check-propensity-score-overlap"><span class="header-section-number">16.0.1</span> 8.1 Check propensity score overlap</a></li>
  <li><a href="#check-weights" id="toc-check-weights" class="nav-link" data-scroll-target="#check-weights"><span class="header-section-number">16.0.2</span> 8.2 Check weights</a></li>
  <li><a href="#consider-truncation" id="toc-consider-truncation" class="nav-link" data-scroll-target="#consider-truncation"><span class="header-section-number">16.0.3</span> 8.3 Consider truncation</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">17</span> 9. Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-01-gcomputation.html">Part II: Estimation Methods</a></li><li class="breadcrumb-item"><a href="./02-02-iptw.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="chapter-2.2-inverse-probability-of-treatment-weighting" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Chapter 2.2: Inverse Probability of Treatment Weighting</h1>
<p>Inverse probability of treatment weighting (IPTW) is a core method in modern causal inference. Instead of modeling the outcome directly as in g computation, IPTW uses a model for <strong>treatment assignment</strong> to create a pseudo population where treatment is independent of confounders.</p>
<p>In this chapter we will</p>
<ul>
<li>Build intuition for IPTW</li>
<li>Derive the weights and connect them to the causal estimand</li>
<li>Show how to estimate and diagnose propensity scores</li>
<li>Implement IPTW in R with tidyverse style</li>
<li>Discuss stabilized weights and truncation</li>
<li>Compare IPTW to g computation on the same simulated data</li>
</ul>
<p>This is still point treatment only. Longitudinal extensions come later.</p>
<hr>
</section>
<section id="intuition-reweighting-to-mimic-a-trial" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> 1. Intuition: Reweighting to Mimic a Trial</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Insight: IPTW Creates a Pseudo-Population That Mimics a Randomized Trial
</div>
</div>
<div class="callout-body-container callout-body">
<p>In observational data, some types of patients are more likely to receive one treatment than another. This creates <strong>confounding by indication</strong>. Think of it this way: if sicker patients are preferentially given a new drug, a naive comparison of outcomes between treated and untreated groups will be biased.</p>
<p>IPTW tackles this by</p>
<blockquote class="blockquote">
<p>Giving more weight to underrepresented patients and less weight to overrepresented ones, so that in the weighted sample, treatment looks as if it were randomized given the measured covariates.</p>
</blockquote>
<p>The result is a <strong>pseudo-population</strong> — a reweighted version of your study sample where the distribution of confounders is the same across treatment groups, just as it would be in a well-conducted randomized trial. This is the core idea that makes IPTW so powerful for epidemiologic research.</p>
<ul>
<li>Patients who got a treatment that was unlikely for their covariate pattern receive a large weight (they are “surprising” and therefore informative)</li>
<li>Patients who got the most expected treatment get a small weight (they are “predictable” and already well-represented)</li>
</ul>
<p>In the weighted pseudo-population, confounders are balanced between treatment groups (if the propensity score model is correctly specified).</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: The Propensity Score
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>propensity score</strong> is the probability of receiving treatment given measured covariates:</p>
<p><span class="math display">\[
e(W) = P(A = 1 \mid W)
\]</span></p>
<p>IPTW weights are constructed from the propensity score:</p>
<ul>
<li>For treated: ( w_i = )</li>
<li>For control: ( w_i = )</li>
</ul>
<p>The propensity score is a <strong>balancing score</strong>: conditioning on it is sufficient to remove confounding by all measured covariates <span class="math inline">\(W\)</span>. This is why a single scalar summary can replace adjustment for many covariates.</p>
</div>
</div>
<hr>
</section>
<section id="identification-using-iptw" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> 2. Identification Using IPTW</h1>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The IPTW Identification Result and the Horvitz-Thompson Connection
</div>
</div>
<div class="callout-body-container callout-body">
<p>Under the same causal assumptions as before</p>
<ul>
<li><strong>Consistency</strong>: the observed outcome equals the potential outcome under the treatment actually received</li>
<li><strong>Exchangeability</strong>: ( Y(a) A W ) — no unmeasured confounding</li>
<li><strong>Positivity</strong>: every covariate stratum has a non-zero probability of receiving each treatment</li>
</ul>
<p>the average potential outcome under treatment can be expressed as</p>
<p><span class="math display">\[
E[Y(1)] = E\left[ \frac{I(A = 1) Y}{e(W)} \right]
\]</span></p>
<p>and under control</p>
<p><span class="math display">\[
E[Y(0)] = E\left[ \frac{I(A = 0) Y}{1 - e(W)} \right]
\]</span></p>
<p>The IPTW estimator replaces the expectation with the sample average and replaces the true ( e(W) ) with an estimated one.</p>
<p>This is called a <strong>Horvitz-Thompson type</strong> estimator because it has the same structure as the survey sampling estimator that reweights observations by the inverse of their selection probability. In our setting, “selection” is selection into a treatment group. Just as survey statisticians upweight undersampled populations, we upweight patients whose treatment assignment was unlikely given their covariates.</p>
</div>
</div>
<hr>
</section>
<section id="simulated-example" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> 3. Simulated Example</h1>
<p>We reuse a familiar setup: an osteoporosis like population with confounding by age and cardiovascular history.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.6.0
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">4000</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">75</span>, <span class="dv">6</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>cvd <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="fl">0.12</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">70</span>)))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment assignment with strong confounding</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.09</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> cvd))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>A <span class="sc">+</span> <span class="fl">0.10</span><span class="sc">*</span>(age <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fl">1.0</span><span class="sc">*</span>cvd))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(age, cvd, A, Y)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
    age   cvd     A     Y
  &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1  78.7     1     1     1
2  75.2     1     0     1
3  79.6     0     1     0
4  82.6     1     0     0
5  77.2     0     1     0
6  74.0     1     1     1</code></pre>
</div>
</div>
<p>For simplicity</p>
<ul>
<li>A = 1 can be thought of as denosumab</li>
<li>A = 0 can be thought of as zoledronic acid</li>
<li>Y = 1 indicates occurrence of a cardiovascular outcome</li>
</ul>
<hr>
</section>
<section id="estimating-the-propensity-score" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> 4. Estimating the Propensity Score</h1>
<p>We model the probability of receiving treatment given covariates.</p>
<p>In practice, one might use logistic regression, SuperLearner, or other ML. Here we start with logistic regression for clarity.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ps_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> cvd, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = A ~ age + cvd, family = binomial, data = dat)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -7.186635   0.486406  -14.78   &lt;2e-16 ***
age          0.088177   0.006572   13.42   &lt;2e-16 ***
cvd          1.478441   0.073676   20.07   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 5459  on 3999  degrees of freedom
Residual deviance: 4634  on 3997  degrees of freedom
AIC: 4640

Number of Fisher Scoring iterations: 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps =</span> <span class="fu">predict</span>(ps_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_ps =</span> <span class="fu">min</span>(ps),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_ps =</span> <span class="fu">max</span>(ps)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  min_ps max_ps
   &lt;dbl&gt;  &lt;dbl&gt;
1 0.0987  0.950</code></pre>
</div>
</div>
<p>We can visualize the propensity score distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A))) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated propensity score P(A=1 | W)"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity score overlap"</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02-02-iptw_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Reading the Propensity Score Overlap Plot
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Good overlap</strong> looks like two density curves that cover mostly the same range of propensity scores, even if their peaks differ. This means that for most covariate patterns, there are both treated and untreated patients — exactly what positivity requires.</p>
<p><strong>Bad overlap</strong> looks like two density curves that barely touch, with the treated group concentrated at high propensity scores and the untreated group concentrated at low ones. When this happens:</p>
<ul>
<li>IPTW produces extreme weights for patients in the non-overlapping tails</li>
<li>Estimates become highly variable and unreliable</li>
<li>You may need to restrict your target population to the region of overlap (trimming) or reconsider your study design</li>
</ul>
<p>As a rule of thumb, be concerned if propensity scores for either group pile up near 0 or 1.</p>
</div>
</div>
<hr>
</section>
<section id="constructing-iptw-weights" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> 5. Constructing IPTW Weights</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Unstabilized Weights
</div>
</div>
<div class="callout-body-container callout-body">
<p>Unstabilized weights are the simplest form of IPTW weights. For each individual, the weight is the inverse of the probability of receiving the treatment they actually received:</p>
<ul>
<li>Treated (<span class="math inline">\(A = 1\)</span>): <span class="math inline">\(w_i = 1 / e(W_i)\)</span></li>
<li>Untreated (<span class="math inline">\(A = 0\)</span>): <span class="math inline">\(w_i = 1 / (1 - e(W_i))\)</span></li>
</ul>
<p>These weights create a pseudo-population where treatment is independent of measured confounders. However, they can be highly variable — especially when some propensity scores are close to 0 or 1.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_ipw =</span> <span class="fu">if_else</span>(A <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> ps, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>w_ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.052   1.297   1.487   1.998   2.327  15.717 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(dat<span class="sc">$</span>w_ipw, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      1%      99% 
1.118912 6.063346 </code></pre>
</div>
</div>
<p>Keep an eye on</p>
<ul>
<li>Very large weights (suggest near-violations of positivity)</li>
<li>Range and extreme quantiles (the 99th percentile should not be orders of magnitude larger than the median)</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why Stabilized Weights Are Preferred in Practice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stabilized weights multiply the standard IPTW weights by the <strong>marginal probability of treatment</strong>, which brings the weights closer to 1 on average and reduces their variance without introducing bias for the marginal causal effect.</p>
<p>For a binary treatment:</p>
<p><span class="math display">\[
SW_i = \frac{P(A_i)}{e(W_i)} \text{ if } A_i = 1
\]</span></p>
<p>and</p>
<p><span class="math display">\[
SW_i = \frac{P(A_i)}{1 - e(W_i)} \text{ if } A_i = 0
\]</span></p>
<p>Here ( P(A_i) ) is the marginal probability of treatment (estimated as the sample proportion treated).</p>
<p><strong>Why this helps:</strong> Unstabilized weights create a pseudo-population that is larger than the original sample, which inflates standard errors. Stabilized weights preserve the original sample size in expectation, leading to:</p>
<ul>
<li>Narrower confidence intervals</li>
<li>More stable point estimates</li>
<li>Better finite-sample performance</li>
</ul>
<p>In epidemiologic practice, <strong>always prefer stabilized weights</strong> unless you have a specific reason to use unstabilized ones.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pA <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>A)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sw_ipw =</span> <span class="fu">case_when</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> pA <span class="sc">/</span> ps,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      A <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">-</span> pA) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>sw_ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.4735  0.6846  0.7863  0.9992  1.1240  6.7071 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(dat<span class="sc">$</span>sw_ipw, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1%       99% 
0.5029079 2.9252532 </code></pre>
</div>
</div>
<hr>
</section>
<section id="estimating-the-ate-via-iptw" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> 6. Estimating the ATE via IPTW</h1>
<p>There are several equivalent ways to use the weights.</p>
<section id="direct-weighted-mean-of-outcomes" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="direct-weighted-mean-of-outcomes"><span class="header-section-number">14.1</span> 6.1 Direct weighted mean of outcomes</h2>
<p>Estimated risk under treatment</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>risk1_ipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>risk0_ipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>ate_ipw <span class="ot">&lt;-</span> risk1_ipw <span class="sc">-</span> risk0_ipw</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">risk1 =</span> risk1_ipw, <span class="at">risk0 =</span> risk0_ipw, <span class="at">ate =</span> ate_ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    risk1     risk0       ate 
0.4109454 0.2991691 0.1117762 </code></pre>
</div>
</div>
<p>This matches the formula</p>
<p><span class="math display">\[
\hat E[Y(1)] = \frac{\sum_i SW_i Y_i I(A_i = 1)}{\sum_i SW_i I(A_i = 1)}
\]</span></p>
</section>
<section id="weighted-regression-model" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="weighted-regression-model"><span class="header-section-number">14.2</span> 6.2 Weighted regression model</h2>
<p>We can also fit a weighted regression with treatment as the only predictor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a simple weighted model</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>fit_ipw <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A, <span class="at">family =</span> binomial, <span class="at">weights =</span> sw_ipw, <span class="at">data =</span> dat)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust standard errors</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>cov_ipw <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(fit_ipw, <span class="at">type =</span> <span class="st">"HC0"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(fit_ipw, cov_ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Interpretation</p>
<ul>
<li>The coefficient of A (on the log odds scale) now estimates a marginal effect in the pseudo population</li>
<li>You can compute marginal risk differences or ratios by predicting from the model at A=1 and A=0 and standardizing</li>
</ul>
<hr>
</section>
</section>
<section id="comparing-iptw-and-g-computation" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> 7. Comparing IPTW and G Computation</h1>
<p>We can compare the IPTW ATE to the g computation ATE from the previous chapter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># g computation</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> cvd, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>p1_g <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>p0_g <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>ate_g <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_g <span class="sc">-</span> p0_g)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">ate_gcomp =</span> ate_g, <span class="at">ate_iptw =</span> ate_ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ate_gcomp  ate_iptw 
0.1064902 0.1117762 </code></pre>
</div>
</div>
<p>Under correct models and adequate positivity, these methods should converge to similar estimates as sample size grows.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Critical Takeaway: IPTW and G-Computation Depend on Different Models
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is one of the most important conceptual points in causal inference methodology:</p>
<ul>
<li><strong>G-computation</strong> depends on correctly specifying the <strong>outcome model</strong> <span class="math inline">\(E[Y \mid A, W]\)</span></li>
<li><strong>IPTW</strong> depends on correctly specifying the <strong>treatment model</strong> <span class="math inline">\(P(A \mid W)\)</span></li>
<li><strong>Neither uses both models at once</strong></li>
</ul>
<p>In practice, you rarely know which model is correct. This motivates <strong>doubly robust</strong> methods (next chapter), which combine both approaches and provide consistent estimates if <em>either</em> the treatment model <em>or</em> the outcome model is correctly specified — giving you two chances to get it right.</p>
<p>For MPH epidemiologists: when you present IPTW results, always show propensity score diagnostics (overlap, balance) alongside your estimates. When you present g-computation results, discuss outcome model fit. When the two approaches give very different answers, that is a signal that at least one model may be misspecified.</p>
</div>
</div>
<hr>
</section>
<section id="diagnostics-and-practical-tips" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> 8. Diagnostics and Practical Tips</h1>
<p>IPTW is powerful but fragile if diagnostics are ignored.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Diagnostic Checklist: Never Report IPTW Without These Checks
</div>
</div>
<div class="callout-body-container callout-body">
<p>Every IPTW analysis should include diagnostics. Reviewers and readers should expect to see them. Omitting diagnostics is a red flag in any manuscript.</p>
</div>
</div>
<section id="check-propensity-score-overlap" class="level3" data-number="16.0.1">
<h3 data-number="16.0.1" class="anchored" data-anchor-id="check-propensity-score-overlap"><span class="header-section-number">16.0.1</span> 8.1 Check propensity score overlap</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Assessing Positivity via Overlap
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Plot propensity score densities by treatment group (as we did in Section 4)</li>
<li>Flag regions where one group is missing or sparse</li>
<li>If the treated and untreated distributions do not overlap, the ATE may not be identifiable in that region</li>
<li>Consider restricting inference to the overlap population or reporting the ATT instead</li>
</ul>
</div>
</div>
</section>
<section id="check-weights" class="level3" data-number="16.0.2">
<h3 data-number="16.0.2" class="anchored" data-anchor-id="check-weights"><span class="header-section-number">16.0.2</span> 8.2 Check weights</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_w =</span> <span class="fu">min</span>(sw_ipw),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_w =</span> <span class="fu">max</span>(sw_ipw),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_w =</span> <span class="fu">mean</span>(sw_ipw),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_w =</span> <span class="fu">sd</span>(sw_ipw)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  min_w max_w mean_w  sd_w
  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 0.474  6.71  0.999 0.544</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
When Extreme Weights Signal Trouble
</div>
</div>
<div class="callout-body-container callout-body">
<p>Large extreme weights are a red flag. Watch for these warning signs:</p>
<ul>
<li><strong>Maximum weight &gt; 10–20</strong>: a single observation is being counted as 10–20 people. Your estimate may be driven by one or two individuals.</li>
<li><strong>Mean of stabilized weights far from 1</strong>: stabilized weights should average approximately 1. Deviations suggest model misspecification.</li>
<li><strong>Ratio of max to median weight &gt; 20</strong>: indicates near-violation of positivity for some covariate patterns.</li>
</ul>
<p>When you see extreme weights, consider: (1) improving your propensity score model, (2) checking for data errors in the extreme-weight observations, and (3) applying weight truncation (see below).</p>
</div>
</div>
</section>
<section id="consider-truncation" class="level3" data-number="16.0.3">
<h3 data-number="16.0.3" class="anchored" data-anchor-id="consider-truncation"><span class="header-section-number">16.0.3</span> 8.3 Consider truncation</h3>
<p>You can truncate weights at a chosen percentile, for example the 1st and 99th percentiles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>lower <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw_ipw, <span class="fl">0.01</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>upper <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw_ipw, <span class="fl">0.99</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sw_trunc =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(sw_ipw, lower), upper)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># recompute ATE with truncated weights</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>risk1_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>risk0_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>ate_trunc   <span class="ot">&lt;-</span> risk1_trunc <span class="sc">-</span> risk0_trunc</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">ate_truncated =</span> ate_trunc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ate_truncated 
    0.1168119 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Truncation Trade-Off: Bias vs.&nbsp;Variance
</div>
</div>
<div class="callout-body-container callout-body">
<p>Truncation (also called “winsorizing”) reduces variance at the cost of introducing some bias. By capping extreme weights, you are effectively saying: “I am willing to accept a small amount of bias in exchange for a much more stable estimate.”</p>
<p><strong>The trade-off in practice:</strong></p>
<ul>
<li><strong>Without truncation</strong>: unbiased (if the propensity model is correct) but potentially high variance, with confidence intervals that may be uninformatively wide</li>
<li><strong>With truncation</strong>: slightly biased but often lower mean squared error, producing more useful estimates</li>
</ul>
<p><strong>Common approaches:</strong></p>
<ul>
<li>Truncate at the 1st and 99th percentiles (as shown above)</li>
<li>Truncate at fixed values (e.g., cap weights at 10 or 20)</li>
<li>Report results with and without truncation as a sensitivity analysis</li>
</ul>
<p>There is no single “right” truncation threshold. In your manuscripts, always report which threshold you used and show sensitivity to this choice.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="summary" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> 9. Summary</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Chapter Takeaways and Limitations
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>What we covered:</strong></p>
<ul>
<li>The intuition for IPTW as a method that reweights observational data to mimic a randomized trial</li>
<li>The key role of the propensity score in computing weights, and its connection to the Horvitz-Thompson estimator from survey sampling</li>
<li>How to construct unstabilized and stabilized IPTW weights (prefer stabilized in practice)</li>
<li>How to estimate ATEs via weighted means or weighted regression</li>
<li>How to diagnose propensity score overlap and extreme weights — never skip these diagnostics</li>
<li>How IPTW compares to g-computation, and why each depends on a different model</li>
</ul>
<p><strong>Limitations to keep in mind:</strong></p>
<ul>
<li>Depends entirely on a correctly specified treatment model — if you miss a confounder or misspecify the functional form, your weights will not balance the confounders</li>
<li>Sensitive to violations of positivity — extreme weights can dominate your estimates</li>
<li>Does not use information from the outcome model, which motivates doubly robust approaches</li>
<li>For rare exposures or outcomes, IPTW can be particularly unstable</li>
</ul>
<p><strong>Looking ahead:</strong> In the next chapter, we will introduce <strong>doubly robust estimators</strong> and <strong>Targeted Maximum Likelihood Estimation (TMLE)</strong>, which combine the strengths of g-computation and IPTW and allow the use of machine learning for both nuisance models.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lubridate_1.9.3 forcats_1.0.0   stringr_1.6.0   dplyr_1.1.4    
 [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   
 [9] ggplot2_3.5.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 
 [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         
 [9] labeling_0.4.3    generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4
[13] munsell_0.5.1     pillar_1.9.0      tzdb_0.4.0        rlang_1.1.6      
[17] utf8_1.2.4        stringi_1.8.7     xfun_0.49         timechange_0.3.0 
[21] cli_3.6.5         withr_3.0.2       magrittr_2.0.3    digest_0.6.37    
[25] grid_4.4.2        rstudioapi_0.17.1 hms_1.1.3         lifecycle_1.0.4  
[29] vctrs_0.6.5       evaluate_1.0.5    glue_1.8.0        farver_2.1.2     
[33] fansi_1.0.6       colorspace_2.1-1  rmarkdown_2.29    tools_4.4.2      
[37] pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amertens\.github\.io\/causal-learning-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02-01-gcomputation.html" class="pagination-link" aria-label="Chapter 2.1: Outcome Modeling and Standardization (G-Computation)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 2.1: Outcome Modeling and Standardization (G-Computation)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./02-03-doubly-robust-tmle.html" class="pagination-link" aria-label="Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 2.3: Doubly Robust Estimators and Targeted Learning (AIPW + TMLE)</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 2.2: Inverse Probability of Treatment Weighting (IPTW)"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 2.2: Inverse Probability of Treatment Weighting  </span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>Inverse probability of treatment weighting (IPTW) is a core method in modern causal inference. Instead of modeling the outcome directly as in g computation, IPTW uses a model for **treatment assignment** to create a pseudo population where treatment is independent of confounders.  </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>In this chapter we will</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build intuition for IPTW</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Derive the weights and connect them to the causal estimand</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Show how to estimate and diagnose propensity scores</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement IPTW in R with tidyverse style</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Discuss stabilized weights and truncation</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compare IPTW to g computation on the same simulated data</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>This is still point treatment only. Longitudinal extensions come later.</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. Intuition: Reweighting to Mimic a Trial</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Insight: IPTW Creates a Pseudo-Population That Mimics a Randomized Trial</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>In observational data, some types of patients are more likely to receive one treatment than another. This creates **confounding by indication**. Think of it this way: if sicker patients are preferentially given a new drug, a naive comparison of outcomes between treated and untreated groups will be biased.</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>IPTW tackles this by</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Giving more weight to underrepresented patients and less weight to overrepresented ones, so that in the weighted sample, treatment looks as if it were randomized given the measured covariates.</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>The result is a **pseudo-population** --- a reweighted version of your study sample where the distribution of confounders is the same across treatment groups, just as it would be in a well-conducted randomized trial. This is the core idea that makes IPTW so powerful for epidemiologic research.</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Patients who got a treatment that was unlikely for their covariate pattern receive a large weight (they are "surprising" and therefore informative)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Patients who got the most expected treatment get a small weight (they are "predictable" and already well-represented)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>In the weighted pseudo-population, confounders are balanced between treatment groups (if the propensity score model is correctly specified).</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="fu">## Definition: The Propensity Score</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>The **propensity score** is the probability of receiving treatment given measured covariates:</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>e(W) = P(A = 1 \mid W)</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>IPTW weights are constructed from the propensity score:</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For treated:  <span class="sc">\(</span> \displaystyle w_i = \frac{1}{e(W_i)} <span class="sc">\)</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For control: <span class="sc">\(</span> \displaystyle w_i = \frac{1}{1 - e(W_i)} <span class="sc">\)</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>The propensity score is a **balancing score**: conditioning on it is sufficient to remove confounding by all measured covariates $W$. This is why a single scalar summary can replace adjustment for many covariates.</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. Identification Using IPTW</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a><span class="fu">## The IPTW Identification Result and the Horvitz-Thompson Connection</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>Under the same causal assumptions as before</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Consistency**: the observed outcome equals the potential outcome under the treatment actually received</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Exchangeability**: <span class="sc">\(</span> Y(a) \perp A \mid W <span class="sc">\)</span> --- no unmeasured confounding</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Positivity**: every covariate stratum has a non-zero probability of receiving each treatment</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>the average potential outcome under treatment can be expressed as</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">Y(1)</span><span class="co">]</span> = E\left<span class="co">[</span><span class="ot"> \frac{I(A = 1) Y}{e(W)} \right</span><span class="co">]</span></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>and under control</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">Y(0)</span><span class="co">]</span> = E\left<span class="co">[</span><span class="ot"> \frac{I(A = 0) Y}{1 - e(W)} \right</span><span class="co">]</span></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>The IPTW estimator replaces the expectation with the sample average and replaces the true <span class="sc">\(</span> e(W) <span class="sc">\)</span> with an estimated one.</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>This is called a **Horvitz-Thompson type** estimator because it has the same structure as the survey sampling estimator that reweights observations by the inverse of their selection probability. In our setting, "selection" is selection into a treatment group. Just as survey statisticians upweight undersampled populations, we upweight patients whose treatment assignment was unlikely given their covariates.</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Simulated Example</span></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>We reuse a familiar setup: an osteoporosis like population with confounding by age and cardiovascular history.</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">4000</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">75</span>, <span class="dv">6</span>)</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>cvd <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="fl">0.12</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">70</span>)))</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment assignment with strong confounding</span></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.09</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> cvd))</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome model</span></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>A <span class="sc">+</span> <span class="fl">0.10</span><span class="sc">*</span>(age <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fl">1.0</span><span class="sc">*</span>cvd))</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(age, cvd, A, Y)</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>For simplicity</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A = 1 can be thought of as denosumab</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A = 0 can be thought of as zoledronic acid</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Y = 1 indicates occurrence of a cardiovascular outcome</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Estimating the Propensity Score</span></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>We model the probability of receiving treatment given covariates.</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>In practice, one might use logistic regression, SuperLearner, or other ML. Here we start with logistic regression for clarity.</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>ps_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(A <span class="sc">~</span> age <span class="sc">+</span> cvd, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps_mod)</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">ps =</span> <span class="fu">predict</span>(ps_mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> </span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_ps =</span> <span class="fu">min</span>(ps),</span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_ps =</span> <span class="fu">max</span>(ps)</span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>We can visualize the propensity score distribution.</span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">factor</span>(A))) <span class="sc">+</span></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Estimated propensity score P(A=1 | W)"</span>,</span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Propensity score overlap"</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reading the Propensity Score Overlap Plot</span></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>**Good overlap** looks like two density curves that cover mostly the same range of propensity scores, even if their peaks differ. This means that for most covariate patterns, there are both treated and untreated patients --- exactly what positivity requires.</span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>**Bad overlap** looks like two density curves that barely touch, with the treated group concentrated at high propensity scores and the untreated group concentrated at low ones. When this happens:</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>IPTW produces extreme weights for patients in the non-overlapping tails</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Estimates become highly variable and unreliable</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You may need to restrict your target population to the region of overlap (trimming) or reconsider your study design</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>As a rule of thumb, be concerned if propensity scores for either group pile up near 0 or 1.</span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. Constructing IPTW Weights</span></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a><span class="fu">## Unstabilized Weights</span></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>Unstabilized weights are the simplest form of IPTW weights. For each individual, the weight is the inverse of the probability of receiving the treatment they actually received:</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Treated ($A = 1$): $w_i = 1 / e(W_i)$</span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Untreated ($A = 0$): $w_i = 1 / (1 - e(W_i))$</span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a>These weights create a pseudo-population where treatment is independent of measured confounders. However, they can be highly variable --- especially when some propensity scores are close to 0 or 1.</span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_ipw =</span> <span class="fu">if_else</span>(A <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> ps, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>w_ipw)</span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(dat<span class="sc">$</span>w_ipw, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>))</span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>Keep an eye on</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Very large weights (suggest near-violations of positivity)</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Range and extreme quantiles (the 99th percentile should not be orders of magnitude larger than the median)</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Stabilized Weights Are Preferred in Practice</span></span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>Stabilized weights multiply the standard IPTW weights by the **marginal probability of treatment**, which brings the weights closer to 1 on average and reduces their variance without introducing bias for the marginal causal effect.</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a>For a binary treatment:</span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>SW_i = \frac{P(A_i)}{e(W_i)} \text{ if } A_i = 1</span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>SW_i = \frac{P(A_i)}{1 - e(W_i)} \text{ if } A_i = 0</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>Here <span class="sc">\(</span> P(A_i) <span class="sc">\)</span> is the marginal probability of treatment (estimated as the sample proportion treated).</span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>**Why this helps:** Unstabilized weights create a pseudo-population that is larger than the original sample, which inflates standard errors. Stabilized weights preserve the original sample size in expectation, leading to:</span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Narrower confidence intervals</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>More stable point estimates</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Better finite-sample performance</span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>In epidemiologic practice, **always prefer stabilized weights** unless you have a specific reason to use unstabilized ones.</span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>pA <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>A)</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">sw_ipw =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>      A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> pA <span class="sc">/</span> ps,</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>      A <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">-</span> pA) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)</span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>sw_ipw)</span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(dat<span class="sc">$</span>sw_ipw, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>))</span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. Estimating the ATE via IPTW</span></span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a>There are several equivalent ways to use the weights.</span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.1 Direct weighted mean of outcomes</span></span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>Estimated risk under treatment</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a>risk1_ipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>risk0_ipw <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_ipw <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>ate_ipw <span class="ot">&lt;-</span> risk1_ipw <span class="sc">-</span> risk0_ipw</span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">risk1 =</span> risk1_ipw, <span class="at">risk0 =</span> risk0_ipw, <span class="at">ate =</span> ate_ipw)</span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a>This matches the formula</span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a>\hat E<span class="co">[</span><span class="ot">Y(1)</span><span class="co">]</span> = \frac{\sum_i SW_i Y_i I(A_i = 1)}{\sum_i SW_i I(A_i = 1)}</span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.2 Weighted regression model</span></span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>We can also fit a weighted regression with treatment as the only predictor.</span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a><span class="in">library(sandwich)</span></span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a><span class="in">library(lmtest)</span></span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a><span class="in"># Fit a simple weighted model</span></span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a><span class="in">fit_ipw &lt;- glm(Y ~ A, family = binomial, weights = sw_ipw, data = dat)</span></span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a><span class="in"># Robust standard errors</span></span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a><span class="in">cov_ipw &lt;- vcovHC(fit_ipw, type = "HC0")</span></span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a><span class="in">coeftest(fit_ipw, cov_ipw)</span></span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a>Interpretation</span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The coefficient of A (on the log odds scale) now estimates a marginal effect in the pseudo population</span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You can compute marginal risk differences or ratios by predicting from the model at A=1 and A=0 and standardizing</span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. Comparing IPTW and G Computation</span></span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>We can compare the IPTW ATE to the g computation ATE from the previous chapter.</span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a><span class="co"># g computation</span></span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>g_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> age <span class="sc">+</span> cvd, <span class="at">family =</span> binomial, <span class="at">data =</span> dat)</span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>p1_g <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>p0_g <span class="ot">&lt;-</span> <span class="fu">predict</span>(g_mod, <span class="at">newdata =</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="dv">0</span>), <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>ate_g <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_g <span class="sc">-</span> p0_g)</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">ate_gcomp =</span> ate_g, <span class="at">ate_iptw =</span> ate_ipw)</span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a>Under correct models and adequate positivity, these methods should converge to similar estimates as sample size grows.</span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a><span class="fu">## Critical Takeaway: IPTW and G-Computation Depend on Different Models</span></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a>This is one of the most important conceptual points in causal inference methodology:</span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**G-computation** depends on correctly specifying the **outcome model** $E<span class="co">[</span><span class="ot">Y \mid A, W</span><span class="co">]</span>$</span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**IPTW** depends on correctly specifying the **treatment model** $P(A \mid W)$</span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Neither uses both models at once**</span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>In practice, you rarely know which model is correct. This motivates **doubly robust** methods (next chapter), which combine both approaches and provide consistent estimates if *either* the treatment model *or* the outcome model is correctly specified --- giving you two chances to get it right.</span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>For MPH epidemiologists: when you present IPTW results, always show propensity score diagnostics (overlap, balance) alongside your estimates. When you present g-computation results, discuss outcome model fit. When the two approaches give very different answers, that is a signal that at least one model may be misspecified.</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Diagnostics and Practical Tips</span></span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a>IPTW is powerful but fragile if diagnostics are ignored.</span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a><span class="fu">## Diagnostic Checklist: Never Report IPTW Without These Checks</span></span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a>Every IPTW analysis should include diagnostics. Reviewers and readers should expect to see them. Omitting diagnostics is a red flag in any manuscript.</span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a><span class="fu">### 8.1 Check propensity score overlap</span></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a><span class="fu">## Assessing Positivity via Overlap</span></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Plot propensity score densities by treatment group (as we did in Section 4)</span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Flag regions where one group is missing or sparse</span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the treated and untreated distributions do not overlap, the ATE may not be identifiable in that region</span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consider restricting inference to the overlap population or reporting the ATT instead</span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a><span class="fu">### 8.2 Check weights</span></span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_w =</span> <span class="fu">min</span>(sw_ipw),</span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_w =</span> <span class="fu">max</span>(sw_ipw),</span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_w =</span> <span class="fu">mean</span>(sw_ipw),</span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_w =</span> <span class="fu">sd</span>(sw_ipw)</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a><span class="fu">## When Extreme Weights Signal Trouble</span></span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a>Large extreme weights are a red flag. Watch for these warning signs:</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Maximum weight &gt; 10--20**: a single observation is being counted as 10--20 people. Your estimate may be driven by one or two individuals.</span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Mean of stabilized weights far from 1**: stabilized weights should average approximately 1. Deviations suggest model misspecification.</span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Ratio of max to median weight &gt; 20**: indicates near-violation of positivity for some covariate patterns.</span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a>When you see extreme weights, consider: (1) improving your propensity score model, (2) checking for data errors in the extreme-weight observations, and (3) applying weight truncation (see below).</span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a><span class="fu">### 8.3 Consider truncation</span></span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>You can truncate weights at a chosen percentile, for example the 1st and 99th percentiles.</span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a>lower <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw_ipw, <span class="fl">0.01</span>)</span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a>upper <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>sw_ipw, <span class="fl">0.99</span>)</span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">sw_trunc =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(sw_ipw, lower), upper)</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a><span class="co"># recompute ATE with truncated weights</span></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>risk1_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">1</span>)))</span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>risk0_trunc <span class="ot">&lt;-</span> <span class="fu">with</span>(dat, <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> Y <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">/</span> <span class="fu">sum</span>(sw_trunc <span class="sc">*</span> (A <span class="sc">==</span> <span class="dv">0</span>)))</span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a>ate_trunc   <span class="ot">&lt;-</span> risk1_trunc <span class="sc">-</span> risk0_trunc</span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">ate_truncated =</span> ate_trunc)</span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Truncation Trade-Off: Bias vs. Variance</span></span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a>Truncation (also called "winsorizing") reduces variance at the cost of introducing some bias. By capping extreme weights, you are effectively saying: "I am willing to accept a small amount of bias in exchange for a much more stable estimate."</span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a>**The trade-off in practice:**</span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Without truncation**: unbiased (if the propensity model is correct) but potentially high variance, with confidence intervals that may be uninformatively wide</span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**With truncation**: slightly biased but often lower mean squared error, producing more useful estimates</span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>**Common approaches:**</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Truncate at the 1st and 99th percentiles (as shown above)</span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Truncate at fixed values (e.g., cap weights at 10 or 20)</span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Report results with and without truncation as a sensitivity analysis</span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a>There is no single "right" truncation threshold. In your manuscripts, always report which threshold you used and show sensitivity to this choice.</span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Summary</span></span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a><span class="fu">## Chapter Takeaways and Limitations</span></span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a>**What we covered:**</span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The intuition for IPTW as a method that reweights observational data to mimic a randomized trial</span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The key role of the propensity score in computing weights, and its connection to the Horvitz-Thompson estimator from survey sampling</span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to construct unstabilized and stabilized IPTW weights (prefer stabilized in practice)</span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to estimate ATEs via weighted means or weighted regression</span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to diagnose propensity score overlap and extreme weights --- never skip these diagnostics</span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How IPTW compares to g-computation, and why each depends on a different model</span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a>**Limitations to keep in mind:**</span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Depends entirely on a correctly specified treatment model --- if you miss a confounder or misspecify the functional form, your weights will not balance the confounders</span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sensitive to violations of positivity --- extreme weights can dominate your estimates</span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Does not use information from the outcome model, which motivates doubly robust approaches</span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For rare exposures or outcomes, IPTW can be particularly unstable</span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>**Looking ahead:** In the next chapter, we will introduce **doubly robust estimators** and **Targeted Maximum Likelihood Estimation (TMLE)**, which combine the strengths of g-computation and IPTW and allow the use of machine learning for both nuisance models.</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>